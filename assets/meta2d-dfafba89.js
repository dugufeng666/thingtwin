var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i);function rectangle(e,t){const i=t||new Path2D;e.setTheme||(e.setTheme=setTheme);let n=e.calculative.borderRadius||0,o=n;const{x:s,y:r,width:a,height:l,ex:c,ey:h}=e.calculative.worldRect;n<1&&(n*=a,o*=l);let d=n<o?n:o;if(a<2*d&&(d=a/2),l<2*d&&(d=l/2),i.moveTo(s+d,r),i.arcTo(c,r,c,h,d),i.arcTo(c,h,s,h,d),i.arcTo(s,h,s,r,d),i.arcTo(s,r,c,r,d),i.closePath(),i instanceof Path2D)return i}function setTheme(e,t){if(e.affectByTheme){for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const n=t[i];e.hasOwnProperty(i)&&(e[i]=n),e.calculative.hasOwnProperty(i)&&(e.calculative[i]=n)}e.hoverTextColor=t.textPrimaryColor,e.iconColor=t.buttonBg,e.calculative.iconColor=t.buttonBg,e.hoverBackground=t.formBg,e.activeBackground=t.activeBg,e.color=t.borderColor,e.calculative.color=t.borderColor,e.textColor=t["textColor-9"],e.calculative.textColor=t["textColor-9"]}}const square=rectangle;function circle(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.ellipse(n+s/2,o+r/2,s/2,r/2,0,0,2*Math.PI),i instanceof Path2D)return i}var PenType,PenType2,LockState,LockState2,AnchorMode,AnchorMode2,Gradient,Gradient2,CanvasLayer,CanvasLayer2;PenType2=PenType||(PenType={}),PenType2[PenType2.Node=0]="Node",PenType2[PenType2.Line=1]="Line",LockState2=LockState||(LockState={}),LockState2[LockState2.None=0]="None",LockState2[LockState2.DisableEdit=1]="DisableEdit",LockState2[LockState2.DisableMove=2]="DisableMove",LockState2[LockState2.DisableScale=3]="DisableScale",LockState2[LockState2.DisableMoveScale=4]="DisableMoveScale",LockState2[LockState2.Disable=10]="Disable",AnchorMode2=AnchorMode||(AnchorMode={}),AnchorMode2[AnchorMode2.Default=0]="Default",AnchorMode2[AnchorMode2.In=1]="In",AnchorMode2[AnchorMode2.Out=2]="Out",Gradient2=Gradient||(Gradient={}),Gradient2[Gradient2.None=0]="None",Gradient2[Gradient2.Linear=1]="Linear",Gradient2[Gradient2.Radial=2]="Radial",CanvasLayer2=CanvasLayer||(CanvasLayer={}),CanvasLayer2[CanvasLayer2.CanvasTemplate=1]="CanvasTemplate",CanvasLayer2[CanvasLayer2.CanvasImageBottom=2]="CanvasImageBottom",CanvasLayer2[CanvasLayer2.CanvasMain=3]="CanvasMain",CanvasLayer2[CanvasLayer2.CanvasImage=4]="CanvasImage";const needCalcTextRectProps=["text","textWidth","textHeight","textLeft","textTop","fontFamily","fontSize","lineHeight","fontStyle","fontWeight","textAlign","textBaseline","whiteSpace","ellipsis","keepDecimal"],needSetPenProps=["x","y","width","height","flipX","flipY"],needPatchFlagsPenRectProps=["paddingTop","paddingRight","paddingBottom","paddingLeft","flipX","flipY","visible","showChild"],needCalcIconRectProps=["iconLeft","iconTop","iconRotate"];var LineAnimateType,LineAnimateType2;LineAnimateType2=LineAnimateType||(LineAnimateType={}),LineAnimateType2[LineAnimateType2.Normal=0]="Normal",LineAnimateType2[LineAnimateType2.Beads=1]="Beads",LineAnimateType2[LineAnimateType2.Dot=2]="Dot",LineAnimateType2[LineAnimateType2.Arrow=3]="Arrow",LineAnimateType2[LineAnimateType2.WaterDrop=4]="WaterDrop",LineAnimateType2[LineAnimateType2.Custom=5]="Custom";const isDomShapes=["gif","iframe","video","echarts","highcharts","lightningCharts","vue"],isInteraction=["radio","checkbox","button","inputDom","slider","echarts"],formatAttrs=new Set(["borderRadius","paddingLeft","paddingRight","paddingTop","paddingBottom","progress","progressColor","verticalProgress","reverseProgress","flipX","flipY","input","lineDash","lineCap","lineJoin","strokeType","lineGradientFromColor","lineGradientToColor","lineGradientAngle","color","hoverColor","activeColor","lineWidth","bkType","gradientFromColor","gradientToColor","gradientAngle","gradientRadius","hoverBackground","activeBackground","globalAlpha","anchorColor","anchorRadius","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","textHasShadow","fontFamily","fontSize","textColor","hoverTextColor","activeTextColor","textBackground","fontStyle","fontWeight","textAlign","textBaseline","lineHeight","whiteSpace","textWidth","textHeight","textLeft","textTop","ellipsis","hiddenText","keepDecimal","borderWidth","borderColor","animateLineWidth","lineAnimateType","frames","animateColor","animateType","animateReverse","background","gradientColors","lineGradientColors","animateLineWidth","gradientSmooth","lineSmooth","animations"]);function clearLifeCycle(e){e.onAdd=void 0,e.onValue=void 0,e.onBeforeValue=void 0,e.onDestroy=void 0,e.onMove=void 0,e.onResize=void 0,e.onRotate=void 0,e.onClick=void 0,e.onMouseEnter=void 0,e.onMouseLeave=void 0,e.onMouseDown=void 0,e.onMouseMove=void 0,e.onMouseUp=void 0,e.onShowInput=void 0,e.onInput=void 0,e.onChangeId=void 0,e.onBinds=void 0,e.onStartVideo=void 0,e.onPauseVideo=void 0,e.onStopVideo=void 0,e.onRenderPenRaw=void 0,e.onKeyDown=void 0,e.onContextmenu=void 0,e.onScale=void 0,e.onWheel=void 0,e.onConnectLine=void 0}var HoverType,HoverType2,HotkeyType,HotkeyType2,MouseRight,MouseRight2,Direction,Direction2;HoverType2=HoverType||(HoverType={}),HoverType2[HoverType2.None=0]="None",HoverType2[HoverType2.LineAnchor=1]="LineAnchor",HoverType2[HoverType2.NodeAnchor=2]="NodeAnchor",HoverType2[HoverType2.Line=3]="Line",HoverType2[HoverType2.Node=4]="Node",HoverType2[HoverType2.Resize=5]="Resize",HoverType2[HoverType2.Rotate=6]="Rotate",HoverType2[HoverType2.LineAnchorPrev=7]="LineAnchorPrev",HoverType2[HoverType2.LineAnchorNext=8]="LineAnchorNext",HotkeyType2=HotkeyType||(HotkeyType={}),HotkeyType2[HotkeyType2.None=0]="None",HotkeyType2[HotkeyType2.Translate=1]="Translate",HotkeyType2[HotkeyType2.Select=2]="Select",HotkeyType2[HotkeyType2.Resize=3]="Resize",HotkeyType2[HotkeyType2.AddAnchor=4]="AddAnchor",MouseRight2=MouseRight||(MouseRight={}),MouseRight2[MouseRight2.None=0]="None",MouseRight2[MouseRight2.Down=1]="Down",MouseRight2[MouseRight2.Translate=2]="Translate",Direction2=Direction||(Direction={}),Direction2[Direction2.None=-1]="None",Direction2[Direction2.Up=0]="Up",Direction2[Direction2.Right=1]="Right",Direction2[Direction2.Bottom=2]="Bottom",Direction2[Direction2.Left=3]="Left";const defaultCursors=["nw-resize","ne-resize","se-resize","sw-resize"],rotatedCursors=["n-resize","e-resize","s-resize","w-resize"],defaultDrawLineFns=["curve","polyline","line"],inheritanceProps=["dash","lineWidth","lineCap","lineJoin","strokeType","color","lineGradientFromColor","lineGradientToColor","lineGradientAngle","globalAlpha","bkType","background","gradientFromColor","gradientToColor","gradientAngle","gradientRadius","fontFamily","fontSize","textColor","hoverTextColor","activeTextColor","textBackground","fontStyle","fontWeight","textAlign","textBaseline","lineHeight","whiteSpace","textLeft","textTop","flipX","flipY","lineDash","visible","iconColor"];var PrevNextType,PrevNextType2,TwoWay,TwoWay2,PointType,PointType2;function rotatePoint(e,t,i){if(!t||t%360==0)return;const n=t*Math.PI/180,o=(e.x-i.x)*Math.cos(n)-(e.y-i.y)*Math.sin(n)+i.x,s=(e.x-i.x)*Math.sin(n)+(e.y-i.y)*Math.cos(n)+i.y;e.x=o,e.y=s,e.prev&&rotatePoint(e.prev,t,i),e.next&&rotatePoint(e.next,t,i)}function hitPoint(e,t,i=5,n){if(t.type===PointType.Line){let o=n.rotate;n.flipX&&(o*=-1),n.flipY&&(o*=-1);let s=t.rotate+o;return n.flipX&&(s*=-1),n.flipY&&(s*=-1),pointInRect(e,{x:t.x-t.length*n.calculative.canvas.store.data.scale/2,y:t.y-i,width:t.length*n.calculative.canvas.store.data.scale,height:2*i,rotate:s})}return e.x>t.x-i&&e.x<t.x+i&&e.y>t.y-i&&e.y<t.y+i}function scalePoint(e,t,i){e.x=i.x-(i.x-e.x)*t,e.y=i.y-(i.y-e.y)*t}function calcRotate(e,t){if(e.x===t.x)return e.y<=t.y?0:180;if(e.y===t.y)return e.x<t.x?270:90;const i=e.x-t.x,n=e.y-t.y;let o=Math.atan(Math.abs(i/n))/(2*Math.PI)*360;return i>0&&n>0?o=180-o:i<0&&n>0?o+=180:i<0&&n<0&&(o=360-o),o}function distance(e,t){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}function facePoint(e,t){let i=Direction.None;if(!t)return i;const n=e.x-t.x,o=e.y-t.y;return i=Math.abs(n)>Math.abs(o)?n>0?Direction.Right:Direction.Left:o>0?Direction.Bottom:Direction.Up,i}function translatePoint(e,t,i){e&&(e.x+=t,e.y+=i,e.next&&(e.next.x+=t,e.next.y+=i),e.prev&&(e.prev.x+=t,e.prev.y+=i))}function samePoint(e,t){return e.anchorId===t.anchorId&&e.connectTo===t.connectTo}function getDistance(e,t,i){let n=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))/i.data.scale;0===t.rotate?e.x<t.x?i.pens[t.penId].flipX||(n*=-1):i.pens[t.penId].flipX&&(n*=-1):e.y<t.y?i.pens[t.penId].flipY||(n*=-1):i.pens[t.penId].flipY&&(n*=-1),e.distance=n}PrevNextType2=PrevNextType||(PrevNextType={}),PrevNextType2[PrevNextType2.Mirror=0]="Mirror",PrevNextType2[PrevNextType2.Bilateral=1]="Bilateral",PrevNextType2[PrevNextType2.Free=2]="Free",TwoWay2=TwoWay||(TwoWay={}),TwoWay2[TwoWay2.Default=0]="Default",TwoWay2[TwoWay2.In=1]="In",TwoWay2[TwoWay2.Out=2]="Out",TwoWay2[TwoWay2.DisableConnected=3]="DisableConnected",TwoWay2[TwoWay2.DisableConnectTo=4]="DisableConnectTo",TwoWay2[TwoWay2.Disable=10]="Disable",PointType2=PointType||(PointType={}),PointType2[PointType2.Default=0]="Default",PointType2[PointType2.Line=1]="Line";const name="@meta2d/core",version="1.0.81",description="@meta2d/core: Powerful, Beautiful, Simple, Open - Web-Based 2D At Its Best .",main="index.js",types="index.d.ts",scripts={copy:"copyfiles  package.json ../../dist/core/",build:"tsc && npm run copy"},keywords=["meta2d","diagram","2D","canvas"],author="alsmile123@qq.com",license="MIT",repository={type:"git",url:"git+https://github.com/le5le-com/meta2d.js.git"},bugs={url:"https://github.com/le5le-com/meta2d.js/issues"},homepage="https://github.com/le5le-com/meta2d.js#readme",devDependencies={"@types/marked":"^4.0.3","@types/offscreencanvas":"latest","@types/zrender":"^4.0.0"},dependencies={mitt:"^2.1.0",mqtt:"^4.2.6"},publishConfig={access:"public"},gitHead="78f2a53ca1839c89b56e2e498d17ba4eb987ad14",pkg={name:name,version:version,description:description,main:main,types:types,scripts:scripts,keywords:keywords,author:author,license:license,repository:repository,bugs:bugs,homepage:homepage,devDependencies:devDependencies,dependencies:dependencies,publishConfig:publishConfig,gitHead:gitHead},globalStore={version:pkg.version,path2dDraws:{},canvasDraws:{},anchors:{},lineAnimateDraws:{},htmlElements:{}};function register(e){Object.assign(globalStore.path2dDraws,e)}function registerCanvasDraw(e){Object.assign(globalStore.canvasDraws,e)}function registerAnchors(e){Object.assign(globalStore.anchors,e)}function mitt(e){return{all:e=e||new Map,on:function(t,i){var n=e.get(t);n&&n.push(i)||e.set(t,[i])},off:function(t,i){var n=e.get(t);n&&n.splice(n.indexOf(i)>>>0,1)},emit:function(t,i){(e.get(t)||[]).slice().map((function(e){e(i)})),(e.get("*")||[]).slice().map((function(e){e(t,i)}))}}}var KeydownType,KeydownType2;KeydownType2=KeydownType||(KeydownType={}),KeydownType2[KeydownType2.None=-1]="None",KeydownType2[KeydownType2.Document=0]="Document",KeydownType2[KeydownType2.Canvas=1]="Canvas";const defaultOptions={fontFamily:'"Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial',fontSize:12,lineHeight:1.5,textAlign:"center",textBaseline:"middle",color:"#222222",activeColor:"#278df8",hoverColor:"rgba(39,141,248,0.50)",anchorColor:"#278DF8",hoverAnchorColor:"#FF4101",anchorRadius:4,anchorBackground:"#fff",dockColor:"rgba(39,141,248,0.50)",dockPenColor:"#1890FF",dragColor:"#1890ff",rotateCursor:"rotate.cur",rightCursor:"right.cur",downCursor:"down.cur",hoverCursor:"pointer",minScale:.1,maxScale:10,keydown:KeydownType.Document,gridSize:20,gridColor:"#e2e2e2",ruleColor:"#888888",drawingLineName:"curve",interval:30,animateInterval:30,autoPolyline:!0,autoAnchor:!0,autoAlignGrid:!1,animateColor:"#30EEDC",ruleLineColor:"#FF4101",shadowOffsetX:0,shadowOffsetY:0,shadowBlur:64,shadowColor:"#00000014",globalAlpha:1,defaultAnchors:[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],measureTextWidth:!0,moveConnectedLine:!0,mouseRightActive:!0,disableClipboard:!1,drawingLineLength:0,disableTouchPadScale:!1,cdn:"",polylineSpace:10,domShapes:[],containerShapes:["tablePlus"],textFlip:!0,textRotate:!0,unavailableKeys:[],diagramOptions:{},svgPathStroke:!0,reconnetTimes:10},themeKeys=["color","hoverColor","activeColor","disabledColor","background","activeBackground","hoverBackground","disabledBackground","anchorColor","hoverAnchorColor","anchorBackground","animateColor","textColor","ruleColor","ruleLineColor","gridColor","lineColor","penBackground","dockPenColor"],defaultTheme={dark:{color:"#bdc7db",background:"#1e2430",parentBackground:"#080b0f",ruleColor:"#222E47",ruleOptions:{background:"#121924",textColor:"#6E7B91"}},light:{color:"#222222",background:"#FFFFFF",parentBackground:"#F0F1F2",ruleColor:"#C8D0E1",ruleOptions:{background:"#F7F8FA",textColor:"#C8D0E1"}}},le5leTheme={cssRuleSelector:":root",style_prefix:"le5le_",vendor_css_prefix:"--le-",dark:["textColor-9: rgba(255,255,255,0.90)","textColor-6: rgba(255,255,255,0.60)","textColor-1: rgba(255,255,255,1)","textColor-4: rgba(255,255,255,0.40)","textPrimaryColor: #7f838c","textSecondColor: rgba(255,255,255,0.90)","textDisabledColor: rgba(255,255,255,0.40)","textActiveColor: #0052d9","buttonBg: #4583ff","buttonDisabledBg: #0057CC","buttonDisabledColor: #FFFFFF26","buttonGradient: linear-gradient(360deg,#4583ff, #33ccff)","containerBg: rgba(21,24,28,0.95)","tabBg: #303746","tabActiveBg: #4583ff","tabDisabledBg: #282e3b","tabDisabledColor: rgba(255,255,255,0.26)","tabActiveColor: rgba(255,255,255,0.90)","formBg: #2a2f36","datePickerCellActiveRangeBg: #2c4475","componentDisabledBg: #282e3b","dataPickerCellActiveBg: #001b52","activeBg: #25375b","popContentBg: #252b37","disabledBg: #7f838c","disabledBg-2: #282E3B","tableStripeColor: rgba(150,192,255,0.10)","tableMenuBg: #303746","tableMenuDividerBg: rgb(76 81 94)","tableMenuHandleBg: #454f64","tableMenuColor: #bdc7db","tableMenuBorderColor: transparent","tableColRowBg: #303746","tableColRowActiveBg: #4A5263","tableColRowColor: rgba(255,255,255,0.6)","paginationColor: rgba(255,255,255,0.6)","paginationActiveColor: #4583ff","paginationActiveBg: rgba(69,131,255,0.20)","sliderBg: #303746","sliderBtnBg: #000000","notificationBorderColor: transparent","notificationBg: #282e3b","borderColor: #424b61","borderOutsideColor: #4583ff","formBorderColor: #424b61","borderInsideColor: rgba(255,255,255,0.40)","shadow: 0px 1px 10px 0px rgba(0,0,0,0.05), 0px 4px 5px 0px rgba(0,0,0,0.08), 0px 2px 4px -1px rgba(0,0,0,0.12)","radius: 4px"],light:["textColor-9: rgba(0,0,0,0.90)","textColor-6: rgba(0,0,0,0.60)","textColor-1: rgba(0,0,0,1)","textColor-4: rgba(0,0,0,0.40)","textPrimaryColor: #7f838c","textSecondColor: #171B27","textDisabledColor: rgba(0, 0, 0, 0.6)","textActiveColor: #0052d9","buttonBg: #4583ff","buttonDisabledBg: #b5c7ff","buttonDisabledColor: #FFFFFF","buttonGradient: linear-gradient(360deg,#4583ff, #33ccff)","containerBg: #ffffff","tabBg: #f1f2f5","tabActiveBg: #4583ff","tabDisabledBg: #e2e6ea","tabDisabledColor: rgba(0,0,0,0.26)","tabActiveColor: #ffffff","formBg: #EFF1F4","datePickerCellActiveRangeBg: #f2f3ff","componentDisabledBg: #eee","dataPickerCellActiveBg: #edefff","activeBg: #f2f3ff","popContentBg: #ffffff","disabledBg: #7f838c","disabledBg-2: #E2E6EA","tableStripeColor: #f1f2f5","tableMenuBg: #ffffff","tableMenuDividerBg: #e2e6ea","tableMenuHandleBg: #ebedf1","tableMenuColor: rgba(0,0,0,0.60)","tableMenuBorderColor: #e2e6ea","tableColRowBg: #ebedf1","tableColRowActiveBg: #bcc4d0","tableColRowColor: rgba(0,0,0,0.4)","paginationColor: rgba(0,0,0,0.6)","paginationActiveColor: #ffffff","paginationActiveBg: #4583ff","sliderBg: #e2e6ea","sliderBtnBg: #ffffff","notificationBorderColor: transparent","notificationBg: #ffffff","borderColor: #d6dbe3","borderOutsideColor: #d6dbe3","formBorderColor: #d4d6d9","borderInsideColor: #e7e7e7","shadow: 0px 2px 4px 0px rgba(107,113,121,0.25)","radius: 4px"],camelCaseToHyphenated:e=>e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase())),_addVendorCssPrefix(e){return e.map((e=>{const[t,i]=e.split(":");return`${this.vendor_css_prefix}${this.camelCaseToHyphenated(t.trim())}:${i.trim()}`}))},createThemeSheet(e,t){const i=document.createElement("style");i.type="text/css",i.id=this.style_prefix+t,document.head.appendChild(i);const n=e||"dark",o=this.getTheme(n),s=`${this.cssRuleSelector} { ${o.join(";")} }`;i.innerHTML=s},destroyThemeSheet(e){const t=this.findStyleSheet(this.style_prefix+e);t&&document.head.removeChild(t.ownerNode)},addTheme(e,t){Object.assign(this,{[e]:t})},getTheme(e){return this._addVendorCssPrefix(this[e]||this.light)},getThemeObj(e="dark"){return this[e].reduce(((e,t)=>{const[i,n]=t.split(":");return e[i]=n,e}),{})},findStyleSheet(e){const t=document.styleSheets;for(let i=0;i<t.length;i++){const n=t[i];if(n.ownerNode&&n.ownerNode.id===e)return n}return null},updateCssRule(e,t){const i=this.getTheme(t),n=this.findStyleSheet(this.style_prefix+e);if(!n)return;let o=!1;for(let s=0;s<n.cssRules.length;s++){if(n.cssRules[s].selectorText===this.cssRuleSelector){o=!0;break}}if(o)for(let s=0;s<n.cssRules.length;s++){const e=n.cssRules[s];if(e.selectorText===this.cssRuleSelector)if(n.insertRule){n.deleteRule(s);const e=`${this.cssRuleSelector} { ${i.join(";")} }`;n.insertRule(e,s)}else n.addRule&&(e.style.cssText=i.join(";"))}else if(n.insertRule){const e=`${this.cssRuleSelector} { ${i.join(";")} }`;n.insertRule(e,n.cssRules.length)}else if(n.addRule){const e=n.cssRules.find((e=>e.selectorText===this.cssRuleSelector));if(e){const t=i.join(";");e.style.cssText+=`; ${t}`}else n.addRule(this.cssRuleSelector,i.join(";"))}}};var EditType,EditType2;EditType2=EditType||(EditType={}),EditType2[EditType2.Add=0]="Add",EditType2[EditType2.Update=1]="Update",EditType2[EditType2.Delete=2]="Delete",EditType2[EditType2.Replace=3]="Replace";const createStore=()=>({data:{x:0,y:0,scale:1,pens:[],origin:{x:0,y:0},center:{x:0,y:0},paths:{}},histories:[],pens:{},path2dMap:new WeakMap,animateMap:new WeakMap,active:[],animates:new Set,options:{...defaultOptions},theme:{...defaultTheme},emitter:mitt(),bindDatas:{},bind:{},pensNetwork:{},cacheDatas:[],messageEvents:{},templatePens:{},globalTriggers:{}}),useStore=(e="default")=>(globalStore[e]||(globalStore[e]=createStore(),globalStore[e].id=e),globalStore[e]),clearStore=(e,t)=>{const i=e.data.template===t;if(i)for(const n of e.data.pens)n.canvasLayer===CanvasLayer.CanvasTemplate&&(e.templatePens[n.id]=n);e.lastScale=e.data.scale,e.data={x:0,y:0,scale:1,pens:[],origin:{x:0,y:0},center:{x:0,y:0},paths:{},template:i?t:null,lineAnimateDraws:{}},e.sameTemplate=i,e.pens={},e.histories=[],e.historyIndex=null,e.path2dMap=new WeakMap,e.animateMap=new WeakMap,e.bindDatas={},e.bind={},e.pensNetwork={},e.active=[],e.hover=void 0,e.lastHover=void 0,e.animates.clear()};function calcTextRect(e){const{paddingTop:t,paddingBottom:i,paddingLeft:n,paddingRight:o,worldRect:s,canvas:r}=e.calculative;let{textLeft:a,textTop:l,textWidth:c,textHeight:h}=e.calculative,d=n,u=t;const p=s.width-n-o,f=s.height-t-i;c&&c<1&&(c*=s.width),h&&h<1&&(h*=s.height),c<e.calculative.fontSize&&(c=e.calculative.fontSize),d+=(a||0)+s.x,u+=(l||0)+s.y;const v=e.textAlign||r.store.options.textAlign,g=e.textBaseline||r.store.options.textBaseline;switch(v){case"center":d+=(p-(c||p))/2;break;case"right":d+=p-(c||p)}switch(g){case"middle":u+=(f-(h||f))/2;break;case"bottom":u+=f-(h||f)}const y={x:d,y:u,width:c||p,height:h||f};calcRightBottom(y),e.calculative.worldTextRect=y,calcTextLines(e),e.calculative.textDrawRect=void 0}function calcTextDrawRect(e,t){const i=t.calculative.fontSize*t.calculative.lineHeight,n=t.calculative.textLines.length*i,o=calcTextAdaptionWidth(e,t),s=t.calculative.worldTextRect;let r=s.x+(s.width-o)/2,a=s.y+(s.height-n)/2;const l=t.calculative.canvas.store.options;switch(t.textAlign||l.textAlign){case"left":r=s.x;break;case"right":r=s.x+s.width-o}switch(t.textBaseline||l.textBaseline){case"top":a=s.y;break;case"bottom":a=s.ey-n}t.calculative.textDrawRect={x:r,y:a,width:o,height:n},calcRightBottom(t.calculative.textDrawRect)}function calcTextLines(e,t=e.calculative.text){if(null==t)return void(e.calculative.textLines=[]);t=t.toString();const i=e.calculative.keepDecimal;if(null!=i){const e=Number(t);isNaN(e)||(t=e.toFixed(i))}let n=[];const o=e.calculative.fontSize*e.calculative.lineHeight,s=e.calculative.worldTextRect.height,r=Math.floor(s/o),a=r>1?r:1;switch(e.whiteSpace){case"nowrap":if(!1!==e.ellipsis){const i=wrapLines(t.split(""),e);i[0]&&(n.push(i[0]),i.length>1&&setEllipsisOnLastLine(n))}else n.push(t);break;case"pre-line":n=t.split(/[\n]/g),!1!==e.ellipsis&&n.length>a&&(n=n.slice(0,a),setEllipsisOnLastLine(n));break;default:const i=t.split(/[\n]/g);let o=0;e:for(const t of i){let i=wrapLines("break-all"===e.whiteSpace?t.split(""):getWords(t),e);if(0===i.length&&(i=[""]),0!=e.ellipsis)for(const e of i){if(o++,o>a){setEllipsisOnLastLine(n);break e}n.push(e)}else n.push(...i)}}return e.calculative.textLines=n,n}function getWords(e=""){const t=[];let i="";for(let n=0;n<e.length;++n){const o=e.charCodeAt(n);o<33||o>126?(i&&(t.push(i),i=""),t.push(e[n])):i+=e[n]}return i&&t.push(i),t}function wrapLines(e,t){const i=t.calculative.canvas,n=i.offscreen.getContext("2d"),{fontStyle:o,fontWeight:s,fontSize:r,fontFamily:a,lineHeight:l}=t.calculative;n.save();const c=[];let h=e[0]||"";for(let d=1;d<e.length;++d){const u=e[d]||"",p=h+u;let f=0;if(i.store.options.measureTextWidth)n.font=getFont({fontStyle:o,fontWeight:s,fontFamily:a||i.store.options.fontFamily,fontSize:r,lineHeight:l}),f=n.measureText(p).width;else{const e=p.match(/[^\x00-\xff]/g)||"",t=e.length*r,i=p.match(/\s/g)||"";f=t+i.length*r*.3+(p.length-e.length-i.length)*r*.6}f<=t.calculative.worldTextRect.width+.1?h+=u:(h.length&&c.push(h),h=u)}return h.length&&c.push(h),n.restore(),c}function calcTextAdaptionWidth(e,t){let i=0;return t.calculative.textLineWidths=[],t.calculative.textLines.forEach((n=>{const o=e.measureText(n).width;t.calculative.textLineWidths.push(o),i<o&&(i=o)})),i}function setEllipsisOnLastLine(e){e[e.length-1]=e[e.length-1].slice(0,-3)+"..."}function calcTextAutoWidth(e){let t=e.text.split("\n");const i=e.calculative.canvas,n=i.offscreen.getContext("2d"),{fontStyle:o,fontWeight:s,fontSize:r,fontFamily:a,lineHeight:l}=e.calculative;let c=0,h=0;n.save();for(let u=0;u<t.length;u++){if(i.store.options.measureTextWidth)n.font=getFont({fontStyle:o,fontWeight:s,fontFamily:a||i.store.options.fontFamily,fontSize:r,lineHeight:l}),h=n.measureText(t[u]).width;else{const e=t[u].match(/[^\x00-\xff]/g)||"",i=e.length*r,n=t[u].match(/\s/g)||"";h=i+n.length*r*.3+(t[u].length-e.length-n.length)*r*.6}h>c&&(c=h)}n.restore();let d=t.length*r*l;"left"===e.textAlign||("right"===e.textAlign?e.x=e.x-(c-e.width):e.x=e.x-(c-e.width)/2),"top"===e.textBaseline||("bottom"===e.textBaseline?e.y=e.y-(d-e.height):e.y=e.y-(d-e.height)/2),e.height=d+5,e.width=c+5,e.calculative.canvas.updatePenRect(e),e.calculative.canvas.calcActiveRect()}function deepClone(e,t=!1){if(Array.isArray(e)){const i=[];return e.forEach((e=>{i.push(deepClone(e,t))})),i}if("object"==typeof e){if(null===e)return null;if(e.constructor===RegExp)return e;const i={};for(const n in e)["canvas","lastFrame"].includes(n)||e[n]instanceof HTMLImageElement||e[n]instanceof HTMLMediaElement||("calculative"!==n||t)&&(i[n]="singleton"!==n?deepClone(e[n],t):t?{}:e[n]);return i}return e}function deepSetValue(e,t,i){if(Array.isArray(e)){const n=[];return e.forEach((e=>{n.push(deepSetValue(e,t,i))})),n}if("object"==typeof e){if(null===e)return null;for(const n in e)if(t.includes(n))if(Array.isArray(e[n]))e[n].forEach(((t,o)=>{Number.isNaN(Number(t))||(e[n][o]=Number(t*i))}));else{if(Number.isNaN(Number(e[n])))continue;e[n]=Number(e[n])*i}else e[n]=deepSetValue(e[n],t,i);return e}return e}const arrows={};function renderFromArrow(e,t,i){if(!arrows[t.fromArrow])return;const n=getFromAnchor(t),{x:o,y:s}=n,r={x:o,y:s};if(r.step=(t.fromArrowSize||10)*i.data.scale,n.next)r.rotate=calcRotate(n.next,n)+90;else{const e=t.calculative.worldAnchors[1];if(!e)return;e.prev?r.rotate=calcRotate(e.prev,n)+90:r.rotate=calcRotate(e,n)+90}e.save(),e.beginPath(),e.setLineDash([]);const a=t.fromArrowColor||t.calculative.color;a&&(e.strokeStyle=a),arrows[t.fromArrow](e,t,i,r),e.restore()}function renderToArrow(e,t,i){if(!arrows[t.toArrow]||t.calculative.worldAnchors.length<2)return;e.save();const n=getToAnchor(t),{x:o,y:s}=n,r={x:o,y:s};if(r.step=(t.toArrowSize||10)*i.data.scale,n.prev)r.rotate=calcRotate(n.prev,n)+90;else{const e=t.calculative.worldAnchors[t.calculative.worldAnchors.length-2];e.next?r.rotate=calcRotate(e.next,n)+90:r.rotate=calcRotate(e,n)+90}e.beginPath(),e.setLineDash([]);const a=t.toArrowColor||t.calculative.color;a&&(e.strokeStyle=a),arrows[t.toArrow](e,t,i,r),e.restore()}function pSBCr(e){const t=parseInt,i=Math.round;let n=e.length,o={};if(n>9){const[i,s,r,a]=e=e.split(",");if(n=e.length,n<3||n>4)return null;o.r=t("a"==i[3]?i.slice(5):i.slice(4)),o.g=t(s),o.b=t(r),o.a=a?parseFloat(a):-1}else{if(8==n||6==n||n<4)return null;n<6&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+(n>4?e[4]+e[4]:"")),e=t(e.slice(1),16),9==n||5==n?(o.r=e>>24&255,o.g=e>>16&255,o.b=e>>8&255,o.a=i((255&e)/.255)/1e3):(o.r=e>>16,o.g=e>>8&255,o.b=255&e,o.a=-1)}return o}function pSBC(e,t,i,n){let o,s,r,a,l,c,h,d=Math.round,u="string"==typeof i;return"number"!=typeof e||e<-1||e>1||"string"!=typeof t||"r"!=t[0]&&"#"!=t[0]||i&&!u?null:(h=t.length>9,h=u?i.length>9||"c"==i&&!h:h,l=pSBCr(t),a=e<0,c=i&&"c"!=i?pSBCr(i):a?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},a=1-(e=a?-1*e:e),l&&c?(n?(o=d(a*l.r+e*c.r),s=d(a*l.g+e*c.g),r=d(a*l.b+e*c.b)):(o=d((a*l.r**2+e*c.r**2)**.5),s=d((a*l.g**2+e*c.g**2)**.5),r=d((a*l.b**2+e*c.b**2)**.5)),u=l.a,c=c.a,l=u>=0||c>=0,u=l?u<0?c:c<0?u:u*a+c*e:0,h?"rgb"+(l?"a(":"(")+o+","+s+","+r+(l?","+d(1e3*u)/1e3:"")+")":"#"+(4294967296+16777216*o+65536*s+256*r+(l?d(255*u):0)).toString(16).slice(1,l?void 0:-2)):null)}function rgba(e,t){const i=pSBCr(e)||{r:0,g:0,b:0};return i.a<0?`rgba(${i.r},${i.g},${i.b},${t})`:`rgba(${i.r},${i.g},${i.b},${t+i.a})`}function valueInRange(e,t){if(isNaN(e))return;if("string"!=typeof t)return;const[i,n]=[t[0],t[t.length-1]];if(!["[","("].includes(i))return;if(!["]",")"].includes(n))return;const o=t.substring(1,t.length-1).split(",");if(2!==o.length)return;const[s,r]=[+o[0],+o[1]];if(s>=r)return;if(!(e>s||"["===i&&e===s))return!1;return e<r||"]"===n&&e===r}function valueInArray(e,t){if("string"!=typeof t)return;const[i,n]=[t[0],t[t.length-1]];if("["!==i||"]"!==n)return;const o=t.substring(1,t.length-1).split(",");for(const s of o)if(s.includes("..")){const[t,i]=s.split(".."),[n,o]=[+t,+i];if(n>=o)return;if(e>=n&&e<=o)return!0}else if(e==s)return!0;return!1}function cubicBezierY(e,t,i){const n=1-e;return 3*n*n*e*t+3*n*e*e*i+e*e*e}function s8(){return(4294967296*(1+Math.random())|0).toString(16).substring(1)}arrows.triangleSolid=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step;e.moveTo(o,n.y-n.step/4),e.lineTo(n.x,n.y),e.lineTo(o,n.y+n.step/4),e.closePath(),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()},arrows.reTriangleSolid=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step/2;e.moveTo(n.x,n.y-n.step/2),e.lineTo(o,n.y),e.lineTo(n.x,n.y+n.step/2),e.closePath(),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()},arrows.triangle=(e,t,i,n)=>{e.save(),e.lineWidth<2&&(e.lineWidth=2),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step;e.moveTo(o,n.y-n.step/4),e.lineTo(n.x,n.y),e.lineTo(o,n.y+n.step/4),e.closePath(),e.stroke(),e.fillStyle=i.data.background||"#ffffff",e.fill(),e.restore()},arrows.circleSolid=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.step/2;e.arc(n.x-o,n.y,o,0,2*Math.PI),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()},arrows.circle=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.step/2;e.arc(n.x-o,n.y,o,0,2*Math.PI),e.stroke(),e.fillStyle=i.data.background||"#ffffff",e.fill(),e.restore()},arrows.diamondSolid=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step,s=n.step/2;e.moveTo(o,n.y),e.lineTo(o+s,n.y-s/2),e.lineTo(n.x,n.y),e.lineTo(o+s,n.y+s/2),e.closePath(),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()},arrows.diamond=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step,s=n.step/2;e.moveTo(o,n.y),e.lineTo(o+s,n.y-s/2),e.lineTo(n.x,n.y),e.lineTo(o+s,n.y+s/2),e.closePath(),e.stroke(),e.fillStyle=i.data.background||"#ffffff",e.fill(),e.restore()},arrows.line=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step;e.moveTo(o,n.y-n.step/3),e.lineTo(n.x,n.y),e.lineTo(o,n.y+n.step/3),e.stroke(),e.restore()},arrows.lineUp=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step;e.moveTo(o,n.y-n.step/3),e.lineTo(n.x,n.y),e.stroke(),e.restore()},arrows.lineDown=(e,t,i,n)=>{e.save(),e.translate(n.x,n.y),e.rotate(n.rotate*Math.PI/180),e.translate(-n.x,-n.y);const o=n.x-n.step;e.moveTo(o,n.y+n.step/3),e.lineTo(n.x,n.y),e.stroke(),e.restore()},globalThis.pSBC=pSBC;const formatPadding=e=>{let t=0,i=0,n=0,o=0;if("number"==typeof e)t=i=n=o=e;else if("string"==typeof e){t=i=n=o=parseInt(e,10)}else Array.isArray(e)&&(t=e[0],n=isNil(e[1])?e[0]:e[1],o=isNil(e[2])?e[0]:e[2],i=isNil(e[3])?n:e[3]);return[t,n,o,i]};function isNil(e){return null==e}async function fileToBase64(e){return new Promise(((t,i)=>{const n=new FileReader;n.onload=e=>{t(e.target.result)},n.onerror=e=>{i(e)},n.readAsDataURL(e)}))}async function uploadFile(e,t,i,n){const o=new FormData;if(o.append("file",e),i)for(const r in i)i.hasOwnProperty(r)&&o.append(r,i[r]);const s=await fetch(t,{method:"POST",headers:n,body:o});return(await s.json()).url}function loadCss(e,t,i){var n=document.createElement("link");n.href=e,n.rel="stylesheet",t&&(n.onload=t),i&&(n.onerror=i),document.head.appendChild(n)}function queryURLParams(e){let t=e||window.location.search.split("?")[1];const i=new URLSearchParams(t);return Object.fromEntries(i.entries())}function getCookie(e){let t;const i=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(i))?decodeURIComponent(t[2]):""}var TokenType,TokenType2;TokenType2=TokenType||(TokenType={}),TokenType2[TokenType2.None=0]="None",TokenType2[TokenType2.LocalStorage=1]="LocalStorage",TokenType2[TokenType2.Cookie=2]="Cookie";const isLe5le=-1!==location.host.indexOf("le5le.com");function getToken(){const e=globalThis.le5leTokenName??"token";switch(globalThis.le5leTokenType){case TokenType.LocalStorage:return localStorage.getItem(e);case TokenType.Cookie:return getCookie(e);default:return isLe5le?getCookie(e):localStorage.getItem(e)}}async function getMeta2dData(e,t){var i,n;if(globalThis.getMeta2dData)return await globalThis.getMeta2dData(t);const o=e.options.navigatorNetWork;let s=`/api/data/${location.href.includes("2d.")||location.href.includes("/2d")?"2d":"v"}/get`,r=(null==(i=queryURLParams())?void 0:i.id)||s.includes("${id}");if(!r){if(null==(n=queryURLParams())?void 0:n.data){s=`./projects/${t}`;const e=new URL(window.location);e.searchParams.set("data",t),history.pushState({},"",e)}}(null==o?void 0:o.url)&&(s=o.url.includes("${id}")?o.url.replace("${id}",t):o.url+("GET"===(null==o?void 0:o.method)?`?id=${t}`:""));let a=(null==o?void 0:o.method)||"POST";r||(a="GET");const l=await fetch(s,{headers:{Authorization:`Bearer ${getToken()}`},method:a,body:"GET"===a?void 0:JSON.stringify({id:t})});if(l.ok){let e=await l.text();return e.constructor===Object||e.constructor===Array?e=JSON.parse(JSON.stringify(e)):"string"==typeof e&&(e=JSON.parse(e)),e.data&&(e=e.data),e}e.emitter.emit("error",{type:"http",error:l})}function getter(e,t){if(null==t)return e;const i=t.split(".");for(;i.length&&(e=e[i.shift()]););return e}function setter(e,t,i){null!=t&&t.split(".").reduce(((e,n,o)=>e[n]=t.split(".").length===++o?i:e[n]||{}),e)}function formatTime(e){const t=new Date,i=t.getFullYear(),n=t.getMonth()+1,o=t.getDate(),s=t.getDay(),r=t.getHours(),a=t.getMinutes(),l=t.getSeconds();return new Function("year","month","day","week","hours","minutes","seconds",e?`return ${e}`:"return `${year}:${month}:${day} ${hours}:${minutes}:${seconds} 星期${week}`")(i,n,o,["天","一","二","三","四","五","六"][s],r,a,l)}function isAncestor(e,t){if(!e||!t)return!1;let i=getParent(e);for(;i;){if(i.id===t.id)return!0;i=getParent(i)}return!1}function getParent(e,t){if(!e||!e.parentId||!e.calculative)return;const i=e.calculative.canvas.store.pens[e.parentId];return t&&getParent(i,t)||i}function getAllChildren(e,t){if(!e||!e.children)return[];const i=[];return e.children.forEach((e=>{const n=t.pens[e];n&&(i.push(n),i.push(...getAllChildren(n,t)))})),i}function getAllFollowers(e,t){if(!e||!e.followers)return[];const i=[];return e.followers.forEach((e=>{const n=t.pens[e];n&&!n.parentId&&(i.push(n),i.push(...getAllFollowers(n,t)))})),i}function drawBkLinearGradient(e,t){const{worldRect:i,gradientFromColor:n,gradientToColor:o,gradientAngle:s}=t.calculative;return linearGradient(e,i,n,o,s)}function drawBkRadialGradient(e,t){const{worldRect:i,gradientFromColor:n,gradientToColor:o,gradientRadius:s}=t.calculative;if(!n||!o)return;const{width:r,height:a,center:l}=i,{x:c,y:h}=l;let d=r;d<a&&(d=a),d*=.5;const u=e.createRadialGradient(c,h,d*(s||0),c,h,d);return u.addColorStop(0,n),u.addColorStop(1,o),u}function getLinearGradientPoints(e,t,i,n,o){let s=0;s=Math.PI/2-Math.atan2(n-t,i-e);const r=(e+i)/2,a=(t+n)/2;return[r+o*Math.sin(90*Math.PI/180-s),a+o*-Math.cos(90*Math.PI/180-s),r+o*Math.sin(270*Math.PI/180-s),a+o*-Math.cos(270*Math.PI/180-s)]}function getBkRadialGradient(e,t){const{worldRect:i,gradientColors:n,gradientRadius:o}=t.calculative;if(!n)return;let s=t.calculative.gradientColors;t.calculative.checked&&(s=t.calculative.onGradientColors);const{width:r,height:a,center:l}=i,{x:c,y:h}=l;let d=r;d<a&&(d=a),d*=.5;const{colors:u}=formatGradient(s),p=e.createRadialGradient(c,h,d*(o||0),c,h,d);return u.forEach((e=>{p.addColorStop(e.i,e.color)})),p}function getBkGradient(e,t){const{x:i,y:n,ex:o,width:s,height:r,center:a}=t.calculative.worldRect;let l=[{x:o,y:n+r/2},{x:i,y:n+r/2}],c=t.calculative.gradientColors;t.calculative.checked&&(c=t.calculative.onGradientColors);const{angle:h,colors:d}=formatGradient(c);let u=getGradientR(h,s,r);return l.forEach((e=>{rotatePoint(e,h,a)})),getLinearGradient(e,l,d,u)}function getTextRadialGradient(e,t){const{worldRect:i,textGradientColors:n}=t.calculative;if(!n)return;const{width:o,height:s,center:r}=i,{x:a,y:l}=r;let c=o;c<s&&(c=s),c*=.5;const{colors:h}=formatGradient(n),d=e.createRadialGradient(a,l,0,a,l,c);return h.forEach((e=>{d.addColorStop(e.i,e.color)})),d}function getTextGradient(e,t){const{x:i,y:n,ex:o,width:s,height:r,center:a}=t.calculative.worldRect;let l=[{x:o,y:n+r/2},{x:i,y:n+r/2}];const{angle:c,colors:h}=formatGradient(t.calculative.textGradientColors);let d=getGradientR(c,s,r);return l.forEach((e=>{rotatePoint(e,c,a)})),getLinearGradient(e,l,h,d)}function getGradientR(e,t,i){const n=Math.atan(i/t)/Math.PI*180;let o=(e-90)%360,s=0;return o>n&&o<180-n||o>180+n&&o<360-n||o<0?(o>270?o=360-o:o>180?o-=180:o>90&&(o=180-o),s=Math.abs(i/Math.sin(o/180*Math.PI)/2)):(o>270?o=360-o:o>180?o-=180:o>90&&(o=180-o),s=Math.abs(t/Math.cos(o/180*Math.PI)/2)),s}function formatGradient(e){if("string"==typeof e&&e.startsWith("linear-gradient")){let t=e.slice(16,-2).split("deg,");if(t.length>1){let e=t[1].split("%,");const i=[];return e.forEach((e=>{if(/rgba?/.test(e)){let t=e.split(") ");i.push({color:rgbaToHex(t[0]+")"),i:parseFloat(t[1])/100})}else{let t=e.split(" ");t.length>2?i.push({color:t[1],i:parseFloat(t[2])/100}):i.push({color:t[0],i:parseFloat(t[1])/100})}})),{angle:parseFloat(t[0]),colors:i}}return{angle:parseFloat(t[0]),colors:[]}}return{angle:0,colors:[]}}function rgbaToHex(e){if(/rgba?/.test(e)){let t=e.split(",");if(t.length<3)return"";e="#";for(let i,n=0;i=t[n++];)if(n<4)i=parseInt(i.replace(/[^\d]/gi,""),10).toString(16),e+=1==i.length?"0"+i:i;else{i=i.replace(")","");let t=parseInt(255*i+"").toString(16);t=2===t.length?t:"0"+t,e+=t}e=e.toUpperCase()}return e}function getLineGradient(e,t){const{x:i,y:n,ex:o,width:s,height:r,center:a}=t.calculative.worldRect;let l=[{x:o,y:n+r/2},{x:i,y:n+r/2}];const{angle:c,colors:h}=formatGradient(t.calculative.lineGradientColors);let d=getGradientR(c,s,r);return l.forEach((e=>{rotatePoint(e,c,a)})),getLinearGradient(e,l,h,d)}function getLinearGradient(e,t,i,n){let o=getLinearGradientPoints(t[0].x,t[0].y,t[1].x,t[1].y,n),s=e.createLinearGradient(o[0],o[1],o[2],o[3]);return i.forEach((e=>{s.addColorStop(e.i,e.color)})),s}function drawLinearGradientLine(e,t,i){let n=[];t.calculative.gradientColorStop?n=t.calculative.gradientColorStop:(n=formatGradient(t.calculative.lineGradientColors).colors,t.calculative.gradientColorStop=n),e.strokeStyle=getLinearGradient(e,i,n,t.calculative.lineWidth/2),e.beginPath(),e.moveTo(i[0].x,i[0].y),e.lineTo(i[1].x,i[1].y),e.stroke()}function ctxDrawLinearGradientPath(e,t){const i=t.calculative.worldAnchors;let n=t.calculative.lineWidth*(t.calculative.gradientSmooth||t.calculative.lineSmooth||0);for(let o=0;o<i.length-1;o++)if("curve"!==t.lineName&&"mind"!==t.lineName||!i[o].curvePoints){let s=i[o],r=i[o+1];if(o>0&&o<i.length-1){let s=i[o-1].curvePoints;smoothTransition(e,t,n,s?s[s.length-1]:i[o-1],i[o],i[o+1])}o>0&&o<i.length-1&&(s=getSmoothAdjacent(n,i[o],i[o+1])),o<i.length-2&&(r=getSmoothAdjacent(n,i[o+1],i[o]));let a=!1;if(0===o&&t.fromLineCap&&"butt"!==t.fromLineCap&&(e.save(),a=!0,e.lineCap=t.fromLineCap),0!==o&&o===i.length-2&&t.toLineCap&&"butt"!==t.toLineCap&&(e.save(),a=!0,e.lineCap=t.toLineCap),drawLinearGradientLine(e,t,[s,r]),a&&e.restore(),2===i.length&&0===o){e.save(),a=!0,e.lineCap=t.toLineCap;let i=.1,n=.1;s.x-r.x===0?n=0:i=(s.y-r.y)/(s.x-r.x)*.1,drawLinearGradientLine(e,t,[{x:r.x-n,y:r.y-i},r]),e.restore()}}else{if(o>0){let s=i[o-1].curvePoints;smoothTransition(e,t,n,s?s[s.length-1]:i[o-1],i[o],i[o].curvePoints[0]),drawLinearGradientLine(e,t,[getSmoothAdjacent(n,i[o],i[o].curvePoints[0]),i[o].curvePoints[1]])}else drawLinearGradientLine(e,t,[i[o],i[o].curvePoints[0]]),drawLinearGradientLine(e,t,[i[o].curvePoints[0],i[o].curvePoints[1]]);let s=i[o].curvePoints.length-1;for(let n=1;n<s;n++)drawLinearGradientLine(e,t,[i[o].curvePoints[n],i[o].curvePoints[n+1]]);let r=getSmoothAdjacent(n,i[o+1],i[o].curvePoints[s]);drawLinearGradientLine(e,t,[i[o].curvePoints[s],r])}}function getSmoothAdjacent(e,t,i){let n=Math.sqrt((i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y));return 0===n?{x:t.x,y:t.y}:e<n?{x:t.x+(i.x-t.x)*e/n,y:t.y+(i.y-t.y)*e/n}:{x:t.x+(i.x-t.x)/n/2,y:t.y+(i.y-t.y)/n/2}}function smoothTransition(e,t,i,n,o,s){let r=getSmoothAdjacent(i,o,n),a=getSmoothAdjacent(i,o,s),l={x:o.x,y:o.y},c=getBezierPoints(t.calculative.canvas.store.data.smoothNum||20,r,l,a);for(let h=0;h<c.length-1;h++)drawLinearGradientLine(e,t,[{x:c[h].x,y:c[h].y},{x:c[h+1].x,y:c[h+1].y}])}function smoothAnimateTransition(e,t,i,n){let o=getSmoothAdjacent(t,i,n),s={x:i.x,y:i.y};e.quadraticCurveTo(s.x,s.y,o.x,o.y)}function getGradientAnimatePath(e){const t=e.calculative.worldAnchors;let i=e.calculative.lineWidth*(e.calculative.gradientSmooth||e.calculative.lineSmooth||0);const n=new Path2D;for(let o=0;o<t.length-1;o++){t[o];let e=t[o+1];if(0==o&&n.moveTo(t[o].x,t[o].y),o>0&&o<t.length-1){t[o-1].curvePoints;smoothAnimateTransition(n,i,t[o],t[o+1])}o>0&&o<t.length-1&&getSmoothAdjacent(i,t[o],t[o+1]),o<t.length-2&&(e=getSmoothAdjacent(i,t[o+1],t[o])),n.lineTo(e.x,e.y)}return n}function getBezierPoints(e=100,t,i,n,o){let s=null;const r=[];n||o?n&&!o?s=twoBezier:n&&o&&(s=threeBezier):s=oneBezier;for(let a=0;a<e;a++)r.push(s(a/e,t,i,n,o));return o?r.push(o):n&&r.push(n),r}function oneBezier(e,t,i){const{x:n,y:o}=t,{x:s,y:r}=i;return{x:n+(s-n)*e,y:o+(r-o)*e}}function twoBezier(e,t,i,n){const{x:o,y:s}=t,{x:r,y:a}=i,{x:l,y:c}=n;return{x:(1-e)*(1-e)*o+2*e*(1-e)*r+e*e*l,y:(1-e)*(1-e)*s+2*e*(1-e)*a+e*e*c}}function threeBezier(e,t,i,n,o){const{x:s,y:r}=t,{x:a,y:l}=o,{x:c,y:h}=i,{x:d,y:u}=n;return{x:s*(1-e)*(1-e)*(1-e)+3*c*e*(1-e)*(1-e)+3*d*e*e*(1-e)+a*e*e*e,y:r*(1-e)*(1-e)*(1-e)+3*h*e*(1-e)*(1-e)+3*u*e*e*(1-e)+l*e*e*e}}function strokeLinearGradient(e,t){const{worldRect:i,lineGradientFromColor:n,lineGradientToColor:o,lineGradientAngle:s}=t.calculative;return linearGradient(e,i,n,o,s)}function linearGradient(e,t,i,n,o){if(!i||!n)return;const{x:s,y:r,center:a,ex:l,ey:c}=t,h={x:s,y:a.y},d={x:l,y:a.y};o%90==0&&o%180?(h.x=a.x,d.x=a.x,o%270?(h.y=r,d.y=c):(h.y=c,d.y=r)):o&&(rotatePoint(h,o,t.center),rotatePoint(d,o,t.center));const u=e.createLinearGradient(h.x,h.y,d.x,d.y);return u.addColorStop(0,i),u.addColorStop(1,n),u}function getImagePosition(e){const{worldIconRect:t,iconWidth:i,iconHeight:n,imgNaturalWidth:o,imgNaturalHeight:s}=e.calculative;let{x:r,y:a,width:l,height:c}=t;if(i&&(l=i),n&&(c=n),o&&s&&e.imageRatio){const e=t.width/o,r=t.height/s,a=Math.min(e,r),h=o/s;i?c=i/h:n?l=n*h:(l=a*o,c=a*s)}switch(r+=(t.width-l)/2,a+=(t.height-c)/2,e.iconAlign){case"top":a=t.y;break;case"bottom":a=t.ey-c;break;case"left":r=t.x;break;case"right":r=t.ex-l;break;case"left-top":r=t.x,a=t.y;break;case"right-top":r=t.ex-l,a=t.y;break;case"left-bottom":r=t.x,a=t.ey-c;break;case"right-bottom":r=t.ex-l,a=t.ey-c}return{x:r,y:a,width:l,height:c}}function drawImage(e,t){const{x:i,y:n,width:o,height:s}=getImagePosition(t),{worldIconRect:r,iconRotate:a,img:l}=t.calculative;if(e.filter=t.filter,a){const{x:t,y:i}=r.center;e.translate(t,i),e.rotate(a*Math.PI/180),e.translate(-t,-i)}if(t.imageRadius){e.save();let r=t.calculative.imageRadius||0,a=r;const{x:c,y:h,width:d,height:u,ex:p,ey:f}=t.calculative.worldRect;r<1&&(r*=d,a*=u);let v=r<a?r:a;d<2*v&&(v=d/2),u<2*v&&(v=u/2),e.beginPath(),e.moveTo(c+v,h),e.arcTo(p,h,p,f,v),e.arcTo(p,f,c,f,v),e.arcTo(c,f,c,h,v),e.arcTo(c,h,p,h,v),e.clip(),e.drawImage(l,i,n,o,s),e.restore()}else{let r=n,a=0;if(t.thumbImg){a=(s/o*l.naturalWidth-l.naturalHeight)/2,r=n+a}e.drawImage(l,i,r,o,s-2*a)}}function getTextColor(e,t){const{textColor:i,color:n}=e.calculative,{styles:o}=t;return i||n||o.textColor||o.color}function drawText(e,t){const{fontStyle:i,fontWeight:n,fontSize:o,fontFamily:s,lineHeight:r,text:a,hiddenText:l,canvas:c,textHasShadow:h,textBackground:d,textType:u}=t.calculative;if(null==a||l)return;const p=c.store;let f,v;e.save(),h||(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),t.calculative.disabled?f=t.disabledTextColor||t.disabledColor||pSBC(.4,getTextColor(t,p)):t.calculative.hover?f=t.hoverTextColor||t.hoverColor||p.styles.hoverColor:t.calculative.active&&(f=t.activeTextColor||t.activeColor||p.styles.activeColor),u===Gradient.Linear?v=getTextGradient(e,t):u===Gradient.Radial&&(v=getTextRadialGradient(e,t)),e.fillStyle=f||v||getTextColor(t,p),e.font=getFont({fontStyle:i,fontWeight:n,fontFamily:s||p.options.fontFamily,fontSize:o,lineHeight:r}),!t.calculative.textDrawRect&&calcTextDrawRect(e,t);const{x:g,y:y,width:m,height:w}=t.calculative.textDrawRect;d&&(e.save(),e.fillStyle=d,e.fillRect(g,y,m,w),e.restore());const b=.55,x=t.textAlign||p.options.textAlign,k=o*r;t.calculative.textLines.forEach(((i,n)=>{const s=t.calculative.textLineWidths[n];let r=0;"center"===x?r=(m-s)/2:"right"===x&&(r=m-s),e.fillText(i,g+r,y+(n+b)*k);const{textDecorationColor:a,textDecorationDash:l,textDecoration:c}=t;c&&drawUnderLine(e,{x:g+r,y:y+(n+b)*k,width:s},{textDecorationColor:a,textDecorationDash:l,fontSize:o});const{textStrickoutColor:h,textStrickoutDash:d,textStrickout:u}=t;u&&drawStrickout(e,{x:g+r,y:y+(n+b)*k,width:s},{textStrickoutColor:h,textStrickoutDash:d,fontSize:o})})),e.restore()}function drawUnderLine(e,t,i){const{textDecorationColor:n,textDecorationDash:o,fontSize:s}=i;let{x:r,y:a,width:l}=t;switch(e.textBaseline){case"top":a+=s;break;case"middle":a+=s/2}e.save(),e.beginPath(),e.strokeStyle=n||e.fillStyle,e.lineWidth=1,e.moveTo(r,a),e.setLineDash(o||[]),e.lineTo(r+l,a),e.stroke(),e.restore()}function drawStrickout(e,t,i){const{textStrickoutColor:n,textStrickoutDash:o,fontSize:s}=i;let{x:r,y:a,width:l}=t;switch(e.textBaseline){case"top":a+=s/2;break;case"bottom":a-=s/2}e.save(),e.beginPath(),e.strokeStyle=n||e.fillStyle,e.lineWidth=1,e.moveTo(r,a),e.setLineDash(o||[]),e.lineTo(r+l,a),e.stroke(),e.restore()}function drawFillText(e,t,i){if(null==i)return;const{fontStyle:n,fontWeight:o,fontSize:s,fontFamily:r,lineHeight:a,canvas:l}=t.calculative,c=l.store;let h;e.save(),t.calculative.hover?h=t.hoverTextColor||t.hoverColor||c.styles.hoverColor:t.calculative.active&&(h=t.activeTextColor||t.activeColor||c.styles.activeColor),e.fillStyle=h||getTextColor(t,c),e.font=getFont({fontStyle:n,fontWeight:o,fontFamily:r||c.options.fontFamily,fontSize:s,lineHeight:a});const d=e.measureText(i).width;let u,p;for(const f of t.calculative.worldAnchors){if(!p){p=f;continue}const t=distance(p,f),n=Math.floor(t/d);u="";for(let e=0;e<n;e++)u+=i;const o=calcRotate(p,f)-270;if(e.save(),o%360!=0){const{x:t,y:i}=p;e.translate(t,i);let n=o*Math.PI/180;e.rotate(n),e.translate(-t,-i)}e.fillText(u,p.x,p.y+a/2),e.restore(),p=f}e.restore()}function drawIcon(e,t){const i=t.calculative.canvas.store;e.save(),e.shadowColor="",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.textAlign="center",e.textBaseline="middle";const n=t.calculative.worldIconRect;let o=n.x+n.width/2,s=n.y+n.height/2;switch(t.iconAlign){case"top":s=n.y,e.textBaseline="top";break;case"bottom":s=n.ey,e.textBaseline="bottom";break;case"left":o=n.x,e.textAlign="left";break;case"right":o=n.ex,e.textAlign="right";break;case"left-top":o=n.x,s=n.y,e.textAlign="left",e.textBaseline="top";break;case"right-top":o=n.ex,s=n.y,e.textAlign="right",e.textBaseline="top";break;case"left-bottom":o=n.x,s=n.ey,e.textAlign="left",e.textBaseline="bottom";break;case"right-bottom":o=n.ex,s=n.ey,e.textAlign="right",e.textBaseline="bottom"}const r=t.calculative.iconWeight;let a;const l=t.calculative.iconFamily;a=t.calculative.iconSize>0?t.calculative.iconSize:n.width>n.height?n.height:n.width,e.font=getFont({fontSize:a,fontWeight:r,fontFamily:l}),e.fillStyle=t.calculative.iconColor||getTextColor(t,i),t.calculative.iconRotate&&(e.translate(n.center.x,n.center.y),e.rotate(t.calculative.iconRotate*Math.PI/180),e.translate(-n.center.x,-n.center.y)),e.beginPath(),e.fillText(t.calculative.icon,o,s),e.restore()}function drawDropdown(e,t){const i=t.calculative.canvas.store.data.scale,n=t.calculative.canvas.inputDiv.dataset.penId,{x:o,y:s,width:r,height:a}=t.calculative.worldRect;e.save(),e.beginPath(),t.id===n?(e.moveTo(o+r-20*i,s+a/2+2*i),e.lineTo(o+r-14*i,s+a/2-4*i),e.lineTo(o+r-8*i,s+a/2+2*i)):(e.moveTo(o+r-20*i,s+a/2-4*i),e.lineTo(o+r-14*i,s+a/2+2*i),e.lineTo(o+r-8*i,s+a/2-4*i)),e.stroke(),e.restore()}function getFont({fontStyle:e="normal",textDecoration:t="normal",fontWeight:i="normal",fontSize:n=12,fontFamily:o="Arial",lineHeight:s=1}={}){return`${e} ${t} ${i} ${n}px/${s} ${o}`}function ctxFlip(e,t){const{x:i,ex:n,y:o,ey:s}=t.calculative.worldRect||{};t.calculative.flipX&&(e.translate(i+n,0),e.scale(-1,1)),t.calculative.flipY&&(e.translate(0,o+s),e.scale(1,-1))}function ctxRotate(e,t,i=!1){const{x:n,y:o}=t.calculative.worldRect.pivot||t.calculative.worldRect.center;e.translate(n,o);let s=t.calculative.rotate*Math.PI/180;i||(t.calculative.flipX&&(s*=-1),t.calculative.flipY&&(s*=-1)),e.rotate(s),e.translate(-n,-o)}function renderPen(e,t,i){e.save(),e.translate(.5,.5),e.beginPath(),drawFilter(e,t);const n=t.calculative.canvas.store,o=t.textFlip||n.options.textFlip,s=t.textRotate||n.options.textRotate;let r;o&&s||e.save(),ctxFlip(e,t),t.calculative.rotate&&"line"!==t.name&&ctxRotate(e,t),(t.calculative.lineWidth>1||i)&&(e.lineWidth=t.calculative.lineWidth),inspectRect(e,n,t);let a,l=!1;t.calculative.disabled?(a=t.disabledColor||n.styles.disabledColor||pSBC(.4,t.calculative.color||n.styles.color),r=t.disabledBackground||n.styles.disabledBackground||pSBC(.4,t.calculative.background||n.styles.penBackground)):t.mouseDownValid&&t.calculative.mouseDown?(a=t.mouseDownColor||pSBC(-.4,t.calculative.color||n.styles.color),r=t.mouseDownBackground||pSBC(-.4,t.calculative.background||n.styles.penBackground)):t.switch&&t.calculative.checked?t.calculative.bkType||(r=t.onBackground):t.calculative.hover?(a=t.hoverColor||n.styles.hoverColor,r=t.hoverBackground||n.styles.hoverBackground):t.calculative.active?(a=t.activeColor||n.styles.activeColor,r=t.activeBackground||n.styles.activeBackground):t.calculative.isDock&&(t.type===PenType.Line?a=n.styles.dockPenColor:r=rgba(n.styles.dockPenColor,.2));const c=t.calculative.strokeImg;if(t.calculative.strokeImage&&c)e.strokeStyle=a||e.createPattern(c,"repeat");else{let i;t.calculative.strokeType?t.calculative.lineGradientColors?"line"===t.name?l=!0:t.calculative.lineGradient?i=t.calculative.lineGradient:(i=getLineGradient(e,t),t.calculative.lineGradient=i):i=strokeLinearGradient(e,t):i=t.calculative.color||(t.type?n.data.lineColor:"")||n.styles.color,e.strokeStyle=a||i}const h=t.calculative.backgroundImg;if(t.calculative.backgroundImage&&h)e.fillStyle=r||e.createPattern(h,"repeat"),r=!0;else{let i;t.calculative.bkType===Gradient.Linear?t.calculative.gradientColors?t.calculative.gradient?i=t.calculative.gradient:(i=getBkGradient(e,t),t.calculative.gradient=i):i=drawBkLinearGradient(e,t):t.calculative.bkType===Gradient.Radial?t.calculative.gradientColors?t.calculative.radialGradient?i=t.calculative.radialGradient:(i=getBkRadialGradient(e,t),t.calculative.radialGradient=i):i=drawBkRadialGradient(e,t):i=t.calculative.background||n.styles.penBackground,e.fillStyle=r||i,r=!!i}if(setLineCap(e,t),setLineJoin(e,t),setGlobalAlpha(e,t),t.calculative.lineDash&&e.setLineDash(t.calculative.lineDash.map((e=>e*t.calculative.canvas.store.data.scale))),t.calculative.lineDashOffset&&(e.lineDashOffset=t.calculative.lineDashOffset),t.calculative.shadowColor&&(e.shadowColor=t.calculative.shadowColor,e.shadowOffsetX=t.calculative.shadowOffsetX,e.shadowOffsetY=t.calculative.shadowOffsetY,e.shadowBlur=t.calculative.shadowBlur),l?(ctxDrawLinearGradientPath(e,t),ctxDrawLinePath(!0,e,t,n)):(ctxDrawPath(!0,e,t,n,r),ctxDrawCanvas(e,t)),t.image&&t.calculative.img||!t.calculative.icon||drawIcon(e,t),t.dropdownList&&drawDropdown(e,t),o&&s||e.restore(),o&&!s&&ctxFlip(e,t),!o&&s&&t.calculative.rotate&&"line"!==t.name&&ctxRotate(e,t,!0),drawText(e,t),t.type===PenType.Line&&t.fillTexts)for(const d of t.fillTexts)drawFillText(e,t,d);e.restore()}function setLineCap(e,t){const i=t.lineCap||(t.type?"round":"square");i?e.lineCap=i:t.type&&(e.lineCap="round")}function setLineJoin(e,t){const i=t.lineJoin;i?e.lineJoin=i:t.type&&(e.lineJoin="round")}function renderPenRaw$1(e,t,i,n){var o;e.save(),i&&e.translate(-i.x,-i.y),null==(o=e.setAttrs)||o.call(e,t);let s=!1;const r=t.calculative.canvas.store,a=t.textFlip||r.options.textFlip,l=t.textRotate||r.options.textRotate;let c;if(e.beginPath(),a&&l||e.save(),t.calculative.flipX&&(e.translate(t.calculative.worldRect.x+t.calculative.worldRect.ex,0),e.scale(-1,1)),t.calculative.flipY&&(e.translate(0,t.calculative.worldRect.y+t.calculative.worldRect.ey),e.scale(1,-1)),t.calculative.rotate&&"line"!==t.name&&ctxRotate(e,t),(t.calculative.lineWidth>1||n)&&(e.lineWidth=t.calculative.lineWidth),t.calculative.hover)e.strokeStyle=t.hoverColor||r.styles.hoverColor,e.fillStyle=t.hoverBackground||r.styles.hoverBackground,c=t.hoverBackground||r.styles.hoverBackground;else if(t.calculative.active)e.strokeStyle=t.activeColor||r.styles.activeColor,e.fillStyle=t.activeBackground||r.styles.activeBackground,c=t.activeBackground||r.styles.activeBackground;else{if(t.strokeImage)t.calculative.strokeImg&&(e.strokeStyle=e.createPattern(t.calculative.strokeImg,"repeat"),c=!0);else{let i;t.calculative.strokeType&&t.calculative.lineGradientColors&&"line"===t.name?s=!0:i=t.calculative.color||r.styles.color,e.strokeStyle=i}t.backgroundImage?t.calculative.backgroundImg&&(e.fillStyle=e.createPattern(t.calculative.backgroundImg,"repeat"),c=!0):(e.fillStyle=t.background,c=!!t.background)}if(setLineCap(e,t),setLineJoin(e,t),setGlobalAlpha(e,t),t.calculative.lineDash&&e.setLineDash(t.calculative.lineDash),t.calculative.lineDashOffset&&(e.lineDashOffset=t.calculative.lineDashOffset),t.calculative.shadowColor&&(e.shadowColor=t.calculative.shadowColor,e.shadowOffsetX=t.calculative.shadowOffsetX,e.shadowOffsetY=t.calculative.shadowOffsetY,e.shadowBlur=t.calculative.shadowBlur),s?(ctxDrawLinearGradientPath(e,t),ctxDrawLinePath(!0,e,t,r)):(ctxDrawPath(!1,e,t,r,c),ctxDrawCanvas(e,t)),t.calculative.img?(e.save(),e.shadowColor="",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,drawImage(e,t),e.restore()):t.calculative.icon&&drawIcon(e,t),t.dropdownList&&drawDropdown(e,t),a&&l||e.restore(),a&&!l&&(t.calculative.flipX&&(e.translate(t.calculative.worldRect.x+t.calculative.worldRect.ex,0),e.scale(-1,1)),t.calculative.flipY&&(e.translate(0,t.calculative.worldRect.y+t.calculative.worldRect.ey),e.scale(1,-1))),!a&&l&&t.calculative.rotate&&"line"!==t.name&&ctxRotate(e,t,!0),drawText(e,t),t.type===PenType.Line&&t.fillTexts)for(const h of t.fillTexts)drawFillText(e,t,h);e.restore()}function ctxDrawPath(e=!0,t,i,n,o){if("drawCommand"===i.name)return;const s=e?n.path2dMap.get(i):globalStore.path2dDraws[i.name];let r=null,a=null;if(i.type===PenType.Line&&(i.fromLineCap&&"butt"!==i.fromLineCap&&(t.lineCap="butt",r=new Path2D,r.moveTo(i.calculative.worldAnchors[0].x,i.calculative.worldAnchors[0].y),r.lineTo(i.calculative.worldAnchors[0].x,i.calculative.worldAnchors[0].y)),i.toLineCap&&"butt"!==i.toLineCap&&(t.lineCap="butt",a=new Path2D,a.moveTo(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].x,i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].y),a.lineTo(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].x,i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].y))),s){if(i.type===PenType.Line&&i.borderWidth){t.save(),t.beginPath();const e=i.calculative.lineWidth+i.calculative.borderWidth;t.lineWidth=e,t.strokeStyle=i.borderColor,r&&(t.save(),t.lineCap=i.fromLineCap,t.stroke(r),t.restore()),s instanceof Path2D?(o&&t.fill(s),e&&t.stroke(s)):(s(i,t),o&&t.fill(),e&&t.stroke()),a&&(t.save(),t.lineCap=i.toLineCap,t.stroke(a),t.restore()),t.restore()}s instanceof Path2D?i.type?i.close&&o&&t.fill(s):o&&t.fill(s):(t.save(),s(i,t),o&&t.fill(),t.restore());const e=i.calculative.progress;if(null!=e){t.save();const{ex:o,x:r,y:a,width:l,height:c,ey:h}=i.calculative.worldRect;let d=null;if(d=i.calculative.verticalProgress?i.reverseProgress?t.createLinearGradient(r,a,r,a+c*e):t.createLinearGradient(r,h,r,a+c*(1-e)):i.reverseProgress?t.createLinearGradient(o,a,r+l*(1-e),a):t.createLinearGradient(r,a,r+l*e,a),i.calculative.progressGradientColors){const{colors:e}=formatGradient(i.calculative.progressGradientColors);e.forEach((e=>{d.addColorStop(e.i,e.color)}))}else{const e=i.calculative.progressColor||i.calculative.color||n.options.activeColor||n.data.color;d.addColorStop(0,e),d.addColorStop(1,e)}d.addColorStop(1,"transparent"),t.fillStyle=d,s instanceof Path2D?t.fill(s):(s(i,t),t.fill()),t.restore()}if(i.calculative.lineWidth&&(s instanceof Path2D?(n.options.svgPathStroke||"svgPath"!==i.name)&&(r&&(t.save(),t.lineCap=i.fromLineCap,t.stroke(r),t.restore()),t.stroke(s),a&&(t.save(),t.lineCap=i.toLineCap,t.stroke(a),t.restore())):(s(i,t),t.stroke())),i.type){if(i.calculative.animatePos){if(t.save(),setCtxLineAnimate(t,i,n),i.lineAnimateType===LineAnimateType.Arrow||i.lineAnimateType===LineAnimateType.WaterDrop){let e=drawArrow(i,t);e instanceof Path2D?(t.stroke(e),t.fill(e)):(t.stroke(),t.fill())}else s instanceof Path2D?(r&&!i.lineAnimateType&&(t.save(),t.lineCap=i.fromLineCap,t.stroke(r),t.restore()),t.lineCap=i.lineCap,t.stroke(s)):(s(i,t),t.stroke());t.restore()}i.fromArrow&&renderFromArrow(t,i,n),i.toArrow&&renderToArrow(t,i,n),!i.calculative.active||i.calculative.pencil||n.options.disableAnchor||n.data.locked||renderLineAnchors(t,i)}}}function ctxDrawLinePath(e=!0,t,i,n){const o=e?n.path2dMap.get(i):globalStore.path2dDraws[i.name];if(o&&i.type){if(i.calculative.animatePos){if(t.save(),setCtxLineAnimate(t,i,n),t.beginPath(),o instanceof Path2D)if("polyline"===i.lineName||"line"===i.lineName)if(i.lineAnimateType===LineAnimateType.Arrow||i.lineAnimateType===LineAnimateType.WaterDrop){const e=drawArrow(i);t.stroke(e),t.fill(e)}else i.calculative.gradientSmooth||i.calculative.lineSmooth?(i.calculative.gradientAnimatePath||(i.calculative.gradientAnimatePath=getGradientAnimatePath(i)),i.calculative.gradientAnimatePath instanceof Path2D&&t.stroke(i.calculative.gradientAnimatePath)):t.stroke(o);else t.stroke(o);else o(i,t),t.stroke();t.restore()}i.fromArrow&&renderFromArrow(t,i,n),i.toArrow&&renderToArrow(t,i,n),!i.calculative.active||i.calculative.pencil||n.options.disableAnchor||n.data.locked||renderLineAnchors(t,i)}}function setCtxLineAnimate(e,t,i){e.strokeStyle=t.animateColor||i.styles.animateColor,t.animateShadow&&(e.shadowBlur=t.animateShadowBlur||t.animateLineWidth||6,e.shadowColor=t.animateShadowColor||t.animateColor||i.styles.animateColor),t.calculative.animateLineWidth&&(e.lineWidth=t.calculative.animateLineWidth*i.data.scale);let n=0;switch(t.lineAnimateType){case LineAnimateType.Beads:t.animateReverse?e.lineDashOffset=t.calculative.animatePos:e.lineDashOffset=t.length-t.calculative.animatePos,n=t.calculative.lineWidth||5,n<5&&(n=5);const o=t.animateLineDash&&t.animateLineDash.map((e=>e*n/5));e.setLineDash(o||[n,2*n]);break;case LineAnimateType.Dot:t.animateReverse?e.lineDashOffset=t.calculative.animatePos:e.lineDashOffset=t.length-t.calculative.animatePos,n=t.calculative.animateDotSize||2*t.calculative.lineWidth||6,n<6&&(n=6),n>40&&(n=40),e.lineWidth=(t.calculative.animateLineWidth||n)*i.data.scale,e.setLineDash([.1,t.length]);break;case LineAnimateType.Arrow:case LineAnimateType.WaterDrop:e.fillStyle=t.animateColor||i.styles.animateColor,e.lineWidth=1;break;case LineAnimateType.Custom:if(t.trackTargets&&t.trackTargets.length){setTrackAnimateOnPen(t,t.trackTargets);break}setElementAnimateOnPen(e,t,t.lineAnimateElement);break;default:t.animateReverse?(e.lineDashOffset=Number.EPSILON,e.setLineDash([0,t.length-t.calculative.animatePos+1,t.calculative.animatePos])):e.setLineDash([t.calculative.animatePos,t.length+.01-t.calculative.animatePos])}}function setTrackAnimateOnPen(e,t){if(!Array.isArray(t))return;const i=e.calculative.canvas.store.data.origin,n=e.calculative.canvas.store.data.scale;t.forEach((t=>{var o,s,r;const a=e.calculative.canvas.store.pens[t.id],l=e.calculative.canvas.parent;if(!a)return;const c=calculateLineFrameStates(e,null==(o=t.offset)?void 0:o.instance);if(!c)return;const h=a.width,d=a.height,u=c.x-h/2,p=c.y-d/2,f=(u-i.x)/n,v=(p-i.y)/n,g=h/n,y=d/n,m={x:f+((null==(s=t.offset)?void 0:s.x)||0),y:v+((null==(r=t.offset)?void 0:r.y)||0),width:g,height:y,rotate:c.rotate};l.setValue({id:a.id,...m})}))}function setElementAnimateOnPen(e,t,i){const n=globalStore.lineAnimateDraws[i];n&&renderElementOnLine(e,t,n)}function renderElementOnLine(e,t,i){if(t.lineAnimateDash){const n=Array.isArray(t.lineAnimateDash)?t.lineAnimateDash:t.lineAnimateDash.split(",").map((e=>Number(e))),o=t.calculative.canvas.store.data.scale;computeLineDashSegments(getLineLength(t)/o,n,t.lineAnimateDashOffset,t.lineAnimateElementCount).forEach(((n,o)=>{const s=calculateLineFrameStates(t,n.start);if(s){s.index=n.start,s.calculateLineFrameStates=calculateLineFrameStates;try{e.save(),i(e,t,s,o),e.restore()}catch(r){e.restore()}}}))}}function computeLineDashSegments(e,t,i=0,n,o=0){const s=[];if(!t||0===t.length)return s.push({start:0,end:e,isDash:!0}),s;const r=t.reduce(((e,t)=>e+t),0);let a=(-i+o)%r;a<0&&(a+=r);let l=0,c=0;for(n||(n=1/0);c<e&&l<n;)for(let i=0;i<t.length;i++){let r=c+t[i]-a;if(r>e&&(r=e),i%2==0&&r>c){const t=(c+o)%e,i=(r+o)%e;s.push({start:t,end:i,isDash:!0}),l+=1}if(c=r,a=0,c>=e||l>=n)break}return s}function calculateLineFrameStates(e,t=0){let i,n=null;if(e.calculative.worldAnchors.forEach((e=>{n&&(i=createSvgPath(i,n,n.next,e.prev,e)),n=e})),e.close){let t=e.calculative.worldAnchors[0];i=createSvgPath(i,n,n.next,t.prev,t)}let o=0;o=e.animateReverse?e.length-e.calculative.animatePos-t*e.calculative.canvas.store.data.scale:e.calculative.animatePos-t*e.calculative.canvas.store.data.scale;return getLinePointPosAndAngle(i,o)}function renderLineAnchors(e,t){const i=t.calculative.canvas.store;e.save(),e.lineWidth=1,e.fillStyle=t.activeColor||i.styles.activeColor,t.calculative.worldAnchors.forEach((i=>{!i.hidden&&!i.isTemp&&renderAnchor(e,i,t)})),e.restore()}function renderAnchor(e,t,i){if(!t)return;const n=i.calculative.canvas.store.activeAnchor===i.calculative.activeAnchor&&i.calculative.activeAnchor===t;let o=3;i.calculative.lineWidth>3&&(o=i.calculative.lineWidth),i.anchorRadius&&(o=i.anchorRadius),t.radius&&(o=t.radius),n?(t.prev&&(e.save(),e.strokeStyle="#4dffff",e.beginPath(),e.moveTo(t.prev.x,t.prev.y),e.lineTo(t.x,t.y),e.stroke(),e.restore(),e.save(),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.prev.x,t.prev.y,o,0,2*Math.PI),e.fill(),e.stroke(),e.restore()),t.next&&(e.save(),e.strokeStyle="#4dffff",e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.next.x,t.next.y),e.stroke(),e.restore(),e.save(),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.next.x,t.next.y,o,0,2*Math.PI),e.fill(),e.stroke(),e.restore(),e.beginPath(),e.arc(t.x,t.y,o,0,2*Math.PI),e.fill(),e.stroke()),e.beginPath(),e.arc(t.x,t.y,o,0,2*Math.PI),e.fill(),e.stroke()):(e.save(),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.x,t.y,o,0,2*Math.PI),e.fill(),e.stroke(),e.restore())}function calcWorldRects(e){const t=e.calculative.canvas.store;let i={x:e.x,y:e.y};if(!e.parentId||e.parentId&&!t.pens[e.parentId])e.parentId=void 0,i.width=e.width,i.height=e.height,i.rotate=e.rotate,calcRightBottom(i),calcCenter(i),e.pivot&&calcPivot(i,e.pivot);else{const n=t.pens[e.parentId];let o=n.calculative.worldRect;o||(o=calcWorldRects(n)),i.x=o.x+o.width*e.x,i.y=o.y+o.height*e.y,i.width=o.width*e.width,i.height=o.height*e.height,n.flipX&&(i.x=o.width-(i.x-o.x+i.width)+o.x),n.flipY&&(i.y=o.height-(i.y-o.y+i.height)+o.y),calcRightBottom(i),i.rotate=o.rotate+e.rotate,calcCenter(i),e.pivot&&calcPivot(i,e.pivot)}return e.calculative.worldRect=i,calcPadding(e,i),i}function calcPadding(e,t){!e.paddingTop&&(e.calculative.paddingTop=0),!e.paddingBottom&&(e.calculative.paddingBottom=0),!e.paddingLeft&&(e.calculative.paddingLeft=0),!e.paddingRight&&(e.calculative.paddingRight=0),Math.abs(e.calculative.paddingTop)<1&&(e.calculative.paddingTop*=t.height),Math.abs(e.calculative.paddingBottom)<1&&(e.calculative.paddingBottom*=t.height),Math.abs(e.calculative.paddingLeft)<1&&(e.calculative.paddingLeft*=t.width),Math.abs(e.calculative.paddingRight)<1&&(e.calculative.paddingRight*=t.width)}function calcPenRect(e){const t=deepClone(e.calculative.worldRect);if(delete t.pivot,!e.parentId)return void Object.assign(e,t);const i=e.calculative.canvas.store.pens[e.parentId].calculative.worldRect;Object.assign(e,calcRelativeRect(t,i))}function calcWorldAnchors(e){const t=e.calculative.canvas.store;let i=[];if(e.anchors){let t=deepClone(e.anchors);e.flipX&&t.forEach((e=>{e.x=.5-(e.x-.5)})),e.flipY&&t.forEach((e=>{e.y=.5-(e.y-.5)})),t.forEach((t=>{i.push(calcWorldPointOfPen(e,t))}))}if(!i.length&&!e.type&&!e.calculative.canvas.parent.isCombine(e)){const{x:n,y:o,width:s,height:r}=e.calculative.worldRect;i=t.options.defaultAnchors.map(((t,i)=>({id:`${i}`,penId:e.id,x:n+s*t.x,y:o+r*t.y})))}e.calculative.rotate&&i.forEach((t=>{rotatePoint(t,e.calculative.rotate,e.calculative.worldRect.pivot||e.calculative.worldRect.center)})),e.type&&!e.anchors||(e.calculative.worldAnchors=i),e.calculative.activeAnchor&&i.length&&(e.calculative.activeAnchor=i.find((t=>{t.id,e.calculative.activeAnchor.id}))),e.calculative.gradientAnimatePath=void 0}function calcChildrenInitRect(e){var t;if(null==(t=e.children)?void 0:t.length){let t=e.calculative.worldRect;e.children.forEach((i=>{const n=e.calculative.canvas.store.pens[i];n.calculative.initRect&&n.calculative.initRelativeRect&&(n.calculative.initRect.x=t.x+t.width*n.calculative.initRelativeRect.x,n.calculative.initRect.y=t.y+t.height*n.calculative.initRelativeRect.y,n.calculative.initRect.ex=n.calculative.initRect.x+t.width*n.calculative.initRelativeRect.width,n.calculative.initRect.ey=n.calculative.initRect.y+t.height+n.calculative.initRelativeRect.height,calcCenter(n.calculative.initRect)),calcChildrenInitRect(n)}))}}function calcWorldPointOfPen(e,t){const i={...t},{x:n,y:o,width:s,height:r}=e.calculative.worldRect;return i.x=n+s*t.x,i.y=o+r*t.y,t.prev&&(i.prev={penId:e.id,connectTo:t.prev.connectTo,x:n+s*t.prev.x,y:o+r*t.prev.y}),t.next&&(i.next={penId:e.id,connectTo:t.next.connectTo,x:n+s*t.next.x,y:o+r*t.next.y}),i}function calcIconRect(e,t){const{paddingTop:i,paddingBottom:n,paddingLeft:o,paddingRight:s}=t.calculative;let r=o,a=i,l=t.calculative.worldRect.width-o-s,c=t.calculative.worldRect.height-i-n,h=t.calculative.iconLeft,d=t.calculative.iconTop;h&&Math.abs(h)<1&&(h=t.calculative.worldRect.width*h),d&&Math.abs(d)<1&&(d=t.calculative.worldRect.height*d),r+=h||0,a+=d||0,l-=h||0,c-=d||0;let u=t.calculative.iconRotate||0;if(t.parentId){const i=e[t.parentId].calculative;i&&(u+=i.rotate,u%=360)}r=t.calculative.worldRect.x+r,a=t.calculative.worldRect.y+a,t.calculative.worldIconRect={x:r,y:a,width:l,height:c,rotate:u},calcRightBottom(t.calculative.worldIconRect),calcCenter(t.calculative.worldIconRect)}function scalePen(e,t,i){scaleRect(e.calculative.worldRect,t,i,e.pivot),e.calculative.initRect&&scaleRect(e.calculative.initRect,t,i,e.pivot),scaleChildrenInitRect(e,t,i),e.calculative.x&&scalePoint(e.calculative,t,i),e.type&&calcWorldAnchors(e)}function scaleChildrenInitRect(e,t,i){var n;e&&(null==(n=e.children)?void 0:n.length)&&e.children.forEach((n=>{const o=e.calculative.canvas.store.pens[n];o&&(o.calculative.initRect&&scaleRect(o.calculative.initRect,t,i),scaleChildrenInitRect(o,t,i))}))}function pushPenAnchor(e,t){e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]);const i={id:t.id,penId:e.id,x:t.x,y:t.y};if(e.calculative.worldAnchors.push(i),e.calculative.worldRect){e.rotate%360&&rotatePoint(t,-e.rotate,e.calculative.worldRect.center);const i={id:t.id,penId:e.id,x:(t.x-e.calculative.worldRect.x)/e.calculative.worldRect.width,y:(t.y-e.calculative.worldRect.y)/e.calculative.worldRect.height};e.anchors.push(i)}return i}function addLineAnchor(e,t,i){e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]);const n=getSplitAnchor(e,t,i);return e.calculative.worldAnchors.splice(i+1,0,n),e.anchors.splice(i+1,0,calcRelativePoint(n,e.calculative.worldRect)),e.calculative.activeAnchor=n,n}function removePenAnchor(e,t){if(!e||!e.calculative.worldAnchors)return;let i=e.calculative.worldAnchors.findIndex((e=>e.id===t.id));i>-1&&e.calculative.worldAnchors.splice(i,1),i=e.anchors.findIndex((e=>e.id===t.id)),i>-1&&e.anchors.splice(i,1)}function facePen(e,t){if(!t||!t.calculative||!t.calculative.worldRect.center)return Direction.None;if(e.anchorId){let i=t.anchors.filter((t=>t.id===e.anchorId));if(i.length&&i[0].direction>-1)return i[0].direction}return facePoint(e,t.calculative.worldRect.center)}function nearestAnchor(e,t){let i,n=1/0;return e.calculative.worldAnchors.forEach((e=>{const o=distance(t,e);n>o&&(n=o,i=e)})),i}function translateLine(e,t,i){e.x+=t,e.y+=i,e.anchors&&e.anchors.forEach((e=>{translatePoint(e,t,i)})),e.calculative.worldAnchors&&e.calculative.worldAnchors.forEach((e=>{translatePoint(e,t,i)}))}function deleteTempAnchor(e){if(e&&e.calculative&&e.calculative.worldAnchors.length){let t=getToAnchor(e);if(e.anchors&&e.anchors.length)t===e.calculative.activeAnchor?e.calculative.worldAnchors=[e.calculative.worldAnchors[0]]:e.calculative.worldAnchors[0]===e.calculative.activeAnchor&&(e.calculative.worldAnchors=[e.calculative.worldAnchors[e.calculative.worldAnchors.length-1]]);else for(;e.calculative.worldAnchors.length&&t!==e.calculative.activeAnchor;)e.calculative.worldAnchors.pop(),t=getToAnchor(e)}}function connectLine(e,t,i,n){var o,s,r,a,l,c;if(!(e&&t&&i&&n&&t.twoWay!==TwoWay.DisableConnected&&t.twoWay!==TwoWay.Disable&&n.twoWay!==TwoWay.DisableConnectTo&&n.twoWay!==TwoWay.Disable))return;if(t.twoWay===TwoWay.In){if(1===i.calculative.worldAnchors.length)return;const e=getToAnchor(i);if(n.id!==e.id)return}if(t.twoWay===TwoWay.Out){const e=getFromAnchor(i);if(n.id!==e.id)return}if(n.connectTo===e.id&&n.anchorId===t.id)return;if(n.connectTo){const t=e.calculative.canvas.store.pens[n.connectTo];disconnectLine(t,getAnchor(t,n.anchorId),i,n)}e.connectedLines||(e.connectedLines=[]);e.connectedLines.findIndex((e=>e.lineId===i.id&&e.lineAnchor===n.id&&e.anchor===t.id))<0&&e.connectedLines.push({lineId:i.id,lineAnchor:n.id,anchor:t.id}),n.connectTo=e.id,n.anchorId=t.id,e.type&&connectLine(i,n,e,t),e.calculative.canvas.store.emitter.emit("connectLine",{line:i,lineAnchor:n,pen:e,anchor:t});let h=(null==(o=i.calculative.worldAnchors)?void 0:o.length)>=2?null==(s=i.calculative.worldAnchors)?void 0:s[0].connectTo:void 0,d=(null==(r=i.calculative.worldAnchors)?void 0:r.length)>=2?null==(l=i.calculative.canvas.store.pens[null==(a=i.calculative.worldAnchors)?void 0:a[0].connectTo])?void 0:l.anchors.find((e=>{var t;return e.id===(null==(t=i.calculative.worldAnchors)?void 0:t[0].anchorId)})):void 0;return null==(c=e.onConnectLine)||c.call(e,e,{line:i,lineAnchor:n,pen:e,anchor:t,fromPen:h,fromAnchor:d}),!0}function disconnectLine(e,t,i,n){if(e&&t&&i&&n&&e.connectedLines&&e.connectedLines.length)return i.lastConnected||(i.lastConnected={}),i.lastConnected[e.id]||(i.lastConnected[e.id]=deepClone(e.connectedLines)),e.connectedLines.forEach(((e,o,s)=>{e.lineId!==i.id&&e.lineId!==i.id||e.lineAnchor!==n.id||e.anchor!==t.id||s.splice(o,1)})),n.connectTo=void 0,n.anchorId=void 0,e.type&&t.connectTo===i.id&&t.anchorId===n.id&&disconnectLine(i,n,e,t),e.calculative.canvas.store.emitter.emit("disconnectLine",{line:i,lineAnchor:n,pen:e,anchor:t}),!0}function getAnchor(e,t){var i;if(e&&t)return null==(i=e.calculative.worldAnchors)?void 0:i.find((e=>e.id===t))}function getFromAnchor(e){if(e&&e.calculative.worldAnchors)return e.calculative.worldAnchors[0]}function getToAnchor(e){if(e&&e.calculative.worldAnchors)return e.calculative.worldAnchors[e.calculative.worldAnchors.length-1]}function setNodeAnimate(e,t){var i,n;if(0===e.calculative.start||!e.frames||!e.frames.length)return e.calculative.start=void 0,0;if(!e.calculative.duration){e.calculative.duration=0;for(const t of e.frames){e.calculative.duration+=t.duration;for(const i in t)"duration"===i||e[i]||"scale"===i&&(e[i]=1)}}if(e.animateCycle||(e.animateCycle=1/0),e.calculative.start){let i=0;const o=Math.ceil((t-e.calculative.start)/e.calculative.duration);if(o>e.animateCycle)return e.currentAnimation=void 0,e.calculative.start=void 0,setNodeAnimateProcess(e,1),0;const s=(t-e.calculative.start)%e.calculative.duration||e.calculative.duration;let r=0;for(const t of e.frames){if(r+=t.duration,!(s>r))break;++i}if(!e.frames[i])return!0;let a=!1;i!==e.calculative.frameIndex&&(a=!0,e.calculative.frameIndex=i,e.calculative.frameDuration=e.frames[i].duration,i>0&&(e.calculative.frameStart+=e.frames[i-1].duration),e.calculative.frameEnd=e.calculative.frameStart+e.calculative.frameDuration);let l=!1;if(o>e.calculative.cycleIndex&&(e.calculative.cycleIndex=o,e.calculative.frameStart=e.calculative.start+e.calculative.duration*(o-1),l=!0),a||l)if(e.calculative.x=e.calculative.initRect.x,e.calculative.y=e.calculative.initRect.y,(null==(n=e.children)?void 0:n.length)&&!e.parentId?e.calculative.canvas.rotatePen(e,(e.calculative.initRect.rotate||0)-(e.calculative.rotate||0),e.calculative.initRect):e.calculative.rotate=e.calculative.initRect.rotate||0,i>0){e.prevFrame={};const t=e.frames[i-1];for(const i in t)e.prevFrame[i]=t[i];Object.assign(e.prevFrame,{rotate:t.rotate||0,x:t.x||0,y:t.y||0,scale:t.scale||1})}else initPrevFrame(e)}else{if(e.calculative.start=t,e.calculative.frameIndex=0,e.calculative.frameStart=e.calculative.start,e.calculative.frameDuration=e.frames[0].duration,e.calculative.frameEnd=e.calculative.frameStart+e.calculative.frameDuration,e.calculative.cycleIndex=1,e.calculative.x=e.calculative.worldRect.x,e.calculative.y=e.calculative.worldRect.y,e.calculative.initRect=deepClone(e.calculative.worldRect),e.parentId&&(e.calculative.initRelativeRect={x:e.x,y:e.y,width:e.width,height:e.height}),null==(i=e.children)?void 0:i.length){const t=e.calculative.canvas.store;e.calculative.childrenVisible={},e.children.forEach((i=>{e.calculative.childrenVisible[i]=t.pens[i].visible}))}e.calculative.initRect.rotate=e.calculative.rotate||0,initPrevFrame(e)}const o=(t-e.calculative.frameStart)/e.calculative.frameDuration%1;return o>0&&setNodeAnimateProcess(e,o),!0}function initPrevFrame(e){e.prevFrame={};for(const t in e)"object"==typeof e[t]&&"lineDash"!==t||(e.prevFrame[t]=e[t]);e.prevFrame.rotate=0,e.prevFrame.x=0,e.prevFrame.y=0,e.prevFrame.scale=1}function setNodeAnimateProcess(e,t){var i,n,o,s,r,a;if(t<0)return;t>1&&(t=1);const l=e.frames[e.calculative.frameIndex],c=e.calculative.canvas.store.data.scale;for(const h in l)if("duration"!==h){if("scale"===h){e.calculative.worldRect=deepClone(e.calculative.initRect),scaleRect(e.calculative.worldRect,e.prevFrame.scale,e.calculative.worldRect.center);const i=e.prevFrame.scale+(l[h]-e.prevFrame.scale)*t;scaleRect(e.calculative.worldRect,i/e.prevFrame.scale,e.calculative.worldRect.center),e.calculative.patchFlags=!0}else if("x"===h){const o=getFrameValue(e,h,e.calculative.frameIndex)*c;e.calculative.worldRect.x=e.calculative.initRect.x+o,e.calculative.worldRect.ex=e.calculative.initRect.ex+o,e.calculative.worldRect.center.x=e.calculative.initRect.center.x+o,(null==(i=e.calculative.worldRect.pivot)?void 0:i.x)&&(e.calculative.worldRect.pivot.x=(null==(n=e.calculative.initRect.pivot)?void 0:n.x)+o),translateRect(e.calculative.worldRect,l[h]*t*c,0),e.calculative.patchFlags=!0}else if("y"===h){const i=getFrameValue(e,h,e.calculative.frameIndex)*c;e.calculative.worldRect.y=e.calculative.initRect.y+i,e.calculative.worldRect.ey=e.calculative.initRect.ey+i,e.calculative.worldRect.center.y=e.calculative.initRect.center.y+i,(null==(o=e.calculative.worldRect.pivot)?void 0:o.x)&&(e.calculative.worldRect.pivot.y=(null==(s=e.calculative.initRect.pivot)?void 0:s.y)+i),translateRect(e.calculative.worldRect,0,l[h]*t*c),e.calculative.patchFlags=!0}else if("width"===h){const i=getFrameValue(e,h,e.calculative.frameIndex)*c;e.calculative.worldRect.width=e.calculative.initRect.width+i,e.calculative.worldRect.ex=e.calculative.initRect.ex+i,e.calculative.worldRect.center.x=e.calculative.initRect.center.x+i;let n=l[h]*t*c;e.calculative.worldRect.width+=n,e.calculative.worldRect.ex+=n,e.calculative.worldRect.center.x+=n,e.calculative.patchFlags=!0}else if("height"===h){const i=getFrameValue(e,h,e.calculative.frameIndex)*c;e.calculative.worldRect.height=e.calculative.initRect.height+i,e.calculative.worldRect.ey=e.calculative.initRect.ey+i,e.calculative.worldRect.center.y=e.calculative.initRect.center.y+i;let n=l[h]*t*c;e.calculative.worldRect.height+=n,e.calculative.worldRect.ey+=n,e.calculative.worldRect.center.y+=n,e.calculative.patchFlags=!0}else if("rotate"===h){e.prevFrame[h]>=360&&(e.prevFrame[h]%=360);const i=getFrameValue(e,h,e.calculative.frameIndex),n=(e.calculative.initRect.rotate+i+l[h]*t)%360-(e.calculative.rotate||0);(null==(r=e.children)?void 0:r.length)?e.calculative.canvas.rotatePen(e,n,e.calculative.initRect):e.calculative.rotate=(e.calculative.initRect.rotate+i+l[h]*t)%360,e.calculative.patchFlags=!0}else if("image"===h)e.image=l.image,e.calculative.image=void 0,e.calculative.canvas.loadImage(e),e.canvasLayer===CanvasLayer.CanvasImageBottom?e.calculative.canvas.canvasImageBottom.init():e.canvasLayer===CanvasLayer.CanvasImage&&e.calculative.canvas.canvasImage.init();else if(isLinear(l[h],h,e)){null==e.prevFrame[h]&&(e.prevFrame[h]="globalAlpha"===h?1:0);const i=e.prevFrame[h]+(l[h]-e.prevFrame[h])*t;e.calculative[h]=Math.round(100*i)/100}else{if("visible"===h)if(e.calculative.image);else if(null==(a=e.children)?void 0:a.length){const t=getAllChildren(e,e.calculative.canvas.store);e.calculative.canvas.initImageCanvas(t)}e.calculative[h]=l[h];const t={};t[h]=l[h],setChildValue(e,t)}"text"===h&&calcTextLines(e)}}function isLinear(e,t,i){return"number"==typeof e&&!1!==i.linear&&!["strokeType","bkType","showChild"].includes(t)}function setLineAnimate(e,t){if(0===e.calculative.start)return e.calculative.start=void 0,e.calculative.cycleStart=void 0,0;e.animateCycle||(e.animateCycle=1/0),e.animateSpan||(e.animateSpan=1);const i=(t-e.calculative.cycleStart)/1e3;if(e.animateTimingFunction&&e.duration){const t=Array.isArray(e.animateTimingFunction)?e.animateTimingFunction:e.animateTimingFunction.split(","),n=cubicBezierY(i/e.duration,t[1],t[3]);e.calculative.animatePos=n*e.length}else e.calculative.animatePos+=e.animateSpan*(e.calculative.canvas.store.data.scale||1);if(e.calculative.cycleStart||(e.calculative.cycleStart=t),e.calculative.start){if(e.calculative.animatePos>e.length||i>e.duration){if(++e.calculative.cycleIndex,e.calculative.cycleIndex>e.animateCycle)return e.currentAnimation=void 0,e.calculative.start=void 0,e.calculative.cycleStart=void 0,0;e.calculative.cycleStart=void 0,e.calculative.animatePos=e.animateSpan}}else e.calculative.start=Date.now(),e.calculative.animatePos=e.animateSpan*(e.calculative.canvas.store.data.scale||1),e.calculative.cycleIndex=1;return!0}function setChildrenActive(e,t=!0){if(!e.children||!1===e.childActive)return;const i=e.calculative.canvas.store;e.children.forEach((e=>{const n=i.pens[e];n&&(n.calculative.active=t,setChildrenActive(n,t))}))}function setHover(e,t=!0){if(!e)return;const i=e.calculative.canvas.store;e.calculative.hover=t,!1!==e.childHover&&e.children&&e.children.forEach((e=>{var n,o;null==(null==(n=i.pens[e])?void 0:n.hoverColor)&&null==(null==(o=i.pens[e])?void 0:o.hoverBackground)&&setHover(i.pens[e],t)}))}function setElemPosition(e,t){if(!t)return;const i=e.calculative.canvas.store,n=e.calculative.worldRect;if(t.style.opacity=e.globalAlpha+"",t.style.position="absolute",t.style.outline="none",t.style.left=n.x+i.data.x+"px",t.style.top=n.y+i.data.y+"px",t.style.width=n.width+"px",t.style.height=n.height+"px",t.style.display=0!=e.calculative.inView?e.calculative.cssDisplay||"inline":"none",!e.calculative.rotate&&(e.calculative.rotate=0),t.style.transform=`rotate(${e.calculative.rotate}deg)`,e.calculative.rotate||(e.calculative.flipX&&(t.style.transform="rotateY(180deg)"),e.calculative.flipY&&(t.style.transform="rotateX(180deg)"),e.calculative.flipX&&e.calculative.flipY&&(t.style.transform="rotateZ(180deg)")),t.style.zIndex=void 0!==e.calculative.zIndex?e.calculative.zIndex+"":"5",e.calculative.zIndex>e.calculative.canvas.maxZindex&&(e.calculative.canvas.maxZindex=e.calculative.zIndex),e.locked===LockState.DisableEdit||e.locked===LockState.DisableMove||i.data.locked?(t.style.userSelect="initial",t.style.pointerEvents="initial","gif"===e.name&&(t.style.userSelect="none",t.style.pointerEvents="none")):(t.style.userSelect="none",t.style.pointerEvents="none"),e.className&&(t.className=e.className),e.styles)for(let o in e.styles)t.style[o]=e.styles[o]}function getPensLock(e){return e.every((e=>e.locked))}function getPensDisableRotate(e){return e.every((e=>e.disableRotate))}function rotatePen(e,t,i){var n;e.type?(e.calculative.worldAnchors.forEach((e=>{rotatePoint(e,t,i.center)})),initLineRect(e),calcPenRect(e)):(e.calculative.rotate?e.calculative.rotate+=t:e.calculative.rotate=t,rotatePoint(e.calculative.worldRect.center,t,i.center),e.parentId&&(e.calculative.worldRect.x=e.calculative.worldRect.center.x-e.calculative.worldRect.width/2,e.calculative.worldRect.y=e.calculative.worldRect.center.y-e.calculative.worldRect.height/2,e.x=(e.calculative.worldRect.x-i.x)/i.width,e.y=(e.calculative.worldRect.y-i.y)/i.height)),null==(n=e.children)||n.forEach((n=>{rotatePen(e.calculative.canvas.store.pens[n],t,i)}))}function initLineRect(e){var t;if(!(null==(t=e.calculative.worldAnchors)?void 0:t.length))return;if(!isFinite(e.x)||!isFinite(e.x))return;if(null==e.x||null==e.y)return;const i=getLineRect(e);e.parentId||Object.assign(e,i);const{fontSize:n,lineHeight:o}=e.calculative.canvas.store.options;e.fontSize?e.fontSize<0&&(e.fontSize=0,e.calculative.fontSize=0):(e.fontSize=n>=0?n:12,e.calculative.fontSize=e.fontSize*e.calculative.canvas.store.data.scale),e.lineHeight||(e.lineHeight=o,e.calculative.lineHeight=e.lineHeight),calcCenter(i),e.calculative.worldRect=i,calcPadding(e,i),calcTextRect(e),e.calculative.worldAnchors&&(e.anchors=e.calculative.worldAnchors.map((t=>calcRelativePoint(t,e.calculative.worldRect))))}function getPensDisableResize(e){return e.every((e=>e.disableSize||e.pivot))}function getFrameValue(e,t,i){if(!e.frames||!t)return 0;let n=0;for(let o=0;o<i;o++)e.frames[o]&&(n+=e.frames[o][t]||0);return n}function isShowChild(e,t){var i;let n=e;for(;n&&n.parentId;){const e=n;n=t.pens[n.parentId];const o=null==(i=null==n?void 0:n.calculative)?void 0:i.showChild;if(null!=o){if(n.children[o]!==e.id)return!1}}return!0}function calcInView(e,t=!1){var i,n,o;const{store:s,canvasRect:r}=e.calculative.canvas;if(t&&(null==(i=e.children)||i.forEach((e=>{const t=s.pens[e];t&&calcInView(t,!0)}))),e.calculative.inView=!0,isShowChild(e,s)?0!=e.visible&&0!=e.calculative.visible||(e.calculative.inView=!1,e.canvasLayer!==CanvasLayer.CanvasImageBottom&&e.canvasLayer!==CanvasLayer.CanvasImage||!(null==(n=e.frames)?void 0:n.length)||(e.calculative.inView=e.frames.some((e=>e.hasOwnProperty("visible"))))):e.calculative.inView=!1,e.calculative.inView){const{x:t,y:i,width:n,height:o,rotate:a}=e.calculative.worldRect,l={x:t+s.data.x,y:i+s.data.y,width:n,height:o,rotate:a};calcRightBottom(l),rectInRect(l,r)||(e.calculative.inView=!1)}(null==(o=e.calculative.singleton)?void 0:o.div)&&setElemPosition(e,e.calculative.singleton.div)}function inspectRect(e,t,i){if(t.fillWorldTextRect){e.save(),e.fillStyle="#c3deb7";const{x:t,y:n,width:o,height:s}=i.calculative.worldTextRect;e.fillRect(t,n,o,s),e.restore()}}function setGlobalAlpha(e,t){const i=t.calculative.globalAlpha;"number"==typeof i&&i<1&&!isNaN(i)&&(e.globalAlpha=i)}function ctxDrawCanvas(e,t){const i=drawFuncGenerator(e,t)||globalStore.canvasDraws[t.name];i&&(e.save(),i(e,t),e.restore())}function drawFuncGenerator(e,t){const i=t.drawCommand;if(i&&"line"!==t.name)return(e,t)=>{i.forEach((i=>{try{i.steps=i.steps.flat(1/0),i.steps.reduce(((i,n)=>{const o=commandTransfer(n,t,i.x,i.y);try{if(o.c){if(o.c.startsWith("_")){const n=o.c.split("_")[1];return"number"==typeof o.v.value&&(o.v.value*=t.calculative.canvas.store.data.scale),(o.p||e)[n]=o.v.value,{x:i.x,y:i.y}}let n=[];for(const e in o.v)n.push(o.v[e]);return(o.p||e)[o.c](...n),{x:o.startX||o.v.x,y:o.startY||o.v.y}}return{x:i.x,y:i.y}}catch(s){}}),{})}catch(n){}})),e.stroke()}}function commandTransfer(e,t,i,n){var o;const s={visio:dealWithVisio,dxf:dealWithDXF,canvas:dealWithCanvas};return(null==(o=s[t.parseType])?void 0:o.call(s,e,t,i,n))||e}function dealWithDXF(e,t,i,n){const{x:o,y:s,width:r,height:a}=t.calculative.worldRect,{originWidth:l,originHeight:c}=t.dxfOrigin;switch(e.c){case"beginPath":return{c:"beginPath",v:{}};case"closePath":return{c:"closePath",v:{}};case"moveTo":return{c:"moveTo",v:{x:e.v.x*(r/l)+o,y:e.v.y*(a/c)+s}};case"lineTo":return{c:"lineTo",v:{x:e.v.x*(r/l)+o,y:e.v.y*(a/c)+s}};case"arc":case"ellipse":return{c:"ellipse",v:{x:e.v.x*(r/l)+o,y:e.v.y*(a/c)+s,rx:e.v.xr*(r/l),ry:e.v.yr*(a/c),rotation:e.v.rotation||0,startAngle:e.v.startAngle,endAngle:e.v.endAngle,a:e.v.aclockwise??!0}};case"_font":return{c:"_font",v:{value:e.v.fontSize*t.calculative.canvas.store.data.scale+"px "+(e.v.fontFamily||t.calculative.canvas.store.options.fontFamily)}};case"_fillStyle":return{c:"_fillStyle",v:{value:t.color||e.v.value}};default:const i={c:e.c,v:{...e.v}};return void 0!==i.v.x&&(i.v.x=e.v.x*(r/l)+o),void 0!==i.v.y&&(i.v.y=e.v.y*(a/c)+s),i}}function dealWithCanvas(e,t,i,n){const{x:o,y:s,width:r,height:a}=t.calculative.worldRect,{originWidth:l,originHeight:c}=t.origin;switch(e.c){case"beginPath":return{c:"beginPath",v:{}};case"closePath":return{c:"closePath",v:{}};case"moveTo":return{c:"moveTo",v:{x:e.v.x*(r/l)+o,y:e.v.y*(a/c)+s}};case"lineTo":return{c:"lineTo",v:{x:e.v.x*(r/l)+o,y:e.v.y*(a/c)+s}};case"arc":case"ellipse":return{c:"ellipse",v:{x:e.v.x*(r/l)+o,y:e.v.y*(a/c)+s,rx:e.v.xr*(r/l),ry:e.v.yr*(a/c),rotation:e.v.rotation||0,startAngle:e.v.startAngle,endAngle:e.v.endAngle,a:e.v.aclockwise??!0}};case"_font":return{c:"_font",v:{value:e.v.fontSize*t.calculative.canvas.store.data.scale+"px "+(e.v.fontFamily||t.calculative.canvas.store.options.fontFamily)}};default:const i={c:e.c,v:{...e.v}};return void 0!==i.v.x&&(i.v.x=e.v.x*(r/l)+o),void 0!==i.v.y&&(i.v.y=e.v.y*(a/c)+s),i}}function dealWithVisio(e,t,i,n){const{x:o,y:s,width:r,height:a}=t.calculative.worldRect,{width:l,height:c}=t.origin;switch(e.c){case"MoveTo":return{c:"moveTo",v:{x:100*+e.v.X*(r/l)+o,y:100*+e.v.Y*(a/c)+s}};case"RelMoveTo":return{c:"moveTo",v:{x:+e.v.X*l*(r/l)+o,y:+e.v.Y*c*(a/c)+s}};case"LineTo":return{c:"lineTo",v:{x:100*+e.v.X*(r/l)+o,y:100*+e.v.Y*(a/c)+s}};case"RelLineTo":return{c:"lineTo",v:{x:+e.v.X*l*(r/l)+o,y:+e.v.Y*c*(a/c)+s}};case"Ellipse":let t=e.v.X,h=e.v.Y,d=Math.abs(e.v.A-e.v.C),u=Math.abs(e.v.B-e.v.D);return{c:"ellipse",v:{x:100*t*(r/l)+o,y:100*h*(a/c)+s,radiuX:100*d*(r/l),radiuY:100*u*(a/c),rotation:0,startAngle:0,endAngle:2*Math.PI,anticlockwise:!0}};case"EllipticalArcTo":const p=100*e.v.X*(r/l)+o,f=100*e.v.Y*(a/c)+s,v=100*e.v.A*(r/l)+o,g=100*e.v.B*(a/c)+s;e.v.C;const y=(p-i)*(g-n)-(f-n)*(v-i)>0,m=calculateEllipseParameters(i,n,p,f,v,g,e.v.D*(r/a)*(c/l));return!e.orign&&(e.orign={}),!e.orign.startA&&(e.orign.startA=calculateAngleInRadians(m.x0,m.y0,i,n)),!e.orign.endA&&(e.orign.endA=calculateAngleInRadians(m.x0,m.y0,p,f)),{c:"ellipse",v:{centerX:m.x0,centerY:m.y0,radiuX:m.a,radiuY:m.b,rotation:0,startAngle:e.orign.startA,endAngle:e.orign.endA,anticlockwise:y},startX:p,startY:f};case"RelEllipticalArcTo":const w=e.v.X*l*(r/l)+o,b=e.v.Y*c*(a/c)+s,x=e.v.A*l*(r/l)+o,k=e.v.B*c*(a/c)+s;e.v.C;const T=(w-i)*(k-n)-(b-n)*(x-i)>0,C=calculateEllipseParameters(i,n,w,b,x,k,e.v.D*(r/a)*(c/l));return!e.orign&&(e.orign={}),!e.orign.startA&&(e.orign.startA=calculateAngleInRadians(C.x0,C.y0,i,n)),!e.orign.endA&&(e.orign.endA=calculateAngleInRadians(C.x0,C.y0,w,b)),{c:"ellipse",v:{centerX:C.x0,centerY:C.y0,radiuX:C.a,radiuY:C.b,rotation:0,startAngle:e.orign.startA,endAngle:e.orign.endA,anticlockwise:T},startX:w,startY:b};case"ArcTo":let A=100*e.v.X*r/l+o,R=100*e.v.Y*a/c+s,_=100*e.v.A*(r/a)*(c/l),S=(i+A)/2,P=(n+R)/2,E=Math.sqrt((A-i)**2+(R-n)**2),I=E**2/(8*_)+_/2,L=S+-(R-n)/E*I,M=P+(A-i)/E*I;return{c:"arc",v:{x:L,y:M,radius:I,startAngle:Math.atan2(n-M,i-L),endAngle:Math.atan2(R-M,A-L),aclockwise:!0}};default:const D=deepClone(e);return Object.entries(D.v).forEach((([e,t])=>{var i,n;(null==(i=e.endsWith)?void 0:i.call(e,"_x"))?"number"==typeof t&&(D.v[e]=t*(r/l)+o):(null==(n=e.endsWith)?void 0:n.call(e,"_y"))?"number"==typeof t&&(D.v[e]=t*(a/c)+s):"number"==typeof t&&(D.v[e]=t)})),D}}function drawFilter(e,t){e.filter=t.filter}function setChildValue(e,t){for(const i in t)inheritanceProps.includes(i)&&("fontSize"==i&&t[i]<0&&(t[i]=0),e[i]=t[i],["fontSize","lineWidth"].includes(i)?(e.calculative[i]=t[i]*e.calculative.canvas.store.data.scale,calcTextRect(e)):e.calculative[i]=t[i]);if(e.calculative.canvas.parent.isCombine(e)){const i=e.children;null==i||i.forEach((i=>{let n=deepClone(t);e.calculative.childrenVisible&&!1===e.calculative.childrenVisible[i]&&delete n.visible;const o=e.calculative.canvas.store.pens[i];o&&setChildValue(o,n)}))}}function calculateEllipseParameters(e,t,i,n,o,s,r){let a=((e-i)*(e+i)*(n-s)-(i-o)*(i+o)*(t-n)+r*r*(t-n)*(n-s)*(t-s))/(2*((e-i)*(n-s)-(i-o)*(t-n))),l=((e-i)*(i-o)*(e-o)+r*r*((i-o)*(t-n)*(t+n)-(e-i)*(n-s)*(n+s)))/(2*r*r*((i-o)*(t-n)-(e-i)*(n-s))),c=Math.sqrt(Math.pow(e-a,2)+Math.pow(r*(t-l),2));return{x0:a,y0:l,a:c,b:c/r}}function calculateAngleInRadians(e,t,i,n){let o=i-e,s=n-t,r=Math.atan2(s,o);return r<0&&(r+=2*Math.PI),r}function calcAnchorDock(e,t,i){let n,o,s=1/0,r=1/0;for(const a of e.data.pens){if(!1===a.calculative.inView)continue;getPointsByPen(a).forEach((e=>{if(e===t||e===i)return;let l=(a.calculative.worldRect.center.x-t.x)*(a.calculative.worldRect.center.x-t.x)+(a.calculative.worldRect.center.y-t.y)*(a.calculative.worldRect.center.y-t.y);const c=Math.abs(e.x-t.x);c>0&&c<8&&l<s&&(n={x:Math.round(e.x)+.5,y:Math.round(e.y)+.5,prev:{x:Math.round(t.x)+.5,y:Math.round(t.y)+.5},step:e.x-t.x},s=l);const h=Math.abs(e.y-t.y);h>0&&h<8&&l<r&&(o={x:Math.round(e.x)+.5,y:Math.round(e.y)+.5,prev:{x:Math.round(t.x)+.5,y:Math.round(t.y)+.5},step:e.y-t.y},r=l)}))}return{xDock:n,yDock:o}}function calcMoveDock(e,t,i,n){let o=[];return 1===i.length?(o=deepClone(getPointsByPen(i[0])),o.forEach((e=>{e.x+=n.x,e.y+=n.y}))):(calcCenter(t),o=[t.center,...rectToPoints(t)]),calcDockByPoints(e,o,t,!0)}function getPointsByPen(e){if(!e.type){const t=rectToPoints(e.calculative.worldRect);return calcCenter(e.calculative.worldRect),[...e.calculative.worldAnchors,...t,e.calculative.worldRect.center]}if(e.type===PenType.Line)return e.calculative.worldAnchors}function calcResizeDock(e,t,i,n){return calcDockByPoints(e,rectToPoints(t),t)}function calcDockByPoints(e,t,i,n=!1){let o,s,r=1/0,a=1/0;const l=expandRect(i,10);return e.data.pens.forEach((c=>{const{inView:h,worldRect:d,active:u}=c.calculative;if(!1===h||!n&&u||rectInFourAngRect(l,d)||c.type&&e.active.some((t=>isConnectLine(e,t,c))))return;const p=getPointsByPen(c);if(p)for(const e of p)for(const n of t){const t=e.x-n.x,l=e.y-n.y,h=Math.abs(t),d=Math.abs(l);i.center||(i.center={x:i.x+i.width/2,y:i.y+i.height/2}),h<10&&h<r&&(o={x:Math.round(e.x)+.5,y:Math.round(e.y)+.5,step:t,prev:{x:Math.round(n.x)+.5,y:Math.round(n.y)+.5},penId:c.id,anchorId:n.id,dockAnchorId:e.id},r=h),d<10&&d<a&&(s={x:Math.round(e.x)+.5,y:Math.round(e.y)+.5,step:l,prev:{x:Math.round(n.x)+.5,y:Math.round(n.y)+.5},penId:c.id,anchorId:n.id,dockAnchorId:e.id},a=d)}})),{xDock:o,yDock:s}}function isConnectLine(e,t,i){if(!i.type)return!1;if(Array.isArray(null==t?void 0:t.connectedLines))for(const n of null==t?void 0:t.connectedLines)if(n.lineId===i.id)return!0;if(Array.isArray(null==t?void 0:t.children))for(const n of t.children){if(isConnectLine(e,e.pens[n],i))return!0}return!1}function isEqual(e,t){return e.toFixed(12)==t}function randomId(e){if(e.id=s8(),Array.isArray(e.anchors))for(const t of e.anchors)e.type&&(t.id=s8()),t.penId=e.id,t.prev&&(e.type&&(t.prev.id=s8()),t.prev.penId=e.id),t.next&&(e.type&&(t.next.id=s8()),t.next.penId=e.id)}function rewritePenLifeCycle(){let e=null,t=new Map;return(i,n,o,s=!1)=>{if(t.has(i)&&t.get(i)?e=t.get(i):t.set(i,e=new Map),"function"!=typeof o)return()=>{};let r=new Set,a=new Map;e.has(n)&&e.get(n)?r=e.get(n):(a.set(n,i[n]),e.set(n,r)),s?r.delete(o):r.add(o);let l=a.get(n);i[n]=(...e)=>{null==l||l(...e),r.forEach((t=>{t(...e)}))}}}let setLifeCycleFunc=rewritePenLifeCycle();function validationPlugin(e){return!(!e.name&&!e.install)}function pointInRect(e,t){if(!t)return;if(null==t.ex&&calcRightBottom(t),!t.rotate||t.rotate%360==0)return e.x>t.x&&e.x<t.ex&&e.y>t.y&&e.y<t.ey;t.center||calcCenter(t);const i=[{x:t.x,y:t.y},{x:t.ex,y:t.y},{x:t.ex,y:t.ey},{x:t.x,y:t.ey}];return i.forEach((e=>{rotatePoint(e,t.rotate,t.pivot||t.center)})),pointInVertices(e,i)}function pointInSimpleRect(e,t,i=0){const{x:n,y:o,ex:s,ey:r}=t;return e.x>=n-i&&e.x<=s+i&&e.y>=o-i&&e.y<=r+i}function calcCenter(e){e.center||(e.center={}),e.center.x=e.x+e.width/2,e.center.y=e.y+e.height/2}function calcRightBottom(e){e.ex=e.x+e.width,e.ey=e.y+e.height}function calcPivot(e,t){e.pivot||(e.pivot={}),e.pivot.x=e.x+e.width*t.x,e.pivot.y=e.y+e.height*t.y}function pointInVertices(e,t){if(t.length<3)return!1;let i=!1,n=t[t.length-1];for(const o of t)n.y>e.y!=o.y>e.y&&o.x+(e.y-o.y)*(n.x-o.x)/(n.y-o.y)>e.x&&(i=!i),n=o;return i}function getRect$1(e){const t=[];e.forEach((e=>{if(e.isRuleLine)return;const i=e.calculative.worldRect;if(i){const e=rectToPoints(i);t.push(...e)}}));const i=getRectOfPoints(t);return calcCenter(i),i}function rectToPoints(e){const t=[{x:e.x,y:e.y},{x:e.ex,y:e.y},{x:e.ex,y:e.ey},{x:e.x,y:e.ey}];return e.rotate&&(e.center||calcCenter(e),t.forEach((t=>{rotatePoint(t,e.rotate,e.pivot||e.center)}))),t}function getRectOfPoints(e){let t=1/0,i=1/0,n=-1/0,o=-1/0;return null==e||e.forEach((e=>{isFinite(e.x)&&isFinite(e.y)&&(t=Math.min(t,e.x),i=Math.min(i,e.y),n=Math.max(n,e.x),o=Math.max(o,e.y))})),{x:t,y:i,ex:n,ey:o,width:n-t,height:o-i}}function rectInRect(e,t,i){return e.rotate&&(e=getRectOfPoints(rectToPoints(e))),i?e.x>t.x&&e.ex<t.ex&&e.y>t.y&&e.ey<t.ey:!(e.x>t.ex||e.ex<t.x||e.ey<t.y||e.y>t.ey)}function rectInFourAngRect(e,t){return(t.x>e.ex||t.ex<e.x)&&(t.y>e.ey||t.ey<e.y)}function expandRect(e,t){const i=formatPadding(t),n={x:e.x-i[3],y:e.y-i[0],width:e.width+i[1]+i[3],height:e.height+i[0]+i[2]};return calcRightBottom(n),n}function translateRect(e,t,i){e.x+=t,e.y+=i,e.ex+=t,e.ey+=i,e.center&&(e.center.x+=t,e.center.y+=i),e.pivot&&(e.pivot.x+=t,e.pivot.y+=i)}function getIntersectPoint(e,t){const i=(e.to.y-e.from.y)/(e.to.x-e.from.x),n=(t.to.y-t.from.y)/(t.to.x-t.from.x);return getIntersectPointByK({k:i,point:e.from},{k:n,point:t.from})}function getIntersectPointByK(e,t){if(isEqual(e.k,0))return{x:t.point.x,y:e.point.y};if(isEqual(t.k,0))return{x:e.point.x,y:t.point.y};const i=e.point.y-e.k*e.point.x,n=(t.point.y-t.k*t.point.x-i)/(e.k-t.k);return{x:n,y:e.k*n+i}}function pointsToRect(e,t){const i=getIntersectPoint({from:e[0],to:e[2]},{from:e[1],to:e[3]});for(const n of e)rotatePoint(n,-t,i);return getRectOfPoints(e)}function resizeRect(e,t,i,n){let o=e.rotate?e.rotate%360:0;if(o){const s=rectToPoints(e),r=(s[0].y-s[1].y)/(s[0].x-s[1].x),a=(s[1].y-s[2].y)/(s[1].x-s[2].x);if(n<4){if(s[n].x+=t,e.ratio)if(0===n||2===n){let i=t*Math.tan((90-(360-o)-Math.atan(e.width/e.height)/Math.PI*180)/180*Math.PI);s[n].y+=i}else{let i=t*Math.tan((90-(360-o)+Math.atan(e.width/e.height)/Math.PI*180)/180*Math.PI);s[n].y+=i}else s[n].y+=i;const l=s[(n+2)%4];s[(n+1)%4]=getIntersectPointByK({k:n%2?a:r,point:s[n]},{k:n%2?r:a,point:l}),s[(n+4-1)%4]=getIntersectPointByK({k:n%2?r:a,point:s[n]},{k:n%2?a:r,point:l})}else{const e=[4,6].includes(n)?a:r;isEqual(e,0)?(s[n%4].x+=t,s[(n+1)%4].x+=t):(s[n%4].y+=i,s[n%4].x+=i/e,s[(n+1)%4].y+=i,s[(n+1)%4].x+=i/e)}if((s[0].x-s[1].x)**2+(s[0].y-s[1].y)**2<25||(s[1].x-s[2].x)**2+(s[1].y-s[2].y)**2<25)return;const l=pointsToRect(s,e.rotate);return calcCenter(l),void Object.assign(e,l)}switch(n){case 0:if(e.width-t<5||e.height-i<5)break;e.x+=t,e.y+=i,e.width-=t,e.height-=i;break;case 1:if(e.width+t<5||e.height-i<5)break;e.ex+=t,e.y+=i,e.width+=t,e.height-=i;break;case 2:if(e.width+t<5||e.height+i<5)break;e.ex+=t,e.ey+=i,e.width+=t,e.height+=i;break;case 3:if(e.width-t<5||e.height+i<5)break;e.x+=t,e.ey+=i,e.width-=t,e.height+=i;break;case 4:if(e.height-i<5)break;e.y+=i,e.height-=i;break;case 5:if(e.width+t<5)break;e.ex+=t,e.width+=t;break;case 6:if(e.height+i<5)break;e.ey+=i,e.height+=i;break;case 7:if(e.width-t<5)break;e.x+=t,e.width-=t}}function scaleRect(e,t,i,n){e&&(e.width*=t,e.height*=t,scalePoint(e,t,i),calcRightBottom(e),calcCenter(e),n&&calcPivot(e,n))}function calcRelativeRect(e,t){const i={x:(e.x-t.x)/t.width,y:(e.y-t.y)/t.height,width:e.width/t.width,height:e.height/t.height};return calcRightBottom(i),i}function calcRelativePoint(e,t){const{x:i,y:n,width:o,height:s}=t,{penId:r,connectTo:a}=e,l=Object.assign({},e,{x:o?(e.x-i)/o:0,y:s?(e.y-n)/s:0});return e.prev&&(l.prev={penId:r,connectTo:a,x:o?(e.prev.x-i)/o:0,y:s?(e.prev.y-n)/s:0}),e.next&&(l.next={penId:r,connectTo:a,x:o?(e.next.x-i)/o:0,y:s?(e.next.y-n)/s:0}),l}function pointInPolygon(e,t){let i=!1;for(let n=0,o=t.length-1;n<t.length;o=n++){let s=t[n].x,r=t[n].y,a=t[o].x,l=t[o].y;r>e.y!=l>e.y&&e.x<(a-s)*(e.y-r)/(l-r)+s&&(i=!i)}return i}const commandRegex=/^[\t\n\f\r ]*([MLHVZCSQTAmlhvzcsqta])[\t\n\f\r ]*/,flagRegex=/^[01]/,numberRegex=/^[+-]?(([0-9]*\.[0-9]+)|([0-9]+\.)|([0-9]+))([eE][+-]?[0-9]+)?/,commaWsp=/^(([\t\n\f\r ]+,?[\t\n\f\r ]*)|(,[\t\n\f\r ]*))/,grammar={M:[numberRegex,numberRegex],L:[numberRegex,numberRegex],H:[numberRegex],V:[numberRegex],Z:[],C:[numberRegex,numberRegex,numberRegex,numberRegex,numberRegex,numberRegex],S:[numberRegex,numberRegex,numberRegex,numberRegex],Q:[numberRegex,numberRegex,numberRegex,numberRegex],T:[numberRegex,numberRegex],A:[numberRegex,numberRegex,numberRegex,flagRegex,flagRegex,numberRegex,numberRegex]};function parseSvgPath(e){let t=0;const i=[];for(;t<e.length;){const n=e.slice(t).match(commandRegex);if(null===n)throw new Error("malformed path (first error at "+t+")");{const o=n[1];t+=n[0].length;const s=parseCommands(o,e,t);t=s.cursor,i.push(...s.commands)}}return{commands:i}}function getRect(e){let t=1/0,i=1/0,n=-1/0,o=-1/0;return calcWorldPositions(e),e.commands.forEach((e=>{e.worldPoints.forEach(((e,s)=>{s%2==0?(e<t&&(t=e),e>n&&(n=e)):(e<i&&(i=e),e>o&&(o=e))}))})),{x:t,y:i,ex:n,ey:o,width:n-t+1,height:o-i+1}}function translatePath(e,t,i){null==i&&(i=t),e.commands.forEach(((e,n)=>{if(!e.relative||!n)switch(e.key){case"A":case"a":e.values[5]+=t,e.values[6]+=i;break;case"V":case"v":e.values[0]+=i;break;default:e.values.forEach(((n,o)=>{e.values[o]=n+(o%2==0?t:i)}))}}))}function scalePath(e,t,i){null==i&&(i=t),e.commands.forEach((e=>{switch(e.key){case"A":case"a":const n=e.values[0],o=e.values[1],s=Math.PI*e.values[2]/180,r=Math.cos(s),a=Math.sin(s),l=o*o*i*i*r*r+n*n*i*i*a*a,c=2*t*i*r*a*(o*o-n*n),h=n*n*t*t*r*r+o*o*t*t*a*a,d=-n*n*o*o*t*t*i*i,u=c*c-4*l*h,p=Math.sqrt((l-h)*(l-h)+c*c);e.values[2]=0!==c?180*Math.atan((h-l-p)/c)/Math.PI:l<h?0:90,e.values[0]=-Math.sqrt(2*u*d*(l+h+p))/u,e.values[1]=-Math.sqrt(2*u*d*(l+h-p))/u,e.values[5]*=t,e.values[6]*=i,e.values[4]=t*i>=0?e.values[4]:1-e.values[4];break;case"V":case"v":e.values[0]*=i;break;default:e.values.forEach(((n,o)=>{e.values[o]=n*(o%2==0?t:i)}))}}))}function pathToString(e){let t="";return e.commands.forEach((e=>{t+=e.key+" ",e.values.forEach((e=>{t+=e+" "}))})),t}function parseCommands(e,t,i){const n=grammar[e.toUpperCase()],o=[];for(;i<=t.length;){const s={key:e,values:[]};for(const e of n){const n=t.slice(i).match(e);if(null===n){if(0===s.values.length)return{cursor:i,commands:o};throw new Error("malformed path (first error at "+i+")")}{s.values.push(+n[0]),i+=n[0].length;const e=t.slice(i).match(commaWsp);null!==e&&(i+=e[0].length)}}if(s.relative=s.key.toUpperCase()!==s.key,o.push(s),0===n.length)return{cursor:i,commands:o};"m"===e&&(e="l"),"M"===e&&(e="L")}throw new Error("malformed path (first error at "+i+")")}function calcWorldPoints(e,t){const i=[];let n=e.relative&&t?{x:t.worldPoints[t.worldPoints.length-2],y:t.worldPoints[t.worldPoints.length-1]}:{x:0,y:0};for(let o=0;o<e.values.length-1;o+=2)i.push(n.x+e.values[o]),i.push(n.y+e.values[o+1]);e.worldPoints=i}function calcWorldPositions(e){let t,i=0,n=0;e.commands.forEach((e=>{switch(e.key){case"Z":case"z":e.worldPoints=[i,n];break;case"H":e.worldPoints=[e.values[0],t.worldPoints[t.worldPoints.length-1]];break;case"h":e.worldPoints=[e.values[0]+t.worldPoints[t.worldPoints.length-2],t.worldPoints[t.worldPoints.length-1]];break;case"V":e.worldPoints=[t.worldPoints[t.worldPoints.length-2],e.values[0]];break;case"v":case"A":e.worldPoints=[t.worldPoints[t.worldPoints.length-2],e.values[0]+t.worldPoints[t.worldPoints.length-1]];break;default:calcWorldPoints(e,t)}"M"!==e.key&&"m"!==e.key&&"Z"!==e.key&&"z"!==e.key||(i=e.worldPoints[e.worldPoints.length-2],n=e.worldPoints[e.worldPoints.length-1]),t=e}))}function svgPath(e,t){var i;const n=e.calculative.canvas.store.data.paths[e.pathId];if(!n)return new Path2D;const o=parseSvgPath(n);e.calculative.svgRect=getRect(o),calcCenter(e.calculative.svgRect),e.calculative.svgRect.width===e.calculative.worldRect.width&&e.calculative.svgRect.height===e.calculative.worldRect.height||scalePath(o,e.calculative.worldRect.width/e.calculative.svgRect.width,e.calculative.worldRect.height/e.calculative.svgRect.height);const s=getRect(o);calcCenter(s),translatePath(o,e.calculative.worldRect.x-s.x,e.calculative.worldRect.y-s.y);const r=pathToString(o);if(t)return void(null==(i=t.svgPath)||i.call(t,r));return new Path2D(r)}function diamond(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n+s/2,o),i.lineTo(n+s,o+r/2),i.lineTo(n+s/2,o+r),i.lineTo(n,o+r/2),i.lineTo(n+s/2,o),i.closePath(),i instanceof Path2D)return i}function triangle(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n+s/2,o),i.lineTo(n+s,o+r),i.lineTo(n,o+r),i.lineTo(n+s/2,o),i.closePath(),i instanceof Path2D)return i}function triangleAnchors(e){e.anchors=[{x:.5,y:0},{x:.75,y:.5},{x:.5,y:1},{x:.25,y:.5}].map((({x:t,y:i},n)=>({id:`${n}`,penId:e.id,x:t,y:i})))}function pentagon(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n+s/2,o),i.lineTo(n+s,o+2*r/5),i.lineTo(n+4*s/5,o+r),i.lineTo(n+s/5,o+r),i.lineTo(n,o+2*r/5),i.closePath(),i instanceof Path2D)return i}function pentagonAnchors(e){e.anchors=[{x:.5,y:0},{x:1,y:.4},{x:.8,y:1},{x:.2,y:1},{x:0,y:.4}].map((({x:t,y:i},n)=>({id:`${n}`,penId:e.id,x:t,y:i})))}function pentagram(e,t){e.onResize||(e.onResize=resize$2);const i=t||new Path2D,{width:n,height:o,center:s}=e.calculative.worldRect,r=n>o?o:n,a=s.x,l=s.y,c=l-r/2,h=l-r/4,d=-(h-l)*Math.sin(Math.PI/180*324)+a,u=(h-l)*Math.cos(Math.PI/180*324)+l;i.moveTo(d,u);for(let p=0;p<5;++p)i.lineTo(-(c-l)*Math.sin(Math.PI/180*72*p)+a,(c-l)*Math.cos(Math.PI/180*72*p)+l),i.lineTo((d-a)*Math.cos(Math.PI/180*72*(p+1))-(u-l)*Math.sin(Math.PI/180*72*(p+1))+a,(d-a)*Math.sin(Math.PI/180*72*(p+1))+(u-l)*Math.cos(Math.PI/180*72*(p+1))+l);if(i.closePath(),i instanceof Path2D)return i}function pentagramAnchors(e){const{width:t,height:i}=e,n=t>i?i:t,o=[];for(let s=0;s<5;++s)o.push({flag:1,id:String(s),penId:e.id,x:.5+n/2*Math.sin(Math.PI/180*72*s)/t,y:-n/2*Math.cos(Math.PI/180*72*s)/i+.5});e.anchors=o}function resize$2(e){const t=e.anchors.filter((e=>1!==e.flag));pentagramAnchors(e),e.anchors=e.anchors.concat(...t)}function hexagon(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n+s/4,o),i.lineTo(n+3*s/4,o),i.lineTo(n+s,o+r/2),i.lineTo(n+3*s/4,o+r),i.lineTo(n+1*s/4,o+r),i.lineTo(n,o+r/2),i.lineTo(n+s/4,o),i.closePath(),i instanceof Path2D)return i}function leftArrow(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n,o+r/2),i.lineTo(n+r/2,o),i.lineTo(n+r/2,o+r/3),i.lineTo(n+s,o+r/3),i.lineTo(n+s,o+2*r/3),i.lineTo(n+r/2,o+2*r/3),i.lineTo(n+r/2,o+2*r/3),i.lineTo(n+r/2,o+r),i.closePath(),i instanceof Path2D)return i}function rightArrow(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n,o+r/3),i.lineTo(n+(s-r/2),o+r/3),i.lineTo(n+(s-r/2),o),i.lineTo(n+s,o+r/2),i.lineTo(n+(s-r/2),o+r),i.lineTo(n+(s-r/2),o+2*r/3),i.lineTo(n,o+2*r/3),i.closePath(),i instanceof Path2D)return i}function twowayArrow(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n,o+r/2),i.lineTo(n+r/2,o),i.lineTo(n+r/2,o+r/3),i.lineTo(n+(s-r/2),o+r/3),i.lineTo(n+(s-r/2),o),i.lineTo(n+s,o+r/2),i.lineTo(n+(s-r/2),o+r),i.lineTo(n+(s-r/2),o+2*r/3),i.lineTo(n+r/2,o+2*r/3),i.lineTo(n+r/2,o+r),i.closePath(),i instanceof Path2D)return i}function message(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r,ey:a}=e.calculative.worldRect;if(i.moveTo(n,o),i.lineTo(n+s,o),i.lineTo(n+s,o+3*r/4),i.lineTo(n+8*s/16,o+3*r/4),i.lineTo(n+s/4,a),i.lineTo(n+5*s/16,o+3*r/4),i.lineTo(n,o+3*r/4),i.closePath(),i instanceof Path2D)return i}function cloud(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n+s/5,o+13*r/16),i.bezierCurveTo(n-s/15,o+13*r/16,n-s/15,o+7*r/16,n+s/5,o+7*r/16),i.bezierCurveTo(n+s/5,o,n+4*s/5,o,n+4*s/5,o+7*r/16),i.bezierCurveTo(n+16*s/15,o+7*r/16,n+16*s/15,o+13*r/16,n+4*s/5,o+13*r/16),i.closePath(),i instanceof Path2D)return i}function file(e,t){const i=t||new Path2D,{x:n,y:o,width:s,ex:r,ey:a}=e.calculative.worldRect,l=s/6;if(i.moveTo(n,o),i.lineTo(r-l,o),i.lineTo(r,o+l),i.lineTo(r,a),i.lineTo(n,a),i.closePath(),i.moveTo(r-l,o),i.lineTo(r-l,o+l),i.lineTo(r,o+l),i.closePath(),i instanceof Path2D)return i}function cube(e,t){const{x:i,y:n,width:o,ex:s,ey:r}=t.calculative.worldRect;let a=.25*o;const l=t.z;l>1?a=l*t.calculative.canvas.store.data.scale:l>0&&(a=o*l);const c={x:i,y:n+a},h={x:s-a,y:n+a},d={x:s-a,y:r};face(e,[c,h,d,{x:i,y:r}],t.backgroundFront||t.background,t.color),face(e,[c,{x:i+a,y:n},{x:s,y:n},h],t.backgroundUp||t.background,t.color),face(e,[h,{x:s,y:n},{x:s,y:r-a},d],t.backgroundRight||t.background,t.color)}function face(e,t,i="",n=""){e.save(),i&&(e.fillStyle=i),n&&(e.strokeStyle=n),e.beginPath();for(let o=0;o<t.length;++o)o?e.lineTo(t[o].x,t[o].y):e.moveTo(t[o].x,t[o].y);e.closePath(),i&&e.fill(),e.stroke(),e.restore()}function people(e,t){const i=t||new Path2D,{x:n,y:o,width:s,ex:r,ey:a}=e.calculative.worldRect,l=s/4,c=n+s/2;if(i.arc(c,o+l,l,0,2*Math.PI),i.moveTo(n,o+3*l),i.lineTo(r,o+3*l),i.moveTo(c,o+2*l),i.lineTo(c,o+4*l),i.moveTo(c,o+4*l),i.lineTo(n,a),i.moveTo(c,o+4*l),i.lineTo(r,a),i.closePath(),i instanceof Path2D)return i}function curve(e,t,i){if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),i)t.calculative.activeAnchor&&(t.calculative.activeAnchor.next={penId:t.id,x:i.x,y:i.y},distance(t.calculative.activeAnchor.next,t.calculative.activeAnchor)<5?t.calculative.activeAnchor.next=void 0:(t.calculative.activeAnchor.prev={...t.calculative.activeAnchor.next},rotatePoint(t.calculative.activeAnchor.prev,180,t.calculative.activeAnchor)));else{const i=t.calculative.worldAnchors[0];if(!i.next){calcCurveCP(i,facePen(i,e.pens[i.connectTo]),50),i.prev=void 0}const n=t.calculative.worldAnchors[t.calculative.worldAnchors.length-1];if(n&&n!==i&&!n.prev){calcCurveCP(n,facePen(n,e.pens[n.connectTo]),-50),n.next=void 0}}}function calcCurveCP(e,t,i){switch(t){case Direction.Up:e.prev={penId:e.penId,x:e.x,y:e.y+i},e.next={penId:e.penId,x:e.x,y:e.y-i};break;case Direction.Right:e.prev={penId:e.penId,x:e.x-i,y:e.y},e.next={penId:e.penId,x:e.x+i,y:e.y};break;case Direction.Bottom:e.prev={penId:e.penId,x:e.x,y:e.y-i},e.next={penId:e.penId,x:e.x,y:e.y+i};break;case Direction.Left:e.prev={penId:e.penId,x:e.x+i,y:e.y},e.next={penId:e.penId,x:e.x-i,y:e.y}}}function getQuadraticPoint(e,t,i,n){const o=1-e;return{x:o*o*t.x+2*o*e*i.x+e*e*n.x,y:o*o*t.y+2*o*e*i.y+e*e*n.y,step:e}}function getBezierPoint(e,t,i,n,o){const{x:s,y:r}=t,{x:a,y:l}=o,{x:c,y:h}=i,{x:d,y:u}=n,p=1-e;return{x:s*p*p*p+3*c*e*p*p+3*d*e*e*p+a*e*e*e,y:r*p*p*p+3*h*e*p*p+3*u*e*e*p+l*e*e*e,step:e}}function lerp(e,t,i){return{x:e.x+i*(t.x-e.x),y:e.y+i*(t.y-e.y)}}function getSplitAnchor(e,t,i){let n=e.calculative.worldAnchors[i],o=e.calculative.worldAnchors[i+1];!o&&e.close&&(o=e.calculative.worldAnchors[0]);const s=t.step;let r;if(n.next&&o.prev){const t=n,i=n.next,a=o.prev,l=o,c=lerp(t,i,s),h=lerp(i,a,s),d=lerp(a,l,s),u=lerp(c,h,s),p=lerp(h,d,s);r=lerp(u,p,s),u.penId=e.id,r.prev=u,p.penId=e.id,r.next=p,n.next.x=c.x,n.next.y=c.y,o.prev.x=d.x,o.prev.y=d.y}else if(n.next||o.prev){const i=n,a=n.next||o.prev,l=o,c=lerp(i,a,s),h=lerp(a,l,s);r=t,c.penId=e.id,h.penId=e.id,r.prev=c,r.next=h,n.next=void 0,o.prev=void 0}else r=t;return r.penId=e.id,r.id=s8(),r.prevNextType=PrevNextType.Bilateral,r}function mind(e,t,i){if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),t.calculative.worldAnchors.length<2)return;let n=t.calculative.activeAnchor,o=i||getToAnchor(t);if(!n||!o)return;let s=facePen(n,e.pens[n.connectTo]);switch(s===Direction.None&&(s=o.x>n.x?Direction.Right:Direction.Left),n.next={id:s8(),penId:t.id,x:n.x,y:n.y,prevNextType:2},o.prev={id:s8(),penId:t.id,x:o.x,y:o.y,prevNextType:2},s){case Direction.Up:n.next.y-=20,o.prev.y=n.y;break;case Direction.Bottom:n.next.y+=20,o.prev.y=n.y;break;case Direction.Left:n.next.x-=20,o.prev.x=n.x;break;default:n.next.x+=20,o.prev.x=n.x}}function line(e,t){const i=t||new Path2D;if(("line"===e.lineName||"polyline"===e.lineName)&&e.calculative.lineSmooth){let t=getGradientAnimatePath(e);if(i instanceof Path2D&&i.addPath(t),i instanceof Path2D)return i}const n=e.calculative.worldAnchors;if(n.length>1){let t;n.forEach((e=>{t?draw(i,t,e):e.start=!0,t=e})),e.close&&("curve"===e.lineName?draw(i,t,n[0]):i.closePath())}if(i instanceof Path2D)return i}function lineSegment(e,t,i){var n;if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),t.calculative.worldAnchors.length<2||(null==(n=t.anchors)?void 0:n.length)>1)return;const o=getFromAnchor(t),s=getToAnchor(t);o&&s&&s.id&&o!==s&&(o.next=void 0,deleteTempAnchor(t),s.prev=void 0,t.calculative.worldAnchors.push(s))}function draw(e,t,i){i&&!i.isTemp&&(t.start&&e.moveTo(t.x,t.y),t.next?i.prev?e.bezierCurveTo(t.next.x,t.next.y,i.prev.x,i.prev.y,i.x,i.y):e.quadraticCurveTo(t.next.x,t.next.y,i.x,i.y):i.prev?e.quadraticCurveTo(i.prev.x,i.prev.y,i.x,i.y):e.lineTo(i.x,i.y))}function getLineRect(e){return getLineLength(e),getRectOfPoints(getLinePoints(e))}function getLinePoints(e){const t=[];let i;return e.calculative.worldAnchors.forEach((n=>{t.push(n),i&&t.push(...getPoints(i,n,e)),i=n})),e.close&&e.calculative.worldAnchors.length>1&&t.push(...getPoints(i,e.calculative.worldAnchors[0],e)),t}function getLineR(e){return(null==e?void 0:e.lineWidth)?e.lineWidth/2+4:4}function getPoints(e,t,i){const n=[];if(!t)return n;let o=.02;if(e.lineLength&&!i.parentId){o=getLineR(i)/e.lineLength}if(e.next)if(t.prev)for(let s=o;s<1;s+=o)n.push(getBezierPoint(s,e,e.next,t.prev,t));else for(let s=o;s<1;s+=o)n.push(getQuadraticPoint(s,e,e.next,t));else if(t.prev)for(let s=o;s<1;s+=o)n.push(getQuadraticPoint(s,e,t.prev,t));else n.push({x:t.x,y:t.y});return n.length>1&&(e.curvePoints=n),n}function pointInLine(e,t){const i=getLineR(t);let n,o,s=0;for(const r of t.calculative.worldAnchors){if(n){if(o=pointInLineSegment(e,n,r,i),o)return{i:s,point:o};++s}n=r}if(t.close&&t.calculative.worldAnchors.length>1&&(o=pointInLineSegment(e,n,t.calculative.worldAnchors[0],i)))return{i:s,point:o}}function pointInLineSegment(e,t,i,n=4){if(!t.next&&!i.prev){const{x:o,y:s}=t,{x:r,y:a}=i,l=Math.min(o,r),c=Math.max(o,r),h=Math.min(s,a),d=Math.max(s,a);if(!(e.x>=l-n&&e.x<=c+n&&e.y>=h-n&&e.y<=d+n))return;return pointToLine(e,t,i,n)}if(t.curvePoints)for(const o of t.curvePoints)if(hitPoint(e,o,n))return o}function pointToLine(e,t,i,n=4){if(t.x===i.x){if(Math.abs(e.x-t.x)<=n)return{x:t.x,y:e.y}}else{const o=(t.y-i.y)/(t.x-i.x),s=t.y-o*t.x;if(Math.abs((o*e.x+s-e.y)/Math.sqrt(o*o+1))<=n){const t=(e.x+o*e.y-o*s)/(o*o+1);return{x:t,y:o*t+s}}}}function lineLen(e,t,i,n){if(!t&&!i)return Math.sqrt(Math.pow(Math.abs(e.x-n.x),2)+Math.pow(Math.abs(e.y-n.y),2))||0;const o=document.createElementNS("http://www.w3.org/2000/svg","path");return t&&i?o.setAttribute("d",`M${e.x} ${e.y} C${t.x} ${t.y} ${i.x} ${i.y} ${n.x} ${n.y}`):t?o.setAttribute("d",`M${e.x} ${e.y} Q${t.x} ${t.y} ${n.x} ${n.y}`):o.setAttribute("d",`M${e.x} ${e.y} Q${i.x} ${i.y} ${n.x} ${n.y}`),o.getTotalLength()||0}function getLineLength(e){if(e.calculative.worldAnchors.length<2)return 0;let t,i=0;if(e.calculative.worldAnchors.forEach((e=>{t&&(t.lineLength=lineLen(t,t.next,e.prev,e),i+=t.lineLength),t=e})),e.close){const n=getFromAnchor(e);t.lineLength=lineLen(t,t.next,n.prev,n),i+=t.lineLength}return e.calculative.animatePos&&(e.calculative.animatePos=i/e.length*e.calculative.animatePos),e.length=i,i}function lineInRect(e,t){const i=e.calculative.worldAnchors;for(let n=0;n<i.length-1;n++){const e=i[n],o=i[n+1];if(e.next||o.prev){if(isBezierIntersectRectangle(e,o,t))return!0}else if(isLineIntersectRectangle(e,o,t))return!0}return!1}function isLineIntersectRectangle(e,t,i){if(pointInSimpleRect(e,i)||pointInSimpleRect(t,i))return!0;const n=e.x,o=e.y,s=t.x,r=t.y;let a=i.x,l=i.y,c=i.ex,h=i.ey;const d=o-r,u=s-n,p=n*r-s*o;if(d*a+u*l+p>=0&&d*c+u*h+p<=0||d*a+u*l+p<=0&&d*c+u*h+p>=0||d*a+u*h+p>=0&&d*c+u*l+p<=0||d*a+u*h+p<=0&&d*c+u*l+p>=0){if(a>c){const e=a;a=c,c=e}if(l<h){const e=l;l=h,h=e}return!(n<a&&s<a||n>c&&s>c||o>l&&r>l||o<h&&r<h)}return!1}function isBezierIntersectRectangle(e,t,i){const n=.02;if(!e.next&&!t.prev)return isLineIntersectRectangle(e,t,i);if(e.next&&t.prev)for(let o=n;o<1;o+=n){if(pointInSimpleRect(getBezierPoint(o,e,e.next,t.prev,t),i))return!0}else if(e.next||t.prev)for(let o=n;o<1;o+=n){if(pointInSimpleRect(getQuadraticPoint(o,e,e.next||t.prev,t),i))return!0}return!1}function createSvgPath(e,t,i,n,o){let s="";return e||(s+=`M${t.x} ${t.y} `,(e=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",s)),s=e.getAttribute("d")||"",s+=i&&n?`C${i.x} ${i.y} ${n.x} ${n.y} ${o.x} ${o.y}`:i?`Q${i.x} ${i.y} ${o.x} ${o.y}`:`Q${(null==n?void 0:n.x)||t.x} ${(null==n?void 0:n.y)||t.y} ${o.x} ${o.y}`,e.setAttribute("d",s),e}function getLinePointPosAndAngle(e,t){const i=e.getTotalLength();if(t<0||t>i)return null;const n=e.getPointAtLength(t),o=e.getPointAtLength(t-.01),s=Math.atan2(n.y-o.y,n.x-o.x);return{x:n.x,y:n.y,rotate:s/Math.PI*180,progress:t/i}}let faceSpace=10;function polyline(e,t,i){var n;if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),faceSpace=e.options.polylineSpace||10,t.calculative.worldAnchors.length<2)return;let o,s=getFromAnchor(t),r=getToAnchor(t);if(!s||!r)return;if((null==(n=t.anchors)?void 0:n.length)&&s===t.calculative.activeAnchor?(o=!0,s=r,r=getFromAnchor(t)):t.anchors&&t.anchors.length||s===t.calculative.activeAnchor||(s=t.calculative.activeAnchor),!s||!r)return;s.next=void 0,r.prev=void 0;const a=r.connectTo;deleteTempAnchor(t);const l=[],c=e.pens[s.connectTo],h=e.pens[r.connectTo],d=facePen(s,c),u=facePen(r,h);let p=getFacePoint(s,d,faceSpace);p&&(s=p,l.push(p)),p=getFacePoint(r,u,faceSpace);const f=r;let v;if(p&&(r=p,f.connectTo&&(p.y>f.y&&s.y<f.y||p.y<f.y&&s.y>f.y))){v=p;let e=faceSpace;s.x<p.x&&(e=-e),Math.abs(s.x-p.x)<e&&(e=-e);r={x:p.x+e,y:p.y,id:s8()}}switch(d){case Direction.Up:l.push(...getNextPointsOfUp(s,r,u));break;case Direction.Right:l.push(...getNextPointsOfRight(s,r,u));break;case Direction.Bottom:l.push(...getNextPointsOfBottom(s,r,u));break;case Direction.Left:l.push(...getNextPointsOfLeft(s,r,u));break;default:l.push(...getNextPoints(t,s,r))}if(l.forEach((e=>{e.id=s8(),e.penId=t.id,t.calculative.worldAnchors.push(e)})),t.calculative.worldAnchors.push(r),v&&t.calculative.worldAnchors.push(v),p&&t.calculative.worldAnchors.push(f),o&&t.calculative.worldAnchors.reverse(),a){const e=t.calculative.worldAnchors.length-2;t.calculative.worldAnchors[e].isTemp=!1,t.calculative.worldAnchors[1].isTemp=!1}}function getFacePoint(e,t,i){const n={x:e.x,y:e.y,id:s8()};switch(t){case Direction.Up:n.y-=i;break;case Direction.Right:n.x+=i;break;case Direction.Bottom:n.y+=i;break;case Direction.Left:n.x-=i;break;default:return}return n}function getNextPointsOfUp(e,t,i){if(e.x===t.x||e.y===t.y)return[];const n=[];let o,s;switch(i){case Direction.Up:e.y<t.y?(o=t.x,s=e.y):(o=e.x,s=t.y),n.push({x:o,y:s});break;case Direction.Bottom:if(o=t.x,s=e.y,t.y>e.y)o=e.x+(t.x-e.x)/2,n.push({x:o,y:e.y},{x:o,y:t.y});else{const i=(e.y+t.y)/2;n.push({x:e.x,y:i},{x:t.x,y:i})}break;case Direction.Right:o=t.x,s=e.y,t.x<e.x&&t.y<e.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;case Direction.Left:o=t.x,s=e.y,t.x>e.x&&t.y<e.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;default:if(t.y>e.y-faceSpace)o=e.x+(t.x-e.x)/2,n.push({x:o,y:e.y},{x:o,y:t.y});else{const i=(e.y+t.y+faceSpace)/2;n.push({x:e.x,y:i},{x:t.x,y:i})}}return n}function getNextPointsOfRight(e,t,i){if(e.x===t.x||e.y===t.y)return[];const n=[];let o,s;switch(i){case Direction.Up:o=e.x,s=t.y,t.x>e.x&&t.y>e.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;case Direction.Bottom:o=e.x,s=t.y,t.x>e.x&&t.y<e.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;case Direction.Left:if(o=t.x,s=e.y,t.x<e.x)s=e.y+(t.y-e.y)/2,n.push({x:e.x,y:s},{x:t.x,y:s});else{const i=(e.x+t.x)/2;n.push({x:i,y:s},{x:i,y:t.y})}break;case Direction.Right:t.x<e.x?n.push({x:e.x,y:t.y}):n.push({x:t.x,y:e.y});break;default:if(o=t.x,s=t.y,t.x<e.x+faceSpace)n.push({x:e.x,y:s});else{const i=(e.x+t.x-faceSpace)/2;n.push({x:i,y:e.y},{x:i,y:s})}}return n}function getNextPointsOfBottom(e,t,i){if(e.x===t.x||e.y===t.y)return[];const n=[];let o,s;switch(i){case Direction.Up:if(o=e.x,s=t.y,t.y<e.y)o=e.x+(t.x-e.x)/2,n.push({x:o,y:e.y},{x:o,y:t.y});else{const i=(e.y+t.y)/2;n.push({x:o,y:i},{x:t.x,y:i})}break;case Direction.Right:o=t.x,s=e.y,t.x<e.x&&t.y>e.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;case Direction.Bottom:e.y>t.y?(o=t.x,s=e.y):(o=e.x,s=t.y),n.push({x:o,y:s});break;case Direction.Left:o=t.x,s=e.y,t.x>e.x&&t.y>e.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;default:if(o=e.x,t.y<e.y+faceSpace)o=e.x+(t.x-e.x)/2,n.push({x:o,y:e.y},{x:o,y:t.y});else{const i=(e.y+t.y-faceSpace)/2;n.push({x:o,y:i},{x:t.x,y:i})}}return n}function getNextPointsOfLeft(e,t,i){if(e.x===t.x||e.y===t.y)return[];const n=[];let o,s;switch(i){case Direction.Up:o=e.x,s=t.y,t.x<e.x&&t.y>e.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;case Direction.Bottom:o=e.x,s=t.y,t.x<e.x&&t.y<e.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;case Direction.Right:if(o=e.x,s=t.y,t.x>e.x)o=t.x,s=e.y+(t.y-e.y)/2,n.push({x:e.x,y:s},{x:t.x,y:s});else{const i=(e.x+t.x)/2;n.push({x:i,y:e.y},{x:i,y:t.y})}break;case Direction.Left:t.x>e.x?n.push({x:e.x,y:t.y}):n.push({x:t.x,y:e.y});break;default:if(o=e.x,s=t.y,t.x<e.x-faceSpace){const i=(e.x+t.x+faceSpace)/2;n.push({x:i,y:e.y},{x:i,y:s})}else n.push({x:e.x,y:s})}return n}function getNextPoints(e,t,i){const n=[];null==e.calculative.drawlineH&&(e.calculative.drawlineH=Math.abs(i.x-t.x)>Math.abs(i.y-t.y));let o=e.calculative.worldAnchors.findIndex((e=>e.id==t.id));if(o>1){let s=e.calculative.worldAnchors[o-1];if(s.x===t.x&&s.y!==t.y)return n.push({x:i.x,y:t.y}),n;if(s.y===t.y&&s.x!==t.x)return n.push({x:t.x,y:i.y}),n}return e.calculative.worldAnchors.length&&(i.isTemp=void 0,e.calculative.drawlineH?(n.push({x:i.x,y:t.y}),Math.abs(i.y-t.y)<faceSpace&&(i.isTemp=!0)):(n.push({x:t.x,y:i.y}),Math.abs(i.x-t.x)<faceSpace&&(i.isTemp=!0))),n}function anchorInHorizontal(e,t,i=!0){var n,o;let s=e.calculative.worldAnchors;i||(s=[],e.calculative.worldAnchors.forEach((e=>{s.unshift(e)})));for(let r=0;r<s.length&&s[r].id!==t.id;r++){if(s[r].y!==t.y)return!1;if(s[r].x===(null==(n=s[r+1])?void 0:n.x)&&s[r].y!==(null==(o=s[r+1])?void 0:o.y))return!1}return!0}function anchorInVertical(e,t,i=!0){var n,o;let s=e.calculative.worldAnchors;i||(s=[],e.calculative.worldAnchors.forEach((e=>{s.unshift(e)})));for(let r=0;r<s.length&&s[r].id!==t.id;r++){if(s[r].x!==t.x)return!1;if(s[r].y===(null==(n=s[r+1])?void 0:n.y)&&s[r].x!==(null==(o=s[r+1])?void 0:o.x))return!1}return!0}function translatePolylineAnchor(e,t,i){if(!e.calculative.worldAnchors)return;const n=e.calculative.worldAnchors.findIndex((e=>e.id===t.id)),o=getFromAnchor(e),s=getToAnchor(e);let r=e.calculative.worldAnchors[n-1],a=e.calculative.worldAnchors[n+1];if(null==e.calculative.h&&(o.connectTo&&(anchorInHorizontal(e,t,!0)?e.calculative.h=!0:anchorInVertical(e,t,!0)&&(e.calculative.h=!1)),null==e.calculative.h&&s.connectTo&&(anchorInHorizontal(e,t,!1)?e.calculative.h=!0:anchorInVertical(e,t,!1)&&(e.calculative.h=!1)),null==e.calculative.h&&(r?e.calculative.h=r.y===t.y:a&&(e.calculative.h=a.y===t.y))),e.calculative.h){if(t.x=i.x,o.connectTo&&anchorInHorizontal(e,t,!0))return void(a&&a.y!==t.y&&(a.x=t.x));if(s.connectTo&&anchorInHorizontal(e,t,!1))return void(r&&r.y!==t.y&&(r.x=t.x));const l=e.anchors[n];let c;for(let t=n-1;t>-1;t--)if(r=e.anchors[t],null==c&&(c=r.y===l.y),!0===c){if(r.y!==l.y)break;e.calculative.worldAnchors[t].y=i.y}else{if(r.x!==l.x)break;e.calculative.worldAnchors[t].x=i.x}c=void 0;for(let t=n+1;t<e.calculative.worldAnchors.length&&(a=e.anchors[t],a);t++)if(null==c&&(c=a.y===l.y),!0===c){if(a.y!==l.y)break;e.calculative.worldAnchors[t].y=i.y}else{if(a.x!==l.x)break;e.calculative.worldAnchors[t].x=i.x}t.y=i.y}else{if(t.y=i.y,o.connectTo&&anchorInVertical(e,t,!0))return void(a&&a.x!==t.x&&(a.y=t.y));if(s.connectTo&&anchorInVertical(e,t,!1))return void(r&&r.x!==t.x&&(r.y=t.y));const l=e.anchors[n];let c;for(let t=n-1;t>-1;t--)if(r=e.anchors[t],null==c&&(c=r.x===l.x),!0===c){if(r.x!==l.x)break;e.calculative.worldAnchors[t].x=i.x}else{if(r.y!==l.y)break;e.calculative.worldAnchors[t].y=i.y}c=void 0;for(let t=n+1;t<e.calculative.worldAnchors.length&&(a=e.anchors[t],a);t++)if(null==c&&(c=a.x===l.x),!0===c){if(a.x!==l.x)break;e.calculative.worldAnchors[t].x=i.x}else{if(a.y!==l.y)break;e.calculative.worldAnchors[t].y=i.y}t.x=i.x}}function simplify(e,t,i,n){const o=[];let s,r,a,l,c,h,d,u,p,f,v,g,y,m;p=e[i],f=e[n],a=p.x,l=p.y,d=f.x-a,u=f.y-l,m=d*d+u*u,s=t;for(let w=i+1;w<n;w++)v=e[w],0!==d||0!==u?(g=((v.x-a)*d+(v.y-l)*u)/m,g>1?(c=v.x-f.x,h=v.y-f.y):g>0?(c=v.x-(a+d*g),h=v.y-(l+u*g)):(c=v.x-a,h=v.y-l)):(c=v.x-a,h=v.y-l),y=c*c+h*h,y>s&&(r=w,s=y);return s>t&&(r-i>1&&o.push(...simplify(e,t,i,r)),o.push({id:e[r].id,penId:e[r].penId,x:e[r].x,y:e[r].y}),n-r>1&&o.push(...simplify(e,t,r,n))),o}function smoothLine(e,t=.8,i=!1){if(e.length<3)return e;let n,o,s,r,a,l,c,h,d,u,p,f,v,g,y;u=[],p=e.length,n=e[0],e[p-1],u.push({...e[0]});for(let k=0;k<p-1;k++){if(o=e[k],s=e[k+1],d=Math.abs((m=o.x-n.x,w=o.y-n.y,b=s.x-o.x,x=s.y-o.y,r=Math.sqrt(m*m+w*w),r>0?(f=m/r,g=w/r):(f=1,g=0),a=Math.sqrt(b*b+x*x),a>0?(v=b/a,y=x/a):(v=1,y=0),Math.acos(f*v+g*y))),r)if(d<3.14*t)if(i&&(r=Math.min(r,a),a=r),l=(f+v)/2,c=(g+y)/2,h=Math.sqrt(l*l+c*c),0===h)u.push({...o});else{l/=h,c/=h;const e={...o};e.prevNextType=PrevNextType.Bilateral,e.prev={penId:e.penId,x:o.x-l*r*.25,y:o.y-c*r*.25},e.next={penId:e.penId,x:o.x+l*a*.25,y:o.y+c*a*.25},u.push(e)}else u.push({...o});n=o}var m,w,b,x;return u.push({...e[e.length-1]}),u}function drawArrow(e,t){const i=t||new Path2D,n=e.calculative.worldAnchors;let o=e.calculative.canvas.store.data.scale,s=(e.calculative.animateLineWidth||6)*o,r=(2*e.animateLineWidth||12)*o;e.lineAnimateType===LineAnimateType.WaterDrop&&(r=(4*e.animateLineWidth||24)*o);let a=(e.animateInterval||100)*o,l=e.calculative.lineWidth*(e.calculative.lineSmooth||0),c=(e.calculative.animateLineWidth/2||3)*o;if(e.animateReverse&&(r=-r,s=-s),n.length>1){let t,o=0;for(let h=0;h<n.length;h++){let d=n[h];if(t){let n=getAngle(t,d),h={x:t.x+(e.calculative.animatePos-o)%a*Math.cos(n*Math.PI/180),y:t.y-(e.calculative.animatePos-o)%a*Math.sin(n*Math.PI/180)};e.animateReverse&&(h={x:t.x+(e.length-(e.calculative.animatePos+o))%a*Math.cos(n*Math.PI/180),y:t.y-(e.length-(e.calculative.animatePos+o))%a*Math.sin(n*Math.PI/180)});let u=Math.sqrt((h.x-t.x)**2+(h.y-t.y)**2),p=Math.sqrt((d.x-t.x)**2+(d.y-t.y)**2);for(;u<p;)(e.animateReverse&&u-r<p||!e.animateReverse&&u>r)&&u>l+r&&p-u>l&&(e.lineAnimateType===LineAnimateType.Arrow?arrow(i,h,s,n,c,r):e.lineAnimateType===LineAnimateType.WaterDrop&&waterDrop(i,h,e.animateReverse,n,c,r)),h.x+=a*Math.cos(n*Math.PI/180),h.y-=a*Math.sin(n*Math.PI/180),u=Math.sqrt((h.x-t.x)**2+(h.y-t.y)**2)}t=d}}if(i instanceof Path2D)return i}function getAngle(e,t){let i=t.x-e.x,n=t.y-e.y,o=180*Math.atan(n/i)/Math.PI;return o=t.x>=e.x?-o:180-o,o}function getRotatePoint(e,t,i){let n=(180-i)*Math.PI/180;return{x:(e.x-t.x)*Math.cos(n)-(e.y-t.y)*Math.sin(n)+t.x,y:(e.x-t.x)*Math.sin(n)+(e.y-t.y)*Math.cos(n)+t.y}}function arrow(e,t,i,n,o,s){let r=getRotatePoint({x:t.x+i,y:t.y+.57*i},{x:t.x,y:t.y},n),a=getRotatePoint({x:t.x+i,y:t.y-.57*i},{x:t.x,y:t.y},n),l=getRotatePoint({x:t.x+i,y:t.y+o/2},{x:t.x,y:t.y},n),c=getRotatePoint({x:t.x+s,y:t.y+o/2},{x:t.x,y:t.y},n),h=getRotatePoint({x:t.x+i,y:t.y-o/2},{x:t.x,y:t.y},n),d=getRotatePoint({x:t.x+s,y:t.y-o/2},{x:t.x,y:t.y},n);e.moveTo(r.x,r.y),e.lineTo(t.x,t.y),e.lineTo(a.x,a.y),e.lineTo(h.x,h.y),e.lineTo(d.x,d.y),e.lineTo(c.x,c.y),e.lineTo(l.x,l.y),e.lineTo(r.x,r.y)}function waterDrop(e,t,i,n,o,s){let r=o/2;i&&(r=-o/2);let a=getRotatePoint({x:t.x,y:t.y+r},{x:t.x,y:t.y},n),l=getRotatePoint({x:t.x+s,y:t.y},{x:t.x,y:t.y},n),c=Math.PI/2;i&&(c=-Math.PI/2),e.moveTo(t.x,t.y),e.arc(t.x,t.y,o/2,-c-n/180*Math.PI,c-n/180*Math.PI,!1),e.lineTo(l.x,l.y),e.lineTo(a.x,a.y)}function iframe(e){var t;e.onDestroy||(e.onDestroy=destory$3,e.onMove=move$3,e.onResize=move$3,e.onRotate=move$3,e.onValue=move$3,e.onMouseMove=mouseMove$1,e.onBeforeValue=beforeValue,e.onRenderPenRaw=renderPenRaw),e.calculative.singleton||(e.calculative.singleton={});const i=e.calculative.worldRect;if(!e.calculative.singleton.div){const n=document.createElement("div");n.style.position="absolute",n.style.outline="none",n.style.left="-9999px",n.style.top="-9999px",n.style.width=i.width+"px",n.style.height=i.height+"px",document.body.appendChild(n),null==(t=e.calculative.canvas.externalElements)||t.parentElement.appendChild(n),setElemPosition(e,n),e.calculative.singleton.div=n;const o=document.createElement("iframe");o.style.width="100%",o.style.height="100%",o.scrolling=e.scrolling||"no",o.frameBorder="0",o.style.border="none",o.src=e.iframe,e.calculative.iframe=e.iframe,n.appendChild(o),generateAroundDiv(e),o.onload=()=>{o.setAttribute("document.domain","")}}return e.calculative.patchFlags&&setElemPosition(e,e.calculative.singleton.div),e.onRenderPenRaw(e),new Path2D}function destory$3(e){updatePointerEvents(e),e.calculative.singleton&&e.calculative.singleton.div&&(e.calculative.singleton.div.remove(),delete e.calculative.singleton.div)}function move$3(e){e.calculative.singleton.div&&setElemPosition(e,e.calculative.singleton.div)}function beforeValue(e,t){if(t.iframe&&e.calculative.singleton.div&&(e.calculative.singleton.div.children[0].src=t.iframe,e.calculative.iframe=t.iframe),t.operationalRect||void 0!==t["operationalRect.x"]||void 0!==t["operationalRect.y"]||void 0!==t["operationalRect.width"]||void 0!==t["operationalRect.height"]){e.operationalRect||(e.operationalRect={});let i=deepClone(t);if(i.operationalRect||(i.operationalRect={}),void 0!==i["operationalRect.x"]&&(i.operationalRect.x=i["operationalRect.x"]),void 0!==i["operationalRect.y"]&&(i.operationalRect.y=i["operationalRect.y"]),void 0!==i["operationalRect.width"]&&(i.operationalRect.width=i["operationalRect.width"]),void 0!==i["operationalRect.height"]&&(i.operationalRect.height=i["operationalRect.height"]),Object.assign(e.operationalRect,i.operationalRect),e.calculative.singleton.div){1===e.calculative.singleton.div.children.length?generateAroundDiv(e):(e.calculative.singleton.div.children[1].style.height=100*e.operationalRect.y+"%",e.calculative.singleton.div.children[1].style.left=100*e.operationalRect.x+"%",e.calculative.singleton.div.children[1].style.width=100*e.operationalRect.width+"%",e.calculative.singleton.div.children[2].style.width=100*(1-e.operationalRect.x-e.operationalRect.width)+"%",e.calculative.singleton.div.children[3].style.height=100*(1-e.operationalRect.y-e.operationalRect.height)+"%",e.calculative.singleton.div.children[3].style.left=100*e.operationalRect.x+"%",e.calculative.singleton.div.children[3].style.width=100*e.operationalRect.width+"%",e.calculative.singleton.div.children[4].style.width=100*e.operationalRect.x+"%")}}if(void 0!==t.blur)for(let i=1;i<5;i++)e.calculative.singleton.div.children[i].style["backdrop-filter"]=`blur(${t.blur||2}px)`;if(void 0!==t.blurBackground)for(let i=1;i<5;i++)e.calculative.singleton.div.children[i].style.backgroundColor=t.blurBackground;return t}function mouseMove$1(e,t){if((e.calculative.canvas.store.data.locked||e.locked)&&initOperationalRect(e.operationalRect)&&e.calculative.zIndex<5&&t.x>e.x+e.width*e.operationalRect.x&&t.x<e.x+e.width*(e.operationalRect.x+e.operationalRect.width)&&t.y>e.y+e.height*e.operationalRect.y&&t.y<e.y+e.height*(e.operationalRect.y+e.operationalRect.height)&&e.calculative.singleton.div){let t=e.calculative.singleton.div.parentNode.children;for(let e=0;e<6;e++)t[e].style.pointerEvents="none"}}function initOperationalRect(e){return!!e&&(!(!e.width||!e.height)&&(void 0===e.x&&(e.x=(1-e.width)/2),void 0===e.y&&(e.y=(1-e.height)/2),!0))}function generateAroundDiv(e){if(!initOperationalRect(e.operationalRect))return;const t=e.calculative.singleton.div;if(!t)return;const i=document.createElement("div");i.style.position="absolute",i.style.left=100*e.operationalRect.x+"%",i.style.top="0px",i.style.width=100*e.operationalRect.width+"%",i.style.height=100*e.operationalRect.y+"%",i.style["backdrop-filter"]=`blur(${e.blur||2}px)`,i.style.backgroundColor=e.blurBackground,t.appendChild(i);const n=document.createElement("div");n.style.position="absolute",n.style.right="0px",n.style.top="0px",n.style.width=100*(1-e.operationalRect.x-e.operationalRect.width)+"%",n.style.height="100%",n.style["backdrop-filter"]=`blur(${e.blur||2}px)`,n.style.backgroundColor=e.blurBackground,t.appendChild(n);const o=document.createElement("div");o.style.position="absolute",o.style.left=100*e.operationalRect.x+"%",o.style.bottom="0px",o.style.width=100*e.operationalRect.width+"%",o.style.height=100*(1-e.operationalRect.y-e.operationalRect.height)+"%",o.style["backdrop-filter"]=`blur(${e.blur||2}px)`,o.style.backgroundColor=e.blurBackground,t.appendChild(o);const s=document.createElement("div");s.style.position="absolute",s.style.left="0px",s.style.top="0px",s.style.width=100*e.operationalRect.x+"%",s.style.height="100%",s.style["backdrop-filter"]=`blur(${e.blur||2}px)`,s.style.backgroundColor=e.blurBackground,t.appendChild(s);let r=()=>{updatePointerEvents(e)};i.onmouseenter=r,o.onmouseenter=r,n.onmouseenter=r,s.onmouseenter=r,t.onmouseleave=r}function updatePointerEvents(e){if((e.calculative.canvas.store.data.locked||e.locked)&&e.calculative.zIndex<5){let t=e.calculative.singleton.div.parentNode.children;for(let e=1;e<6;e++)t[e].style.pointerEvents="initial"}}function renderPenRaw(e){if(e.thumbImg&&!e.calculative.img){const t=new Image;t.crossOrigin="undefined"===e.crossOrigin?void 0:e.crossOrigin||"anonymous",e.calculative.canvas.store.options.cdn&&!(e.thumbImg.startsWith("http")||e.thumbImg.startsWith("//")||e.thumbImg.startsWith("data:image"))?t.src=e.calculative.canvas.store.options.cdn+e.thumbImg:t.src=e.thumbImg,t.onerror=i=>{t.remove(),e.calculative.img=void 0},e.calculative.img=t}}const videos={},mutedIcons=['<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M473.088 125.44L256 256H52.224C23.552 256 0 279.552 0 308.224V716.8c0 28.16 23.04 51.2 51.2 51.2h204.8l217.088 130.56c16.896 10.24 38.912-2.048 38.912-22.016V147.456c0-19.968-21.504-32.256-38.912-22.016zM699.904 320.512c-20.992-18.944-53.248-17.408-72.192 3.584-18.944 20.992-17.408 53.248 3.584 72.192 0.512 0.512 58.368 54.784 58.368 121.344 0 37.888-19.456 74.752-58.368 110.08-20.992 18.944-22.528 51.2-3.584 72.192 10.24 11.264 24.064 16.896 37.888 16.896 12.288 0 24.576-4.608 34.304-13.312 61.44-55.296 92.16-117.76 92.16-185.856 0-112.64-88.576-193.536-92.16-197.12z" fill="" p-id="2434"></path><path d="M853.504 166.4c-20.992-18.944-53.248-16.896-72.192 4.096-18.944 20.992-16.896 53.248 4.096 72.192 1.536 1.024 135.68 122.88 135.68 280.576 0 90.624-45.568 177.152-135.68 257.536-20.992 18.944-23.04 51.2-4.096 72.192 10.24 11.264 24.064 16.896 38.4 16.896 12.288 0 24.576-4.096 34.304-12.8 112.64-100.864 169.984-212.992 169.984-333.824-1.024-202.752-163.84-350.208-170.496-356.864z"></path></svg>','<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" ><path d="M256 768H51.2c-28.16 0-51.2-23.04-51.2-51.2V308.224C0 279.552 23.552 256 52.224 256H256v512zM512 147.456v728.576c0 19.968-21.504 32.256-38.912 22.016L256 768V256l217.088-130.56c17.408-10.24 38.912 2.048 38.912 22.016zM623.104 656.896c-19.968-19.968-19.968-52.224 0-72.192l217.088-217.088c19.968-19.968 52.224-19.968 72.192 0 19.968 19.968 19.968 52.224 0 72.192l-217.088 217.088c-19.456 19.968-52.224 19.968-72.192 0z" fill="" p-id="2582"></path><path d="M623.104 367.104c19.968-19.968 52.224-19.968 72.192 0l217.088 217.088c19.968 19.968 19.968 52.224 0 72.192-19.968 19.968-52.224 19.968-72.192 0l-217.088-217.088c-19.968-19.456-19.968-52.224 0-72.192z"></path></svg>'];function video(e){var t;if(e.onDestroy||(e.onDestroy=destory$2,e.onMove=move$2,e.onResize=move$2,e.onRotate=move$2,e.onClick=click,e.onValue=value$2,e.onChangeId=changeId$1),videos[e.id])e.video&&e.calculative.media&&e.video!==e.calculative.video?(e.calculative.media.src=e.video,e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop,e.calculative.video=e.video):e.audio&&e.calculative.media&&e.audio!==e.calculative.audio&&(e.calculative.media.src=e.audio,e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop,e.calculative.audio=e.audio);else{const i=document.createElement("div"),n=document.createElement("div");n.style.position="absolute",n.style.outline="none",n.style.left="0",n.style.bottom="0",n.style.width="0",n.style.height="2px",n.style.background="#52c41a",n.style.zIndex="1",e.hideProgress&&(n.style.display="none");const o=document.createElement("div");let s;o.innerHTML=mutedIcons[1],o.style.position="absolute",o.style.right="0",o.style.bottom="0",o.style.width="20px",o.style.height="20px",o.style.fill="hsla(0, 0%, 100%, .8)",o.style.zIndex="1",o.style.display="none",i.appendChild(n),i.appendChild(o),o.onclick=t=>{t.stopPropagation(),e.calculative.media.muted?(o.innerHTML=mutedIcons[0],e.calculative.media.muted=!1):(o.innerHTML=mutedIcons[1],e.calculative.media.muted=!0)},e.calculative.singleton||(e.calculative.singleton={}),e.calculative.singleton.muted=o,i.onmouseenter=e=>{o.style.display="block"},i.onmouseleave=e=>{o.style.display="none"},i.onclick=t=>{t.stopPropagation(),click(e)},e.audio?(s=document.createElement("audio"),s.controls=e.controls,s.src=e.audio):(s=document.createElement("video"),s.src=e.video),s.loop=e.playLoop,s.ontimeupdate=()=>{resizeProcessWidth(n,s,e.calculative.worldRect.width)},s.onended=()=>{e.calculative.onended&&e.calculative.onended(e)},e.calculative.media=s,s.style.position="absolute",s.style.outline="none",s.style.left="0",s.style.top="0",s.style.width="100%",s.style.height="100%",i.appendChild(s),videos[e.id]=i,null==(t=e.calculative.canvas.externalElements)||t.parentElement.appendChild(i),setElemPosition(e,i),e.autoPlay&&(s.autoplay=!0,s.muted=!0)}return e.calculative.patchFlags&&setElemPosition(e,videos[e.id]),new Path2D}function destory$2(e){videos[e.id].onclick=null,videos[e.id].remove(),videos[e.id]=void 0}function move$2(e){setElemPosition(e,videos[e.id]);resizeProcessWidth(videos[e.id].children[0],videos[e.id].children[1],e.calculative.worldRect.width)}function click(e){e.calculative.media&&(e.calculative.media.muted=!1,e.calculative.singleton.muted.innerHTML=mutedIcons[0],e.calculative.media.paused?e.calculative.media.play():e.calculative.media.pause())}function resizeProcessWidth(e,t,i){e.style.width=t.currentTime/t.duration*i+"px"}function changeId$1(e,t,i){videos[t]&&(videos[i]=videos[t],delete videos[t])}function value$2(e){const t=videos[e.id];if(!t)return;setElemPosition(e,t);const i=e.calculative.media.getAttribute("src");e.video?i!==e.video&&(e.calculative.media.src=e.video):e.audio&&i!==e.audio&&(e.calculative.media.src=e.audio),e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop}function createOffscreen(){try{const e=new OffscreenCanvas(0,0),t=e.getContext("2d");return t&&t.arc?e:document.createElement("canvas")}catch(e){return document.createElement("canvas")}}class Tooltip{constructor(e,t){let i;__publicField(this,"parentElement"),__publicField(this,"store"),__publicField(this,"box"),__publicField(this,"text"),__publicField(this,"arrowUp"),__publicField(this,"arrowDown"),__publicField(this,"x"),__publicField(this,"y"),__publicField(this,"currentPen"),this.parentElement=e,this.store=t,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.box.className="meta2d-tooltip",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),e.appendChild(this.box),this.box.onmouseleave=()=>{this.hide(),this.store.lastHover=void 0};for(let n=0;n<document.styleSheets.length;n++)"le5le.com/tooltip"===document.styleSheets[n].title&&(i=document.styleSheets[n]);if(!i){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/tooltip",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),i=e.sheet,i.insertRule(".meta2d-tooltip{position:absolute;padding:8px 0;z-index:10;left: -9999px;top: -9999px;}"),i.insertRule(".meta2d-tooltip .text{max-width:320px;min-height:30px;max-height:400px;outline:none;padding:8px 16px;border-radius:4px;background:#777777;color:#ffffff;line-height:1.8;overflow-y:auto;}"),i.insertRule(".meta2d-tooltip .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-5px;left:50%;transform:translateX(-50%)}"),i.insertRule(".meta2d-tooltip .arrow.down{top:initial;bottom: -1px;}")}}static getTitle(e){if(e.titleFnJs&&!e.titleFn)try{e.titleFn=new Function("pen",e.titleFnJs)}catch(t){}return e.titleFn?e.titleFn(e):String(e.title)}setText(e){const t=this.box.getBoundingClientRect();let i=globalThis.marked;const n=Tooltip.getTitle(e);if(i){this.text.innerHTML=i(n);const e=this.text.getElementsByTagName("A");for(let t=0;t<e.length;++t)e[t].setAttribute("target","_blank")}else this.text.innerHTML=n;return t}updateText(e){var t;if((null==(t=this.currentPen)?void 0:t.id)!==e.id)return;if(Tooltip.titleEmpty(e))return;const i=this.setText(e),n=this.box.getBoundingClientRect();this.changePositionByText(i,n)}changePositionByText(e,t){this.x-=(t.width-e.width)/2,this.y-=t.height-e.height,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}static titleEmpty(e){return!e.title&&!e.titleFn&&!e.titleFnJs}show(e,t){if(this.currentPen=e,Tooltip.titleEmpty(e)){let i=getParent(e,!0);return void(i&&this.show(i,t))}this.setText(e);const i=this.box.getBoundingClientRect(),n=e.calculative.worldRect;let o=e.calculative.canvas.store.data.x+t.x-i.width/2,s=e.calculative.canvas.store.data.y+t.y-i.height;e.type||(o=e.calculative.canvas.store.data.x+n.x-(i.width-n.width)/2,s=e.calculative.canvas.store.data.y+n.ey-i.height-n.height),s>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#777777"):(s+=i.height+n.height+5,this.arrowUp.style.borderBottomColor="#777777",this.arrowDown.style.borderTopColor="transparent"),this.x=o,this.y=s,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.currentPen=null,this.x=-9999,this.box.style.left="-9999px"}translate(e,t){this.x<-1e3||(this.x+=e,this.y+=t,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px")}destroy(){this.box.onmouseleave=null}}class Scroll{constructor(e){let t;__publicField(this,"parent"),__publicField(this,"h"),__publicField(this,"v"),__publicField(this,"isDownH"),__publicField(this,"isDownV"),__publicField(this,"x"),__publicField(this,"y"),__publicField(this,"hSize"),__publicField(this,"vSize"),__publicField(this,"scrollX"),__publicField(this,"scrollY"),__publicField(this,"lastScrollX"),__publicField(this,"lastScrollY"),__publicField(this,"rect"),__publicField(this,"isShow"),__publicField(this,"pageMode"),__publicField(this,"onMouseDownH",(e=>{e.preventDefault(),e.stopPropagation(),this.isDownH=e.x,this.x=this.parent.store.data.x||0,this.lastScrollX=this.scrollX})),__publicField(this,"onMouseDownV",(e=>{e.preventDefault(),e.stopPropagation(),this.isDownV=e.y,this.y=this.parent.store.data.y||0,this.lastScrollY=this.scrollY})),__publicField(this,"onMouseMove",(e=>{if(this.isDownH){const t=e.x-this.isDownH;this.scrollX=this.lastScrollX+t,this.h.style.left=`${this.scrollX}px`,this.parent.store.data.x=this.x-t*this.rect.width/this.parent.parentElement.clientWidth}if(this.isDownV){const t=e.y-this.isDownV;if(this.pageMode&&this.canMouseMove(t))return;this.scrollY=this.lastScrollY+t,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y=this.y-t*this.rect.height/this.parent.parentElement.clientHeight}(this.isDownH||this.isDownV)&&(this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())})),__publicField(this,"onMouseUp",(e=>{(this.isDownH||this.isDownV)&&(this.isDownH=void 0,this.isDownV=void 0,this.scrollX<20?(this.scrollX=20,this.h.style.left=`${this.scrollX}px`):this.scrollX>this.parent.parentElement.clientWidth-this.hSize-20&&(this.scrollX=this.parent.parentElement.clientWidth-this.hSize-20,this.h.style.left=`${this.scrollX}px`),this.scrollY<20?(this.scrollY=20,this.v.style.top=`${this.scrollY}px`):this.scrollY>this.parent.parentElement.clientHeight-this.vSize-20&&(this.scrollY=this.parent.parentElement.clientHeight-this.vSize-20,this.v.style.top=`${this.scrollY}px`),this.resize())})),this.parent=e,this.h=document.createElement("div"),this.v=document.createElement("div"),this.parent.externalElements.appendChild(this.h),this.parent.externalElements.appendChild(this.v),this.h.className="meta2d-scroll h",this.h.onmousedown=this.onMouseDownH,this.v.className="meta2d-scroll v",this.v.onmousedown=this.onMouseDownV,document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp);for(let i=0;i<document.styleSheets.length;i++)"le5le/scroll"===document.styleSheets[i].title&&(t=document.styleSheets[i]);if(!t){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/scroll",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),t=e.sheet,t.insertRule(".meta2d-scroll{position:absolute;width:8px;height:200px;background:#dddddd;border-radius:10px;z-index:20;cursor:default;}"),t.insertRule(".meta2d-scroll:hover{background:#cccccc;cursor:pointer}"),t.insertRule(".meta2d-scroll.v{right:0;top:calc(50% - 100px);}"),t.insertRule(".meta2d-scroll.h{bottom:2px;left:calc(50% - 100px);width:200px;height:8px;}")}this.init()}init(){this.isShow=!0,this.resize(),this.initPos()}canMouseMove(e){const t=this.parent.parent.getRect();return e<0&&t.y+this.parent.store.data.y>=0||e>0&&t.ey-this.parent.height+this.parent.store.data.y<=0}changeMode(){this.pageMode=!0,this.h.style.display="none";this.parent.parent.getRect().height<this.parent.height&&(this.v.style.display="none")}initPos(){this.scrollX=(this.parent.parentElement.clientWidth-this.hSize)/2,this.scrollY=(this.parent.parentElement.clientHeight-this.vSize)/2,this.h.style.left=`${this.scrollX}px`,this.v.style.top=`${this.scrollY}px`}resize(){this.rect=getRect$1(this.parent.store.data.pens),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.parent.store.data.x>0?this.rect.width+=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x):this.rect.width-=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x),this.parent.store.data.y>0?this.rect.height+=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y):this.rect.height-=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.hSize=1e3*this.parent.parentElement.clientWidth/this.rect.width/3,this.vSize=1e3*this.parent.parentElement.clientHeight/this.rect.height/3,this.h.style.width=this.hSize+"px",this.v.style.height=this.vSize+"px"}show(){this.isShow=!0,this.h.style.display="block",this.v.style.display="block",document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}hide(){this.isShow=!1,this.h.style.display="none",this.v.style.display="none",this.destroy()}translate(e,t){e&&(this.scrollX-=e*this.parent.parentElement.clientWidth/this.rect.width,this.h.style.left=`${this.scrollX}px`),t&&(this.scrollY-=t*this.parent.parentElement.clientHeight/this.rect.height,this.v.style.top=`${this.scrollY}px`)}wheel(e){let t=10;e&&(t=-10),this.pageMode&&this.canMouseMove(t)||(this.scrollY+=t,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y-=t*this.rect.height/this.parent.parentElement.clientHeight,this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())}destroy(){document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}}class CanvasImage{constructor(e,t,i){__publicField(this,"parentElement"),__publicField(this,"store"),__publicField(this,"isBottom"),__publicField(this,"canvas",document.createElement("canvas")),__publicField(this,"otherOffsreen",createOffscreen()),__publicField(this,"offscreen",createOffscreen()),__publicField(this,"animateOffsScreen",createOffscreen()),__publicField(this,"fitOffscreen",createOffscreen()),__publicField(this,"fitFlag",!1),__publicField(this,"currentFit"),__publicField(this,"activeFit"),this.parentElement=e,this.store=t,this.isBottom=i,e.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(e,t){this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",e=e*this.store.dpiRatio|0,t=t*this.store.dpiRatio|0,this.canvas.width=e,this.canvas.height=t,this.otherOffsreen.width=e,this.otherOffsreen.height=t,this.offscreen.width=e,this.offscreen.height=t,this.animateOffsScreen.width=e,this.animateOffsScreen.height=t,this.fitOffscreen.width=e,this.fitOffscreen.height=t,this.otherOffsreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.otherOffsreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.animateOffsScreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.animateOffsScreen.getContext("2d").textBaseline="middle",this.fitOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.fitOffscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height);for(const e of this.store.data.pens)this.hasImage(e)&&(e.calculative.imageDrawed=!1);this.isBottom?this.store.patchFlagsBackground=!0:this.store.patchFlagsTop=!0}clear(){this.otherOffsreen.getContext("2d").clearRect(0,0,this.otherOffsreen.width,this.otherOffsreen.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}hasImage(e){return e.calculative.hasImage=e.calculative&&e.calculative.inView&&(this.isBottom&&e.canvasLayer===CanvasLayer.CanvasImageBottom||!this.isBottom&&e.canvasLayer===CanvasLayer.CanvasImage)&&e.image&&e.calculative.img&&"gif"!==e.name,e.calculative.hasImage}render(){var e;let t=!1,i=!1;for(const s of this.store.data.pens)this.hasImage(s)&&(this.store.animates.has(s)?i=!0:s.calculative.imageDrawed||(t=!0),s.parentId&&this.store.animates.has(getParent(s,!0))&&(i=!0));const n=this.store.patchFlagsBackground,o=this.store.patchFlagsTop;if(o&&!this.isBottom){const e=this.otherOffsreen.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderRule(e)}if(this.store.patchFlagsLast){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}if(t){const e=this.offscreen.getContext("2d");e.save(),e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(this.store.data.x,this.store.data.y);for(const t of this.store.data.pens)!t.calculative.hasImage||this.store.animates.has(t)||this.store.animates.has(getParent(t,!0))||t.canvasLayer!==CanvasLayer.CanvasTemplate&&("combine"!==t.name||t.draw)&&(t.calculative.imageDrawed=!0,e.save(),ctxFlip(e,t),t.calculative.rotate&&ctxRotate(e,t),setGlobalAlpha(e,t),drawImage(e,t),e.restore());e.restore()}if(i){const e=this.animateOffsScreen.getContext("2d");e.save(),e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(this.store.data.x,this.store.data.y);for(const t of this.store.animates)t.calculative.hasImage&&t.canvasLayer!==CanvasLayer.CanvasTemplate&&!1!==t.visible&&!1!==t.calculative.visible&&(t.calculative.imageDrawed=!0,e.save(),ctxFlip(e,t),t.calculative.rotate&&ctxRotate(e,t),setGlobalAlpha(e,t),drawImage(e,t),e.restore());for(const t of this.store.data.pens)t.calculative.hasImage&&t.parentId&&t.canvasLayer!==CanvasLayer.CanvasTemplate&&!1!==t.visible&&!1!==t.calculative.visible&&this.store.animates.has(getParent(t,!0))&&(t.calculative.imageDrawed=!0,e.save(),ctxFlip(e,t),t.calculative.rotate&&ctxRotate(e,t),setGlobalAlpha(e,t),drawImage(e,t),e.restore());e.restore()}if(!this.isBottom&&!this.store.data.locked&&this.fitFlag){const t=(this.store.data.width||this.store.options.width)*this.store.data.scale,i=(this.store.data.height||this.store.options.height)*this.store.data.scale,n=this.store.data.origin.x+this.store.data.x||this.store.options.x||0,o=this.store.data.origin.y+this.store.data.y||this.store.options.y||0,s=this.fitOffscreen.getContext("2d");s.save(),s.clearRect(0,0,this.canvas.width,this.canvas.height),s.fillStyle="#ffffff66",s.strokeStyle=this.store.styles.activeColor,null==(e=this.store.data.fits)||e.forEach(((e,r)=>{s.fillRect(n+t*e.x,o+i*e.y,t*e.width,i*e.height),e.active&&s.strokeRect(n+t*e.x,o+i*e.y,t*e.width,i*e.height)})),s.restore()}if(t||i||n&&this.isBottom||o&&!this.isBottom){const e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),this.isBottom&&(this.store.patchFlagsBackground=!1),e.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),e.drawImage(this.animateOffsScreen,0,0,this.canvas.width,this.canvas.height),this.isBottom||(e.drawImage(this.otherOffsreen,0,0,this.canvas.width,this.canvas.height),this.store.patchFlagsTop=!1,!this.store.data.locked&&this.fitFlag&&e.drawImage(this.fitOffscreen,0,0,this.canvas.width,this.canvas.height))}}renderRule(e){var t,i,n,o,s,r,a,l;const{data:c,options:h}=this.store,{rule:d,ruleColor:u,scale:p,origin:f}=c;if(!(d??h.rule))return;const v=10*p;e.save();const g=u||h.ruleColor||"#ccc";e.strokeStyle=rgba(g,.7);const y=f.x+c.x,m=f.y+c.y,{width:w,height:b}=this.canvas;let x=(null==(t=h.ruleOptions)?void 0:t.height)||20;(null==(i=h.ruleOptions)?void 0:i.background)&&(e.beginPath(),e.fillStyle=null==(n=h.ruleOptions)?void 0:n.background,e.rect(0,0,w,x),e.fill(),e.rect(0,0,x,b),e.fill()),(null==(o=h.ruleOptions)?void 0:o.underline)&&(e.beginPath(),e.fillStyle=rgba(g,.7),e.moveTo(0,x),e.lineTo(w,x),e.stroke(),e.moveTo(x,0),e.lineTo(x,b),e.stroke());let k=x/4;"bottom"===(null==(s=h.ruleOptions)?void 0:s.baseline)&&(k=3*x/4),e.beginPath(),e.lineWidth=x/2,e.lineDashOffset=-y%v,e.setLineDash([1,v-1]),e.moveTo(0,k),e.lineTo(w,k),e.stroke(),e.beginPath(),e.lineDashOffset=-m%v,e.moveTo(k,0),e.lineTo(k,b),e.stroke(),e.strokeStyle=g,e.beginPath(),e.lineWidth=x,e.lineDashOffset=-y%(10*v),e.setLineDash([1,10*v-1]),e.moveTo(0,x/2),e.lineTo(w,x/2),e.stroke(),e.beginPath(),e.lineDashOffset=-m%(10*v),e.moveTo(x/2,0),e.lineTo(x/2,b),e.stroke(),e.beginPath(),e.fillStyle=(null==(r=h.ruleOptions)?void 0:r.textColor)||e.strokeStyle;let T=0-100*Math.floor(y/v/10),C=(null==(a=h.ruleOptions)?void 0:a.textTop)||16,A=(null==(l=h.ruleOptions)?void 0:l.textLeft)||4;y<0&&(T-=100);for(let R=y%(10*v);R<w;R+=10*v,T+=100)v<3&&T%500||e.fillText(T.toString(),R+A,C);T=0-100*Math.floor(m/v/10),m<0&&(T-=100);for(let R=m%(10*v);R<b;R+=10*v,T+=100)v<3&&T%500||(e.save(),e.beginPath(),e.translate(C,R-A),e.rotate(270*Math.PI/180),e.fillText(T.toString(),0,0),e.restore());e.restore()}}class MagnifierCanvas{constructor(e,t,i){__publicField(this,"parentCanvas"),__publicField(this,"parentElement"),__publicField(this,"store"),__publicField(this,"canvas",document.createElement("canvas")),__publicField(this,"magnifierScreen",createOffscreen()),__publicField(this,"offscreen",createOffscreen()),__publicField(this,"domOffscreen",createOffscreen()),__publicField(this,"magnifierSize",300),__publicField(this,"magnifier"),this.parentCanvas=e,this.parentElement=t,this.store=i,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none"}resize(e,t){this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",e=e*this.store.dpiRatio|0,t=t*this.store.dpiRatio|0,this.canvas.width=e,this.canvas.height=t,this.offscreen.width=e,this.offscreen.height=t,this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.domOffscreen.width=e,this.domOffscreen.height=t,this.domOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.domOffscreen.getContext("2d").textBaseline="middle",this.magnifierScreen.width=this.magnifierSize+5,this.magnifierScreen.height=this.magnifierSize+5}renderMagnifier(){if(!this.magnifier)return;const e=this.magnifierSize/2,t=this.magnifierSize+5,i=this.magnifierScreen.getContext("2d");i.clearRect(0,0,t,t),i.lineWidth=5,i.save(),i.translate(2.5,2.5),i.save(),i.arc(e,e,e,0,2*Math.PI,!1),i.clip(),i.translate(-e,-e),i.scale(2,2);const n=(this.parentCanvas.mousePos.x+this.store.data.x)*this.store.dpiRatio,o=(this.parentCanvas.mousePos.y+this.store.data.y)*this.store.dpiRatio;[this.parentCanvas.canvasTemplate.bgOffscreen,this.parentCanvas.canvasTemplate.offscreen,this.parentCanvas.canvasImageBottom.offscreen,this.parentCanvas.canvasImageBottom.animateOffsScreen,this.parentCanvas.offscreen,this.parentCanvas.canvasImage.offscreen,this.parentCanvas.canvasImage.animateOffsScreen,this.domOffscreen].forEach((t=>{i.drawImage(t,n-e,o-e,this.magnifierSize,this.magnifierSize,0,0,this.magnifierSize,this.magnifierSize)})),i.restore(),i.beginPath();const s=i.createRadialGradient(e,e,e-5,e,e,e);s.addColorStop(0,"rgba(0,0,0,0.2)"),s.addColorStop(.8,"rgb(200,200,200)"),s.addColorStop(.9,"rgb(200,200,200)"),s.addColorStop(1,"rgba(200,200,200,0.9)"),i.strokeStyle=s,i.arc(e,e,e,0,2*Math.PI,!1),i.stroke(),i.restore();this.offscreen.getContext("2d").drawImage(this.magnifierScreen,0,0,this.magnifierSize+5,this.magnifierSize+5,(n-e-2.5)/this.store.dpiRatio,(o-e-2.5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio)}updateDomOffscreen(){const e=this.domOffscreen.getContext("2d");e.clearRect(0,0,this.domOffscreen.width,this.domOffscreen.height);for(const t of this.store.data.pens)if((t.externElement||"gif"===t.name)&&t.calculative.img){e.save(),e.translate(this.store.data.x,this.store.data.y);const{x:i,y:n,width:o,height:s}=t.calculative.worldRect;e.drawImage(t.calculative.img,i,n,o,s),e.restore()}}render(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.renderMagnifier();const e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),e.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height)}}function lockedError(e){if(e.data.locked)throw new Error("canvas is locked")}class Dialog{constructor(e,t){__publicField(this,"parentElement"),__publicField(this,"box"),__publicField(this,"iframe"),__publicField(this,"dialog"),__publicField(this,"close"),__publicField(this,"title"),__publicField(this,"body"),__publicField(this,"x"),__publicField(this,"y"),__publicField(this,"url"),__publicField(this,"meta2dDiv"),__publicField(this,"dialogMeta2d"),__publicField(this,"store"),this.parentElement=e,this.store=t,this.box=document.createElement("div"),this.dialog=document.createElement("div");let i,n=document.createElement("div");this.title=document.createElement("div"),this.close=document.createElement("span"),this.close.innerHTML='\n      <svg fill="none" viewBox="0 0 16 16" width="1em" height="1em">\n      <path\n        fill="currentColor"\n        d="M8 8.92L11.08 12l.92-.92L8.92 8 12 4.92 11.08 4 8 7.08 4.92 4 4 4.92 7.08 8 4 11.08l.92.92L8 8.92z"\n        fill-opacity="0.9"\n      ></path>\n    </svg>',this.body=document.createElement("div"),this.iframe=document.createElement("iframe"),this.iframe.setAttribute("frameborder","0"),this.meta2dDiv=document.createElement("div"),this.box.className="meta2d-dialog_mask",this.dialog.className="meta2d-dialog",this.body.className="meta2d-dialog_body",n.className="meta2d-dialog_header",this.title.className="meta2d-dialog-content",this.close.className="meta2d-dialog-close",this.meta2dDiv.className="meta2d-dialog-meta2d",n.appendChild(this.title),n.appendChild(this.close),this.body.appendChild(this.iframe),this.body.appendChild(this.meta2dDiv),this.dialog.appendChild(n),this.dialog.appendChild(this.body),this.box.appendChild(this.dialog),e.appendChild(this.box),this.dialog.onclick=e=>{e.stopPropagation()},this.box.onclick=()=>{this.hide()},this.close.onclick=()=>{this.hide()};for(let o=0;o<document.styleSheets.length;o++)"le5le.com/dialog"===document.styleSheets[o].title&&(i=document.styleSheets[o]);if(!i){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/dialog",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),i=e.sheet,i.insertRule(".meta2d-dialog_mask {\n        display: none;\n        position: absolute;\n        top: 0%;\n        left: 0%;\n        width: 100%;\n        height: 100%;\n        background-color: #0000006f;\n        z-index: 9999;"),i.insertRule(".meta2d-dialog_mask .meta2d-dialog {\n            position: absolute;\n            top: 15vh;\n            left: 10%;\n            width: 80%;\n            height:420px;\n            padding: 16px 20px;\n            border-radius: 9px;\n            background-color: #1e2430;\n            z-index: 19999;\n            overflow: auto;\n        }"),i.insertRule(".meta2d-dialog_header {\n            display: flex;\n            position: relative;\n            z-index: 999;\n        }"),i.insertRule(".meta2d-dialog-content {\n            width: calc(100% - 20px);\n            font-weight: 600;\n            font-size: 14px;\n            color: #bdc7db;\n            padding-bottom:8px;\n        }"),i.insertRule(".meta2d-dialog-close {\n            width: 20px;\n            height: 20px;\n            line-height: 20px;\n            text-align: center;\n            color: #617b91;\n            position: absolute;\n            right:20px;\n            top:2px;\n        }"),i.insertRule(".meta2d-dialog-close svg{\n            width: 18px;\n            height: 18px;\n        }"),i.insertRule(".meta2d-dialog-close :hover{\n            cursor: pointer;\n        }"),i.insertRule(".meta2d-dialog_body{\n          width: 100%;\n          height: 100%;\n        } "),i.insertRule(".meta2d-dialog_body iframe{\n            width: 100%;\n            height: 100%;\n        }"),i.insertRule(".meta2d-dialog_body .meta2d-dialog-meta2d{\n          width: 100%;\n          height: 100%;\n          display: none;\n      }")}}async show(e,t,i,n){if(!t)return;const o=this.isUrl(t);if(o?(this.meta2dDiv.style.display="none",this.iframe.style.display="block"):(this.iframe.style.display="none",this.meta2dDiv.style.display="block"),o&&t!==this.url&&(this.iframe.setAttribute("src",t),this.url=t),e&&(this.title.innerText=e),e?(this.dialog.style.padding="16px 20px",this.title.style.display="block",this.body.style.height="calc(100% - 26px)",this.close.style.top="2px",this.close.style.right="2px",this.body.style.background="#1e2430"):(this.dialog.style.padding="0px",this.title.style.display="none",this.body.style.height="100%",this.body.style.overflow="hidden",this.close.style.top="18px",this.close.style.right="20px",this.body.style.background="transparent"),i&&(this.dialog.style.width=i.width?i.width+"px":"80%",this.dialog.style.height=i.height?i.height+"px":"420px",this.dialog.style.top=i.y?i.y+"px":i.height?`calc( 50% - ${i.height/2}px )`:"15vh",this.dialog.style.left=i.x?i.x+"px":`calc( 50% - ${i.width?i.width/2+"px":"40%"} )`),o&&n){let e=0;const t=setInterval((()=>{this.iframe.contentWindow.meta2d&&(clearInterval(t),setTimeout((()=>{this.iframe.contentWindow.postMessage(JSON.stringify({name:"dialog",data:n}),"*")}),100)),e++,e>50&&clearInterval(t)}),300)}if(this.dialogMeta2d&&!o||(this.box.style.display="block"),!o){this.meta2dDiv.style.display="block",this.dialogMeta2d||(globalThis.mainMeta2d=globalThis.meta2d,this.dialogMeta2d=new Meta2d(this.meta2dDiv),globalThis.meta2d=globalThis.mainMeta2d);const e=await getMeta2dData(this.store,t);e&&(this.box.style.display="block",this.dialogMeta2d.clear(!0),this.dialogMeta2d.open(e,!1),this.dialogMeta2d.lock(1),this.dialogMeta2d.resize(),this.dialogMeta2d.fitView(!0,0),this.dialogMeta2d.render(!0))}}hide(){this.box.style.display="none"}isUrl(e){return!!(e.startsWith("http")||e.includes("?")||e.includes("/"))}destroy(){var e;this.dialog.onclick=void 0,this.box.onclick=void 0,this.close.onclick=void 0,null==(e=this.dialogMeta2d)||e.destroy(!0)}}class Title{constructor(e){let t;__publicField(this,"parentElement"),__publicField(this,"box"),__publicField(this,"currentAnchor"),this.parentElement=e,this.box=document.createElement("div"),this.box.className="meta2d-title",e.appendChild(this.box);for(let i=0;i<document.styleSheets.length;i++)"le5le.com/title"===document.styleSheets[i].title&&(t=document.styleSheets[i]);if(!t){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/title",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),t=e.sheet,t.insertRule(".meta2d-title{position:absolute;padding:0;z-index:10;left: -9999px;top: -9999px;background:#fff;color:#000; cursor: crosshair;border: 1px solid black;}")}}static getTitle(e){}setText(e){this.box.innerText=e.title}updateText(e){var t;(null==(t=this.currentAnchor)?void 0:t.id)===e.id&&(Title.titleEmpty(e)||(this.setText(e),this.changePositionByAnchor(e)))}changePositionByAnchor(e){this.box.style.left=e.x+10+"px",this.box.style.top=e.y+10+"px"}static titleEmpty(e){return!e.title}show(e,t){if(Title.titleEmpty(e))return;this.currentAnchor=e,this.setText(e);let i={x:t.calculative.canvas.store.data.x+e.x,y:t.calculative.canvas.store.data.y+e.y};this.changePositionByAnchor(i)}hide(){this.box.style.left="-9999px",this.box.innerText="",this.currentAnchor=null}destroy(){this.box.onmouseleave=null}}class CanvasTemplate{constructor(e,t){__publicField(this,"parentElement"),__publicField(this,"store"),__publicField(this,"canvas",document.createElement("canvas")),__publicField(this,"offscreen",createOffscreen()),__publicField(this,"bgOffscreen",createOffscreen()),__publicField(this,"patchFlags"),__publicField(this,"bgPatchFlags"),__publicField(this,"fit"),this.parentElement=e,this.store=t,e.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(e,t){this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",e=e*this.store.dpiRatio|0,t=t*this.store.dpiRatio|0,this.canvas.width=e,this.canvas.height=t,this.bgOffscreen.width=e,this.bgOffscreen.height=t,this.offscreen.width=e,this.offscreen.height=t,this.bgOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.bgOffscreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.patchFlags=!0,this.bgPatchFlags=!0}hidden(){this.canvas.style.display="none"}show(){this.canvas.style.display="block"}clear(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.bgPatchFlags=!0,this.patchFlags=!0}render(){if(this.bgPatchFlags){const e=this.bgOffscreen.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height);const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height,n=this.store.data.x||this.store.options.x||0,o=this.store.data.y||this.store.options.y||0,s=this.store.data.background||this.store.styles.background;s&&(e.save(),e.fillStyle=s,e.globalAlpha=this.store.data.globalAlpha??this.store.options.globalAlpha,t&&i&&!this.fit?(e.shadowOffsetX=this.store.options.shadowOffsetX,e.shadowOffsetY=this.store.options.shadowOffsetY,e.shadowBlur=this.store.options.shadowBlur,e.shadowColor=this.store.options.shadowColor,e.fillRect(this.store.data.origin.x+n,this.store.data.origin.y+o,t*this.store.data.scale,i*this.store.data.scale)):e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore()),t&&i&&this.store.bkImg&&(e.save(),this.fit?e.drawImage(this.store.bkImg,0,0,this.canvas.offsetWidth,this.canvas.offsetHeight):e.drawImage(this.store.bkImg,this.store.data.origin.x+n,this.store.data.origin.y+o,t*this.store.data.scale,i*this.store.data.scale),e.restore()),this.renderGrid(e)}if(this.patchFlags){const e=this.offscreen.getContext("2d");e.save(),e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(this.store.data.x,this.store.data.y);for(const t of this.store.data.pens)if(isFinite(t.x)&&t.canvasLayer===CanvasLayer.CanvasTemplate&&t.calculative.inView){if("combine"===t.name&&!t.draw)continue;renderPen(e,t),t.image&&"gif"!==t.name&&t.calculative.img&&(e.save(),ctxFlip(e,t),t.calculative.rotate&&ctxRotate(e,t),setGlobalAlpha(e,t),drawImage(e,t),e.restore())}e.restore()}if(this.patchFlags||this.bgPatchFlags){const e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),e.drawImage(this.bgOffscreen,0,0,this.canvas.width,this.canvas.height),e.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),this.patchFlags=!1,this.bgPatchFlags=!1}}renderGrid(e){const{data:t,options:i}=this.store,{grid:n,gridRotate:o,gridColor:s,gridSize:r,scale:a,origin:l}=t;if(!(n??i.grid))return;e.save();const c=(t.width||i.width)*a,h=(t.height||i.height)*a,d=(t.x||i.x||0)+l.x,u=(t.y||i.y||0)+l.y;o&&(e.translate(c/2,h/2),e.rotate(o*Math.PI/180),e.translate(-c/2,-h/2)),e.lineWidth=1,e.strokeStyle=s||i.gridColor,e.beginPath();let p=(r||i.gridSize)*a;if(p=p<0?0:p,c&&h){const t=c+d,i=h+u;for(let n=d;n<=t;n+=p)e.moveTo(n,u),e.lineTo(n,h+u);for(let n=u;n<=i;n+=p)e.moveTo(d,n),e.lineTo(c+d,n)}else{const t=this.store.dpiRatio,i=this.canvas.width/t,n=this.canvas.height/t,o=d/p,s=u/p,r=10*p,a=d-Math.ceil(o)*p,l=u-Math.ceil(s)*p,c=i+a+r,h=n+l+r;for(let d=a;d<=c;d+=p)e.moveTo(d,l),e.lineTo(d,n+l+r);for(let d=l;d<=h;d+=p)e.moveTo(a,d),e.lineTo(i+a+r,d)}e.stroke(),e.restore()}}const status$1={success:{},info:{icon:'<svg fill="none" viewBox="0 0 24 24"><path fill="#0052d9" d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{},error:{}};class Popconfirm{constructor(e,t){let i;__publicField(this,"parentElement"),__publicField(this,"store"),__publicField(this,"box"),__publicField(this,"text"),__publicField(this,"arrowUp"),__publicField(this,"arrowDown"),__publicField(this,"icon"),__publicField(this,"confirm"),__publicField(this,"cancel"),__publicField(this,"x"),__publicField(this,"y"),this.parentElement=e,this.store=t,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.icon=document.createElement("div"),this.confirm=document.createElement("button"),this.cancel=document.createElement("button"),this.box.className="meta2d-popconfirm",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.icon.className="icon",this.confirm.className="confirm",this.cancel.className="cancel",this.confirm.innerHTML="确定",this.cancel.innerHTML="取消",this.icon.innerHTML=status$1.info.icon,this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),this.box.appendChild(this.confirm),this.box.appendChild(this.cancel),this.box.appendChild(this.icon),e.appendChild(this.box);for(let n=0;n<document.styleSheets.length;n++)"le5le.com/popconfirm"===document.styleSheets[n].title&&(i=document.styleSheets[n]);if(!i){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/popconfirm",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),i=e.sheet,i.insertRule(".meta2d-popconfirm{position:absolute;z-index:999;left: -9999px;top: -9999px;padding:16px;max-width:400px;background:#fff;border-radius:6px;box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);}"),i.insertRule(".meta2d-popconfirm .text{outline:none;padding:0px 0px 40px 28px;border-radius:4px;color:rgba(0, 0, 0, 0.9);overflow-y:auto;line-height:22px;font-size:13px;}"),i.insertRule(".meta2d-popconfirm .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-18px;left:50%;transform:translateX(-50%)}"),i.insertRule(".meta2d-popconfirm .arrow.down{top:initial;bottom: -18px;}"),i.insertRule(".meta2d-popconfirm .icon{position:absolute;width:22px;height:22px;left:16px;top:16px;}"),i.insertRule(".meta2d-popconfirm .confirm{position:absolute;right:16px;bottom:16px;width:40px;height:24px;text-align:center;background:#4582e6;color:#fff;border-radius:3px;border-color:transparent}"),i.insertRule(".meta2d-popconfirm .confirm:hover{background:#003cab;}"),i.insertRule(".meta2d-popconfirm .cancel{position:absolute;right:64px;bottom:16px;width:40px;height:24px;text-align:center;background:#dcdcdc;color:rgba(0, 0, 0, 0.9);border-radius:3px;border-color:transparent}"),i.insertRule(".meta2d-popconfirm .cancel:hover{background:#a6a6a6;}")}}show(e,t){if(!e)return;const i=this.box.getBoundingClientRect(),n=e.calculative.worldRect;let o=e.calculative.canvas.store.data.x+t.x-i.width/2,s=e.calculative.canvas.store.data.y+t.y-i.height-20;e.type||(o=e.calculative.canvas.store.data.x+n.x-(i.width-n.width)/2,s=e.calculative.canvas.store.data.y+n.ey-i.height-n.height),s>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#fff",s-=10):(s+=i.height+n.height+5,s+=10,this.arrowUp.style.borderBottomColor="#fff",this.arrowDown.style.borderTopColor="transparent"),this.x=o,this.y=s,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.x=-9999,this.box.style.left="-9999px"}showModal(e,t,i){return new Promise((n=>{this.text.innerHTML=i||"确认执行操作吗？",this.show(e,t),this.confirm.onclick=()=>{n(!0),this.hide()},this.cancel.onclick=()=>{n(!1),this.hide()}}))}destroy(){this.box=null}}const movingSuffix="-moving";class Canvas{constructor(e,t,i){__publicField(this,"parent"),__publicField(this,"parentElement"),__publicField(this,"store"),__publicField(this,"canvas",document.createElement("canvas")),__publicField(this,"offscreen",createOffscreen()),__publicField(this,"width"),__publicField(this,"height"),__publicField(this,"externalElements",document.createElement("div")),__publicField(this,"clientRect"),__publicField(this,"canvasRect"),__publicField(this,"activeRect"),__publicField(this,"initActiveRect"),__publicField(this,"dragRect"),__publicField(this,"lastRotate",0),__publicField(this,"sizeCPs"),__publicField(this,"activeInitPos"),__publicField(this,"hoverType",HoverType.None),__publicField(this,"resizeIndex",0),__publicField(this,"mouseDown"),__publicField(this,"hotkeyType"),__publicField(this,"mouseRight"),__publicField(this,"addCaches"),__publicField(this,"touchCenter"),__publicField(this,"initTouchDis"),__publicField(this,"initScale"),__publicField(this,"touchScaling"),__publicField(this,"touchMoving"),__publicField(this,"startTouches"),__publicField(this,"lastOffsetX",0),__publicField(this,"lastOffsetY",0),__publicField(this,"drawingLineName"),__publicField(this,"drawLineFns",[...defaultDrawLineFns]),__publicField(this,"drawingLine"),__publicField(this,"pencil"),__publicField(this,"pencilLine"),__publicField(this,"movingPens"),__publicField(this,"patchFlagsLines",new Set),__publicField(this,"dock"),__publicField(this,"prevAnchor"),__publicField(this,"nextAnchor"),__publicField(this,"lastMouseTime",0),__publicField(this,"hoverTimer",0),__publicField(this,"fitTimer",0),__publicField(this,"willInactivePen"),__publicField(this,"patchFlags",!1),__publicField(this,"lastRender",0),__publicField(this,"touchStart",0),__publicField(this,"touchStartTimer"),__publicField(this,"timer"),__publicField(this,"lastAnimateRender",0),__publicField(this,"animateRendering",!1),__publicField(this,"renderTimer"),__publicField(this,"initPens"),__publicField(this,"pointSize",8),__publicField(this,"pasteOffset",!0),__publicField(this,"opening",!1),__publicField(this,"maxZindex",5),__publicField(this,"canMoveLine",!1),__publicField(this,"randomIdObj"),__publicField(this,"keyOptions"),__publicField(this,"beforeAddPen"),__publicField(this,"beforeAddPens"),__publicField(this,"beforeAddAnchor"),__publicField(this,"beforeRemovePens"),__publicField(this,"beforeRemoveAnchor"),__publicField(this,"customResizeDock"),__publicField(this,"customMoveDock"),__publicField(this,"inputParent",document.createElement("div")),__publicField(this,"inputDiv",document.createElement("div")),__publicField(this,"dropdown",document.createElement("ul")),__publicField(this,"tooltip"),__publicField(this,"popconfirm"),__publicField(this,"title"),__publicField(this,"mousePos",{x:0,y:0}),__publicField(this,"scroll"),__publicField(this,"movingAnchor"),__publicField(this,"canvasTemplate"),__publicField(this,"canvasImage"),__publicField(this,"canvasImageBottom"),__publicField(this,"magnifierCanvas"),__publicField(this,"dialog"),__publicField(this,"autoPolylineFlag",!1),__publicField(this,"stopPropagation",(e=>{e.stopPropagation()})),__publicField(this,"curve",curve),__publicField(this,"polyline",polyline),__publicField(this,"mind",mind),__publicField(this,"line",lineSegment),__publicField(this,"onCopy",(e=>{this.store.options.disableClipboard||e.target!==this.externalElements&&e.target!==document.body&&e.target.offsetParent!==this.externalElements||this.copy()})),__publicField(this,"onCut",(e=>{this.store.options.disableClipboard||e.target!==this.externalElements&&e.target!==document.body&&e.target.offsetParent!==this.externalElements||this.cut()})),__publicField(this,"onPaste",(async e=>{if(this.store.data.locked||this.store.options.disableClipboard)return;if(e.target!==this.externalElements&&e.target!==document.body&&e.target.offsetParent!==this.externalElements)return;let t;if(navigator.clipboard&&e.clipboardData){const i=e.clipboardData.items;if(i)for(let e=0;e<i.length;e++)if(-1!==i[e].type.indexOf("image")&&i[e].getAsFile()){t=!0;break}}if(t){const t=e.clipboardData.items;if(t)for(let e=0;e<t.length;e++)if(-1!==t[e].type.indexOf("image")&&t[e].getAsFile()){const{x:i,y:n}=this.mousePos,o=t[e].getAsFile();let s="gif"===t[e].type.slice(6)?"gif":"image";if(null!==o){const e="gif"===s,t=await this.fileToPen(o,e);t.height=t.height/t.width*100,t.width=100,t.x=i-25,t.y=n-t.height/t.width*50,t.externElement=e,this.addPens([t]),this.active([t]),this.copy([t])}}}else this.paste()})),__publicField(this,"onMessage",(e=>{if("string"!=typeof e.data||!e.data||e.data.startsWith("setImmediate")||e.data.startsWith("webpackHotUpdate"))return;let t=JSON.parse(e.data);"object"==typeof t?this.parent.doMessageEvent(t.name,JSON.stringify(t.data)):this.parent.doMessageEvent(t)})),__publicField(this,"onwheel",(e=>{if("true"===this.inputDiv.contentEditable)return;if(this.drawingLine)return;if(this.pencil)return;if(this.store.hover&&this.store.hover.onWheel)return void this.store.hover.onWheel(this.store.hover,e);if(this.store.data.disableScale||this.store.options.disableScale)return;if(e.preventDefault(),e.stopPropagation(),this.mouseDown&&(this.hoverType===HoverType.Node||this.hoverType===HoverType.Line))return;if(this.store.data.locked===LockState.Disable)return;if(this.store.data.locked===LockState.DisableScale)return;if(this.store.data.locked===LockState.DisableMoveScale)return;if(!e.ctrlKey&&Math.abs(e.wheelDelta)<100&&-1===e.deltaY.toString().indexOf(".")){if(this.store.options.scroll&&!e.metaKey&&this.scroll)return void this.scroll.wheel(e.deltaY<0);const t=this.store.data.scale||1;return void this.translate(-e.deltaX/t,-e.deltaY/t)}if(Math.abs(e.wheelDelta)>100&&this.store.options.scroll&&this.scroll&&!this.store.options.scrollButScale&&!e.ctrlKey&&!e.metaKey)return void this.scroll.wheel(e.deltaY<0);if(this.store.options.disableTouchPadScale)return;let t=.015;if(this.store.options.scaleOff)t=this.store.options.scaleOff,e.deltaY>0&&(t=-this.store.options.scaleOff);else{if(/mac os /i.test(navigator.userAgent))e.ctrlKey?e.deltaY>0&&(t*=-1):t*=e.wheelDeltaY/240;else{let i=.2;-1!==e.deltaY.toString().indexOf(".")&&(i=.01),t=e.deltaY>0?-i:i}}let{offsetX:i,offsetY:n}=e;this.scale(this.store.data.scale+t,{x:i,y:n}),this.externalElements.focus()})),__publicField(this,"onkeydown",(e=>{var t,i,n;if(this.store.data.locked>=LockState.DisableEdit&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&!e.target.dataset.meta2dIgnore&&this.store.active.forEach((t=>{var i;null==(i=t.onKeyDown)||i.call(t,t,e.key)})),this.store.data.locked>=LockState.DisableEdit||"INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.dataset.meta2dIgnore)return;if(this.store.options.unavailableKeys.includes(e.key))return;this.keyOptions||(this.keyOptions={}),this.keyOptions.altKey=e.altKey,this.keyOptions.shiftKey=e.shiftKey,this.keyOptions.ctrlKey=e.ctrlKey,this.keyOptions.metaKey=e.metaKey,this.keyOptions.F=!1,"F"!==e.key&&"f"!==e.key||(this.keyOptions.F=!0);let o=10,s=10,r=null;if(this.store.options.strictScope){const e=this.store.data.width||this.store.options.width,t=this.store.data.height||this.store.options.height;e&&t&&(r={x:this.store.data.origin.x,y:this.store.data.origin.y,width:e*this.store.data.scale,height:t*this.store.data.scale})}switch(e.key){case" ":this.hotkeyType=HotkeyType.Translate;break;case"Control":this.drawingLine?this.drawingLine.calculative.drawlineH=!this.drawingLine.calculative.drawlineH:this.hotkeyType||(this.patchFlags=!0,this.hotkeyType=HotkeyType.Select);break;case"Meta":break;case"Shift":1===this.store.active.length&&this.store.active[0].type&&this.store.activeAnchor?this.toggleAnchorHand():this.hotkeyType||(this.patchFlags=!0,this.store.options.resizeMode||(this.hotkeyType=HotkeyType.Resize));break;case"Alt":if(!e.ctrlKey&&!e.shiftKey&&this.drawingLine){const e=getToAnchor(this.drawingLine);e!==this.drawingLine.calculative.activeAnchor?(deleteTempAnchor(this.drawingLine),this.drawingLine.calculative.worldAnchors.push(e)):this.drawingLine.calculative.worldAnchors.push({x:e.x,y:e.y});const t=this.drawLineFns.indexOf(this.drawingLineName);this.drawingLineName=this.drawLineFns[(t+1)%this.drawLineFns.length],this.drawingLine.lineName=this.drawingLineName,this.drawline(),this.patchFlags=!0}e.preventDefault();break;case"a":case"A":e.ctrlKey||e.metaKey?(this.active(this.store.data.pens.filter((e=>!e.parentId&&e.locked!==LockState.Disable))),e.preventDefault()):this.toggleAnchorMode();break;case"Delete":case"Backspace":if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){this.deleteFit();break}!this.store.data.locked&&this.delete();break;case"ArrowLeft":if(this.movingAnchor){this.translateAnchor(-1,0);break}if(o=-1,e.shiftKey&&(o=-5),(e.ctrlKey||e.metaKey)&&(o=-10),o*=this.store.data.scale,this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+o,y:this.store.activeAnchor.y},{});break}r&&this.activeRect.x+o<r.x&&(o=r.x-this.activeRect.x),this.translatePens(this.store.active,o,0);break;case"ArrowUp":if(this.movingAnchor){this.translateAnchor(0,-1);break}if(s=-1,e.shiftKey&&(s=-5),(e.ctrlKey||e.metaKey)&&(s=-10),s*=this.store.data.scale,r&&this.activeRect.y+s<r.y&&(s=r.y-this.activeRect.y),this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+s},{});break}this.translatePens(this.store.active,0,s);break;case"ArrowRight":if(this.movingAnchor){this.translateAnchor(1,0);break}if(o=1,e.shiftKey&&(o=5),(e.ctrlKey||e.metaKey)&&(o=10),o*=this.store.data.scale,this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+o,y:this.store.activeAnchor.y},{});break}r&&this.activeRect.x+this.activeRect.width+o>r.x+r.width&&(o=r.x+r.width-(this.activeRect.x+this.activeRect.width)),this.translatePens(this.store.active,o,0);break;case"ArrowDown":if(this.movingAnchor){this.translateAnchor(0,1);break}if(s=1,e.shiftKey&&(s=5),(e.ctrlKey||e.metaKey)&&(s=10),s*=this.store.data.scale,r&&this.activeRect.y+this.activeRect.height+s>r.y+r.height&&(s=r.y+r.height-(this.activeRect.y+this.activeRect.height)),this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+s},{});break}this.translatePens(this.store.active,0,s);break;case"d":case"D":(null==(t=this.store.active[0])?void 0:t.locked)||this.removeAnchorHand();break;case"h":case"H":(null==(i=this.store.active[0])?void 0:i.locked)||this.addAnchorHand();break;case"m":case"M":this.toggleMagnifier();break;case"g":case"G":if(e.ctrlKey||e.metaKey){e.shiftKey?this.parent.uncombine():this.store.active.length>1&&this.parent.combine(this.store.active),e.preventDefault();break}this.hoverType===HoverType.NodeAnchor&&(this.movingAnchor=this.store.hoverAnchor,this.externalElements.style.cursor="move");break;case"s":case"S":this.store.data.locked||this.hoverType!==HoverType.LineAnchor||this.store.hover!==this.store.active[0]||this.splitLine(this.store.active[0],this.store.hoverAnchor),(e.ctrlKey||e.metaKey)&&this.store.emitter.emit("save",{event:e});break;case"c":case"C":(e.ctrlKey||e.metaKey)&&this.store.options.disableClipboard&&this.copy();break;case"x":case"X":(e.ctrlKey||e.metaKey)&&this.store.options.disableClipboard&&this.cut();break;case"√":case"v":case"V":e.ctrlKey||e.metaKey||(this.pencil&&this.stopPencil(),this.drawingLineName?(this.finishDrawline(),this.drawingLineName=""):this.drawingLineName=this.store.options.drawingLineName),!this.store.data.locked&&(e.ctrlKey||e.metaKey)&&(this.store.options.disableClipboard||!this.store.options.disableClipboard&&e.altKey)&&this.paste();break;case"b":case"B":this.drawingLineName&&(this.finishDrawline(),this.drawingLineName=""),this.pencil?this.stopPencil():this.drawingPencil();break;case"y":case"Y":(e.ctrlKey||e.metaKey)&&this.redo();break;case"z":case"Z":e.ctrlKey||e.metaKey?this.undo():e.shiftKey&&this.redo();break;case"Enter":this.drawingLineName&&(this.finishDrawline(!0),this.store.active[0].anchors[0].connectTo?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName),this.store.active&&(this.store.active.forEach((e=>{e.type?(e.close=!e.close,e.close&&getLinePoints(e),this.store.path2dMap.set(e,globalStore.path2dDraws.line(e)),getLineLength(e)):e.calculative.focus=!0})),this.render());break;case"Escape":this.drawingLineName&&this.finishDrawline(),this.drawingLineName=void 0,this.stopPencil(),this.store.active&&this.store.active.forEach((e=>{e.type||(e.calculative.focus=!1)})),this.movingPens&&(this.getAllByPens(this.movingPens).forEach((e=>{this.store.pens[e.id]=void 0})),this.movingPens=void 0,this.mouseDown=void 0,this.clearDock(),null==(n=this.store.active)||n.forEach((e=>{this.updateLines(e)})),this.calcActiveRect(),this.patchFlags=!0),this.hotkeyType=HotkeyType.None,this.movingAnchor=void 0,this.magnifierCanvas.magnifier&&(this.magnifierCanvas.magnifier=!1,this.patchFlags=!0);break;case"E":case"e":this.store.options.disableAnchor=!this.store.options.disableAnchor,this.store.emitter.emit("disableAnchor",this.store.options.disableAnchor);break;case"=":(e.ctrlKey||e.metaKey)&&(this.scale(this.store.data.scale+.1),e.preventDefault(),e.stopPropagation());break;case"-":(e.ctrlKey||e.metaKey)&&(this.scale(this.store.data.scale-.1),e.preventDefault(),e.stopPropagation());break;case"l":case"L":this.canMoveLine=!0;break;case"[":this.parent.down();break;case"]":this.parent.up();break;case"{":this.parent.bottom();break;case"}":this.parent.top();break;case"F":case"f":this.store.data.locked||!e.ctrlKey&&!e.metaKey||this.store.options.disableClipboard||this.paste(),this.setFollowers()}this.render(!1)})),__publicField(this,"onkeyup",(e=>{switch(e.key){case"l":case"L":this.canMoveLine=!1}this.hotkeyType&&this.render(),this.hotkeyType<HotkeyType.AddAnchor&&(this.hotkeyType=HotkeyType.None)})),__publicField(this,"ondrop",(async e=>{if(this.store.data.locked)return;e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.getData("Meta2d")||e.dataTransfer.getData("Text");let i=null;try{t&&(i=JSON.parse(t))}catch(n){}if(!i){const{files:t}=e.dataTransfer;if(!t.length||!t[0].type.match("image.*")||this.addCaches&&this.addCaches.length){if(!this.addCaches||!this.addCaches.length)return void this.store.emitter.emit("drop",void 0);i=this.addCaches,this.addCaches=[]}else{const e="image/gif"===t[0].type;i=await this.fileToPen(t[0],e)}}if(i=Array.isArray(i)?i:[i],i[0]&&!1!==i[0].draggable){const t={x:e.offsetX,y:e.offsetY};this.calibrateMouse(t),this.dropPens(i,t),this.addCaches=[],this.getContainerHover(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hoverContainer})}this.store.emitter.emit("drop",i||t)})),__publicField(this,"ontouchstart",(e=>{this.store.data.locked!==LockState.Disable&&(this.touchStartTimer&&clearTimeout(this.touchStartTimer),this.touchStartTimer=setTimeout((()=>{this.touchStart=performance.now();const t=e.touches[0].pageX-this.clientRect.x,i=e.touches[0].pageY-this.clientRect.y,n={x:t,y:i};if(this.calibrateMouse(n),this.getHover(n),this.onMouseDown({x:t,y:i,clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,pageX:e.touches[0].pageX,pageY:e.touches[0].pageY,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey,buttons:1}),2===e.touches.length)return this.initTouchDis=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY),this.initScale=this.store.data.scale,this.startTouches=e.touches,void(this.touchCenter={x:e.touches[0].pageX+(e.touches[1].pageX-e.touches[0].pageX)/2-this.clientRect.x,y:e.touches[0].pageY+(e.touches[1].pageY-e.touches[0].pageY)/2-this.clientRect.y});3===e.touches.length&&(this.store.emitter.emit("contextmenu",{e:{x:t,y:i,clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,pageX:e.touches[0].pageX,pageY:e.touches[0].pageY},clientRect:this.clientRect}),e.preventDefault(),e.stopPropagation()),this.touchStartTimer=void 0}),50))})),__publicField(this,"ontouchmove",(e=>{var t;if(this.store.data.locked===LockState.Disable)return;e.stopPropagation(),e.preventDefault();const i=performance.now();if(i-this.touchStart<50)return;this.touchStart=i;const n=e.touches,o=n.length,s=e.touches[0].pageX-this.clientRect.x,r=e.touches[0].pageY-this.clientRect.y;if(1===o)this.onMouseMove({x:s,y:r,clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY,pageX:e.changedTouches[0].pageX,pageY:e.changedTouches[0].pageY,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey,buttons:1});else if(2===o&&2===(null==(t=this.startTouches)?void 0:t.length)){if(!this.touchMoving&&!this.touchScaling){const e=this.startTouches[0].pageX-n[0].pageX,t=this.startTouches[1].pageX-n[1].pageX,i=this.startTouches[0].pageY-n[0].pageY,o=this.startTouches[1].pageY-n[1].pageY;(e>=0&&t<0||e<=0&&t>0)&&(i>=0&&o<0||i<=0&&o>0)?this.touchScaling=!0:this.touchMoving=!0}if(this.touchScaling){if(this.store.data.disableScale||this.store.options.disableScale)return;const e=Math.hypot(n[0].pageX-n[1].pageX,n[0].pageY-n[1].pageY)/this.initTouchDis;this.scale(this.initScale*e,deepClone(this.touchCenter))}if(this.touchMoving){if(this.store.data.locked>=LockState.DisableMove&&this.store.data.locked!==LockState.DisableScale||this.store.data.disableScale||this.store.options.disableScale)return;if(this.lastOffsetX){const{scale:e}=this.store.data;this.translate((s-this.lastOffsetX)/e,(r-this.lastOffsetY)/e)}this.lastOffsetX=s,this.lastOffsetY=r}}})),__publicField(this,"ontouchend",(e=>{if(this.store.data.locked===LockState.Disable)return;this.touchCenter=void 0,this.touchScaling=void 0,this.touchMoving=void 0,this.startTouches=void 0,this.lastOffsetX=0,this.lastOffsetY=0;const t=e.changedTouches[0].pageX-this.clientRect.x,i=e.changedTouches[0].pageY-this.clientRect.y;this.onMouseUp({x:t,y:i,clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY,pageX:e.changedTouches[0].pageX,pageY:e.changedTouches[0].pageY,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey,buttons:1}),setTimeout((()=>{this.render()}),20)})),__publicField(this,"onGesturestart",(e=>{e.preventDefault()})),__publicField(this,"onMouseDown",(e=>{var t,i,n,o,s;if(2!==e.buttons||this.drawingLine||(this.mouseRight=MouseRight.Down),this.hideInput(),this.popconfirm.hide(),this.store.data.locked===LockState.Disable||1!==e.buttons&&2!==e.buttons)this.hoverType=HoverType.None;else if(!this.magnifierCanvas.magnifier)if(this.calibrateMouse(e),this.mousePos.x=e.x,this.mousePos.y=e.y,this.mouseDown=e,this.lastMouseTime=performance.now(),this.canvasImage.fitFlag)this.canvasImage.currentFit||this.calcuActiveFit();else if(this.hotkeyType!==HotkeyType.AddAnchor){if(!this.store.options.autoAnchor&&!this.drawingLine&&e.shiftKey&&e.ctrlKey&&e.altKey){this.setAnchor(this.store.pointAt),this.drawingLineName=this.store.options.drawingLineName;const e=this.store.activeAnchor;if(!e)return;const t={id:s8(),x:e.x,y:e.y};this.drawingLine=this.createDrawingLine(t);let i=getFromAnchor(this.drawingLine);return this.drawingLine.calculative.activeAnchor=i,connectLine(this.store.hover,e,this.drawingLine,t),void this.drawline()}if(this.hotkeyType!==HotkeyType.Translate&&(this.mouseRight!==MouseRight.Down||this.store.options.mouseRightActive)){if(this.drawingLine){if(this.store.hoverAnchor){const e=getToAnchor(this.drawingLine);return this.store.hoverAnchor.type===PointType.Line?getDistance(e,this.store.hoverAnchor,this.store):(e.x=this.store.hoverAnchor.x,e.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,e),this.drawline(),void this.finishDrawline(!0)}if(!this.store.options.autoAnchor&&e.shiftKey&&e.altKey&&e.ctrlKey){this.setAnchor(this.store.pointAt);const e=getToAnchor(this.drawingLine),t=this.store.activeAnchor;if(!t)return;return e.x=t.x,e.y=t.y,connectLine(this.store.hover,t,this.drawingLine,e),this.drawline(),void this.finishDrawline(!0)}if(2===e.buttons||"mind"===this.drawingLineName&&(null==(t=this.drawingLine)?void 0:t.calculative.worldAnchors.length)>1||this.store.options.drawingLineLength&&(null==(i=this.drawingLine)?void 0:i.calculative.worldAnchors.length)>this.store.options.drawingLineLength)return this.finishDrawline(!0),void((null==(n=this.store.active[0])?void 0:n.anchors[0].connectTo)||0==this.store.active.length?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName);if(this.store.options.autoAnchor&&this.hoverType===HoverType.Node){const t=getToAnchor(this.drawingLine),i=nearestAnchor(this.store.hover,e);return t.x=i.x,t.y=i.y,this.drawingLine.autoTo=!0,connectLine(this.store.hover,i,this.drawingLine,t),this.drawline(),void this.finishDrawline(!0)}const o=getToAnchor(this.drawingLine);o.isTemp?(this.drawingLine.calculative.activeAnchor=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2],o.isTemp=void 0):(this.drawingLine.calculative.activeAnchor=o,this.drawingLine.calculative.worldAnchors.push({x:o.x,y:o.y,penId:o.penId})),this.drawingLine.calculative.drawlineH=void 0,"polyline"!==this.drawingLineName&&this.drawline()}if(this.drawingLineName){if(this.hoverType===HoverType.Node)if(this.store.options.autoAnchor){this.inactive(!0);const t=nearestAnchor(this.store.hover,e);this.store.hoverAnchor=t;const i={id:s8(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(i),this.drawingLine.autoFrom=!0,connectLine(this.store.hover,t,this.drawingLine,i)}else this.inactive(),this.hoverType=HoverType.None;else if(this.hoverType===HoverType.NodeAnchor){this.drawingLineName=this.store.options.drawingLineName;const e={id:s8(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};this.drawingLine=this.createDrawingLine(e),this.drawingLine.calculative.activeAnchor=e,connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,e)}else if(!this.drawingLine&&"curve"!==this.drawingLineName){this.inactive(!0);const t={id:s8(),x:e.x,y:e.y};this.drawingLine=this.createDrawingLine(t),this.drawingLine.calculative.activeAnchor=t}}else if(this.pencil){this.inactive(!0);const t=s8(),i={x:e.x,y:e.y,id:s8(),penId:t};this.pencilLine=this.getInitPencilLine(i)}else{switch(this.hoverType){case HoverType.None:(this.store.data.rule||this.store.options.rule)&&!this.store.options.disableRuleLine&&this.addRuleLine(e),this.store.options.resizeMode&&(this.hotkeyType=HotkeyType.None),this.inactive();break;case HoverType.Node:case HoverType.Line:if(this.store.hover){if((null==(o=this.store.active)?void 0:o.length)&&1===this.store.active.length&&this.store.hover.id===this.store.active[0].id){this.calcActiveRect();break}const t=getParent(this.store.hover,!0);let i=t||this.store.hover;t&&(t.container||(null==(s=this.store.options.containerShapes)?void 0:s.includes(t.name)))&&(i=this.store.hover),e.ctrlKey&&!e.shiftKey?(i.calculative.active?this.willInactivePen=i:this.store.active.length>0&&(i.calculative.active=!0,setChildrenActive(i),this.store.active.push(i),this.store.emitter.emit("active",this.store.active)),this.patchFlags=!0):e.ctrlKey&&e.shiftKey&&this.store.hover.parentId?this.active([this.store.hover]):this.activeRect&&pointInRect({x:e.x,y:e.y},this.activeRect)&&1!=this.store.active.length||i.calculative.active||(this.active([i]),this.store.options.resizeMode&&(this.hotkeyType=HotkeyType.Resize)),this.calcActiveRect()}break;case HoverType.LineAnchor:this.store.activeAnchor=this.store.hoverAnchor,this.store.hover.calculative.activeAnchor=this.store.hoverAnchor,this.active([this.store.hover]);break;case HoverType.LineAnchorPrev:case HoverType.LineAnchorNext:this.store.activeAnchor&&(this.prevAnchor={...this.store.activeAnchor.prev},this.nextAnchor={...this.store.activeAnchor.next});break;case HoverType.Resize:this.activeInitPos=[],this.store.active.forEach((e=>{this.activeInitPos.push({x:(e.calculative.worldRect.x-this.activeRect.x)/this.activeRect.width,y:(e.calculative.worldRect.y-this.activeRect.y)/this.activeRect.height})}))}this.store.hover&&(this.store.hover.calculative.mouseDown=!0),this.store.emitter.emit("mousedown",{x:e.x,y:e.y,pen:this.store.hover})}this.render()}}else this.setAnchor(this.store.pointAt)})),__publicField(this,"onMouseMove",(e=>{var t,i,n,o,s,r,a,l;if(this.store.data.locked===LockState.Disable)return void(this.hoverType=HoverType.None);if(this.mouseDown&&!this.mouseDown.restore&&1!==e.buttons&&2!==e.buttons)return void this.onMouseUp(e);if(this.lastMouseTime){if(performance.now()-this.lastMouseTime<50)return void(this.lastMouseTime=0);this.lastMouseTime=0}if(this.calibrateMouse(e),this.mousePos.x=e.x,this.mousePos.y=e.y,this.magnifierCanvas.magnifier)return void this.render();if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){const t=performance.now();return void(t-this.fitTimer>100&&(this.mouseDown?this.updateFit(e):this.inFitBorder(this.mousePos),this.fitTimer=t))}if(this.mouseDown&&!this.store.options.disableTranslate&&!this.store.data.disableTranslate){if(this.mouseRight===MouseRight.Down&&(this.mouseRight=MouseRight.Translate),this.store.data.locked===LockState.DisableEdit||this.store.data.locked===LockState.DisableScale||this.hotkeyType===HotkeyType.Translate||this.mouseRight===MouseRight.Translate){const{scale:t}=this.store.data;let i=(e.x-this.mouseDown.x)/t,n=(e.y-this.mouseDown.y)/t;return e.shiftKey&&!e.ctrlKey&&(n=0),e.ctrlKey&&(i=0),void this.translate(i,n)}if(this.store.data.locked)return;if(this.drawingLine||this.pencil){if(this.pencil){const{x:t,y:i}=e,n={x:t,y:i};n.id=s8(),n.penId=this.pencilLine.id,this.pencilLine.calculative.worldAnchors.push(n),this.store.path2dMap.set(this.pencilLine,globalStore.path2dDraws[this.pencilLine.name](this.pencilLine)),this.patchFlags=!0}}else{if(this.drawingLineName||this.movingAnchor){if(this.drawingLineName&&this.hoverType===HoverType.None){const t={id:s8(),x:e.x,y:e.y};return this.drawingLine=this.createDrawingLine(t),this.drawingLine.calculative.activeAnchor=t,void this.drawline()}}else if(this.hoverType===HoverType.NodeAnchor){if(!this.store.hoverAnchor)return;this.drawingLineName=this.store.options.drawingLineName;const e={id:s8(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};return this.drawingLine=this.createDrawingLine(e),this.drawingLine.calculative.activeAnchor=e,connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,e),void this.drawline()}if(1===e.buttons&&(e.ctrlKey||!this.hoverType&&!this.hotkeyType)&&(!e.ctrlKey||!this.store.activeAnchor&&!(null==(t=this.store.active)?void 0:t.length)))return this.dragRect={x:Math.min(this.mouseDown.x,e.x),y:Math.min(this.mouseDown.y,e.y),ex:Math.max(this.mouseDown.x,e.x),ey:Math.max(this.mouseDown.y,e.y),width:Math.abs(e.x-this.mouseDown.x),height:Math.abs(e.y-this.mouseDown.y)},void this.render();if(this.movingAnchor){const t=e.x-this.movingAnchor.x,i=e.y-this.movingAnchor.y;return this.translateAnchor(t,i),void this.render()}if(!(null==(i=this.store.active[0])?void 0:i.locked)){const t={x:e.x,y:e.y};if(this.hoverType===HoverType.LineAnchor)return!this.dockInAnchor(e)&&"line"!==(null==(n=this.store.active[0])?void 0:n.lineName)||this.store.options.disableDock||this.store.options.disableLineDock||(this.clearDock(),this.dock=calcAnchorDock(this.store,t,this.store.activeAnchor),(null==(o=this.dock)?void 0:o.xDock)&&(t.x+=this.dock.xDock.step),(null==(s=this.dock)?void 0:s.yDock)&&(t.y+=this.dock.yDock.step)),void this.moveLineAnchor(t,e);if(this.hoverType===HoverType.LineAnchorPrev)return void this.moveLineAnchorPrev(e);if(this.hoverType===HoverType.LineAnchorNext)return void this.moveLineAnchorNext(e)}if(this.hoverType===HoverType.Rotate)return void this.rotatePens({x:e.x,y:e.y});if(this.hoverType===HoverType.Resize)return void this.resizePens(e);if(this.hoverType===HoverType.Node||this.hoverType===HoverType.Line){const t=e.x-this.mouseDown.x,i=e.y-this.mouseDown.y,n=20;if(e.ctrlKey&&!e.shiftKey&&(Math.abs(t)>=n||Math.abs(i)>=n)&&(this.willInactivePen=void 0),1===this.store.active.length){const e=this.store.active[0];if((void 0===e.locked||e.locked<LockState.DisableMove)&&(null==(r=null==e?void 0:e.onMouseMove)||r.call(e,e,this.mousePos)),e.calculative.focus)return}return this.movePens(e),void this.getContainerHover(e)}}}if(this.drawingLine){const{x:t,y:i}=e,n={x:t,y:i};if(n.id=s8(),n.penId=this.drawingLine.id,this.store.options.disableDock||this.store.options.disableLineDock||(this.clearDock(),this.dock=calcAnchorDock(this.store,n),(null==(a=this.dock)?void 0:a.xDock)&&(n.x+=this.dock.xDock.step),(null==(l=this.dock)?void 0:l.yDock)&&(n.y+=this.dock.yDock.step)),this.mouseDown&&"curve"===this.drawingLineName&&!this.drawingLine.calculative.worldAnchors[0].connectTo)this.drawline(n);else{let t;if(this.drawingLine.calculative.worldAnchors.length>1&&(t=getToAnchor(this.drawingLine)),t?(t.prev=void 0,t.next=void 0,t.id||(t.id=s8()),t.x=n.x,t.y=n.y,t.connectTo=void 0):(t={...n},this.drawingLine.calculative.worldAnchors.push(t)),this.hoverType!==HoverType.NodeAnchor&&this.hoverType!==HoverType.LineAnchor||(this.store.hoverAnchor.type!==PointType.Line&&(t.x=this.store.hoverAnchor.x,t.y=this.store.hoverAnchor.y),t.connectTo=this.store.hoverAnchor.penId,"polyline"===this.drawingLineName&&(t.isTemp=!1)),"line"===this.drawingLineName)if(e.ctrlKey&&!e.shiftKey)t.x=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].x;else if(e.shiftKey&&!e.ctrlKey)t.y=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].y;else if(e.shiftKey&&e.ctrlKey){let e=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2];this.getSpecialAngle(t,e)}this.drawline()}}globalThis.debug;const c=performance.now();c-this.hoverTimer>50&&(this.hoverTimer=c,this.getHover(e)),globalThis.debug,this.hotkeyType===HotkeyType.AddAnchor&&(this.patchFlags=!0),this.render(!1)})),__publicField(this,"onMouseUp",(e=>{if(this.store.data.locked!==LockState.Disable){if(this.mouseDown){if(this.mouseRight===MouseRight.Down&&(this.store.hover&&this.store.hover.onContextmenu?this.store.hover.onContextmenu(this.store.hover,e):this.store.emitter.emit("contextmenu",{e:e,clientRect:this.clientRect,pen:this.store.hover})),this.mouseRight=MouseRight.None,this.calibrateMouse(e),this.mousePos.x=e.x,this.mousePos.y=e.y,this.pencil&&this.finishPencil(),this.drawingLine){if(this.store.hoverAnchor){const e=getToAnchor(this.drawingLine);return this.store.hoverAnchor.type===PointType.Line?getDistance(e,this.store.hoverAnchor,this.store):(e.x=this.store.hoverAnchor.x,e.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,e),this.drawline(),void this.finishDrawline(!0)}if(this.store.options.autoAnchor&&this.hoverType===HoverType.Node){const t=getToAnchor(this.drawingLine),i=nearestAnchor(this.store.hover,e);return t.x=i.x,t.y=i.y,this.drawingLine.autoTo=!0,connectLine(this.store.hover,i,this.drawingLine,t),this.drawline(),void this.finishDrawline(!0)}}if(this.hoverType===HoverType.LineAnchor&&this.store.hover&&this.store.active[0]&&"line"===this.store.active[0].name&&this.store.active[0]!==this.store.hover){const t=this.store.active[0],i=getFromAnchor(t),n=getToAnchor(t);if(this.store.hoverAnchor){const o=this.store.hover,s=getFromAnchor(o)===this.store.hoverAnchor,r=getToAnchor(o)===this.store.hoverAnchor,a=i===this.store.activeAnchor,l=n===this.store.activeAnchor;if((e.ctrlKey||e.altKey)&&o.type===PenType.Line&&(s||r)&&(a||l)){const e=o.calculative.worldAnchors.map((e=>({...e,penId:t.id})));s?e.shift():r&&e.pop(),(s&&a||r&&l)&&e.reverse(),a?(t.calculative.worldAnchors[0].connectTo=void 0,t.calculative.worldAnchors.unshift(...e)):l&&(t.calculative.worldAnchors[t.calculative.worldAnchors.length-1].connectTo=void 0,t.calculative.worldAnchors.push(...e)),this.delete([o]),this.render()}else this.store.activeAnchor&&(this.store.hoverAnchor.type===PointType.Line?getDistance(this.store.activeAnchor,this.store.hoverAnchor,this.store):(this.store.activeAnchor.x=this.store.hoverAnchor.x,this.store.activeAnchor.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,t,this.store.activeAnchor));this[t.lineName]&&"polyline"!==t.lineName&&this[t.lineName](this.store,t),this.store.path2dMap.set(t,globalStore.path2dDraws.line(t)),this.initLineRect(t)}else i===this.store.activeAnchor&&t.autoFrom?this.calcAutoAnchor(t,i,this.store.hover):n===this.store.activeAnchor&&t.autoTo&&this.calcAutoAnchor(t,n,this.store.hover)}if(this.addCaches&&this.addCaches.length){if(!this.store.data.locked){if(this.dragRect&&1===this.addCaches.length){const t=this.addCaches[0];t.width=this.dragRect.width/this.store.data.scale,t.height=this.dragRect.height/this.store.data.scale,e.x=(this.dragRect.x+this.dragRect.ex)/2,e.y=(this.dragRect.y+this.dragRect.ey)/2}this.dropPens(this.addCaches,e)}this.addCaches=void 0}if(this.hoverType===HoverType.Rotate&&(this.getSizeCPs(),this.store.active.forEach((e=>{e.rotate=e.calculative.rotate}))),this.patchFlagsLines.forEach((e=>{e.type&&this.initLineRect(e)})),this.patchFlagsLines.clear(),this.dragRect)if(this.canvasImage.fitFlag)this.makeFit();else{const t=this.store.data.pens.filter((t=>!(!1===t.visible||t.locked>=LockState.DisableMove||t.parentId||t.isRuleLine)&&(rectInRect(t.calculative.worldRect,this.dragRect,e.ctrlKey||this.store.options.dragAllIn)?!(t.type===PenType.Line&&!this.store.options.dragAllIn)||lineInRect(t,this.dragRect):void 0)));this.active(t)}if(2!==e.button&&(distance(this.mouseDown,e)<2&&(this.store.hover&&this.store.hover.input&&(this.store.hover.onShowInput?this.store.hover.onShowInput(this.store.hover,e):this.showInput(this.store.hover)),this.store.emitter.emit("click",{x:e.x,y:e.y,pen:this.store.hover})),this.store.hover&&(this.store.hover.calculative.mouseDown=!1),this.store.hover!=this.store.hoverContainer&&this.store.emitter.emit("mouseup",{x:e.x,y:e.y,pen:this.store.hover}),this.store.emitter.emit("mouseup",{x:e.x,y:e.y,pen:this.store.hoverContainer})),this.willInactivePen){this.willInactivePen.calculative.active=void 0,setChildrenActive(this.willInactivePen,!1);const e=this.store.active.findIndex((e=>e===this.willInactivePen));e>=0&&this.store.active.splice(e,1),this.calcActiveRect(),this.willInactivePen=void 0,this.store.emitter.emit("inactive",[this.willInactivePen]),this.render()}this.movingPens&&(e.altKey&&!e.shiftKey?this.copyMovedPens():this.movedActivePens(e.ctrlKey&&e.shiftKey),this.getAllByPens(this.movingPens).forEach((e=>{this.store.pens[e.id]=void 0})),this.movingPens=void 0),this.store.active&&this.store.active[0]&&(this.store.active[0].calculative.h=void 0),this.mouseDown=void 0,this.lastOffsetX=0,this.lastOffsetY=0,this.clearDock(),this.dragRect=void 0,this.initActiveRect=void 0,this.render()}}else this.hoverType=HoverType.None})),__publicField(this,"clearDock",(()=>{var e,t,i,n;const o=null==(t=null==(e=this.dock)?void 0:e.xDock)?void 0:t.penId,s=null==(n=null==(i=this.dock)?void 0:i.yDock)?void 0:n.penId,r=this.store.pens[o];r&&(r.calculative.isDock=!1);const a=this.store.pens[s];a&&(a.calculative.isDock=!1),this.dock=void 0})),__publicField(this,"onResize",(()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.resize(),this.timer=void 0}),100)})),__publicField(this,"onScroll",(()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.clientRect=this.canvas.getBoundingClientRect(),this.timer=void 0}),100)})),__publicField(this,"calibrateMouse",(e=>(e.x-=this.store.data.x,e.y-=this.store.data.y,e))),__publicField(this,"getContainerHover",(e=>{var t;if(this.dragRect)return;this.store.hoverContainer=void 0;const i=this.store.data.pens.filter((e=>{var t;return e.container||(null==(t=this.store.options.containerShapes)?void 0:t.includes(e.name))}));if(i.length)for(let n=i.length-1;n>=0;--n){const o=i[n];if(0!=o.visible&&0!=o.calculative.inView&&o.locked!==LockState.Disable)if(pointInRect(e,o.calculative.worldRect))this.store.hoverContainer=o,null==(t=null==o?void 0:o.onMouseMove)||t.call(o,o,e),this.store.lastHoverContainer!==this.store.hoverContainer&&(this.patchFlags=!0,this.store.lastHoverContainer&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.hoverContainer&&(this.store.hoverContainer.calculative.containerHover=!0,this.store.emitter.emit("enter",this.store.hoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer);else if(o===this.store.hoverContainer&&(this.store.hoverContainer=void 0,this.store.lastHoverContainer!==this.store.hoverContainer)){this.patchFlags=!0;const e=this.store.lastHoverContainer.calculative.canvas.store.pens[this.store.lastHoverContainer.id+movingSuffix];this.store.lastHoverContainer&&!e&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer}}})),__publicField(this,"getHover",(e=>{var t,i;if(this.dragRect)return;if(this.canvasImage.fitFlag)return;let n=HoverType.None;this.store.hover=void 0,this.store.hoverAnchor=void 0,this.title.hide(),this.store.pointAt=void 0,this.store.pointAtIndex=void 0;const o=1===this.store.active.length&&this.store.active[0].type;if(!this.drawingLineName&&this.hotkeyType!==HotkeyType.AddAnchor&&this.activeRect&&!o&&!this.store.data.locked){const t=getPensLock(this.store.active),i=getPensDisableRotate(this.store.active)||this.store.options.disableRotate,o=getPensDisableResize(this.store.active)||this.store.options.disableSize;if(!t&&!i){const t={x:this.activeRect.center.x,y:this.activeRect.y-30};this.activeRect.rotate&&rotatePoint(t,this.activeRect.rotate,this.activeRect.pivot||this.activeRect.center),!this.hotkeyType&&hitPoint(e,t,this.pointSize)&&(n=HoverType.Rotate,this.externalElements.style.cursor=`url("${this.store.options.rotateCursor}"), auto`)}if(!t&&!o)for(let s=0;s<8;s++){const t=s<4;if((this.hotkeyType===HotkeyType.Resize||t&&!this.hotkeyType)&&hitPoint(e,this.sizeCPs[s],this.pointSize)){let e=t?defaultCursors:rotatedCursors,i=0;Math.abs(this.activeRect.rotate%90-45)<25?(e=t?rotatedCursors:defaultCursors,i=Math.round((this.activeRect.rotate-45)/90)+(t?0:1)):i=Math.round(this.activeRect.rotate/90),n=HoverType.Resize,this.resizeIndex=s,this.externalElements.style.cursor=e[(s+i)%4];break}}}n===HoverType.None&&(n=this.inPens(e,this.store.data.pens)),n||o||!pointInRect(e,this.activeRect)||(n=HoverType.Node,this.externalElements.style.cursor="move"),this.hoverType=n,n===HoverType.None&&(this.drawingLineName||this.pencil?this.externalElements.style.cursor="crosshair":this.mouseDown||(this.externalElements.style.cursor="default"),this.store.hover=void 0),this.store.lastHover!==this.store.hover&&(this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1,setHover(getParent(this.store.lastHover,!0)||this.store.lastHover,!1),this.store.emitter.emit("leave",this.store.lastHover),this.tooltip.hide()),this.store.hover&&(this.store.hover.calculative.hover=!0,setHover(getParent(this.store.hover,!0)||this.store.hover),this.store.emitter.emit("enter",this.store.hover),this.tooltip.show(this.store.hover,e)),this.store.lastHover=this.store.hover),null==(i=null==(t=this.store.hover)?void 0:t.onMouseMove)||i.call(t,this.store.hover,this.mousePos)})),__publicField(this,"inPens",((e,t)=>{var i;let n=HoverType.None;e:for(let o=t.length-1;o>=0;--o){const s=t[o];if(0==s.visible||0==s.calculative.inView||s.locked===LockState.Disable)continue;const r=getLineR(s);if(s.calculative.active||pointInSimpleRect(e,s.calculative.worldRect,r)||pointInRect(e,s.calculative.worldRect)){if(!this.store.data.locked&&this.hotkeyType!==HotkeyType.Resize&&s.calculative.worldAnchors)for(const t of s.calculative.worldAnchors)if(n=this.inAnchor(e,s,t),n){let i=deepClone(t);Object.assign(i,e),this.title.show(i,s);break e}if(s.type){if(s.isRuleLine){let t=(null==(i=this.store.options.ruleOptions)?void 0:i.height)||20;if(e.x+this.store.data.x>t&&e.y+this.store.data.y>t)break}const t=pointInLine(e,s);if(t){this.store.data.locked||s.locked?this.externalElements.style.cursor=this.store.options.hoverCursor:this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move",s.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=s,this.store.pointAt=t.point,this.store.pointAtIndex=t.i,this.initTemplateCanvas([this.store.hover]),n=HoverType.Line;break}}else{if(s.children){const t=[];if(s.children.forEach((e=>{this.store.pens[e]&&t.push(this.store.pens[e])})),n=this.inPens(e,t),n)break}let t=!1;if(t="line"===s.name?pointInSimpleRect(e,s.calculative.worldRect,s.lineWidth):pointInRect(e,s.calculative.worldRect),t){if(s.type===PenType.Node&&"line"===s.name){if(!pointInPolygon(e,s.calculative.worldAnchors))continue}if(this.store.data.locked||s.locked?this.externalElements.style.cursor=this.store.options.hoverCursor:this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move",s.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=s,this.initTemplateCanvas([this.store.hover]),n=HoverType.Node,this.store.pointAt=e,!e.ctrlKey){let{x:t,y:i,ex:n,ey:o,rotate:s,center:r}=this.store.hover.calculative.worldRect;if(s){const a=[{x:t,y:i},{x:n,y:i},{x:n,y:o},{x:t,y:o}];a.forEach((e=>{rotatePoint(e,s,r)}));let l=a[a.length-1];for(const t of a){if(l.y>e.y!=t.y>e.y){const i=t.x+(e.y-t.y)*(l.x-t.x)/(l.y-t.y);Math.abs(i-this.store.pointAt.x)<10&&(this.store.pointAt.x=i)}l=t}}else this.store.pointAt.x-10<t?this.store.pointAt.x=t:this.store.pointAt.x+10>n&&(this.store.pointAt.x=n),this.store.pointAt.y-10<i?this.store.pointAt.y=i:this.store.pointAt.y+10>o&&(this.store.pointAt.y=o)}break}}}}return n})),__publicField(this,"dockInAnchor",(e=>{var t,i;this.store.hover=void 0;for(let n=this.store.data.pens.length-1;n>=0;--n){const o=this.store.data.pens[n];if(0==o.visible||o.locked===LockState.Disable||o===this.store.active[0])continue;let s=getLineR(o);if(s+=2*this.store.options.anchorRadius,pointInSimpleRect(e,o.calculative.worldRect,s)&&(this.store.hover=o,this.hotkeyType!==HotkeyType.Resize&&o.calculative.worldAnchors))for(const n of o.calculative.worldAnchors){if(n.twoWay===TwoWay.In){const e=getToAnchor(this.store.active[0]);if(this.store.activeAnchor.id!==e.id)continue}if(n.twoWay===TwoWay.Out){const e=getFromAnchor(this.store.active[0]);if(this.store.activeAnchor.id!==e.id)continue}if(n.twoWay!==TwoWay.DisableConnected&&n.twoWay!==TwoWay.Disable&&(null==(t=this.store.activeAnchor)?void 0:t.twoWay)!==TwoWay.DisableConnectTo&&(null==(i=this.store.activeAnchor)?void 0:i.twoWay)!==TwoWay.Disable&&(this.title.hide(),this.inAnchor(e,o,n))){let t=deepClone(n);return Object.assign(t,e),this.title.show(t,o),!0}}}})),__publicField(this,"imageTimer"),__publicField(this,"templateImageTimer"),__publicField(this,"render",(e=>{if(e&&(this.opening=!1),this.opening)return;let t;if(null==e||!0===e||e===1/0?(t=performance.now(),this.patchFlags=!0):t=e>1?e:performance.now(),!this.patchFlags)return;if(t-this.lastRender<this.store.options.interval)return this.renderTimer&&cancelAnimationFrame(this.renderTimer),void(this.renderTimer=requestAnimationFrame(this.render));this.renderTimer=void 0,this.lastRender=t;const i=this.offscreen.getContext("2d");i.clearRect(0,0,this.offscreen.width,this.offscreen.height),i.save(),i.translate(this.store.data.x,this.store.data.y),globalThis.debugRender,this.renderPens(),globalThis.debugRender,this.renderBorder(),this.renderHoverPoint(),i.restore(),this.magnifierCanvas.magnifier&&this.magnifierCanvas.render();const n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height),n.drawImage(this.offscreen,0,0,this.width,this.height),this.canvasTemplate.render(),this.canvasImageBottom.render(),this.canvasImage.render(),this.patchFlags=!1})),__publicField(this,"renderPens",(()=>{const e=this.offscreen.getContext("2d");e.strokeStyle=this.store.styles.color;for(const t of this.store.data.pens)isFinite(t.x)&&t.canvasLayer!==CanvasLayer.CanvasTemplate&&("combine"!==t.name||t.draw)&&t.calculative.inView&&(t.canvasLayer===CanvasLayer.CanvasMain&&"gif"!==t.name&&t.image&&t.calculative.img&&(e.save(),ctxFlip(e,t),t.calculative.rotate&&ctxRotate(e,t),setGlobalAlpha(e,t),drawImage(e,t),e.restore()),renderPen(e,t));this.drawingLine&&renderPen(e,this.drawingLine),this.pencilLine&&renderPen(e,this.pencilLine),this.movingPens&&this.movingPens.forEach((t=>{this.renderPenContainChild(e,t)}))})),__publicField(this,"renderPenContainChild",((e,t)=>{var i;t.calculative.inView&&("combine"!==t.name||t.draw)&&renderPen(e,t),null==(i=t.children)||i.forEach((t=>{const i=this.store.pens[t];i&&this.renderPenContainChild(e,i)}))})),__publicField(this,"renderBorder",(()=>{if(!this.store.data.locked&&this.activeRect&&(1!==this.store.active.length||!this.store.active[0].type)&&!this.movingPens){const e=this.offscreen.getContext("2d");e.save(),e.translate(.5,.5);const t=this.activeRect.pivot||this.activeRect.center;if(this.activeRect.rotate&&(e.translate(t.x,t.y),e.rotate(this.activeRect.rotate*Math.PI/180),e.translate(-t.x,-t.y)),e.strokeStyle=this.store.styles.activeColor,e.globalAlpha=void 0===this.store.options.activeGlobalAlpha?.3:this.store.options.activeGlobalAlpha,e.beginPath(),e.lineWidth=this.store.options.activeLineWidth||1,e.setLineDash(this.store.options.activeLineDash||[]),e.strokeRect(this.activeRect.x,this.activeRect.y,this.activeRect.width,this.activeRect.height),e.setLineDash([]),e.lineWidth=1,e.globalAlpha=1,getPensLock(this.store.active)||getPensDisableRotate(this.store.active)||this.store.options.disableRotate)return void e.restore();e.beginPath(),e.moveTo(this.activeRect.center.x,this.activeRect.y),e.lineTo(this.activeRect.center.x,this.activeRect.y-30),e.stroke(),e.beginPath(),e.strokeStyle=this.store.styles.activeColor,e.fillStyle="#ffffff",e.arc(this.activeRect.center.x,this.activeRect.y-30,5,0,2*Math.PI),e.fill(),e.stroke(),e.restore()}})),__publicField(this,"renderHoverPoint",(()=>{if(this.store.data.locked)return;const e=this.offscreen.getContext("2d");if(e.save(),e.translate(.5,.5),!this.store.options.disableAnchor&&this.store.hover&&!this.store.hover.disableAnchor&&(this.hotkeyType!==HotkeyType.Resize||1!==this.store.active.length||this.store.active[0]!==this.store.hover)){const t=[...this.store.hover.calculative.worldAnchors];this.store.pointAt&&this.hotkeyType===HotkeyType.AddAnchor&&t.push(this.store.pointAt),t&&(e.strokeStyle=this.store.hover.anchorColor||this.store.styles.anchorColor,e.fillStyle=this.store.hover.anchorBackground||this.store.options.anchorBackground,t.forEach((t=>{if(t.hidden&&t.locked>LockState.DisableEdit)return;if(t===this.store.hoverAnchor){e.save();const t=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;e.strokeStyle=t,e.fillStyle=t}e.beginPath();let i=t.radius||this.store.hover.anchorRadius||this.store.options.anchorRadius;if(!this.store.hover.type||t.radius||this.store.hover.anchorRadius||(i=3,this.store.hover.calculative.lineWidth>3&&(i=this.store.hover.calculative.lineWidth)),t.type===PointType.Line){let n=this.store.pens[t.penId].rotate||0;this.store.pens[t.penId].calculative.flipX&&(n*=-1),this.store.pens[t.penId].calculative.flipY&&(n*=-1);let o=t.rotate+n;this.store.pens[t.penId].calculative.flipX&&(o*=-1),this.store.pens[t.penId].calculative.flipY&&(o*=-1),e.save(),e.translate(t.x,t.y),e.rotate(o*Math.PI/180),e.translate(-t.x,-t.y),e.rect(t.x-t.length*this.store.data.scale/2,t.y-i,t.length*this.store.data.scale,2*i),e.restore()}else e.arc(t.x,t.y,i,0,2*Math.PI);if(this.store.hover.type&&this.store.hoverAnchor===t?(e.save(),e.strokeStyle=this.store.hover.activeColor||this.store.styles.activeColor,e.fillStyle=e.strokeStyle):(t.color||t.background)&&(e.save(),e.strokeStyle=t.color,e.fillStyle=t.background),e.fill(),e.stroke(),t===this.store.hoverAnchor&&e.restore(),(this.store.hover.type&&this.store.hoverAnchor===t||t.color||t.background)&&e.restore(),!this.store.hover.parentId&&this.store.hover.children&&this.store.hover.children.length>0&&t===this.store.hoverAnchor){e.save(),e.beginPath(),e.lineWidth=3;const n=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;globalThis.pSBC&&(e.strokeStyle=globalThis.pSBC(.5,n)),e.arc(t.x,t.y,i+1.5,0,2*Math.PI),e.stroke(),e.restore()}})))}this.hotkeyType===HotkeyType.AddAnchor||this.movingPens||!this.activeRect||1===this.store.active.length&&this.store.active[0].type||getPensLock(this.store.active)||getPensDisableResize(this.store.active)||this.store.options.disableSize||(e.strokeStyle=this.store.styles.activeColor,e.fillStyle="#ffffff",this.sizeCPs.forEach(((t,i)=>{this.activeRect.rotate&&(e.save(),e.translate(t.x,t.y),e.rotate(this.activeRect.rotate*Math.PI/180),e.translate(-t.x,-t.y)),(i<4||this.hotkeyType===HotkeyType.Resize)&&(e.beginPath(),e.fillRect(t.x-4.5,t.y-4.5,8,8),e.strokeRect(t.x-5.5,t.y-5.5,10,10)),this.activeRect.rotate&&e.restore()}))),!this.store.data.locked&&this.dragRect&&(e.save(),e.fillStyle=rgba(this.store.options.dragColor,.2),e.strokeStyle=this.store.options.dragColor,e.beginPath(),e.strokeRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),e.fillRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),e.restore()),this.dock&&(e.strokeStyle=this.store.options.dockColor,this.dock.xDock&&(e.beginPath(),e.moveTo(this.dock.xDock.x,this.dock.xDock.y),e.lineTo(this.dock.xDock.x,this.dock.xDock.prev.y),e.stroke()),this.dock.yDock&&(e.beginPath(),e.moveTo(this.dock.yDock.x,this.dock.yDock.y),e.lineTo(this.dock.yDock.prev.x,this.dock.yDock.y),e.stroke())),e.restore()})),__publicField(this,"transTimeout"),__publicField(this,"pastePen",((e,t)=>{const i=e.id;if(randomId(e),e.parentId=t,e.type===PenType.Line?this.changeNodeConnectedLine(i,e,this.store.clipboard.pens):this.changeLineAnchors(i,e,this.store.clipboard.pens),!e.parentId){const t=this.getPenRect(e,this.store.clipboard.origin,this.store.clipboard.scale),i=this.getPenRect(this.store.clipboard.initRect,this.store.clipboard.origin,this.store.clipboard.scale),{origin:n,scale:o}=this.store.data;e.x=n.x+t.x*o,e.y=n.y+t.y*o,e.width=t.width*o,e.height=t.height*o,i.x=n.x+i.x*o,i.y=n.y+i.y*o,calcCenter(i),this.store.clipboard.pos&&(e.x-=i.center.x-this.store.clipboard.pos.x,e.y-=i.center.y-this.store.clipboard.pos.y),this.keyOptions&&this.keyOptions.altKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey)?(e.x=-this.store.data.x+this.width/2-e.width/2,e.y=-this.store.data.y+this.height/2-e.height/2):this.keyOptions&&this.keyOptions.shiftKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey||this.keyOptions.F)||(e.x+=this.store.clipboard.offset*this.store.data.scale,e.y+=this.store.clipboard.offset*this.store.data.scale)}this.makePen(e);const n=[];if(Array.isArray(e.children))for(const o of e.children){const t=this.store.clipboard.pens.find((e=>e.id===o));t&&n.push(this.pastePen(t,e.id).id)}return e.children=n,calcInView(e,!0),e})),__publicField(this,"ondblclick",(e=>{var t,i,n;if(this.store.hover&&(!this.store.data.locked||this.store.hover.dbInput)&&!this.store.options.disableInput)if(this.store.hover.onShowInput)this.store.hover.onShowInput(this.store.hover,e);else if(this.store.hover&&this.store.hover.parentId)if(1===(null==(t=this.store.active)?void 0:t.length)&&this.store.active[0].id===this.store.hover.id)this.showInput(this.store.hover);else{if(this.store.pens[this.store.hover.parentId].children.forEach((e=>{this.store.pens[e].calculative.active=!1,this.store.pens[e].calculative.hover=!1})),this.store.hover.parentId){let t=this.store.hover.id;const o=this.calibrateMouse({x:e.offsetX,y:e.offsetY});let s=1/0;null==(n=null==(i=this.store.pens[this.store.hover.parentId])?void 0:i.children)||n.forEach((e=>{const i=this.store.pens[e];if(pointInRect(o,i.calculative.worldRect)){const n=Math.sqrt((o.x-i.calculative.worldRect.center.x)**2+(o.y-i.calculative.worldRect.center.y)**2);n<s&&(s=n,t=e)}})),this.store.hover=this.store.pens[t],this.store.pens[t].calculative.hover=!0}this.active([this.store.hover])}else this.showInput(this.store.hover);this.store.emitter.emit("dblclick",{x:e.x,y:e.y,pen:this.store.hover})})),__publicField(this,"showInput",((e,t,i="transparent")=>{if(!window||!this.store.hover||this.store.hover.locked||this.store.hover.externElement||this.store.hover.disableInput||this.store.hover.disabled)return;if(this.inputDiv.dataset.penId===e.id){this.inputDiv.dataset.isInput="true",this.inputDiv.contentEditable="true",this.inputDiv.focus();const e=window.getSelection();return e.selectAllChildren(this.inputDiv),e.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,void(this.inputDiv.scrollLeft=this.inputDiv.scrollWidth)}t||e.dbInput?(this.inputDiv.style.width="100%",this.inputDiv.style.height="100%"):this.setInputStyle(e);const n=t||e.calculative.worldTextRect,o=`${(void 0===e.calculative.tempText?e.text+""||"":e.calculative.tempText).replace(/\x20/g,"&nbsp;").split(/[\s\n]/).join("</div><div>")}</div>`.replace("</div>","").replace(/\<div\>\<\/div\>/g,"<div><br></div>");this.inputDiv.innerHTML=o,this.inputParent.style.left=n.x+this.store.data.x-(e.calculative.textLeft||0)+"px",this.inputParent.style.top=n.y+this.store.data.y-(e.calculative.textTop||0)+"px";let s=n.width;this.inputParent.style.width=(s<0?12:s)+"px",this.inputParent.style.height=n.height+(e.textTop||0)+"px",this.inputParent.style.zIndex="9999",this.inputParent.style.background=i,e.rotate%360?this.inputParent.style.transform=`rotate(${e.rotate}deg)`:this.inputParent.style.transform=null,this.inputParent.style.display="flex",this.inputDiv.dataset.penId=e.id,this.inputDiv.contentEditable=null==e.disableInput?"true":e.disableInput.toString(),e.dropdownList&&"block"!==this.dropdown.style.display&&(this.dropdown.style.background=e.dropdownBackground||this.store.styles.popContentBg||"#fff",this.dropdown.style.color=e.dropdownColor||"#bdc7db",this.dropdown.style.width=this.inputParent.style.width,this.dropdown.style.fontSize=(e.fontSize||12)+"px",this.setDropdownList(),this.externalElements.style.zIndex="9999"),this.inputDiv.contentEditable="true",this.inputDiv.focus();const r=window.getSelection();r.selectAllChildren(this.inputDiv),r.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,this.inputDiv.scrollLeft=this.inputDiv.scrollWidth,e.calculative.text=void 0,this.initTemplateCanvas([e]),this.render()})),__publicField(this,"setInputStyle",(e=>{let t;e.text||(e.text="");for(let a=0;a<document.styleSheets.length;a++)"le5le.com"===document.styleSheets[a].title&&(t=document.styleSheets[a]);let i="overflow: scroll;",n="",o=1;const{scale:s}=this.store.data;if(e.fontSize<12&&(o=12/e.fontSize),e.textAlign?i+=`text-align: ${e.textAlign};`:i+="text-align: center;",e.textAlign&&"pre-line"===e.whiteSpace){i+=`align-items: ${{left:"start",center:"center",right:"end"}[e.textAlign]};`}if(e.textBaseline){i+=`justify-content: ${{top:"start",middle:"center",bottom:"end"}[e.textBaseline]};`}else i+="justify-content: center;";if(e.fontFamily&&(i+=`font-family: ${e.fontFamily};`),e.fontSize&&(e.fontSize*s<12?(i+=`font-size:${e.fontSize}px;`,i+=`zoom:${e.fontSize/12*s};`):i+=`font-size:${e.fontSize*s}px;`),i+=`color:${getTextColor(e,this.store)};`,e.fontStyle&&(i+=`font-style: ${e.fontStyle};`),e.fontWeight&&(i+=`font-weight: ${e.fontWeight};`),e.textLeft&&(i+=`margin-left:${s>1?e.textLeft*o:e.textLeft*o/s}px;`),e.textTop&&(i+=`margin-top:${s>1?e.textTop*o:e.textTop*o/s}px;`),e.lineHeight&&(i+=`line-height:${s>1?e.fontSize*e.lineHeight*s:e.fontSize*e.lineHeight*o}px;`),e.textHeight)i+=`height:${s>1?e.textHeight*o*s:e.textHeight*o}px;`;else{let t=e.calculative.worldRect.height/s;t<0&&(t=0);let n=e.fontSize*s<12?t*o:t*s*o;n<e.fontSize*e.lineHeight*s&&(n=e.fontSize*e.lineHeight*s,i+=`top:-${n/2}px;`),i+=`height:${n}px;`}let r=null;if(e.textWidth)r=e.textWidth<1&&e.textWidth>-1?e.textWidth*e.calculative.worldRect.width:e.textWidth,"pre-line"!==e.whiteSpace&&(r<e.fontSize?i+=`width:${1.2*e.fontSize*o}px;`:i+=`width:${s>1?r*o*s:r*o}px;`);else if(void 0===e.whiteSpace||"break-all"===e.whiteSpace){let t=(e.calculative.worldTextRect.width||12)/s;t<0&&(t=0),i+=`width:${e.fontSize*s<12?t*o:t*s}px;`}if(e.whiteSpace&&("pre-line"===e.whiteSpace?i+="white-space:pre;":(i+=`white-space:${e.whiteSpace};`,"nowrap"===e.whiteSpace&&(n+="display:contents;"))),"nowrap"!==e.whiteSpace){1.2*e.fontSize*e.text.length>(r||e.calculative.worldRect.width/s)*Math.floor(e.calculative.worldRect.height/s/(e.lineHeight*e.fontSize))&&(i+="justify-content: start;")}t.deleteRule(0),t.deleteRule(0),t.insertRule(`.meta2d-input\n      .input-div{\n        resize:none;border:none;outline:none;background:transparent;position:absolute;flex-grow:1;height:100%;width: 100%;position:absolute;left:0;top:0;display:flex;flex-direction: column;cursor: text;${i}}`),t.insertRule(`.input-div div{${n}}`)})),__publicField(this,"hideInput",(()=>{if(this.externalElements.style.zIndex="5","flex"===this.inputParent.style.display){this.inputParent.style.display="none";const e=this.store.pens[this.inputDiv.dataset.penId];if(!e)return;if(e.calculative.text=e.text,this.inputDiv.dataset.value=this.inputDiv.innerHTML.replace(/\<div\>/g,"\n").replace(/\<\/div\>/g,"").replace(/\<br\>/g,"").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,""),this.inputDiv.dataset.value=this.convertSpecialCharacter(this.inputDiv.dataset.value),e.onInput)e.onInput(e,this.inputDiv.dataset.value);else if(e.text!==this.inputDiv.dataset.value){const t=[deepClone(e,!0)];e.text=this.inputDiv.dataset.value,e.calculative.text=e.text,this.inputDiv.dataset.penId=void 0,e.text&&e.textAutoAdjust&&!e.parentId&&calcTextAutoWidth(e),calcTextRect(e),this.patchFlags=!0,this.pushHistory({type:EditType.Update,pens:[deepClone(e,!0)],initPens:t}),this.store.emitter.emit("change",e),this.store.emitter.emit("valueUpdate",e)}else e.text===this.inputDiv.dataset.value&&0==e.calculative.textLines.length&&calcTextRect(e);this.initTemplateCanvas([e])}this.inputDiv.dataset.penId=void 0,this.dropdown.style.display="none",this.inputDiv.dataset.isInput="false",this.inputDiv.contentEditable="false",this.render()})),__publicField(this,"setDropdownList",(e=>{this.clearDropdownList();const t=this.store.pens[this.inputDiv.dataset.penId];if(!this.store.data.locked&&!["tablePlus"].includes(t.name))return;if(this.dropdown.style.display="block",!t||!t.dropdownList)return void(this.dropdown.style.display="none");if(!t.dropdownList.length){const e=document.createElement("div");return e.innerText="None",e.style.padding="5px 12px",e.style.color="#ddd",void this.dropdown.appendChild(e)}const i=this.inputDiv.innerHTML.replace(/\<div\>/g,"\n").replace(/\<\/div\>/g,"").replace(/\<br\>/g,"");let n=0;for(const o of t.dropdownList){const t="string"==typeof o?o:o.text;e&&i?t.includes(i)&&this.dropdownAppendOption(t,n):this.dropdownAppendOption(t,n),++n}if(!this.dropdown.hasChildNodes()){const e=document.createElement("div");e.innerText="None",e.style.padding="5px 12px",e.style.color="#ddd",this.dropdown.appendChild(e)}})),__publicField(this,"selectDropdown",(e=>{const t=e.target,i=this.store.pens[this.inputDiv.dataset.penId];if(!t||!i||!i.dropdownList)return;const n=+t.dataset.i,o=i.dropdownList[n];if(!o)return;const s=[deepClone(i,!0)];"object"==typeof o?(this.updateValue(i,{...o}),i.calculative.text=void 0,this.calcActiveRect()):i.text=o+"",this.inputDiv.innerText=i.text,this.hideInput(),this.pushHistory({type:EditType.Update,pens:[deepClone(i,!0)],initPens:s}),this.render(),this.store.emitter.emit("change",i),this.store.emitter.emit("valueUpdate",i)})),__publicField(this,"inFitBorder",(e=>{let t;const i=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height;let o=(e.x-this.store.data.origin.x)/this.store.data.scale,s=(e.y-this.store.data.origin.y)/this.store.data.scale;const r=this.canvasImage.activeFit;this.externalElements.style.cursor="default",s>n*r.y-10&&s<n*r.y+10&&(t="top",this.externalElements.style.cursor="row-resize"),s>n*(r.y+r.height)-10&&s<n*(r.y+r.height)+10&&(t="bottom",this.externalElements.style.cursor="row-resize"),o>i*r.x-10&&o<i*r.x&&(t="left",this.externalElements.style.cursor="col-resize"),o>i*(r.x+r.width)-10&&o<i*(r.x+r.width)+10&&(t="right",this.externalElements.style.cursor="col-resize"),this.canvasImage.currentFit=t})),this.parent=e,this.parentElement=t,this.store=i,this.canvasTemplate=new CanvasTemplate(t,i),this.canvasTemplate.canvas.style.zIndex="1",this.canvasImageBottom=new CanvasImage(t,i,!0),this.canvasImageBottom.canvas.style.zIndex="2",t.appendChild(this.canvas),this.canvas.style.position="absolute",this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.zIndex="3",this.canvasImage=new CanvasImage(t,i),this.canvasImage.canvas.style.zIndex="4",this.magnifierCanvas=new MagnifierCanvas(this,t,i),this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.position="absolute",this.externalElements.style.left="0",this.externalElements.style.top="0",this.externalElements.style.outline="none",this.externalElements.style.background="transparent",this.externalElements.style.zIndex="5",t.style.position="relative",t.appendChild(this.externalElements),this.createInput(),this.tooltip=new Tooltip(t,i),this.tooltip.box.onmouseleave=e=>{this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1),setHover(this.store.data.pens.find((e=>!0===e.calculative.hover)),!1)},this.popconfirm=new Popconfirm(t,i),this.dialog=new Dialog(t,i),this.title=new Title(t),this.store.options.scroll&&(this.scroll=new Scroll(this)),this.store.dpiRatio=globalThis.devicePixelRatio||1,this.store.dpiRatio<1?this.store.dpiRatio=1:this.store.dpiRatio>1&&this.store.dpiRatio<1.5&&(this.store.dpiRatio=1.5),this.clientRect=this.externalElements.getBoundingClientRect(),this.listen(),null==window||window.addEventListener("resize",this.onResize),null==window||window.addEventListener("scroll",this.onScroll),null==window||window.addEventListener("message",this.onMessage)}listen(){switch(this.externalElements.addEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=e=>e.preventDefault(),this.externalElements.ondrop=this.ondrop,this.externalElements.oncontextmenu=e=>e.preventDefault(),this.store.options.interval=50,this.externalElements.ontouchstart=this.ontouchstart,this.externalElements.ontouchmove=this.ontouchmove,this.externalElements.ontouchend=this.ontouchend,this.externalElements.onmousedown=e=>{this.onMouseDown({x:e.offsetX,y:e.offsetY,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey,buttons:e.buttons})},this.externalElements.onmousemove=e=>{e.target===this.externalElements&&this.onMouseMove({x:e.offsetX,y:e.offsetY,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey,buttons:e.buttons})},this.externalElements.onmouseup=e=>{this.onMouseUp({x:e.offsetX,y:e.offsetY,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey,buttons:e.buttons,button:e.button})},this.externalElements.onmouseleave=e=>{this.store.data.pens.forEach((e=>{e.calculative.hover&&(e.calculative.hover=!1)})),this.store.hover&&(this.store.hover.calculative.hover=!1,this.store.hover=void 0),this.render(),e.toElement!==this.tooltip.box&&e.toElement!==this.tooltip.arrowUp&&e.toElement!==this.tooltip.arrowDown&&(this.tooltip.hide(),this.store.lastHover=void 0)},this.externalElements.ondblclick=this.ondblclick,this.externalElements.tabIndex=0,this.externalElements.onblur=()=>{this.mouseDown=void 0},this.externalElements.onwheel=this.onwheel,document.addEventListener("copy",this.onCopy),document.addEventListener("cut",this.onCut),document.addEventListener("paste",this.onPaste),this.store.options.keydown){case KeydownType.Document:document.addEventListener("keydown",this.onkeydown),document.addEventListener("keyup",this.onkeyup);break;case KeydownType.Canvas:this.externalElements.addEventListener("keydown",this.onkeydown),this.externalElements.addEventListener("keyup",this.onkeyup)}}splitLine(e,t){const i=e.calculative.worldAnchors,n=i.findIndex((e=>e===t));if([-1,0,i.length-1].includes(n))return;const o=deepClone(e,!0),s=deepClone(e,!0),r=s8();s.id=r,s.calculative.canvas=this,s.calculative.active=!1,s.calculative.hover=!1;const a=deepClone(i.slice(0,n+1)),l=deepClone(i.slice(n)).map((e=>(e.penId=r,e)));e.calculative.worldAnchors=a,s.calculative.worldAnchors=l,this.initLineRect(e),this.initLineRect(s),this.store.data.pens.push(s),this.store.pens[r]=s,this.pushHistory({type:EditType.Add,pens:[deepClone(s,!0)],step:2}),this.pushHistory({type:EditType.Update,initPens:[o],pens:[deepClone(e,!0)],step:2})}translateAnchor(e,t){this.movingAnchor.x+=e,this.movingAnchor.y+=t;const i=this.movingAnchor.penId;if(i){const e=this.store.pens[i],t=e.calculative.worldRect;this.movingAnchor.x<t.x?this.movingAnchor.x=t.x:this.movingAnchor.x>t.ex&&(this.movingAnchor.x=t.ex),this.movingAnchor.y<t.y?this.movingAnchor.y=t.y:this.movingAnchor.y>t.ey&&(this.movingAnchor.y=t.ey);const n=calcRelativePoint(this.movingAnchor,t),o=e.anchors.findIndex((e=>e.id===this.movingAnchor.id));e.anchors[o]=n,this.patchFlags=!0}}async fileToPen(e,t){let i="";return i=this.store.options.uploadFn?await this.store.options.uploadFn(e):this.store.options.uploadUrl?await uploadFile(e,this.store.options.uploadUrl,this.store.options.uploadParams,this.store.options.uploadHeaders):await fileToBase64(e),new Promise(((e,n)=>{const o=new Image;o.onload=()=>{globalStore.htmlElements[i]=o,e({width:o.width,height:o.height,name:t?"gif":"image",image:i})},o.onerror=e=>{n(e)},o.crossOrigin="anonymous",o.src=i}))}async dropPens(e,t){var i,n,o,s;this.randomIdObj={};for(const d of e)!d.parentId&&this.randomCombineId(d,e);if(0!==Object.keys(this.randomIdObj).length){const t=Object.keys(this.randomIdObj).join("|"),r=new RegExp(`(${t})`,"g");for(const a of e){if(a.type?(a.anchors[0].connectTo=this.randomIdObj[a.anchors[0].connectTo],a.anchors[a.anchors.length-1].connectTo=this.randomIdObj[a.anchors[a.anchors.length-1].connectTo]):null==(i=a.connectedLines)||i.forEach((e=>{e.lineAnchor=this.randomIdObj[e.lineAnchor],e.lineId=this.randomIdObj[e.lineId]})),null==(n=a.animations)?void 0:n.length){const e=JSON.stringify(a.animations).replace(r,(e=>this.randomIdObj[e]));a.animations=JSON.parse(e)}if(null==(o=a.triggers)?void 0:o.length){const e=JSON.stringify(a.triggers).replace(r,(e=>this.randomIdObj[e]));a.triggers=JSON.parse(e)}if(null==(s=a.events)?void 0:s.length){const e=JSON.stringify(a.events).replace(r,(e=>this.randomIdObj[e]));a.events=JSON.parse(e)}}}for(const d of e)d.id||(d.id=s8()),!d.calculative&&(d.calculative={canvas:this}),this.store.pens[d.id]=d;let r=0,a=0,l=0;for(const d of e)d.parentId||(d.width*=this.store.data.scale,d.height*=this.store.data.scale,d.x=t.x-d.width/2+l,d.y=t.y-d.height/2+a,d.tags&&d.tags.includes("meta3d")&&(d.x=this.store.data.origin.x,d.y=this.store.data.origin.y),d.dataset&&(l=r%2==0?d.width-40*this.store.data.scale:0,r++,r%2==0&&(a+=d.height+10*this.store.data.scale)));const c=this.store.data.width||this.store.options.width,h=this.store.data.height||this.store.options.height;if(c&&h){let t={x:this.store.data.origin.x,y:this.store.data.origin.y,width:c*this.store.data.scale,height:h*this.store.data.scale},i=!0;for(const n of e)if(!n.parentId){let e=[{x:n.x,y:n.y},{x:n.x+n.width,y:n.y},{x:n.x,y:n.y+n.height},{x:n.x+n.width,y:n.y+n.height},{x:n.x+n.width/2,y:n.y+n.height/2}];if(n.x===t.x&&n.y===t.y&&n.width===t.width&&n.height===t.height||e.some((e=>pointInRect(e,t)))){i=!1,this.store.options.strictScope&&(n.x<t.x&&(n.x=t.x),n.y<t.y&&(n.y=t.y),n.x+n.width>t.x+t.width&&(n.x=t.x+t.width-n.width),n.y+n.height>t.y+t.height&&(n.y=t.y+t.height-n.height));break}}if(i)return}await this.addPens(e,!0),this.active(e.filter((e=>!e.parentId))),this.render(),this.externalElements.focus()}randomCombineId(e,t,i){let n=null;e.type?n=e.anchors[0].connectTo||e.anchors[e.anchors.length-1].connectTo?[e.id,e.anchors[0].id,e.anchors[e.anchors.length-1].id]:[e.id]:t.length>1&&(n=[e.id]),randomId(e),t.length>1&&(1===n.length?this.randomIdObj[n[0]]=e.id:(this.randomIdObj[n[0]]=e.id,this.randomIdObj[n[1]]=e.anchors[0].id,this.randomIdObj[n[2]]=e.anchors[e.anchors.length-1].id)),e.parentId=i;const o=[];if(Array.isArray(e.children))for(const s of e.children){const i=t.find((e=>e.id===s));i&&o.push(this.randomCombineId(i,t,e.id).id)}return e.children=o,e}async addPens(e,t,i){if(this.beforeAddPens&&1!=await this.beforeAddPens(e))return[];const n=[];for(const o of e)this.beforeAddPen&&1!=this.beforeAddPen(o)||(i&&(o.x=o.x*this.store.data.scale+this.store.data.origin.x,o.y=o.y*this.store.data.scale+this.store.data.origin.y,o.width=o.width*this.store.data.scale,o.height=o.height*this.store.data.scale),this.makePen(o),n.push(o));return this.render(),this.store.emitter.emit("add",n),t&&this.pushHistory({type:EditType.Add,pens:deepClone(n,!0)}),n}getInitPencilLine(e){const{data:t,options:i}=this.store,n=t.scale,o=t.lineWidth||1;return{id:e.penId,name:"line",x:e.x,y:e.y,type:PenType.Line,calculative:{canvas:this,pencil:!0,active:!0,worldAnchors:[e],lineWidth:o*n},fromArrow:t.fromArrow||i.fromArrow,toArrow:t.toArrow||i.toArrow,lineWidth:o}}createDrawingLine(e){this.inactive();const{data:t,options:i}=this.store,n=t.scale,o=t.lineWidth||1;return e.penId=s8(),{id:e.penId,name:"line",lineName:this.drawingLineName,x:e.x,y:e.y,type:PenType.Line,calculative:{canvas:this,active:!0,worldAnchors:[e],lineWidth:o*n},fromArrow:t.fromArrow||i.fromArrow,toArrow:t.toArrow||i.toArrow,lineWidth:o}}addRuleLine(e){const{x:t,y:i,scale:n,origin:o}=this.store.data,s=e.x+t,r=e.y+i;let a=e.x,l=e.y,c=0,h=0,d=0,u=0;if(s<=r&&s<20)a=-t,c=this.width,d=1,e.ctrlKey||(l=Math.round((l-o.y)/(10*n))*(10*n)+o.y);else{if(!(r<s&&r<20))return;l=-i,h=this.height,u=1,e.ctrlKey||(a=Math.round((a-o.x)/(10*n))*(10*n)+o.x)}this.addPen({isRuleLine:!0,type:PenType.Line,name:"line",lineName:"line",x:a,y:l,width:c,height:h,color:this.store.options.ruleLineColor,anchors:[{x:0,y:0},{x:d,y:u}]})}clearRuleLines(){this.delete(this.ruleLines)}get ruleLines(){return this.store.data.pens.filter((e=>e.isRuleLine))}alignPenToGrid(e){var t;if(this.store.options.autoAlignGrid&&this.store.data.grid&&!e.type){const i=this.store.data.gridSize||this.store.options.gridSize,{origin:n,scale:o}=this.store.data,{x:s,y:r}=e,a={x:s,y:r},l=this.getPenRect(e),c=parseInt((l.x/i).toFixed())*i,h=parseInt((l.y/i).toFixed())*i;a.x=n.x+c*o,a.y=n.y+h*o,Object.assign(e,a),null==(t=e.onMove)||t.call(e,e),this.updatePenRect(e),this.calcActiveRect(),this.getSizeCPs()}}movedActivePens(e){let t=this.getAllFollowersByPens(this.store.active,!1);const i=deepClone(t,!0),n=this.store.data.gridSize||this.store.options.gridSize,{origin:o,scale:s}=this.store.data,r=this.store.options.autoAlignGrid&&(this.store.data.grid||this.store.options.grid);if(t.forEach((e=>{var t;const i=this.movingPens.findIndex((t=>t.id===e.id+movingSuffix));if(i<0)return;const{x:a,y:l}=this.movingPens[i],c={x:a,y:l};if(r&&!this.movingPens[i].type){const e=this.getPenRect(this.movingPens[i]),t=parseInt((e.x/n).toFixed()),r=parseInt((e.y/n).toFixed()),a=t*n,l=r*n;c.x=o.x+a*s,c.y=o.y+l*s}Object.assign(e,c),null==(t=e.onMove)||t.call(e,e),this.updatePenRect(e),this.updateLines(e),this.store.emitter.emit("updateLines",e),this.patchFlagsLines.forEach((e=>{e.type&&this.initLineRect(e)})),this.patchFlagsLines.clear(),e.calculative.x=e.x,e.calculative.y=e.y,e.calculative.initRect&&(e.calculative.initRect.x=e.calculative.x,e.calculative.initRect.y=e.calculative.y,e.calculative.initRect.ex=e.calculative.x+e.calculative.width,e.calculative.initRect.ey=e.calculative.y+e.calculative.height),calcChildrenInitRect(e),e.parentId&&this.parent.updateRectbyChild(e.calculative.worldRect,e,this.store.pens[e.parentId])})),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),!this.dock)return;const{xDock:a,yDock:l}=this.dock;let c;a&&(c=this.store.pens[a.penId]),!c&&l&&(c=this.store.pens[l.penId]);const h=deepClone(this.store.active,!0);if(e&&1===this.store.active.length&&1===(null==c?void 0:c.type)&&((null==a?void 0:a.anchorId)||(null==l?void 0:l.anchorId))){const e=getFromAnchor(c),t=getToAnchor(c);if(null==a?void 0:a.anchorId){const n=this.store.pens[this.store.active[0].id+movingSuffix].calculative.worldAnchors.find((e=>e.id===a.anchorId));n.x===e.x&&n.y===e.y?(i.push(deepClone(c,!0)),connectLine(this.store.active[0],n,c,e),h.push(deepClone(c,!0))):n.x===t.x&&n.y===t.y&&(i.push(deepClone(c,!0)),connectLine(this.store.active[0],n,c,t),h.push(deepClone(c,!0)))}else if(null==l?void 0:l.anchorId){const n=this.store.pens[this.store.active[0].id+movingSuffix].calculative.worldAnchors.find((e=>e.id===l.anchorId));n.x===e.x&&n.y===e.y?(i.push(deepClone(c,!0)),connectLine(this.store.active[0],n,c,e),h.push(deepClone(c,!0))):n.x===t.x&&n.y===t.y&&(i.push(deepClone(c,!0)),connectLine(this.store.active[0],n,c,t),h.push(deepClone(c,!0)))}}r&&(this.calcActiveRect(),this.getSizeCPs()),this.pushHistory({type:EditType.Update,pens:h,initPens:i}),this.store.emitter.emit("translatePens",h)}copyMovedPens(){this.copy(this.store.active.map(((e,t)=>{const{x:i,y:n}=this.movingPens[t];return this.updateLines(e),{...e,x:i,y:n}}))),this.pasteOffset=!1,this.paste()}initImageCanvas(e){e.some((e=>this.hasImage(e,!1)))&&this.canvasImage.init(),e.some((e=>this.hasImage(e,!0)))&&this.canvasImageBottom.init()}initTemplateCanvas(e){e.some((e=>e.canvasLayer===CanvasLayer.CanvasTemplate))&&this.canvasTemplate.init()}hasImage(e,t){var i;return e.image&&"gif"!==e.name?t?e.canvasLayer===CanvasLayer.CanvasImageBottom:e.canvasLayer===CanvasLayer.CanvasImage:null==(i=e.children)?void 0:i.some((e=>{const i=this.store.pens[e];return i&&this.hasImage(i,t)}))}inactive(e){this.store.active.length&&(this.initTemplateCanvas(this.store.active),this.store.active.forEach((e=>{e.calculative.active=void 0,e.calculative.activeAnchor=void 0,e.calculative.hover=!1,setChildrenActive(e,!1)})),!e&&this.store.emitter.emit("inactive",this.store.active),this.store.active=[],this.activeRect=void 0,this.sizeCPs=void 0,this.store.activeAnchor=void 0,this.patchFlags=!0)}active(e,t=!0){if(this.store.active){t&&this.store.emitter.emit("inactive",this.store.active);for(const e of this.store.active)e.calculative.active=void 0,e.calculative.hover=!1,setChildrenActive(e,!1)}this.store.active=[],e.forEach((e=>{e.calculative.active=!0,setChildrenActive(e)})),this.store.active.push(...e),this.activeRect=void 0,this.calcActiveRect(),this.initTemplateCanvas(e),this.patchFlags=!0,t&&this.store.emitter.emit("active",this.store.active)}getSizeCPs(){this.sizeCPs=rectToPoints(this.activeRect);const{x:e,y:t,width:i,height:n,rotate:o,center:s}=this.activeRect;[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}].forEach((r=>{const a={x:r.x*i+e,y:r.y*n+t};rotatePoint(a,o,s),this.sizeCPs.push(a)}))}getSpecialAngle(e,t){let i=0;e.x-t.x!==0?(i=180*Math.atan((t.y-e.y)/(e.x-t.x))/Math.PI,e.x<t.x&&(i>0?i-=180:i+=180)):t.y>e.y?i=90:t.y<e.y&&(i=-90),i=15*Math.round(i/15);let n=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y));e.x=t.x+Math.cos(i/180*Math.PI)*n,e.y=t.y-Math.sin(i/180*Math.PI)*n}clearHover(){this.hoverType=HoverType.None,this.store.hover=null,this.store.hoverAnchor=null}inAnchor(e,t,i){var n;if(this.store.hoverAnchor=void 0,this.movingAnchor=void 0,!i||i.locked>LockState.DisableEdit)return HoverType.None;if((!t.type||!t.calculative.active)&&this.store.options.disableAnchor||t.disableAnchor)return HoverType.None;if((this.mouseDown||this.drawingLine)&&"line"===t.name&&i.connectTo){const e=this.findOne(i.connectTo);if((null==e?void 0:e.calculative)&&!(null==e?void 0:e.calculative.active)){t=e;const n=e.calculative.worldAnchors.find((e=>e.id===i.anchorId));n&&(i=n)}}if(i.twoWay===TwoWay.Disable&&"line"!==t.name)return HoverType.None;if("line"===t.name&&i.connectTo){let e=null==(n=this.findOne(i.connectTo))?void 0:n.anchors.find((e=>e.id===i.anchorId));if(e&&e.twoWay)return HoverType.None}if(this.drawingLine){if(i.twoWay===TwoWay.Out)return HoverType.None}else if(this.mouseDown&&this.hoverType===HoverType.LineAnchor);else if(i.twoWay===TwoWay.In)return HoverType.None;if(hitPoint(e,i,this.pointSize,i.penId?this.store.pens[i.penId]:void 0))return i!==this.store.hoverAnchor&&(this.patchFlags=!0),this.store.hoverAnchor=i,this.store.hover=t,t.type?i.connectTo&&!t.calculative.active&&(this.store.hover=this.store.pens[i.connectTo],this.store.hover)?(this.store.hoverAnchor=this.store.hover.calculative.worldAnchors.find((e=>e.id===i.anchorId)),this.store.hoverAnchor?(this.externalElements.style.cursor="crosshair",HoverType.NodeAnchor):HoverType.None):(this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="pointer",HoverType.LineAnchor):(this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="crosshair",HoverType.NodeAnchor);if(!this.mouseDown&&t.type){if(t.calculative.active&&i.prev&&hitPoint(e,i.prev,this.pointSize))return this.store.hoverAnchor=i,this.store.hover=t,this.externalElements.style.cursor="pointer",HoverType.LineAnchorPrev;if(t.calculative.active&&i.next&&hitPoint(e,i.next,this.pointSize))return this.store.hoverAnchor=i,this.store.hover=t,this.externalElements.style.cursor="pointer",HoverType.LineAnchorNext}return HoverType.None}resize(e,t){e=e||this.parentElement.clientWidth,t=t||this.parentElement.clientHeight,this.width=e,this.height=t,this.canvasRect={x:0,y:0,width:e,height:t},calcRightBottom(this.canvasRect),this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.externalElements.style.width=e+"px",this.externalElements.style.height=t+"px",this.canvasTemplate.resize(e,t),this.canvasImage.resize(e,t),this.canvasImageBottom.resize(e,t),this.magnifierCanvas.resize(e,t),e=e*this.store.dpiRatio|0,t=t*this.store.dpiRatio|0,this.canvas.width=e,this.canvas.height=t,this.offscreen.width=e,this.offscreen.height=t,this.clientRect=this.externalElements.getBoundingClientRect(),this.canvas.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle";for(const i of this.store.data.pens)i.isRuleLine&&(i.width?i.height||(i.width=this.width):i.height=this.height,this.updatePenRect(i)),calcInView(i);this.render()}clearCanvas(){this.activeRect=void 0,this.sizeCPs=void 0,this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.offscreen.width,this.offscreen.height),this.store.data.template||this.canvasTemplate.clear(),this.canvasImage.clear(),this.canvasImageBottom.clear()}async addPen(e,t,i,n){if(!(this.beforeAddPens&&1!=await this.beforeAddPens([e])||this.beforeAddPen&&1!=this.beforeAddPen(e)))return n&&(e.x=e.x*this.store.data.scale+this.store.data.origin.x,e.y=e.y*this.store.data.scale+this.store.data.origin.y,e.width=e.width*this.store.data.scale,e.height=e.height*this.store.data.scale),this.makePen(e),this.active([e]),this.render(),i&&this.store.emitter.emit("add",[e]),t&&this.pushHistory({type:EditType.Add,pens:[e]}),e}pushHistory(e){var t;if(this.store.data.locked)return;const{origin:i,scale:n}=this.store.data;e.origin=deepClone(i),e.scale=n,e.type!==EditType.Update&&e.pens&&e.pens.forEach((e=>{e.calculative&&(e.calculative.layer=this.store.data.pens.findIndex((t=>t.id===e.id)))})),this.store.historyIndex<this.store.histories.length-1&&this.store.histories.splice(this.store.historyIndex+1,this.store.histories.length-this.store.historyIndex-1),null==(t=e.pens)||t.forEach((t=>{let i;if(e.initPens)for(const n of e.initPens)n.id===t.id&&(i=n);if(i)for(const e in t)null==i[e]&&(i[e]=void 0)})),this.store.histories.push(e),this.store.historyIndex=this.store.histories.length-1,this.store.emitter.emit("update",{previous:e.initPens,current:e.pens})}undo(){if(this.store.data.locked||null==this.store.historyIndex||this.store.historyIndex<0)return;const e=this.store.histories[this.store.historyIndex--];this.doEditAction(e,!0);let t=e.step;for(;t>1;){const e=this.store.histories[this.store.historyIndex--];this.doEditAction(e,!0),t--}e.type!=EditType.Add&&e.type!=EditType.Delete&&e.type!=EditType.Update||this.activeHistory()}redo(){if(this.store.data.locked||null==this.store.historyIndex||this.store.historyIndex>this.store.histories.length-2)return;const e=this.store.histories[++this.store.historyIndex];this.doEditAction(e,!1);let t=e.step;for(;t>1;){const e=this.store.histories[++this.store.historyIndex];this.doEditAction(e,!1),t--}e.type!=EditType.Add&&e.type!=EditType.Delete&&e.type!=EditType.Update||this.activeHistory()}activeHistory(){let e=this.store.histories[this.store.historyIndex+1];const t=[];if(e&&e.type===EditType.Update)return e.pens.forEach((e=>{t.push(this.store.pens[e.id])})),void this.active(t);let i=this.store.histories[this.store.historyIndex];!i||i.type!==EditType.Add&&i.type!==EditType.Delete||(i.pens.forEach((e=>{t.push(this.store.pens[e.id])})),this.active(t))}doEditAction(e,t){switch(this.inactive(),this.store.hoverAnchor=void 0,this.store.hover=void 0,e.type){case EditType.Add:e.pens.forEach((e=>{var t;const i=deepClone(e,!0),n=this.store.data.pens.findIndex((e=>e.id===i.id));n>-1&&(null==(t=i.onDestroy)||t.call(i,this.store.pens[i.id]),this.store.data.pens.splice(n,1),this.store.pens[i.id]=void 0,i.calculative||(i.calculative={}),i.calculative.canvas=this,this.store.animates.delete(i),this.store.animateMap.delete(i))})),e.type=EditType.Delete;break;case EditType.Update:const i=t?e.initPens:e.pens,n=t?e.pens:e.initPens;i.forEach((t=>{const i=deepClone(t,!0),o=this.store.data.pens.findIndex((e=>e.id===i.id));if(o>-1){if(i.calculative=this.store.data.pens[o].calculative,this.store.data.pens[o].type&&this.store.data.pens[o].lastConnected)for(let e in this.store.data.pens[o].lastConnected)if(this.store.pens[e]){let t=deepClone(this.store.data.pens[o].lastConnected[e]);this.store.pens[e].connectedLines=t,i.anchors.forEach((i=>{t.forEach((t=>{i.id===t.lineAnchor&&(i.connectTo=e)}))}))}this.store.data.pens[o]=i,this.store.pens[i.id]=i;for(const e in i)"object"==typeof i[e]&&"lineDash"!==e||(i.calculative[e]=i[e]);i.calculative.image=void 0;const t=this.getPenRect(i,e.origin,e.scale);if(this.setPenRect(i,t,!1),this.updateLines(i,!0),i.calculative.canvas.parent.isCombine(i)){let e=n.find((e=>e.id===i.id));inheritanceProps.forEach((t=>{i[t]!==e[t]&&this.parent.setValue({id:i.id,[t]:i[t]},{render:!0,doEvent:!1})}))}}}));break;case EditType.Delete:e.pens.reverse().forEach((e=>{var t,i;const n=deepClone(e,!0);if(n.calculative||(n.calculative={}),this.store.data.pens.splice(-1!==(null==(t=n.calculative)?void 0:t.layer)?null==(i=n.calculative)?void 0:i.layer:this.store.data.pens.length,0,n),this.store.pens[n.id]=n,n.type&&n.lastConnected)for(let o in n.lastConnected)this.store.pens[o]&&(this.store.pens[o].connectedLines=n.lastConnected[o]);n.calculative.canvas=this})),e.pens.reverse().forEach((t=>{const i=this.store.pens[t.id],n=this.getPenRect(i,e.origin,e.scale);this.setPenRect(i,n,!1),i.calculative.image=void 0,i.calculative.backgroundImage=void 0,i.calculative.strokeImage=void 0,this.loadImage(i)})),e.type=EditType.Add;break;case EditType.Replace:{const i=t?e.initPens:e.pens;(t?e.pens:e.initPens).forEach((e=>{var t;const i=deepClone(e,!0);if(this.store.data.pens.findIndex((e=>e.id===i.id))>-1){null==(t=i.onDestroy)||t.call(i,this.store.data.pens.find((e=>e.id===i.id)));const e=this.store.data.pens.findIndex((e=>e.id===i.id));this.store.data.pens.splice(e,1),this.store.pens[i.id]=void 0,i.calculative||(i.calculative={}),i.calculative.canvas=this,this.store.animates.delete(i),this.store.animateMap.delete(i)}})),i.reverse().forEach((e=>{var t,i;const n=deepClone(e,!0);if(n.calculative||(n.calculative={}),this.store.data.pens.splice(-1!==(null==(t=n.calculative)?void 0:t.layer)?null==(i=n.calculative)?void 0:i.layer:this.store.data.pens.length,0,n),this.store.pens[n.id]=n,n.type&&n.lastConnected)for(let o in n.lastConnected)this.store.pens[o]&&(this.store.pens[o].connectedLines=n.lastConnected[o]);n.calculative.canvas=this})),i.reverse().forEach((t=>{const i=this.store.data.pens.find((e=>e.id===t.id)),n=this.getPenRect(i,e.origin,e.scale);this.setPenRect(i,n,!1),i.calculative.image=void 0,i.calculative.backgroundImage=void 0,i.calculative.strokeImage=void 0,this.loadImage(i)})),e.type=EditType.Replace;break}}if(e.type===EditType.Update){let t=[...e.pens,...e.initPens];this.initImageCanvas(t),this.initTemplateCanvas(t)}else this.initImageCanvas(e.pens),this.initTemplateCanvas(e.pens);this.parent.onSizeUpdate(),this.render(),this.store.emitter.emit(t?"undo":"redo",e)}makePen(e){var t;if(e.id||(e.id=s8()),Math.abs(this.store.lastScale-this.store.data.scale)<1e-4&&this.store.sameTemplate&&this.store.templatePens[e.id]&&e.canvasLayer===CanvasLayer.CanvasTemplate)return e=this.store.templatePens[e.id],this.store.data.pens.push(e),void this.updatePenRect(e);if(e.copyIndex?(this.store.data.pens.splice(e.copyIndex+1,0,e),delete e.copyIndex):this.store.data.pens.push(e),this.store.pens[e.id]=e,e.path){!e.pathId&&(e.pathId=s8());const t=this.store.data.paths;!t[e.pathId]&&(t[e.pathId]=e.path),e.path=void 0}null==e.lineWidth&&(e.lineWidth=1);const{fontSize:i,lineHeight:n}=this.store.options;e.fontSize?e.fontSize<0&&(e.fontSize=0):e.fontSize=i>=0?i:12,e.lineHeight||(e.lineHeight=n),e.image&&"gif"!==e.name&&void 0===e.canvasLayer&&(e.isBottom?e.canvasLayer=CanvasLayer.CanvasImageBottom:e.canvasLayer=CanvasLayer.CanvasImage,delete e.isBottom),e.template&&(e.canvasLayer=CanvasLayer.CanvasTemplate),e.calculative={canvas:this,singleton:null==(t=e.calculative)?void 0:t.singleton},(e.video||e.audio)&&(e.calculative.onended=e=>{this.nextAnimate(e)});for(const o in e)"object"==typeof e[o]&&"lineDash"!==o||(e.calculative[o]=e[o]);if(e.calculative.image=void 0,e.calculative.backgroundImage=void 0,e.calculative.strokeImage=void 0,!e.anchors&&globalStore.anchors[e.name]&&(e.anchors||(e.anchors=[]),globalStore.anchors[e.name](e)),!e.anchors){const t=deepClone(this.store.options.defaultAnchors);t.forEach(((t,i)=>{t.id=`${i}`,t.penId=e.id})),e.anchors=t}this.updatePenRect(e),!e.anchors&&e.calculative.worldAnchors&&(e.anchors=e.calculative.worldAnchors.map((t=>calcRelativePoint(t,e.calculative.worldRect)))),!e.rotate&&(e.rotate=0),this.loadImage(e),this.parent.penNetwork(e)}drawline(e){var t;this.drawingLine&&(null==(t=this[this.drawingLineName])||t.call(this,this.store,this.drawingLine,e),this.store.path2dMap.set(this.drawingLine,globalStore.path2dDraws.line(this.drawingLine)),this.patchFlags=!0)}initLineRect(e){var t;if(!e)return;if(!(null==(t=e.calculative.worldAnchors)?void 0:t.length))return void this._del([e]);if(!isFinite(e.x)||!isFinite(e.x))return;if(null==e.x||null==e.y)return;const i=getLineRect(e);e.parentId||Object.assign(e,i);const{fontSize:n,lineHeight:o}=this.store.options;e.fontSize||(e.fontSize=n>=0?n:12,e.calculative.fontSize=e.fontSize*this.store.data.scale),e.lineHeight||(e.lineHeight=o,e.calculative.lineHeight=e.lineHeight),calcCenter(i),e.calculative.worldRect=i,calcPadding(e,i),calcTextRect(e),calcInView(e),e.calculative&&(e.calculative.gradientAnimatePath=void 0),this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e)),e.calculative.worldAnchors&&(e.anchors=e.calculative.worldAnchors.map((t=>calcRelativePoint(t,e.calculative.worldRect))))}drawingPencil(){lockedError(this.store),this.pencil=!0,this.externalElements.style.cursor="crosshair"}stopPencil(){this.pencil=!1,this.pencilLine=void 0,this.externalElements.style.cursor="default"}async finishDrawline(e){if(!this.drawingLine)return;const t=getFromAnchor(this.drawingLine);let i=getToAnchor(this.drawingLine);if(i.isTemp&&(this.drawingLine.calculative.worldAnchors.pop(),i=getToAnchor(this.drawingLine)),!e&&(!i.connectTo&&this.drawingLine.calculative.worldAnchors.pop(),getFromAnchor(this.drawingLine)===this.drawingLine.calculative.activeAnchor))return this.drawingLine=void 0,void this.render();if(t.connectTo&&i.connectTo){if(this.store.options.disableRepeatLine){if(this.store.data.pens.find((e=>{if(e.type){const n=getFromAnchor(e),o=getToAnchor(e);return samePoint(n,t)&&samePoint(o,i)}})))return this.drawingLine=void 0,void this.render()}}else if(this.store.options.disableEmptyLine)return t.connectTo&&(this.store.pens[t.connectTo].connectedLines=this.store.pens[t.connectTo].connectedLines.filter((e=>e.lineId!==this.drawingLine.id))),this.drawingLine=void 0,void this.render();const n=getLineRect(this.drawingLine);Object.assign(this.drawingLine,n),this.drawingLine.calculative.worldRect=n,this.drawingLine.calculative.activeAnchor=getToAnchor(this.drawingLine),this.store.activeAnchor=this.drawingLine.calculative.activeAnchor;(!this.beforeAddPens||await this.beforeAddPens([this.drawingLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.drawingLine))&&(this.initLineRect(this.drawingLine),this.store.data.pens.push(this.drawingLine),this.store.pens[this.drawingLine.id]=this.drawingLine,this.store.emitter.emit("add",[this.drawingLine]),this.active([this.drawingLine]),this.pushHistory({type:EditType.Add,pens:deepClone([this.drawingLine],!0)})),this.store.path2dMap.set(this.drawingLine,globalStore.path2dDraws[this.drawingLine.name](this.drawingLine)),this.drawingLine=void 0,this.drawingLineName=void 0,this.render()}async finishPencil(){if(this.pencilLine){const e=simplify(this.pencilLine.calculative.worldAnchors,10,0,this.pencilLine.calculative.worldAnchors.length-1);let t=getFromAnchor(this.pencilLine);if(e.unshift({id:t.id,penId:t.penId,x:t.x,y:t.y}),t=getToAnchor(this.pencilLine),e.push({id:t.id,penId:t.penId,x:t.x,y:t.y}),this.pencilLine.calculative.worldAnchors=smoothLine(e),this.pencilLine.calculative.worldAnchors.length>1){this.pencilLine.calculative.pencil=!1,this.store.path2dMap.set(this.pencilLine,globalStore.path2dDraws[this.pencilLine.name](this.pencilLine));(!this.beforeAddPens||await this.beforeAddPens([this.pencilLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.pencilLine))&&(this.initLineRect(this.pencilLine),this.store.data.pens.push(this.pencilLine),this.store.pens[this.pencilLine.id]=this.pencilLine,this.store.emitter.emit("add",[this.pencilLine]),this.active([this.pencilLine]),this.pushHistory({type:EditType.Add,pens:deepClone([this.pencilLine],!0)}))}this.pencilLine=void 0,this.render()}}firefoxLoadSvg(e){const t=new Image,i=new XMLHttpRequest;i.open("GET",e.image,!0),i.onload=()=>{const n=(new DOMParser).parseFromString(i.responseText,"text/xml").getElementsByTagName("svg")[0],{width:o,height:s}=e.calculative.worldRect;n.setAttribute("width",`${o}px`),n.setAttribute("height",`${s}px`);const r="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent((new XMLSerializer).serializeToString(n))));t.src=r,t.onload=()=>{e.calculative.img=t,e.calculative.imgNaturalWidth=t.naturalWidth||e.iconWidth,e.calculative.imgNaturalHeight=t.naturalHeight||e.iconHeight,globalStore.htmlElements[e.image]=t,this.imageLoaded(),e.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}},i.send()}loadImage(e){if(e.image!==e.calculative.image||!e.calculative.img){if(e.calculative.img=void 0,e.image)if(globalStore.htmlElements[e.image]){const t=globalStore.htmlElements[e.image];e.calculative.img=t,e.calculative.imgNaturalWidth=t.naturalWidth||e.iconWidth,e.calculative.imgNaturalHeight=t.naturalHeight||e.iconHeight,this.imageLoaded(),e.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}else if(navigator.userAgent.includes("Firefox")&&e.image.endsWith(".svg"))this.firefoxLoadSvg(e);else{const t=new Image;t.crossOrigin="undefined"===e.crossOrigin?void 0:e.crossOrigin||"anonymous",t.src=e.image,this.store.options.cdn&&!(e.image.startsWith("http")||e.image.startsWith("//")||e.image.startsWith("data:image"))&&(t.src=this.store.options.cdn+e.image),t.onload=()=>{e.calculative.img=t,e.calculative.imgNaturalWidth=t.naturalWidth||e.iconWidth,e.calculative.imgNaturalHeight=t.naturalHeight||e.iconHeight,globalStore.htmlElements[e.image]=t,this.imageLoaded(),e.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}}e.calculative.image=e.image}if(e.backgroundImage!==e.calculative.backgroundImage){if(e.calculative.backgroundImg=void 0,e.backgroundImage)if(globalStore.htmlElements[e.backgroundImage]){const t=globalStore.htmlElements[e.backgroundImage];e.calculative.backgroundImg=t}else{const t=new Image;t.crossOrigin="anonymous",t.src=e.backgroundImage,this.store.options.cdn&&!(e.backgroundImage.startsWith("http")||e.backgroundImage.startsWith("//")||e.backgroundImage.startsWith("data:image"))&&(t.src=this.store.options.cdn+e.backgroundImage),t.onload=()=>{e.calculative.backgroundImg=t,globalStore.htmlElements[e.backgroundImage]=t,this.imageLoaded(),e.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}}e.calculative.backgroundImage=e.backgroundImage}if(e.strokeImage!==e.calculative.strokeImage){if(e.calculative.strokeImg=void 0,e.strokeImage)if(globalStore.htmlElements[e.strokeImage]){const t=globalStore.htmlElements[e.strokeImage];e.calculative.strokeImg=t}else{const t=new Image;t.crossOrigin="anonymous",t.src=e.strokeImage,this.store.options.cdn&&!(e.strokeImage.startsWith("http")||e.strokeImage.startsWith("//")||e.strokeImage.startsWith("data:image"))&&(t.src=this.store.options.cdn+e.strokeImage),t.onload=()=>{e.calculative.strokeImg=t,globalStore.htmlElements[e.strokeImage]=t,this.imageLoaded(),e.canvasLayer===CanvasLayer.CanvasTemplate&&"gif"!==e.name&&this.templateImageLoaded()}}e.calculative.strokeImage=e.strokeImage}}imageLoaded(){this.imageTimer&&clearTimeout(this.imageTimer),this.imageTimer=setTimeout((()=>{this.canvasImage.init(),this.canvasImageBottom.init(),this.render()}),100)}templateImageLoaded(){this.templateImageTimer&&clearTimeout(this.templateImageTimer),this.templateImageTimer=setTimeout((()=>{this.canvasTemplate.init(),this.render()}),100)}setCalculativeByScale(e){const t=this.store.data.scale;e.calculative.lineWidth=e.lineWidth*t,e.calculative.fontSize=e.fontSize*t,e.fontSize<1&&e.fontSize>0&&(e.calculative.fontSize=e.fontSize*e.calculative.worldRect.height),e.calculative.iconSize=e.iconSize*t,e.calculative.iconWidth=e.iconWidth*t,e.calculative.iconHeight=e.iconHeight*t,e.calculative.iconLeft=e.iconLeft<1&&e.iconLeft>-1?e.iconLeft:e.iconLeft*t,e.calculative.iconTop=e.iconTop<1&&e.iconTop>-1?e.iconTop:e.iconTop*t,e.calculative.textWidth=e.textWidth<1&&e.textWidth>-1?e.textWidth:e.textWidth*t,e.calculative.textHeight=e.textHeight<1&&e.textHeight>-1?e.textHeight:e.textHeight*t,e.calculative.textLeft=e.textLeft<1&&e.textLeft>-1?e.textLeft*e.calculative.worldRect.width:e.textLeft*t,e.calculative.textTop=e.textTop<1&&e.textTop>-1?e.textTop*e.calculative.worldRect.height:e.textTop*t,e.type===PenType.Line&&e.borderWidth&&(e.calculative.borderWidth=e.borderWidth*t)}updatePenRect(e,{worldRectIsReady:t,playingAnimate:i}={}){t?calcPenRect(e):calcWorldRects(e),i||this.setCalculativeByScale(e),calcWorldAnchors(e),calcIconRect(this.store.pens,e),calcTextRect(e),calcInView(e),globalStore.path2dDraws[e.name]&&this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e)),e.calculative.patchFlags=!0,this.patchFlags=!0,e.children&&e.children.forEach((e=>{const t=this.store.pens[e];t&&this.updatePenRect(t,{worldRectIsReady:!1})})),e.type&&this.initLineRect(e),e.calculative.gradientTimer&&clearTimeout(e.calculative.gradientTimer),e.calculative.gradientTimer=setTimeout((()=>{e.calculative.lineGradient&&(e.calculative.lineGradient=null),e.calculative.gradient&&(e.calculative.gradient=null),e.calculative.radialGradient&&(e.calculative.radialGradient=null),this.patchFlags=!0,e.calculative.gradientTimer=void 0}),50)}initGlobalStyle(){const e={},t={},i={};themeKeys.forEach((n=>{var o;if(void 0!==this.store.options[n]&&(e[n]=this.store.options[n]),void 0!==this.store.data[n]&&(t[n]=this.store.data[n]),this.store.data.theme){const e=null==(o=this.store.theme[this.store.data.theme])?void 0:o[n];void 0!==e&&(i[n]=e)}})),this.store.styles={};const n=le5leTheme.getThemeObj(this.store.data.theme);Object.assign(this.store.styles,e,t,i,n)}translate(e=0,t=0){if(this.store.data.x+=e*this.store.data.scale,this.store.data.y+=t*this.store.data.scale,this.store.data.x=Math.round(this.store.data.x),this.store.data.y=Math.round(this.store.data.y),this.store.options.padding){let e=formatPadding(this.store.options.padding);const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;this.width<(t+e[1]+e[3])*this.store.data.scale&&(this.store.data.x+this.store.data.origin.x>e[3]*this.store.data.scale&&(this.store.data.x=e[3]*this.store.data.scale-this.store.data.origin.x),this.store.data.x+this.store.data.origin.x+t*this.store.data.scale<this.width-e[1]*this.store.data.scale&&(this.store.data.x=this.width-e[1]*this.store.data.scale-(this.store.data.origin.x+t*this.store.data.scale))),this.height<(i+e[0]+e[2])*this.store.data.scale&&(this.store.data.y+this.store.data.origin.y>e[0]*this.store.data.scale&&(this.store.data.y=e[0]*this.store.data.scale-this.store.data.origin.y),this.store.data.y+this.store.data.origin.y+i*this.store.data.scale<this.height-e[2]*this.store.data.scale&&(this.store.data.y=this.height-e[2]*this.store.data.scale-(this.store.data.origin.y+i*this.store.data.scale)))}this.store.data.asyncTranslate?(clearTimeout(this.transTimeout),this.transTimeout=setTimeout((()=>{this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()}),300)):(this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()),this.store.emitter.emit("translate",{x:this.store.data.x,y:this.store.data.y}),this.tooltip.translate(e,t),this.scroll&&this.scroll.isShow&&this.scroll.translate(e,t),this.onMovePens()}onMovePens(){var e;const t=this.parent.map;t&&t.isShow&&t.setView();for(const i of this.store.data.pens)calcInView(i),null==(e=i.onMove)||e.call(i,i),i.isRuleLine&&(i.width?i.height||(i.x=-this.store.data.x):i.y=-this.store.data.y,this.updatePenRect(i))}scale(e,t={x:0,y:0}){var i;const n=this.store.data.minScale||this.store.options.minScale,o=this.store.data.maxScale||this.store.options.maxScale;if(!(e>=n&&e<=o))return;this.calibrateMouse(t);const s=e/this.store.data.scale;this.store.data.scale=e,this.store.data.center=t,(null==(i=this.store.clipboard)?void 0:i.pos)&&scalePoint(this.store.clipboard.pos,s,t),scalePoint(this.store.data.origin,s,t),this.store.data.pens.forEach((e=>{if(!e.parentId){if(scalePen(e,s,t),e.onScale&&e.onScale(e),e.isRuleLine){const t=1/s,i=e.calculative.worldRect.center;e.width&&e.height||scalePen(e,t,i)}this.updatePenRect(e,{worldRectIsReady:!0}),this.execPenResize(e)}})),this.onMovePens(),this.calcActiveRect(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init();const r=this.parent.map;r&&r.isShow&&r.setView(),this.render(),this.store.emitter.emit("scale",this.store.data.scale)}templateScale(e,t={x:0,y:0}){const{minScale:i,maxScale:n}=this.store.options;if(!(e>=i&&e<=n))return;const o=e/this.store.data.scale;this.store.data.scale=e,this.store.data.center={x:0,y:0},this.store.data.origin={x:0,y:0},this.store.data.pens.forEach((e=>{if(!e.parentId){if(scalePen(e,o,t),e.onScale&&e.onScale(e),e.isRuleLine){const t=o>1?1:1/o/o,i=e.calculative.worldRect.center;e.width&&e.height||scalePen(e,t,i)}this.execPenResize(e)}})),this.calcActiveRect()}rotatePens(e){this.initPens||(this.initPens=deepClone(this.getAllByPens(this.store.active))),this.activeRect.rotate=calcRotate(e,this.activeRect.center),this.activeRect.rotate%90<10&&(this.activeRect.rotate-=this.activeRect.rotate%90),this.activeRect.rotate%90>80&&(this.activeRect.rotate+=90-this.activeRect.rotate%90),1===this.store.active.length&&(this.lastRotate=this.store.active[0].rotate||0);const t=this.activeRect.rotate-this.lastRotate;for(const i of this.store.active){if(i.parentId)return;this.rotatePen(i,t,this.activeRect),i.onRotate&&i.onRotate(i),this.updateLines(i)}this.lastRotate=this.activeRect.rotate,this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("rotatePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.getAllByPens(this.store.active)),initPens:this.initPens}),this.initPens=void 0}),200)}resizePens(e){if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),!this.initActiveRect)return void(this.initActiveRect=deepClone(this.activeRect));const t=this.mouseDown.x,i=this.mouseDown.y;let n=e.x-t,o=e.y-i;const s=deepClone(this.initActiveRect);if(resizeRect(s,n,o,this.resizeIndex),calcCenter(s),!this.store.options.disableDock){this.clearDock();const e=this.customResizeDock||calcResizeDock;this.dock=e(this.store,s,this.store.active,this.resizeIndex);const{xDock:t,yDock:i}=this.dock;if(t){n+=t.step;this.store.pens[t.penId].calculative.isDock=!0}if(i){o+=i.step;this.store.pens[i.penId].calculative.isDock=!0}}const r=this.activeRect.width,a=this.activeRect.height;let l=n-this.lastOffsetX,c=o-this.lastOffsetY;if(this.lastOffsetX=n,this.lastOffsetY=o,e.ctrlKey||1===this.initPens.length&&this.initPens[0].ratio){c=([1,3].includes(this.resizeIndex)?-1:1)*(l*a)/r}if(this.activeRect.ratio=this.initPens[0].ratio,resizeRect(this.activeRect,l,c,this.resizeIndex),this.store.options.strictScope){const e=this.store.data.width||this.store.options.width,t=this.store.data.height||this.store.options.height;if(e&&t){let i={x:this.store.data.origin.x,y:this.store.data.origin.y,width:e*this.store.data.scale,height:t*this.store.data.scale};this.activeRect.x<i.x&&(this.activeRect.width=this.activeRect.width-(i.x-this.activeRect.x),this.activeRect.x=i.x),this.activeRect.y<i.y&&(this.activeRect.height=this.activeRect.height-(i.y-this.activeRect.y),this.activeRect.y=i.y),this.activeRect.x+this.activeRect.width>i.x+i.width&&(this.activeRect.width=this.activeRect.width-(this.activeRect.x+this.activeRect.width-(i.x+i.width)),this.activeRect.x=i.x+i.width-this.activeRect.width,this.activeRect.ex=this.activeRect.x+this.activeRect.width),this.activeRect.y+this.activeRect.height>i.y+i.height&&(this.activeRect.height=this.activeRect.height-(this.activeRect.y+this.activeRect.height-(i.y+i.height)),this.activeRect.y=i.y+i.height-this.activeRect.height,this.activeRect.ey=this.activeRect.y+this.activeRect.height)}}calcCenter(this.activeRect);const h=this.activeRect.width/r,d=this.activeRect.height/a;this.store.active.forEach(((e,t)=>{e.calculative.worldRect.x=this.activeInitPos[t].x*this.activeRect.width+this.activeRect.x,e.calculative.worldRect.y=this.activeInitPos[t].y*this.activeRect.height+this.activeRect.y,e.calculative.worldRect.width*=h,e.calculative.iconWidth&&(e.calculative.iconWidth*=h),e.calculative.worldRect.height*=d,e.calculative.iconHeight&&(e.calculative.iconHeight*=d),calcRightBottom(e.calculative.worldRect),calcCenter(e.calculative.worldRect),this.updatePenRect(e,{worldRectIsReady:!0}),this.execPenResize(e),this.updateLines(e)})),this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("resizePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0}),200)}movePens(e){var t,i;if(!this.activeRect||this.store.data.locked)return;if(!this.initActiveRect)return void(this.initActiveRect=deepClone(this.activeRect));if(!this.store.options.moveConnectedLine&&!this.canMoveLine&&1===this.store.active.length&&((null==(t=this.store.active[0].anchors[0])?void 0:t.connectTo)||(null==(i=this.store.active[0].anchors[this.store.active[0].anchors.length-1])?void 0:i.connectTo)))return;if(this.movingPens||(this.initMovingPens(),this.store.active.forEach((e=>{setHover(e,!1)})),this.store.hover=void 0),!this.mouseDown)return;let n=e.x-this.mouseDown.x,o=e.y-this.mouseDown.y;e.shiftKey&&!e.ctrlKey&&(o=0),e.ctrlKey&&(n=0);const s=deepClone(this.initActiveRect);translateRect(s,n,o);let r=!1;if(this.store.options.strictScope){const e=this.store.data.width||this.store.options.width,t=this.store.data.height||this.store.options.height;if(e&&t){let i={x:this.store.data.origin.x,y:this.store.data.origin.y,width:e*this.store.data.scale,height:t*this.store.data.scale};s.x<i.x&&(s.x=i.x,r=!0),s.y<i.y&&(s.y=i.y,r=!0),s.x+s.width>i.x+i.width&&(s.x=i.x+i.width-s.width,r=!0),s.y+s.height>i.y+i.height&&(s.y=i.y+i.height-s.height,r=!0)}}const a={x:s.x-this.activeRect.x,y:s.y-this.activeRect.y};if(!this.store.options.disableDock&&!r){this.clearDock();const e=this.customMoveDock||calcMoveDock;this.dock=e(this.store,s,this.movingPens,a);const{xDock:t,yDock:i}=this.dock;let n;t&&(a.x+=t.step,n=this.store.pens[t.penId],n.calculative.isDock=!0),i&&(a.y+=i.step,n=this.store.pens[i.penId],n.calculative.isDock=!0)}this.translatePens(this.movingPens,a.x,a.y,!0)}changeIdsByMoving(e,t){e.id+=movingSuffix,e.parentId&&t.find((t=>t.id===e.parentId))&&(e.parentId+=movingSuffix),e.children&&(e.children=e.children.map((e=>e+movingSuffix))),e.connectedLines&&(e.connectedLines=e.connectedLines.map((e=>(t.find((t=>t.id===e.lineId))&&(e.lineId+=movingSuffix),e)))),e.type&&e.calculative.worldAnchors&&(e.calculative.worldAnchors=e.calculative.worldAnchors.map((e=>(e.connectTo&&t.find((t=>t.id===e.connectTo))&&(e.connectTo+=movingSuffix),e))))}initMovingPens(){var e,t;if(!this.store.options.moveConnectedLine&&!this.canMoveLine)for(let o=0;o<this.store.active.length;o++){const i=this.store.active[o];((null==(e=i.anchors[0])?void 0:e.connectTo)||(null==(t=i.anchors[i.anchors.length-1])?void 0:t.connectTo))&&(this.store.active.splice(o,1),i.calculative.active=void 0,--o)}this.movingPens=deepClone(this.store.active,!0),this.movingPens=this.getAllFollowersByPens(this.movingPens);const i=this.getAllByPens(this.movingPens),n=deepClone(i,!0);i.forEach((e=>{this.changeIdsByMoving(e,n),this.store.pens[e.id]=e,e.calculative.canvas=this;const t={globalAlpha:.5};0===e.lineWidth&&(t.lineWidth=1),(e.name.endsWith("Dom")||isDomShapes.includes(e.name)||this.store.options.domShapes.includes(e.name)||e.image)&&(t.name="rectangle",t.onDestroy=void 0),this.updateValue(e,t),e.calculative.image=void 0}))}moveLineAnchor(e,t){var i,n,o,s,r;if(!this.activeRect||this.store.data.locked)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),null==(i=this.store.activeAnchor)?void 0:i.connectTo){const e=this.store.pens[this.store.activeAnchor.connectTo];disconnectLine(e,getAnchor(e,this.store.activeAnchor.anchorId),this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor)}let a=null==(n=this.store.activeAnchor)?void 0:n.id,l=null==(s=null==(o=this.store.pens[this.store.activeAnchor.penId])?void 0:o.connectedLines)?void 0:s.filter((e=>e.anchor===a));l&&l.length>0&&l.forEach((e=>{const t=this.store.pens[e.lineId];disconnectLine(this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor,t,getAnchor(t,e.lineAnchor))}));const c=this.store.active[0];getFromAnchor(c);const h=getToAnchor(c);if("polyline"!==c.lineName||t.shiftKey){let i=0,n=0;if("line"===c.lineName){let o=c.calculative.worldAnchors.findIndex((e=>e.id===this.store.activeAnchor.id));0===o&&(o=2);let s=c.calculative.worldAnchors[o-1];if(t.ctrlKey&&t.shiftKey){let t=deepClone(e);this.getSpecialAngle(t,s),i=t.x-this.store.activeAnchor.x,n=t.y-this.store.activeAnchor.y}else if(!t.ctrlKey&&t.shiftKey){let t={x:e.x,y:s.y};i=t.x-this.store.activeAnchor.x,n=t.y-this.store.activeAnchor.y}else if(t.ctrlKey&&!t.shiftKey){let t={x:s.x,y:e.y};i=t.x-this.store.activeAnchor.x,n=t.y-this.store.activeAnchor.y}else i=e.x-this.store.activeAnchor.x,n=e.y-this.store.activeAnchor.y}else!t.ctrlKey&&t.shiftKey?(i=e.x-this.store.activeAnchor.x,n=0):t.ctrlKey&&!t.shiftKey?(i=0,n=e.y-this.store.activeAnchor.y):(i=e.x-this.store.activeAnchor.x,n=e.y-this.store.activeAnchor.y);translatePoint(this.store.activeAnchor,i,n),this.store.hover&&this.store.hoverAnchor&&this.store.hoverAnchor.penId!==this.store.activeAnchor.penId&&(this.store.hoverAnchor.type===PointType.Line?(i=e.x-this.store.activeAnchor.x,n=e.y-this.store.activeAnchor.y,getDistance(this.store.activeAnchor,this.store.hoverAnchor,this.store)):(i=this.store.hoverAnchor.x-this.store.activeAnchor.x,n=this.store.hoverAnchor.y-this.store.activeAnchor.y),translatePoint(this.store.activeAnchor,i,n),h.prev=void 0,"polyline"!==c.lineName&&(null==(r=this[c.lineName])||r.call(this,this.store,c)))}else translatePolylineAnchor(c,this.store.activeAnchor,e);this.patchFlagsLines.add(c),this.store.path2dMap.set(c,globalStore.path2dDraws[c.name](c)),this.render(),this.store.active[0].calculative&&(this.store.active[0].calculative.gradientAnimatePath=void 0),this.store.emitter.emit("moveLineAnchor",{pen:this.store.active[0],anchor:this.store.activeAnchor}),this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0}),500)}moveLineAnchorPrev(e){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),this.store.activeAnchor.prev.x=e.x,this.store.activeAnchor.prev.y=e.y,this.store.activeAnchor.next)if(this.store.activeAnchor.prevNextType){if(this.store.activeAnchor.prevNextType===PrevNextType.Bilateral&&this.prevAnchor){const t=calcRotate(e,this.store.activeAnchor),i=calcRotate(this.prevAnchor,this.store.activeAnchor);this.store.activeAnchor.next.x=this.nextAnchor.x,this.store.activeAnchor.next.y=this.nextAnchor.y,rotatePoint(this.store.activeAnchor.next,t-i,this.store.activeAnchor)}}else this.store.activeAnchor.next.x=e.x,this.store.activeAnchor.next.y=e.y,rotatePoint(this.store.activeAnchor.next,180,this.store.activeAnchor);const t=this.store.active[0];this.patchFlagsLines.add(t),this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0}),200)}moveLineAnchorNext(e){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),this.store.activeAnchor.next.x=e.x,this.store.activeAnchor.next.y=e.y,this.store.activeAnchor.prev)if(this.store.activeAnchor.prevNextType){if(this.store.activeAnchor.prevNextType===PrevNextType.Bilateral&&this.nextAnchor){const t=calcRotate(e,this.store.activeAnchor),i=calcRotate(this.nextAnchor,this.store.activeAnchor);this.store.activeAnchor.prev.x=this.prevAnchor.x,this.store.activeAnchor.prev.y=this.prevAnchor.y,rotatePoint(this.store.activeAnchor.prev,t-i,this.store.activeAnchor)}}else this.store.activeAnchor.prev.x=e.x,this.store.activeAnchor.prev.y=e.y,rotatePoint(this.store.activeAnchor.prev,180,this.store.activeAnchor);const t=this.store.active[0];this.patchFlagsLines.add(t),this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0}),200)}async setAnchor(e){var t;const i=[deepClone(this.store.hover,!0)],n=this.store.hover;if(this.store.hoverAnchor){if(this.beforeRemoveAnchor&&!(await this.beforeRemoveAnchor(n,this.store.hoverAnchor)))return;n.type===PenType.Line&&(null==(t=n.calculative.worldAnchors)?void 0:t.length)<=2?this.delete([n]):(removePenAnchor(n,this.store.hoverAnchor),n.type===PenType.Line&&this.initLineRect(n)),this.store.hoverAnchor=void 0,this.store.activeAnchor=void 0,this.externalElements.style.cursor="default"}else if(n){if(this.beforeAddAnchor&&!(await this.beforeAddAnchor(n,this.store.pointAt)))return;if(n.type===PenType.Line){this.store.activeAnchor=addLineAnchor(n,this.store.pointAt,this.store.pointAtIndex),this.initLineRect(n);const t={x:e.x,y:e.y};this.getHover(t)}else{const t={id:s8(),x:e.x,y:e.y};this.store.activeAnchor=pushPenAnchor(n,t)}}this.hotkeyType=HotkeyType.None,this.render(),n&&this.pushHistory({type:EditType.Update,pens:[deepClone(n,!0)],initPens:i})}checkDisconnect(e,t){if(e.id.indexOf(movingSuffix)>0){const t=e.id;e=this.store.pens[t.replace(movingSuffix,"")]}e.anchors.forEach((i=>{if(i.connectTo&&!t.find((e=>e.id===i.connectTo||e.id===i.connectTo+movingSuffix))){const t=this.store.pens[i.connectTo];if(!t||t.type)return;disconnectLine(t,getAnchor(t,i.anchorId),e,i)}}))}translatePens(e=this.store.active,t,i,n){if(!e||!e.length)return;if(e.some((e=>{if(e.locked>=LockState.DisableMove)return!0})))return;const o=!n&&deepClone(e,!0);this.activeRect&&translateRect(this.activeRect,t,i);const s=this.getAllByPens(e);e.forEach((e=>{var o,r;if(!(e.locked>=LockState.DisableMove)){if(e.type===PenType.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)return;if(e.isRuleLine)return;translateLine(e,t,i),this.checkDisconnect(e,s),this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e)),n||(this.initLineRect(e),null==(o=e.connectedLines)||o.forEach((e=>{const t=this.store.pens[e.lineId];this.initLineRect(t)})))}else translateRect(e.calculative.worldRect,t,i),this.updatePenRect(e,{worldRectIsReady:!0}),e.calculative.x=e.x,e.calculative.y=e.y,e.calculative.initRect&&(e.calculative.initRect.x=e.calculative.x,e.calculative.initRect.y=e.calculative.y,e.calculative.initRect.ex=e.calculative.x+e.calculative.width,e.calculative.initRect.ey=e.calculative.y+e.calculative.height);this.updateLines(e),null==(r=e.onMove)||r.call(e,e)}})),this.activeRect&&this.getSizeCPs(),this.render(),this.tooltip.translate(t,i),n||(this.pushHistory({type:EditType.Update,pens:deepClone(e,!0),initPens:o}),this.initImageCanvas(e),this.initTemplateCanvas(e),this.store.emitter.emit("translatePens",e)),this.store.emitter.emit("translatingPens",e)}templateTranslatePens(e=this.store.active,t,i){if(!e||!e.length)return;const n=this.getAllByPens(e);e.forEach((e=>{var o;if(e.type===PenType.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)return;translateLine(e,t,i),this.checkDisconnect(e,n),this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e))}else translateRect(e.calculative.worldRect,t,i),this.updatePenRect(e,{worldRectIsReady:!0}),e.calculative.x=e.x,e.calculative.y=e.y,e.calculative.initRect&&(e.calculative.initRect.x=e.calculative.x,e.calculative.initRect.y=e.calculative.y,e.calculative.initRect.ex=e.calculative.x+e.calculative.width,e.calculative.initRect.ey=e.calculative.y+e.calculative.height);null==(o=e.onMove)||o.call(e,e)}))}calcAutoAnchor(e,t,i,n){const o=getFromAnchor(e),s=getToAnchor(e),r=nearestAnchor(i,t===o?s:o);r&&(t.x=r.x,t.y=r.y,t.prev=void 0,t.next=void 0,n?n.anchor=r.id:connectLine(i,r,e,t),this[e.lineName]&&this[e.lineName](this.store,e),this.store.path2dMap.set(e,globalStore.path2dDraws.line(e)),this.initLineRect(e))}restoreNodeAnimate(e){var t,i;if(e.calculative.initRect){if(e.keepAnimateState)for(const t in e)void 0!==e.calculative[t]&&("x"===t||"y"===t||"width"===t||"height"===t||"initRect"===t||"object"==typeof e[t]&&"lineDash"!==t||(e[t]="fontSize"===t||"lineWidth"===t?e.calculative[t]/e.calculative.canvas.store.data.scale:e.calculative[t]));else{const i=e.calculative.initRect.rotate-e.calculative.rotate;for(const t in e)"x"===t||"y"===t||"width"===t||"height"===t||"initRect"===t||"rotate"===t||"object"==typeof e[t]&&"lineDash"!==t||(e.calculative[t]=e[t]);(null==(t=e.children)?void 0:t.length)?i&&rotatePen(e,i,e.calculative.worldRect):e.calculative.rotate=e.rotate;const n=deepClone(this.store.animateMap.get(e));n&&(n.id=e.id,this.parent.setValue(n,{doEvent:!1,render:!0,history:!1})),e.calculative.worldRect=e.calculative.initRect}this.updatePenRect(e,{worldRectIsReady:!0}),this.updateLines(e),e.image&&"gif"!==e.name&&(this.canvasImage.init(),this.canvasImageBottom.init()),e.calculative.text!==e.text&&(e.calculative.text=e.text,calcTextLines(e)),(null==(i=this.store.active)?void 0:i.length)&&this.calcActiveRect(),e.calculative.initRect=void 0}}updateLines(e,t){var i;null==(i=e.children)||i.forEach((e=>{const i=this.store.pens[e];i&&this.updateLines(i,t)})),e.connectedLines&&e.connectedLines.forEach(((i,n)=>{const o=this.store.pens[i.lineId];if(!o||o.calculative.active)return;const s=getAnchor(o,i.lineAnchor);if(!s)return;if(!s.connectTo)return void e.connectedLines.splice(n,1);if(o.autoFrom){const t=getFromAnchor(o);t.id===s.id&&this.calcAutoAnchor(o,t,e,i)}if(o.autoTo){const t=getToAnchor(o);t.id===s.id&&this.calcAutoAnchor(o,t,e,i)}const r=getAnchor(e,i.anchor);if(!r)return;let a=e.rotate;e.flipX&&(a*=-1),e.flipY&&(a*=-1);let l=s.distance*this.store.data.scale*Math.cos((a+r.rotate)/180*Math.PI)||0,c=s.distance*this.store.data.scale*Math.sin((a+r.rotate)/180*Math.PI)||0;if(e.flipX&&(l=-l),e.flipY&&(c=-c),translatePoint(s,r.x-s.x+l,r.y-s.y+c),this.store.options.autoPolyline&&!this.autoPolylineFlag&&!1!==o.autoPolyline&&"polyline"===o.lineName){let e=getFromAnchor(o),t=getToAnchor(o),i=!1;e.id===s.id?(e=s,i=!0):t.id===s.id&&(t=s,i=!0),i&&(o.calculative.worldAnchors=[e,t],o.calculative.activeAnchor=e,this.polyline(this.store,o,t),this.initLineRect(o))}this.store.path2dMap.set(o,globalStore.path2dDraws[o.name](o)),this.patchFlagsLines.add(o),o.calculative.gradientSmooth&&(o.calculative.gradientAnimatePath=getGradientAnimatePath(o)),t&&getLineLength(o)}))}calcActiveRect(){const e=this.store.active.filter((e=>(!e.locked||e.locked<LockState.DisableMove)&&0!=e.visible));e.length&&(1===e.length?(this.activeRect=deepClone(e[0].calculative.worldRect),this.activeRect.rotate=e[0].calculative.rotate||0,calcCenter(this.activeRect)):(this.activeRect=getRect$1(e),this.activeRect.rotate=0),this.lastRotate=0,this.getSizeCPs())}rotatePen(e,t,i){e.type?(e.calculative.worldAnchors.forEach((e=>{rotatePoint(e,t,i.center)})),this.initLineRect(e),calcPenRect(e)):(e.calculative.rotate?e.calculative.rotate+=t:e.calculative.rotate=t,rotatePoint(e.calculative.worldRect.center,t,i.center),e.parentId?(e.calculative.worldRect.x=e.calculative.worldRect.center.x-e.calculative.worldRect.width/2,e.calculative.worldRect.y=e.calculative.worldRect.center.y-e.calculative.worldRect.height/2,e.x=(e.calculative.worldRect.x-i.x)/i.width,e.y=(e.calculative.worldRect.y-i.y)/i.height):(e.x=e.calculative.worldRect.center.x-e.width/2,e.y=e.calculative.worldRect.center.y-e.height/2),e.rotate=e.calculative.rotate,this.updatePenRect(e),e.children&&e.children.forEach((i=>{const n=this.store.pens[i];this.rotatePen(n,t,e.calculative.worldRect)})))}nextAnimate(e){if(!e)return;let t;this.store.emitter.emit("animateEnd",e),e.nextAnimate&&(t=this.store.data.pens.filter((t=>t.id===e.nextAnimate||t.tags&&t.tags.indexOf(e.nextAnimate)>-1))),t&&(t.forEach((e=>{var t,i,n,o,s;if(e.calculative.pause){const t=Date.now()-e.calculative.pause;e.calculative.pause=void 0,e.calculative.frameStart+=t,e.calculative.frameEnd+=t}else if("video"===e.name)e.calculative.media.currentTime=0,null==(t=e.calculative.media)||t.play(),null==(i=e.onStartVideo)||i.call(e,e);else if(e.type||(null==(n=e.frames)?void 0:n.length)||e.animations&&e.animations.length){if(e.type){if(null==(s=e.animations)?void 0:s.length){const t=deepClone(e.animations[0]);delete t.name,t.currentAnimation=0,this.parent.setValue({id:e.id,...t},{doEvent:!1,history:!1})}}else{if(!e.frames&&e.animations&&e.animations.length){let t=null==(o=e.animations)?void 0:o.findIndex((e=>e.autoPlay)),i=-1===t?0:t;const n=deepClone(e.animations[i]);delete n.name,n.currentAnimation=i,!e.type&&n.frames&&(n.showDuration=this.parent.calcAnimateDuration(n)),this.parent.setValue({id:e.id,...n},{doEvent:!1,history:!1})}this.store.animateMap.set(e,this.getFrameProps(e))}this.store.animates.add(e)}})),this.animate())}getFrameProps(e){let t={};return e.frames&&e.frames.forEach((i=>{for(let n in i)["duration","x","y","width","height","rotate"].includes(n)||t[n]||(t[n]=e[n])})),t}animate(){this.animateRendering||requestAnimationFrame((()=>{const e=Date.now();if(e-this.lastAnimateRender<this.store.options.animateInterval)return void(this.store.animates.size>0&&this.animate());this.lastAnimateRender=e,this.animateRendering=!0;const t=[];let i=!1;for(const n of this.store.animates)if(!n.calculative.pause){if(!n.calculative.active||n.type||this.movingPens||(i=!0),n.type){if(!setLineAnimate(n,e)){if(n.keepAnimateState){for(const e in n)void 0!==n.calculative[e]&&"length"!==e&&("object"==typeof n[e]&&"lineDash"!==e||(n[e]="lineWidth"===e?n.calculative[e]/n.calculative.canvas.store.data.scale:n.calculative[e]));calcPenRect(n)}else for(const e in n)"object"==typeof n[e]&&"lineDash"!==e||(n.calculative[e]="lineWidth"===e?n[e]*n.calculative.canvas.store.data.scale:n[e]);t.push(n),this.nextAnimate(n)}}else setNodeAnimate(n,e)?n.calculative.patchFlags&&(calcCenter(n.calculative.worldRect),this.updatePenRect(n,{worldRectIsReady:!0,playingAnimate:!0})):(requestAnimationFrame((()=>{this.restoreNodeAnimate(n)})),t.push(n),this.nextAnimate(n)),this.updateLines(n,!0);this.patchFlags=!0}i&&this.calcActiveRect(),t.forEach((e=>{this.store.animates.delete(e)})),this.render(!1),this.animateRendering=!1,this.animate()}))}get clipboardName(){return"meta2d-clipboard"}async copy(e,t=!0){const i=s8(),{origin:n,scale:o}=this.store.data;this.store.clipboard=void 0,localStorage.removeItem(this.clipboardName),sessionStorage.setItem("page",i);let s=this.getAllByPens(deepClone(e||this.store.active,!0));s.forEach((e=>{e.copyIndex=this.store.data.pens.findIndex((t=>t.id===e.id)),e.pathId&&(e.path=this.store.data.paths[e.pathId])})),s.sort(((e,t)=>e.copyIndex-t.copyIndex));const r={meta2d:!0,pens:s,origin:deepClone(n),scale:o,page:i,initRect:deepClone(this.activeRect),offset:10,mousePos:deepClone(this.mousePos)};if(!navigator.clipboard||this.store.options.disableClipboard||navigator.userAgent.includes("Firefox"))localStorage.setItem(this.clipboardName,JSON.stringify(r));else try{await navigator.clipboard.writeText(JSON.stringify(r))}catch{localStorage.setItem(this.clipboardName,JSON.stringify(r))}t&&this.store.emitter.emit("copy",r.pens)}cut(e){this.copy(e,!1),this.delete(e),this.store.emitter.emit("cut",e)}async paste(){var e,t;let i,n,o,s;if(!navigator.clipboard||this.store.options.disableClipboard||navigator.userAgent.includes("Firefox"))i=localStorage.getItem(this.clipboardName);else try{i=await(null==(e=navigator.clipboard)?void 0:e.readText())}catch{i=localStorage.getItem(this.clipboardName)}if(!i)return;try{n=JSON.parse(i)}catch(c){return}if(!n||!n.meta2d)return;if(this.beforeAddPens&&1!=await this.beforeAddPens(n.pens))return;this.store.clipboard&&(o=this.store.clipboard.offset+10,s=this.store.clipboard.pos),this.store.clipboard=deepClone(n);const r=sessionStorage.getItem("page"),a=this.store.data.scale;if(this.store.clipboard.mousePos&&(Math.abs(this.store.clipboard.mousePos.x-this.mousePos.x)>100*a||Math.abs(this.store.clipboard.mousePos.y-this.mousePos.y)>100*a)){let e=-this.store.clipboard.initRect.width/this.store.clipboard.scale/10/a,t=-this.store.clipboard.initRect.height/this.store.clipboard.scale/10/a,i=(a-this.store.clipboard.scale)*this.store.clipboard.initRect.width/2+e,n=(a-this.store.clipboard.scale)*this.store.clipboard.initRect.height/2+t;this.store.clipboard.pens.length>1&&(i=(a-1)*this.store.clipboard.initRect.width/this.store.clipboard.scale/2,n=(a-1)*this.store.clipboard.initRect.height/this.store.clipboard.scale/2),this.store.clipboard.pos={x:this.mousePos.x-i,y:this.mousePos.y-n},this.store.clipboard.offset=0}else r!==n.page?(this.store.clipboard.pos={x:this.mousePos.x,y:this.mousePos.y},this.store.clipboard.offset=0):this.pasteOffset?(o&&(this.store.clipboard.offset=o),s&&(this.store.clipboard.pos=s)):(this.store.clipboard.offset=0,this.pasteOffset=!0);(null==(t=this.keyOptions)?void 0:t.F)||this.store.clipboard.pens.forEach((e=>{delete e.copyIndex}));const l=this.store.clipboard.pens.filter((e=>!e.parentId));for(const h of l)this.pastePen(h,void 0);sessionStorage.setItem("page",n.page),this.active(l),this.pushHistory({type:EditType.Add,pens:this.store.clipboard.pens}),this.render(),this.store.emitter.emit("add",this.store.clipboard.pens),this.store.emitter.emit("paste",this.store.clipboard.pens)}getAllByPens(e){const t=[];for(const i of e)t.push(...deepClone(getAllChildren(i,this.store),!0));return t.concat(e)}getAllFollowersByPens(e,t=!0){const i=e;for(const n of e){let e=getAllFollowers(n,this.store);t&&(e=deepClone(e,!0));for(const t of e)i.find((e=>e.id===t.id))||i.push(t)}return i}setFollowers(e=this.store.active){if(e)if(e.length<2)e[0].followers=[];else{let t=e.map((e=>e.id));t.pop();const i=e[e.length-1];i.followers?t.forEach((e=>{i.followers.includes(e)||i.followers.push(e)})):i.followers=t}}changeLineAnchors(e,t,i){if(Array.isArray(t.connectedLines))for(let n=0;n<t.connectedLines.length;n++){const{lineId:o}=t.connectedLines[n],s=i.find((e=>e.id===o));if(s){const i=s.anchors[0],n=s.anchors[s.anchors.length-1];i.connectTo===e&&(i.connectTo=t.id),n.connectTo===e&&(n.connectTo=t.id)}else t.connectedLines.splice(n,1),n--}}changeNodeConnectedLine(e,t,i){var n;const o=[t.anchors[0],t.anchors[t.anchors.length-1]];for(const s of o){const o=s.connectTo;if(o){const r=i.find((e=>e.id===o));r?null==(n=r.connectedLines)||n.forEach((i=>{i.lineId===e&&(i.lineId=t.id,i.lineAnchor=s.id)})):(s.connectTo=void 0,s.prev&&(s.prev.connectTo=void 0),s.next&&(s.next.connectTo=void 0))}}}async delete(e=this.store.active,t=!1,i=!0){if(!e||!e.length)return;if(this.beforeRemovePens&&1!=await this.beforeRemovePens(e))return;if(t||(e=e.filter((e=>!e.locked))),!e||!e.length)return;const n=[];if(this._del(e,n,t),this.initImageCanvas(n),this.initTemplateCanvas(n),this.inactive(),this.clearHover(),this.render(),i){if(0===n.length)return;this.pushHistory({type:EditType.Delete,pens:n})}this.store.emitter.emit("delete",e)}_del(e,t,i){e&&e.forEach((e=>{if(e.type&&(e.lastConnected={}),e.parentId){if(this.getLockedParent(e))return;{const i=getParent(e),n=i.children.indexOf(e.id);i.children.splice(n,1),t&&this.getDelPens(e,t),this.delForce(e)}}else{if(!i&&e.locked)return;t&&this.getDelPens(e,t),this.delForce(e)}}))}getDelPens(e,t){if(!e)return;if(this.store.data.pens.findIndex((t=>t.id===e.id))>-1){const i=this.store.pens[e.id];i&&i.calculative&&(i.calculative.active=void 0),t.push(i)}e.children&&e.children.forEach((e=>{this.getDelPens(this.store.pens[e],t)}))}getLockedParent(e){if(!e.parentId)return!1;const t=getParent(e);if(t.locked)return t;this.getLockedParent(t)}delForce(e){var t;if(!e)return;const i=this.store.data.pens.findIndex((t=>t.id===e.id));i>-1&&(this.delConnectedLines(this.store.data.pens[i]),this.store.data.pens.splice(i,1),this.store.pens[e.id]=void 0,delete this.store.pens[e.id],e.pathId&&delete this.store.data.paths[e.pathId]),this.store.animates.delete(e),this.store.animateMap.delete(e),e.children&&e.children.forEach((e=>{this.delForce(this.store.pens[e])})),null==(t=e.onDestroy)||t.call(e,e)}delConnectedLines(e){var t;if(e.connectedLines)for(let i=0;i<e.connectedLines.length;i++){const{lineId:t,lineAnchor:n}=e.connectedLines[i],o=this.store.pens[t];if(o){let t=o.anchors.find((e=>e.id===n));(null==t?void 0:t.connectTo)===e.id&&(t.connectTo=void 0,t.anchorId=void 0,t.prev&&(t.prev.connectTo=void 0),t.next&&(t.next.connectTo=void 0)),t=getAnchor(o,n),t&&(t.connectTo=void 0,t.anchorId=void 0,t.prev&&(t.prev.connectTo=void 0),t.next&&(t.next.connectTo=void 0))}}e.type&&(null==(t=e.calculative.worldAnchors)||t.forEach(((t,i)=>{var n;if(!t.connectTo)return;const o=this.store.pens[t.connectTo];o&&(null==(n=o.calculative.worldAnchors)||n.forEach((i=>{disconnectLine(o,i,e,t)})))})))}convertSpecialCharacter(e){var t={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return e.replace(/&(lt|gt|nbsp|amp|quot);/gi,(function(e,i){return t[i]}))}createInput(){let e;this.inputParent.classList.add("meta2d-input"),this.inputDiv.classList.add("input-div"),this.inputParent.appendChild(this.inputDiv),this.dropdown.onmouseleave=()=>{this.store.hover=null},this.inputParent.appendChild(this.dropdown),this.externalElements.appendChild(this.inputParent),this.inputParent.onmousedown=this.stopPropagation,this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.contentEditable="false",this.dropdown.onmousedown=this.stopPropagation;for(let t=0;t<document.styleSheets.length;t++)"le5le.com"===document.styleSheets[t].title&&(e=document.styleSheets[t]);if(!e){const t=document.createElement("style");t.title="le5le.com",document.head.appendChild(t),e=t.sheet,e.insertRule(".meta2d-input{display:none;position:absolute;outline:none;align-items: center;}"),e.insertRule(".meta2d-input textarea{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;left:0;top:0}"),e.insertRule(".meta2d-input .right{width:10px;height:10px;flex-shrink:0;border-top: 1px solid;border-right: 1px solid;margin-right: 5px;transition: all .3s cubic-bezier(.645,.045,.355,1);position:absolute;right:1px;}"),e.insertRule(".meta2d-input ul{position:absolute;top:100%;margin-top:4px; width:calc(100% + 10px);min-height:30px;border-radius: 2px;box-shadow: 0 2px 8px #00000026;list-style-type: none;background-color: #fff;padding: 4px 0;max-height: 105px;overflow-y: auto;}"),e.insertRule(".meta2d-input ul li{padding: 5px 12px;line-height: 22px;white-space: nowrap;cursor: pointer;}"),e.insertRule(".meta2d-input ul li:hover{background: #eeeeee;}"),e.insertRule(".input-div::-webkit-scrollbar {display:none}"),e.insertRule(".input-div{scrollbar-width: none;}"),e.insertRule(".meta2d-input .input-div{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;width: 100%;left:0;top:0;display:flex;text-align: center;justify-content: center;flex-direction: column;}"),e.insertRule(".input-div div{}")}this.inputDiv.onfocus=e=>{if(navigator.userAgent.includes("Firefox")){if(!e.target.innerText){let e=this.inputDiv.offsetWidth/2;"center"!==window.getComputedStyle(this.inputDiv,null).textAlign&&(e=0),this.inputDiv.innerHTML=`<br style="margin-left:${e}px;margin-top:4px;" />`}}else if(e.target.innerText)this.inputDiv.style.paddingTop="";else{let e=window.getComputedStyle(this.inputDiv,null);"center"===e.justifyContent&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(e.lineHeight)/2}px`)}},this.inputDiv.onblur=()=>{setTimeout((()=>{this.hideInput()}),300)},this.inputDiv.oninput=e=>{const t=this.store.pens[this.inputDiv.dataset.penId];if(t&&"number"===t.inputType){const t=e.target.innerText,i=t.replace(/[^0-9]/g,"");t!==i&&(e.preventDefault(),e.target.innerText=i)}if(navigator.userAgent.includes("Firefox")){if(!e.target.innerText.trim()){let e=this.inputDiv.offsetWidth/2;"center"!==window.getComputedStyle(this.inputDiv,null).textAlign&&(e=0),this.inputDiv.innerHTML=`<br style="margin-left:${e}px;margin-top:4px;" />`}}else if(e.target.innerText)this.inputDiv.style.paddingTop="";else{let e=window.getComputedStyle(this.inputDiv,null);"center"===e.justifyContent&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(e.lineHeight)/2}px`)}this.store.emitter.emit("input",t)},this.inputDiv.onclick=e=>{e.stopPropagation();const t=this.store.pens[this.inputDiv.dataset.penId];"block"===this.dropdown.style.display?this.dropdown.style.display="none":(null==t?void 0:t.dropdownList)&&this.store.data.locked&&(this.dropdown.style.display="block"),this.store.emitter.emit("clickInput",t)},this.inputDiv.onkeyup=e=>{this.setDropdownList(!0);const t=this.store.pens[this.inputDiv.dataset.penId];this.store.emitter.emit("input",{pen:t,text:e.key}),e.stopPropagation()},this.inputDiv.onkeydown=e=>{e.stopPropagation()},this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.onwheel=e=>{e.stopPropagation()},this.inputDiv.onpaste=e=>{e.preventDefault();let t="";e.clipboardData&&e.clipboardData.getData&&(t=e.clipboardData.getData("text/plain")),document.execCommand("insertHTML",!1,t)}}clearDropdownList(){if(this.dropdown.hasChildNodes())for(let e=0;e<this.dropdown.childNodes.length;e++)this.dropdown.childNodes[e].remove(),--e}dropdownAppendOption(e,t){const i=document.createElement("li");i.onwheel=this.stopPropagation,i.innerText=e,i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.title=e,i.style.zoom=this.store.data.scale,i.onmousedown=this.stopPropagation,i.dataset.i=t+"",i.onclick=this.selectDropdown;const n=this.store.pens[this.inputDiv.dataset.penId];i.onmouseenter=()=>{i.style.background=n.dropdownHoverBackground||this.store.styles.activeBg||"#eee",i.style.color=n.dropdownHoverColor||"#bdc7db"},i.onmouseleave=()=>{i.style.background=n.dropdownBackground||this.store.styles.popContentBg||"#fff",i.style.color=n.dropdownColor||"#bdc7db"},this.dropdown.appendChild(i)}find(e){return this.store.data.pens.filter((t=>t.id==e||t.tags&&t.tags.indexOf(e)>-1))}findOne(e){return this.store.data.pens.find((t=>t.id==e||t.tags&&t.tags.indexOf(e)>-1))}changePenId(e,t){var i,n,o,s,r,a,l;if(e===t)return;const c=this.store.pens[e];if(c&&!this.store.pens[t]){if(c.id=t,this.store.pens[t]=this.store.pens[e],null==(i=c.onChangeId)||i.call(c,c,e,t),delete this.store.pens[e],c.parentId){const i=this.store.pens[c.parentId],s=null==(n=i.children)?void 0:n.findIndex((t=>t===e));-1!==s&&(null==(o=i.children)||o.splice(s,1,t))}null==(s=c.children)||s.forEach((e=>{this.store.pens[e].parentId=t})),c.formId&&c.followers.forEach((e=>{this.store.pens[e].formId=t})),c.type===PenType.Line?this.changeNodeConnectedLine(e,c,this.store.data.pens):(this.changeLineAnchors(e,c,this.store.data.pens),null==(r=c.connectedLines)||r.forEach((({lineId:e})=>{calcWorldAnchors(this.store.pens[e])}))),null==(a=c.anchors)||a.forEach((e=>e.penId=t)),null==(l=c.calculative.worldAnchors)||l.forEach((e=>e.penId=t))}}updateValue(e,t){var i,n;const o=this.getPenRect(e),s=e.name;Object.assign(e,t);const r=s!==e.name;t.newId&&this.changePenId(e.id,t.newId);let a,l=!1,c=!1,h=!1,d=!1,u=!1,p=!1,f=!1;for(const v in t)-1===v.indexOf(".")?("rotate"===v?e.disableRotate?e.rotate=e.calculative.rotate||0:a=e.calculative.rotate||0:"canvasLayer"===v||"isBottom"===v||"showChild"===v?p=!0:"image"===v&&(f=!0),"object"==typeof e[v]&&"lineDash"!==v||e.disableRotate&&"rotate"===v||(e.calculative[v]=t[v]),needCalcTextRectProps.includes(v)&&(c=!0),["name","borderRadius","lineSmooth","close"].includes(v)&&(l=!0),needSetPenProps.includes(v)&&(u=!0),needPatchFlagsPenRectProps.includes(v)&&(h=!0),needCalcIconRectProps.includes(v)&&(d=!0),e.image&&"gif"!==e.name&&["globalAlpha","flipY","flipX","x","y","width","height","iconWidth","iconHeight","imageRatio","iconLeft","iconTop","iconAlign","rotate","visible"].includes(v)&&(f=!0)):(delete e[v],setter(e,v,t[v])),"anchors"===v.split(".")[0]&&calcWorldAnchors(e);if(this.setCalculativeByScale(e),r&&(null==(i=e.onDestroy)||i.call(e,e),clearLifeCycle(e)),u){const i={x:t.x??o.x,y:t.y??o.y,width:t.width??o.width,height:t.height??o.height};this.setPenRect(e,i,!1),this.updateLines(e,!0),this.store.active&&this.store.active.length&&e.id===this.store.active[0].id&&this.calcActiveRect()}else h?this.updatePenRect(e):(c&&calcTextRect(e),d&&calcIconRect(this.store.pens,e),l&&globalStore.path2dDraws[e.name]&&this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e)));if(void 0!==a){const t=e.calculative.rotate;e.calculative.rotate=a,this.rotatePen(e,t-a,e.calculative.worldRect)}(t.image||t.backgroundImage||t.strokeImage)&&(e.calculative.image=void 0,e.calculative.backgroundImage=void 0,e.calculative.strokeImage=void 0,this.loadImage(e)),t.lineGradientColors&&(e.calculative.lineGradient=void 0,e.calculative.gradientColorStop=void 0),t.gradientColors&&(e.calculative.gradient=void 0,e.calculative.radialGradient=void 0),t.gradientRadius&&(e.calculative.gradient=void 0,e.calculative.radialGradient=void 0),t.animateLineWidth&&(e.calculative.gradientAnimatePath=void 0),t.gradientSmooth&&(e.calculative.gradientAnimatePath=void 0),p?(this.canvasImage.init(),this.canvasImageBottom.init()):f&&(void 0===e.canvasLayer&&(e.canvasLayer=CanvasLayer.CanvasImageBottom,e.calculative.canvasLayer=CanvasLayer.CanvasImageBottom),e.canvasLayer===CanvasLayer.CanvasImageBottom?this.canvasImageBottom.init():e.canvasLayer===CanvasLayer.CanvasImage&&this.canvasImage.init()),void 0===t.canvasLayer&&e.canvasLayer!==CanvasLayer.CanvasTemplate||this.initTemplateCanvas([e]),void 0!==t.zIndex&&(null==(n=e.calculative.singleton)?void 0:n.div)&&setElemPosition(e,e.calculative.singleton.div)}execPenResize(e){var t,i;null==(t=e.onResize)||t.call(e,e),null==(i=e.children)||i.forEach((e=>{const t=this.store.pens[e];t&&this.execPenResize(t)}))}setPenRect(e,t,i=!0){if(e.parentId)Object.assign(e,t);else{const{origin:i,scale:n}=this.store.data;e.x=i.x+t.x*n,e.y=i.y+t.y*n,e.width=t.width*n,e.height=t.height*n}this.updatePenRect(e),this.execPenResize(e),i&&this.render()}getPenRect(e,t=this.store.data.origin,i=this.store.data.scale){if(e)return e.parentId?{x:e.x,y:e.y,width:e.width,height:e.height}:{x:(e.x-t.x)/i,y:(e.y-t.y)/i,width:e.width/i,height:e.height/i}}toPng(e=2,t,i=!1,n){const o=getRect$1(this.store.data.pens),s=this.store.data.scale;if(!isFinite(o.width))throw new Error("can not to png, because width is not finite");const r=deepClone(o),a=this.store.data,l=i&&this.store.bkImg;let c=!1,h=!1;if(l){if(o.x+=a.x,o.y+=a.y,calcRightBottom(o),rectInRect(o,this.canvasRect,!0))Object.assign(o,this.canvasRect);else{const e=getRectOfPoints([...rectToPoints(o),...rectToPoints(this.canvasRect)]);Object.assign(o,e)}c=0===o.x,h=0===o.y}const d=this.store.data.width||this.store.options.width,u=this.store.data.height||this.store.options.height;let p=!1;d&&u&&!this.store.data.component&&(p=!0),p&&(o.x=this.store.data.origin.x,o.y=this.store.data.origin.y,o.width=d*this.store.data.scale,o.height=u*this.store.data.scale);const f=deepClone(o),v=formatPadding(e);o.x-=v[3]*s,o.y-=v[0]*s,o.width+=(v[3]+v[1])*s,o.height+=(v[0]+v[2])*s;const g=(n||1920)/o.width;o.width*=g,o.height*=g,calcRightBottom(o);const y=document.createElement("canvas");if(y.width=o.width,y.height=o.height,y.width>32767||y.height>32767||!navigator.userAgent.includes("Firefox")&&y.height*y.width>268435456||navigator.userAgent.includes("Firefox")&&y.height*y.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const m=y.getContext("2d");m.textBaseline="middle",m.scale(g,g);const w=this.store.data.background||this.store.styles.background;if(w&&p&&(m.save(),m.fillStyle=w,m.fillRect(0,0,f.width+(v[1]+v[3])*s,f.height+(v[0]+v[2])*s),m.restore()),l)if(p)m.drawImage(this.store.bkImg,v[3]*s||0,v[0]*s||0,f.width,f.height);else{const e=o.x<0?-o.x:0,t=o.y<0?-o.y:0;m.drawImage(this.store.bkImg,e,t,this.canvasRect.width,this.canvasRect.height)}if(w&&!p)if(l){const e=o.x<0?-o.x:0,t=o.y<0?-o.y:0;m.save(),m.fillStyle=w,m.fillRect(e,t,this.canvasRect.width,this.canvasRect.height),m.restore()}else m.save(),m.fillStyle=w,m.fillRect(0,0,r.width+(v[3]+v[1])*s,r.height+(v[0]+v[2])*s),m.restore();l?p?m.translate(-o.x,-o.y):m.translate((c?a.x:-r.x)+v[3]*s||0,(h?a.y:-r.y)+v[0]*s||0):m.translate(-o.x,-o.y);for(const b of this.store.data.pens){if(!isShowChild(b,this.store)||0==b.visible)continue;if("combine"===b.name&&!b.draw)continue;const{active:e}=b.calculative;b.calculative.active=!1,b.calculative.img?renderPenRaw$1(m,b):renderPen(m,b,!0),b.calculative.active=e}if(!t)return y.toDataURL();y.toBlob(t)}activeToPng(e=2,t){return this.pensToPng(this.store.active,e,t)}pensToPng(e=this.store.active,t=2,i){if(0===e.length)return;const n=this.getAllByPens(e);let o=n.map((e=>e.id));const s=getRect$1(n);if(!isFinite(s.width))throw new Error("can not to png, because width is not finite");const r=deepClone(s),a=formatPadding(t);s.x-=a[3],s.y-=a[0],s.width+=a[3]+a[1],s.height+=a[0]+a[2],calcRightBottom(s);const l=(i||s.width)/s.width;s.width*=l,s.height*=l;const c=document.createElement("canvas");if(c.width=s.width,c.height=s.height,c.width>32767||c.height>32767||!navigator.userAgent.includes("Firefox")&&c.height*c.width>268435456||navigator.userAgent.includes("Firefox")&&c.height*c.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const h=c.getContext("2d");h.textBaseline="middle",h.scale(l,l);const d=this.store.data.background||this.store.styles.background;d&&(h.save(),h.fillStyle=d,h.fillRect(0,0,r.width+(a[3]+a[1]),r.height+(a[0]+a[2])),h.restore()),h.translate(-r.x+a[3],-r.y+a[0]);for(const u of this.store.data.pens)if(o.includes(u.id)){if(!isShowChild(u,this.store)||0==u.visible)continue;if("combine"===u.name&&!u.draw)continue;const{active:e}=u.calculative;u.calculative.active=!1,u.calculative.img?renderPenRaw$1(h,u):renderPen(h,u),u.calculative.active=e}return c.toDataURL()}toggleAnchorMode(){var e;if(this.hotkeyType)this.hotkeyType===HotkeyType.AddAnchor&&(this.hotkeyType=HotkeyType.None,this.store.hoverAnchor?this.externalElements.style.cursor="vertical-text":this.store.hover&&(this.externalElements.style.cursor="move"));else{if(this.store.options.disableAnchor||(null==(e=this.store.hover)?void 0:e.disableAnchor))return;this.hotkeyType=HotkeyType.AddAnchor,this.store.hover&&(this.externalElements.style.cursor="pointer")}this.patchFlags=!0}addAnchorHand(){if(this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){const e=[deepClone(this.store.active[0],!0)];this.store.activeAnchor.prev?this.store.activeAnchor.next||(this.store.activeAnchor.next={...this.store.activeAnchor.prev},rotatePoint(this.store.activeAnchor.next,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.next||(this.store.activeAnchor.next={penId:this.store.activeAnchor.penId,x:this.store.activeAnchor.x+50,y:this.store.activeAnchor.y}),this.store.activeAnchor.prev={...this.store.activeAnchor.next},rotatePoint(this.store.activeAnchor.prev,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:EditType.Update,pens:[deepClone(this.store.active[0],!0)],initPens:e})}}removeAnchorHand(){if(this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){const e=[deepClone(this.store.active[0],!0)];this.hoverType===HoverType.LineAnchorPrev?(this.store.activeAnchor.prev=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):this.hoverType===HoverType.LineAnchorNext?(this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.prev=void 0,this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:EditType.Update,pens:[deepClone(this.store.active[0])],initPens:e})}}toggleAnchorHand(){1===this.store.active.length&&this.store.active[0].type&&this.store.activeAnchor&&(this.store.activeAnchor.prevNextType||(this.store.activeAnchor.prevNextType=PrevNextType.Mirror),this.store.activeAnchor.prevNextType=(this.store.activeAnchor.prevNextType+1)%3)}gotoView(e,t){let i=getRect$1(this.store.data.pens);if(!isFinite(i.width))throw new Error("can not move view, because width is not finite");const n=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;n&&o&&(i={x:this.store.data.origin.x,y:this.store.data.origin.y,width:n*this.store.data.scale,height:o*this.store.data.scale}),this.store.data.x=this.canvas.clientWidth/2-e*i.width-i.x,this.store.data.y=this.canvas.clientHeight/2-t*i.height-i.y,this.onMovePens(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()}showMagnifier(){this.magnifierCanvas.canvas.style.zIndex="100",this.externalElements.style.zIndex="101",this.magnifierCanvas.magnifier=!0,this.magnifierCanvas.updateDomOffscreen(),this.externalElements.style.cursor="default",this.render()}hideMagnifier(){this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.zIndex="5",this.magnifierCanvas.magnifier=!1,this.externalElements.style.cursor="default",this.magnifierCanvas.render(),this.render()}showFit(){this.store.data.locked=0,this.canvasImage.fitFlag=!0,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach((e=>e.active=!1)),this.canvasImage.init(),this.canvasImage.render()}hideFit(){this.canvasImage.fitFlag=!1,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.canvasImage.init(),this.canvasImage.render()}makeFit(){if(this.dragRect.width<100&&this.dragRect.height<100)return;const e=this.store.data.pens.filter((e=>!e.parentId&&!e.isRuleLine&&(rectInRect(e.calculative.worldRect,this.dragRect,!0)?!(e.type===PenType.Line&&!this.store.options.dragAllIn)||lineInRect(e,this.dragRect):void 0)));if(!e.length)return;const t=this.parent.getRect(e),i=this.store.data.scale,n=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;let s={x:(Math.floor(t.x)-this.store.data.origin.x)/i/n,y:(Math.floor(t.y)-this.store.data.origin.y)/i/o,width:(Math.ceil(t.width)+1)/i/n,height:(Math.ceil(t.height)+1)/i/o,children:e.map((e=>e.id)),id:s8(),active:!0};s.x<-.1&&(s.x=-.1),s.y<-.1&&(s.y=-.1),s.width>.5?(s.left=!0,s.right=!0,s.leftValue=(s.x-0)*i*n,s.rightValue=(1-(s.x+s.width))*i*n):s.x<.5?(s.left=!0,s.leftValue=(s.x-0)*i*n):(s.right=!0,s.rightValue=(1-(s.x+s.width))*i*n),s.leftValue<1&&(s.leftValue=0),s.rightValue<1&&(s.rightValue=0),s.height>.5?(s.top=!0,s.bottom=!0,s.topValue=(s.y-0)*i*o,s.bottomValue=(1-(s.y+s.height))*i*o):s.y<.5?(s.top=!0,s.topValue=(s.y-0)*i*o):(s.bottom=!0,s.bottomValue=(1-(s.y+s.height))*i*o),s.topValue<1&&(s.topValue=0),s.bottomValue<1&&(s.bottomValue=0),this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach((e=>{e.active=!1})),this.store.data.fits.push(s),this.canvasImage.activeFit=s,this.store.emitter.emit("fit",s),this.canvasImage.init(),this.canvasImage.render()}updateFit(e){const t=this.store.data.scale,i=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height;let o=(e.x-this.store.data.origin.x)/t/i,s=(e.y-this.store.data.origin.y)/t/n;if(this.canvasImage.currentFit){const r=this.canvasImage.activeFit;if("top"===this.canvasImage.currentFit){s<-.1&&(s=-.1);let e=s-r.y;if(r.height-=e,r.height<.01)return void(r.height=.01);r.y=s}if("bottom"===this.canvasImage.currentFit&&(s>1.1&&(s=1.1),r.height=s-r.y,r.height<=.01&&(r.height=.01)),"left"===this.canvasImage.currentFit){o<-.1&&(o=-.1);let e=o-r.x;if(r.width-=e,r.width<.01)return void(r.width=.01);r.x=o}"right"===this.canvasImage.currentFit&&(o>1.1&&(o=1.1),r.width=o-r.x,r.width<=.01&&(r.width=.01));let a={x:r.x*i*t+this.store.data.origin.x,y:r.y*n*t+this.store.data.origin.y,width:r.width*i*t,height:r.height*n*t};calcRightBottom(a);const l=this.store.data.pens.filter((e=>!e.parentId&&!e.isRuleLine&&(rectInRect(e.calculative.worldRect,a,!0)?!(e.type===PenType.Line&&!this.store.options.dragAllIn)||lineInRect(e,a):void 0)));r.left=void 0,r.leftValue=void 0,r.right=void 0,r.rightValue=void 0,r.top=void 0,r.topValue=void 0,r.bottom=void 0,r.bottomValue=void 0,r.width>.5?(r.left=!0,r.right=!0,r.leftValue=(r.x-0)*t*i,r.rightValue=(1-(r.x+r.width))*t*i):r.x<.5?(r.left=!0,r.leftValue=(r.x-0)*t*i):(r.right=!0,r.rightValue=(1-(r.x+r.width))*t*i),Math.abs(r.leftValue)<1&&(r.leftValue=0),Math.abs(r.rightValue)<1&&(r.rightValue=0),r.height>.5?(r.top=!0,r.bottom=!0,r.topValue=(r.y-0)*t*n,r.bottomValue=(1-(r.y+r.height))*t*n):r.y<.5?(r.top=!0,r.topValue=(r.y-0)*t*n):(r.bottom=!0,r.bottomValue=(1-(r.y+r.height))*t*n),Math.abs(r.topValue)<1&&(r.topValue=0),Math.abs(r.bottomValue)<1&&(r.bottomValue=0),r.children=l.map((e=>e.id)),this.store.emitter.emit("fit",r),this.mouseDown.x=e.x,this.mouseDown.y=e.y,this.canvasImage.init(),this.canvasImage.render()}}updateFitRect(e=this.canvasImage.activeFit){const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;e.left&&(e.leftValue?e.x=Math.abs(e.leftValue)<1?e.leftValue:e.leftValue/t:e.x=0),e.right&&(e.rightValue?e.width=1-(Math.abs(e.rightValue)<1?e.rightValue:e.rightValue/t)-e.x:e.width=1-e.x),e.top&&(e.topValue?e.y=Math.abs(e.topValue)<1?e.topValue:e.topValue/i:e.y=0),e.bottom&&(e.bottomValue?e.height=1-(Math.abs(e.bottomValue)<1?e.bottomValue:e.bottomValue/i)-e.y:e.height=1-e.y),this.canvasImage.init(),this.canvasImage.render()}deleteFit(e=this.canvasImage.activeFit){if(!e)return;const t=this.store.data.fits.findIndex((t=>t.id===e.id));this.store.data.fits.splice(t,1),this.canvasImage.activeFit=void 0,this.canvasImage.init(),this.canvasImage.render(),this.store.emitter.emit("fit",void 0)}calcuActiveFit(){var e;const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;let n=(this.mouseDown.x-this.store.data.origin.x)/this.store.data.scale/t,o=(this.mouseDown.y-this.store.data.origin.y)/this.store.data.scale/i,s=-1,r=-1;null==(e=this.store.data.fits)||e.forEach(((e,t)=>{e.ex=null,e.ey=null,pointInRect({x:n,y:o},e)&&(s=t),e.active&&(r=t)})),-1!==s&&s!==r?(this.canvasImage.activeFit=this.store.data.fits[s],this.store.data.fits[s].active=!0,-1!==r&&(this.store.data.fits[r].active=!1),this.store.emitter.emit("fit",this.store.data.fits[s])):-1===s&&-1!==r&&(this.store.data.fits[r].active=!1,this.store.emitter.emit("fit",void 0),this.canvasImage.activeFit=null),this.inactive(),this.canvasImage.init(),this.canvasImage.render()}toggleMagnifier(){this.magnifierCanvas.magnifier=!this.magnifierCanvas.magnifier,this.magnifierCanvas.magnifier&&(this.externalElements.style.cursor="default"),this.render()}destroy(){var e,t,i,n;switch(this.scroll&&this.scroll.destroy(),null==(e=this.tooltip)||e.destroy(),null==(t=this.dialog)||t.destroy(),null==(i=this.title)||i.destroy(),null==(n=this.popconfirm)||n.destroy(),this.externalElements.removeEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=e=>e.preventDefault(),this.externalElements.ondrop=void 0,this.externalElements.ontouchstart=void 0,this.externalElements.ontouchmove=void 0,this.externalElements.ontouchend=void 0,this.externalElements.onmousedown=void 0,this.externalElements.onmousemove=void 0,this.externalElements.onmouseup=void 0,this.externalElements.onmouseleave=void 0,this.externalElements.ondblclick=void 0,this.store.options.keydown){case KeydownType.Document:document.removeEventListener("keydown",this.onkeydown),document.removeEventListener("keyup",this.onkeyup);break;case KeydownType.Canvas:this.externalElements.removeEventListener("keydown",this.onkeydown),this.externalElements.removeEventListener("keyup",this.onkeyup)}document.removeEventListener("copy",this.onCopy),document.removeEventListener("cut",this.onCut),document.removeEventListener("paste",this.onPaste),window&&window.removeEventListener("message",this.onMessage),window&&window.removeEventListener("resize",this.onResize),window&&window.removeEventListener("scroll",this.onScroll),this.parentElement.innerHTML=""}}function form(e,t){const i=t||new Path2D;e.onDestroy||(e.onDestroy=destory$1,e.onMove=move$1,e.onRotate=move$1,e.onMouseEnter=mouseEnter,e.onMouseLeave=mouseLeave,e.onMouseMove=mouseMove,e.onMouseUp=mouseUp,e.onInput=input),e.formId=e.id;let n=e.calculative.borderRadius||0,o=n;const{x:s,y:r,width:a,height:l,ex:c,ey:h}=e.calculative.worldRect;e.calculative.worldTextRect,n<1&&(n*=a,o*=l);let d=n<o?n:o;if(a<2*d&&(d=a/2),l<2*d&&(d=l/2),i.moveTo(s+d,r),i.arcTo(c,r,c,h,d),i.arcTo(c,h,s,h,d),i.arcTo(s,h,s,r,d),i.arcTo(s,r,c,r,d),i instanceof Path2D)return i}function input(e,t){e.text=t,e.calculative.text=e.text,e.calculative.canvas.updatePenRect(e)}function destory$1(e){}function move$1(e){}function mouseEnter(e){}function mouseLeave(e){const t=e.calculative.canvas.store.active;t&&t.length&&t.forEach((t=>{if(e.followers){let i=e.followers.findIndex((e=>e===t.id));if(-1!==i){const n=e.calculative.canvas.store.pens[t.id+movingSuffix];if(n&&n.calculative){rectInRect(n.calculative.worldRect,e.calculative.worldRect,!0)||(e.followers.splice(i,1),delete t.formId)}}}}))}function mouseUp(e){const t=e.calculative.canvas.store.active;t&&t.length&&t.forEach((t=>{const i=e.calculative.canvas.store.pens[t.id+movingSuffix];if(i&&i.calculative){let n=deepClone(e.calculative.worldRect);n.x-=1,n.y-=1,n.width+=2,n.height+=2,rectInRect(i.calculative.worldRect,n,!0)&&(e.followers||(e.followers=[]),e.followers.includes(t.id)||e.followers.push(t.id),t.formId=e.id)}}))}function mouseMove(e,t){}function updateFormData(e,t){if(e.formId&&e.formKey&&e.formValue){const t=e.calculative.canvas.store.pens[e.formId];t&&(t.formData||(t.formData={}),t.formData[e.formKey]=e[e.formValue])}}function reset(e){const t=e.calculative.canvas.store.pens[e.formId];t.followers.forEach((i=>{const n=e.calculative.canvas.store.pens[i];if(n.formId&&n.formKey&&t.formData[n.formKey]){const t=n[n.formValue];let i="";Array.isArray(t)&&(i=[]),e.calculative.canvas.parent.setValue({id:n.id,[n.formValue]:i},{render:!1,doEvent:!1,history:!1})}})),t.formData={},e.calculative.canvas.parent.render()}const gifsList={};function gif(e){e.onDestroy||(e.onDestroy=destory,e.onMove=move,e.onResize=resize$1,e.onRotate=move,e.onValue=value$1,e.onChangeId=changeId);const t=new Path2D;if(!e.image)return;const i=e.calculative.canvas.store.id+"-"+e.id;if(!gifsList[i]){const t=new Image;t.crossOrigin="anonymous",t.src=e.image,e.calculative.canvas.parent.store.options.cdn&&!(e.image.startsWith("http")||e.image.startsWith("//")||e.image.startsWith("data:image"))&&(t.src=e.calculative.canvas.parent.store.options.cdn+e.image),gifsList[i]=t,t.onload=()=>{var n;gifsList[i]===t&&(e.calculative.img=t,e.calculative.imgNaturalWidth=t.naturalWidth||e.iconWidth,e.calculative.imgNaturalHeight=t.naturalHeight||e.iconHeight,null==(n=e.calculative.canvas.externalElements)||n.parentElement.appendChild(t),setImagePosition(e,t))}}return e.calculative.patchFlags&&gifsList[i]&&setImagePosition(e,gifsList[i]),t}function destory(e){const t=e.calculative.canvas.store.id+"-"+e.id;gifsList[t]&&(gifsList[t].remove(),gifsList[t]=void 0)}function move(e){const t=e.calculative.canvas.store.id+"-"+e.id;gifsList[t]&&setImagePosition(e,gifsList[t])}function resize$1(e){const t=e.calculative.canvas.store.id+"-"+e.id;gifsList[t]&&setImagePosition(e,gifsList[t])}function value$1(e){const t=e.calculative.canvas.store.id+"-"+e.id;gifsList[t]&&(setImagePosition(e,gifsList[t]),gifsList[t].getAttribute("src")!==e.image&&(gifsList[t].src=e.image))}function changeId(e,t,i){const n=e.calculative.canvas.store.id;gifsList[n+"-"+t]&&(gifsList[n+"-"+i]=gifsList[n+"-"+t],delete gifsList[n+"-"+t])}function setImagePosition(e,t){t.style.objectFit=e.imageRatio?"contain":"fill",setElemPosition(e,t)}function mindNode(e,t){return e.onResize||(e.onResize=resize,e.onValue=value),rectangle(e,t)}function resize(e){const t=e.anchors.filter((e=>1!==e.flag));mindNodeAnchors(e),e.anchors=e.anchors.concat(...t)}function value(e){resize(e),calcWorldAnchors(e)}function mindNodeAnchors(e){const t=[],{x:i,y:n,width:o,height:s}=e,r=borderRadius(e);for(let a=0;a<5;a++){if(2===a)continue;let l=i+o*(a+1)/6,c=n;l<i+r?c=getYByCircle(i+r,c+r,l,r,-1):l>i+o-r&&(c=getYByCircle(i+o-r,c+r,l,r,-1)),t.push({id:String(t.length),flag:1,penId:e.id,x:(l-i)/o,y:(c-n)/s})}for(let a=0;a<3;a++){let l=n+s*(a+1)/4,c=i+o;l<n+r?c=getXByCircle(c-r,n+r,l,r):l>n+s-r&&(c=getXByCircle(c-r,n+s-r,l,r)),t.push({id:String(t.length),flag:1,penId:e.id,x:(c-i)/o,y:(l-n)/s})}for(let a=0;a<5;a++){if(2===a)continue;let l=i+o*(a+1)/6,c=n+s;l<i+r?c=getYByCircle(i+r,c-r,l,r):l>i+o-r&&(c=getYByCircle(i+o-r,c-r,l,r)),t.push({id:String(t.length),flag:1,penId:e.id,x:(l-i)/o,y:(c-n)/s})}for(let a=0;a<3;a++){let l=n+s*(a+1)/4,c=i;l<n+r?c=getXByCircle(c+r,n+r,l,r,-1):l>n+s-r&&(c=getXByCircle(c+r,n+s-r,l,r,-1)),t.push({id:String(t.length),flag:1,penId:e.id,x:(c-i)/o,y:(l-n)/s})}e.anchors=t}function borderRadius(e){let t=e.calculative.borderRadius||0,i=e.calculative.borderRadius||0;const{width:n,height:o}=e;e.calculative.borderRadius<1&&(t=n*e.calculative.borderRadius,i=o*e.calculative.borderRadius);let s=t<i?t:i;return n<2*s&&(s=n/2),o<2*s&&(s=o/2),s}function getXByCircle(e,t,i,n,o=1){return o*Math.sqrt(n**2-(i-t)**2)+e}function getYByCircle(e,t,i,n,o=1){return o*Math.sqrt(n**2-(i-e)**2)+t}function mindLine(e,t){const i=t||new Path2D,{x:n,y:o,width:s,height:r}=e.calculative.worldRect;if(i.moveTo(n,o+r),i.lineTo(n+s,o+r),i.closePath(),i instanceof Path2D)return i}function mindLineAnchors(e){e.anchors=[{x:0,y:1},{x:1,y:1}].map((({x:t,y:i},n)=>({id:n+"",x:t,y:i,penId:e.id})))}function commonPens(){return{rectangle:rectangle,square:square,circle:circle,svgPath:svgPath,diamond:diamond,triangle:triangle,pentagon:pentagon,pentagram:pentagram,hexagon:hexagon,leftArrow:leftArrow,rightArrow:rightArrow,twowayArrow:twowayArrow,message:message,cloud:cloud,file:file,people:people,line:line,iframe:iframe,video:video,gif:gif,mindNode:mindNode,mindLine:mindLine,mindNode2:rectangle,form:form,combine:rectangle}}function commonAnchors(){return{triangle:triangleAnchors,pentagon:pentagonAnchors,pentagram:pentagramAnchors,mindNode:mindNodeAnchors,mindLine:mindLineAnchors}}var EventAction,EventAction2;EventAction2=EventAction||(EventAction={}),EventAction2[EventAction2.Link=0]="Link",EventAction2[EventAction2.SetProps=1]="SetProps",EventAction2[EventAction2.StartAnimate=2]="StartAnimate",EventAction2[EventAction2.PauseAnimate=3]="PauseAnimate",EventAction2[EventAction2.StopAnimate=4]="StopAnimate",EventAction2[EventAction2.JS=5]="JS",EventAction2[EventAction2.GlobalFn=6]="GlobalFn",EventAction2[EventAction2.Emit=7]="Emit",EventAction2[EventAction2.StartVideo=8]="StartVideo",EventAction2[EventAction2.PauseVideo=9]="PauseVideo",EventAction2[EventAction2.StopVideo=10]="StopVideo",EventAction2[EventAction2.SendPropData=11]="SendPropData",EventAction2[EventAction2.SendVarData=12]="SendVarData",EventAction2[EventAction2.Navigator=13]="Navigator",EventAction2[EventAction2.Dialog=14]="Dialog",EventAction2[EventAction2.SendData=15]="SendData",EventAction2[EventAction2.PostMessage=16]="PostMessage",EventAction2[EventAction2.PostMessageToParent=17]="PostMessageToParent",EventAction2[EventAction2.Message=18]="Message";class ViewMap{constructor(e){var t;let i;__publicField(this,"parent"),__publicField(this,"box"),__publicField(this,"boxWidth",320),__publicField(this,"boxHeight",180),__publicField(this,"ratio",this.boxWidth/this.boxHeight),__publicField(this,"padding",5),__publicField(this,"img"),__publicField(this,"isShow"),__publicField(this,"isDown"),__publicField(this,"view"),__publicField(this,"timer"),__publicField(this,"onMouseDown",(e=>{e.preventDefault(),e.stopPropagation(),this.isDown=!0})),__publicField(this,"onMouseMove",(e=>{if(e.preventDefault(),e.stopPropagation(),this.isDown)try{this.parent.gotoView(e.offsetX/this.box.clientWidth,e.offsetY/this.box.clientHeight)}catch(t){this.isDown=!1}})),__publicField(this,"onMouseUp",(e=>{e.preventDefault(),e.stopPropagation();try{this.parent.gotoView(e.offsetX/this.box.clientWidth,e.offsetY/this.box.clientHeight)}catch(t){}finally{this.isDown=!1}})),__publicField(this,"onWheel",(e=>{let t=.015;if(this.parent.store.options.scaleOff)t=this.parent.store.options.scaleOff,e.deltaY>0&&(t=-this.parent.store.options.scaleOff);else{if(/mac os /i.test(navigator.userAgent))e.ctrlKey?e.deltaY>0&&(t*=-1):t*=e.wheelDeltaY/240;else{let i=.2;-1!==e.deltaY.toString().indexOf(".")&&(i=.01),t=e.deltaY>0?-i:i}}let{offsetX:i,offsetY:n}=e;const o=this.parent.store.data.width||this.parent.store.options.width,s=this.parent.store.data.height||this.parent.store.options.height;if(o&&s)i=i/this.boxWidth*o*this.parent.store.data.scale+this.parent.store.data.origin.x+this.parent.store.data.x,n=n/this.boxHeight*s*this.parent.store.data.scale+this.parent.store.data.origin.y+this.parent.store.data.y;else{const e=this.parent.parent.getRect();i=i/this.boxWidth*e.width+e.x+this.parent.store.data.x,n=n/this.boxHeight*e.height+e.y+this.parent.store.data.y}this.parent.scale(this.parent.store.data.scale+t,{x:i,y:n})})),this.parent=e,this.box=document.createElement("div"),this.img=new Image,this.view=document.createElement("div"),this.box.appendChild(this.img),this.box.appendChild(this.view),null==(t=this.parent.externalElements)||t.parentElement.appendChild(this.box),this.box.className="meta2d-map",this.box.onmousedown=this.onMouseDown,this.box.onmousemove=this.onMouseMove,this.box.onmouseup=this.onMouseUp,this.box.onwheel=this.onWheel;for(let n=0;n<document.styleSheets.length;n++)"le5le/map"===document.styleSheets[n].title&&(i=document.styleSheets[n]);if(!i){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/map",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),i=e.sheet,i.insertRule(`.meta2d-map{display:flex;width:${this.boxWidth+2*this.padding}px;height:${this.boxHeight+2*this.padding}px;padding:${this.padding}px;background:#f4f4f4;border:1px solid #ffffff;box-shadow: 0px 0px 14px 0px rgba(0,10,38,0.30);border-radius:8px;position:absolute;z-index:9999;right:0;bottom:0;justify-content:center;align-items:center;cursor:default;user-select:none;overflow: hidden;}`),i.insertRule(".meta2d-map img{max-width:100%;max-height:100%;pointer-events: none;}"),i.insertRule(".meta2d-map div{pointer-events: none;border:1px solid #1890ff;position:absolute}")}}show(){this.box.style.display="flex";this.parent.store.data.pens.length?(this.img.style.display="block",this.img.src=this.parent.toPng(0,void 0,!0),this.setView()):this.img.style.display="none",this.isShow=!0}hide(){this.box.style.display="none",this.isShow=!1}setView(){const e=this.parent.store.data;if(e.pens.length){let t=getRect$1(e.pens);const i=this.parent.store.data.width||this.parent.store.options.width,n=this.parent.store.data.height||this.parent.store.options.height;i&&n?t={x:this.parent.store.data.origin.x,y:this.parent.store.data.origin.y,width:i*this.parent.store.data.scale,height:n*this.parent.store.data.scale}:(clearTimeout(this.timer),this.timer=setTimeout((()=>{this.parent.store.bkImg&&(this.img.src=this.parent.toPng(0,void 0,!0))}),300)),translateRect(t,e.x,e.y);if(t.width/t.height>this.ratio){const e=t.width/this.ratio;t.y-=(e-t.height)/2,t.height=e,calcRightBottom(t)}else{const e=t.height*this.ratio;t.x-=(e-t.width)/2,t.width=e,calcRightBottom(t)}const o=this.parent.canvasRect;let s=0,r=0;if(t.x<0)s=-t.x/t.width;else if(t.x+t.width>o.width){let e=0;o.width>t.width&&(e=o.width-t.width),s=(-t.x+e)/t.width}if(t.y<0)r=-t.y/t.height;else if(t.y+t.height>o.height){let e=0;o.height>t.height&&(e=o.height-t.height),r=(-t.y+e)/t.height}const a=o.width>t.width?1:o.width/t.width,l=o.height>t.height?1:o.height/t.height;this.view.style.left=this.padding+s*this.boxWidth+"px",this.view.style.width=a*this.boxWidth+"px",this.view.style.top=this.padding+r*this.boxHeight+"px",this.view.style.height=l*this.boxHeight+"px"}}}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function commonjsRequire(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var mqtt_min={exports:{}};mqtt_min.exports=function e(t,i,n){function o(r,a){if(!i[r]){if(!t[r]){var l="function"==typeof commonjsRequire&&commonjsRequire;if(!a&&l)return l(r,!0);if(s)return s(r,!0);var c=new Error("Cannot find module '"+r+"'");throw c.code="MODULE_NOT_FOUND",c}var h=i[r]={exports:{}};t[r][0].call(h.exports,(function(e){return o(t[r][1][e]||e)}),h,h.exports,e,t,i,n)}return i[r].exports}for(var s="function"==typeof commonjsRequire&&commonjsRequire,r=0;r<n.length;r++)o(n[r]);return o}({1:[function(e,t,i){(function(i,n){(function(){const o=e("events").EventEmitter,s=e("./store"),r=e("./topic-alias-recv"),a=e("./topic-alias-send"),l=e("mqtt-packet"),c=e("./default-message-id-provider"),h=e("readable-stream").Writable,d=e("inherits"),u=e("reinterval"),p=e("rfdc/default"),f=e("./validations"),v=e("xtend"),g=e("debug")("mqttjs:client"),y=i?i.nextTick:function(e){setTimeout(e,0)},m=n.setImmediate||function(e){y(e)},w={keepalive:60,reschedulePings:!0,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,connectTimeout:3e4,clean:!0,resubscribe:!0},b={0:"",1:"Unacceptable protocol version",2:"Identifier rejected",3:"Server unavailable",4:"Bad username or password",5:"Not authorized",16:"No matching subscribers",17:"No subscription existed",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",132:"Unsupported Protocol Version",133:"Client Identifier not valid",134:"Bad User Name or Password",135:"Not authorized",136:"Server unavailable",137:"Server busy",138:"Banned",139:"Server shutting down",140:"Bad authentication method",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",145:"Packet identifier in use",146:"Packet Identifier not found",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"};function x(e,t){let i;t.properties&&(i=t.properties.topicAlias);let n=t.topic.toString();if(0===n.length){if(void 0===i)return new Error("Unregistered Topic Alias");if(void 0===(n=e.topicAliasSend.getTopicByAlias(i)))return new Error("Unregistered Topic Alias");t.topic=n}i&&delete t.properties.topicAlias}function k(e,t,i){g("sendPacket :: packet: %O",t),g("sendPacket :: emitting `packetsend`"),e.emit("packetsend",t),g("sendPacket :: writing to stream");const n=l.writeToStream(t,e.stream,e.options);g("sendPacket :: writeToStream result %s",n),!n&&i&&i!==C?(g("sendPacket :: handle events on `drain` once through callback."),e.stream.once("drain",i)):i&&(g("sendPacket :: invoking cb"),i())}function T(e,t,i,n){g("storeAndSend :: store packet with cmd %s to outgoingStore",t.cmd);let o,s=t;if("publish"===s.cmd&&(s=p(t),o=x(e,s)))return i&&i(o);e.outgoingStore.put(s,(function(o){if(o)return i&&i(o);n(),k(e,t,i)}))}function C(e){g("nop ::",e)}function A(e,t){let i;const n=this;if(!(this instanceof A))return new A(e,t);for(i in this.options=t||{},w)void 0===this.options[i]?this.options[i]=w[i]:this.options[i]=t[i];g("MqttClient :: options.protocol",t.protocol),g("MqttClient :: options.protocolVersion",t.protocolVersion),g("MqttClient :: options.username",t.username),g("MqttClient :: options.keepalive",t.keepalive),g("MqttClient :: options.reconnectPeriod",t.reconnectPeriod),g("MqttClient :: options.rejectUnauthorized",t.rejectUnauthorized),g("MqttClient :: options.topicAliasMaximum",t.topicAliasMaximum),this.options.clientId="string"==typeof t.clientId?t.clientId:"mqttjs_"+Math.random().toString(16).substr(2,8),g("MqttClient :: clientId",this.options.clientId),this.options.customHandleAcks=5===t.protocolVersion&&t.customHandleAcks?t.customHandleAcks:function(){arguments[3](0)},this.streamBuilder=e,this.messageIdProvider=void 0===this.options.messageIdProvider?new c:this.options.messageIdProvider,this.outgoingStore=t.outgoingStore||new s,this.incomingStore=t.incomingStore||new s,this.queueQoSZero=void 0===t.queueQoSZero||t.queueQoSZero,this._resubscribeTopics={},this.messageIdToTopic={},this.pingTimer=null,this.connected=!1,this.disconnecting=!1,this.queue=[],this.connackTimer=null,this.reconnectTimer=null,this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={},this._storeProcessingQueue=[],this.outgoing={},this._firstConnection=!0,t.topicAliasMaximum>0&&(t.topicAliasMaximum>65535?g("MqttClient :: options.topicAliasMaximum is out of range"):this.topicAliasRecv=new r(t.topicAliasMaximum)),this.on("connect",(function(){const e=this.queue;g("connect :: sending queued packets"),function t(){const i=e.shift();g("deliver :: entry %o",i);let o=null;if(!i)return void n._resubscribe();o=i.packet,g("deliver :: call _sendPacket for %o",o);let s=!0;o.messageId&&0!==o.messageId&&(n.messageIdProvider.register(o.messageId)||(s=!1)),s?n._sendPacket(o,(function(e){i.cb&&i.cb(e),t()})):(g("messageId: %d has already used. The message is skipped and removed.",o.messageId),t())}()})),this.on("close",(function(){g("close :: connected set to `false`"),this.connected=!1,g("close :: clearing connackTimer"),clearTimeout(this.connackTimer),g("close :: clearing ping timer"),null!==n.pingTimer&&(n.pingTimer.clear(),n.pingTimer=null),this.topicAliasRecv&&this.topicAliasRecv.clear(),g("close :: calling _setupReconnect"),this._setupReconnect()})),o.call(this),g("MqttClient :: setting up stream"),this._setupStream()}d(A,o),A.prototype._setupStream=function(){const e=this,t=new h,i=l.parser(this.options);let n=null;const o=[];function s(){if(o.length)y(r);else{const e=n;n=null,e()}}function r(){g("work :: getting next packet in queue");const t=o.shift();if(t)g("work :: packet pulled from queue"),e._handlePacket(t,s);else{g("work :: no packets in queue");const e=n;n=null,g("work :: done flag is %s",!!e),e&&e()}}g("_setupStream :: calling method to clear reconnect"),this._clearReconnect(),g("_setupStream :: using streamBuilder provided to client to create stream"),this.stream=this.streamBuilder(this),i.on("packet",(function(e){g("parser :: on packet push to packets array."),o.push(e)})),t._write=function(e,t,o){n=o,g("writable stream :: parsing buffer"),i.parse(e),r()},g("_setupStream :: pipe stream to writable stream"),this.stream.pipe(t),this.stream.on("error",(function(t){g("streamErrorHandler :: error",t.message),t.code?(g("streamErrorHandler :: emitting error"),e.emit("error",t)):C(t)})),this.stream.on("close",(function(){var t;g("(%s)stream :: on close",e.options.clientId),(t=e.outgoing)&&(g("flushVolatile :: deleting volatile messages from the queue and setting their callbacks as error function"),Object.keys(t).forEach((function(e){t[e].volatile&&"function"==typeof t[e].cb&&(t[e].cb(new Error("Connection closed")),delete t[e])}))),g("stream: emit close to MqttClient"),e.emit("close")})),g("_setupStream: sending packet `connect`");const a=Object.create(this.options);if(a.cmd="connect",this.topicAliasRecv&&(a.properties||(a.properties={}),this.topicAliasRecv&&(a.properties.topicAliasMaximum=this.topicAliasRecv.max)),k(this,a),i.on("error",this.emit.bind(this,"error")),this.options.properties){if(!this.options.properties.authenticationMethod&&this.options.properties.authenticationData)return e.end((()=>this.emit("error",new Error("Packet has no Authentication Method")))),this;this.options.properties.authenticationMethod&&this.options.authPacket&&"object"==typeof this.options.authPacket&&k(this,v({cmd:"auth",reasonCode:0},this.options.authPacket))}this.stream.setMaxListeners(1e3),clearTimeout(this.connackTimer),this.connackTimer=setTimeout((function(){g("!!connectTimeout hit!! Calling _cleanUp with force `true`"),e._cleanUp(!0)}),this.options.connectTimeout)},A.prototype._handlePacket=function(e,t){const i=this.options;if(5===i.protocolVersion&&i.properties&&i.properties.maximumPacketSize&&i.properties.maximumPacketSize<e.length)return this.emit("error",new Error("exceeding packets size "+e.cmd)),this.end({reasonCode:149,properties:{reasonString:"Maximum packet size was exceeded"}}),this;switch(g("_handlePacket :: emitting packetreceive"),this.emit("packetreceive",e),e.cmd){case"publish":this._handlePublish(e,t);break;case"puback":case"pubrec":case"pubcomp":case"suback":case"unsuback":this._handleAck(e),t();break;case"pubrel":this._handlePubrel(e,t);break;case"connack":this._handleConnack(e),t();break;case"auth":this._handleAuth(e),t();break;case"pingresp":this._handlePingresp(e),t();break;case"disconnect":this._handleDisconnect(e),t()}},A.prototype._checkDisconnecting=function(e){return this.disconnecting&&(e&&e!==C?e(new Error("client disconnecting")):this.emit("error",new Error("client disconnecting"))),this.disconnecting},A.prototype.publish=function(e,t,i,n){g("publish :: message `%s` to topic `%s`",t,e);const o=this.options;if("function"==typeof i&&(n=i,i=null),i=v({qos:0,retain:!1,dup:!1},i),this._checkDisconnecting(n))return this;const s=this,r=function(){let r=0;if((1===i.qos||2===i.qos)&&null===(r=s._nextId()))return g("No messageId left"),!1;const a={cmd:"publish",topic:e,payload:t,qos:i.qos,retain:i.retain,messageId:r,dup:i.dup};switch(5===o.protocolVersion&&(a.properties=i.properties),g("publish :: qos",i.qos),i.qos){case 1:case 2:s.outgoing[a.messageId]={volatile:!1,cb:n||C},g("MqttClient:publish: packet cmd: %s",a.cmd),s._sendPacket(a,void 0,i.cbStorePut);break;default:g("MqttClient:publish: packet cmd: %s",a.cmd),s._sendPacket(a,n,i.cbStorePut)}return!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!r())&&this._storeProcessingQueue.push({invoke:r,cbStorePut:i.cbStorePut,callback:n}),this},A.prototype.subscribe=function(){const e=this,t=new Array(arguments.length);for(let d=0;d<arguments.length;d++)t[d]=arguments[d];const i=[];let n=t.shift();const o=n.resubscribe;let s=t.pop()||C,r=t.pop();const a=this.options.protocolVersion;delete n.resubscribe,"string"==typeof n&&(n=[n]),"function"!=typeof s&&(r=s,s=C);const l=f.validateTopics(n);if(null!==l)return m(s,new Error("Invalid topic "+l)),this;if(this._checkDisconnecting(s))return g("subscribe: discconecting true"),this;const c={qos:0};if(5===a&&(c.nl=!1,c.rap=!1,c.rh=0),r=v(c,r),Array.isArray(n)?n.forEach((function(t){if(g("subscribe: array topic %s",t),!Object.prototype.hasOwnProperty.call(e._resubscribeTopics,t)||e._resubscribeTopics[t].qos<r.qos||o){const e={topic:t,qos:r.qos};5===a&&(e.nl=r.nl,e.rap=r.rap,e.rh=r.rh,e.properties=r.properties),g("subscribe: pushing topic `%s` and qos `%s` to subs list",e.topic,e.qos),i.push(e)}})):Object.keys(n).forEach((function(t){if(g("subscribe: object topic %s",t),!Object.prototype.hasOwnProperty.call(e._resubscribeTopics,t)||e._resubscribeTopics[t].qos<n[t].qos||o){const e={topic:t,qos:n[t].qos};5===a&&(e.nl=n[t].nl,e.rap=n[t].rap,e.rh=n[t].rh,e.properties=r.properties),g("subscribe: pushing `%s` to subs list",e),i.push(e)}})),!i.length)return s(null,[]),this;const h=function(){const t=e._nextId();if(null===t)return g("No messageId left"),!1;const n={cmd:"subscribe",subscriptions:i,qos:1,retain:!1,dup:!1,messageId:t};if(r.properties&&(n.properties=r.properties),e.options.resubscribe){g("subscribe :: resubscribe true");const t=[];i.forEach((function(i){if(e.options.reconnectPeriod>0){const n={qos:i.qos};5===a&&(n.nl=i.nl||!1,n.rap=i.rap||!1,n.rh=i.rh||0,n.properties=i.properties),e._resubscribeTopics[i.topic]=n,t.push(i.topic)}})),e.messageIdToTopic[n.messageId]=t}return e.outgoing[n.messageId]={volatile:!0,cb:function(e,t){if(!e){const e=t.granted;for(let t=0;t<e.length;t+=1)i[t].qos=e[t]}s(e,i)}},g("subscribe :: call _sendPacket"),e._sendPacket(n),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!h())&&this._storeProcessingQueue.push({invoke:h,callback:s}),this},A.prototype.unsubscribe=function(){const e=this,t=new Array(arguments.length);for(let a=0;a<arguments.length;a++)t[a]=arguments[a];let i=t.shift(),n=t.pop()||C,o=t.pop();"string"==typeof i&&(i=[i]),"function"!=typeof n&&(o=n,n=C);const s=f.validateTopics(i);if(null!==s)return m(n,new Error("Invalid topic "+s)),this;if(e._checkDisconnecting(n))return this;const r=function(){const t=e._nextId();if(null===t)return g("No messageId left"),!1;const s={cmd:"unsubscribe",qos:1,messageId:t};return"string"==typeof i?s.unsubscriptions=[i]:Array.isArray(i)&&(s.unsubscriptions=i),e.options.resubscribe&&s.unsubscriptions.forEach((function(t){delete e._resubscribeTopics[t]})),"object"==typeof o&&o.properties&&(s.properties=o.properties),e.outgoing[s.messageId]={volatile:!0,cb:n},g("unsubscribe: call _sendPacket"),e._sendPacket(s),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!r())&&this._storeProcessingQueue.push({invoke:r,callback:n}),this},A.prototype.end=function(e,t,i){const n=this;function o(){g("end :: (%s) :: finish :: calling _cleanUp with force %s",n.options.clientId,e),n._cleanUp(e,(()=>{g("end :: finish :: calling process.nextTick on closeStores"),y(function(){g("end :: closeStores: closing incoming and outgoing stores"),n.disconnected=!0,n.incomingStore.close((function(e){n.outgoingStore.close((function(t){if(g("end :: closeStores: emitting end"),n.emit("end"),i){const n=e||t;g("end :: closeStores: invoking callback with args"),i(n)}}))})),n._deferredReconnect&&n._deferredReconnect()}.bind(n))}),t)}return g("end :: (%s)",this.options.clientId),null!=e&&"boolean"==typeof e||(i=t||C,t=e,e=!1,"object"!=typeof t&&(i=t,t=null,"function"!=typeof i&&(i=C))),"object"!=typeof t&&(i=t,t=null),g("end :: cb? %s",!!i),i=i||C,this.disconnecting?(i(),this):(this._clearReconnect(),this.disconnecting=!0,!e&&Object.keys(this.outgoing).length>0?(g("end :: (%s) :: calling finish in 10ms once outgoing is empty",n.options.clientId),this.once("outgoingEmpty",setTimeout.bind(null,o,10))):(g("end :: (%s) :: immediately calling finish",n.options.clientId),o()),this)},A.prototype.removeOutgoingMessage=function(e){const t=this.outgoing[e]?this.outgoing[e].cb:null;return delete this.outgoing[e],this.outgoingStore.del({messageId:e},(function(){t(new Error("Message removed"))})),this},A.prototype.reconnect=function(e){g("client reconnect");const t=this,i=function(){e?(t.options.incomingStore=e.incomingStore,t.options.outgoingStore=e.outgoingStore):(t.options.incomingStore=null,t.options.outgoingStore=null),t.incomingStore=t.options.incomingStore||new s,t.outgoingStore=t.options.outgoingStore||new s,t.disconnecting=!1,t.disconnected=!1,t._deferredReconnect=null,t._reconnect()};return this.disconnecting&&!this.disconnected?this._deferredReconnect=i:i(),this},A.prototype._reconnect=function(){g("_reconnect: emitting reconnect to client"),this.emit("reconnect"),this.connected?(this.end((()=>{this._setupStream()})),g("client already connected. disconnecting first.")):(g("_reconnect: calling _setupStream"),this._setupStream())},A.prototype._setupReconnect=function(){const e=this;!e.disconnecting&&!e.reconnectTimer&&e.options.reconnectPeriod>0?(this.reconnecting||(g("_setupReconnect :: emit `offline` state"),this.emit("offline"),g("_setupReconnect :: set `reconnecting` to `true`"),this.reconnecting=!0),g("_setupReconnect :: setting reconnectTimer for %d ms",e.options.reconnectPeriod),e.reconnectTimer=setInterval((function(){g("reconnectTimer :: reconnect triggered!"),e._reconnect()}),e.options.reconnectPeriod)):g("_setupReconnect :: doing nothing...")},A.prototype._clearReconnect=function(){g("_clearReconnect : clearing reconnect timer"),this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=null)},A.prototype._cleanUp=function(e,t){const i=arguments[2];if(t&&(g("_cleanUp :: done callback provided for on stream close"),this.stream.on("close",t)),g("_cleanUp :: forced? %s",e),e)0===this.options.reconnectPeriod&&this.options.clean&&(n=this.outgoing)&&(g("flush: queue exists? %b",!!n),Object.keys(n).forEach((function(e){"function"==typeof n[e].cb&&(n[e].cb(new Error("Connection closed")),delete n[e])}))),g("_cleanUp :: (%s) :: destroying stream",this.options.clientId),this.stream.destroy();else{const e=v({cmd:"disconnect"},i);g("_cleanUp :: (%s) :: call _sendPacket with disconnect packet",this.options.clientId),this._sendPacket(e,m.bind(null,this.stream.end.bind(this.stream)))}var n;this.disconnecting||(g("_cleanUp :: client not disconnecting. Clearing and resetting reconnect."),this._clearReconnect(),this._setupReconnect()),null!==this.pingTimer&&(g("_cleanUp :: clearing pingTimer"),this.pingTimer.clear(),this.pingTimer=null),t&&!this.connected&&(g("_cleanUp :: (%s) :: removing stream `done` callback `close` listener",this.options.clientId),this.stream.removeListener("close",t),t())},A.prototype._sendPacket=function(e,t,i){g("_sendPacket :: (%s) ::  start",this.options.clientId),i=i||C,t=t||C;const n=function(e,t){if(5===e.options.protocolVersion&&"publish"===t.cmd){let i;t.properties&&(i=t.properties.topicAlias);const n=t.topic.toString();if(e.topicAliasSend)if(i){if(0!==n.length&&(g("applyTopicAlias :: register topic: %s - alias: %d",n,i),!e.topicAliasSend.put(n,i)))return g("applyTopicAlias :: error out of range. topic: %s - alias: %d",n,i),new Error("Sending Topic Alias out of range")}else 0!==n.length&&(e.options.autoAssignTopicAlias?(i=e.topicAliasSend.getAliasByTopic(n))?(t.topic="",t.properties={...t.properties,topicAlias:i},g("applyTopicAlias :: auto assign(use) topic: %s - alias: %d",n,i)):(i=e.topicAliasSend.getLruAlias(),e.topicAliasSend.put(n,i),t.properties={...t.properties,topicAlias:i},g("applyTopicAlias :: auto assign topic: %s - alias: %d",n,i)):e.options.autoUseTopicAlias&&(i=e.topicAliasSend.getAliasByTopic(n))&&(t.topic="",t.properties={...t.properties,topicAlias:i},g("applyTopicAlias :: auto use topic: %s - alias: %d",n,i)));else if(i)return g("applyTopicAlias :: error out of range. topic: %s - alias: %d",n,i),new Error("Sending Topic Alias out of range")}}(this,e);if(n)t(n);else{if(!this.connected)return"auth"===e.cmd?(this._shiftPingInterval(),void k(this,e,t)):(g("_sendPacket :: client not connected. Storing packet offline."),void this._storePacket(e,t,i));switch(this._shiftPingInterval(),e.cmd){case"publish":break;case"pubrel":return void T(this,e,t,i);default:return void k(this,e,t)}switch(e.qos){case 2:case 1:T(this,e,t,i);break;default:k(this,e,t)}g("_sendPacket :: (%s) ::  end",this.options.clientId)}},A.prototype._storePacket=function(e,t,i){g("_storePacket :: packet: %o",e),g("_storePacket :: cb? %s",!!t),i=i||C;let n=e;if("publish"===n.cmd){const i=x(this,n=p(e));if(i)return t&&t(i)}0===(n.qos||0)&&this.queueQoSZero||"publish"!==n.cmd?this.queue.push({packet:n,cb:t}):n.qos>0?(t=this.outgoing[n.messageId]?this.outgoing[n.messageId].cb:null,this.outgoingStore.put(n,(function(e){if(e)return t&&t(e);i()}))):t&&t(new Error("No connection to broker"))},A.prototype._setupPingTimer=function(){g("_setupPingTimer :: keepalive %d (seconds)",this.options.keepalive);const e=this;!this.pingTimer&&this.options.keepalive&&(this.pingResp=!0,this.pingTimer=u((function(){e._checkPing()}),1e3*this.options.keepalive))},A.prototype._shiftPingInterval=function(){this.pingTimer&&this.options.keepalive&&this.options.reschedulePings&&this.pingTimer.reschedule(1e3*this.options.keepalive)},A.prototype._checkPing=function(){g("_checkPing :: checking ping..."),this.pingResp?(g("_checkPing :: ping response received. Clearing flag and sending `pingreq`"),this.pingResp=!1,this._sendPacket({cmd:"pingreq"})):(g("_checkPing :: calling _cleanUp with force true"),this._cleanUp(!0))},A.prototype._handlePingresp=function(){this.pingResp=!0},A.prototype._handleConnack=function(e){g("_handleConnack");const t=this.options,i=5===t.protocolVersion?e.reasonCode:e.returnCode;if(clearTimeout(this.connackTimer),delete this.topicAliasSend,e.properties){if(e.properties.topicAliasMaximum){if(e.properties.topicAliasMaximum>65535)return void this.emit("error",new Error("topicAliasMaximum from broker is out of range"));e.properties.topicAliasMaximum>0&&(this.topicAliasSend=new a(e.properties.topicAliasMaximum))}e.properties.serverKeepAlive&&t.keepalive&&(t.keepalive=e.properties.serverKeepAlive,this._shiftPingInterval()),e.properties.maximumPacketSize&&(t.properties||(t.properties={}),t.properties.maximumPacketSize=e.properties.maximumPacketSize)}if(0===i)this.reconnecting=!1,this._onConnect(e);else if(i>0){const e=new Error("Connection refused: "+b[i]);e.code=i,this.emit("error",e)}},A.prototype._handleAuth=function(e){const t=this.options.protocolVersion,i=5===t?e.reasonCode:e.returnCode;if(5!==t){const e=new Error("Protocol error: Auth packets are only supported in MQTT 5. Your version:"+t);return e.code=i,void this.emit("error",e)}const n=this;this.handleAuth(e,(function(e,t){if(e)n.emit("error",e);else if(24===i)n.reconnecting=!1,n._sendPacket(t);else{const t=new Error("Connection refused: "+b[i]);e.code=i,n.emit("error",t)}}))},A.prototype.handleAuth=function(e,t){t()},A.prototype._handlePublish=function(e,t){g("_handlePublish: packet %o",e),t=void 0!==t?t:C;let i=e.topic.toString();const n=e.payload,o=e.qos,s=e.messageId,r=this,a=this.options,l=[0,16,128,131,135,144,145,151,153];if(5===this.options.protocolVersion){let t;if(e.properties&&(t=e.properties.topicAlias),void 0!==t)if(0===i.length){if(!(t>0&&t<=65535))return g("_handlePublish :: topic alias out of range. alias: %d",t),void this.emit("error",new Error("Received Topic Alias is out of range"));{const e=this.topicAliasRecv.getTopicByAlias(t);if(!e)return g("_handlePublish :: unregistered topic alias. alias: %d",t),void this.emit("error",new Error("Received unregistered Topic Alias"));g("_handlePublish :: topic complemented by alias. topic: %s - alias: %d",i=e,t)}}else{if(!this.topicAliasRecv.put(i,t))return g("_handlePublish :: topic alias out of range. alias: %d",t),void this.emit("error",new Error("Received Topic Alias is out of range"));g("_handlePublish :: registered topic: %s - alias: %d",i,t)}}switch(g("_handlePublish: qos %d",o),o){case 2:a.customHandleAcks(i,n,e,(function(i,n){return i instanceof Error||(n=i,i=null),i?r.emit("error",i):-1===l.indexOf(n)?r.emit("error",new Error("Wrong reason code for pubrec")):void(n?r._sendPacket({cmd:"pubrec",messageId:s,reasonCode:n},t):r.incomingStore.put(e,(function(){r._sendPacket({cmd:"pubrec",messageId:s},t)})))}));break;case 1:a.customHandleAcks(i,n,e,(function(o,a){return o instanceof Error||(a=o,o=null),o?r.emit("error",o):-1===l.indexOf(a)?r.emit("error",new Error("Wrong reason code for puback")):(a||r.emit("message",i,n,e),void r.handleMessage(e,(function(e){if(e)return t&&t(e);r._sendPacket({cmd:"puback",messageId:s,reasonCode:a},t)})))}));break;case 0:this.emit("message",i,n,e),this.handleMessage(e,t);break;default:g("_handlePublish: unknown QoS. Doing nothing.")}},A.prototype.handleMessage=function(e,t){t()},A.prototype._handleAck=function(e){const t=e.messageId,i=e.cmd;let n=null;const o=this.outgoing[t]?this.outgoing[t].cb:null,s=this;let r;if(o){switch(g("_handleAck :: packet type",i),i){case"pubcomp":case"puback":{const i=e.reasonCode;i&&i>0&&16!==i&&((r=new Error("Publish error: "+b[i])).code=i,o(r,e)),delete this.outgoing[t],this.outgoingStore.del(e,o),this.messageIdProvider.deallocate(t),this._invokeStoreProcessingQueue();break}case"pubrec":{n={cmd:"pubrel",qos:2,messageId:t};const i=e.reasonCode;i&&i>0&&16!==i?((r=new Error("Publish error: "+b[i])).code=i,o(r,e)):this._sendPacket(n);break}case"suback":delete this.outgoing[t],this.messageIdProvider.deallocate(t);for(let i=0;i<e.granted.length;i++)if(128&e.granted[i]){const e=this.messageIdToTopic[t];e&&e.forEach((function(e){delete s._resubscribeTopics[e]}))}this._invokeStoreProcessingQueue(),o(null,e);break;case"unsuback":delete this.outgoing[t],this.messageIdProvider.deallocate(t),this._invokeStoreProcessingQueue(),o(null);break;default:s.emit("error",new Error("unrecognized packet type"))}this.disconnecting&&0===Object.keys(this.outgoing).length&&this.emit("outgoingEmpty")}else g("_handleAck :: Server sent an ack in error. Ignoring.")},A.prototype._handlePubrel=function(e,t){g("handling pubrel packet"),t=void 0!==t?t:C;const i=this,n={cmd:"pubcomp",messageId:e.messageId};i.incomingStore.get(e,(function(e,o){e?i._sendPacket(n,t):(i.emit("message",o.topic,o.payload,o),i.handleMessage(o,(function(e){if(e)return t(e);i.incomingStore.del(o,C),i._sendPacket(n,t)})))}))},A.prototype._handleDisconnect=function(e){this.emit("disconnect",e)},A.prototype._nextId=function(){return this.messageIdProvider.allocate()},A.prototype.getLastMessageId=function(){return this.messageIdProvider.getLastAllocated()},A.prototype._resubscribe=function(){g("_resubscribe");const e=Object.keys(this._resubscribeTopics);if(!this._firstConnection&&(this.options.clean||5===this.options.protocolVersion&&!this.connackPacket.sessionPresent)&&e.length>0)if(this.options.resubscribe)if(5===this.options.protocolVersion){g("_resubscribe: protocolVersion 5");for(let t=0;t<e.length;t++){const i={};i[e[t]]=this._resubscribeTopics[e[t]],i.resubscribe=!0,this.subscribe(i,{properties:i[e[t]].properties})}}else this._resubscribeTopics.resubscribe=!0,this.subscribe(this._resubscribeTopics);else this._resubscribeTopics={};this._firstConnection=!1},A.prototype._onConnect=function(e){if(this.disconnected)return void this.emit("connect",e);const t=this;this.connackPacket=e,this.messageIdProvider.clear(),this._setupPingTimer(),this.connected=!0,function i(){let n=t.outgoingStore.createStream();function o(){t._storeProcessing=!1,t._packetIdsDuringStoreProcessing={}}function s(){n.destroy(),n=null,t._flushStoreProcessingQueue(),o()}t.once("close",s),n.on("error",(function(e){o(),t._flushStoreProcessingQueue(),t.removeListener("close",s),t.emit("error",e)})),n.on("end",(function(){let n=!0;for(const e in t._packetIdsDuringStoreProcessing)if(!t._packetIdsDuringStoreProcessing[e]){n=!1;break}n?(o(),t.removeListener("close",s),t._invokeAllStoreProcessingQueue(),t.emit("connect",e)):i()})),function e(){if(!n)return;t._storeProcessing=!0;const i=n.read(1);let o;i?t._packetIdsDuringStoreProcessing[i.messageId]?e():t.disconnecting||t.reconnectTimer?n.destroy&&n.destroy():(o=t.outgoing[i.messageId]?t.outgoing[i.messageId].cb:null,t.outgoing[i.messageId]={volatile:!1,cb:function(t,i){o&&o(t,i),e()}},t._packetIdsDuringStoreProcessing[i.messageId]=!0,t.messageIdProvider.register(i.messageId)?t._sendPacket(i):g("messageId: %d has already used.",i.messageId)):n.once("readable",e)}()}()},A.prototype._invokeStoreProcessingQueue=function(){if(this._storeProcessingQueue.length>0){const e=this._storeProcessingQueue[0];if(e&&e.invoke())return this._storeProcessingQueue.shift(),!0}return!1},A.prototype._invokeAllStoreProcessingQueue=function(){for(;this._invokeStoreProcessingQueue(););},A.prototype._flushStoreProcessingQueue=function(){for(const e of this._storeProcessingQueue)e.cbStorePut&&e.cbStorePut(new Error("Connection closed")),e.callback&&e.callback(new Error("Connection closed"));this._storeProcessingQueue.splice(0)},t.exports=A}).call(this)}).call(this,e("_process"),void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./default-message-id-provider":7,"./store":8,"./topic-alias-recv":9,"./topic-alias-send":10,"./validations":11,_process:50,debug:18,events:22,inherits:24,"mqtt-packet":40,"readable-stream":69,reinterval:70,"rfdc/default":71,xtend:81}],2:[function(e,t,i){const{Buffer:n}=e("buffer"),o=e("readable-stream").Transform,s=e("duplexify");let r,a,l,c=!1;t.exports=function(e,t){if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const i="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";var h;(h=t).hostname||(h.hostname="localhost"),h.path||(h.path="/"),h.wsOptions||(h.wsOptions={});const d=function(e,t){const i="alis"===e.protocol?"wss":"ws";let n=i+"://"+e.hostname+e.path;return e.port&&80!==e.port&&443!==e.port&&(n=i+"://"+e.hostname+":"+e.port+e.path),"function"==typeof e.transformWsUrl&&(n=e.transformWsUrl(n,e,t)),n}(t,e);return(r=t.my).connectSocket({url:d,protocols:i}),a=function(){const e=new o;return e._write=function(e,t,i){r.sendSocketMessage({data:e.buffer,success:function(){i()},fail:function(){i(new Error)}})},e._flush=function(e){r.closeSocket({success:function(){e()}})},e}(),l=s.obj(),c||(c=!0,r.onSocketOpen((function(){l.setReadable(a),l.setWritable(a),l.emit("connect")})),r.onSocketMessage((function(e){if("string"==typeof e.data){const t=n.from(e.data,"base64");a.push(t)}else{const t=new FileReader;t.addEventListener("load",(function(){let e=t.result;e=e instanceof ArrayBuffer?n.from(e):n.from(e,"utf8"),a.push(e)})),t.readAsArrayBuffer(e.data)}})),r.onSocketClose((function(){l.end(),l.destroy()})),r.onSocketError((function(e){l.destroy(e)}))),l}},{buffer:17,duplexify:20,"readable-stream":69}],3:[function(e,t,i){const n=e("net"),o=e("debug")("mqttjs:tcp");t.exports=function(e,t){t.port=t.port||1883,t.hostname=t.hostname||t.host||"localhost";const i=t.port,s=t.hostname;return o("port %d and host %s",i,s),n.createConnection(i,s)}},{debug:18,net:16}],4:[function(e,t,i){const n=e("tls"),o=e("net"),s=e("debug")("mqttjs:tls");t.exports=function(e,t){t.port=t.port||8883,t.host=t.hostname||t.host||"localhost",0===o.isIP(t.host)&&(t.servername=t.host),t.rejectUnauthorized=!1!==t.rejectUnauthorized,delete t.path,s("port %d host %s rejectUnauthorized %b",t.port,t.host,t.rejectUnauthorized);const i=n.connect(t);function r(n){t.rejectUnauthorized&&e.emit("error",n),i.end()}return i.on("secureConnect",(function(){t.rejectUnauthorized&&!i.authorized?i.emit("error",new Error("TLS not authorized")):i.removeListener("error",r)})),i.on("error",r),i}},{debug:18,net:16,tls:16}],5:[function(e,t,i){(function(i){(function(){const{Buffer:n}=e("buffer"),o=e("ws"),s=e("debug")("mqttjs:ws"),r=e("duplexify"),a=e("readable-stream").Transform,l=["rejectUnauthorized","ca","cert","key","pfx","passphrase"],c=void 0!==i&&"browser"===i.title||"function"==typeof __webpack_require__;function h(e,t){let i=e.protocol+"://"+e.hostname+":"+e.port+e.path;return"function"==typeof e.transformWsUrl&&(i=e.transformWsUrl(i,e,t)),i}function d(e){const t=e;return e.hostname||(t.hostname="localhost"),e.port||("wss"===e.protocol?t.port=443:t.port=80),e.path||(t.path="/"),e.wsOptions||(t.wsOptions={}),c||"wss"!==e.protocol||l.forEach((function(i){Object.prototype.hasOwnProperty.call(e,i)&&!Object.prototype.hasOwnProperty.call(e.wsOptions,i)&&(t.wsOptions[i]=e[i])})),t}t.exports=c?function(e,t){let i;s("browserStreamBuilder");const o=function(e){const t=d(e);if(t.hostname||(t.hostname=t.host),!t.hostname){if("undefined"==typeof document)throw new Error("Could not determine host. Specify host manually.");const e=new URL(document.URL);t.hostname=e.hostname,t.port||(t.port=e.port)}return void 0===t.objectMode&&(t.objectMode=!(!0===t.binary||void 0===t.binary)),t}(t).browserBufferSize||524288,l=t.browserBufferTimeout||1e3,c=!t.objectMode,u=function(e,t){const i="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt",n=h(t,e),o=new WebSocket(n,[i]);return o.binaryType="arraybuffer",o}(e,t),p=function(e,t,i){const n=new a({objectModeMode:e.objectMode});return n._write=t,n._flush=i,n}(t,(function e(t,i,s){u.bufferedAmount>o&&setTimeout(e,l,t,i,s),c&&"string"==typeof t&&(t=n.from(t,"utf8"));try{u.send(t)}catch(r){return s(r)}s()}),(function(e){u.close(),e()}));t.objectMode||(p._writev=w),p.on("close",(()=>{u.close()}));const f=void 0!==u.addEventListener;function v(){i.setReadable(p),i.setWritable(p),i.emit("connect")}function g(){i.end(),i.destroy()}function y(e){i.destroy(e)}function m(e){let t=e.data;t=t instanceof ArrayBuffer?n.from(t):n.from(t,"utf8"),p.push(t)}function w(e,t){const i=new Array(e.length);for(let o=0;o<e.length;o++)"string"==typeof e[o].chunk?i[o]=n.from(e[o],"utf8"):i[o]=e[o].chunk;this._write(n.concat(i),"binary",t)}return u.readyState===u.OPEN?i=p:(i=i=r(void 0,void 0,t),t.objectMode||(i._writev=w),f?u.addEventListener("open",v):u.onopen=v),i.socket=u,f?(u.addEventListener("close",g),u.addEventListener("error",y),u.addEventListener("message",m)):(u.onclose=g,u.onerror=y,u.onmessage=m),i}:function(e,t){s("streamBuilder");const i=d(t),n=h(i,e),r=function(e,t,i){s("createWebSocket"),s("protocol: "+i.protocolId+" "+i.protocolVersion);const n="MQIsdp"===i.protocolId&&3===i.protocolVersion?"mqttv3.1":"mqtt";return s("creating new Websocket for url: "+t+" and protocol: "+n),new o(t,[n],i.wsOptions)}(0,n,i),a=o.createWebSocketStream(r,i.wsOptions);return a.url=n,r.on("close",(()=>{a.destroy()})),a}}).call(this)}).call(this,e("_process"))},{_process:50,buffer:17,debug:18,duplexify:20,"readable-stream":69,ws:80}],6:[function(e,t,i){const{Buffer:n}=e("buffer"),o=e("readable-stream").Transform,s=e("duplexify");let r,a,l;t.exports=function(e,t){if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const i="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";var c;(c=t).hostname||(c.hostname="localhost"),c.path||(c.path="/"),c.wsOptions||(c.wsOptions={});const h=function(e,t){const i="wxs"===e.protocol?"wss":"ws";let n=i+"://"+e.hostname+e.path;return e.port&&80!==e.port&&443!==e.port&&(n=i+"://"+e.hostname+":"+e.port+e.path),"function"==typeof e.transformWsUrl&&(n=e.transformWsUrl(n,e,t)),n}(t,e);r=wx.connectSocket({url:h,protocols:[i]}),a=function(){const e=new o;return e._write=function(e,t,i){r.send({data:e.buffer,success:function(){i()},fail:function(e){i(new Error(e))}})},e._flush=function(e){r.close({success:function(){e()}})},e}(),(l=s.obj())._destroy=function(e,t){r.close({success:function(){t&&t(e)}})};const d=l.destroy;return l.destroy=function(){l.destroy=d;const e=this;setTimeout((function(){r.close({fail:function(){e._destroy(new Error)}})}),0)}.bind(l),r.onOpen((function(){l.setReadable(a),l.setWritable(a),l.emit("connect")})),r.onMessage((function(e){let t=e.data;t=t instanceof ArrayBuffer?n.from(t):n.from(t,"utf8"),a.push(t)})),r.onClose((function(){l.end(),l.destroy()})),r.onError((function(e){l.destroy(new Error(e.errMsg))})),l}},{buffer:17,duplexify:20,"readable-stream":69}],7:[function(e,t,i){function n(){if(!(this instanceof n))return new n;this.nextId=Math.max(1,Math.floor(65535*Math.random()))}n.prototype.allocate=function(){const e=this.nextId++;return 65536===this.nextId&&(this.nextId=1),e},n.prototype.getLastAllocated=function(){return 1===this.nextId?65535:this.nextId-1},n.prototype.register=function(e){return!0},n.prototype.deallocate=function(e){},n.prototype.clear=function(){},t.exports=n},{}],8:[function(e,t,i){const n=e("xtend"),o=e("readable-stream").Readable,s={objectMode:!0},r={clean:!0};function a(e){if(!(this instanceof a))return new a(e);this.options=e||{},this.options=n(r,e),this._inflights=new Map}a.prototype.put=function(e,t){return this._inflights.set(e.messageId,e),t&&t(),this},a.prototype.createStream=function(){const e=new o(s),t=[];let i=!1,n=0;return this._inflights.forEach((function(e,i){t.push(e)})),e._read=function(){!i&&n<t.length?this.push(t[n++]):this.push(null)},e.destroy=function(){if(i)return;const e=this;i=!0,setTimeout((function(){e.emit("close")}),0)},e},a.prototype.del=function(e,t){return(e=this._inflights.get(e.messageId))?(this._inflights.delete(e.messageId),t(null,e)):t&&t(new Error("missing packet")),this},a.prototype.get=function(e,t){return(e=this._inflights.get(e.messageId))?t(null,e):t&&t(new Error("missing packet")),this},a.prototype.close=function(e){this.options.clean&&(this._inflights=null),e&&e()},t.exports=a},{"readable-stream":69,xtend:81}],9:[function(e,t,i){function n(e){if(!(this instanceof n))return new n(e);this.aliasToTopic={},this.max=e}n.prototype.put=function(e,t){return!(0===t||t>this.max||(this.aliasToTopic[t]=e,this.length=Object.keys(this.aliasToTopic).length,0))},n.prototype.getTopicByAlias=function(e){return this.aliasToTopic[e]},n.prototype.clear=function(){this.aliasToTopic={}},t.exports=n},{}],10:[function(e,t,i){const n=e("lru-cache"),o=e("number-allocator").NumberAllocator;function s(e){if(!(this instanceof s))return new s(e);e>0&&(this.aliasToTopic=new n({max:e}),this.topicToAlias={},this.numberAllocator=new o(1,e),this.max=e,this.length=0)}s.prototype.put=function(e,t){if(0===t||t>this.max)return!1;const i=this.aliasToTopic.get(t);return i&&delete this.topicToAlias[i],this.aliasToTopic.set(t,e),this.topicToAlias[e]=t,this.numberAllocator.use(t),this.length=this.aliasToTopic.length,!0},s.prototype.getTopicByAlias=function(e){return this.aliasToTopic.get(e)},s.prototype.getAliasByTopic=function(e){const t=this.topicToAlias[e];return void 0!==t&&this.aliasToTopic.get(t),t},s.prototype.clear=function(){this.aliasToTopic.reset(),this.topicToAlias={},this.numberAllocator.clear(),this.length=0},s.prototype.getLruAlias=function(){return this.numberAllocator.firstVacant()||this.aliasToTopic.keys()[this.aliasToTopic.length-1]},t.exports=s},{"lru-cache":37,"number-allocator":46}],11:[function(e,t,i){function n(e){const t=e.split("/");for(let i=0;i<t.length;i++)if("+"!==t[i]){if("#"===t[i])return i===t.length-1;if(-1!==t[i].indexOf("+")||-1!==t[i].indexOf("#"))return!1}return!0}t.exports={validateTopics:function(e){if(0===e.length)return"empty_topic_list";for(let t=0;t<e.length;t++)if(!n(e[t]))return e[t];return null}}},{}],12:[function(e,t,i){(function(i){(function(){const n=e("../client"),o=e("../store"),s=e("url"),r=e("xtend"),a=e("debug")("mqttjs"),l={};function c(e,t){if(a("connecting to an MQTT broker..."),"object"!=typeof e||t||(t=e,e=null),t=t||{},e){const i=s.parse(e,!0);if(null!=i.port&&(i.port=Number(i.port)),null===(t=r(i,t)).protocol)throw new Error("Missing protocol");t.protocol=t.protocol.replace(/:$/,"")}if(function(e){let t;e.auth&&((t=e.auth.match(/^(.+):(.+)$/))?(e.username=t[1],e.password=t[2]):e.username=e.auth)}(t),t.query&&"string"==typeof t.query.clientId&&(t.clientId=t.query.clientId),t.cert&&t.key){if(!t.protocol)throw new Error("Missing secure protocol key");if(-1===["mqtts","wss","wxs","alis"].indexOf(t.protocol))switch(t.protocol){case"mqtt":t.protocol="mqtts";break;case"ws":t.protocol="wss";break;case"wx":t.protocol="wxs";break;case"ali":t.protocol="alis";break;default:throw new Error('Unknown protocol for secure connection: "'+t.protocol+'"!')}}if(!l[t.protocol]){const e=-1!==["mqtts","wss"].indexOf(t.protocol);t.protocol=["mqtt","mqtts","ws","wss","wx","wxs","ali","alis"].filter((function(t,i){return(!e||i%2!=0)&&"function"==typeof l[t]}))[0]}if(!1===t.clean&&!t.clientId)throw new Error("Missing clientId for unclean clients");t.protocol&&(t.defaultProtocol=t.protocol);const i=new n((function(e){return t.servers&&(e._reconnectCount&&e._reconnectCount!==t.servers.length||(e._reconnectCount=0),t.host=t.servers[e._reconnectCount].host,t.port=t.servers[e._reconnectCount].port,t.protocol=t.servers[e._reconnectCount].protocol?t.servers[e._reconnectCount].protocol:t.defaultProtocol,t.hostname=t.host,e._reconnectCount++),a("calling streambuilder for",t.protocol),l[t.protocol](e,t)}),t);return i.on("error",(function(){})),i}void 0!==i&&"browser"!==i.title||"function"!=typeof __webpack_require__?(l.mqtt=e("./tcp"),l.tcp=e("./tcp"),l.ssl=e("./tls"),l.tls=e("./tls"),l.mqtts=e("./tls")):(l.wx=e("./wx"),l.wxs=e("./wx"),l.ali=e("./ali"),l.alis=e("./ali")),l.ws=e("./ws"),l.wss=e("./ws"),t.exports=c,t.exports.connect=c,t.exports.MqttClient=n,t.exports.Store=o}).call(this)}).call(this,e("_process"))},{"../client":1,"../store":8,"./ali":2,"./tcp":3,"./tls":4,"./ws":5,"./wx":6,_process:50,debug:18,url:76,xtend:81}],13:[function(e,t,i){i.byteLength=function(e){var t=c(e),i=t[0],n=t[1];return 3*(i+n)/4-n},i.toByteArray=function(e){var t,i,n,r=c(e),a=r[0],l=r[1],h=new s(3*(a+(n=l))/4-n),d=0,u=l>0?a-4:a;for(i=0;i<u;i+=4)t=o[e.charCodeAt(i)]<<18|o[e.charCodeAt(i+1)]<<12|o[e.charCodeAt(i+2)]<<6|o[e.charCodeAt(i+3)],h[d++]=t>>16&255,h[d++]=t>>8&255,h[d++]=255&t;return 2===l&&(t=o[e.charCodeAt(i)]<<2|o[e.charCodeAt(i+1)]>>4,h[d++]=255&t),1===l&&(t=o[e.charCodeAt(i)]<<10|o[e.charCodeAt(i+1)]<<4|o[e.charCodeAt(i+2)]>>2,h[d++]=t>>8&255,h[d++]=255&t),h},i.fromByteArray=function(e){for(var t,i=e.length,o=i%3,s=[],r=0,a=i-o;r<a;r+=16383)s.push(h(e,r,r+16383>a?a:r+16383));return 1===o?(t=e[i-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===o&&(t=(e[i-2]<<8)+e[i-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),s.join("")};for(var n=[],o=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,l=r.length;a<l;++a)n[a]=r[a],o[r.charCodeAt(a)]=a;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function h(e,t,i){for(var o,s,r=[],a=t;a<i;a+=3)o=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),r.push(n[(s=o)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return r.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63},{}],14:[function(e,t,i){const{Buffer:n}=e("buffer"),o=Symbol.for("BufferList");function s(e){if(!(this instanceof s))return new s(e);s._init.call(this,e)}s._init=function(e){Object.defineProperty(this,o,{value:!0}),this._bufs=[],this.length=0,e&&this.append(e)},s.prototype._new=function(e){return new s(e)},s.prototype._offset=function(e){if(0===e)return[0,0];let t=0;for(let i=0;i<this._bufs.length;i++){const n=t+this._bufs[i].length;if(e<n||i===this._bufs.length-1)return[i,e-t];t=n}},s.prototype._reverseOffset=function(e){const t=e[0];let i=e[1];for(let n=0;n<t;n++)i+=this._bufs[n].length;return i},s.prototype.get=function(e){if(e>this.length||e<0)return;const t=this._offset(e);return this._bufs[t[0]][t[1]]},s.prototype.slice=function(e,t){return"number"==typeof e&&e<0&&(e+=this.length),"number"==typeof t&&t<0&&(t+=this.length),this.copy(null,0,e,t)},s.prototype.copy=function(e,t,i,o){if(("number"!=typeof i||i<0)&&(i=0),("number"!=typeof o||o>this.length)&&(o=this.length),i>=this.length)return e||n.alloc(0);if(o<=0)return e||n.alloc(0);const s=!!e,r=this._offset(i),a=o-i;let l=a,c=s&&t||0,h=r[1];if(0===i&&o===this.length){if(!s)return 1===this._bufs.length?this._bufs[0]:n.concat(this._bufs,this.length);for(let t=0;t<this._bufs.length;t++)this._bufs[t].copy(e,c),c+=this._bufs[t].length;return e}if(l<=this._bufs[r[0]].length-h)return s?this._bufs[r[0]].copy(e,t,h,h+l):this._bufs[r[0]].slice(h,h+l);s||(e=n.allocUnsafe(a));for(let n=r[0];n<this._bufs.length;n++){const t=this._bufs[n].length-h;if(!(l>t)){this._bufs[n].copy(e,c,h,h+l),c+=t;break}this._bufs[n].copy(e,c,h),c+=t,l-=t,h&&(h=0)}return e.length>c?e.slice(0,c):e},s.prototype.shallowSlice=function(e,t){if(e=e||0,t="number"!=typeof t?this.length:t,e<0&&(e+=this.length),t<0&&(t+=this.length),e===t)return this._new();const i=this._offset(e),n=this._offset(t),o=this._bufs.slice(i[0],n[0]+1);return 0===n[1]?o.pop():o[o.length-1]=o[o.length-1].slice(0,n[1]),0!==i[1]&&(o[0]=o[0].slice(i[1])),this._new(o)},s.prototype.toString=function(e,t,i){return this.slice(t,i).toString(e)},s.prototype.consume=function(e){if(e=Math.trunc(e),Number.isNaN(e)||e<=0)return this;for(;this._bufs.length;){if(!(e>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(e),this.length-=e;break}e-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this},s.prototype.duplicate=function(){const e=this._new();for(let t=0;t<this._bufs.length;t++)e.append(this._bufs[t]);return e},s.prototype.append=function(e){if(null==e)return this;if(e.buffer)this._appendBuffer(n.from(e.buffer,e.byteOffset,e.byteLength));else if(Array.isArray(e))for(let t=0;t<e.length;t++)this.append(e[t]);else if(this._isBufferList(e))for(let t=0;t<e._bufs.length;t++)this.append(e._bufs[t]);else"number"==typeof e&&(e=e.toString()),this._appendBuffer(n.from(e));return this},s.prototype._appendBuffer=function(e){this._bufs.push(e),this.length+=e.length},s.prototype.indexOf=function(e,t,i){if(void 0===i&&"string"==typeof t&&(i=t,t=void 0),"function"==typeof e||Array.isArray(e))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if("number"==typeof e?e=n.from([e]):"string"==typeof e?e=n.from(e,i):this._isBufferList(e)?e=e.slice():Array.isArray(e.buffer)?e=n.from(e.buffer,e.byteOffset,e.byteLength):n.isBuffer(e)||(e=n.from(e)),t=Number(t||0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const o=this._offset(t);let s=o[0],r=o[1];for(;s<this._bufs.length;s++){const t=this._bufs[s];for(;r<t.length;)if(t.length-r>=e.length){const i=t.indexOf(e,r);if(-1!==i)return this._reverseOffset([s,i]);r=t.length-e.length+1}else{const t=this._reverseOffset([s,r]);if(this._match(t,e))return t;r++}r=0}return-1},s.prototype._match=function(e,t){if(this.length-e<t.length)return!1;for(let i=0;i<t.length;i++)if(this.get(e+i)!==t[i])return!1;return!0},function(){const e={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const t in e)!function(t){s.prototype[t]=null===e[t]?function(e,i){return this.slice(e,e+i)[t](0,i)}:function(i=0){return this.slice(i,i+e[t])[t](0)}}(t)}(),s.prototype._isBufferList=function(e){return e instanceof s||s.isBufferList(e)},s.isBufferList=function(e){return null!=e&&e[o]},t.exports=s},{buffer:17}],15:[function(e,t,i){const n=e("readable-stream").Duplex,o=e("inherits"),s=e("./BufferList");function r(e){if(!(this instanceof r))return new r(e);if("function"==typeof e){this._callback=e;const t=function(e){this._callback&&(this._callback(e),this._callback=null)}.bind(this);this.on("pipe",(function(e){e.on("error",t)})),this.on("unpipe",(function(e){e.removeListener("error",t)})),e=null}s._init.call(this,e),n.call(this)}o(r,n),Object.assign(r.prototype,s.prototype),r.prototype._new=function(e){return new r(e)},r.prototype._write=function(e,t,i){this._appendBuffer(e),"function"==typeof i&&i()},r.prototype._read=function(e){if(!this.length)return this.push(null);e=Math.min(e,this.length),this.push(this.slice(0,e)),this.consume(e)},r.prototype.end=function(e){n.prototype.end.call(this,e),this._callback&&(this._callback(null,this.slice()),this._callback=null)},r.prototype._destroy=function(e,t){this._bufs.length=0,this.length=0,t(e)},r.prototype._isBufferList=function(e){return e instanceof r||e instanceof s||r.isBufferList(e)},r.isBufferList=s.isBufferList,t.exports=r,t.exports.BufferListStream=r,t.exports.BufferList=s},{"./BufferList":14,inherits:24,"readable-stream":69}],16:[function(e,t,i){},{}],17:[function(e,t,i){(function(t){(function(){var t=e("base64-js"),n=e("ieee754");i.Buffer=r,i.SlowBuffer=function(e){return+e!=e&&(e=0),r.alloc(+e)},i.INSPECT_MAX_BYTES=50;var o=2147483647;function s(e){if(e>o)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=r.prototype,t}function r(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return c(e)}return a(e,t,i)}function a(e,t,i){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!r.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var i=0|u(e,t),n=s(i),o=n.write(e,t);return o!==i&&(n=n.slice(0,o)),n}(e,t);if(ArrayBuffer.isView(e))return h(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(z(e,ArrayBuffer)||e&&z(e.buffer,ArrayBuffer))return function(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');var n;return(n=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i)).__proto__=r.prototype,n}(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return r.from(n,t,i);var o=function(e){if(r.isBuffer(e)){var t=0|d(e.length),i=s(t);return 0===i.length||e.copy(i,0,0,t),i}return void 0!==e.length?"number"!=typeof e.length||H(e.length)?s(0):h(e):"Buffer"===e.type&&Array.isArray(e.data)?h(e.data):void 0}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return r.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function c(e){return l(e),s(e<0?0:0|d(e))}function h(e){for(var t=e.length<0?0:0|d(e.length),i=s(t),n=0;n<t;n+=1)i[n]=255&e[n];return i}function d(e){if(e>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return 0|e}function u(e,t){if(r.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||z(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var i=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===i)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return O(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return B(e).length;default:if(o)return n?-1:O(e).length;t=(""+t).toLowerCase(),o=!0}}function p(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function f(e,t,i,n,o){if(0===e.length)return-1;if("string"==typeof i?(n=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),H(i=+i)&&(i=o?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(o)return-1;i=e.length-1}else if(i<0){if(!o)return-1;i=0}if("string"==typeof t&&(t=r.from(t,n)),r.isBuffer(t))return 0===t.length?-1:v(e,t,i,n,o);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):v(e,[t],i,n,o);throw new TypeError("val must be string, number or Buffer")}function v(e,t,i,n,o){var s,r=1,a=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;r=2,a/=2,l/=2,i/=2}function c(e,t){return 1===r?e[t]:e.readUInt16BE(t*r)}if(o){var h=-1;for(s=i;s<a;s++)if(c(e,s)===c(t,-1===h?0:s-h)){if(-1===h&&(h=s),s-h+1===l)return h*r}else-1!==h&&(s-=s-h),h=-1}else for(i+l>a&&(i=a-l),s=i;s>=0;s--){for(var d=!0,u=0;u<l;u++)if(c(e,s+u)!==c(t,u)){d=!1;break}if(d)return s}return-1}function g(e,t,i,n){i=Number(i)||0;var o=e.length-i;n?(n=Number(n))>o&&(n=o):n=o;var s=t.length;n>s/2&&(n=s/2);for(var r=0;r<n;++r){var a=parseInt(t.substr(2*r,2),16);if(H(a))return r;e[i+r]=a}return r}function y(e,t,i,n){return N(O(t,e.length-i),e,i,n)}function m(e,t,i,n){return N(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,n)}function w(e,t,i,n){return m(e,t,i,n)}function b(e,t,i,n){return N(B(t),e,i,n)}function x(e,t,i,n){return N(function(e,t){for(var i,n,o,s=[],r=0;r<e.length&&!((t-=2)<0);++r)n=(i=e.charCodeAt(r))>>8,o=i%256,s.push(o),s.push(n);return s}(t,e.length-i),e,i,n)}function k(e,i,n){return 0===i&&n===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(i,n))}function T(e,t,i){i=Math.min(e.length,i);for(var n=[],o=t;o<i;){var s,r,a,l,c=e[o],h=null,d=c>239?4:c>223?3:c>191?2:1;if(o+d<=i)switch(d){case 1:c<128&&(h=c);break;case 2:128==(192&(s=e[o+1]))&&(l=(31&c)<<6|63&s)>127&&(h=l);break;case 3:s=e[o+1],r=e[o+2],128==(192&s)&&128==(192&r)&&(l=(15&c)<<12|(63&s)<<6|63&r)>2047&&(l<55296||l>57343)&&(h=l);break;case 4:s=e[o+1],r=e[o+2],a=e[o+3],128==(192&s)&&128==(192&r)&&128==(192&a)&&(l=(15&c)<<18|(63&s)<<12|(63&r)<<6|63&a)>65535&&l<1114112&&(h=l)}null===h?(h=65533,d=1):h>65535&&(h-=65536,n.push(h>>>10&1023|55296),h=56320|1023&h),n.push(h),o+=d}return function(e){var t=e.length;if(t<=C)return String.fromCharCode.apply(String,e);for(var i="",n=0;n<t;)i+=String.fromCharCode.apply(String,e.slice(n,n+=C));return i}(n)}i.kMaxLength=o,r.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(t){return!1}}(),r.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||console.error,Object.defineProperty(r.prototype,"parent",{enumerable:!0,get:function(){if(r.isBuffer(this))return this.buffer}}),Object.defineProperty(r.prototype,"offset",{enumerable:!0,get:function(){if(r.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&r[Symbol.species]===r&&Object.defineProperty(r,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),r.poolSize=8192,r.from=function(e,t,i){return a(e,t,i)},r.prototype.__proto__=Uint8Array.prototype,r.__proto__=Uint8Array,r.alloc=function(e,t,i){return o=t,r=i,l(n=e),n<=0?s(n):void 0!==o?"string"==typeof r?s(n).fill(o,r):s(n).fill(o):s(n);var n,o,r},r.allocUnsafe=function(e){return c(e)},r.allocUnsafeSlow=function(e){return c(e)},r.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==r.prototype},r.compare=function(e,t){if(z(e,Uint8Array)&&(e=r.from(e,e.offset,e.byteLength)),z(t,Uint8Array)&&(t=r.from(t,t.offset,t.byteLength)),!r.isBuffer(e)||!r.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var i=e.length,n=t.length,o=0,s=Math.min(i,n);o<s;++o)if(e[o]!==t[o]){i=e[o],n=t[o];break}return i<n?-1:n<i?1:0},r.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return r.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var n=r.allocUnsafe(t),o=0;for(i=0;i<e.length;++i){var s=e[i];if(z(s,Uint8Array)&&(s=r.from(s)),!r.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(n,o),o+=s.length}return n},r.byteLength=u,r.prototype._isBuffer=!0,r.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},r.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},r.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},r.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?T(this,0,e):function(e,t,i){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return _(this,t,i);case"utf8":case"utf-8":return T(this,t,i);case"ascii":return A(this,t,i);case"latin1":case"binary":return R(this,t,i);case"base64":return k(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,t,i);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}.apply(this,arguments)},r.prototype.toLocaleString=r.prototype.toString,r.prototype.equals=function(e){if(!r.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===r.compare(this,e)},r.prototype.inspect=function(){var e="",t=i.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},r.prototype.compare=function(e,t,i,n,o){if(z(e,Uint8Array)&&(e=r.from(e,e.offset,e.byteLength)),!r.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===n&&(n=0),void 0===o&&(o=this.length),t<0||i>e.length||n<0||o>this.length)throw new RangeError("out of range index");if(n>=o&&t>=i)return 0;if(n>=o)return-1;if(t>=i)return 1;if(this===e)return 0;for(var s=(o>>>=0)-(n>>>=0),a=(i>>>=0)-(t>>>=0),l=Math.min(s,a),c=this.slice(n,o),h=e.slice(t,i),d=0;d<l;++d)if(c[d]!==h[d]){s=c[d],a=h[d];break}return s<a?-1:a<s?1:0},r.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},r.prototype.indexOf=function(e,t,i){return f(this,e,t,i,!0)},r.prototype.lastIndexOf=function(e,t,i){return f(this,e,t,i,!1)},r.prototype.write=function(e,t,i,n){if(void 0===t)n="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)n=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}var o=this.length-t;if((void 0===i||i>o)&&(i=o),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var s=!1;;)switch(n){case"hex":return g(this,e,t,i);case"utf8":case"utf-8":return y(this,e,t,i);case"ascii":return m(this,e,t,i);case"latin1":case"binary":return w(this,e,t,i);case"base64":return b(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return x(this,e,t,i);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},r.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var C=4096;function A(e,t,i){var n="";i=Math.min(e.length,i);for(var o=t;o<i;++o)n+=String.fromCharCode(127&e[o]);return n}function R(e,t,i){var n="";i=Math.min(e.length,i);for(var o=t;o<i;++o)n+=String.fromCharCode(e[o]);return n}function _(e,t,i){var n=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>n)&&(i=n);for(var o="",s=t;s<i;++s)o+=F(e[s]);return o}function S(e,t,i){for(var n=e.slice(t,i),o="",s=0;s<n.length;s+=2)o+=String.fromCharCode(n[s]+256*n[s+1]);return o}function P(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function E(e,t,i,n,o,s){if(!r.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>o||t<s)throw new RangeError('"value" argument is out of bounds');if(i+n>e.length)throw new RangeError("Index out of range")}function I(e,t,i,n,o,s){if(i+n>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function L(e,t,i,o,s){return t=+t,i>>>=0,s||I(e,0,i,4),n.write(e,t,i,o,23,4),i+4}function M(e,t,i,o,s){return t=+t,i>>>=0,s||I(e,0,i,8),n.write(e,t,i,o,52,8),i+8}r.prototype.slice=function(e,t){var i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);var n=this.subarray(e,t);return n.__proto__=r.prototype,n},r.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||P(e,t,this.length);for(var n=this[e],o=1,s=0;++s<t&&(o*=256);)n+=this[e+s]*o;return n},r.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||P(e,t,this.length);for(var n=this[e+--t],o=1;t>0&&(o*=256);)n+=this[e+--t]*o;return n},r.prototype.readUInt8=function(e,t){return e>>>=0,t||P(e,1,this.length),this[e]},r.prototype.readUInt16LE=function(e,t){return e>>>=0,t||P(e,2,this.length),this[e]|this[e+1]<<8},r.prototype.readUInt16BE=function(e,t){return e>>>=0,t||P(e,2,this.length),this[e]<<8|this[e+1]},r.prototype.readUInt32LE=function(e,t){return e>>>=0,t||P(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},r.prototype.readUInt32BE=function(e,t){return e>>>=0,t||P(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},r.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||P(e,t,this.length);for(var n=this[e],o=1,s=0;++s<t&&(o*=256);)n+=this[e+s]*o;return n>=(o*=128)&&(n-=Math.pow(2,8*t)),n},r.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||P(e,t,this.length);for(var n=t,o=1,s=this[e+--n];n>0&&(o*=256);)s+=this[e+--n]*o;return s>=(o*=128)&&(s-=Math.pow(2,8*t)),s},r.prototype.readInt8=function(e,t){return e>>>=0,t||P(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},r.prototype.readInt16LE=function(e,t){e>>>=0,t||P(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},r.prototype.readInt16BE=function(e,t){e>>>=0,t||P(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},r.prototype.readInt32LE=function(e,t){return e>>>=0,t||P(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},r.prototype.readInt32BE=function(e,t){return e>>>=0,t||P(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},r.prototype.readFloatLE=function(e,t){return e>>>=0,t||P(e,4,this.length),n.read(this,e,!0,23,4)},r.prototype.readFloatBE=function(e,t){return e>>>=0,t||P(e,4,this.length),n.read(this,e,!1,23,4)},r.prototype.readDoubleLE=function(e,t){return e>>>=0,t||P(e,8,this.length),n.read(this,e,!0,52,8)},r.prototype.readDoubleBE=function(e,t){return e>>>=0,t||P(e,8,this.length),n.read(this,e,!1,52,8)},r.prototype.writeUIntLE=function(e,t,i,n){e=+e,t>>>=0,i>>>=0,n||E(this,e,t,i,Math.pow(2,8*i)-1,0);var o=1,s=0;for(this[t]=255&e;++s<i&&(o*=256);)this[t+s]=e/o&255;return t+i},r.prototype.writeUIntBE=function(e,t,i,n){e=+e,t>>>=0,i>>>=0,n||E(this,e,t,i,Math.pow(2,8*i)-1,0);var o=i-1,s=1;for(this[t+o]=255&e;--o>=0&&(s*=256);)this[t+o]=e/s&255;return t+i},r.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,1,255,0),this[t]=255&e,t+1},r.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},r.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},r.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},r.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},r.prototype.writeIntLE=function(e,t,i,n){if(e=+e,t>>>=0,!n){var o=Math.pow(2,8*i-1);E(this,e,t,i,o-1,-o)}var s=0,r=1,a=0;for(this[t]=255&e;++s<i&&(r*=256);)e<0&&0===a&&0!==this[t+s-1]&&(a=1),this[t+s]=(e/r|0)-a&255;return t+i},r.prototype.writeIntBE=function(e,t,i,n){if(e=+e,t>>>=0,!n){var o=Math.pow(2,8*i-1);E(this,e,t,i,o-1,-o)}var s=i-1,r=1,a=0;for(this[t+s]=255&e;--s>=0&&(r*=256);)e<0&&0===a&&0!==this[t+s+1]&&(a=1),this[t+s]=(e/r|0)-a&255;return t+i},r.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},r.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},r.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},r.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},r.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||E(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},r.prototype.writeFloatLE=function(e,t,i){return L(this,e,t,!0,i)},r.prototype.writeFloatBE=function(e,t,i){return L(this,e,t,!1,i)},r.prototype.writeDoubleLE=function(e,t,i){return M(this,e,t,!0,i)},r.prototype.writeDoubleBE=function(e,t,i){return M(this,e,t,!1,i)},r.prototype.copy=function(e,t,i,n){if(!r.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<i&&(n=i),n===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-i&&(n=e.length-t+i);var o=n-i;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,i,n);else if(this===e&&i<t&&t<n)for(var s=o-1;s>=0;--s)e[s+t]=this[s+i];else Uint8Array.prototype.set.call(e,this.subarray(i,n),t);return o},r.prototype.fill=function(e,t,i,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!r.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){var o=e.charCodeAt(0);("utf8"===n&&o<128||"latin1"===n)&&(e=o)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{var a=r.isBuffer(e)?e:r.from(e,n),l=a.length;if(0===l)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<i-t;++s)this[s+t]=a[s%l]}return this};var D=/[^+/0-9A-Za-z-_]/g;function F(e){return e<16?"0"+e.toString(16):e.toString(16)}function O(e,t){var i;t=t||1/0;for(var n=e.length,o=null,s=[],r=0;r<n;++r){if((i=e.charCodeAt(r))>55295&&i<57344){if(!o){if(i>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(r+1===n){(t-=3)>-1&&s.push(239,191,189);continue}o=i;continue}if(i<56320){(t-=3)>-1&&s.push(239,191,189),o=i;continue}i=65536+(o-55296<<10|i-56320)}else o&&(t-=3)>-1&&s.push(239,191,189);if(o=null,i<128){if((t-=1)<0)break;s.push(i)}else if(i<2048){if((t-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function B(e){return t.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(D,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function N(e,t,i,n){for(var o=0;o<n&&!(o+i>=t.length||o>=e.length);++o)t[o+i]=e[o];return o}function z(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function H(e){return e!=e}}).call(this)}).call(this,e("buffer").Buffer)},{"base64-js":13,buffer:17,ieee754:23}],18:[function(e,t,i){(function(n){(function(){i.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;e.splice(1,0,i,"color: inherit");let n=0,o=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&"%c"===e&&(o=++n)})),e.splice(o,0,i)},i.save=function(e){try{e?i.storage.setItem("debug",e):i.storage.removeItem("debug")}catch(t){}},i.load=function(){let e;try{e=i.storage.getItem("debug")}catch(t){}return!e&&void 0!==n&&"env"in n&&(e=n.env.DEBUG),e},i.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},i.storage=function(){try{return localStorage}catch(e){}}(),i.destroy=(()=>{let e=!1;return()=>{e||(e=!0)}})(),i.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],i.log=console.debug||console.log||(()=>{}),t.exports=e("./common")(i);const{formatters:o}=t.exports;o.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}).call(this)}).call(this,e("_process"))},{"./common":19,_process:50}],19:[function(e,t,i){t.exports=function(t){function i(e){let t,o,s,r=null;function a(...e){if(!a.enabled)return;const n=a,o=Number(new Date),s=o-(t||o);n.diff=s,n.prev=t,n.curr=o,t=o,e[0]=i.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let r=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((t,o)=>{if("%%"===t)return"%";r++;const s=i.formatters[o];if("function"==typeof s){const i=e[r];t=s.call(n,i),e.splice(r,1),r--}return t})),i.formatArgs.call(n,e),(n.log||i.log).apply(n,e)}return a.namespace=e,a.useColors=i.useColors(),a.color=i.selectColor(e),a.extend=n,a.destroy=i.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==r?r:(o!==i.namespaces&&(o=i.namespaces,s=i.enabled(e)),s),set:e=>{r=e}}),"function"==typeof i.init&&i.init(a),a}function n(e,t){const n=i(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return i.debug=i,i.default=i,i.coerce=function(e){return e instanceof Error?e.stack||e.message:e},i.disable=function(){const e=[...i.names.map(o),...i.skips.map(o).map((e=>"-"+e))].join(",");return i.enable(""),e},i.enable=function(e){let t;i.save(e),i.namespaces=e,i.names=[],i.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),o=n.length;for(t=0;t<o;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?i.skips.push(new RegExp("^"+e.substr(1)+"$")):i.names.push(new RegExp("^"+e+"$")))},i.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=i.skips.length;t<n;t++)if(i.skips[t].test(e))return!1;for(t=0,n=i.names.length;t<n;t++)if(i.names[t].test(e))return!0;return!1},i.humanize=e("ms"),i.destroy=function(){},Object.keys(t).forEach((e=>{i[e]=t[e]})),i.names=[],i.skips=[],i.formatters={},i.selectColor=function(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return i.colors[Math.abs(t)%i.colors.length]},i.enable(i.load()),i}},{ms:45}],20:[function(e,t,i){(function(i,n){(function(){var o=e("readable-stream"),s=e("end-of-stream"),r=e("inherits"),a=e("stream-shift"),l=n.from&&n.from!==Uint8Array.from?n.from([0]):new n([0]),c=function(e,t){e._corked?e.once("uncork",t):t()},h=function(e,t){return function(i){var n,o;i?(n=e,o="premature close"===i.message?null:i,n._autoDestroy&&n.destroy(o)):t&&!e._ended&&e.end()}},d=function(){},u=function(e,t,i){if(!(this instanceof u))return new u(e,t,i);o.Duplex.call(this,i),this._writable=null,this._readable=null,this._readable2=null,this._autoDestroy=!i||!1!==i.autoDestroy,this._forwardDestroy=!i||!1!==i.destroy,this._forwardEnd=!i||!1!==i.end,this._corked=1,this._ondrain=null,this._drained=!1,this._forwarding=!1,this._unwrite=null,this._unread=null,this._ended=!1,this.destroyed=!1,e&&this.setWritable(e),t&&this.setReadable(t)};r(u,o.Duplex),u.obj=function(e,t,i){return i||(i={}),i.objectMode=!0,i.highWaterMark=16,new u(e,t,i)},u.prototype.cork=function(){1==++this._corked&&this.emit("cork")},u.prototype.uncork=function(){this._corked&&0==--this._corked&&this.emit("uncork")},u.prototype.setWritable=function(e){if(this._unwrite&&this._unwrite(),this.destroyed)e&&e.destroy&&e.destroy();else if(null!==e&&!1!==e){var t=this,n=s(e,{writable:!0,readable:!1},h(this,this._forwardEnd)),o=function(){var e=t._ondrain;t._ondrain=null,e&&e()};this._unwrite&&i.nextTick(o),this._writable=e,this._writable.on("drain",o),this._unwrite=function(){t._writable.removeListener("drain",o),n()},this.uncork()}else this.end()},u.prototype.setReadable=function(e){if(this._unread&&this._unread(),this.destroyed)e&&e.destroy&&e.destroy();else{if(null===e||!1===e)return this.push(null),void this.resume();var t,i=this,n=s(e,{writable:!1,readable:!0},h(this)),r=function(){i._forward()},a=function(){i.push(null)};this._drained=!0,this._readable=e,this._readable2=e._readableState?e:(t=e,new o.Readable({objectMode:!0,highWaterMark:16}).wrap(t)),this._readable2.on("readable",r),this._readable2.on("end",a),this._unread=function(){i._readable2.removeListener("readable",r),i._readable2.removeListener("end",a),n()},this._forward()}},u.prototype._read=function(){this._drained=!0,this._forward()},u.prototype._forward=function(){if(!this._forwarding&&this._readable2&&this._drained){var e;for(this._forwarding=!0;this._drained&&null!==(e=a(this._readable2));)this.destroyed||(this._drained=this.push(e));this._forwarding=!1}},u.prototype.destroy=function(e,t){if(t||(t=d),this.destroyed)return t(null);this.destroyed=!0;var n=this;i.nextTick((function(){n._destroy(e),t(null)}))},u.prototype._destroy=function(e){if(e){var t=this._ondrain;this._ondrain=null,t?t(e):this.emit("error",e)}this._forwardDestroy&&(this._readable&&this._readable.destroy&&this._readable.destroy(),this._writable&&this._writable.destroy&&this._writable.destroy()),this.emit("close")},u.prototype._write=function(e,t,i){if(!this.destroyed)return this._corked?c(this,this._write.bind(this,e,t,i)):e===l?this._finish(i):this._writable?void(!1===this._writable.write(e)?this._ondrain=i:this.destroyed||i()):i()},u.prototype._finish=function(e){var t=this;this.emit("preend"),c(this,(function(){var i,n;n=function(){!1===t._writableState.prefinished&&(t._writableState.prefinished=!0),t.emit("prefinish"),c(t,e)},(i=t._forwardEnd&&t._writable)?i._writableState&&i._writableState.finished?n():i._writableState?i.end(n):(i.end(),n()):n()}))},u.prototype.end=function(e,t,i){return"function"==typeof e?this.end(null,null,e):"function"==typeof t?this.end(e,null,t):(this._ended=!0,e&&this.write(e),this._writableState.ending||this._writableState.destroyed||this.write(l),o.Writable.prototype.end.call(this,i))},t.exports=u}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:50,buffer:17,"end-of-stream":21,inherits:24,"readable-stream":69,"stream-shift":74}],21:[function(e,t,i){(function(i){(function(){var n=e("once"),o=function(){},s=function(e,t,r){if("function"==typeof t)return s(e,null,t);t||(t={}),r=n(r||o);var a,l=e._writableState,c=e._readableState,h=t.readable||!1!==t.readable&&e.readable,d=t.writable||!1!==t.writable&&e.writable,u=!1,p=function(){e.writable||f()},f=function(){d=!1,h||r.call(e)},v=function(){h=!1,d||r.call(e)},g=function(t){r.call(e,t?new Error("exited with error code: "+t):null)},y=function(t){r.call(e,t)},m=function(){i.nextTick(w)},w=function(){if(!u)return(!h||c&&c.ended&&!c.destroyed)&&(!d||l&&l.ended&&!l.destroyed)?void 0:r.call(e,new Error("premature close"))},b=function(){e.req.on("finish",f)};return(a=e).setHeader&&"function"==typeof a.abort?(e.on("complete",f),e.on("abort",m),e.req?b():e.on("request",b)):d&&!l&&(e.on("end",p),e.on("close",p)),function(e){return e.stdio&&Array.isArray(e.stdio)&&3===e.stdio.length}(e)&&e.on("exit",g),e.on("end",v),e.on("finish",f),!1!==t.error&&e.on("error",y),e.on("close",m),function(){u=!0,e.removeListener("complete",f),e.removeListener("abort",m),e.removeListener("request",b),e.req&&e.req.removeListener("finish",f),e.removeListener("end",p),e.removeListener("close",p),e.removeListener("finish",f),e.removeListener("exit",g),e.removeListener("end",v),e.removeListener("error",y),e.removeListener("close",m)}};t.exports=s}).call(this)}).call(this,e("_process"))},{_process:50,once:48}],22:[function(e,t,i){var n=Object.create||function(e){var t=function(){};return t.prototype=e,new t},o=Object.keys||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.push(i);return i},s=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function r(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=n(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0;var a,l=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),a=0===c.x}catch(y){a=!1}function h(e){return void 0===e._maxListeners?r.defaultMaxListeners:e._maxListeners}function d(e,t,i,o){var s,r,a;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if((r=e._events)?(r.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),r=e._events),a=r[t]):(r=e._events=n(null),e._eventsCount=0),a){if("function"==typeof a?a=r[t]=o?[i,a]:[a,i]:o?a.unshift(i):a.push(i),!a.warned&&(s=h(e))&&s>0&&a.length>s){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=a.length,"object"==typeof console&&console.warn}}else a=r[t]=i,++e._eventsCount;return e}function u(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function p(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},o=s.call(u,n);return o.listener=i,n.wrapFn=o,o}function f(e,t,i){var n=e._events;if(!n)return[];var o=n[t];return o?"function"==typeof o?i?[o.listener||o]:[o]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(o):g(o,o.length):[]}function v(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function g(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}a?Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');l=e}}):r.defaultMaxListeners=l,r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},r.prototype.getMaxListeners=function(){return h(this)},r.prototype.emit=function(e){var t,i,n,o,s,r,a="error"===e;if(r=this._events)a=a&&null==r.error;else if(!a)return!1;if(a){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var l=new Error('Unhandled "error" event. ('+t+")");throw l.context=t,l}if(!(i=r[e]))return!1;var c="function"==typeof i;switch(n=arguments.length){case 1:!function(e,t,i){if(t)e.call(i);else for(var n=e.length,o=g(e,n),s=0;s<n;++s)o[s].call(i)}(i,c,this);break;case 2:!function(e,t,i,n){if(t)e.call(i,n);else for(var o=e.length,s=g(e,o),r=0;r<o;++r)s[r].call(i,n)}(i,c,this,arguments[1]);break;case 3:!function(e,t,i,n,o){if(t)e.call(i,n,o);else for(var s=e.length,r=g(e,s),a=0;a<s;++a)r[a].call(i,n,o)}(i,c,this,arguments[1],arguments[2]);break;case 4:!function(e,t,i,n,o,s){if(t)e.call(i,n,o,s);else for(var r=e.length,a=g(e,r),l=0;l<r;++l)a[l].call(i,n,o,s)}(i,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(n-1),s=1;s<n;s++)o[s-1]=arguments[s];!function(e,t,i,n){if(t)e.apply(i,n);else for(var o=e.length,s=g(e,o),r=0;r<o;++r)s[r].apply(i,n)}(i,c,this,o)}return!0},r.prototype.addListener=function(e,t){return d(this,e,t,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(e,t){return d(this,e,t,!0)},r.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,p(this,e,t)),this},r.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,p(this,e,t)),this},r.prototype.removeListener=function(e,t){var i,o,s,r,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(i=o[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=n(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,r=i.length-1;r>=0;r--)if(i[r]===t||i[r].listener===t){a=i[r].listener,s=r;break}if(s<0)return this;0===s?i.shift():function(e,t){for(var i=t,n=i+1,o=e.length;n<o;i+=1,n+=1)e[i]=e[n];e.pop()}(i,s),1===i.length&&(o[e]=i[0]),o.removeListener&&this.emit("removeListener",e,a||t)}return this},r.prototype.removeAllListeners=function(e){var t,i,s;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=n(null),this._eventsCount=0):i[e]&&(0==--this._eventsCount?this._events=n(null):delete i[e]),this;if(0===arguments.length){var r,a=o(i);for(s=0;s<a.length;++s)"removeListener"!==(r=a[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=n(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},r.prototype.listeners=function(e){return f(this,e,!0)},r.prototype.rawListeners=function(e){return f(this,e,!1)},r.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):v.call(e,t)},r.prototype.listenerCount=v,r.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],23:[function(e,t,i){i.read=function(e,t,i,n,o){var s,r,a=8*o-n-1,l=(1<<a)-1,c=l>>1,h=-7,d=i?o-1:0,u=i?-1:1,p=e[t+d];for(d+=u,s=p&(1<<-h)-1,p>>=-h,h+=a;h>0;s=256*s+e[t+d],d+=u,h-=8);for(r=s&(1<<-h)-1,s>>=-h,h+=n;h>0;r=256*r+e[t+d],d+=u,h-=8);if(0===s)s=1-c;else{if(s===l)return r?NaN:1/0*(p?-1:1);r+=Math.pow(2,n),s-=c}return(p?-1:1)*r*Math.pow(2,s-n)},i.write=function(e,t,i,n,o,s){var r,a,l,c=8*s-o-1,h=(1<<c)-1,d=h>>1,u=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:s-1,f=n?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,r=h):(r=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-r))<1&&(r--,l*=2),(t+=r+d>=1?u/l:u*Math.pow(2,1-d))*l>=2&&(r++,l/=2),r+d>=h?(a=0,r=h):r+d>=1?(a=(t*l-1)*Math.pow(2,o),r+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,o),r=0));o>=8;e[i+p]=255&a,p+=f,a/=256,o-=8);for(r=r<<o|a,c+=o;c>0;e[i+p]=255&r,p+=f,r/=256,c-=8);e[i+p-f]|=128*v}},{}],24:[function(e,t,i){"function"==typeof Object.create?t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},{}],25:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(e,t){this.color=!0,this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0,this.leftChild=void 0,this.rightChild=void 0,this.key=e,this.value=t}return e.prototype.rotateLeft=function(){var e=this.parent,t=this.brother,i=this.leftChild,n=this.rightChild;if(!n)throw new Error("unknown error");var o=n.leftChild,s=n.rightChild;return e&&(e.leftChild===this?e.leftChild=n:e.rightChild===this&&(e.rightChild=n)),n.parent=e,n.brother=t,n.leftChild=this,n.rightChild=s,t&&(t.brother=n),this.parent=n,this.brother=s,this.leftChild=i,this.rightChild=o,s&&(s.parent=n,s.brother=this),i&&(i.parent=this,i.brother=o),o&&(o.parent=this,o.brother=i),n},e.prototype.rotateRight=function(){var e=this.parent,t=this.brother,i=this.leftChild;if(!i)throw new Error("unknown error");var n=this.rightChild,o=i.leftChild,s=i.rightChild;return e&&(e.leftChild===this?e.leftChild=i:e.rightChild===this&&(e.rightChild=i)),i.parent=e,i.brother=t,i.leftChild=o,i.rightChild=this,t&&(t.brother=i),o&&(o.parent=i,o.brother=this),this.parent=i,this.brother=o,this.leftChild=s,this.rightChild=n,s&&(s.parent=this,s.brother=n),n&&(n.parent=this,n.brother=s),i},e.prototype.remove=function(){if(this.leftChild||this.rightChild)throw new Error("can only remove leaf node");this.parent&&(this===this.parent.leftChild?this.parent.leftChild=void 0:this===this.parent.rightChild&&(this.parent.rightChild=void 0)),this.brother&&(this.brother.brother=void 0),this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0},e.TreeNodeColorType={red:!0,black:!1},e}();Object.freeze(n),i.default=n},{}],26:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};function o(e){var t=this;void 0===e&&(e=[]);var i=[],s=0,r=0,a=0,l=0,c=0,h=0;this.size=function(){return h},this.empty=function(){return 0===h},this.clear=function(){s=a=r=l=c=h=0,u.call(this,o.bucketSize),h=0},this.front=function(){return i[s][r]},this.back=function(){return i[a][l]},this.forEach=function(e){if(!this.empty()){var t=0;if(s!==a){for(c=r;c<o.bucketSize;++c)e(i[s][c],t++);for(c=s+1;c<a;++c)for(var n=0;n<o.bucketSize;++n)e(i[c][n],t++);for(c=0;c<=l;++c)e(i[a][c],t++)}else for(var c=r;c<=l;++c)e(i[s][c],t++)}};var d=function(e){var t=s*o.bucketSize+r,i=t+e,n=a*o.bucketSize+l;if(i<t||i>n)throw new Error("pos should more than 0 and less than queue's size");return{curNodeBucketIndex:Math.floor(i/o.bucketSize),curNodePointerIndex:i%o.bucketSize}};this.getElementByPos=function(e){var t=d(e),n=t.curNodeBucketIndex,o=t.curNodePointerIndex;return i[n][o]},this.eraseElementByPos=function(e){var t=this;if(e<0||e>h)throw new Error("pos should more than 0 and less than queue's size");if(0===e)this.popFront();else if(e===this.size())this.popBack();else{for(var i=[],n=e+1;n<h;++n)i.push(this.getElementByPos(n));this.cut(e),this.popBack(),i.forEach((function(e){return t.pushBack(e)}))}},this.eraseElementByValue=function(e){if(!this.empty()){var t=[];this.forEach((function(i){i!==e&&t.push(i)}));for(var i=t.length,n=0;n<i;++n)this.setElementByPos(n,t[n]);this.cut(i-1)}};var u=function(e){for(var t=[],n=e*o.sigma,d=Math.max(Math.ceil(n/o.bucketSize),2),u=0;u<d;++u)t.push(new Array(o.bucketSize));var p=Math.ceil(e/o.bucketSize),f=Math.floor(d/2)-Math.floor(p/2),v=f,g=0;if(this.size())for(u=0;u<p;++u){for(var y=0;y<o.bucketSize;++y)if(t[f+u][y]=this.front(),this.popFront(),this.empty()){v=f+u,g=y;break}if(this.empty())break}i=t,s=f,r=0,a=v,l=g,c=d,h=e};this.pushBack=function(e){this.empty()||(a===c-1&&l===o.bucketSize-1&&u.call(this,this.size()),l<o.bucketSize-1?++l:a<c-1&&(++a,l=0)),++h,i[a][l]=e},this.popBack=function(){this.empty()||(1!==this.size()&&(l>0?--l:s<a&&(--a,l=o.bucketSize-1)),h>0&&--h)},this.setElementByPos=function(e,t){var n=d(e),o=n.curNodeBucketIndex,s=n.curNodePointerIndex;i[o][s]=t},this.insert=function(e,t,i){var n=this;if(void 0===i&&(i=1),0===e)for(;i--;)this.pushFront(t);else if(e===this.size())for(;i--;)this.pushBack(t);else{for(var o=[],s=e;s<h;++s)o.push(this.getElementByPos(s));for(this.cut(e-1),s=0;s<i;++s)this.pushBack(t);o.forEach((function(e){return n.pushBack(e)}))}},this.find=function(e){if(s===a){for(var t=r;t<=l;++t)if(i[s][t]===e)return!0;return!1}for(t=r;t<o.bucketSize;++t)if(i[s][t]===e)return!0;for(t=s+1;t<a;++t)for(var n=0;n<o.bucketSize;++n)if(i[t][n]===e)return!0;for(t=0;t<=l;++t)if(i[a][t]===e)return!0;return!1},this.reverse=function(){for(var e=0,t=h-1;e<t;){var i=this.getElementByPos(e);this.setElementByPos(e,this.getElementByPos(t)),this.setElementByPos(t,i),++e,--t}},this.unique=function(){if(!this.empty()){var e=[],t=this.front();this.forEach((function(i,n){0!==n&&i===t||(e.push(i),t=i)}));for(var i=0;i<h;++i)this.setElementByPos(i,e[i]);this.cut(e.length-1)}},this.sort=function(e){var t=[];this.forEach((function(e){t.push(e)})),t.sort(e);for(var i=0;i<h;++i)this.setElementByPos(i,t[i])},this.pushFront=function(e){this.empty()||(0===s&&0===r&&u.call(this,this.size()),r>0?--r:s>0&&(--s,r=o.bucketSize-1)),++h,i[s][r]=e},this.popFront=function(){this.empty()||(1!==this.size()&&(r<o.bucketSize-1?++r:s<a&&(++s,r=0)),h>0&&--h)},this.shrinkToFit=function(){var e=this,t=[];this.forEach((function(e){t.push(e)}));var n=t.length;i=[];for(var s=Math.ceil(n/o.bucketSize),r=0;r<s;++r)i.push(new Array(o.bucketSize));this.clear(),t.forEach((function(t){return e.pushBack(t)}))},this.cut=function(e){if(e<0)this.clear();else{var t=d(e),i=t.curNodeBucketIndex,n=t.curNodePointerIndex;a=i,l=n,h=e+1}},this[Symbol.iterator]=function(){return function(){var e,t;return n(this,(function(n){switch(n.label){case 0:if(0===h)return[2];if(s!==a)return[3,5];t=r,n.label=1;case 1:return t<=l?[4,i[s][t]]:[3,4];case 2:n.sent(),n.label=3;case 3:return++t,[3,1];case 4:return[2];case 5:t=r,n.label=6;case 6:return t<o.bucketSize?[4,i[s][t]]:[3,9];case 7:n.sent(),n.label=8;case 8:return++t,[3,6];case 9:t=s+1,n.label=10;case 10:if(!(t<a))return[3,15];e=0,n.label=11;case 11:return e<o.bucketSize?[4,i[t][e]]:[3,14];case 12:n.sent(),n.label=13;case 13:return++e,[3,11];case 14:return++t,[3,10];case 15:t=0,n.label=16;case 16:return t<=l?[4,i[a][t]]:[3,19];case 17:n.sent(),n.label=18;case 18:return++t,[3,16];case 19:return[2]}}))}()},function(){var n=o.bucketSize;e.size?n=e.size():e.length&&(n=e.length);var r=n*o.sigma;c=Math.ceil(r/o.bucketSize),c=Math.max(c,3);for(var l=0;l<c;++l)i.push(new Array(o.bucketSize));var h=Math.ceil(n/o.bucketSize);s=Math.floor(c/2)-Math.floor(h/2),a=s,e.forEach((function(e){return t.pushBack(e)}))}(),Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),o.sigma=3,o.bucketSize=5e3,Object.freeze(o),i.default=o},{}],27:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=e("../LinkList/LinkList"),r=e("../Map/Map");function a(e,t,i){var l=this;if(void 0===e&&(e=[]),void 0===t&&(t=a.initSize),i=i||function(e){var t,i,n=0,s="";if("number"==typeof e)n=((n=Math.floor(e))<<5)-n,n&=n;else{s="string"!=typeof e?JSON.stringify(e):e;try{for(var r=o(s),a=r.next();!a.done;a=r.next())n=(n<<5)-n+a.value.charCodeAt(0),n&=n}catch(l){t={error:l}}finally{try{a&&!a.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}}return n^n>>>16},t&t-1)throw new Error("initBucketNum must be 2 to the power of n");var c=0,h=[],d=Math.max(a.initSize,Math.min(a.maxSize,t));this.size=function(){return c},this.empty=function(){return 0===c},this.clear=function(){c=0,d=t,h=[]},this.forEach=function(e){var t=0;h.forEach((function(i){i.forEach((function(i){e(i,t++)}))}))},this.setElement=function(e,t){var n,l;if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(null!=t){var u=i(e)&d-1;if(h[u]){var p=h[u].size();if(h[u]instanceof s.default){try{for(var f=o(h[u]),v=f.next();!v.done;v=f.next()){var g=v.value;if(g.key===e)return void(g.value=t)}}catch(m){n={error:m}}finally{try{v&&!v.done&&(l=f.return)&&l.call(f)}finally{if(n)throw n.error}}h[u].pushBack({key:e,value:t}),h[u].size()>=a.treeifyThreshold&&(h[u]=new r.default(h[u]))}else h[u].setElement(e,t);var y=h[u].size();c+=y-p}else++c,h[u]=new s.default([{key:e,value:t}]);c>d*a.sigma&&function(e){if(!(e>=a.maxSize)){d=2*e;var t=[];h.forEach((function(n,o){if(!n.empty()){if(n instanceof s.default&&1===n.size()){var l=n.front(),c=l.key,u=l.value;t[i(c)&d-1]=new s.default([{key:c,value:u}])}else if(n instanceof r.default){var p=new s.default,f=new s.default;n.forEach((function(t){0==(i(t.key)&e)?p.pushBack(t):f.pushBack(t)})),p.size()>a.untreeifyThreshold?t[o]=new r.default(p):p.size()&&(t[o]=p),f.size()>a.untreeifyThreshold?t[o+e]=new r.default(f):f.size()&&(t[o+e]=f)}else{var v=new s.default,g=new s.default;n.forEach((function(t){0==(i(t.key)&e)?v.pushBack(t):g.pushBack(t)})),v.size()&&(t[o]=v),g.size()&&(t[o+e]=g)}h[o].clear()}})),h=t}}.call(this,d)}else this.eraseElementByKey(e)},this.getElementByKey=function(e){var t,n,s=i(e)&d-1;if(h[s]){if(h[s]instanceof r.default)return h[s].getElementByKey(e);try{for(var a=o(h[s]),l=a.next();!l.done;l=a.next()){var c=l.value;if(c.key===e)return c.value}}catch(u){t={error:u}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}}},this.eraseElementByKey=function(e){var t,n,l=i(e)&d-1;if(h[l]){var u=h[l].size();if(h[l]instanceof r.default)h[l].eraseElementByKey(e),h[l].size()<=a.untreeifyThreshold&&(h[l]=new s.default(h[l]));else{var p=-1;try{for(var f=o(h[l]),v=f.next();!v.done;v=f.next())if(++p,v.value.key===e){h[l].eraseElementByPos(p);break}}catch(y){t={error:y}}finally{try{v&&!v.done&&(n=f.return)&&n.call(f)}finally{if(t)throw t.error}}}var g=h[l].size();c+=g-u}},this.find=function(e){var t,n,s=i(e)&d-1;if(!h[s])return!1;if(h[s]instanceof r.default)return h[s].find(e);try{for(var a=o(h[s]),l=a.next();!l.done;l=a.next())if(l.value.key===e)return!0}catch(c){t={error:c}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return!1},this[Symbol.iterator]=function(){return function(){var e,t,i,s,r,a;return n(this,(function(n){switch(n.label){case 0:e=0,n.label=1;case 1:if(!(e<d))return[3,10];for(;e<d&&!h[e];)++e;if(e>=d)return[3,10];n.label=2;case 2:n.trys.push([2,7,8,9]),r=void 0,t=o(h[e]),i=t.next(),n.label=3;case 3:return i.done?[3,6]:[4,i.value];case 4:n.sent(),n.label=5;case 5:return i=t.next(),[3,3];case 6:return[3,9];case 7:return s=n.sent(),r={error:s},[3,9];case 8:try{i&&!i.done&&(a=t.return)&&a.call(t)}finally{if(r)throw r.error}return[7];case 9:return++e,[3,1];case 10:return[2]}}))}()},e.forEach((function(e){var t=e.key,i=e.value;return l.setElement(t,i)})),Object.freeze(this)}a.initSize=16,a.maxSize=1<<30,a.sigma=.75,a.treeifyThreshold=8,a.untreeifyThreshold=6,a.minTreeifySize=64,Object.freeze(a),i.default=a},{"../LinkList/LinkList":29,"../Map/Map":30}],28:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=e("../Set/Set"),r=e("../LinkList/LinkList");function a(e,t,i){var l=this;if(void 0===e&&(e=[]),void 0===t&&(t=a.initSize),i=i||function(e){var t=0,i="";if("number"==typeof e)t=((t=Math.floor(e))<<5)-t,t&=t;else{i="string"!=typeof e?JSON.stringify(e):e;for(var n=0;n<i.length;n++)t=(t<<5)-t+i.charCodeAt(n),t&=t}return t^t>>>16},t&t-1)throw new Error("initBucketNum must be 2 to the power of n");var c=0,h=[],d=Math.max(a.initSize,Math.min(a.maxSize,t));this.size=function(){return c},this.empty=function(){return 0===c},this.clear=function(){c=0,d=t,h=[]},this.forEach=function(e){var t=0;h.forEach((function(i){i.forEach((function(i){e(i,t++)}))}))},this.insert=function(e){if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");var t=i(e)&d-1;if(h[t]){var n=h[t].size();if(h[t]instanceof r.default){if(h[t].find(e))return;h[t].pushBack(e),h[t].size()>=a.treeifyThreshold&&(h[t]=new s.default(h[t]))}else h[t].insert(e);var o=h[t].size();c+=o-n}else h[t]=new r.default([e]),++c;c>d*a.sigma&&function(e){if(!(e>=a.maxSize)){d=2*e;var t=[];h.forEach((function(n,o){if(!n.empty()){if(n instanceof r.default&&1===n.size()){var l=n.front();if(void 0===l)throw new Error("unknown error");t[i(l)&d-1]=new r.default([l])}else if(n instanceof s.default){var c=new r.default,u=new r.default;n.forEach((function(t){0==(i(t)&e)?c.pushBack(t):u.pushBack(t)})),c.size()>a.untreeifyThreshold?t[o]=new s.default(c):c.size()&&(t[o]=c),u.size()>a.untreeifyThreshold?t[o+e]=new s.default(u):u.size()&&(t[o+e]=u)}else{var p=new r.default,f=new r.default;n.forEach((function(t){0==(i(t)&e)?p.pushBack(t):f.pushBack(t)})),p.size()&&(t[o]=p),f.size()&&(t[o+e]=f)}h[o].clear()}})),h=t}}.call(this,d)},this.eraseElementByValue=function(e){var t=i(e)&d-1;if(h[t]){var n=h[t].size();h[t].eraseElementByValue(e),h[t]instanceof s.default&&h[t].size()<=a.untreeifyThreshold&&(h[t]=new r.default(h[t]));var o=h[t].size();c+=o-n}},this.find=function(e){var t=i(e)&d-1;return!!h[t]&&h[t].find(e)},this[Symbol.iterator]=function(){return function(){var e,t,i,s,r,a;return n(this,(function(n){switch(n.label){case 0:e=0,n.label=1;case 1:if(!(e<d))return[3,10];for(;e<d&&!h[e];)++e;if(e>=d)return[3,10];n.label=2;case 2:n.trys.push([2,7,8,9]),r=void 0,t=o(h[e]),i=t.next(),n.label=3;case 3:return i.done?[3,6]:[4,i.value];case 4:n.sent(),n.label=5;case 5:return i=t.next(),[3,3];case 6:return[3,9];case 7:return s=n.sent(),r={error:s},[3,9];case 8:try{i&&!i.done&&(a=t.return)&&a.call(t)}finally{if(r)throw r.error}return[7];case 9:return++e,[3,1];case 10:return[2]}}))}()},e.forEach((function(e){return l.insert(e)})),Object.freeze(this)}a.initSize=16,a.maxSize=1<<30,a.sigma=.75,a.treeifyThreshold=8,a.untreeifyThreshold=6,a.minTreeifySize=64,Object.freeze(a),i.default=a},{"../LinkList/LinkList":29,"../Set/Set":33}],29:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(i,"__esModule",{value:!0});var o=function(e){this.value=void 0,this.pre=void 0,this.next=void 0,this.value=e};function s(e){var t=this;void 0===e&&(e=[]);var i=0,s=void 0,r=void 0;this.size=function(){return i},this.empty=function(){return 0===i},this.clear=function(){s=r=void 0,i=0},this.front=function(){return null==s?void 0:s.value},this.back=function(){return null==r?void 0:r.value},this.forEach=function(e){for(var t=s,i=0;t;){if(void 0===t.value)throw new Error("unknown error");e(t.value,i++),t=t.next}},this.getElementByPos=function(e){if(e<0||e>=i)throw new Error("pos must more then 0 and less then the list length");for(var t=s;e--&&t;)t=t.next;if(!t||void 0===t.value)throw new Error("unknown error");return t.value},this.eraseElementByPos=function(e){if(e<0||e>=i)throw new Error("erase pos must more then 0 and less then the list length");if(0===e)this.popFront();else if(e===i-1)this.popBack();else{for(var t=s;e--;){if(!(null==t?void 0:t.next))throw new Error("unknown error");t=t.next}if(!t||!t.pre||!t.next)throw new Error("unknown error");var n=t.pre,o=t.next;o.pre=n,n.next=o,i>0&&--i}},this.eraseElementByValue=function(e){for(;s&&s.value===e;)this.popFront();for(;r&&r.value===e;)this.popBack();if(s)for(var t=s;t;){if(t.value===e){var n=t.pre,o=t.next;o&&(o.pre=n),n&&(n.next=o),i>0&&--i}t=t.next}},this.pushBack=function(e){if(null==e)throw new Error("you can't push null or undefined here");++i;var t=new o(e);r?(r.next=t,t.pre=r,r=t):s=r=t},this.popBack=function(){r&&(i>0&&--i,r&&(s===r?s=r=void 0:(r=r.pre)&&(r.next=void 0)))},this.setElementByPos=function(e,t){if(null==t)throw new Error("you can't set null or undefined here");if(e<0||e>=i)throw new Error("pos must more then 0 and less then the list length");for(var n=s;e--;){if(!n)throw new Error("unknown error");n=n.next}n&&(n.value=t)},this.insert=function(e,t,n){if(void 0===n&&(n=1),null==t)throw new Error("you can't insert null or undefined here");if(e<0||e>i)throw new Error("insert pos must more then 0 and less then or equal to the list length");if(n<0)throw new Error("insert size must more than 0");if(0===e)for(;n--;)this.pushFront(t);else if(e===i)for(;n--;)this.pushBack(t);else{for(var r=s,a=1;a<e;++a){if(!(null==r?void 0:r.next))throw new Error("unknown error");r=null==r?void 0:r.next}if(!r)throw new Error("unknown error");var l=r.next;for(i+=n;n--;)r.next=new o(t),r.next.pre=r,r=r.next;r.next=l,l&&(l.pre=r)}},this.find=function(e){for(var t=s;t;){if(t.value===e)return!0;t=t.next}return!1},this.reverse=function(){for(var e=s,t=r,n=0;e&&t&&2*n<i;){var o=e.value;e.value=t.value,t.value=o,e=e.next,t=t.pre,++n}},this.unique=function(){for(var e=s;e;){for(var t=e;t&&t.next&&t.value===t.next.value;)t=t.next,i>0&&--i;e.next=t.next,e.next&&(e.next.pre=e),e=e.next}},this.sort=function(e){var t=[];this.forEach((function(e){t.push(e)})),t.sort(e);var i=s;t.forEach((function(e){i&&(i.value=e,i=i.next)}))},this.pushFront=function(e){if(null==e)throw new Error("you can't push null or undefined here");++i;var t=new o(e);s?(t.next=s,s.pre=t,s=t):s=r=t},this.popFront=function(){s&&(i>0&&--i,s&&(s===r?s=r=void 0:(s=s.next)&&(s.pre=void 0)))},this.merge=function(e){var t=this,n=s;e.forEach((function(e){for(;n&&void 0!==n.value&&n.value<=e;)n=n.next;if(void 0===n)t.pushBack(e),n=r;else if(n===s)t.pushFront(e),n=s;else{++i;var a=n.pre;a&&(a.next=new o(e),a.next.pre=a,a.next.next=n,n&&(n.pre=a.next))}}))},this[Symbol.iterator]=function(){return function(){var e;return n(this,(function(t){switch(t.label){case 0:e=s,t.label=1;case 1:if(void 0===e)return[3,3];if(!e.value)throw new Error("unknown error");return[4,e.value];case 2:return t.sent(),e=e.next,[3,1];case 3:return[2]}}))}()},e.forEach((function(e){return t.pushBack(e)})),Object.freeze(this)}Object.freeze(s),i.default=s},{}],30:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=e("../Base/TreeNode");function r(e,t){var i=this;void 0===e&&(e=[]),t=t||function(e,t){return e<t?-1:e>t?1:0};var r=0,a=new s.default;a.color=s.default.TreeNodeColorType.black,this.size=function(){return r},this.empty=function(){return 0===r},this.clear=function(){r=0,a.key=a.value=void 0,a.leftChild=a.rightChild=a.brother=void 0};var l=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.leftChild?l(e.leftChild):e},c=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.rightChild?c(e.rightChild):e};this.front=function(){if(!this.empty()){var e=l(a);if(void 0===e.key||void 0===e.value)throw new Error("unknown error");return{key:e.key,value:e.value}}},this.back=function(){if(!this.empty()){var e=c(a);if(void 0===e.key||void 0===e.value)throw new Error("unknown error");return{key:e.key,value:e.value}}},this.forEach=function(e){var t,i,n=0;try{for(var s=o(this),r=s.next();!r.done;r=s.next())e(r.value,n++)}catch(a){t={error:a}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}},this.getElementByPos=function(e){var t,i;if(e<0||e>=this.size())throw new Error("pos must more than 0 and less than set's size");var n=0;try{for(var s=o(this),r=s.next();!r.done;r=s.next()){var a=r.value;if(n===e)return a;++n}}catch(l){t={error:l}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}throw new Error("unknown Error")};var h=function(e,i){if(e&&void 0!==e.key&&void 0!==e.value){var n=t(e.key,i);return 0===n?{key:e.key,value:e.value}:n<0?h(e.rightChild,i):h(e.leftChild,i)||{key:e.key,value:e.value}}};this.lowerBound=function(e){return h(a,e)};var d=function(e,i){if(e&&void 0!==e.key&&void 0!==e.value)return t(e.key,i)<=0?d(e.rightChild,i):d(e.leftChild,i)||{key:e.key,value:e.value}};this.upperBound=function(e){return d(a,e)};var u=function(e,i){if(e&&void 0!==e.key&&void 0!==e.value){var n=t(e.key,i);return 0===n?{key:e.key,value:e.value}:n>0?u(e.leftChild,i):u(e.rightChild,i)||{key:e.key,value:e.value}}};this.reverseLowerBound=function(e){return u(a,e)};var p=function(e,i){if(e&&void 0!==e.key&&void 0!==e.value)return t(e.key,i)>=0?p(e.leftChild,i):p(e.rightChild,i)||{key:e.key,value:e.value}};this.reverseUpperBound=function(e){return p(a,e)};var f=function(e){var t=e.parent;if(!t){if(e===a)return;throw new Error("unknown error")}if(e.color!==s.default.TreeNodeColorType.red){var i=e.brother;if(!i)throw new Error("unknown error");if(e===t.leftChild)if(i.color===s.default.TreeNodeColorType.red){i.color=s.default.TreeNodeColorType.black,t.color=s.default.TreeNodeColorType.red;var n=t.rotateLeft();a===t&&(a=n),f(e)}else i.color===s.default.TreeNodeColorType.black&&(i.rightChild&&i.rightChild.color===s.default.TreeNodeColorType.red?(i.color=t.color,t.color=s.default.TreeNodeColorType.black,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=t.rotateLeft(),a===t&&(a=n),e.color=s.default.TreeNodeColorType.black):i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||!i.leftChild||i.leftChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,f(t)):(i.color=s.default.TreeNodeColorType.red,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=i.rotateRight(),a===i&&(a=n),f(e)));else e===t.rightChild&&(i.color===s.default.TreeNodeColorType.red?(i.color=s.default.TreeNodeColorType.black,t.color=s.default.TreeNodeColorType.red,n=t.rotateRight(),a===t&&(a=n),f(e)):i.color===s.default.TreeNodeColorType.black&&(i.leftChild&&i.leftChild.color===s.default.TreeNodeColorType.red?(i.color=t.color,t.color=s.default.TreeNodeColorType.black,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=t.rotateRight(),a===t&&(a=n),e.color=s.default.TreeNodeColorType.black):i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||!i.rightChild||i.rightChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,f(t)):(i.color=s.default.TreeNodeColorType.red,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=i.rotateLeft(),a===i&&(a=n),f(e))))}else e.color=s.default.TreeNodeColorType.black},v=function(e){for(var t=e;t.leftChild||t.rightChild;){if(t.rightChild){t=l(t.rightChild);var i=e.key;e.key=t.key,t.key=i;var n=e.value;e.value=t.value,t.value=n,e=t}t.leftChild&&(t=c(t.leftChild),i=e.key,e.key=t.key,t.key=i,n=e.value,e.value=t.value,t.value=n,e=t)}f(t),t&&t.remove(),--r,a.color=s.default.TreeNodeColorType.black},g=function(e,t){return!(!e||void 0===e.key)&&(!!g(e.leftChild,t)||!!t(e)||g(e.rightChild,t))};this.eraseElementByPos=function(e){if(e<0||e>=r)throw new Error("pos must more than 0 and less than set's size");var t=0;g(a,(function(i){return e===t?(v(i),!0):(++t,!1)}))},this.eraseElementByKey=function(e){if(!this.empty()){var i=w(a,e);void 0!==i&&void 0!==i.key&&0===t(i.key,e)&&v(i)}};var y=function(e,i){if(!e||void 0===e.key)throw new Error("unknown error");var n=t(i,e.key);return n<0?e.leftChild?y(e.leftChild,i):(e.leftChild=new s.default,e.leftChild.parent=e,e.leftChild.brother=e.rightChild,e.rightChild&&(e.rightChild.brother=e.leftChild),e.leftChild):n>0?e.rightChild?y(e.rightChild,i):(e.rightChild=new s.default,e.rightChild.parent=e,e.rightChild.brother=e.leftChild,e.leftChild&&(e.leftChild.brother=e.rightChild),e.rightChild):e},m=function(e){var t=e.parent;if(!t){if(e===a)return;throw new Error("unknown error")}if(t.color!==s.default.TreeNodeColorType.black&&t.color===s.default.TreeNodeColorType.red){var i=t.brother,n=t.parent;if(!n)throw new Error("unknown error");if(i&&i.color===s.default.TreeNodeColorType.red)i.color=t.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,m(n);else if(!i||i.color===s.default.TreeNodeColorType.black)if(t===n.leftChild)if(e===t.leftChild){t.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red;var o=n.rotateRight();n===a&&(a=o)}else e===t.rightChild&&(o=t.rotateLeft(),n===a&&(a=o),m(t));else t===n.rightChild&&(e===t.leftChild?(o=t.rotateRight(),n===a&&(a=o),m(t)):e===t.rightChild&&(t.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,o=n.rotateLeft(),n===a&&(a=o)))}};this.setElement=function(e,i){if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(null!=i){if(this.empty())return++r,a.key=e,a.value=i,void(a.color=s.default.TreeNodeColorType.black);var n=y(a,e);void 0===n.key||0!==t(n.key,e)?(++r,n.key=e,n.value=i,m(n),a.color=s.default.TreeNodeColorType.black):n.value=i}else this.eraseElementByKey(e)};var w=function(e,i){if(e&&void 0!==e.key){var n=t(i,e.key);return n<0?w(e.leftChild,i):n>0?w(e.rightChild,i):e}};this.find=function(e){return!!w(a,e)},this.getElementByKey=function(e){var t=w(a,e);if(void 0===(null==t?void 0:t.key)||void 0===(null==t?void 0:t.value))throw new Error("unknown error");return t.value},this.union=function(e){var t=this;e.forEach((function(e){var i=e.key,n=e.value;return t.setElement(i,n)}))},this.getHeight=function(){if(this.empty())return 0;var e=function(t){return t?Math.max(e(t.leftChild),e(t.rightChild))+1:1};return e(a)};var b=function(e){return n(this,(function(t){switch(t.label){case 0:return e&&void 0!==e.key&&void 0!==e.value?[5,o(b(e.leftChild))]:[2];case 1:return t.sent(),[4,{key:e.key,value:e.value}];case 2:return t.sent(),[5,o(b(e.rightChild))];case 3:return t.sent(),[2]}}))};this[Symbol.iterator]=function(){return b(a)},e.forEach((function(e){var t=e.key,n=e.value;return i.setElement(t,n)})),Object.freeze(this)}Object.freeze(r),i.default=r},{"../Base/TreeNode":25}],31:[function(e,t,i){function n(e,t){void 0===e&&(e=[]),t=t||function(e,t){return e>t?-1:e<t?1:0};var i=[];e.forEach((function(e){return i.push(e)}));var n=i.length,o=function(e,t){if(e<0||e>=n)throw new Error("unknown error");if(t<0||t>=n)throw new Error("unknown error");var o=i[e];i[e]=i[t],i[t]=o},s=function(e){if(e<0||e>=n)throw new Error("unknown error");var s=2*e+1,r=2*e+2;s<n&&t(i[e],i[s])>0&&o(e,s),r<n&&t(i[e],i[r])>0&&o(e,r)};!function(){for(var e=Math.floor((n-1)/2);e>=0;--e)for(var s=e,r=2*s+1;r<n;){var a=r+1,l=r;if(a<n&&t(i[r],i[a])>0&&(l=a),t(i[s],i[l])<=0)break;o(s,l),r=2*(s=l)+1}}(),this.size=function(){return n},this.empty=function(){return 0===n},this.clear=function(){n=0,i.length=0},this.push=function(e){if(i.push(e),1!==++n)for(var o=n-1;o>0;){var r=Math.floor((o-1)/2);if(t(i[r],e)<=0)break;s(r),o=r}},this.pop=function(){if(!this.empty())if(1!==this.size()){var e=i[n-1];--n;for(var o=0;o<this.size();){var s=2*o+1,r=2*o+2;if(s>=this.size())break;var a=s;if(r<this.size()&&t(i[s],i[r])>0&&(a=r),t(i[a],e)>=0)break;i[o]=i[a],o=a}i[o]=e}else--n},this.top=function(){return i[0]},Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),Object.freeze(n),i.default=n},{}],32:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=e("../LinkList/LinkList");function o(e){void 0===e&&(e=[]);var t=new n.default(e);this.size=function(){return t.size()},this.empty=function(){return t.empty()},this.clear=function(){t.clear()},this.push=function(e){t.pushBack(e)},this.pop=function(){t.popFront()},this.front=function(){return t.front()},Object.freeze(this)}Object.freeze(o),i.default=o},{"../LinkList/LinkList":29}],33:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=e("../Base/TreeNode");function r(e,t){var i=this;void 0===e&&(e=[]),t=t||function(e,t){return e<t?-1:e>t?1:0};var r=0,a=new s.default;a.color=s.default.TreeNodeColorType.black,this.size=function(){return r},this.empty=function(){return 0===r},this.clear=function(){r=0,a.key=void 0,a.leftChild=a.rightChild=a.brother=a.parent=void 0,a.color=s.default.TreeNodeColorType.black};var l=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.leftChild?l(e.leftChild):e},c=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.rightChild?c(e.rightChild):e};this.front=function(){if(!this.empty())return l(a).key},this.back=function(){if(!this.empty())return c(a).key},this.forEach=function(e){var t,i,n=0;try{for(var s=o(this),r=s.next();!r.done;r=s.next())e(r.value,n++)}catch(a){t={error:a}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}},this.getElementByPos=function(e){var t,i;if(e<0||e>=this.size())throw new Error("pos must more than 0 and less than set's size");var n=0;try{for(var s=o(this),r=s.next();!r.done;r=s.next()){var a=r.value;if(n===e)return a;++n}}catch(l){t={error:l}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}throw new Error("unknown error")};var h=function(e){var t=e.parent;if(!t){if(e===a)return;throw new Error("unknown error")}if(e.color!==s.default.TreeNodeColorType.red){var i=e.brother;if(!i)throw new Error("unknown error");if(e===t.leftChild)if(i.color===s.default.TreeNodeColorType.red){i.color=s.default.TreeNodeColorType.black,t.color=s.default.TreeNodeColorType.red;var n=t.rotateLeft();a===t&&(a=n),h(e)}else i.color===s.default.TreeNodeColorType.black&&(i.rightChild&&i.rightChild.color===s.default.TreeNodeColorType.red?(i.color=t.color,t.color=s.default.TreeNodeColorType.black,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=t.rotateLeft(),a===t&&(a=n),e.color=s.default.TreeNodeColorType.black):i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||!i.leftChild||i.leftChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,h(t)):(i.color=s.default.TreeNodeColorType.red,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=i.rotateRight(),a===i&&(a=n),h(e)));else e===t.rightChild&&(i.color===s.default.TreeNodeColorType.red?(i.color=s.default.TreeNodeColorType.black,t.color=s.default.TreeNodeColorType.red,n=t.rotateRight(),a===t&&(a=n),h(e)):i.color===s.default.TreeNodeColorType.black&&(i.leftChild&&i.leftChild.color===s.default.TreeNodeColorType.red?(i.color=t.color,t.color=s.default.TreeNodeColorType.black,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=t.rotateRight(),a===t&&(a=n),e.color=s.default.TreeNodeColorType.black):i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||!i.rightChild||i.rightChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,h(t)):(i.color=s.default.TreeNodeColorType.red,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=i.rotateLeft(),a===i&&(a=n),h(e))))}else e.color=s.default.TreeNodeColorType.black},d=function(e){for(var t=e;t.leftChild||t.rightChild;){if(t.rightChild){t=l(t.rightChild);var i=e.key;e.key=t.key,t.key=i,e=t}t.leftChild&&(t=c(t.leftChild),i=e.key,e.key=t.key,t.key=i,e=t)}h(t),t&&t.remove(),--r,a.color=s.default.TreeNodeColorType.black},u=function(e,t){return!(!e||void 0===e.key)&&(!!u(e.leftChild,t)||!!t(e)||u(e.rightChild,t))};this.eraseElementByPos=function(e){if(e<0||e>=r)throw new Error("pos must more than 0 and less than set's size");var t=0;u(a,(function(i){return e===t?(d(i),!0):(++t,!1)}))},this.eraseElementByValue=function(e){if(!this.empty()){var i=v(a,e);void 0!==i&&void 0!==i.key&&0===t(i.key,e)&&d(i)}};var p=function(e,i){if(!e||void 0===e.key)throw new Error("unknown error");var n=t(i,e.key);return n<0?e.leftChild?p(e.leftChild,i):(e.leftChild=new s.default,e.leftChild.parent=e,e.leftChild.brother=e.rightChild,e.rightChild&&(e.rightChild.brother=e.leftChild),e.leftChild):n>0?e.rightChild?p(e.rightChild,i):(e.rightChild=new s.default,e.rightChild.parent=e,e.rightChild.brother=e.leftChild,e.leftChild&&(e.leftChild.brother=e.rightChild),e.rightChild):e},f=function(e){var t=e.parent;if(!t){if(e===a)return;throw new Error("unknown error")}if(t.color!==s.default.TreeNodeColorType.black&&t.color===s.default.TreeNodeColorType.red){var i=t.brother,n=t.parent;if(!n)throw new Error("unknown error");if(i&&i.color===s.default.TreeNodeColorType.red)i.color=t.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,f(n);else if(!i||i.color===s.default.TreeNodeColorType.black)if(t===n.leftChild)if(e===t.leftChild){t.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red;var o=n.rotateRight();n===a&&(a=o)}else e===t.rightChild&&(o=t.rotateLeft(),n===a&&(a=o),f(t));else t===n.rightChild&&(e===t.leftChild?(o=t.rotateRight(),n===a&&(a=o),f(t)):e===t.rightChild&&(t.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,o=n.rotateLeft(),n===a&&(a=o)))}};this.insert=function(e){if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(this.empty())return++r,a.key=e,void(a.color=s.default.TreeNodeColorType.black);var i=p(a,e);void 0!==i.key&&0===t(i.key,e)||(++r,i.key=e,f(i),a.color=s.default.TreeNodeColorType.black)};var v=function(e,i){if(e&&void 0!==e.key){var n=t(i,e.key);return n<0?v(e.leftChild,i):n>0?v(e.rightChild,i):e}};this.find=function(e){var i=v(a,e);return void 0!==i&&void 0!==i.key&&0===t(i.key,e)};var g=function(e,i){if(e&&void 0!==e.key){var n=t(e.key,i);if(0===n)return e.key;if(n<0)return g(e.rightChild,i);var o=g(e.leftChild,i);return void 0!==o?o:e.key}};this.lowerBound=function(e){return g(a,e)};var y=function(e,i){if(e&&void 0!==e.key){if(t(e.key,i)<=0)return y(e.rightChild,i);var n=y(e.leftChild,i);return void 0!==n?n:e.key}};this.upperBound=function(e){return y(a,e)};var m=function(e,i){if(e&&void 0!==e.key){var n=t(e.key,i);if(0===n)return e.key;if(n>0)return m(e.leftChild,i);var o=m(e.rightChild,i);return void 0!==o?o:e.key}};this.reverseLowerBound=function(e){return m(a,e)};var w=function(e,i){if(e&&void 0!==e.key){if(t(e.key,i)>=0)return w(e.leftChild,i);var n=w(e.rightChild,i);return void 0!==n?n:e.key}};this.reverseUpperBound=function(e){return w(a,e)},this.union=function(e){var t=this;e.forEach((function(e){return t.insert(e)}))},this.getHeight=function(){if(this.empty())return 0;var e=function(t){return t?Math.max(e(t.leftChild),e(t.rightChild))+1:1};return e(a)};var b=function(e){return n(this,(function(t){switch(t.label){case 0:return e&&void 0!==e.key?[5,o(b(e.leftChild))]:[2];case 1:return t.sent(),[4,e.key];case 2:return t.sent(),[5,o(b(e.rightChild))];case 3:return t.sent(),[2]}}))};this[Symbol.iterator]=function(){return b(a)},e.forEach((function(e){return i.insert(e)})),Object.freeze(this)}Object.freeze(r),i.default=r},{"../Base/TreeNode":25}],34:[function(e,t,i){function n(e){var t=this;void 0===e&&(e=[]);var i=0,n=[];this.size=function(){return i},this.empty=function(){return 0===i},this.clear=function(){i=0,n.length=0},this.push=function(e){n.push(e),++i},this.pop=function(){n.pop(),i>0&&--i},this.top=function(){return n[i-1]},e.forEach((function(e){return t.push(e)})),Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),Object.freeze(n),i.default=n},{}],35:[function(e,t,i){var n=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(a){s=[6,a],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__read||function(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,o,s=i.call(e),r=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)r.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(i=s.return)&&i.call(s)}finally{if(o)throw o.error}}return r},s=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,o=0,s=t.length;o<s;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},r=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};function a(e){var t=this;void 0===e&&(e=[]);var i=0,a=[];this.size=function(){return i},this.empty=function(){return 0===i},this.clear=function(){i=0,a.length=0},this.front=function(){if(!this.empty())return a[0]},this.back=function(){if(!this.empty())return a[i-1]},this.forEach=function(e){a.forEach(e)},this.getElementByPos=function(e){if(e<0||e>=i)throw new Error("pos must more than 0 and less than vector's size");return a[e]},this.eraseElementByPos=function(e){if(e<0||e>=i)throw new Error("pos must more than 0 and less than vector's size");for(var t=e;t<i-1;++t)a[t]=a[t+1];this.popBack()},this.eraseElementByValue=function(e){var t=[];this.forEach((function(i){i!==e&&t.push(i)})),t.forEach((function(e,t){a[t]=e}));for(var n=t.length;i>n;)this.popBack()},this.pushBack=function(e){a.push(e),++i},this.popBack=function(){a.pop(),i>0&&--i},this.setElementByPos=function(e,t){if(e<0||e>=i)throw new Error("pos must more than 0 and less than vector's size");a[e]=t},this.insert=function(e,t,n){if(void 0===n&&(n=1),e<0||e>i)throw new Error("pos must more than 0 and less than or equal to vector's size");a.splice.apply(a,s([e,0],o(new Array(n).fill(t)),!1)),i+=n},this.find=function(e){return a.includes(e)},this.reverse=function(){a.reverse()},this.unique=function(){var e,t=[];this.forEach((function(i,n){0!==n&&i===e||(t.push(i),e=i)})),t.forEach((function(e,t){a[t]=e}));for(var n=t.length;i>n;)this.popBack()},this.sort=function(e){a.sort(e)},this[Symbol.iterator]=function(){return function(){return n(this,(function(e){switch(e.label){case 0:return[5,r(a)];case 1:return[2,e.sent()]}}))}()},e.forEach((function(e){return t.pushBack(e)})),Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),Object.freeze(a),i.default=a},{}],36:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0}),i.HashMap=i.HashSet=i.Map=i.Set=i.PriorityQueue=i.Deque=i.LinkList=i.Queue=i.Stack=i.Vector=void 0;var n=e("./Vector/Vector");i.Vector=n.default;var o=e("./Stack/Stack");i.Stack=o.default;var s=e("./Queue/Queue");i.Queue=s.default;var r=e("./LinkList/LinkList");i.LinkList=r.default;var a=e("./Deque/Deque");i.Deque=a.default;var l=e("./PriorityQueue/PriorityQueue");i.PriorityQueue=l.default;var c=e("./Set/Set");i.Set=c.default;var h=e("./Map/Map");i.Map=h.default;var d=e("./HashSet/HashSet");i.HashSet=d.default;var u=e("./HashMap/HashMap");i.HashMap=u.default},{"./Deque/Deque":26,"./HashMap/HashMap":27,"./HashSet/HashSet":28,"./LinkList/LinkList":29,"./Map/Map":30,"./PriorityQueue/PriorityQueue":31,"./Queue/Queue":32,"./Set/Set":33,"./Stack/Stack":34,"./Vector/Vector":35}],37:[function(e,t,i){const n=e("yallist"),o=Symbol("max"),s=Symbol("length"),r=Symbol("lengthCalculator"),a=Symbol("allowStale"),l=Symbol("maxAge"),c=Symbol("dispose"),h=Symbol("noDisposeOnSet"),d=Symbol("lruList"),u=Symbol("cache"),p=Symbol("updateAgeOnGet"),f=()=>1,v=(e,t,i)=>{const n=e[u].get(t);if(n){const t=n.value;if(g(e,t)){if(m(e,n),!e[a])return}else i&&(e[p]&&(n.value.now=Date.now()),e[d].unshiftNode(n));return t.value}},g=(e,t)=>{if(!t||!t.maxAge&&!e[l])return!1;const i=Date.now()-t.now;return t.maxAge?i>t.maxAge:e[l]&&i>e[l]},y=e=>{if(e[s]>e[o])for(let t=e[d].tail;e[s]>e[o]&&null!==t;){const i=t.prev;m(e,t),t=i}},m=(e,t)=>{if(t){const i=t.value;e[c]&&e[c](i.key,i.value),e[s]-=i.length,e[u].delete(i.key),e[d].removeNode(t)}};class w{constructor(e,t,i,n,o){this.key=e,this.value=t,this.length=i,this.now=n,this.maxAge=o||0}}const b=(e,t,i,n)=>{let o=i.value;g(e,o)&&(m(e,i),e[a]||(o=void 0)),o&&t.call(n,o.value,o.key,e)};t.exports=class{constructor(e){if("number"==typeof e&&(e={max:e}),e||(e={}),e.max&&("number"!=typeof e.max||e.max<0))throw new TypeError("max must be a non-negative number");this[o]=e.max||1/0;const t=e.length||f;if(this[r]="function"!=typeof t?f:t,this[a]=e.stale||!1,e.maxAge&&"number"!=typeof e.maxAge)throw new TypeError("maxAge must be a number");this[l]=e.maxAge||0,this[c]=e.dispose,this[h]=e.noDisposeOnSet||!1,this[p]=e.updateAgeOnGet||!1,this.reset()}set max(e){if("number"!=typeof e||e<0)throw new TypeError("max must be a non-negative number");this[o]=e||1/0,y(this)}get max(){return this[o]}set allowStale(e){this[a]=!!e}get allowStale(){return this[a]}set maxAge(e){if("number"!=typeof e)throw new TypeError("maxAge must be a non-negative number");this[l]=e,y(this)}get maxAge(){return this[l]}set lengthCalculator(e){"function"!=typeof e&&(e=f),e!==this[r]&&(this[r]=e,this[s]=0,this[d].forEach((e=>{e.length=this[r](e.value,e.key),this[s]+=e.length}))),y(this)}get lengthCalculator(){return this[r]}get length(){return this[s]}get itemCount(){return this[d].length}rforEach(e,t){t=t||this;for(let i=this[d].tail;null!==i;){const n=i.prev;b(this,e,i,t),i=n}}forEach(e,t){t=t||this;for(let i=this[d].head;null!==i;){const n=i.next;b(this,e,i,t),i=n}}keys(){return this[d].toArray().map((e=>e.key))}values(){return this[d].toArray().map((e=>e.value))}reset(){this[c]&&this[d]&&this[d].length&&this[d].forEach((e=>this[c](e.key,e.value))),this[u]=new Map,this[d]=new n,this[s]=0}dump(){return this[d].map((e=>!g(this,e)&&{k:e.key,v:e.value,e:e.now+(e.maxAge||0)})).toArray().filter((e=>e))}dumpLru(){return this[d]}set(e,t,i){if((i=i||this[l])&&"number"!=typeof i)throw new TypeError("maxAge must be a number");const n=i?Date.now():0,a=this[r](t,e);if(this[u].has(e)){if(a>this[o])return m(this,this[u].get(e)),!1;const r=this[u].get(e).value;return this[c]&&(this[h]||this[c](e,r.value)),r.now=n,r.maxAge=i,r.value=t,this[s]+=a-r.length,r.length=a,this.get(e),y(this),!0}const p=new w(e,t,a,n,i);return p.length>this[o]?(this[c]&&this[c](e,t),!1):(this[s]+=p.length,this[d].unshift(p),this[u].set(e,this[d].head),y(this),!0)}has(e){if(!this[u].has(e))return!1;const t=this[u].get(e).value;return!g(this,t)}get(e){return v(this,e,!0)}peek(e){return v(this,e,!1)}pop(){const e=this[d].tail;return e?(m(this,e),e.value):null}del(e){m(this,this[u].get(e))}load(e){this.reset();const t=Date.now();for(let i=e.length-1;i>=0;i--){const n=e[i],o=n.e||0;if(0===o)this.set(n.k,n.v);else{const e=o-t;e>0&&this.set(n.k,n.v,e)}}}prune(){this[u].forEach(((e,t)=>v(this,t,!1)))}}},{yallist:83}],38:[function(e,t,i){(function(e){(function(){const i=t.exports;i.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},i.codes={};for(const e in i.types){const t=i.types[e];i.codes[t]=e}i.CMD_SHIFT=4,i.CMD_MASK=240,i.DUP_MASK=8,i.QOS_MASK=3,i.QOS_SHIFT=1,i.RETAIN_MASK=1,i.VARBYTEINT_MASK=127,i.VARBYTEINT_FIN_MASK=128,i.VARBYTEINT_MAX=268435455,i.SESSIONPRESENT_MASK=1,i.SESSIONPRESENT_HEADER=e.from([i.SESSIONPRESENT_MASK]),i.CONNACK_HEADER=e.from([i.codes.connack<<i.CMD_SHIFT]),i.USERNAME_MASK=128,i.PASSWORD_MASK=64,i.WILL_RETAIN_MASK=32,i.WILL_QOS_MASK=24,i.WILL_QOS_SHIFT=3,i.WILL_FLAG_MASK=4,i.CLEAN_SESSION_MASK=2,i.CONNECT_HEADER=e.from([i.codes.connect<<i.CMD_SHIFT]),i.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},i.propertiesCodes={};for(const e in i.properties){const t=i.properties[e];i.propertiesCodes[t]=e}function n(t){return[0,1,2].map((n=>[0,1].map((o=>[0,1].map((s=>{const r=e.alloc(1);return r.writeUInt8(i.codes[t]<<i.CMD_SHIFT|(o?i.DUP_MASK:0)|n<<i.QOS_SHIFT|s,0,!0),r}))))))}i.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},i.PUBLISH_HEADER=n("publish"),i.SUBSCRIBE_HEADER=n("subscribe"),i.SUBSCRIBE_OPTIONS_QOS_MASK=3,i.SUBSCRIBE_OPTIONS_NL_MASK=1,i.SUBSCRIBE_OPTIONS_NL_SHIFT=2,i.SUBSCRIBE_OPTIONS_RAP_MASK=1,i.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,i.SUBSCRIBE_OPTIONS_RH_MASK=3,i.SUBSCRIBE_OPTIONS_RH_SHIFT=4,i.SUBSCRIBE_OPTIONS_RH=[0,16,32],i.SUBSCRIBE_OPTIONS_NL=4,i.SUBSCRIBE_OPTIONS_RAP=8,i.SUBSCRIBE_OPTIONS_QOS=[0,1,2],i.UNSUBSCRIBE_HEADER=n("unsubscribe"),i.ACKS={unsuback:n("unsuback"),puback:n("puback"),pubcomp:n("pubcomp"),pubrel:n("pubrel"),pubrec:n("pubrec")},i.SUBACK_HEADER=e.from([i.codes.suback<<i.CMD_SHIFT]),i.VERSION3=e.from([3]),i.VERSION4=e.from([4]),i.VERSION5=e.from([5]),i.VERSION131=e.from([131]),i.VERSION132=e.from([132]),i.QOS=[0,1,2].map((t=>e.from([t]))),i.EMPTY={pingreq:e.from([i.codes.pingreq<<4,0]),pingresp:e.from([i.codes.pingresp<<4,0]),disconnect:e.from([i.codes.disconnect<<4,0])}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:17}],39:[function(e,t,i){(function(i){(function(){const n=e("./writeToStream"),o=e("events");class s extends o{constructor(){super(),this._array=new Array(20),this._i=0}write(e){return this._array[this._i++]=e,!0}concat(){let e=0;const t=new Array(this._array.length),n=this._array;let o,s=0;for(o=0;o<n.length&&void 0!==n[o];o++)"string"!=typeof n[o]?t[o]=n[o].length:t[o]=i.byteLength(n[o]),e+=t[o];const r=i.allocUnsafe(e);for(o=0;o<n.length&&void 0!==n[o];o++)"string"!=typeof n[o]?(n[o].copy(r,s),s+=t[o]):(r.write(n[o],s),s+=t[o]);return r}}t.exports=function(e,t){const i=new s;return n(e,i,t),i.concat()}}).call(this)}).call(this,e("buffer").Buffer)},{"./writeToStream":44,buffer:17,events:22}],40:[function(e,t,i){i.parser=e("./parser").parser,i.generate=e("./generate"),i.writeToStream=e("./writeToStream")},{"./generate":39,"./parser":43,"./writeToStream":44}],41:[function(e,t,i){(function(e){(function(){const i=65536,n={},o=e.isBuffer(e.from([1,2]).subarray(0,1));function s(t){const i=e.allocUnsafe(2);return i.writeUInt8(t>>8,0),i.writeUInt8(255&t,1),i}t.exports={cache:n,generateCache:function(){for(let e=0;e<i;e++)n[e]=s(e)},generateNumber:s,genBufVariableByteInt:function(t){let i=0,n=0;const s=e.allocUnsafe(4);do{i=t%128|0,(t=t/128|0)>0&&(i|=128),s.writeUInt8(i,n++)}while(t>0&&n<4);return t>0&&(n=0),o?s.subarray(0,n):s.slice(0,n)},generate4ByteBuffer:function(t){const i=e.allocUnsafe(4);return i.writeUInt32BE(t,0),i}}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:17}],42:[function(e,t,i){t.exports=class{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}}},{}],43:[function(e,t,i){const n=e("bl"),o=e("events"),s=e("./packet"),r=e("./constants"),a=e("debug")("mqtt-packet:parser");class l extends o{constructor(){super(),this.parser=this.constructor.parser}static parser(e){return this instanceof l?(this.settings=e||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):(new l).parser(e)}_resetState(){a("_resetState: resetting packet, error, _list, and _stateCounter"),this.packet=new s,this.error=null,this._list=n(),this._stateCounter=0}parse(e){for(this.error&&this._resetState(),this._list.append(e),a("parse: current state: %s",this._states[this._stateCounter]);(-1!==this.packet.length||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,a("parse: state complete. _stateCounter is now: %d",this._stateCounter),a("parse: packet.length: %d, buffer list length: %d",this.packet.length,this._list.length),this._stateCounter>=this._states.length&&(this._stateCounter=0);return a("parse: exited while loop. packet: %d, buffer list length: %d",this.packet.length,this._list.length),this._list.length}_parseHeader(){const e=this._list.readUInt8(0);return this.packet.cmd=r.types[e>>r.CMD_SHIFT],this.packet.retain=0!=(e&r.RETAIN_MASK),this.packet.qos=e>>r.QOS_SHIFT&r.QOS_MASK,this.packet.dup=0!=(e&r.DUP_MASK),a("_parseHeader: packet: %o",this.packet),this._list.consume(1),!0}_parseLength(){const e=this._parseVarByteNum(!0);return e&&(this.packet.length=e.value,this._list.consume(e.bytes)),a("_parseLength %d",e.value),!!e}_parsePayload(){a("_parsePayload: payload %O",this._list);let e=!1;if(0===this.packet.length||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}e=!0}return a("_parsePayload complete result: %s",e),e}_parseConnect(){let e,t,i,n;a("_parseConnect");const o={},s=this.packet,l=this._parseString();if(null===l)return this._emitError(new Error("Cannot parse protocolId"));if("MQTT"!==l&&"MQIsdp"!==l)return this._emitError(new Error("Invalid protocolId"));if(s.protocolId=l,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(s.protocolVersion=this._list.readUInt8(this._pos),s.protocolVersion>=128&&(s.bridgeMode=!0,s.protocolVersion=s.protocolVersion-128),3!==s.protocolVersion&&4!==s.protocolVersion&&5!==s.protocolVersion)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(o.username=this._list.readUInt8(this._pos)&r.USERNAME_MASK,o.password=this._list.readUInt8(this._pos)&r.PASSWORD_MASK,o.will=this._list.readUInt8(this._pos)&r.WILL_FLAG_MASK,o.will&&(s.will={},s.will.retain=0!=(this._list.readUInt8(this._pos)&r.WILL_RETAIN_MASK),s.will.qos=(this._list.readUInt8(this._pos)&r.WILL_QOS_MASK)>>r.WILL_QOS_SHIFT),s.clean=0!=(this._list.readUInt8(this._pos)&r.CLEAN_SESSION_MASK),this._pos++,s.keepalive=this._parseNum(),-1===s.keepalive)return this._emitError(new Error("Packet too short"));if(5===s.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(s.properties=e)}const c=this._parseString();if(null===c)return this._emitError(new Error("Packet too short"));if(s.clientId=c,a("_parseConnect: packet.clientId: %s",s.clientId),o.will){if(5===s.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(s.will.properties=e)}if(null===(e=this._parseString()))return this._emitError(new Error("Cannot parse will topic"));if(s.will.topic=e,a("_parseConnect: packet.will.topic: %s",s.will.topic),null===(t=this._parseBuffer()))return this._emitError(new Error("Cannot parse will payload"));s.will.payload=t,a("_parseConnect: packet.will.paylaod: %s",s.will.payload)}if(o.username){if(null===(n=this._parseString()))return this._emitError(new Error("Cannot parse username"));s.username=n,a("_parseConnect: packet.username: %s",s.username)}if(o.password){if(null===(i=this._parseBuffer()))return this._emitError(new Error("Cannot parse password"));s.password=i}return this.settings=s,a("_parseConnect: complete"),s}_parseConnack(){a("_parseConnack");const e=this.packet;if(this._list.length<1)return null;if(e.sessionPresent=!!(this._list.readUInt8(this._pos++)&r.SESSIONPRESENT_MASK),5===this.settings.protocolVersion)this._list.length>=2?e.reasonCode=this._list.readUInt8(this._pos++):e.reasonCode=0;else{if(this._list.length<2)return null;e.returnCode=this._list.readUInt8(this._pos++)}if(-1===e.returnCode||-1===e.reasonCode)return this._emitError(new Error("Cannot parse return code"));if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}a("_parseConnack: complete")}_parsePublish(){a("_parsePublish");const e=this.packet;if(e.topic=this._parseString(),null===e.topic)return this._emitError(new Error("Cannot parse topic"));if(!(e.qos>0)||this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}e.payload=this._list.slice(this._pos,e.length),a("_parsePublish: payload from buffer list: %o",e.payload)}}_parseSubscribe(){a("_parseSubscribe");const e=this.packet;let t,i,n,o,s,l,c;if(1!==e.qos)return this._emitError(new Error("Wrong subscribe header"));if(e.subscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}for(;this._pos<e.length;){if(null===(t=this._parseString()))return this._emitError(new Error("Cannot parse topic"));if(this._pos>=e.length)return this._emitError(new Error("Malformed Subscribe Payload"));n=(i=this._parseByte())&r.SUBSCRIBE_OPTIONS_QOS_MASK,l=0!=(i>>r.SUBSCRIBE_OPTIONS_NL_SHIFT&r.SUBSCRIBE_OPTIONS_NL_MASK),s=0!=(i>>r.SUBSCRIBE_OPTIONS_RAP_SHIFT&r.SUBSCRIBE_OPTIONS_RAP_MASK),o=i>>r.SUBSCRIBE_OPTIONS_RH_SHIFT&r.SUBSCRIBE_OPTIONS_RH_MASK,c={topic:t,qos:n},5===this.settings.protocolVersion?(c.nl=l,c.rap=s,c.rh=o):this.settings.bridgeMode&&(c.rh=0,c.rap=!0,c.nl=!0),a("_parseSubscribe: push subscription `%s` to subscription",c),e.subscriptions.push(c)}}}_parseSuback(){a("_parseSuback");const e=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}for(;this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseUnsubscribe(){a("_parseUnsubscribe");const e=this.packet;if(e.unsubscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}for(;this._pos<e.length;){const t=this._parseString();if(null===t)return this._emitError(new Error("Cannot parse topic"));a("_parseUnsubscribe: push topic `%s` to unsubscriptions",t),e.unsubscriptions.push(t)}}}_parseUnsuback(){a("_parseUnsuback");const e=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if(5===this.settings.protocolVersion){const t=this._parseProperties();for(Object.getOwnPropertyNames(t).length&&(e.properties=t),e.granted=[];this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseConfirmation(){a("_parseConfirmation: packet.cmd: `%s`",this.packet.cmd);const e=this.packet;if(this._parseMessageId(),5===this.settings.protocolVersion&&(e.length>2?(e.reasonCode=this._parseByte(),a("_parseConfirmation: packet.reasonCode `%d`",e.reasonCode)):e.reasonCode=0,e.length>3)){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}return!0}_parseDisconnect(){const e=this.packet;if(a("_parseDisconnect"),5===this.settings.protocolVersion){this._list.length>0?e.reasonCode=this._parseByte():e.reasonCode=0;const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}return a("_parseDisconnect result: true"),!0}_parseAuth(){a("_parseAuth");const e=this.packet;if(5!==this.settings.protocolVersion)return this._emitError(new Error("Not supported auth packet for this version MQTT"));e.reasonCode=this._parseByte();const t=this._parseProperties();return Object.getOwnPropertyNames(t).length&&(e.properties=t),a("_parseAuth: result: true"),!0}_parseMessageId(){const e=this.packet;return e.messageId=this._parseNum(),null===e.messageId?(this._emitError(new Error("Cannot parse messageId")),!1):(a("_parseMessageId: packet.messageId %d",e.messageId),!0)}_parseString(e){const t=this._parseNum(),i=t+this._pos;if(-1===t||i>this._list.length||i>this.packet.length)return null;const n=this._list.toString("utf8",this._pos,i);return this._pos+=t,a("_parseString: result: %s",n),n}_parseStringPair(){return a("_parseStringPair"),{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const e=this._parseNum(),t=e+this._pos;if(-1===e||t>this._list.length||t>this.packet.length)return null;const i=this._list.slice(this._pos,t);return this._pos+=e,a("_parseBuffer: result: %o",i),i}_parseNum(){if(this._list.length-this._pos<2)return-1;const e=this._list.readUInt16BE(this._pos);return this._pos+=2,a("_parseNum: result: %s",e),e}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const e=this._list.readUInt32BE(this._pos);return this._pos+=4,a("_parse4ByteNum: result: %s",e),e}_parseVarByteNum(e){a("_parseVarByteNum");let t,i=0,n=1,o=0,s=!1;const l=this._pos?this._pos:0;for(;i<4&&l+i<this._list.length;){if(o+=n*((t=this._list.readUInt8(l+i++))&r.VARBYTEINT_MASK),n*=128,0==(t&r.VARBYTEINT_FIN_MASK)){s=!0;break}if(this._list.length<=i)break}return!s&&4===i&&this._list.length>=i&&this._emitError(new Error("Invalid variable byte integer")),l&&(this._pos+=i),a("_parseVarByteNum: result: %o",s=!!s&&(e?{bytes:i,value:o}:o)),s}_parseByte(){let e;return this._pos<this._list.length&&(e=this._list.readUInt8(this._pos),this._pos++),a("_parseByte: result: %o",e),e}_parseByType(e){switch(a("_parseByType: type: %s",e),e){case"byte":return 0!==this._parseByte();case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){a("_parseProperties");const e=this._parseVarByteNum(),t=this._pos+e,i={};for(;this._pos<t;){const e=this._parseByte();if(!e)return this._emitError(new Error("Cannot parse property code type")),!1;const t=r.propertiesCodes[e];if(!t)return this._emitError(new Error("Unknown property")),!1;if("userProperties"!==t)i[t]?(Array.isArray(i[t])||(i[t]=[i[t]]),i[t].push(this._parseByType(r.propertiesTypes[t]))):i[t]=this._parseByType(r.propertiesTypes[t]);else{i[t]||(i[t]=Object.create(null));const e=this._parseByType(r.propertiesTypes[t]);if(i[t][e.name])if(Array.isArray(i[t][e.name]))i[t][e.name].push(e.value);else{const n=i[t][e.name];i[t][e.name]=[n],i[t][e.name].push(e.value)}else i[t][e.name]=e.value}}return i}_newPacket(){return a("_newPacket"),this.packet&&(this._list.consume(this.packet.length),a("_newPacket: parser emit packet: packet.cmd: %s, packet.payload: %s, packet.length: %d",this.packet.cmd,this.packet.payload,this.packet.length),this.emit("packet",this.packet)),a("_newPacket: new packet"),this.packet=new s,this._pos=0,!0}_emitError(e){a("_emitError"),this.error=e,this.emit("error",e)}}t.exports=l},{"./constants":38,"./packet":42,bl:15,debug:18,events:22}],44:[function(e,t,i){(function(i){(function(){const n=e("./constants"),o=i.allocUnsafe(0),s=i.from([0]),r=e("./numbers"),a=e("process-nextick-args").nextTick,l=e("debug")("mqtt-packet:writeToStream"),c=r.cache,h=r.generateNumber,d=r.generateCache,u=r.genBufVariableByteInt,p=r.generate4ByteBuffer;let f=k,v=!0;function g(e,t,r){switch(l("generate called"),t.cork&&(t.cork(),a(y,t)),v&&(v=!1,d()),l("generate: packet.cmd: %s",e.cmd),e.cmd){case"connect":return function(e,t){const o=e||{},s=o.protocolId||"MQTT";let r=o.protocolVersion||4;const a=o.will;let l=o.clean;const c=o.keepalive||0,h=o.clientId||"",d=o.username,u=o.password,p=o.properties;void 0===l&&(l=!0);let v=0;if(!s||"string"!=typeof s&&!i.isBuffer(s))return t.emit("error",new Error("Invalid protocolId")),!1;if(v+=s.length+2,3!==r&&4!==r&&5!==r)return t.emit("error",new Error("Invalid protocol version")),!1;if(v+=1,("string"==typeof h||i.isBuffer(h))&&(h||r>=4)&&(h||l))v+=i.byteLength(h)+2;else{if(r<4)return t.emit("error",new Error("clientId must be supplied before 3.1.1")),!1;if(1*l==0)return t.emit("error",new Error("clientId must be given if cleanSession set to 0")),!1}if("number"!=typeof c||c<0||c>65535||c%1!=0)return t.emit("error",new Error("Invalid keepalive")),!1;if(v+=2,v+=1,5===r){var g=A(t,p);if(!g)return!1;v+=g.length}if(a){if("object"!=typeof a)return t.emit("error",new Error("Invalid will")),!1;if(!a.topic||"string"!=typeof a.topic)return t.emit("error",new Error("Invalid will topic")),!1;if(v+=i.byteLength(a.topic)+2,v+=2,a.payload){if(!(a.payload.length>=0))return t.emit("error",new Error("Invalid will payload")),!1;"string"==typeof a.payload?v+=i.byteLength(a.payload):v+=a.payload.length}var y={};if(5===r){if(!(y=A(t,a.properties)))return!1;v+=y.length}}let m=!1;if(null!=d){if(!E(d))return t.emit("error",new Error("Invalid username")),!1;m=!0,v+=i.byteLength(d)+2}if(null!=u){if(!m)return t.emit("error",new Error("Username is required to use password")),!1;if(!E(u))return t.emit("error",new Error("Invalid password")),!1;v+=P(u)+2}t.write(n.CONNECT_HEADER),w(t,v),C(t,s),o.bridgeMode&&(r+=128),t.write(131===r?n.VERSION131:132===r?n.VERSION132:4===r?n.VERSION4:5===r?n.VERSION5:n.VERSION3);let x=0;return x|=null!=d?n.USERNAME_MASK:0,x|=null!=u?n.PASSWORD_MASK:0,x|=a&&a.retain?n.WILL_RETAIN_MASK:0,x|=a&&a.qos?a.qos<<n.WILL_QOS_SHIFT:0,x|=a?n.WILL_FLAG_MASK:0,x|=l?n.CLEAN_SESSION_MASK:0,t.write(i.from([x])),f(t,c),5===r&&g.write(),C(t,h),a&&(5===r&&y.write(),b(t,a.topic),C(t,a.payload)),null!=d&&C(t,d),null!=u&&C(t,u),!0}(e,t);case"connack":return function(e,t,o){const r=o?o.protocolVersion:4,a=e||{},l=5===r?a.reasonCode:a.returnCode,c=a.properties;let h=2;if("number"!=typeof l)return t.emit("error",new Error("Invalid return code")),!1;let d=null;if(5===r){if(!(d=A(t,c)))return!1;h+=d.length}return t.write(n.CONNACK_HEADER),w(t,h),t.write(a.sessionPresent?n.SESSIONPRESENT_HEADER:s),t.write(i.from([l])),null!=d&&d.write(),!0}(e,t,r);case"publish":return function(e,t,s){l("publish: packet: %o",e);const r=s?s.protocolVersion:4,a=e||{},c=a.qos||0,h=a.retain?n.RETAIN_MASK:0,d=a.topic,u=a.payload||o,p=a.messageId,v=a.properties;let g=0;if("string"==typeof d)g+=i.byteLength(d)+2;else{if(!i.isBuffer(d))return t.emit("error",new Error("Invalid topic")),!1;g+=d.length+2}if(i.isBuffer(u)?g+=u.length:g+=i.byteLength(u),c&&"number"!=typeof p)return t.emit("error",new Error("Invalid messageId")),!1;c&&(g+=2);let y=null;if(5===r){if(!(y=A(t,v)))return!1;g+=y.length}return t.write(n.PUBLISH_HEADER[c][a.dup?1:0][h?1:0]),w(t,g),f(t,P(d)),t.write(d),c>0&&f(t,p),null!=y&&y.write(),l("publish: payload: %o",u),t.write(u)}(e,t,r);case"puback":case"pubrec":case"pubrel":case"pubcomp":return function(e,t,o){const s=o?o.protocolVersion:4,r=e||{},a=r.cmd||"puback",l=r.messageId,c=r.dup&&"pubrel"===a?n.DUP_MASK:0;let h=0;const d=r.reasonCode,u=r.properties;let p=5===s?3:2;if("pubrel"===a&&(h=1),"number"!=typeof l)return t.emit("error",new Error("Invalid messageId")),!1;let v=null;if(5===s&&"object"==typeof u){if(!(v=R(t,u,o,p)))return!1;p+=v.length}return t.write(n.ACKS[a][h][c][0]),w(t,p),f(t,l),5===s&&t.write(i.from([d])),null!==v&&v.write(),!0}(e,t,r);case"subscribe":return function(e,t,o){l("subscribe: packet: ");const s=o?o.protocolVersion:4,r=e||{},a=r.dup?n.DUP_MASK:0,c=r.messageId,h=r.subscriptions,d=r.properties;let u=0;if("number"!=typeof c)return t.emit("error",new Error("Invalid messageId")),!1;u+=2;let p=null;if(5===s){if(!(p=A(t,d)))return!1;u+=p.length}if("object"!=typeof h||!h.length)return t.emit("error",new Error("Invalid subscriptions")),!1;for(let n=0;n<h.length;n+=1){const e=h[n].topic,o=h[n].qos;if("string"!=typeof e)return t.emit("error",new Error("Invalid subscriptions - invalid topic")),!1;if("number"!=typeof o)return t.emit("error",new Error("Invalid subscriptions - invalid qos")),!1;if(5===s){if("boolean"!=typeof(h[n].nl||!1))return t.emit("error",new Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!=typeof(h[n].rap||!1))return t.emit("error",new Error("Invalid subscriptions - invalid Retain as Published")),!1;const e=h[n].rh||0;if("number"!=typeof e||e>2)return t.emit("error",new Error("Invalid subscriptions - invalid Retain Handling")),!1}u+=i.byteLength(e)+2+1}l("subscribe: writing to stream: %o",n.SUBSCRIBE_HEADER),t.write(n.SUBSCRIBE_HEADER[1][a?1:0][0]),w(t,u),f(t,c),null!==p&&p.write();let v=!0;for(const l of h){const e=l.topic,o=l.qos,r=+l.nl,a=+l.rap,c=l.rh;let h;b(t,e),h=n.SUBSCRIBE_OPTIONS_QOS[o],5===s&&(h|=r?n.SUBSCRIBE_OPTIONS_NL:0,h|=a?n.SUBSCRIBE_OPTIONS_RAP:0,h|=c?n.SUBSCRIBE_OPTIONS_RH[c]:0),v=t.write(i.from([h]))}return v}(e,t,r);case"suback":return function(e,t,o){const s=o?o.protocolVersion:4,r=e||{},a=r.messageId,l=r.granted,c=r.properties;let h=0;if("number"!=typeof a)return t.emit("error",new Error("Invalid messageId")),!1;if(h+=2,"object"!=typeof l||!l.length)return t.emit("error",new Error("Invalid qos vector")),!1;for(let i=0;i<l.length;i+=1){if("number"!=typeof l[i])return t.emit("error",new Error("Invalid qos vector")),!1;h+=1}let d=null;if(5===s){if(!(d=R(t,c,o,h)))return!1;h+=d.length}return t.write(n.SUBACK_HEADER),w(t,h),f(t,a),null!==d&&d.write(),t.write(i.from(l))}(e,t,r);case"unsubscribe":return function(e,t,o){const s=o?o.protocolVersion:4,r=e||{},a=r.messageId,l=r.dup?n.DUP_MASK:0,c=r.unsubscriptions,h=r.properties;let d=0;if("number"!=typeof a)return t.emit("error",new Error("Invalid messageId")),!1;if(d+=2,"object"!=typeof c||!c.length)return t.emit("error",new Error("Invalid unsubscriptions")),!1;for(let n=0;n<c.length;n+=1){if("string"!=typeof c[n])return t.emit("error",new Error("Invalid unsubscriptions")),!1;d+=i.byteLength(c[n])+2}let u=null;if(5===s){if(!(u=A(t,h)))return!1;d+=u.length}t.write(n.UNSUBSCRIBE_HEADER[1][l?1:0][0]),w(t,d),f(t,a),null!==u&&u.write();let p=!0;for(let i=0;i<c.length;i++)p=b(t,c[i]);return p}(e,t,r);case"unsuback":return function(e,t,o){const s=o?o.protocolVersion:4,r=e||{},a=r.messageId,l=r.dup?n.DUP_MASK:0,c=r.granted,h=r.properties,d=r.cmd;let u=2;if("number"!=typeof a)return t.emit("error",new Error("Invalid messageId")),!1;if(5===s){if("object"!=typeof c||!c.length)return t.emit("error",new Error("Invalid qos vector")),!1;for(let e=0;e<c.length;e+=1){if("number"!=typeof c[e])return t.emit("error",new Error("Invalid qos vector")),!1;u+=1}}let p=null;if(5===s){if(!(p=R(t,h,o,u)))return!1;u+=p.length}return t.write(n.ACKS[d][0][l][0]),w(t,u),f(t,a),null!==p&&p.write(),5===s&&t.write(i.from(c)),!0}(e,t,r);case"pingreq":case"pingresp":return c=e,t.write(n.EMPTY[c.cmd]);case"disconnect":return function(e,t,o){const s=o?o.protocolVersion:4,r=e||{},a=r.reasonCode,l=r.properties;let c=5===s?1:0,h=null;if(5===s){if(!(h=R(t,l,o,c)))return!1;c+=h.length}return t.write(i.from([n.codes.disconnect<<4])),w(t,c),5===s&&t.write(i.from([a])),null!==h&&h.write(),!0}(e,t,r);case"auth":return function(e,t,o){const s=o?o.protocolVersion:4,r=e||{},a=r.reasonCode,l=r.properties;let c=5===s?1:0;5!==s&&t.emit("error",new Error("Invalid mqtt version for auth packet"));const h=R(t,l,o,c);return!!h&&(c+=h.length,t.write(i.from([n.codes.auth<<4])),w(t,c),t.write(i.from([a])),null!==h&&h.write(),!0)}(e,t,r);default:return t.emit("error",new Error("Unknown command")),!1}var c}function y(e){e.uncork()}Object.defineProperty(g,"cacheNumbers",{get:()=>f===k,set(e){e?(c&&0!==Object.keys(c).length||(v=!0),f=k):(v=!1,f=T)}});const m={};function w(e,t){if(t>n.VARBYTEINT_MAX)return e.emit("error",new Error(`Invalid variable byte integer: ${t}`)),!1;let i=m[t];return i||(i=u(t),t<16384&&(m[t]=i)),l("writeVarByteInt: writing to stream: %o",i),e.write(i)}function b(e,t){const n=i.byteLength(t);return f(e,n),l("writeString: %s",t),e.write(t,"utf8")}function x(e,t,i){b(e,t),b(e,i)}function k(e,t){return l("writeNumberCached: number: %d",t),l("writeNumberCached: %o",c[t]),e.write(c[t])}function T(e,t){const i=h(t);return l("writeNumberGenerated: %o",i),e.write(i)}function C(e,t){"string"==typeof t?b(e,t):t?(f(e,t.length),e.write(t)):f(e,0)}function A(e,t){if("object"!=typeof t||null!=t.length)return{length:1,write(){S(e,{},0)}};let o=0;function s(t,o){let s=0;switch(n.propertiesTypes[t]){case"byte":if("boolean"!=typeof o)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=2;break;case"int8":if("number"!=typeof o||o<0||o>255)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=2;break;case"binary":if(o&&null===o)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=1+i.byteLength(o)+2;break;case"int16":if("number"!=typeof o||o<0||o>65535)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=3;break;case"int32":if("number"!=typeof o||o<0||o>4294967295)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=5;break;case"var":if("number"!=typeof o||o<0||o>268435455)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=1+i.byteLength(u(o));break;case"string":if("string"!=typeof o)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=3+i.byteLength(o.toString());break;case"pair":if("object"!=typeof o)return e.emit("error",new Error(`Invalid ${t}: ${o}`)),!1;s+=Object.getOwnPropertyNames(o).reduce(((e,t)=>{const n=o[t];return Array.isArray(n)?e+=n.reduce(((e,n)=>e+(3+i.byteLength(t.toString())+2+i.byteLength(n.toString()))),0):e+=3+i.byteLength(t.toString())+2+i.byteLength(o[t].toString()),e}),0);break;default:return e.emit("error",new Error(`Invalid property ${t}: ${o}`)),!1}return s}if(t)for(const i in t){let e=0,n=0;const r=t[i];if(Array.isArray(r))for(let t=0;t<r.length;t++){if(!(n=s(i,r[t])))return!1;e+=n}else{if(!(n=s(i,r)))return!1;e=n}if(!e)return!1;o+=e}return{length:i.byteLength(u(o))+o,write(){S(e,t,o)}}}function R(e,t,i,n){const o=["reasonString","userProperties"],s=i&&i.properties&&i.properties.maximumPacketSize?i.properties.maximumPacketSize:0;let r=A(e,t);if(s)for(;n+r.length>s;){const i=o.shift();if(!i||!t[i])return!1;delete t[i],r=A(e,t)}return r}function _(e,t,o){switch(n.propertiesTypes[t]){case"byte":e.write(i.from([n.properties[t]])),e.write(i.from([+o]));break;case"int8":e.write(i.from([n.properties[t]])),e.write(i.from([o]));break;case"binary":e.write(i.from([n.properties[t]])),C(e,o);break;case"int16":e.write(i.from([n.properties[t]])),f(e,o);break;case"int32":e.write(i.from([n.properties[t]])),function(e,t){const i=p(t);l("write4ByteNumber: %o",i),e.write(i)}(e,o);break;case"var":e.write(i.from([n.properties[t]])),w(e,o);break;case"string":e.write(i.from([n.properties[t]])),b(e,o);break;case"pair":Object.getOwnPropertyNames(o).forEach((s=>{const r=o[s];Array.isArray(r)?r.forEach((o=>{e.write(i.from([n.properties[t]])),x(e,s.toString(),o.toString())})):(e.write(i.from([n.properties[t]])),x(e,s.toString(),r.toString()))}));break;default:return e.emit("error",new Error(`Invalid property ${t} value: ${o}`)),!1}}function S(e,t,i){w(e,i);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&null!==t[n]){const i=t[n];if(Array.isArray(i))for(let t=0;t<i.length;t++)_(e,n,i[t]);else _(e,n,i)}}function P(e){return e?e instanceof i?e.length:i.byteLength(e):0}function E(e){return"string"==typeof e||e instanceof i}t.exports=g}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":38,"./numbers":41,buffer:17,debug:18,"process-nextick-args":49}],45:[function(e,t,i){var n=1e3,o=60*n,s=60*o,r=24*s,a=7*r,l=365.25*r;function c(e,t,i,n){var o=t>=1.5*i;return Math.round(e/i)+" "+n+(o?"s":"")}t.exports=function(e,t){t=t||{};var i,h,d=typeof e;if("string"===d&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return i*l;case"weeks":case"week":case"w":return i*a;case"days":case"day":case"d":return i*r;case"hours":case"hour":case"hrs":case"hr":case"h":return i*s;case"minutes":case"minute":case"mins":case"min":case"m":return i*o;case"seconds":case"second":case"secs":case"sec":case"s":return i*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}}}(e);if("number"===d&&isFinite(e))return t.long?(i=e,(h=Math.abs(i))>=r?c(i,h,r,"day"):h>=s?c(i,h,s,"hour"):h>=o?c(i,h,o,"minute"):h>=n?c(i,h,n,"second"):i+" ms"):function(e){var t=Math.abs(e);return t>=r?Math.round(e/r)+"d":t>=s?Math.round(e/s)+"h":t>=o?Math.round(e/o)+"m":t>=n?Math.round(e/n)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},{}],46:[function(e,t,i){const n=e("./lib/number-allocator.js");t.exports.NumberAllocator=n},{"./lib/number-allocator.js":47}],47:[function(e,t,i){const n=e("js-sdsl").Set,o=e("debug")("number-allocator:trace"),s=e("debug")("number-allocator:error");function r(e,t){this.low=e,this.high=t}function a(e,t){if(!(this instanceof a))return new a(e,t);this.min=e,this.max=t,this.ss=new n([],((e,t)=>e.compare(t))),o("Create"),this.clear()}r.prototype.equals=function(e){return this.low===e.low&&this.high===e.high},r.prototype.compare=function(e){return this.low<e.low&&this.high<e.low?-1:e.low<this.low&&e.high<this.low?1:0},a.prototype.firstVacant=function(){return 0===this.ss.size()?null:this.ss.front().low},a.prototype.alloc=function(){if(0===this.ss.size())return o("alloc():empty"),null;const e=this.ss.front(),t=e.low;return t+1<=e.high?++e.low:this.ss.eraseElementByPos(0),o("alloc():"+t),t},a.prototype.use=function(e){const t=new r(e,e),i=this.ss.lowerBound(t);if(i){if(i.equals(t))return this.ss.eraseElementByValue(i),o("use():"+e),!0;if(i.low>e)return!1;if(i.low===e)return++i.low,o("use():"+e),!0;if(i.high===e)return--i.high,o("use():"+e),!0;const n=i.low;return i.low=e+1,this.ss.insert(new r(n,e-1)),o("use():"+e),!0}return o("use():failed"),!1},a.prototype.free=function(e){if(e<this.min||e>this.max)return void s("free():"+e+" is out of range");const t=new r(e,e),i=this.ss.lowerBound(t);if(i){if(i.low<=e&&e<=i.high)return void s("free():"+e+" has already been vacant");if(i===this.ss.front())e+1===i.low?--i.low:this.ss.insert(t);else{const n=this.ss.reverseLowerBound(t);n.high+1===e?e+1===i.low?(this.ss.eraseElementByValue(n),i.low=n.low):n.high=e:e+1===i.low?i.low=e:this.ss.insert(t)}}else{if(i===this.ss.front())return void this.ss.insert(t);const n=this.ss.reverseLowerBound(t);n.high+1===e?n.high=e:this.ss.insert(t)}o("free():"+e)},a.prototype.clear=function(){o("clear()"),this.ss.clear(),this.ss.insert(new r(this.min,this.max))},a.prototype.intervalCount=function(){return this.ss.size()},a.prototype.dump=function(){for(const e of this.ss);},t.exports=a},{debug:18,"js-sdsl":36}],48:[function(e,t,i){var n=e("wrappy");function o(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function s(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},i=e.name||"Function wrapped with `once`";return t.onceError=i+" shouldn't be called more than once",t.called=!1,t}t.exports=n(o),t.exports.strict=n(s),o.proto=o((function(){Object.defineProperty(Function.prototype,"once",{value:function(){return o(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return s(this)},configurable:!0})}))},{wrappy:79}],49:[function(e,t,i){(function(e){(function(){void 0===e||!e.version||0===e.version.indexOf("v0.")||0===e.version.indexOf("v1.")&&0!==e.version.indexOf("v1.8.")?t.exports={nextTick:function(t,i,n,o){if("function"!=typeof t)throw new TypeError('"callback" argument must be a function');var s,r,a=arguments.length;switch(a){case 0:case 1:return e.nextTick(t);case 2:return e.nextTick((function(){t.call(null,i)}));case 3:return e.nextTick((function(){t.call(null,i,n)}));case 4:return e.nextTick((function(){t.call(null,i,n,o)}));default:for(s=new Array(a-1),r=0;r<s.length;)s[r++]=arguments[r];return e.nextTick((function(){t.apply(null,s)}))}}}:t.exports=e}).call(this)}).call(this,e("_process"))},{_process:50}],50:[function(e,t,i){var n,o,s=t.exports={};function r(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function l(e){if(n===setTimeout)return setTimeout(e,0);if((n===r||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(i){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:r}catch(e){n=r}try{o="function"==typeof clearTimeout?clearTimeout:a}catch(e){o=a}}();var c,h=[],d=!1,u=-1;function p(){d&&c&&(d=!1,c.length?h=c.concat(h):u=-1,h.length&&f())}function f(){if(!d){var e=l(p);d=!0;for(var t=h.length;t;){for(c=h,h=[];++u<t;)c&&c[u].run();u=-1,t=h.length}c=null,d=!1,function(e){if(o===clearTimeout)return clearTimeout(e);if((o===a||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(e);try{o(e)}catch(t){try{return o.call(null,e)}catch(i){return o.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function g(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];h.push(new v(e,t)),1!==h.length||d||l(f)},v.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=g,s.addListener=g,s.once=g,s.off=g,s.removeListener=g,s.removeAllListeners=g,s.emit=g,s.prependListener=g,s.prependOnceListener=g,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},{}],51:[function(e,t,i){(function(e){(function(){!function(n){var o="object"==typeof i&&i&&!i.nodeType&&i,s="object"==typeof t&&t&&!t.nodeType&&t,r="object"==typeof e&&e;r.global!==r&&r.window!==r&&r.self!==r||(n=r);var a,l,c=2147483647,h=36,d=1,u=26,p=38,f=700,v=72,g=128,y="-",m=/^xn--/,w=/[^\x20-\x7E]/,b=/[\x2E\u3002\uFF0E\uFF61]/g,x={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},k=h-d,T=Math.floor,C=String.fromCharCode;function A(e){throw new RangeError(x[e])}function R(e,t){for(var i=e.length,n=[];i--;)n[i]=t(e[i]);return n}function _(e,t){var i=e.split("@"),n="";return i.length>1&&(n=i[0]+"@",e=i[1]),n+R((e=e.replace(b,".")).split("."),t).join(".")}function S(e){for(var t,i,n=[],o=0,s=e.length;o<s;)(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<s?56320==(64512&(i=e.charCodeAt(o++)))?n.push(((1023&t)<<10)+(1023&i)+65536):(n.push(t),o--):n.push(t);return n}function P(e){return R(e,(function(e){var t="";return e>65535&&(t+=C((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+C(e)})).join("")}function E(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function I(e,t,i){var n=0;for(e=i?T(e/f):e>>1,e+=T(e/t);e>k*u>>1;n+=h)e=T(e/k);return T(n+(k+1)*e/(e+p))}function L(e){var t,i,n,o,s,r,a,l,p,f,m,w=[],b=e.length,x=0,k=g,C=v;for((i=e.lastIndexOf(y))<0&&(i=0),n=0;n<i;++n)e.charCodeAt(n)>=128&&A("not-basic"),w.push(e.charCodeAt(n));for(o=i>0?i+1:0;o<b;){for(s=x,r=1,a=h;o>=b&&A("invalid-input"),((l=(m=e.charCodeAt(o++))-48<10?m-22:m-65<26?m-65:m-97<26?m-97:h)>=h||l>T((c-x)/r))&&A("overflow"),x+=l*r,!(l<(p=a<=C?d:a>=C+u?u:a-C));a+=h)r>T(c/(f=h-p))&&A("overflow"),r*=f;C=I(x-s,t=w.length+1,0==s),T(x/t)>c-k&&A("overflow"),k+=T(x/t),x%=t,w.splice(x++,0,k)}return P(w)}function M(e){var t,i,n,o,s,r,a,l,p,f,m,w,b,x,k,R=[];for(w=(e=S(e)).length,t=g,i=0,s=v,r=0;r<w;++r)(m=e[r])<128&&R.push(C(m));for(n=o=R.length,o&&R.push(y);n<w;){for(a=c,r=0;r<w;++r)(m=e[r])>=t&&m<a&&(a=m);for(a-t>T((c-i)/(b=n+1))&&A("overflow"),i+=(a-t)*b,t=a,r=0;r<w;++r)if((m=e[r])<t&&++i>c&&A("overflow"),m==t){for(l=i,p=h;!(l<(f=p<=s?d:p>=s+u?u:p-s));p+=h)k=l-f,x=h-f,R.push(C(E(f+k%x,0))),l=T(k/x);R.push(C(E(l,0))),s=I(i,b,n==o),i=0,++n}++i,++t}return R.join("")}if(a={version:"1.4.1",ucs2:{decode:S,encode:P},decode:L,encode:M,toASCII:function(e){return _(e,(function(e){return w.test(e)?"xn--"+M(e):e}))},toUnicode:function(e){return _(e,(function(e){return m.test(e)?L(e.slice(4).toLowerCase()):e}))}},o&&s)if(t.exports==o)s.exports=a;else for(l in a)a.hasOwnProperty(l)&&(o[l]=a[l]);else n.punycode=a}(this)}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],52:[function(e,t,i){function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,i,s){t=t||"&",i=i||"=";var r={};if("string"!=typeof e||0===e.length)return r;var a=/\+/g;e=e.split(t);var l=1e3;s&&"number"==typeof s.maxKeys&&(l=s.maxKeys);var c=e.length;l>0&&c>l&&(c=l);for(var h=0;h<c;++h){var d,u,p,f,v=e[h].replace(a,"%20"),g=v.indexOf(i);g>=0?(d=v.substr(0,g),u=v.substr(g+1)):(d=v,u=""),p=decodeURIComponent(d),f=decodeURIComponent(u),n(r,p)?o(r[p])?r[p].push(f):r[p]=[r[p],f]:r[p]=f}return r};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],53:[function(e,t,i){var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,i,a){return t=t||"&",i=i||"=",null===e&&(e=void 0),"object"==typeof e?s(r(e),(function(r){var a=encodeURIComponent(n(r))+i;return o(e[r])?s(e[r],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[r]))})).join(t):a?encodeURIComponent(n(a))+i+encodeURIComponent(n(e)):""};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function s(e,t){if(e.map)return e.map(t);for(var i=[],n=0;n<e.length;n++)i.push(t(e[n],n));return i}var r=Object.keys||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.push(i);return t}},{}],54:[function(e,t,i){i.decode=i.parse=e("./decode"),i.encode=i.stringify=e("./encode")},{"./decode":52,"./encode":53}],55:[function(e,t,i){var n={};function o(e,t,i){i||(i=Error);var o=function(e){var i,n;function o(i,n,o){return e.call(this,(s=i,r=n,a=o,"string"==typeof t?t:t(s,r,a)))||this;var s,r,a}return n=e,(i=o).prototype=Object.create(n.prototype),i.prototype.constructor=i,i.__proto__=n,o}(i);o.prototype.name=i.name,o.prototype.code=e,n[e]=o}function s(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map((function(e){return String(e)})),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:2===i?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}o("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),o("ERR_INVALID_ARG_TYPE",(function(e,t,i){var n,o,r,a,l,c;if("string"==typeof t&&(o="not ",t.substr(0,o.length)===o)?(n="must not be",t=t.replace(/^not /,"")):n="must be",a=e,l=" argument",(void 0===c||c>a.length)&&(c=a.length),a.substring(c-l.length,c)===l)r="The ".concat(e," ").concat(n," ").concat(s(t,"type"));else{var h=function(e,t,i){return"number"!=typeof i&&(i=0),!(i+t.length>e.length)&&-1!==e.indexOf(t,i)}(e,".")?"property":"argument";r='The "'.concat(e,'" ').concat(h," ").concat(n," ").concat(s(t,"type"))}return r+". Received type ".concat(typeof i)}),TypeError),o("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),o("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),o("ERR_STREAM_PREMATURE_CLOSE","Premature close"),o("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),o("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),o("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),o("ERR_STREAM_WRITE_AFTER_END","write after end"),o("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),o("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),o("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.codes=n},{}],56:[function(e,t,i){(function(i){(function(){var n=Object.keys||function(e){var t=[];for(var i in e)t.push(i);return t};t.exports=c;var o=e("./_stream_readable"),s=e("./_stream_writable");e("inherits")(c,o);for(var r=n(s.prototype),a=0;a<r.length;a++){var l=r[a];c.prototype[l]||(c.prototype[l]=s.prototype[l])}function c(e){if(!(this instanceof c))return new c(e);o.call(this,e),s.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",h)))}function h(){this._writableState.ended||i.nextTick(d,this)}function d(e){e.end()}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this)}).call(this,e("_process"))},{"./_stream_readable":58,"./_stream_writable":60,_process:50,inherits:24}],57:[function(e,t,i){t.exports=o;var n=e("./_stream_transform");function o(e){if(!(this instanceof o))return new o(e);n.call(this,e)}e("inherits")(o,n),o.prototype._transform=function(e,t,i){i(null,e)}},{"./_stream_transform":59,inherits:24}],58:[function(e,t,i){(function(i,n){(function(){var o;t.exports=A,A.ReadableState=C,e("events").EventEmitter;var s,r=function(e,t){return e.listeners(t).length},a=e("./internal/streams/stream"),l=e("buffer").Buffer,c=n.Uint8Array||function(){},h=e("util");s=h&&h.debuglog?h.debuglog("stream"):function(){};var d,u,p,f=e("./internal/streams/buffer_list"),v=e("./internal/streams/destroy"),g=e("./internal/streams/state").getHighWaterMark,y=e("../errors").codes,m=y.ERR_INVALID_ARG_TYPE,w=y.ERR_STREAM_PUSH_AFTER_EOF,b=y.ERR_METHOD_NOT_IMPLEMENTED,x=y.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;e("inherits")(A,a);var k=v.errorOrDestroy,T=["error","close","destroy","pause","resume"];function C(t,i,n){o=o||e("./_stream_duplex"),t=t||{},"boolean"!=typeof n&&(n=i instanceof o),this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=g(this,t,"readableHighWaterMark",n),this.buffer=new f,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(d||(d=e("string_decoder/").StringDecoder),this.decoder=new d(t.encoding),this.encoding=t.encoding)}function A(t){if(o=o||e("./_stream_duplex"),!(this instanceof A))return new A(t);var i=this instanceof o;this._readableState=new C(t,this,i),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),a.call(this)}function R(e,t,i,n,o){s("readableAddChunk",t);var r,a,h,d,u,p=e._readableState;if(null===t)p.reading=!1,function(e,t){if(s("onEofChunk"),!t.ended){if(t.decoder){var i=t.decoder.end();i&&i.length&&(t.buffer.push(i),t.length+=t.objectMode?1:i.length)}t.ended=!0,t.sync?E(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,I(e)))}}(e,p);else if(o||(a=p,u=h=t,l.isBuffer(u)||u instanceof c||"string"==typeof h||void 0===h||a.objectMode||(d=new m("chunk",["string","Buffer","Uint8Array"],h)),r=d),r)k(e,r);else if(p.objectMode||t&&t.length>0)if("string"==typeof t||p.objectMode||Object.getPrototypeOf(t)===l.prototype||(t=function(e){return l.from(e)}(t)),n)p.endEmitted?k(e,new x):_(e,p,t,!0);else if(p.ended)k(e,new w);else{if(p.destroyed)return!1;p.reading=!1,p.decoder&&!i?(t=p.decoder.write(t),p.objectMode||0!==t.length?_(e,p,t,!1):L(e,p)):_(e,p,t,!1)}else n||(p.reading=!1,L(e,p));return!p.ended&&(p.length<p.highWaterMark||0===p.length)}function _(e,t,i,n){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",i)):(t.length+=t.objectMode?1:i.length,n?t.buffer.unshift(i):t.buffer.push(i),t.needReadable&&E(e)),L(e,t)}Object.defineProperty(A.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),A.prototype.destroy=v.destroy,A.prototype._undestroy=v.undestroy,A.prototype._destroy=function(e,t){t(e)},A.prototype.push=function(e,t){var i,n=this._readableState;return n.objectMode?i=!0:"string"==typeof e&&((t=t||n.defaultEncoding)!==n.encoding&&(e=l.from(e,t),t=""),i=!0),R(this,e,t,!1,i)},A.prototype.unshift=function(e){return R(this,e,null,!0,!1)},A.prototype.isPaused=function(){return!1===this._readableState.flowing},A.prototype.setEncoding=function(t){d||(d=e("string_decoder/").StringDecoder);var i=new d(t);this._readableState.decoder=i,this._readableState.encoding=this._readableState.decoder.encoding;for(var n=this._readableState.buffer.head,o="";null!==n;)o+=i.write(n.data),n=n.next;return this._readableState.buffer.clear(),""!==o&&this._readableState.buffer.push(o),this._readableState.length=o.length,this};var S=1073741824;function P(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=((i=e)>=S?i=S:(i--,i|=i>>>1,i|=i>>>2,i|=i>>>4,i|=i>>>8,i|=i>>>16,i++),i)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0));var i}function E(e){var t=e._readableState;s("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(s("emitReadable",t.flowing),t.emittedReadable=!0,i.nextTick(I,e))}function I(e){var t=e._readableState;s("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,B(e)}function L(e,t){t.readingMore||(t.readingMore=!0,i.nextTick(M,e,t))}function M(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var i=t.length;if(s("maybeReadMore read 0"),e.read(0),i===t.length)break}t.readingMore=!1}function D(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function F(e){s("readable nexttick read 0"),e.read(0)}function O(e,t){s("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),B(e),t.flowing&&!t.reading&&e.read(0)}function B(e){var t=e._readableState;for(s("flow",t.flowing);t.flowing&&null!==e.read(););}function N(e,t){return 0===t.length?null:(t.objectMode?i=t.buffer.shift():!e||e>=t.length?(i=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):i=t.buffer.consume(e,t.decoder),i);var i}function z(e){var t=e._readableState;s("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,i.nextTick(H,t,e))}function H(e,t){if(s("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var i=t._writableState;(!i||i.autoDestroy&&i.finished)&&t.destroy()}}function j(e,t){for(var i=0,n=e.length;i<n;i++)if(e[i]===t)return i;return-1}A.prototype.read=function(e){s("read",e),e=parseInt(e,10);var t=this._readableState,i=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return s("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?z(this):E(this),null;if(0===(e=P(e,t))&&t.ended)return 0===t.length&&z(this),null;var n,o=t.needReadable;return s("need readable",o),(0===t.length||t.length-e<t.highWaterMark)&&s("length less than watermark",o=!0),t.ended||t.reading?s("reading or ended",o=!1):o&&(s("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=P(i,t))),null===(n=e>0?N(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),i!==e&&t.ended&&z(this)),null!==n&&this.emit("data",n),n},A.prototype._read=function(e){k(this,new b("_read()"))},A.prototype.pipe=function(e,t){var n=this,o=this._readableState;switch(o.pipesCount){case 0:o.pipes=e;break;case 1:o.pipes=[o.pipes,e];break;default:o.pipes.push(e)}o.pipesCount+=1,s("pipe count=%d opts=%j",o.pipesCount,t);var a=t&&!1===t.end||e===i.stdout||e===i.stderr?y:c;function l(t,i){s("onunpipe"),t===n&&i&&!1===i.hasUnpiped&&(i.hasUnpiped=!0,s("cleanup"),e.removeListener("close",v),e.removeListener("finish",g),e.removeListener("drain",d),e.removeListener("error",f),e.removeListener("unpipe",l),n.removeListener("end",c),n.removeListener("end",y),n.removeListener("data",p),u=!0,!o.awaitDrain||e._writableState&&!e._writableState.needDrain||d())}function c(){s("onend"),e.end()}o.endEmitted?i.nextTick(a):n.once("end",a),e.on("unpipe",l);var h,d=(h=n,function(){var e=h._readableState;s("pipeOnDrain",e.awaitDrain),e.awaitDrain&&e.awaitDrain--,0===e.awaitDrain&&r(h,"data")&&(e.flowing=!0,B(h))});e.on("drain",d);var u=!1;function p(t){s("ondata");var i=e.write(t);s("dest.write",i),!1===i&&((1===o.pipesCount&&o.pipes===e||o.pipesCount>1&&-1!==j(o.pipes,e))&&!u&&(s("false write response, pause",o.awaitDrain),o.awaitDrain++),n.pause())}function f(t){s("onerror",t),y(),e.removeListener("error",f),0===r(e,"error")&&k(e,t)}function v(){e.removeListener("finish",g),y()}function g(){s("onfinish"),e.removeListener("close",v),y()}function y(){s("unpipe"),n.unpipe(e)}return n.on("data",p),function(e,t,i){if("function"==typeof e.prependListener)return e.prependListener(t,i);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(i):e._events[t]=[i,e._events[t]]:e.on(t,i)}(e,"error",f),e.once("close",v),e.once("finish",g),e.emit("pipe",n),o.flowing||(s("pipe resume"),n.resume()),e},A.prototype.unpipe=function(e){var t=this._readableState,i={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,i)),this;if(!e){var n=t.pipes,o=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var s=0;s<o;s++)n[s].emit("unpipe",this,{hasUnpiped:!1});return this}var r=j(t.pipes,e);return-1===r||(t.pipes.splice(r,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,i)),this},A.prototype.on=function(e,t){var n=a.prototype.on.call(this,e,t),o=this._readableState;return"data"===e?(o.readableListening=this.listenerCount("readable")>0,!1!==o.flowing&&this.resume()):"readable"===e&&(o.endEmitted||o.readableListening||(o.readableListening=o.needReadable=!0,o.flowing=!1,o.emittedReadable=!1,s("on readable",o.length,o.reading),o.length?E(this):o.reading||i.nextTick(F,this))),n},A.prototype.addListener=A.prototype.on,A.prototype.removeListener=function(e,t){var n=a.prototype.removeListener.call(this,e,t);return"readable"===e&&i.nextTick(D,this),n},A.prototype.removeAllListeners=function(e){var t=a.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||i.nextTick(D,this),t},A.prototype.resume=function(){var e,t,n=this._readableState;return n.flowing||(s("resume"),n.flowing=!n.readableListening,e=this,(t=n).resumeScheduled||(t.resumeScheduled=!0,i.nextTick(O,e,t))),n.paused=!1,this},A.prototype.pause=function(){return s("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(s("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},A.prototype.wrap=function(e){var t=this,i=this._readableState,n=!1;for(var o in e.on("end",(function(){if(s("wrapped end"),i.decoder&&!i.ended){var e=i.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(o){s("wrapped data"),i.decoder&&(o=i.decoder.write(o)),(!i.objectMode||null!=o)&&(i.objectMode||o&&o.length)&&(t.push(o)||(n=!0,e.pause()))})),e)void 0===this[o]&&"function"==typeof e[o]&&(this[o]=function(t){return function(){return e[t].apply(e,arguments)}}(o));for(var r=0;r<T.length;r++)e.on(T[r],this.emit.bind(this,T[r]));return this._read=function(t){s("wrapped _read",t),n&&(n=!1,e.resume())},this},"function"==typeof Symbol&&(A.prototype[Symbol.asyncIterator]=function(){return void 0===u&&(u=e("./internal/streams/async_iterator")),u(this)}),Object.defineProperty(A.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(A.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(A.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),A._fromList=N,Object.defineProperty(A.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(A.from=function(t,i){return void 0===p&&(p=e("./internal/streams/from")),p(A,t,i)})}).call(this)}).call(this,e("_process"),void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/async_iterator":61,"./internal/streams/buffer_list":62,"./internal/streams/destroy":63,"./internal/streams/from":65,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,events:22,inherits:24,"string_decoder/":75,util:16}],59:[function(e,t,i){t.exports=c;var n=e("../errors").codes,o=n.ERR_METHOD_NOT_IMPLEMENTED,s=n.ERR_MULTIPLE_CALLBACK,r=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,a=n.ERR_TRANSFORM_WITH_LENGTH_0,l=e("./_stream_duplex");function c(e){if(!(this instanceof c))return new c(e);l.call(this,e),this._transformState={afterTransform:function(e,t){var i=this._transformState;i.transforming=!1;var n=i.writecb;if(null===n)return this.emit("error",new s);i.writechunk=null,i.writecb=null,null!=t&&this.push(t),n(e);var o=this._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",h)}function h(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?d(this,null,null):this._flush((function(t,i){d(e,t,i)}))}function d(e,t,i){if(t)return e.emit("error",t);if(null!=i&&e.push(i),e._writableState.length)throw new a;if(e._transformState.transforming)throw new r;return e.push(null)}e("inherits")(c,l),c.prototype.push=function(e,t){return this._transformState.needTransform=!1,l.prototype.push.call(this,e,t)},c.prototype._transform=function(e,t,i){i(new o("_transform()"))},c.prototype._write=function(e,t,i){var n=this._transformState;if(n.writecb=i,n.writechunk=e,n.writeencoding=t,!n.transforming){var o=this._readableState;(n.needTransform||o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}},c.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},c.prototype._destroy=function(e,t){l.prototype._destroy.call(this,e,(function(e){t(e)}))}},{"../errors":55,"./_stream_duplex":56,inherits:24}],60:[function(e,t,i){(function(i,n){(function(){function o(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t,i){var n=e.entry;for(e.entry=null;n;){var o=n.callback;t.pendingcb--,o(i),n=n.next}t.corkedRequestsFree.next=e}(t,e)}}var s;t.exports=A,A.WritableState=C;var r,a={deprecate:e("util-deprecate")},l=e("./internal/streams/stream"),c=e("buffer").Buffer,h=n.Uint8Array||function(){},d=e("./internal/streams/destroy"),u=e("./internal/streams/state").getHighWaterMark,p=e("../errors").codes,f=p.ERR_INVALID_ARG_TYPE,v=p.ERR_METHOD_NOT_IMPLEMENTED,g=p.ERR_MULTIPLE_CALLBACK,y=p.ERR_STREAM_CANNOT_PIPE,m=p.ERR_STREAM_DESTROYED,w=p.ERR_STREAM_NULL_VALUES,b=p.ERR_STREAM_WRITE_AFTER_END,x=p.ERR_UNKNOWN_ENCODING,k=d.errorOrDestroy;function T(){}function C(t,n,r){s=s||e("./_stream_duplex"),t=t||{},"boolean"!=typeof r&&(r=n instanceof s),this.objectMode=!!t.objectMode,r&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=u(this,t,"writableHighWaterMark",r),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var a=!1===t.decodeStrings;this.decodeStrings=!a,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var n,o=e._writableState,s=o.sync,r=o.writecb;if("function"!=typeof r)throw new g;if((n=o).writing=!1,n.writecb=null,n.length-=n.writelen,n.writelen=0,t)!function(e,t,n,o,s){--t.pendingcb,n?(i.nextTick(s,o),i.nextTick(I,e,t),e._writableState.errorEmitted=!0,k(e,o)):(s(o),e._writableState.errorEmitted=!0,k(e,o),I(e,t))}(e,o,s,t,r);else{var a=P(o)||e.destroyed;a||o.corked||o.bufferProcessing||!o.bufferedRequest||S(e,o),s?i.nextTick(_,e,o,a,r):_(e,o,a,r)}}(n,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new o(this)}function A(t){var i=this instanceof(s=s||e("./_stream_duplex"));if(!i&&!r.call(A,this))return new A(t);this._writableState=new C(t,this,i),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),l.call(this)}function R(e,t,i,n,o,s,r){t.writelen=n,t.writecb=r,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new m("write")):i?e._writev(o,t.onwrite):e._write(o,s,t.onwrite),t.sync=!1}function _(e,t,i,n){var o,s;i||(o=e,0===(s=t).length&&s.needDrain&&(s.needDrain=!1,o.emit("drain"))),t.pendingcb--,n(),I(e,t)}function S(e,t){t.bufferProcessing=!0;var i=t.bufferedRequest;if(e._writev&&i&&i.next){var n=t.bufferedRequestCount,s=new Array(n),r=t.corkedRequestsFree;r.entry=i;for(var a=0,l=!0;i;)s[a]=i,i.isBuf||(l=!1),i=i.next,a+=1;s.allBuffers=l,R(e,t,!0,t.length,s,"",r.finish),t.pendingcb++,t.lastBufferedRequest=null,r.next?(t.corkedRequestsFree=r.next,r.next=null):t.corkedRequestsFree=new o(t),t.bufferedRequestCount=0}else{for(;i;){var c=i.chunk,h=i.encoding,d=i.callback;if(R(e,t,!1,t.objectMode?1:c.length,c,h,d),i=i.next,t.bufferedRequestCount--,t.writing)break}null===i&&(t.lastBufferedRequest=null)}t.bufferedRequest=i,t.bufferProcessing=!1}function P(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function E(e,t){e._final((function(i){t.pendingcb--,i&&k(e,i),t.prefinished=!0,e.emit("prefinish"),I(e,t)}))}function I(e,t){var n,o,s=P(t);if(s&&(n=e,(o=t).prefinished||o.finalCalled||("function"!=typeof n._final||o.destroyed?(o.prefinished=!0,n.emit("prefinish")):(o.pendingcb++,o.finalCalled=!0,i.nextTick(E,n,o))),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var r=e._readableState;(!r||r.autoDestroy&&r.endEmitted)&&e.destroy()}return s}e("inherits")(A,l),C.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(C.prototype,"buffer",{get:a.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(r=Function.prototype[Symbol.hasInstance],Object.defineProperty(A,Symbol.hasInstance,{value:function(e){return!!r.call(this,e)||this===A&&e&&e._writableState instanceof C}})):r=function(e){return e instanceof this},A.prototype.pipe=function(){k(this,new y)},A.prototype.write=function(e,t,n){var o,s,r=this._writableState,a=!1,l=!r.objectMode&&(o=e,c.isBuffer(o)||o instanceof h);return l&&!c.isBuffer(e)&&(s=e,e=c.from(s)),"function"==typeof t&&(n=t,t=null),l?t="buffer":t||(t=r.defaultEncoding),"function"!=typeof n&&(n=T),r.ending?function(e,t){var n=new b;k(e,n),i.nextTick(t,n)}(this,n):(l||function(e,t,n,o){var s;return null===n?s=new w:"string"==typeof n||t.objectMode||(s=new f("chunk",["string","Buffer"],n)),!s||(k(e,s),i.nextTick(o,s),!1)}(this,r,e,n))&&(r.pendingcb++,a=function(e,t,i,n,o,s){if(!i){var r=(l=n,h=o,(a=t).objectMode||!1===a.decodeStrings||"string"!=typeof l||(l=c.from(l,h)),l);n!==r&&(i=!0,o="buffer",n=r)}var a,l,h,d=t.objectMode?1:n.length;t.length+=d;var u=t.length<t.highWaterMark;if(u||(t.needDrain=!0),t.writing||t.corked){var p=t.lastBufferedRequest;t.lastBufferedRequest={chunk:n,encoding:o,isBuf:i,callback:s,next:null},p?p.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else R(e,t,!1,d,n,o,s);return u}(this,r,l,e,t,n)),a},A.prototype.cork=function(){this._writableState.corked++},A.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||S(this,e))},A.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new x(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(A.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(A.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),A.prototype._write=function(e,t,i){i(new v("_write()"))},A.prototype._writev=null,A.prototype.end=function(e,t,n){var o,s,r,a=this._writableState;return"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e&&this.write(e,t),a.corked&&(a.corked=1,this.uncork()),a.ending||(o=this,r=n,(s=a).ending=!0,I(o,s),r&&(s.finished?i.nextTick(r):o.once("finish",r)),s.ended=!0,o.writable=!1),this},Object.defineProperty(A.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(A.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),A.prototype.destroy=d.destroy,A.prototype._undestroy=d.undestroy,A.prototype._destroy=function(e,t){t(e)}}).call(this)}).call(this,e("_process"),void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/destroy":63,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,inherits:24,"util-deprecate":78}],61:[function(e,t,i){(function(i){(function(){var n;function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var s=e("./end-of-stream"),r=Symbol("lastResolve"),a=Symbol("lastReject"),l=Symbol("error"),c=Symbol("ended"),h=Symbol("lastPromise"),d=Symbol("handlePromise"),u=Symbol("stream");function p(e,t){return{value:e,done:t}}function f(e){var t=e[r];if(null!==t){var i=e[u].read();null!==i&&(e[h]=null,e[r]=null,e[a]=null,t(p(i,!1)))}}var v=Object.getPrototypeOf((function(){})),g=Object.setPrototypeOf((o(n={get stream(){return this[u]},next:function(){var e=this,t=this[l];if(null!==t)return Promise.reject(t);if(this[c])return Promise.resolve(p(void 0,!0));if(this[u].destroyed)return new Promise((function(t,n){i.nextTick((function(){e[l]?n(e[l]):t(p(void 0,!0))}))}));var n,o,s,r=this[h];if(r)n=new Promise((o=r,s=this,function(e,t){o.then((function(){s[c]?e(p(void 0,!0)):s[d](e,t)}),t)}));else{var a=this[u].read();if(null!==a)return Promise.resolve(p(a,!1));n=new Promise(this[d])}return this[h]=n,n}},Symbol.asyncIterator,(function(){return this})),o(n,"return",(function(){var e=this;return new Promise((function(t,i){e[u].destroy(null,(function(e){e?i(e):t(p(void 0,!0))}))}))})),n),v);t.exports=function(e){var t,n=Object.create(g,(o(t={},u,{value:e,writable:!0}),o(t,r,{value:null,writable:!0}),o(t,a,{value:null,writable:!0}),o(t,l,{value:null,writable:!0}),o(t,c,{value:e._readableState.endEmitted,writable:!0}),o(t,d,{value:function(e,t){var i=n[u].read();i?(n[h]=null,n[r]=null,n[a]=null,e(p(i,!1))):(n[r]=e,n[a]=t)},writable:!0}),t));return n[h]=null,s(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=n[a];return null!==t&&(n[h]=null,n[r]=null,n[a]=null,t(e)),void(n[l]=e)}var i=n[r];null!==i&&(n[h]=null,n[r]=null,n[a]=null,i(p(void 0,!0))),n[c]=!0})),e.on("readable",function(e){i.nextTick(f,e)}.bind(null,n)),n}}).call(this)}).call(this,e("_process"))},{"./end-of-stream":64,_process:50}],62:[function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function s(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var r=e("buffer").Buffer,a=e("util").inspect,l=a&&a.custom||"inspect";t.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.head=null,this.tail=null,this.length=0}var t;return(t=[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,i=""+t.data;t=t.next;)i+=e+t.data;return i}},{key:"concat",value:function(e){if(0===this.length)return r.alloc(0);for(var t,i,n,o=r.allocUnsafe(e>>>0),s=this.head,a=0;s;)t=s.data,i=o,n=a,r.prototype.copy.call(t,i,n),a+=s.data.length,s=s.next;return o}},{key:"consume",value:function(e,t){var i;return e<this.head.data.length?(i=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):i=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),i}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,i=1,n=t.data;for(e-=n.length;t=t.next;){var o=t.data,s=e>o.length?o.length:e;if(s===o.length?n+=o:n+=o.slice(0,e),0===(e-=s)){s===o.length?(++i,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=o.slice(s));break}++i}return this.length-=i,n}},{key:"_getBuffer",value:function(e){var t=r.allocUnsafe(e),i=this.head,n=1;for(i.data.copy(t),e-=i.data.length;i=i.next;){var o=i.data,s=e>o.length?o.length:e;if(o.copy(t,t.length-e,0,s),0===(e-=s)){s===o.length?(++n,i.next?this.head=i.next:this.head=this.tail=null):(this.head=i,i.data=o.slice(s));break}++n}return this.length-=n,t}},{key:l,value:function(e,t){return a(this,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){o(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t,{depth:0,customInspect:!1}))}}])&&s(e.prototype,t),e}()},{buffer:17,util:16}],63:[function(e,t,i){(function(e){(function(){function i(e,t){o(e,t),n(e)}function n(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function o(e,t){e.emit("error",t)}t.exports={destroy:function(t,s){var r=this,a=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return a||l?(s?s(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,e.nextTick(o,this,t)):e.nextTick(o,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!s&&t?r._writableState?r._writableState.errorEmitted?e.nextTick(n,r):(r._writableState.errorEmitted=!0,e.nextTick(i,r,t)):e.nextTick(i,r,t):s?(e.nextTick(n,r),s(t)):e.nextTick(n,r)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(e,t){var i=e._readableState,n=e._writableState;i&&i.autoDestroy||n&&n.autoDestroy?e.destroy(t):e.emit("error",t)}}}).call(this)}).call(this,e("_process"))},{_process:50}],64:[function(e,t,i){var n=e("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function o(){}t.exports=function e(t,i,s){if("function"==typeof i)return e(t,null,i);var r,a;i||(i={}),r=s||o,a=!1,s=function(){if(!a){a=!0;for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];r.apply(this,t)}};var l=i.readable||!1!==i.readable&&t.readable,c=i.writable||!1!==i.writable&&t.writable,h=function(){t.writable||u()},d=t._writableState&&t._writableState.finished,u=function(){c=!1,d=!0,l||s.call(t)},p=t._readableState&&t._readableState.endEmitted,f=function(){l=!1,p=!0,c||s.call(t)},v=function(e){s.call(t,e)},g=function(){var e;return l&&!p?(t._readableState&&t._readableState.ended||(e=new n),s.call(t,e)):c&&!d?(t._writableState&&t._writableState.ended||(e=new n),s.call(t,e)):void 0},y=function(){t.req.on("finish",u)};return function(e){return e.setHeader&&"function"==typeof e.abort}(t)?(t.on("complete",u),t.on("abort",g),t.req?y():t.on("request",y)):c&&!t._writableState&&(t.on("end",h),t.on("close",h)),t.on("end",f),t.on("finish",u),!1!==i.error&&t.on("error",v),t.on("close",g),function(){t.removeListener("complete",u),t.removeListener("abort",g),t.removeListener("request",y),t.req&&t.req.removeListener("finish",u),t.removeListener("end",h),t.removeListener("close",h),t.removeListener("finish",u),t.removeListener("end",f),t.removeListener("error",v),t.removeListener("close",g)}}},{"../../../errors":55}],65:[function(e,t,i){t.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],66:[function(e,t,i){var n,o=e("../../../errors").codes,s=o.ERR_MISSING_ARGS,r=o.ERR_STREAM_DESTROYED;function a(e){if(e)throw e}function l(e){e()}function c(e,t){return e.pipe(t)}t.exports=function(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];var h,d,u=(d=i).length?"function"!=typeof d[d.length-1]?a:d.pop():a;if(Array.isArray(i[0])&&(i=i[0]),i.length<2)throw new s("streams");var p=i.map((function(t,o){var s=o<i.length-1;return function(t,i,o,s){s=function(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}(s);var a=!1;t.on("close",(function(){a=!0})),void 0===n&&(n=e("./end-of-stream")),n(t,{readable:i,writable:o},(function(e){if(e)return s(e);a=!0,s()}));var l=!1;return function(e){if(!a&&!l)return l=!0,(i=t).setHeader&&"function"==typeof i.abort?t.abort():"function"==typeof t.destroy?t.destroy():void s(e||new r("pipe"));var i}}(t,s,o>0,(function(e){h||(h=e),e&&p.forEach(l),s||(p.forEach(l),u(h))}))}));return i.reduce(c)}},{"../../../errors":55,"./end-of-stream":64}],67:[function(e,t,i){var n=e("../../../errors").codes.ERR_INVALID_OPT_VALUE;t.exports={getHighWaterMark:function(e,t,i,o){var s,r,a,l=(r=o,a=i,null!=(s=t).highWaterMark?s.highWaterMark:r?s[a]:null);if(null!=l){if(!isFinite(l)||Math.floor(l)!==l||l<0)throw new n(o?i:"highWaterMark",l);return Math.floor(l)}return e.objectMode?16:16384}}},{"../../../errors":55}],68:[function(e,t,i){t.exports=e("events").EventEmitter},{events:22}],69:[function(e,t,i){(i=t.exports=e("./lib/_stream_readable.js")).Stream=i,i.Readable=i,i.Writable=e("./lib/_stream_writable.js"),i.Duplex=e("./lib/_stream_duplex.js"),i.Transform=e("./lib/_stream_transform.js"),i.PassThrough=e("./lib/_stream_passthrough.js"),i.finished=e("./lib/internal/streams/end-of-stream.js"),i.pipeline=e("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":56,"./lib/_stream_passthrough.js":57,"./lib/_stream_readable.js":58,"./lib/_stream_transform.js":59,"./lib/_stream_writable.js":60,"./lib/internal/streams/end-of-stream.js":64,"./lib/internal/streams/pipeline.js":66}],70:[function(e,t,i){t.exports=function(){if("function"!=typeof arguments[0])throw new Error("callback needed");if("number"!=typeof arguments[1])throw new Error("interval needed");var e;if(arguments.length>0){e=new Array(arguments.length-2);for(var t=0;t<e.length;t++)e[t]=arguments[t+2]}return new function(e,t,i){var n=this;this._callback=e,this._args=i,this._interval=setInterval(e,t,this._args),this.reschedule=function(e){e||(e=n._interval),n._interval&&clearInterval(n._interval),n._interval=setInterval(n._callback,e,n._args)},this.clear=function(){n._interval&&(clearInterval(n._interval),n._interval=void 0)},this.destroy=function(){n._interval&&clearInterval(n._interval),n._callback=void 0,n._interval=void 0,n._args=void 0}}(arguments[0],arguments[1],e)}},{}],71:[function(e,t,i){t.exports=e("./index.js")()},{"./index.js":72}],72:[function(e,t,i){(function(e){(function(){function i(t){return t instanceof e?e.from(t):new t.constructor(t.buffer.slice(),t.byteOffset,t.length)}t.exports=function(e){return(e=e||{}).circles?function(e){var t=[],n=[];return e.proto?function e(s){if("object"!=typeof s||null===s)return s;if(s instanceof Date)return new Date(s);if(Array.isArray(s))return o(s,e);if(s instanceof Map)return new Map(o(Array.from(s),e));if(s instanceof Set)return new Set(o(Array.from(s),e));var r={};for(var a in t.push(s),n.push(r),s){var l=s[a];if("object"!=typeof l||null===l)r[a]=l;else if(l instanceof Date)r[a]=new Date(l);else if(l instanceof Map)r[a]=new Map(o(Array.from(l),e));else if(l instanceof Set)r[a]=new Set(o(Array.from(l),e));else if(ArrayBuffer.isView(l))r[a]=i(l);else{var c=t.indexOf(l);r[a]=-1!==c?n[c]:e(l)}}return t.pop(),n.pop(),r}:function e(s){if("object"!=typeof s||null===s)return s;if(s instanceof Date)return new Date(s);if(Array.isArray(s))return o(s,e);if(s instanceof Map)return new Map(o(Array.from(s),e));if(s instanceof Set)return new Set(o(Array.from(s),e));var r={};for(var a in t.push(s),n.push(r),s)if(!1!==Object.hasOwnProperty.call(s,a)){var l=s[a];if("object"!=typeof l||null===l)r[a]=l;else if(l instanceof Date)r[a]=new Date(l);else if(l instanceof Map)r[a]=new Map(o(Array.from(l),e));else if(l instanceof Set)r[a]=new Set(o(Array.from(l),e));else if(ArrayBuffer.isView(l))r[a]=i(l);else{var c=t.indexOf(l);r[a]=-1!==c?n[c]:e(l)}}return t.pop(),n.pop(),r};function o(e,o){for(var s=Object.keys(e),r=new Array(s.length),a=0;a<s.length;a++){var l=s[a],c=e[l];if("object"!=typeof c||null===c)r[l]=c;else if(c instanceof Date)r[l]=new Date(c);else if(ArrayBuffer.isView(c))r[l]=i(c);else{var h=t.indexOf(c);r[l]=-1!==h?n[h]:o(c)}}return r}}(e):e.proto?function e(n){if("object"!=typeof n||null===n)return n;if(n instanceof Date)return new Date(n);if(Array.isArray(n))return t(n,e);if(n instanceof Map)return new Map(t(Array.from(n),e));if(n instanceof Set)return new Set(t(Array.from(n),e));var o={};for(var s in n){var r=n[s];"object"!=typeof r||null===r?o[s]=r:r instanceof Date?o[s]=new Date(r):r instanceof Map?o[s]=new Map(t(Array.from(r),e)):r instanceof Set?o[s]=new Set(t(Array.from(r),e)):ArrayBuffer.isView(r)?o[s]=i(r):o[s]=e(r)}return o}:function e(n){if("object"!=typeof n||null===n)return n;if(n instanceof Date)return new Date(n);if(Array.isArray(n))return t(n,e);if(n instanceof Map)return new Map(t(Array.from(n),e));if(n instanceof Set)return new Set(t(Array.from(n),e));var o={};for(var s in n)if(!1!==Object.hasOwnProperty.call(n,s)){var r=n[s];"object"!=typeof r||null===r?o[s]=r:r instanceof Date?o[s]=new Date(r):r instanceof Map?o[s]=new Map(t(Array.from(r),e)):r instanceof Set?o[s]=new Set(t(Array.from(r),e)):ArrayBuffer.isView(r)?o[s]=i(r):o[s]=e(r)}return o};function t(e,t){for(var n=Object.keys(e),o=new Array(n.length),s=0;s<n.length;s++){var r=n[s],a=e[r];"object"!=typeof a||null===a?o[r]=a:a instanceof Date?o[r]=new Date(a):ArrayBuffer.isView(a)?o[r]=i(a):o[r]=t(a)}return o}}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:17}],73:[function(e,t,i){var n=e("buffer"),o=n.Buffer;function s(e,t){for(var i in e)t[i]=e[i]}function r(e,t,i){return o(e,t,i)}o.from&&o.alloc&&o.allocUnsafe&&o.allocUnsafeSlow?t.exports=n:(s(n,i),i.Buffer=r),r.prototype=Object.create(o.prototype),s(o,r),r.from=function(e,t,i){if("number"==typeof e)throw new TypeError("Argument must not be a number");return o(e,t,i)},r.alloc=function(e,t,i){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=o(e);return void 0!==t?"string"==typeof i?n.fill(t,i):n.fill(t):n.fill(0),n},r.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return o(e)},r.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:17}],74:[function(e,t,i){t.exports=function(e){var t,i=e._readableState;return i?i.objectMode||"number"==typeof e._duplexState?e.read():e.read((t=i).buffer.length?t.buffer.head?t.buffer.head.data.length:t.buffer[0].length:t.length):null}},{}],75:[function(e,t,i){var n=e("safe-buffer").Buffer,o=n.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function s(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(n.isEncoding===o||!o(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=l,this.end=c,t=4;break;case"utf8":this.fillLast=a,t=4;break;case"base64":this.text=h,this.end=d,t=3;break;default:return this.write=u,void(this.end=p)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(t)}function r(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function a(e){var t=this.lastTotal-this.lastNeed,i=function(e,t){if(128!=(192&t[0]))return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"�"}}(this,e);return void 0!==i?i:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function l(e,t){if((e.length-t)%2==0){var i=e.toString("utf16le",t);if(i){var n=i.charCodeAt(i.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],i.slice(0,-1)}return i}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function c(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var i=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,i)}return t}function h(e,t){var i=(e.length-t)%3;return 0===i?e.toString("base64",t):(this.lastNeed=3-i,this.lastTotal=3,1===i?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-i))}function d(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function u(e){return e.toString(this.encoding)}function p(e){return e&&e.length?this.write(e):""}i.StringDecoder=s,s.prototype.write=function(e){if(0===e.length)return"";var t,i;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<e.length?t?t+this.text(e,i):this.text(e,i):t||""},s.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t},s.prototype.text=function(e,t){var i=function(e,t,i){var n=t.length-1;if(n<i)return 0;var o=r(t[n]);return o>=0?(o>0&&(e.lastNeed=o-1),o):--n<i||-2===o?0:(o=r(t[n]))>=0?(o>0&&(e.lastNeed=o-2),o):--n<i||-2===o?0:(o=r(t[n]))>=0?(o>0&&(2===o?o=0:e.lastNeed=o-3),o):0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=i;var n=e.length-(i-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)},s.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},{"safe-buffer":73}],76:[function(e,t,i){var n=e("punycode"),o=e("./util");function s(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}i.parse=w,i.resolve=function(e,t){return w(e,!1,!0).resolve(t)},i.resolveObject=function(e,t){return e?w(e,!1,!0).resolveObject(t):t},i.format=function(e){return o.isString(e)&&(e=w(e)),e instanceof s?e.format():s.prototype.format.call(e)},i.Url=s;var r=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,l=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),h=["'"].concat(c),d=["%","/","?",";","#"].concat(h),u=["/","?","#"],p=/^[+a-z0-9A-Z_-]{0,63}$/,f=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,v={javascript:!0,"javascript:":!0},g={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},m=e("querystring");function w(e,t,i){if(e&&o.isObject(e)&&e instanceof s)return e;var n=new s;return n.parse(e,t,i),n}s.prototype.parse=function(e,t,i){if(!o.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var s=e.indexOf("?"),a=-1!==s&&s<e.indexOf("#")?"?":"#",c=e.split(a);c[0]=c[0].replace(/\\/g,"/");var w=e=c.join(a);if(w=w.trim(),!i&&1===e.split("#").length){var b=l.exec(w);if(b)return this.path=w,this.href=w,this.pathname=b[1],b[2]?(this.search=b[2],this.query=t?m.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var x=r.exec(w);if(x){var k=(x=x[0]).toLowerCase();this.protocol=k,w=w.substr(x.length)}if(i||x||w.match(/^\/\/[^@\/]+@[^@\/]+/)){var T="//"===w.substr(0,2);!T||x&&g[x]||(w=w.substr(2),this.slashes=!0)}if(!g[x]&&(T||x&&!y[x])){for(var C,A,R=-1,_=0;_<u.length;_++)-1!==(S=w.indexOf(u[_]))&&(-1===R||S<R)&&(R=S);for(-1!==(A=-1===R?w.lastIndexOf("@"):w.lastIndexOf("@",R))&&(C=w.slice(0,A),w=w.slice(A+1),this.auth=decodeURIComponent(C)),R=-1,_=0;_<d.length;_++){var S;-1!==(S=w.indexOf(d[_]))&&(-1===R||S<R)&&(R=S)}-1===R&&(R=w.length),this.host=w.slice(0,R),w=w.slice(R),this.parseHost(),this.hostname=this.hostname||"";var P="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!P)for(var E=this.hostname.split(/\./),I=(_=0,E.length);_<I;_++){var L=E[_];if(L&&!L.match(p)){for(var M="",D=0,F=L.length;D<F;D++)L.charCodeAt(D)>127?M+="x":M+=L[D];if(!M.match(p)){var O=E.slice(0,_),B=E.slice(_+1),N=L.match(f);N&&(O.push(N[1]),B.unshift(N[2])),B.length&&(w="/"+B.join(".")+w),this.hostname=O.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),P||(this.hostname=n.toASCII(this.hostname));var z=this.port?":"+this.port:"",H=this.hostname||"";this.host=H+z,this.href+=this.host,P&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==w[0]&&(w="/"+w))}if(!v[k])for(_=0,I=h.length;_<I;_++){var j=h[_];if(-1!==w.indexOf(j)){var W=encodeURIComponent(j);W===j&&(W=escape(j)),w=w.split(j).join(W)}}var V=w.indexOf("#");-1!==V&&(this.hash=w.substr(V),w=w.slice(0,V));var U=w.indexOf("?");if(-1!==U?(this.search=w.substr(U),this.query=w.substr(U+1),t&&(this.query=m.parse(this.query)),w=w.slice(0,U)):t&&(this.search="",this.query={}),w&&(this.pathname=w),y[k]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){z=this.pathname||"";var q=this.search||"";this.path=z+q}return this.href=this.format(),this},s.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",i=this.pathname||"",n=this.hash||"",s=!1,r="";this.host?s=e+this.host:this.hostname&&(s=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(s+=":"+this.port)),this.query&&o.isObject(this.query)&&Object.keys(this.query).length&&(r=m.stringify(this.query));var a=this.search||r&&"?"+r||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||y[t])&&!1!==s?(s="//"+(s||""),i&&"/"!==i.charAt(0)&&(i="/"+i)):s||(s=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),t+s+(i=i.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+n},s.prototype.resolve=function(e){return this.resolveObject(w(e,!1,!0)).format()},s.prototype.resolveObject=function(e){if(o.isString(e)){var t=new s;t.parse(e,!1,!0),e=t}for(var i=new s,n=Object.keys(this),r=0;r<n.length;r++){var a=n[r];i[a]=this[a]}if(i.hash=e.hash,""===e.href)return i.href=i.format(),i;if(e.slashes&&!e.protocol){for(var l=Object.keys(e),c=0;c<l.length;c++){var h=l[c];"protocol"!==h&&(i[h]=e[h])}return y[i.protocol]&&i.hostname&&!i.pathname&&(i.path=i.pathname="/"),i.href=i.format(),i}if(e.protocol&&e.protocol!==i.protocol){if(!y[e.protocol]){for(var d=Object.keys(e),u=0;u<d.length;u++){var p=d[u];i[p]=e[p]}return i.href=i.format(),i}if(i.protocol=e.protocol,e.host||g[e.protocol])i.pathname=e.pathname;else{for(var f=(e.pathname||"").split("/");f.length&&!(e.host=f.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==f[0]&&f.unshift(""),f.length<2&&f.unshift(""),i.pathname=f.join("/")}if(i.search=e.search,i.query=e.query,i.host=e.host||"",i.auth=e.auth,i.hostname=e.hostname||e.host,i.port=e.port,i.pathname||i.search){var v=i.pathname||"",m=i.search||"";i.path=v+m}return i.slashes=i.slashes||e.slashes,i.href=i.format(),i}var w=i.pathname&&"/"===i.pathname.charAt(0),b=e.host||e.pathname&&"/"===e.pathname.charAt(0),x=b||w||i.host&&e.pathname,k=x,T=i.pathname&&i.pathname.split("/")||[],C=(f=e.pathname&&e.pathname.split("/")||[],i.protocol&&!y[i.protocol]);if(C&&(i.hostname="",i.port=null,i.host&&(""===T[0]?T[0]=i.host:T.unshift(i.host)),i.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===f[0]?f[0]=e.host:f.unshift(e.host)),e.host=null),x=x&&(""===f[0]||""===T[0])),b)i.host=e.host||""===e.host?e.host:i.host,i.hostname=e.hostname||""===e.hostname?e.hostname:i.hostname,i.search=e.search,i.query=e.query,T=f;else if(f.length)T||(T=[]),T.pop(),T=T.concat(f),i.search=e.search,i.query=e.query;else if(!o.isNullOrUndefined(e.search))return C&&(i.hostname=i.host=T.shift(),(P=!!(i.host&&i.host.indexOf("@")>0)&&i.host.split("@"))&&(i.auth=P.shift(),i.host=i.hostname=P.shift())),i.search=e.search,i.query=e.query,o.isNull(i.pathname)&&o.isNull(i.search)||(i.path=(i.pathname?i.pathname:"")+(i.search?i.search:"")),i.href=i.format(),i;if(!T.length)return i.pathname=null,i.search?i.path="/"+i.search:i.path=null,i.href=i.format(),i;for(var A=T.slice(-1)[0],R=(i.host||e.host||T.length>1)&&("."===A||".."===A)||""===A,_=0,S=T.length;S>=0;S--)"."===(A=T[S])?T.splice(S,1):".."===A?(T.splice(S,1),_++):_&&(T.splice(S,1),_--);if(!x&&!k)for(;_--;_)T.unshift("..");!x||""===T[0]||T[0]&&"/"===T[0].charAt(0)||T.unshift(""),R&&"/"!==T.join("/").substr(-1)&&T.push("");var P,E=""===T[0]||T[0]&&"/"===T[0].charAt(0);return C&&(i.hostname=i.host=E?"":T.length?T.shift():"",(P=!!(i.host&&i.host.indexOf("@")>0)&&i.host.split("@"))&&(i.auth=P.shift(),i.host=i.hostname=P.shift())),(x=x||i.host&&T.length)&&!E&&T.unshift(""),T.length?i.pathname=T.join("/"):(i.pathname=null,i.path=null),o.isNull(i.pathname)&&o.isNull(i.search)||(i.path=(i.pathname?i.pathname:"")+(i.search?i.search:"")),i.auth=e.auth||i.auth,i.slashes=i.slashes||e.slashes,i.href=i.format(),i},s.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":77,punycode:51,querystring:54}],77:[function(e,t,i){t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}],78:[function(e,t,i){(function(e){(function(){function i(t){try{if(!e.localStorage)return!1}catch(n){return!1}var i=e.localStorage[t];return null!=i&&"true"===String(i).toLowerCase()}t.exports=function(e,t){if(i("noDeprecation"))return e;var n=!1;return function(){if(!n){if(i("throwDeprecation"))throw new Error(t);i("traceDeprecation"),n=!0}return e.apply(this,arguments)}}}).call(this)}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],79:[function(e,t,i){t.exports=function e(t,i){if(t&&i)return e(t)(i);if("function"!=typeof t)throw new TypeError("need wrapper function");return Object.keys(t).forEach((function(e){n[e]=t[e]})),n;function n(){for(var e=new Array(arguments.length),i=0;i<e.length;i++)e[i]=arguments[i];var n=t.apply(this,e),o=e[e.length-1];return"function"==typeof n&&n!==o&&Object.keys(o).forEach((function(e){n[e]=o[e]})),n}}},{}],80:[function(e,t,i){t.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},{}],81:[function(e,t,i){t.exports=function(){for(var e={},t=0;t<arguments.length;t++){var i=arguments[t];for(var o in i)n.call(i,o)&&(e[o]=i[o])}return e};var n=Object.prototype.hasOwnProperty},{}],82:[function(e,t,i){t.exports=function(e){e.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}},{}],83:[function(e,t,i){function n(e){var t=this;if(t instanceof n||(t=new n),t.tail=null,t.head=null,t.length=0,e&&"function"==typeof e.forEach)e.forEach((function(e){t.push(e)}));else if(arguments.length>0)for(var i=0,o=arguments.length;i<o;i++)t.push(arguments[i]);return t}function o(e,t,i){var n=t===e.head?new a(i,null,t,e):new a(i,t,t.next,e);return null===n.next&&(e.tail=n),null===n.prev&&(e.head=n),e.length++,n}function s(e,t){e.tail=new a(t,e.tail,null,e),e.head||(e.head=e.tail),e.length++}function r(e,t){e.head=new a(t,null,e.head,e),e.tail||(e.tail=e.head),e.length++}function a(e,t,i,n){if(!(this instanceof a))return new a(e,t,i,n);this.list=n,this.value=e,t?(t.next=this,this.prev=t):this.prev=null,i?(i.prev=this,this.next=i):this.next=null}t.exports=n,n.Node=a,n.create=n,n.prototype.removeNode=function(e){if(e.list!==this)throw new Error("removing node which does not belong to this list");var t=e.next,i=e.prev;return t&&(t.prev=i),i&&(i.next=t),e===this.head&&(this.head=t),e===this.tail&&(this.tail=i),e.list.length--,e.next=null,e.prev=null,e.list=null,t},n.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},n.prototype.pushNode=function(e){if(e!==this.tail){e.list&&e.list.removeNode(e);var t=this.tail;e.list=this,e.prev=t,t&&(t.next=e),this.tail=e,this.head||(this.head=e),this.length++}},n.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)s(this,arguments[e]);return this.length},n.prototype.unshift=function(){for(var e=0,t=arguments.length;e<t;e++)r(this,arguments[e]);return this.length},n.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},n.prototype.shift=function(){if(this.head){var e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}},n.prototype.forEach=function(e,t){t=t||this;for(var i=this.head,n=0;null!==i;n++)e.call(t,i.value,n,this),i=i.next},n.prototype.forEachReverse=function(e,t){t=t||this;for(var i=this.tail,n=this.length-1;null!==i;n--)e.call(t,i.value,n,this),i=i.prev},n.prototype.get=function(e){for(var t=0,i=this.head;null!==i&&t<e;t++)i=i.next;if(t===e&&null!==i)return i.value},n.prototype.getReverse=function(e){for(var t=0,i=this.tail;null!==i&&t<e;t++)i=i.prev;if(t===e&&null!==i)return i.value},n.prototype.map=function(e,t){t=t||this;for(var i=new n,o=this.head;null!==o;)i.push(e.call(t,o.value,this)),o=o.next;return i},n.prototype.mapReverse=function(e,t){t=t||this;for(var i=new n,o=this.tail;null!==o;)i.push(e.call(t,o.value,this)),o=o.prev;return i},n.prototype.reduce=function(e,t){var i,n=this.head;if(arguments.length>1)i=t;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");n=this.head.next,i=this.head.value}for(var o=0;null!==n;o++)i=e(i,n.value,o),n=n.next;return i},n.prototype.reduceReverse=function(e,t){var i,n=this.tail;if(arguments.length>1)i=t;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");n=this.tail.prev,i=this.tail.value}for(var o=this.length-1;null!==n;o--)i=e(i,n.value,o),n=n.prev;return i},n.prototype.toArray=function(){for(var e=new Array(this.length),t=0,i=this.head;null!==i;t++)e[t]=i.value,i=i.next;return e},n.prototype.toArrayReverse=function(){for(var e=new Array(this.length),t=0,i=this.tail;null!==i;t++)e[t]=i.value,i=i.prev;return e},n.prototype.slice=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var i=new n;if(t<e||t<0)return i;e<0&&(e=0),t>this.length&&(t=this.length);for(var o=0,s=this.head;null!==s&&o<e;o++)s=s.next;for(;null!==s&&o<t;o++,s=s.next)i.push(s.value);return i},n.prototype.sliceReverse=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var i=new n;if(t<e||t<0)return i;e<0&&(e=0),t>this.length&&(t=this.length);for(var o=this.length,s=this.tail;null!==s&&o>t;o--)s=s.prev;for(;null!==s&&o>e;o--,s=s.prev)i.push(s.value);return i},n.prototype.splice=function(e,t,...i){e>this.length&&(e=this.length-1),e<0&&(e=this.length+e);for(var n=0,s=this.head;null!==s&&n<e;n++)s=s.next;var r=[];for(n=0;s&&n<t;n++)r.push(s.value),s=this.removeNode(s);for(null===s&&(s=this.tail),s!==this.head&&s!==this.tail&&(s=s.prev),n=0;n<i.length;n++)s=o(this,s,i[n]);return r},n.prototype.reverse=function(){for(var e=this.head,t=this.tail,i=e;null!==i;i=i.prev){var n=i.prev;i.prev=i.next,i.next=n}return this.head=t,this.tail=e,this};try{e("./iterator.js")(n)}catch(l){}},{"./iterator.js":82}]},{},[12])(12);var mqtt_minExports=mqtt_min.exports;const status={success:{color:"#2ba471",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM7.5 10.59l3 3 6-6L17.91 9l-7.41 7.41L6.09 12l1.41-1.41z"></path></svg>'},info:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{color:"#e37318",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},error:{color:"#d54941",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},question:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zm-.17-11.11c.43-.53.97-.97 1.4-1.32A2 2 0 0012 7a2 2 0 00-1.89 1.33l-.33.95L7.9 8.6l.34-.94a4 4 0 116.24 4.47 7 7 0 00-1.1 1.01c-.27.34-.37.61-.37.85v1.25h-2V14c0-.87.39-1.57.83-2.11zM11 18.25v-2h2v2h-2z"></path></svg>'}},messageList={};class Message{constructor(e,t){let i;__publicField(this,"parentElement"),__publicField(this,"box"),__publicField(this,"icon"),__publicField(this,"text"),__publicField(this,"closeBtn"),__publicField(this,"duration"),__publicField(this,"content"),__publicField(this,"theme"),__publicField(this,"placement"),__publicField(this,"height"),__publicField(this,"id"),this.parentElement=e,this.box=document.createElement("div"),this.icon=document.createElement("div"),this.text=document.createElement("div"),this.box.className="meta2d-message",this.icon.className="icon",this.text.className="text",this.icon.innerHTML=status[t.theme||"info"].icon,this.text.innerHTML=t.content,this.box.appendChild(this.icon),this.box.appendChild(this.text),t.closeBtn&&(this.closeBtn=document.createElement("div"),this.closeBtn.className="close",this.closeBtn.innerHTML="x",this.closeBtn.onclick=()=>{this.close()},this.box.appendChild(this.closeBtn)),e.appendChild(this.box);for(let n=0;n<document.styleSheets.length;n++)"le5le.com/message"===document.styleSheets[n].title&&(i=document.styleSheets[n]);if(!i){let e=document.createElement("style");e.type="text/css",e.title="le5le.com/message",document.head.appendChild(e),e=document.createElement("style"),e.type="text/css",document.head.appendChild(e),i=e.sheet,i.insertRule(".meta2d-message{\n           position:absolute;\n           z-index:999;\n           transform: translateX(-50%); \n           padding:12px 16px;\n           max-width:400px;\n           background:#fff;\n           border-radius:6px;\n           box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);\n           display:flex;\n           animation: fadein .5s;}"),i.insertRule("\n        @keyframes fadein {\n          0% {\n              transform: translate(-50%, -100%);\n          }\n          100% {\n              transform: translate(-50%,0);\n          }\n      }"),i.insertRule(".meta2d-message .icon{width:20px;height:20px;}"),i.insertRule(".meta2d-message .text{color:rgba(0, 0, 0, 0.9);font-size:12px;margin-left:8px;line-height:20px;}"),i.insertRule(".meta2d-message .close{width:20px;height:20px;padding-left: 16px; cursor: pointer;}")}this.id=t.id||s8(),this.duration=t.duration??3e3,this.placement=t.placement||"top",this.theme=t.theme||"info",this.height=t.height}init(){messageList[this.id]=this,this.duration&&setTimeout((()=>{this.close()}),this.duration);let e=-1;Object.keys(messageList).forEach((t=>{var i;(null==(i=messageList[t])?void 0:i.placement)===this.placement&&e++})),this.setPosition(this.placement,e),this.icon.children[0].style.fill=status[this.theme].color}setPosition(e,t=0){switch(e){case"top":this.box.style.top=30+t*(this.height||60)+"px",this.box.style.left="50%";break;case"bottom":this.box.style.bottom=30+t*(this.height||60)+"px",this.box.style.left="50%";break;case"left":this.box.style.top=30+t*(this.height||60)+"px",this.box.style.left="30px";break;case"right":this.box.style.top=30+t*(this.height||60)+"px",this.box.style.right="30px"}}close(){Object.keys(messageList).forEach((e=>{var t;if((null==(t=messageList[e])?void 0:t.placement)===this.placement)switch(this.placement){case"top":case"left":case"right":messageList[e].box.style.top=parseInt(messageList[e].box.style.top)-60+"px";break;case"bottom":messageList[e].box.style.bottom=parseInt(messageList[e].box.style.bottom)-60+"px"}})),messageList[this.id]=null,delete messageList[this.id],this.box.remove()}}function connectJetLinks(e,t){if(e.jetLinksList.length){let i=t.url;i.startsWith("/")&&(i=("https:"===location.protocol?"wss://":"ws://")+window.location.host+i),e.jetLinksClient=new WebSocket(`${i}/${localStorage.getItem("X-Access-Token")||getCookie("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||""}`),e.jetLinksClient.onmessage=t=>{var i;const n=JSON.parse(t.data);if(n.payload)if(null==(i=n.payload)?void 0:i.properties){const t=[];for(let e in n.payload.properties)e.startsWith("_")||t.push({id:`${n.payload.headers.productId}#${n.payload.deviceId}#${e}`,value:n.payload.properties[e]});e.setDatas(t,{history:!1})}else n.topic.startsWith("/notifications")&&doWarning(e,n)},e.jetLinksClient.onopen=()=>{e.jetLinksList.forEach((t=>{e.jetLinksClient.send(JSON.stringify({type:"sub",topic:`/device${t.topic}/message/property/report`,parameter:{deviceId:t.deviceId,properties:t.properties,history:1},id:t.topic+"-"+s8()}))})),t.notification&&e.jetLinksClient.send(JSON.stringify({type:"sub",topic:"/notifications",id:"notification",parameter:{}}))}}}function doWarning(e,t){var i,n;let o=t.payload.topicName,s=t.payload.message,r=`<div style="padding:0px 12px 0px 0px;width:300px;">\n      <div style="display:flex;height: 20px;justify-content: space-between">\n        <div style="color: #000000d9;\n      font-size: 14px;\n      font-weight: 700;">${o}</div><div style="color: #00000073;">${getTime(t.payload.notifyTime)}</div>\n      </div>\n      <span>${s}</span>\n   </div>`;e.message({content:r,duration:0,closeBtn:!0,placement:"right",height:75}),(null==(i=t.payload.detail)?void 0:i.alarmConfigId)&&playMp3(e,null==(n=t.payload.detail)?void 0:n.alarmConfigId)}function getTime(e){const t=new Date(e);return t.getFullYear()+"-"+(t.getMonth()+1+"").padStart(2,"0")+"-"+(t.getDate()+"").padStart(2,"0")+" "+(t.getHours()+"").padStart(2,"0")+":"+(t.getMinutes()+"").padStart(2,"0")+":"+(t.getSeconds()+"").padStart(2,"0")}function closeJetLinks(e){e.jetLinksClient&&(e.jetLinksClient.close(),e.jetLinksClient=void 0)}function getSendData(e,t,i){const n=[];return i.list.forEach(((i,o)=>{var s,r;const a=i.params?e.findOne(i.params):t;n[o]={deviceId:a.deviceId,productId:a.productId,properties:{}};for(let t in i.value)if(void 0===i.value[t]||""===i.value[t]){const e=null==(s=a.realTimes)?void 0:s.find((e=>e.propertyId===t));e&&(n[o].properties[t]=a[e.key])}else if("string"==typeof i.value[t]&&(null==(r=i.value[t])?void 0:r.indexOf("${"))>-1){let s=i.value[t].match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));(null==s?void 0:s.length)&&(n[o].properties[t]=a[s[0]]??e.getDynamicParam(s[0]))}else n[o].properties[t]=i.value[t]})),n}async function sendJetLinksData(e,t){t.forEach((async t=>{let i=t.deviceId;if(i&&i.indexOf("${")>-1){let t=i.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));(null==t?void 0:t.length)&&(i=e.getDynamicParam(t[0])||i)}(await fetch(`/api/device-instance/${i}/property`,{headers:{"X-Access-Token":localStorage.getItem("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||"","Content-Type":"application/json"},method:"put",body:JSON.stringify(t.properties)})).ok?e.message({theme:"success",content:"下发成功"}):e.message({theme:"error",content:"下发失败"})}))}async function playMp3(e,t){const i=await fetch(`/api/alarm/config/${t}`,{headers:{"X-Access-Token":localStorage.getItem("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||"","Content-Type":"application/json"},method:"GET"});if(i.ok){let t=i.json();t.result.media&&createAudio(e,t.result.media,t.result.playTimes)}}function createAudio(e,t,i){if(e.store.globalAudio||(e.store.globalAudio=document.createElement("audio")),e.store.globalAudio.src=t,e.store.globalAudio.play(),-1===i)e.store.globalAudio.loop=!0;else{e.store.globalAudio.loop=!1;let t=0;e.store.globalAudio.onended=()=>{t++,t<i&&e.store.globalAudio.play()}}}globalThis.doWarning=doWarning,globalThis.createAudio=createAudio;class Meta2d{constructor(parent,opts={}){__publicField(this,"store"),__publicField(this,"canvas"),__publicField(this,"websocket"),__publicField(this,"mqttClient"),__publicField(this,"websockets"),__publicField(this,"mqttClients"),__publicField(this,"eventSources"),__publicField(this,"penPluginMap",new Map),__publicField(this,"socketFn"),__publicField(this,"events",{}),__publicField(this,"map"),__publicField(this,"mapTimer"),__publicField(this,"facePen",facePen),__publicField(this,"getWords",getWords),__publicField(this,"calcTextLines",calcTextLines),__publicField(this,"calcTextRect",calcTextRect),__publicField(this,"calcTextDrawRect",calcTextDrawRect),__publicField(this,"jetLinksList",[]),__publicField(this,"jetLinksClient"),__publicField(this,"register",register),__publicField(this,"registerCanvasDraw",registerCanvasDraw),__publicField(this,"registerAnchors",registerAnchors),__publicField(this,"registerLineAnimateDraws",((name,drawFunc)=>{drawFunc="string"==typeof drawFunc?drawFunc:drawFunc.toString(),this.store.data.lineAnimateDraws[name]=drawFunc,globalStore.lineAnimateDraws[name]=eval(drawFunc)})),__publicField(this,"websocketTimes",0),__publicField(this,"mqttTimes",0),__publicField(this,"httpTimer"),__publicField(this,"httpTimerList",[]),__publicField(this,"updateTimer"),__publicField(this,"updateTimerList",[]),__publicField(this,"sqlTimerList",[]),__publicField(this,"iotMqttClient"),__publicField(this,"iotTimer"),__publicField(this,"iotWebsocketClient"),__publicField(this,"onEvent",((e,t)=>{switch(e){case"add":t.forEach((e=>{var t;null==(t=e.onAdd)||t.call(e,e)})),this.onSizeUpdate();break;case"enter":t&&t.onMouseEnter&&t.onMouseEnter(t,this.canvas.mousePos),this.store.data.locked&&this.doEvent(t,e);break;case"leave":t&&t.onMouseLeave&&t.onMouseLeave(t,this.canvas.mousePos),this.store.data.locked&&this.doEvent(t,e);break;case"active":case"inactive":this.store.data.locked&&t.forEach((t=>{this.doEvent(t,e)}));break;case"click":if(this.store.data.locked&&t.pen&&!t.pen.disabled&&t.pen.switch&&(t.pen.checked=!t.pen.checked,t.pen.calculative.checked=t.pen.checked,t.pen.calculative.gradient=void 0,t.pen.calculative.radialGradient=void 0),t.pen&&t.pen.formId){const e=this.store.pens[t.pen.formId];"submit"===t.pen.formType?this.store.data.locked&&e&&!e.disabled&&this.doEvent(e,"submit"):"reset"===t.pen.formType&&(reset(t.pen),this.store.data.locked&&e&&!e.disabled&&this.doEvent(e,"reset"))}t.pen&&t.pen.onClick&&!t.pen.disabled&&t.pen.onClick(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"contextmenu":t.pen&&t.pen.onContextmenu&&!t.pen.disabled&&t.pen.onContextmenu(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"mousedown":t.pen&&t.pen.onMouseDown&&!t.pen.disabled&&t.pen.onMouseDown(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"mouseup":t.pen&&t.pen.onMouseUp&&!t.pen.disabled&&t.pen.onMouseUp(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"dblclick":this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"valueUpdate":t&&updateFormData(t,t.formValue),this.store.data.locked&&this.doEvent(t,e),this.canvas.tooltip.updateText(t);break;case"update":case"delete":case"translatePens":case"rotatePens":case"resizePens":this.onSizeUpdate();break;case"navigator":this.store.data.id,this.navigatorTo(t.params);break;case"input":this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,e);break;case"change":t.pen&&updateFormData(t.pen),t.pen?this.store.data.locked&&!t.pen.disabled&&this.doEvent(t.pen,e):this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,e)}this.doMessageEvent(e,t)})),__publicField(this,"doEvent",((e,t)=>{var i,n,o,s,r,a,l,c,h,d;if(!e)return;let u=!1,p=[];if(null==(i=e.events)||i.forEach(((i,n)=>{var o;if(i.actions&&i.actions.length){if(i.name===t){let t=!1;i.conditions&&i.conditions.length?"and"===i.conditionType?t=i.conditions.every((t=>this.judgeCondition(e,t.key,t))):"or"===i.conditionType&&(t=i.conditions.some((t=>this.judgeCondition(e,t.key,t)))):t=!0,t&&p.push(n)}}else if(u=!0,this.events[i.action]&&i.name===t){let t=!(null==(o=i.where)?void 0:o.type);if(i.where){const{fn:n,fnJs:o,comparison:r,key:a,value:l}=i.where;if(n)t=n(e,{meta2d:this});else if(o){try{i.where.fn=new Function("pen","context",o)}catch(s){}i.where.fn&&(t=i.where.fn(e,{meta2d:this}))}else{let i=e[a];switch(["x","y","width","height"].includes(a)&&(i=this.getPenRect(e)[a]),r){case">":t=i>+l;break;case">=":t=i>=+l;break;case"<":t=i<+l;break;case"<=":t=i<=+l;break;case"=":case"==":t=i==l;break;case"!=":t=i!=l;break;case"[)":t=valueInRange(+i,l);break;case"![)":t=!valueInRange(+i,l);break;case"[]":t=valueInArray(i,l);break;case"![]":t=!valueInArray(i,l)}}}t&&p.push(n)}})),u?null==(n=e.events)||n.forEach(((t,i)=>{p.includes(i)&&this.events[t.action](e,t)})):null==(o=e.events)||o.forEach((async(t,i)=>{if(p.includes(i)){if(t.confirm&&!(await this.canvas.popconfirm.showModal(e,this.canvas.mousePos,t.confirmTitle)))return;t.actions.forEach((t=>{if(t.timeout){let i=setTimeout((()=>{this.events[t.action]&&(this.events[t.action](e,t),clearTimeout(i),i=null)}),t.timeout)}else this.events[t.action]&&this.events[t.action](e,t)}))}})),"valueUpdate"===t){null==(s=e.realTimes)||s.forEach((t=>{var i,n;let o=[];null==(i=t.triggers)||i.forEach(((i,n)=>{var s;let r=!1;(null==(s=i.conditions)?void 0:s.length)?"and"===i.conditionType?r=i.conditions.every((i=>this.judgeCondition(e,t.key,i))):"or"===i.conditionType&&(r=i.conditions.some((i=>this.judgeCondition(e,t.key,i)))):r=!0,r&&o.push(n)})),null==(n=t.triggers)||n.forEach(((t,i)=>{var n;o.includes(i)&&(null==(n=t.actions)||n.forEach((t=>{if(t.timeout){let i=setTimeout((()=>{this.events[t.action]&&(this.events[t.action](e,t),clearTimeout(i),i=null)}),t.timeout)}else this.events[t.action](e,t)})))}))}));let t=[];if(null==(r=this.store.globalTriggers[e.id])||r.forEach(((e,i)=>{var n;let o=!1;(null==(n=e.conditions)?void 0:n.length)?"and"===e.conditionType?o=e.conditions.every((e=>this.judgeCondition(this.store.pens[e.source],e.key,e))):"or"===e.conditionType&&(o=e.conditions.some((e=>this.judgeCondition(this.store.pens[e.source],e.key,e)))):o=!0,o&&t.push(i)})),null==(a=this.store.globalTriggers[e.id])||a.forEach(((i,n)=>{var o;t.includes(n)&&(null==(o=i.actions)||o.forEach((t=>{if(t.timeout){let i=setTimeout((()=>{this.events[t.action]&&(this.events[t.action](e,t),clearTimeout(i),i=null)}),t.timeout)}else this.events[t.action](e,t)})))})),null==(l=e.triggers)?void 0:l.length)for(let i of e.triggers)if(null==(c=i.status)?void 0:c.length)for(let t of i.status){let i=!1;if((null==(h=t.conditions)?void 0:h.length)?"and"===t.conditionType?i=t.conditions.every((t=>this.judgeCondition(e,t.key,t))):"or"===t.conditionType&&(i=t.conditions.some((t=>this.judgeCondition(e,t.key,t)))):i=!0,i){null==(d=t.actions)||d.forEach((t=>{if(t.timeout){let i=setTimeout((()=>{this.events[t.action]&&(this.events[t.action](e,t),clearTimeout(i),i=null)}),t.timeout)}else this.events[t.action](e,t)}));break}}}this.doEvent(this.store.pens[e.parentId],t)})),__publicField(this,"doDataEvent",(e=>{var t,i,n;if(!(null==(t=this.store.data.dataEvents)?void 0:t.length))return;const o=e.reduce(((e,{dataId:t,id:i,value:n})=>(e[i||t]=n,e)),{});let s=[];null==(i=this.store.data.dataEvents)||i.forEach(((e,t)=>{let i=!1;e.conditions&&e.conditions.length?"and"===e.conditionType?i=e.conditions.every((e=>this.dataJudegeCondition(o,e.key,e))):"or"===e.conditionType&&(i=e.conditions.some((e=>this.dataJudegeCondition(o,e.key,e)))):i=!0,i&&s.push(t)})),null==(n=this.store.data.dataEvents)||n.forEach(((e,t)=>{var i;s.includes(t)&&(null==(i=e.actions)||i.forEach((e=>{this.events[e.action](o,e)})))}))})),__publicField(this,"renderPenRaw",renderPenRaw$1),__publicField(this,"setElemPosition",setElemPosition),__publicField(this,"setLifeCycleFunc",setLifeCycleFunc),this.store=useStore(s8()),this.setOptions(opts),this.setDatabyOptions(opts),this.init(parent),this.register(commonPens()),this.registerCanvasDraw({cube:cube}),this.registerAnchors(commonAnchors()),globalThis.meta2d=this,this.initEventFns(),this.store.emitter.on("*",this.onEvent)}get beforeAddPen(){return this.canvas.beforeAddPen}set beforeAddPen(e){this.canvas.beforeAddPen=e}get beforeAddPens(){return this.canvas.beforeAddPens}set beforeAddPens(e){this.canvas.beforeAddPens=e}get beforeAddAnchor(){return this.canvas.beforeAddAnchor}set beforeAddAnchor(e){this.canvas.beforeAddAnchor=e}get beforeRemovePens(){return this.canvas.beforeRemovePens}set beforeRemovePens(e){this.canvas.beforeRemovePens=e}get beforeRemoveAnchor(){return this.canvas.beforeRemoveAnchor}set beforeRemoveAnchor(e){this.canvas.beforeRemoveAnchor=e}setOptions(e={}){var t,i;void 0===e.grid&&void 0===e.gridColor&&void 0===e.gridSize||this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),void 0===e.rule&&void 0===e.ruleColor&&void 0===e.ruleOptions||(this.store.patchFlagsTop=!0,e.ruleOptions&&(null==(t=this.store.options)?void 0:t.ruleOptions)&&(Object.assign(this.store.options.ruleOptions,e.ruleOptions),e.ruleOptions=this.store.options.ruleOptions)),void 0!==e.background&&this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),void 0!==e.resizeMode&&(e.resizeMode||(this.canvas.hotkeyType=HotkeyType.None)),void 0===e.width&&void 0===e.height||(this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),this.canvas&&this.canvas.canvasTemplate.canvas.style.backgroundImage&&(this.canvas.canvasTemplate.canvas.style.backgroundImage="")),this.store.options=Object.assign(this.store.options,e),this.canvas&&void 0!==e.scroll&&(e.scroll?(!this.canvas.scroll&&(this.canvas.scroll=new Scroll(this.canvas)),this.canvas.scroll.show()):this.canvas.scroll&&this.canvas.scroll.hide()),null==(i=this.canvas)||i.initGlobalStyle()}getOptions(){return this.store.options}registerTheme(e,t){if(!Array.isArray(t))return;const i=/^\s*\S+\s*:\s*\S+\s*$/;if(!t.every((e=>i.test(e))))return;const n={},o=[];for(let s=0;s<t.length;s++){const e=t[s].split(":"),i=e[0].trim(),r=e[1].trim();o.push([i,r].join(":")),n[i]=r}le5leTheme.addTheme(e,o),this.store.theme[e]=n}setTheme(e){this.store.data.theme=e,this.setBackgroundColor(this.store.theme[e].background),this.canvas.parentElement.style.background=this.store.theme[e].parentBackground,this.store.data.color=this.store.theme[e].color,this.setOptions({ruleColor:this.store.theme[e].ruleColor,ruleOptions:this.store.theme[e].ruleOptions}),le5leTheme.updateCssRule(this.store.id,e),this.canvas.initGlobalStyle();for(let t=0;t<this.store.data.pens.length;t++){const e=this.store.data.pens[t];e.setTheme&&e.setTheme(e,this.store.styles)}this.render()}setDatabyOptions(e={}){const{color:t,activeColor:i,activeBackground:n,grid:o,gridColor:s,gridSize:r,fromArrow:a,toArrow:l,rule:c,ruleColor:h,textColor:d,x:u=0,y:p=0}=e;this.setRule({rule:c,ruleColor:h}),this.setGrid({grid:o,gridColor:s,gridSize:r}),this.store.data=Object.assign(this.store.data,{textColor:d,color:t,activeColor:i,activeBackground:n,fromArrow:a,toArrow:l,x:u,y:p})}init(e){this.canvas=new Canvas(this,"string"==typeof e?document.getElementById(e):e,this.store),this.canvas.initGlobalStyle(),this.resize(),this.canvas.listen(),le5leTheme.createThemeSheet(this.store.data.theme,this.store.id)}initEventFns(){this.events[EventAction.Link]=(e,t)=>{var i;if(window&&t.value&&"string"==typeof t.value){let n=t.value;if(n.includes("${")){let t=null==(i=n.match(/\$\{([^}]+)\}/g))?void 0:i.map((e=>e.slice(2,-1)));t&&(null==t||t.forEach((t=>{n=n.replace(`\${${t}}`,e[t])})))}window.open(n,t.params??"_blank")}else;},this.events[EventAction.SetProps]=(e,t)=>{var i,n,o;const s=t.value;if(s&&"object"==typeof s){const r=t.params?this.find(t.params):this.find(e.id),a={};for(let t in s)if(null==(i=s[t])?void 0:i.id)a[t]=null==(n=this.store.pens[s[t].id])?void 0:n[s[t].key];else if("string"==typeof s[t]&&s[t].includes("${")){let i=s[t],n=null==(o=i.match(/\$\{([^}]+)\}/g))?void 0:o.map((e=>e.slice(2,-1)));n&&n.forEach((t=>{i=i.replace(`\${${t}}`,e[t]||this.getDynamicParam(t))})),a[t]=i}else a[t]=s[t];return r.forEach((e=>{a.hasOwnProperty("visible")&&e.visible!==a.visible&&this.setVisible(e,a.visible),this.setValue({id:e.id,...a},{render:!1,doEvent:!1})})),void this.render()}},this.events[EventAction.StartAnimate]=(e,t)=>{let i=e;t.value&&(i=this.findOne(t.value)),this.store.animates.has(i)&&!i.calculative.pause&&i.animateName===t.params||(t.targetType&&t.params?this.startAnimate(t.value||[e],t.params):t.value&&"string"!=typeof t.value||this.startAnimate(t.value||[e]))},this.events[EventAction.PauseAnimate]=(e,t)=>{t.value&&"string"!=typeof t.value||this.pauseAnimate(t.value||[e])},this.events[EventAction.StopAnimate]=(e,t)=>{if(t.value&&"string"!=typeof t.value);else{if(t.value){let e=this.findOne(t.value);if(!this.store.animates.has(e))return}else if(!this.store.animates.has(e))return;this.stopAnimate(t.value||[e])}},this.events[EventAction.StartVideo]=(e,t)=>{t.value&&"string"!=typeof t.value||this.startVideo(t.value||[e])},this.events[EventAction.PauseVideo]=(e,t)=>{t.value&&"string"!=typeof t.value||this.pauseVideo(t.value||[e])},this.events[EventAction.StopVideo]=(e,t)=>{t.value&&"string"!=typeof t.value||this.stopVideo(t.value||[e])},this.events[EventAction.JS]=(e,t,i)=>{var n;if(t.value&&!t.fn)try{if("string"!=typeof t.value)throw new Error("[meta2d] Function value must be string");const e=t.value;t.fn=new Function("pen","params","context",e)}catch(o){}null==(n=t.fn)||n.call(t,e,i||t.params,{meta2d:this,eventName:t.name})},this.events[EventAction.GlobalFn]=(e,t)=>{"string"==typeof t.value&&globalThis[t.value]&&globalThis[t.value](e,t.params)},this.events[EventAction.Emit]=(e,t)=>{"string"==typeof t.value&&this.store.emitter.emit(t.value,{pen:e,params:t.params,eventName:t.name})},this.events[EventAction.SendPropData]=(e,t)=>{const i=deepClone(t.value);if(i&&"object"==typeof i){const n=t.params?this.findOne(t.params):e;for(let e in i)void 0!==i[e]&&""!==i[e]||(i[e]=n[e]);return i.id=n.id,void this.doSendDataEvent(i,t.extend)}},this.events[EventAction.SendVarData]=(e,t)=>{const i=deepClone(t.value);if(i&&"object"==typeof i){const n=t.params?this.findOne(t.params):e;let o=[];for(let e in i){let t={dataId:e,value:i[e]};if(!t.value){let e=n.form.find((e=>e.dataIds&&e.dataIds.dataId===t.dataId));e&&(t.value=n[e.key])}o.push(t)}this.doSendDataEvent(o,t.extend)}else;},this.events[EventAction.Navigator]=(e,t)=>{t.value&&"string"==typeof t.value&&this.navigatorTo(t.value)},this.events[EventAction.Dialog]=(e,t)=>{var i;if(t.params&&"string"==typeof t.params){let n=t.params;if(t.params.includes("${")){let o=null==(i=t.params.match(/\$\{([^}]+)\}/g))?void 0:i.map((e=>e.slice(2,-1)));o&&(null==o||o.forEach((t=>{n=n.replace(`\${${t}}`,e[t])})))}Object.keys(t.extend).forEach((e=>{["x","y","width","height"].includes(e)||(-1!==n.indexOf("?")?n+=`&${e}=${t.extend[e]}`:n+=`?${e}=${t.extend[e]}`)}));let o=this.getEventData(t.list,e);Object.keys(o).length&&(o=null),this.canvas.dialog.show(t.value,n,t.extend,o)}},this.events[EventAction.SendData]=(e,t)=>{var i,n,o,s;if(null==(i=t.data)?void 0:i.length){const i=this.getSendData(t.data);return e.formId&&e.formData&&Object.assign(i,e.formData),void this.sendDataToNetWork(i,e,t)}if(null==(n=t.list)?void 0:n.length){if(t.network&&"ADIIOT"===t.network.protocol){const i=getSendData(this,e,t);return void(i.length&&sendJetLinksData(this,i))}const i=this.getEventData(t.list,e);return e.deviceId&&(i.deviceId=e.deviceId),e.formId&&e.formData&&Object.assign(i,e.formData),void this.sendDataToNetWork(i,e,t)}const r=deepClone(t.value);if(r&&"object"==typeof r&&"id"===t.targetType){const i=t.params?this.findOne(t.params):e;for(let e in r)if(void 0===r[e]||""===r[e])r[e]=i[e];else if("string"==typeof r[e]&&(null==(o=r[e])?void 0:o.indexOf("${"))>-1){let t=null==(s=r[e].match(/\$\{([^}]+)\}/g))?void 0:s.map((e=>e.slice(2,-1)));(null==t?void 0:t.length)&&(r[e]=i[t[0]]??this.getDynamicParam(t[0]))}return i.deviceId&&(r.deviceId=i.deviceId),void this.sendDataToNetWork(r,e,t)}},this.events[EventAction.PostMessage]=(e,t)=>{if("string"!=typeof t.value)return;const i=t.params?this.findOne(t.params):e;if("iframe"!==i.name||!i.iframe)return;let n=queryURLParams(i.iframe.split("?")[1]);const o=this.getEventData(t.list,i);i.calculative.singleton.div.children[0].contentWindow.postMessage(JSON.stringify({name:t.value,id:n.id,data:o}),"*")},this.events[EventAction.PostMessageToParent]=(e,t)=>{if("string"!=typeof t.value)return;const i=this.getEventData(t.list,e);window.parent.postMessage(JSON.stringify({name:t.value,data:i}),"*")},this.events[EventAction.Message]=(e,t)=>{this.message({theme:t.params,content:t.value,...t.extend})}}getSendData(e){const t={};return e.forEach((e=>{var i;if(e.prop)if(e.id&&"固定值"!==e.id){const i=this.findOne(e.id);t[e.prop]=i[e.key]}else if("string"==typeof e.value&&e.value.includes("${")){let n=e.value,o=null==(i=n.match(/\$\{([^}]+)\}/g))?void 0:i.map((e=>e.slice(2,-1)));o&&o.forEach((e=>{n=n.replace(`\${${e}}`,this.getDynamicParam(e))})),t[e.prop]=n}else t[e.prop]=this.convertType(e.value,e.type)})),t}convertType(e,t){if("string"==typeof e)if(["switch","bool","boolean"].includes(t)){if("false"===e)return!1;if("true"===e)return!0}else if(["integer","number","int","enum","double","float"].includes(t)&&!isNaN(Number(e)))return Number(e);return e}getEventData(e,t){const i={};return(null==e?void 0:e.length)&&e.forEach((e=>{var n,o;const s=e.params?this.findOne(e.params):t;for(let t in e.value)if(void 0===e.value[t]||""===e.value[t])i[t]=s[t];else if("string"==typeof e.value[t]&&(null==(n=e.value[t])?void 0:n.indexOf("${"))>-1){let n=null==(o=e.value[t].match(/\$\{([^}]+)\}/g))?void 0:o.map((e=>e.slice(2,-1)));(null==n?void 0:n.length)&&(i[t]=s[n[0]]??this.getDynamicParam(n[0]))}else i[t]=e.value[t]})),Object.keys(i).length?i:{}}message(e){new Message(this.canvas.parentElement,e).init()}closeAll(){for(let e in messageList)messageList[e].close()}async navigatorTo(e){var t;if(!e)return;if(null==(t=queryURLParams())?void 0:t.id){const t=new URL(window.location);t.searchParams.set("id",e),history.pushState({},"",t)}const i=await getMeta2dData(this.store,e);i&&(this.open(i),this.lock(1),this.fitView(!0,10))}doSendDataEvent(e,t){let i=JSON.stringify(e);this.mqttClient&&this.mqttClient.connected&&(t?t.split(",").forEach((e=>{this.mqttClient.publish(e,i)})):this.store.data.mqttTopics&&this.store.data.mqttTopics.split(",").forEach((e=>{this.mqttClient.publish(e,i)}))),this.websocket&&1===this.websocket.readyState&&this.websocket.send(i),(this.store.data.https||this.store.data.http)&&this.sendDatabyHttp(i),this.store.emitter.emit("sendData",i)}async sendDataToNetWork(e,t,i){var n,o,s,r,a,l;const c=deepClone(i.network);if(c.data&&(Object.assign(c,c.data),delete c.data),"iot"!==c.protocol){if(c.url)if("http"===c.protocol){if("object"==typeof c.headers)for(let e in c.headers)if("string"==typeof c.headers[e]){let t=null==(o=c.headers[e].match(/\$\{([^}]+)\}/g))?void 0:o.map((e=>e.slice(2,-1)));t&&(c.headers[e]=c.headers[e].replace(`\${${t[0]}}`,this.getDynamicParam(t[0])))}let n,a=c.url;if("GET"===c.method&&(n="?"+Object.keys(e).map((t=>t+"="+e[t])).join("&")),"POST"===c.method&&a.indexOf("${")>-1){let e=null==(s=a.match(/\$\{([^}]+)\}/g))?void 0:s.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{a=a.replace(`\${${e}}`,getter(t,e)||this.getDynamicParam(e))}))}const l=await fetch(a+(n||""),{headers:c.headers||{},method:c.method,body:"POST"===c.method?JSON.stringify(e):void 0});if(l.ok&&i.callback){const e=await l.text();if(!i.fn)try{if("string"!=typeof i.callback)throw new Error("[meta2d] Function callback must be string");const e=i.callback;i.fn=new Function("pen","data","context",e)}catch(h){}null==(r=i.fn)||r.call(i,t,e,{meta2d:this,e:i})}}else if("mqtt"===c.protocol){const t=null==(a=this.mqttClients)?void 0:a.filter((e=>e.options.href===c.url));if(t&&t.length)t[0].connected&&c.topics.split(",").forEach((i=>{t[0].publish(i,JSON.stringify(e))}));else{let t=mqtt_minExports.connect(c.url,c.options);t.on("connect",(()=>{c.topics.split(",").forEach((i=>{t.publish(i,JSON.stringify(e)),setTimeout((()=>{null==t||t.end()}),1e3)}))}))}}else if("websocket"===c.protocol){const t=null==(l=this.websockets)?void 0:l.filter((e=>e.url===c.url));if(t&&t.length)1===t[0].readyState&&t[0].send(JSON.stringify(e));else{let t=new WebSocket(c.url,c.protocols||void 0);t.onopen=function(){t.send(JSON.stringify(e)),setTimeout((()=>{t.close()}),100)}}}}else this.iotMqttClient&&this.iotMqttClient.publish(`le5le-iot/property/set/${null==(n=this.store.data.iot)?void 0:n.token}`,JSON.stringify(e))}resize(e,t){this.canvas.resize(e,t),this.render(),this.store.emitter.emit("resize",{width:e,height:t}),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}async addPen(e,t,i=!0,n=!1){return await this.canvas.addPen(e,t,i,n)}async addPens(e,t,i=!1){return await this.canvas.addPens(e,t,i)}render(e){var t;null==(t=this.canvas)||t.render(e)}async setBackgroundImage(e,t){var i,n,o,s;let r=this;this.store.data.bkImage=e;const a=(null==t?void 0:t.width)||(null==(i=this.store.data)?void 0:i.width)||(null==(n=this.store.options)?void 0:n.width),l=(null==t?void 0:t.height)||(null==(o=this.store.data)?void 0:o.height)||(null==(s=this.store.options)?void 0:s.height);if(a&&l?(this.canvas.canvasTemplate.canvas.style.backgroundImage=null,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)):this.canvas.canvasTemplate.canvas.style.backgroundImage=e?`url('${e}')`:"",e){const t=await async function(e){return new Promise((t=>{const i=new Image;i.src=e,r.store.options.cdn&&!(e.startsWith("http")||e.startsWith("//")||e.startsWith("data:image"))&&(i.src=r.store.options.cdn+e),i.crossOrigin="anonymous",i.onload=()=>{t(i)}}))}(e);this.store.bkImg=t,a&&l&&this.canvas&&(this.canvas.canvasTemplate.init(),this.render())}else this.store.bkImg=null}setBackgroundColor(e=this.store.data.background){this.store.data.background=e,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setGrid({grid:e=this.store.data.grid,gridColor:t=this.store.data.gridColor,gridSize:i=this.store.data.gridSize,gridRotate:n=this.store.data.gridRotate}={}){this.store.data.grid=e,this.store.data.gridColor=t,this.store.data.gridSize=i<0?0:i,this.store.data.gridRotate=n,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setRule({rule:e=this.store.data.rule,ruleColor:t=this.store.data.ruleColor}={}){this.store.data.rule=e,this.store.data.ruleColor=t,this.store.patchFlagsTop=!0}open(e,t=!0){if(this.clear(!1,null==e?void 0:e.template),this.canvas.autoPolylineFlag=!0,e){e.theme&&this.setTheme(e.theme),this.setBackgroundImage(e.bkImage,e),Object.assign(this.store.data,e),this.store.data.pens=[];for(const t of e.pens)t.id||(t.id=s8()),!t.calculative&&(t.calculative={canvas:this.canvas}),this.store.pens[t.id]=t;for(const t of e.pens)this.canvas.makePen(t)}if(this.canvas.patchFlagsLines.forEach((e=>{e.type&&this.canvas.initLineRect(e)})),this.store.data.template||(this.store.data.template=s8()),t||(this.canvas.opening=!0),this.doInitJS(),this.initBindDatas(),this.initBinds(),this.doInitFn(),this.loadLineAnimateDraws(),this.initMessageEvents(),this.initGlobalTriggers(),this.startAnimate(),this.startVideo(),this.listenSocket(),this.connectSocket(),this.connectNetwork(),this.startDataMock(),this.canvas.initGlobalStyle(),this.render(),setTimeout((()=>{const e=this.store.data.pens.find((e=>e.autofocus));e&&this.focus(e.id)}),100),this.store.data.iconUrls)for(const i of this.store.data.iconUrls)loadCss(i,(()=>{this.render()}));this.canvas.autoPolylineFlag=!1,this.store.emitter.emit("opened"),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}cacheData(e){if(e&&this.store.options.cacheLength){let t=this.store.cacheDatas.findIndex((t=>t.data&&t.data._id===e));if(-1===t)this.store.cacheDatas.push({data:deepClone(this.store.data,!0)}),this.store.cacheDatas.length>this.store.options.cacheLength&&this.store.cacheDatas.shift();else{let e=this.store.cacheDatas.splice(t,1)[0];this.store.cacheDatas.push(e)}}}loadCacheData(e){let t=this.store.cacheDatas.findIndex((t=>t.data&&t.data._id===e));-1!==t&&(this.store.data=this.store.cacheDatas[t].data,this.setBackgroundImage(this.store.data.bkImage),this.store.pens={},this.store.data.pens.forEach((e=>{e.calculative.canvas=this.canvas,this.store.pens[e.id]=e,globalStore.path2dDraws[e.name]&&this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e)),e.type&&this.store.path2dMap.set(e,globalStore.path2dDraws[e.name](e)),e.image&&(e.calculative.imageDrawed=!1,this.canvas.loadImage(e))})),this.render())}loadLineAnimateDraws(){globalStore.lineAnimateDraws={},Object.entries(this.store.data.lineAnimateDraws).forEach((([key,drawFunc])=>{globalStore.lineAnimateDraws[key]=eval(drawFunc)}))}statistics(){const e=this.store.data.pens.length,t=this.store.data.pens.filter((e=>e.image)).length,i=this.store.data.pens.filter((e=>e.image&&e.calculative.inView)).length,n=this.store.data.pens.filter((e=>e.name.endsWith("Dom")||isDomShapes.includes(e.name)||this.store.options.domShapes.includes(e.name)||e.externElement)).length,o=this.store.animates.size;let s=0;return Object.keys(this.store.bind).forEach((e=>{s+=this.store.bind[e].length})),Object.keys(this.store.bindDatas).forEach((e=>{s+=this.store.bindDatas[e].length})),{"图元总数量":e,"图片图元数量":t,"图片图元绘制数量":i,"dom图元数量":n,"正在执行的动画数量":o,"数据点数量":s}}initBindDatas(){this.store.bindDatas={},this.store.data.pens.forEach((e=>{var t;null==(t=e.form)||t.forEach((t=>{let i;t.dataIds&&(i=Array.isArray(t.dataIds)?t.dataIds:[t.dataIds]),null==i||i.forEach((i=>{this.store.bindDatas[i.dataId]||(this.store.bindDatas[i.dataId]=[]),this.store.bindDatas[i.dataId].push({id:e.id,formItem:t})}))}))}))}initBinds(){this.jetLinksList=[],this.store.bind={};const e=[],t=[];this.store.data.pens.forEach((i=>{var n,o;null==(n=i.realTimes)||n.forEach((n=>{if(n.bind&&n.bind.id){let o=n.productId||i.productId,s=n.deviceId||i.deviceId,r=n.propertyId,a=!1;if(o&&o.indexOf("${")>-1){let e=o.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));(null==e?void 0:e.length)&&(o=this.getDynamicParam(e[0])||o),a=!0}if(s&&s.indexOf("${")>-1){let e=s.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));(null==e?void 0:e.length)&&(s=this.getDynamicParam(e[0])||s),a=!0}if(r&&r.indexOf("${")>-1){let e=r.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));(null==e?void 0:e.length)&&(r=this.getDynamicParam(e[0])||r),a=!0}if(a&&n.bind&&(n.bind.id=o+"#"+s+"#"+r),this.store.bind[n.bind.id]||(this.store.bind[n.bind.id]=[]),this.store.bind[n.bind.id].push({id:i.id,key:n.key}),o&&s&&r){const e=this.jetLinksList.findIndex((e=>e.topic.startsWith(`/${o}/${s}`)));if(e>-1){this.jetLinksList[e].properties.includes(n.propertyId)||this.jetLinksList[e].properties.push(n.propertyId)}else this.jetLinksList.push({topic:`/${o}/${s}`,deviceId:s,properties:[n.propertyId]})}if("iot"===n.bind.class){let i=n.bind.id.split("#"),o=e.findIndex((e=>e.deviceId===i[0]));o>-1?e[o].properties.includes(i[1])||e[o].properties.push(i[1]):e.push({deviceId:i[0],properties:[i[1]],token:n.bind.token}),-1===t.findIndex((e=>e.key===n.bind.id))&&t.push({key:n.bind.id,label:n.bind.label})}else if("sql"===n.bind.class){let e=n.bind.id.split("#");const t=this.store.data.sqls.find((t=>t.bindId===e[0]));if(t){t.keys||(t.keys=[]),e.shift();const i=e.join("#");t.keys.includes(i)||t.keys.push(i)}}}})),null==(o=i.events)||o.forEach((t=>{var i;const n=null==(i=t.actions)?void 0:i.filter((e=>e.action===EventAction.SendData));null==n||n.forEach((t=>{var i;null==(i=t.data)||i.forEach((t=>{if("iot"===t.class){let i=t.prop.split("#"),n=e.findIndex((e=>e.deviceId===i[0]));n>-1?e[n].properties.includes(i[1])||e[n].properties.push(i[1]):e.push({deviceId:i[0],properties:[i[1]],token:t.token})}}))}))}))})),e.length&&(this.store.data.iot||(this.store.data.iot={}),this.store.data.iot.devices=e),t.length&&(this.store.data.iot.list=t)}connectSocket(){this.connectWebsocket(),this.connectMqtt(),this.connectHttp()}doInitJS(){const e=this.store.data.initJs;if(e&&e.trim())try{new Function("context",e)({meta2d:this})}catch(t){}}doInitFn(){let e=queryURLParams(),t=[];for(let i in e)e.hasOwnProperty(i)&&i.startsWith("bind-")&&t.push({id:i.replace("bind-",""),dataId:i.replace("bind-",""),value:e[i]});t.length&&this.setDatas(t,{history:!1})}drawLine(e){e&&lockedError(this.store),this.canvas.drawingLineName=e}alignPenToGrid(e){this.canvas.alignPenToGrid(e)}drawingPencil(){this.canvas.drawingPencil()}stopPencil(){this.canvas.stopPencil()}lock(e){this.store.data.locked=e,this.finishDrawLine(!0),this.canvas.drawingLineName="",this.stopPencil(),this.store.data.pens.forEach((e=>{var t;!0===e.externElement&&(null==(t=e.calculative.singleton)?void 0:t.div)&&setElemPosition(e,e.calculative.singleton.div)})),e>0&&this.initMessageEvents()}async finishDrawLine(e){await this.canvas.finishDrawline(e)}async finishPencil(){await this.canvas.finishPencil()}updateLineType(e,t){if(!e||"line"!=e.name||!t||!this.canvas[t])return;e.lineName=t;const i=getFromAnchor(e),n=getToAnchor(e);i.prev=void 0,i.next=void 0,n.prev=void 0,n.next=void 0,e.calculative.worldAnchors=[i,n],e.calculative.activeAnchor=i,this.canvas[t](this.store,e,n),"curve"===e.lineName&&(i.prev={penId:i.penId,x:i.x-50,y:i.y},i.next={penId:i.penId,x:i.x+50,y:i.y},n.prev={penId:n.penId,x:n.x-50,y:n.y},n.next={penId:n.penId,x:n.x+50,y:n.y}),e.calculative.activeAnchor=void 0,this.canvas.initLineRect(e),this.render()}addDrawLineFn(e,t){this.canvas[e]=t,this.canvas.drawLineFns.push(e)}removeDrawLineFn(e){const t=this.canvas.drawLineFns.indexOf(e);t>-1&&this.canvas.drawLineFns.splice(t,1)}showMagnifier(){this.canvas.showMagnifier()}hideMagnifier(){this.canvas.hideMagnifier()}toggleMagnifier(){this.canvas.toggleMagnifier()}clear(e=!0,t){var i;for(const n of this.store.data.pens)null==(i=n.onDestroy)||i.call(n,n);clearStore(this.store,t),this.hideInput(),this.canvas.tooltip.hide(),this.map&&this.map.isShow&&(this.map.show(),this.map.setView()),this.canvas.clearCanvas(),sessionStorage.removeItem("page"),this.store.clipboard=void 0,this.store.sameTemplate||(this.canvas.canvasTemplate.bgPatchFlags=!0),this.store.patchFlagsBackground=!0,this.store.patchFlagsTop=!0,this.setBackgroundImage(void 0),e&&this.render()}emit(e,t){this.store.emitter.emit(e,t)}on(e,t){return this.store.emitter.on(e,t),this}off(e,t){return this.store.emitter.off(e,t),this}updateLineAnimateDraws(e,t){t&&(delete this.store.data.lineAnimateDraws[e],delete globalStore.lineAnimateDraws[e],-1!==t&&this.registerLineAnimateDraws(t.name||e,t.code))}registerMoveDock(e){this.canvas.customMoveDock=e}registerResizeDock(e){this.canvas.customResizeDock=e}find(e){return this.canvas.find(e)}findOne(e){return this.canvas.findOne(e)}getPenRect(e){return this.canvas.getPenRect(e)}setPenRect(e,t,i=!0){this.canvas.setPenRect(e,t,i)}startAnimate(e,t){let i;this.stopAnimate(e),i=e?"string"==typeof e?this.find(e):e:this.store.data.pens.filter((e=>(e.type||e.frames)&&e.autoPlay||e.animations&&e.animations.length&&-1!==e.animations.findIndex((e=>e.autoPlay)))),i.length&&(i.forEach((e=>{var i,n;if(e.calculative.pause){const t=Date.now()-e.calculative.pause;e.calculative.pause=void 0,e.calculative.frameStart+=t,e.calculative.frameEnd+=t}else{let o=-1;if(void 0!==t&&e.animations){if("string"==typeof t){if(o=e.animations.findIndex((e=>e.name===t)),-1===o)return}else if("number"==typeof t){if(!(e.animations.length>t))return;o=t}}else void 0===t&&(o=null==(i=e.animations)?void 0:i.findIndex((e=>e.autoPlay)),-1===o&&(null==(n=e.animations)?void 0:n.length)&&(o=0));if(-1!==o&&void 0!==o){const t=deepClone(e.animations[o]);t.animateName=t.name,delete t.name,t.currentAnimation=o,!e.type&&t.frames&&(t.showDuration=this.calcAnimateDuration(t)),this.setValue({id:e.id,...t},{doEvent:!1,history:!1})}this.store.animates.add(e),e.type||this.store.animateMap.set(e,e.calculative.canvas.getFrameProps(e))}})),this.initImageCanvas(i),this.canvas.animate())}pauseAnimate(e){let t=[];e?t="string"==typeof e?this.find(e):e:this.store.animates.forEach((e=>{t.push(e)})),t.forEach((e=>{e.calculative.pause||(e.calculative.pause=Date.now())}))}stopAnimate(e){let t=[];e?t="string"==typeof e?this.find(e):e:this.store.animates.forEach((e=>{t.push(e)})),t.forEach((e=>{e.currentAnimation=void 0,e.calculative.pause=void 0,e.calculative.start=void 0,e.calculative.cycleStart=void 0,e.calculative.duration=void 0,e.calculative.animatePos=0,this.store.animates.delete(e),this.canvas.restoreNodeAnimate(e),this.canvas.updateLines(e),this.store.animateMap.delete(e)})),this.initImageCanvas(t),setTimeout((()=>{var e;null==(e=this.canvas)||e.calcActiveRect(),this.render()}),20)}startVideo(e){let t;t=e?"string"==typeof e?this.find(e):e:this.store.data.pens.filter((e=>(e.video||e.audio)&&e.autoPlay)),t.forEach((e=>{var t,i;null==(t=e.calculative.media)||t.play(),null==(i=e.onStartVideo)||i.call(e,e)}))}pauseVideo(e){let t=[];t=e?"string"==typeof e?this.find(e):e:this.store.data.pens.filter((e=>(e.video||e.audio)&&e.autoPlay)),t.forEach((e=>{var t,i;null==(t=e.calculative.media)||t.pause(),null==(i=e.onPauseVideo)||i.call(e,e)}))}stopVideo(e){let t=[];t=e?"string"==typeof e?this.find(e):e:this.store.data.pens.filter((e=>(e.video||e.audio)&&e.autoPlay)),t.forEach((e=>{var t;e.calculative.media&&(e.calculative.media.currentTime=0,e.calculative.media.pause()),null==(t=e.onStopVideo)||t.call(e,e)}))}calcAnimateDuration(e){return e.frames.reduce(((e,t)=>e+t.duration),0)}combine(e=this.store.active,t,i=!0){if(!e||!e.length)return;const n=deepClone(e);if(1===e.length&&e[0].type)return e[0].type=PenType.Node,this.canvas.active(e),this.pushHistory({type:EditType.Update,initPens:n,pens:deepClone(e,!0)}),void this.render();const o=getRect$1(e);let s={id:s8(),name:"combine",...o,children:[],showChild:t};this.canvas.makePen(s);const r=deepClone(s);let a=1/0;return e.forEach((e=>{const t=this.store.data.pens.findIndex((t=>t.id===e.id));if(t<a&&(a=t),e===s||e.parentId===s.id||e.id===s.id)return;s.children.push(e.id),e.parentId=s.id;const i=calcRelativeRect(e.calculative.worldRect,o);Object.assign(e,i),e.locked=e.lockedOnCombine??LockState.None,e.locked=e.interaction||isInteraction.includes(e.name)?0:e.locked})),this.store.data.pens.splice(a,0,s),this.store.data.pens.pop(),i&&this.canvas.active([s]),this.pushHistory({type:EditType.Add,pens:[r],step:3}),this.pushHistory({type:EditType.Update,initPens:[r],pens:[s],step:3}),this.pushHistory({type:EditType.Update,initPens:n,pens:e,step:3}),null!=t&&(e.forEach((e=>{calcInView(e,!0)})),this.initImageCanvas([s])),this.store.emitter.emit("combine",[s]),this.render(),s}uncombine(e){if(!e&&this.store.active&&(e=this.store.active[0]),!e||!e.children)return;const t=e.children.map((e=>this.store.pens[e]));let i=deepClone(t);t.forEach((e=>{e.parentId=void 0,e.x=e.calculative.worldRect.x,e.y=e.calculative.worldRect.y,e.width=e.calculative.worldRect.width,e.height=e.calculative.worldRect.height,e.locked=LockState.None,e.calculative.active=void 0,e.calculative.hover=!1,this.setVisible(e,!0)}));const n=this.isCombine(e)?3:2;this.pushHistory({type:EditType.Update,initPens:i,pens:t,step:n}),i=[deepClone(e)],e.children=void 0,this.pushHistory({type:EditType.Update,initPens:i,pens:[e],step:n}),this.isCombine(e)&&(this.delete([e]),this.store.histories[this.store.histories.length-1].step=n),this.inactive()}clearCombine(e){if(!e&&this.store.active&&(e=this.store.active[0]),!e||!e.children)return;const t=getAllChildren(e,this.store);t.forEach((e=>{e.parentId=void 0,e.x=e.calculative.worldRect.x,e.y=e.calculative.worldRect.y,e.width=e.calculative.worldRect.width,e.height=e.calculative.worldRect.height,e.locked=LockState.None,e.calculative.active=void 0,e.calculative.hover=!1,void 0!==e.showChild&&this.setVisible(e,!0),e.children=void 0}));const i=[];t.forEach(((e,t)=>{"combine"===e.name&&(e.children=void 0,i.push(e))})),this.delete(i,!0,!1),e.children=void 0,this.isCombine(e)&&this.delete([e],!0,!1),this.inactive()}appendChild(e=this.store.active){if(!e)return;if(e.length<2)return;const t=e.findIndex((e=>"combine"===e.name&&void 0!==e.showChild));if(-1!==t){let i=e[t];const n=getRect$1(e);Object.assign(i,n),Object.assign(i.calculative.worldRect,n),calcWorldAnchors(i),i.children.forEach((e=>{const t=this.store.pens[e],i=calcRelativeRect(t.calculative.worldRect,n);Object.assign(t,i)})),e.forEach((e=>{if(e.id!==i.id){i.children.push(e.id),e.parentId=i.id;const t=calcRelativeRect(e.calculative.worldRect,n);Object.assign(e,t),e.locked=e.lockedOnCombine??LockState.DisableMove,e.locked=e.interaction||isInteraction.includes(e.name)?0:e.locked,calcInView(e,!0)}})),this.initImageCanvas(e),this.render()}}updateRectbyChild(e,t,i){if(calcRightBottom(e),calcCenter(e),t.calculative.worldRect=e,rectInRect(e,i.calculative.worldRect,!0)){const n=calcRelativeRect(e,i.calculative.worldRect);Object.assign(t,n)}else{let t=Math.min(e.x,i.calculative.worldRect.x),n=Math.min(e.y,i.calculative.worldRect.y),o=Math.max(e.ex,i.calculative.worldRect.ex),s=Math.max(e.ey,i.calculative.worldRect.ey);i.calculative.worldRect={x:t,y:n,width:o-t,height:s-n,ex:o,ey:s},i.parentId||Object.assign(i,i.calculative.worldRect),calcCenter(i.calculative.worldRect),i.children.forEach((e=>{const t=this.store.pens[e],n=calcRelativeRect(t.calculative.worldRect,i.calculative.worldRect);Object.assign(t,n)})),i.parentId&&this.updateRectbyChild(i.calculative.worldRect,i,this.store.pens[i.parentId])}this.canvas.updatePenRect(i),this.render()}isCombine(e){return"combine"===e.name||!!(e.children&&e.children.length>0)}active(e,t=!0){this.canvas.active(e,t)}inactive(){this.canvas.inactive()}activeAll(){this.canvas.active(this.store.data.pens.filter((e=>!e.parentId&&e.locked!==LockState.Disable))),this.render()}focus(e){const t=this.findOne(e);t&&(this.store.hover=t,this.store.hover.calculative.hover=!0,this.showInput(t))}delete(e,t=!1,i=!0){this.canvas.delete(e,t,i)}scale(e,t={x:0,y:0}){this.canvas.scale(e,t)}translate(e,t){this.canvas.translate(e,t)}translatePens(e,t,i){this.canvas.translatePens(e,t,i)}getParent(e,t){return getParent(e,t)}getAllChildren(e){return getAllChildren(e,this.store)}getAllFollowers(e){return getAllFollowers(e,this.store)}data(){const e=deepClone(this.store.data),{pens:t,paths:i}=this.store.data;e.version=pkg.version,e.paths={};for(const n in i)Object.prototype.hasOwnProperty.call(i,n)&&t.find((e=>e.pathId===n))&&(e.paths[n]=i[n]);return e.dataPoints=[...Object.keys(this.store.bind),...Object.keys(this.store.bindDatas)],Object.entries(globalStore.lineAnimateDraws).forEach((([t,i])=>{e.lineAnimateDraws[t]=i.toString()})),e}copy(e){this.canvas.copy(e)}cut(e){this.canvas.cut(e)}paste(){this.canvas.paste()}undo(){this.canvas.undo()}redo(){this.canvas.redo()}listenSocket(){try{let e;const t=this.store.data.socketCbJs;if(t&&(e=new Function("e","context",t)),!e)return this.socketFn=null,!1;this.socketFn=e}catch(e){return!1}return!0}connectWebsocket(e){this.closeWebsocket(),e&&(this.store.data.websocket=e),this.store.data.websocket&&(this.websocket=new WebSocket(this.store.data.websocket,this.store.data.websocketProtocols||void 0),this.websocket.onmessage=e=>{this.socketCallback(e.data,{type:"websocket",url:this.store.data.websocket})},this.websocket.onerror=e=>{this.store.emitter.emit("error",{type:"websocket",error:e})},this.websocket.onclose=()=>{if(this.store.options.reconnetTimes&&(this.websocketTimes++,this.websocketTimes>=this.store.options.reconnetTimes))return this.websocketTimes=0,void this.closeWebsocket();this.connectWebsocket()})}closeWebsocket(){this.websocket&&(this.websocket.onclose=void 0,this.websocket.close(),this.websocket=void 0)}connectMqtt(e){if(this.closeMqtt(),e&&(this.store.data.mqtt=e.mqtt,this.store.data.mqttTopics=e.mqttTopics,this.store.data.mqttOptions=e.mqttOptions),this.store.data.mqtt){this.store.data.mqttOptions.clientId&&!this.store.data.mqttOptions.customClientId&&(this.store.data.mqttOptions.clientId=s8());const e={...this.store.data.mqttOptions};e.username||delete e.username,e.password||delete e.password;const{username:t,password:i}=e;(t&&i||!t&&!i)&&(this.mqttClient=mqtt_minExports.connect(this.store.data.mqtt,e),this.mqttClient.on("message",((e,t)=>{this.socketCallback(t.toString(),{topic:e,type:"mqtt",url:this.store.data.mqtt})})),this.mqttClient.on("error",(e=>{this.store.emitter.emit("error",{type:"mqtt",error:e})})),this.mqttClient.on("close",(()=>{this.store.options.reconnetTimes&&(this.mqttTimes++,this.mqttTimes>=this.store.options.reconnetTimes&&(this.mqttTimes=0,this.closeMqtt()))})),this.store.data.mqttTopics&&this.mqttClient.subscribe(this.store.data.mqttTopics.split(",")))}}closeMqtt(){var e;null==(e=this.mqttClient)||e.end()}connectHttp(){this.closeHttp();const{https:e}=this.store.data;if(e)this.store.data.cancelFirstConnect||e.forEach((async e=>{this.oldRequestHttp(e)})),e.forEach(((e,t)=>{e.http&&0!==e.httpTimeInterval&&(e.times=0,this.httpTimerList[t]=setInterval((async()=>{this.oldRequestHttp(e),this.store.options.reconnetTimes&&e.times>=this.store.options.reconnetTimes&&(e.times=0,clearInterval(this.httpTimerList[t]),this.httpTimerList[t]=void 0)}),e.httpTimeInterval||1e3))}));else{const{http:e,httpTimeInterval:t,httpHeaders:i}=this.store.data;e&&(this.httpTimer=setInterval((async()=>{const t=await fetch(e,{headers:i});if(t.ok){const i=await t.text();this.socketCallback(i,{type:"http",url:e})}}),t||1e3))}}async oldRequestHttp(e){let t=deepClone(e);if(t.http){const i=await fetch(t.http,{headers:t.httpHeaders,method:t.method||"GET",body:"POST"===t.method?JSON.stringify(t.body):void 0});if(i.ok){const e=await i.text();this.socketCallback(e,{type:"http",url:t.http})}else e.times++,this.store.emitter.emit("error",{type:"http",error:i})}}async sendDatabyHttp(e){const{https:t}=this.store.data;if(t)t.forEach((async t=>{if(t.http){(await fetch(t.http,{method:"post",body:e,headers:t.httpHeaders})).ok}}));else{const{http:t,httpHeaders:i}=this.store.data;if(t){(await fetch(t,{method:"post",body:e,headers:i})).ok}}}closeHttp(){clearInterval(this.httpTimer),this.httpTimer=void 0,this.httpTimerList&&this.httpTimerList.forEach((e=>{clearInterval(e),e=void 0}))}connectNetwork(){this.closeNetwork();const{networks:e}=this.store.data,t=[];if(e){let i=0,n=0,o=0,s=0;this.mqttClients=[],this.websockets=[],this.eventSources=[],e.forEach((async e=>{"mqtt"===e.protocol?(e.index=i,this.connectNetMqtt(e),i+=1):"websocket"===e.protocol?(e.index=o,this.connectNetWebSocket(e),o+=1):"http"===e.protocol?(e.index=n,t.push({url:e.url,interval:e.interval,headers:e.headers||void 0,method:e.method,body:e.body}),n+=1):"ADIIOT"===e.protocol?connectJetLinks(this,e):"SSE"===e.protocol&&(e.index=s,this.connectSSE(e),s+=1)}))}this.onNetworkConnect(t),this.connectIot(),this.connectSqls()}reconnectNetwork(e){var t,i;const n=this.store.data.networks[e];if("mqtt"===n.protocol)this.mqttClients&&(null==(t=this.mqttClients[n.index])||t.end()),this.connectNetMqtt(n);else if("websocket"===n.protocol)this.websockets&&this.websockets[n.index]&&(this.websockets[n.index].onclose=void 0,this.websockets[n.index].close(),this.websockets[n.index]=void 0),this.connectNetWebSocket(n);else if("http"===n.protocol){this.updateTimerList&&(clearInterval(this.updateTimerList[n.index]),this.updateTimerList[n.index]=void 0);const e=deepClone(n);this.store.data.cancelFirstConnect||this.requestHttp(e),this.updateTimerList[n.index]=setInterval((async()=>{this.requestHttp(e)}),e.interval||1e3)}else"SSE"===n.protocol&&(this.eventSources&&(null==(i=this.eventSources[n.index])||i.close(),this.eventSources[n.index]=void 0),this.connectSSE(n))}async connectIot(){var e;const{iot:t}=this.store.data;if(!t||!(null==(e=null==t?void 0:t.devices)?void 0:e.length))return;const i=globalThis.iotUrl||await this.getMqttUrl();if(!i)return;const n=await this.getIotToken(t.devices,"websocket"===t.protocol?1:void 0);t.token=n,this.iotMqttClient=mqtt_minExports.connect(i),this.iotMqttClient.on("message",((e,t)=>{this.socketCallback(t.toString(),{topic:`le5le-iot/properties/${n}`,type:"iot",url:i,method:"mqtt"})})),this.iotMqttClient.on("error",(e=>{this.store.emitter.emit("error",{type:"mqtt",error:e})})),this.iotMqttClient.subscribe(`le5le-iot/properties/${n}`),this.iotTimer=setInterval((()=>{this.iotMqttClient&&this.iotMqttClient.publish("le5le-iot/subscribe/ping",n)}),3e5)}connectSqls(){const{sqls:e}=this.store.data;if(e&&e.length){let t=0;e.forEach((async e=>{await this.doSqlCode(e),e.interval&&(e.index=t,this.sqlTimerList[t]=setInterval((async()=>{await this.doSqlCode(e)}),e.interval),t+=1)}))}}connectSSE(e){this.eventSources[e.index]=new EventSource(e.url,{withCredentials:e.withCredentials}),this.eventSources[e.index].onmessage=t=>{this.socketCallback(t.data,{type:"SSE",url:e.url,name:e.name})},this.eventSources[e.index].onerror=e=>{this.store.emitter.emit("error",{type:"SSE",error:e})}}closeSSE(){this.eventSources&&this.eventSources.forEach((e=>{e&&(e.close(),e=void 0)}))}connectNetMqtt(e){var t,i,n,o;e.options.clientId&&!e.options.customClientId&&(e.options.clientId=s8());let s=e.url;if(s.indexOf("${")>-1){let e=null==(t=s.match(/\$\{([^}]+)\}/g))?void 0:t.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{s=s.replace(`\${${e}}`,this.getDynamicParam(e))}))}e.times=0;let r=deepClone(e.options);if((null==r?void 0:r.username)&&r.username.includes("${")){let e=null==(i=r.username.match(/\$\{([^}]+)\}/g))?void 0:i.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{r.username=r.username.replace(`\${${e}}`,this.getDynamicParam(e))}))}if((null==r?void 0:r.password)&&r.password.includes("${")){let e=null==(n=r.password.match(/\$\{([^}]+)\}/g))?void 0:n.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{r.password=r.password.replace(`\${${e}}`,this.getDynamicParam(e))}))}if(this.mqttClients[e.index]=mqtt_minExports.connect(s,r),this.mqttClients[e.index].on("message",((t,i)=>{this.socketCallback(i.toString(),{topic:t,type:"mqtt",url:e.url,name:e.name})})),this.mqttClients[e.index].on("error",(e=>{this.store.emitter.emit("error",{type:"mqtt",error:e})})),this.mqttClients[e.index].on("close",(()=>{var t;this.store.options.reconnetTimes&&(e.times++,e.times>=this.store.options.reconnetTimes&&(e.times=0,this.mqttClients&&(null==(t=this.mqttClients[e.index])||t.end())))})),e.topics){let t=e.topics;if(t.indexOf("${")>-1){let e=null==(o=t.match(/\$\{([^}]+)\}/g))?void 0:o.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{t=t.replace(`\${${e}}`,this.getDynamicParam(e))}))}this.mqttClients[e.index].subscribe(t.split(","))}}connectNetWebSocket(e){var t,i;this.websockets[e.index]&&(this.websockets[e.index].onclose=void 0,null==(t=this.websockets[e.index])||t.close(),this.websockets[e.index]=void 0);let n=e.url;if(n.indexOf("${")>-1){let e=null==(i=n.match(/\$\{([^}]+)\}/g))?void 0:i.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{n=n.replace(`\${${e}}`,this.getDynamicParam(e))}))}this.websockets[e.index]=new WebSocket(n,e.protocols||void 0),this.websockets[e.index].onmessage=t=>{this.socketCallback(t.data,{type:"websocket",url:e.url,name:e.name})},this.websockets[e.index].onerror=e=>{this.store.emitter.emit("error",{type:"websocket",error:e})},this.websockets[e.index].onclose=()=>{var t;if(this.store.options.reconnetTimes&&(e.times++,e.times>=this.store.options.reconnetTimes))return e.times=0,this.websockets[e.index].onclose=void 0,null==(t=this.websockets[e.index])||t.close(),void(this.websockets[e.index]=void 0);setTimeout((()=>{this.connectNetWebSocket(e)}),2e3)}}async getMqttUrl(){const e=await fetch("/api/iot/app/mqtt",{method:"GET",headers:{Authorization:`Bearer ${getToken()}`}});if(e.ok){const t=await e.text();let i=JSON.parse(t);if(!(i.wssPort||i.wsPort))return;return`${"https:"===location.protocol?"wss":"ws"}://${i.host}:${"https:"===location.protocol?i.wssPort:i.wsPort}${i.path}`}}async getIotToken(e,t){const i=await fetch("/api/iot/subscribe/properties",{method:"POST",headers:{Authorization:`Bearer ${getToken()}`},body:JSON.stringify({devices:e,type:t})});if(i.ok){const e=await i.text();return JSON.parse(e).token}}async doSqlCode(e){var t;const i=e.method||"get";let n=e.sql;"list"===i&&(n+=` LIMIT ${e.pageSize||20}`+(e.current>1?" OFFSET "+(e.current-1)*e.pageSize:""));const o=await fetch(`/api/iot/data/sql/${i}`,{method:"POST",headers:{Authorization:`Bearer ${getCookie("token")||localStorage.getItem("token")||new URLSearchParams(location.search).get("token")||""}`},body:JSON.stringify({dbid:e.dbid,sql:n})});if(o.ok){let n=await o.text();if(n){const o=[];n=JSON.parse(n),null==(t=e.keys)||t.forEach((t=>{o.push({id:e.bindId+"#"+t,value:getter(n,t.split("#").join("."))})})),o.push({id:e.bindId,value:n}),this.socketCallback(JSON.stringify(o),{type:"sql",url:`/api/iot/data/sql/${i}`,method:i})}}}randomString(e){e=e||32;let t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",i="";for(let n=0;n<e;n++)i+=t.charAt(Math.floor(48*Math.random()));return i}mockValue(e){let t;if(e.enableMock&&void 0!==e.mock)if("float"===e.type)if(e.mock&&-1!==e.mock.indexOf(",")){let i=e.mock.split(","),n=Math.floor(Math.random()*i.length);t=parseFloat(i[n])}else if(e.mock&&-1!==e.mock.indexOf("-")){let i,n,o,s=e.mock.split("-");if("-"===e.mock.charAt(0)?4===s.length?(i=-parseFloat(s[3]),n=-parseFloat(s[1]),o=s[3]):(i=parseFloat(s[2]),n=-parseFloat(s[1]),o=s[2]):(i=parseFloat(s[1]),n=parseFloat(s[0]),o=s[1]),-1!==(o+"").indexOf(".")){let e=(o+"").split(".")[1].length;t=(Math.random()*(i-n)+n).toFixed(e)}else t=Math.random()*(i-n)+n}else t=parseFloat(e.mock);else if("integer"===e.type)if(e.mock&&-1!==e.mock.indexOf(",")){let i=e.mock.split(","),n=Math.floor(Math.random()*i.length);t=parseInt(i[n])}else if(e.mock&&-1!==e.mock.indexOf("-")){let i,n,o=e.mock.split("-");"-"===e.mock.charAt(0)?4===o.length?(i=-parseFloat(o[3]),n=-parseFloat(o[1])):(i=parseFloat(o[2]),n=-parseFloat(o[1])):(i=parseInt(o[1]),n=parseInt(o[0])),t=parseInt(Math.random()*(i-n)+n+"")}else t=parseInt(e.mock);else if("bool"===e.type)t="boolean"==typeof e.mock?e.mock:"true"===e.mock||"false"!==e.mock&&Math.random()<.5;else if("object"===e.type||"array"===e.type)e.mock;else if(e.mock&&-1!==e.mock.indexOf(",")){let i=e.mock.split(",");t=i[Math.floor(Math.random()*i.length)]}else if(e.mock&&e.mock.startsWith("[")&&e.mock.endsWith("]")){let i=parseInt(e.mock.substring(1,e.mock.length-1));t=this.randomString(i)}else t=e.mock;return t}dataMock(){var e,t;let i=[];null==(t=null==(e=this.store.data.dataset)?void 0:e.devices)||t.forEach((e=>{let t=this.mockValue(e);void 0!==t&&i.push({id:e.id,value:t})})),i.length&&this.setDatas(i,{render:!0,doEvent:!0,history:!1})}startDataMock(){this.store.data.enableMock&&(this.stopDataMock(),this.initBinds(),this.updateTimer=setInterval((()=>{this.store.data.pens.forEach((e=>{this.penMock(e)})),this.dataMock(),this.render()}),this.store.data.networkInterval||1e3))}stopDataMock(){clearInterval(this.updateTimer),this.updateTimer=void 0}penMock(e){var t;if(e.realTimes){let i={};if(e.realTimes.forEach((e=>{let t=this.mockValue(e);void 0!==t&&(i[e.key]=t)})),Object.keys(i).length){let n=e.onBeforeValue?e.onBeforeValue(e,i):i;this.canvas.updateValue(e,n),null==(t=e.onValue)||t.call(e,e),this.store.emitter.emit("valueUpdate",e)}}}penNetwork(e){const t={url:e.apiUrl,method:e.apiMethod,headers:e.apiHeaders,body:e.apiBody};this.requestHttp(t),e.apiEnable?(this.store.pensNetwork||(this.store.pensNetwork={}),this.store.pensNetwork[e.id]=t):delete this.store.pensNetwork[e.id]}getDynamicParam(e){return queryURLParams()[e]||localStorage[e]||getCookie(e)||globalThis[e]||""}onNetworkConnect(e){if(e&&e.length){if(this.store.pensNetwork)for(let t in this.store.pensNetwork)e.push(this.store.pensNetwork[t]);this.store.data.cancelFirstConnect||e.forEach((async e=>{this.requestHttp(e)})),e.forEach(((e,t)=>{e.times=0,0!==e.interval&&(this.updateTimerList[t]=setInterval((async()=>{this.requestHttp(e),this.store.options.reconnetTimes&&e.times>=this.store.options.reconnetTimes&&(e.times=0,clearInterval(this.updateTimerList[t]),this.updateTimerList[t]=void 0)}),e.interval||1e3))}))}}async requestHttp(e){var t,i,n;let o=deepClone(e);if(o.url){if(o.url.indexOf("${")>-1){let e=null==(t=o.url.match(/\$\{([^}]+)\}/g))?void 0:t.map((e=>e.slice(2,-1)));e&&e.forEach((e=>{o.url=o.url.replace(`\${${e}}`,this.getDynamicParam(e))}))}if("object"==typeof o.headers)for(let e in o.headers)if("string"==typeof o.headers[e]){let t=null==(i=o.headers[e].match(/\$\{([^}]+)\}/g))?void 0:i.map((e=>e.slice(2,-1)));t&&(o.headers[e]=o.headers[e].replace(`\${${t[0]}}`,this.getDynamicParam(t[0])))}if("object"==typeof o.body)for(let e in o.body)if("string"==typeof o.body[e]){let t=null==(n=o.body[e].match(/\$\{([^}]+)\}/g))?void 0:n.map((e=>e.slice(2,-1)));t&&(o.body[e]=o.body[e].replace(`\${${t[0]}}`,this.getDynamicParam(t[0])))}const s=await fetch(o.url,{headers:o.headers,method:o.method,body:"GET"===o.method?void 0:JSON.stringify(o.body)});if(s.ok){const e=await s.text();this.socketCallback(e,{type:"http",url:o.url,name:o.name})}else e.times++,this.store.emitter.emit("error",{type:"http",error:s})}}closeNetwork(){this.mqttClients&&this.mqttClients.forEach((e=>{e.end()})),this.websockets&&this.websockets.forEach((e=>{e&&(e.onclose=void 0,e.close(),e=void 0)})),this.mqttClients=void 0,this.websockets=void 0,this.updateTimerList&&this.updateTimerList.forEach((e=>{clearInterval(e),e=void 0})),this.sqlTimerList&&this.sqlTimerList.forEach((e=>{clearInterval(e),e=void 0})),this.iotMqttClient&&(this.iotMqttClient.end(),this.iotMqttClient=void 0),clearInterval(this.iotTimer),this.iotTimer=void 0,closeJetLinks(this),this.closeSSE()}socketCallback(e,t){this.store.emitter.emit("socket",{message:e,context:t});let i,n=e;if(!this.socketFn||(n=this.socketFn(e,{meta2d:this,type:t.type,topic:t.topic,url:t.url,method:t.method}),n)){if(!0===n&&(n=e),n.constructor===Object||n.constructor===Array)i=n;else{if("string"!=typeof n)return;try{i=JSON.parse(n)}catch(o){}}i&&(Array.isArray(i)||(i=[i]),i.length&&(i[0].dataId?this.setDatas(i):i.forEach((e=>{this.setValue(e)}))))}}setDatas(e,{render:t=!0,doEvent:i=!0,history:n}={}){const o=new Map;let s,r;e.forEach((t=>{var i,n;null==(i=this.store.bindDatas[t.dataId])||i.forEach((i=>{const n=this.store.pens[i.id];if(!n)return;let s=o.get(n);if(n.noOnBinds||"function"!=typeof n.onBinds)s?s[i.formItem.key]=t.value:(s={id:i.id,[i.formItem.key]:t.value},o.set(n,s));else{if(s)return;o.set(n,n.onBinds(n,e,i.formItem))}})),null==(n=this.store.bind[t.id||t.dataId])||n.forEach((e=>{const i=this.store.pens[e.id];if(!i)return;let n=o.get(i);n?n[e.key]=t.value:(n={id:e.id,[e.key]:t.value},o.set(i,n))}))})),this.store.data.locked&&this.doDataEvent(e),n&&(s=[]),o.forEach(((e,t)=>{this.setValue(e,{render:!1,doEvent:i,history:!1}),n&&(s.push(deepClone(t,!0)),r.push(t))})),t&&this.render(),n&&this.pushHistory({type:EditType.Update,initPens:s,pens:r})}setValue(e,{render:t=!0,doEvent:i=!0,history:n}={}){let o,s=[];if(e){if(e.id){if(e.id===this.store.data.id)return this.setDatabyOptions(e),e.bkImage&&this.setBackgroundImage(e.bkImage),e.background&&this.setBackgroundColor(e.background),void this.render();const o=this.store.pens[e.id];if(o)s=[o];else{let o=this.store.bind[e.id];if(o&&o.length)return s=[],void this.setDatas([e],{render:t,doEvent:i,history:n})}}else{if(e.dataId)return s=[],void this.setDatas([e],{render:t,doEvent:i,history:n});if(!e.tag){let o=[];for(let t in e)o.push({dataId:t,id:t,value:e[t]});return void(o.length&&this.setDatas(o,{render:t,doEvent:i,history:n}))}s=this.find(e.tag)}if((n=n&&!this.store.data.locked)&&(o=deepClone(s)),s.forEach((t=>{var i;const n=t.onBeforeValue?t.onBeforeValue(t,e):e;e.frames&&(this.stopAnimate([t]),e.showDuration||(e.showDuration=e.frames.reduce(((e,t)=>e+t.duration),0))),setChildValue(t,n),this.canvas.updateValue(t,n),null==(i=t.onValue)||i.call(t,t)})),this.store.data.locked||!this.store.active.length||this.canvas.movingPens||this.canvas.calcActiveRect(),n){let e=deepClone(s);this.pushHistory({type:EditType.Update,initPens:o,pens:e})}i&&s.forEach((e=>{this.store.emitter.emit("valueUpdate",e)})),t&&this.render()}}_setValue(e,t=!1){this.setValue(e,{history:t,render:!1,doEvent:!1})}pushHistory(e){this.canvas.pushHistory(e)}showInput(e,t){this.canvas.showInput(e,t)}hideInput(){this.canvas.hideInput()}clearDropdownList(){this.canvas.clearDropdownList()}clearRuleLines(){this.canvas.clearRuleLines()}doMessageEvent(e,t){this.store.messageEvents[e]&&this.store.messageEvents[e].forEach((e=>{let i=!1;e.event.conditions&&e.event.conditions.length?"and"===e.event.conditionType?i=e.event.conditions.every((t=>this.judgeCondition(e.pen,t.key,t))):"or"===e.event.conditionType&&(i=e.event.conditions.some((t=>this.judgeCondition(e.pen,t.key,t)))):i=!0,i&&e.event.actions.forEach((i=>{this.events[i.action](e.pen,i,t)}))}))}initGlobalTriggers(){var e;this.store.globalTriggers={},null==(e=this.store.data.triggers)||e.forEach((e=>{e.conditions.forEach((t=>{t.source&&(this.store.globalTriggers[t.source]||(this.store.globalTriggers[t.source]=[]),this.store.globalTriggers[t.source].includes(e)||this.store.globalTriggers[t.source].push(e))}))}))}initMessageEvents(){this.store.messageEvents={},this.store.data.pens.forEach((e=>{var t;null==(t=e.events)||t.forEach((t=>{"message"===t.name&&t.message&&(this.store.messageEvents[t.message]||(this.store.messageEvents[t.message]=[]),this.store.messageEvents[t.message].push({pen:e,event:t}))}))}))}dataJudegeCondition(e,t,i){const{type:n,target:o,fnJs:s,fn:r,operator:a,valueType:l}=i;let c=!1;if("fn"===n){if(r)c=r(e,{meta2d:this});else if(s){try{i.fn=new Function("data","context",s)}catch(h){}i.fn&&(c=i.fn(e,{meta2d:this}))}}else{let n=i.value;"prop"===l&&(n=e[i.value]);let o=e[t];switch(a){case">":c=o>+n;break;case">=":c=o>=+n;break;case"<":c=o<+n;break;case"<=":c=o<=+n;break;case"=":case"==":c=o==n;break;case"!=":c=o!=n;break;case"[)":c=valueInRange(+o,n);break;case"![)":c=!valueInRange(+o,n);break;case"[]":c=valueInArray(o,n);break;case"![]":c=!valueInArray(o,n)}}return c}judgeCondition(e,t,i){const{type:n,target:o,fnJs:s,fn:r,operator:a,valueType:l}=i;let c=!1;if("fn"===n){if(r)c=r(e,{meta2d:this});else if(s){try{i.fn=new Function("pen","context",s)}catch(h){}i.fn&&(c=i.fn(e,{meta2d:this}))}}else{let n=i.value;"prop"===l&&(n=this.store.pens[o][i.value]);let s=getter(e,t);switch(["x","y","width","height"].includes(t)&&(s=this.getPenRect(e)[t]),a){case">":c=s>+n;break;case">=":c=s>=+n;break;case"<":c=s<+n;break;case"<=":c=s<=+n;break;case"=":case"==":c=s==n;break;case"!=":c=s!=n;break;case"[)":c=valueInRange(+s,n);break;case"![)":c=!valueInRange(+s,n);break;case"[]":c=valueInArray(s,n);break;case"![]":c=!valueInArray(s,n)}}return c}pushChildren(e,t){const i=[deepClone(e,!0)],n=[];e.children||(e.children=[]);const o=[];t.forEach((t=>{let s=deepClone(t,!0);if(t.id&&this.store.pens[t.id]||(this.canvas.makePen(t),s=null),t.parentId){const e=this.store.pens[t.parentId],n=e.children.findIndex((e=>e===t.id));i.push(deepClone(e,!0)),e.children.splice(n,1),o.push(deepClone(e,!0))}e.children.push(t.id),t.parentId=e.id;const r=calcRelativeRect(t.calculative.worldRect,e.calculative.worldRect);Object.assign(t,r),t.locked=t.lockedOnCombine??LockState.DisableMove,t.locked=t.interaction||isInteraction.includes(t.name)?0:t.locked,s?(i.push(s),o.push(deepClone(t,!0))):n.push(deepClone(t,!0))})),o.push(deepClone(e,!0));let s=1;n.length&&(s=2,this.pushHistory({type:EditType.Add,pens:n,step:s})),this.pushHistory({type:EditType.Update,initPens:i,pens:o,step:s})}toPng(e,t,i=!1,n){return this.canvas.toPng(e,t,i,n)}activeToPng(e,t){return this.canvas.activeToPng(e,t)}pensToPng(e=this.store.active,t,i){return this.canvas.pensToPng(e,t,i)}downloadPng(e,t,i){var n;for(const o of this.store.data.pens)(o.calculative.img||["iframe"].includes(o.name))&&(null==(n=o.onRenderPenRaw)||n.call(o,o));setTimeout((()=>{const n=document.createElement("a");n.setAttribute("download",(e||this.store.data.name||"le5le.meta2d")+".png"),n.setAttribute("href",this.toPng(t,void 0,!0,i));const o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),n.dispatchEvent(o)}),1e3)}downloadSvg(){if(!window.C2S)throw new Error("请先加载乐吾乐官网下的canvas2svg.js");let e=!1;const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;t&&i&&!this.store.data.component&&(e=!0);const n=this.getRect();e&&(n.x=this.store.data.origin.x,n.y=this.store.data.origin.y,n.width=t*this.store.data.scale,n.height=i*this.store.data.scale),n.x-=10,n.y-=10;const o=new window.C2S(n.width+20,n.height+20);o.textBaseline="middle",o.strokeStyle=this.store.styles.color;const s=this.store.data.background||this.store.styles.background;s&&e&&(o.save(),o.fillStyle=s,o.fillRect(0,0,n.width,n.height),o.restore()),this.store.bkImg&&e&&o.drawImage(this.store.bkImg,0,0,n.width,n.height),s&&!e&&(o.save(),o.fillStyle=s,o.fillRect(0,0,n.width+20,n.height+20),o.restore());for(const u of this.store.data.pens)0!=u.visible&&isShowChild(u,this.store)&&("combine"!==u.name||u.draw)&&renderPenRaw$1(o,u,n,!0);let r=o.getSerializedSvg();this.store.data.background?(r=r.replace("{{bk}}",""),r=r.replace("{{bkRect}}",`<rect x="0" y="0" width="100%" height="100%" fill="${this.store.data.background}"></rect>`)):(r=r.replace("{{bk}}",""),r=r.replace("{{bkRect}}","")),r=r.replace(/--le5le--/g,"&#x");const a=window.URL,l=new Blob([r]),c=a.createObjectURL(l),h=document.createElement("a");h.setAttribute("download",`${this.store.data.name||"le5le.meta2d"}.svg`),h.setAttribute("href",c);const d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),h.dispatchEvent(d)}getRect(e=this.store.data.pens){return getRect$1(e)}hiddenTemplate(){this.canvas.canvasTemplate.hidden()}showTemplate(){this.canvas.canvasTemplate.show()}lockTemplate(e){this.store.data.pens.forEach((t=>{t.canvasLayer===CanvasLayer.CanvasTemplate&&(t.locked=e)}))}fitView(e=!0,t=10){var i,n;if(!this.hasView())return;const{canvas:o}=this.canvas,{offsetWidth:s,offsetHeight:r}=o;this.resize(s,r);const a=formatPadding(t),l=this.getRect(),c=(s-a[1]-a[3])/l.width,h=(r-a[0]-a[2])/l.height;let d=c;d=e?c>h?h:c:c>h?c:h,(null==(i=this.store.data.fits)?void 0:i.length)&&(this.canvas.opening=!0),this.scale(d*this.store.data.scale),this.centerView(),(null==(n=this.store.data.fits)?void 0:n.length)&&this.fillView()}fillView(){var e,t;const i=this.getRect(),n=this.canvas.width-i.width,o=this.canvas.height-i.height;if(Math.abs(n)>10){null==(e=this.store.data.fits)||e.forEach((e=>{let t=[];e.children.forEach((e=>{this.store.pens[e]&&(this.store.pens[e].locked=LockState.None,t.push(this.store.pens[e]))}));let o=n/2;if(e.left&&e.right){let o=e.leftValue,s=e.rightValue;o=o?Math.abs(o)<1?o*this.canvas.width:o:0,s=s?Math.abs(s)<1?s*this.canvas.width:s:0;let r=(this.canvas.width-o-s)/(i.width-o-s);t.forEach((e=>{var t,s;if(e.image&&e.imageRatio&&e.calculative.worldRect.width/this.canvas.width>.1&&(e.imageRatio=!1),e.calculative.worldRect.x=i.x-n/2+o+(e.calculative.worldRect.x-i.x)*r,e.calculative.worldRect.width*=r,e.calculative.worldRect.ex=e.calculative.worldRect.x+e.calculative.worldRect.width,e.calculative.width=e.calculative.worldRect.width,e.calculative.x=e.calculative.worldRect.x,e.width=e.calculative.worldRect.width,e.x=e.calculative.worldRect.x,this.canvas.updatePenRect(e,{worldRectIsReady:!1}),e.externElement&&(null==(t=e.onResize)||t.call(e,e)),null==(s=e.children)?void 0:s.length){getAllChildren(e,this.store).forEach((e=>{var t;e.externElement&&(null==(t=e.onResize)||t.call(e,e))}))}}))}else e.left?(o=-o,e.leftValue&&(o+=Math.abs(e.leftValue)<1?e.leftValue*this.canvas.width:e.leftValue),this.translatePens(t,o,0)):e.right&&(e.rightValue&&(o-=Math.abs(e.rightValue)<1?e.rightValue*this.canvas.width:e.rightValue),this.translatePens(t,o,0))}));const t=this.store.data.pens.filter((e=>"iframe"===e.name));null==t||t.forEach((e=>{var t,o;const s=e.calculative.worldRect;if(s.width/this.store.data.scale>.8*i.width){let i=s.width;e.calculative.worldRect.x=s.x-n/2,e.calculative.worldRect.width=s.width+n,e.calculative.worldRect.ex=s.ex+n,e.operationalRect.x=e.operationalRect.x*i/e.calculative.worldRect.width,e.operationalRect.width=(e.calculative.worldRect.width-(1-e.operationalRect.width)*i)/e.calculative.worldRect.width,null==(t=e.onBeforeValue)||t.call(e,e,{operationalRect:e.operationalRect}),null==(o=e.onResize)||o.call(e,e)}}))}if(Math.abs(o)>10){null==(t=this.store.data.fits)||t.forEach((e=>{let t=[];e.children.forEach((e=>{this.store.pens[e]&&(this.store.pens[e].locked=LockState.None,t.push(this.store.pens[e]))}));let n=o/2;if(e.top&&e.bottom){let n=e.topValue,s=e.bottomValue;n=n?Math.abs(n)<1?n*this.canvas.height:n:0,s=s?Math.abs(s)<1?s*this.canvas.height:s:0;let r=(this.canvas.height-n-s)/i.height;t.forEach((e=>{var t,s;if(e.image&&e.imageRatio&&e.calculative.worldRect.height/this.canvas.height>.1&&(e.imageRatio=!1),e.calculative.worldRect.y=i.y-o/2+n+(e.calculative.worldRect.y-i.y)*r,e.calculative.worldRect.height*=r,e.calculative.worldRect.ey=e.calculative.worldRect.y+e.calculative.worldRect.height,e.calculative.height=e.calculative.worldRect.height,e.calculative.y=e.calculative.worldRect.y,e.height=e.calculative.worldRect.height,e.y=e.calculative.worldRect.y,this.canvas.updatePenRect(e,{worldRectIsReady:!1}),e.externElement&&(null==(t=e.onResize)||t.call(e,e)),null==(s=e.children)?void 0:s.length){getAllChildren(e,this.store).forEach((e=>{var t;e.externElement&&(null==(t=e.onResize)||t.call(e,e))}))}}))}else e.top?(n=-n,e.topValue&&(n+=Math.abs(e.topValue)<1?e.topValue*this.canvas.height:e.topValue),this.translatePens(t,0,n)):e.bottom&&(e.bottomValue&&(n-=Math.abs(e.bottomValue)<1?e.bottomValue*this.canvas.height:e.bottomValue),this.translatePens(t,0,n))}));const e=this.store.data.pens.filter((e=>"iframe"===e.name));null==e||e.forEach((e=>{var t,n;const s=e.calculative.worldRect;if(s.height/this.store.data.scale>.8*i.height){let i=s.height;e.calculative.worldRect.y=s.y-o/2,e.calculative.worldRect.height=s.height+o,e.calculative.worldRect.ey=s.ey+o,e.operationalRect.y=e.operationalRect.y*i/e.calculative.worldRect.width,e.operationalRect.height=(e.calculative.worldRect.height-(1-e.operationalRect.height)*i)/e.calculative.worldRect.height,null==(t=e.onBeforeValue)||t.call(e,e,{operationalRect:e.operationalRect}),null==(n=e.onResize)||n.call(e,e)}}))}this.canvas.canvasTemplate.fit=!0,this.canvas.canvasTemplate.init(),this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render(!0)}trimPens(){let e=this.store.data.pens.filter((e=>"line"===e.name&&e.anchors.length<2));this.delete(e)}fitTemplateView(e=!0,t=10){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i,s=formatPadding(t),r=this.getRect(),a=(n-s[1]-s[3])/r.width,l=(o-s[0]-s[2])/r.height;let c=a;c=e?a>l?l:a:a>l?a:l,this.canvas.templateScale(c*this.store.data.scale);let h=this.getRect(),d=this.store.data.pens.filter((e=>!e.parentId));this.canvas.templateTranslatePens(d,-h.x,-h.y),this.store.data.pens.forEach((e=>{e.type?this.canvas.initLineRect(e):this.canvas.updateLines(e)})),this.centerView()}fitSizeView(e=!0,t=10){var i,n;const{canvas:o}=this.canvas,{offsetWidth:s,offsetHeight:r}=o;this.resize(s,r);const a=formatPadding(t),l=(this.store.data.width||this.store.options.width)*this.store.data.scale,c=(this.store.data.height||this.store.options.height)*this.store.data.scale,h=(s-a[1]-a[3])/l,d=(r-a[0]-a[2])/c;let u=h;u="width"===e?h:"height"===e?d:e?h>d?d:h:h>d?h:d,(null==(i=this.store.data.fits)?void 0:i.length)&&(this.canvas.opening=!0),this.scale(u*this.store.data.scale),this.centerSizeView(),(null==(n=this.store.data.fits)?void 0:n.length)&&this.fillView()}centerSizeView(){const e=this.getViewCenter(),t={x:0,y:0,width:this.store.data.width||this.store.options.width,height:this.store.data.height||this.store.options.height};calcCenter(t);const{center:i}=t,{scale:n,origin:o,x:s,y:r}=this.store.data;this.translate((e.x-o.x)/n-i.x-s/n,(e.y-o.y)/n-i.y-r/n);const{canvas:a}=this.canvas,l=(a.scrollWidth-a.offsetWidth)/2,c=(a.scrollHeight-a.offsetHeight)/2;a.scrollTo(l,c)}scrollView(e=10,t=!1){if(!this.hasView())return;if(!this.canvas.scroll)return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i;this.resize(n,o);const s=formatPadding(e),r=this.getRect(),a=(n-s[1]-s[3])/r.width;this.scale(a*this.store.data.scale),this.topView(s[0]),t&&this.canvas.scroll.changeMode()}screenView(e=10,t=!0){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i;this.resize(n,o);const s=formatPadding(e),r=this.getRect();let a=(n-s[1]-s[3])/r.width;t||(a=(o-s[0]-s[2])/r.height),this.scale(a*this.store.data.scale),this.topView(s[0])}topView(e=10){if(!this.hasView())return;const t=this.getRect(),i=this.getViewCenter(),n=this.getPenRect(t);calcCenter(n);const{center:o}=n,{scale:s,origin:r,x:a,y:l}=this.store.data;this.translate((i.x-r.x)/s-o.x-a/s,(e-r.y)/s-n.y-l/s);const{canvas:c}=this.canvas,h=(c.scrollWidth-c.offsetWidth)/2,d=(c.scrollHeight-c.offsetHeight)/2;c.scrollTo(h,d)}centerView(){if(!this.hasView())return;const e=this.getRect(),t=this.getViewCenter(),i=this.getPenRect(e);calcCenter(i);const{center:n}=i,{scale:o,origin:s,x:r,y:a}=this.store.data;this.translate((t.x-s.x)/o-n.x-r/o,(t.y-s.y)/o-n.y-a/o);const{canvas:l}=this.canvas,c=(l.scrollWidth-l.offsetWidth)/2,h=(l.scrollHeight-l.offsetHeight)/2;l.scrollTo(c,h)}hasView(){return!!this.store.data.pens.filter((e=>!e.isRuleLine)).length}getViewCenter(){const{width:e,height:t}=this.canvas;return{x:e/2,y:t/2}}beSameByFirst(e=this.store.data.pens,t){const i=deepClone(e),n=e[0],{width:o,height:s}=this.getPenRect(n);for(let r=1;r<e.length;r++){const i=e[r];"width"===t?this.setValue({id:i.id,width:o},{render:!1,doEvent:!1}):"height"===t?this.setValue({id:i.id,height:s},{render:!1,doEvent:!1}):this.setValue({id:i.id,width:o,height:s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:e})}beSameByLast(e=this.store.data.pens,t){const i=deepClone(e),n=e[e.length-1],{width:o,height:s}=this.getPenRect(n);for(let r=0;r<e.length-1;r++){const i=e[r];"width"===t?this.setValue({id:i.id,width:o},{render:!1,doEvent:!1}):"height"===t?this.setValue({id:i.id,height:s},{render:!1,doEvent:!1}):this.setValue({id:i.id,width:o,height:s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:e})}formatPainterByFirst(e=this.store.data.pens){const t=deepClone(e),i=e[0],n={};formatAttrs.forEach((e=>{n[e]=i[e]}));for(let o=1;o<e.length;o++){const t=e[o];this.setValue({id:t.id,...n},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}formatPainterByLast(e=this.store.data.pens){const t=deepClone(e),i=e[e.length-1],n={};formatAttrs.forEach((e=>{n[e]=i[e]}));for(let o=0;o<e.length-1;o++){const t=e[o];this.setValue({id:t.id,...n},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}setFormatPainter(){const e=this.store.active,t={};if(e.length>0){const i=e[0];formatAttrs.forEach((e=>{t[e]=void 0!==i[e]?i[e]:this.store.options.defaultFormat[e]||this.store.data[e]||this.store.options[e]}))}else formatAttrs.forEach((e=>{this.store.options.defaultFormat[e]||this.store.data[e]||this.store.options[e]}));localStorage.setItem("meta2d-formatPainter",JSON.stringify(t))}formatPainter(){const e=this.store.active,t=deepClone(e),i=JSON.parse(localStorage.getItem("meta2d-formatPainter"));for(let n=0;n<e.length;n++){const t=e[n];this.setValue({id:t.id,...i},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}clearFormatPainter(){const e=this.store.active,t=deepClone(e);formatAttrs.forEach((t=>{for(let i=0;i<e.length;i++){const n=e[i],{fontSize:o,lineHeight:s}=this.store.options;"lineWidth"===t?(n.lineWidth=1,n.calculative.lineWidth=1):"fontSize"===t?(n.fontSize=o,n.calculative.fontSize=o):"lineHeight"===t?(n.lineHeight=s,n.calculative.lineHeight=s):(delete n[t],delete n.calculative[t])}})),this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}alignNodes(e,t=this.store.data.pens,i){!i&&(i=this.getPenRect(this.getRect(t)));const n=deepClone(t);for(const o of t)this.alignPen(e,o,i);this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:n,pens:t})}alignNodesV(e,t=this.store.data.pens,i=!1){const n=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;let s={x:0,y:0,width:n,height:o};const r=deepClone(t);if(i){const i=this.store.data.scale,s=this.getRect(t),r=(s.x-this.store.data.origin.x)/i,a=(s.y-this.store.data.origin.y)/i,l=s.width/i,c=s.height/i;let h=0,d=0;switch(e){case"left":h=-r;break;case"right":h=n-(r+l);break;case"top":d=-a;break;case"bottom":d=o-(a+c);break;case"center":h=n/2-(r+l/2);break;case"middle":d=o/2-(a+c/2)}this.translatePens(t,h*i,d*i)}else for(const a of t)this.alignPen(e,a,s);this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:r,pens:t})}alignNodesByFirst(e,t=this.store.data.pens){const i=deepClone(t),n=t[0],o=this.getPenRect(n);for(let s=1;s<t.length;s++){const i=t[s];this.alignPen(e,i,o)}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:t})}alignNodesByLast(e,t=this.store.data.pens){const i=deepClone(t),n=t[t.length-1],o=this.getPenRect(n);for(let s=0;s<t.length-1;s++){const i=t[s];this.alignPen(e,i,o)}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:t})}alignPen(e,t,i){const n=this.getPenRect(t);switch(e){case"left":n.x=i.x;break;case"right":n.x=i.x+i.width-n.width;break;case"top":n.y=i.y;break;case"bottom":n.y=i.y+i.height-n.height;break;case"center":n.x=i.x+i.width/2-n.width/2;break;case"middle":n.y=i.y+i.height/2-n.height/2}this.setValue({id:t.id,...n},{render:!1,doEvent:!1})}spaceBetweenByDirection(e,t=this.store.data.pens,i){if(!i){let n=1/0,o=-1/0,s="width"===e?"x":"y";t.forEach((e=>{n=Math.min(n,e.calculative.worldRect[s]),o=Math.max(o,e.calculative.worldRect["e"+s])})),i=(o-n)/this.store.data.scale}if((t=t.filter((e=>!e.parentId))).length<=2)return;const n=deepClone(t),o=(i-t.reduce(((t,i)=>t+this.getPenRect(i)[e]),0))/(t.length-1);t=t.sort(((t,i)=>"width"===e?t.x-i.x:t.y-i.y));const s=this.getPenRect(t[0]);let r="width"===e?s.x:s.y;for(const a of t){const t=this.getPenRect(a);"width"===e?t.x=r:t.y=r,r+=t[e]+o,this.setValue({id:a.id,...t},{render:!1,doEvent:!1})}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:n,pens:t})}spaceBetween(e,t){this.spaceBetweenByDirection("width",e,t)}spaceBetweenColumn(e,t){this.spaceBetweenByDirection("height",e,t)}layout(e=this.store.data.pens,t,i=30){const n=this.getPenRect(getRect$1(e));!t&&(t=n.width);const o=deepClone(e=e.filter((e=>!e.type&&!e.parentId)));let s=0;e.forEach((e=>{const t=this.getPenRect(e);t.height>s&&(s=t.height)}));let r=n.x,a=n.y;e.forEach(((o,l)=>{const c=this.getPenRect(o);if(c.x=r,c.y=a+s/2-c.height/2,this.setValue({id:o.id,...c},{render:!1,doEvent:!1}),l===e.length-1)return;const h=r+c.width-n.x,d=this.getPenRect(e[l+1]);Math.round(t-h)>=Math.round(d.width+i)?r+=c.width+i:(r=n.x,a+=s+i)})),this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:EditType.Update,initPens:o,pens:e})}gotoView(e){const t=this.getViewCenter(),i=t.x-e.calculative.worldRect.x-e.calculative.worldRect.width/2,n=t.y-e.calculative.worldRect.y-e.calculative.worldRect.height/2;this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.translate(i-this.store.data.x,n-this.store.data.y),this.store.data.x=i,this.store.data.y=n;for(const o of this.store.data.pens)calcInView(o);this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render()}showMap(){this.map||(this.map=new ViewMap(this.canvas)),this.map.show()}hideMap(){this.map.hide()}onSizeUpdate(){this.mapTimer&&(clearTimeout(this.mapTimer),this.mapTimer=void 0),this.mapTimer=setTimeout((()=>{this.map&&this.map.isShow&&this.map.show(),this.canvas&&this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.resize()}),500)}toggleAnchorMode(){this.canvas.toggleAnchorMode()}addAnchorHand(){this.canvas.addAnchorHand()}removeAnchorHand(){this.canvas.removeAnchorHand()}toggleAnchorHand(){this.canvas.toggleAnchorHand()}top(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const e=this.store.data.pens,i=[...getAllChildren(t,this.store),t].map((e=>e.id));e.filter((e=>i.includes(e.id))).forEach((t=>{const i=e.findIndex((e=>e.id===t.id));i>-1&&(e.push(e[i]),e.splice(i,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"top")}))}this.store.emitter.emit("layer",{type:"top",pens:e})}initImageCanvas(e){this.canvas&&this.canvas.initImageCanvas(e)}initTemplateCanvas(e){this.canvas&&this.canvas.initTemplateCanvas(e)}bottom(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const e=this.store.data.pens,i=[...getAllChildren(t,this.store),t].map((e=>e.id)),n=e.filter((e=>i.includes(e.id)));for(let t=n.length-1;t>=0;t--){const i=n[t],o=e.findIndex((e=>e.id===i.id));o>-1&&(e.unshift(e[o]),e.splice(o+1,1),this.initTemplateCanvas([i]),this.initImageCanvas([i])),this.specificLayerMove(i,"bottom")}}this.store.emitter.emit("layer",{type:"bottom",pens:e})}upByArea(e){if(-1===this.store.data.pens.findIndex((t=>t.id===e.id)))return;const t=[e,...getAllChildren(e,this.store)];let i=t.map((e=>this.store.data.pens.findIndex((t=>t.id===e.id))));i.includes(-1)&&(i=i.filter((e=>-1!==e)));const n=Math.min(...i),o=e.calculative.worldRect,s=this.store.data.pens.findIndex(((t,i)=>{if(i<=n)return!1;if(t.id===e.id||isAncestor(t,e))return!1;const s=t.calculative.worldRect;return rectInRect(o,s)}));if(-1!==s){this.store.data.pens.splice(s+1,0,...t);for(const e of t){const t=this.store.data.pens.findIndex((t=>t.id===e.id));t>-1&&this.store.data.pens.splice(t,1)}this.initImageCanvas([e])}else this.up(e)}specificLayerMove(e,t){var i;if(e.image&&"gif"!==e.name){let i=CanvasLayer.CanvasImageBottom;"top"===t?i=CanvasLayer.CanvasImage:"up"!==t&&"down"!==t||(i=CanvasLayer.CanvasMain),this.setValue({id:e.id,canvasLayer:i},{render:!1,doEvent:!1,history:!1})}else if(e.externElement||"gif"===e.name){let n=0;"top"===t?(e.calculative.canvas.maxZindex+=1,n=e.calculative.canvas.maxZindex):"up"===t?n=void 0===e.calculative.zIndex?6:e.calculative.zIndex+1:"down"===t&&(n=void 0===e.calculative.zIndex?3:e.calculative.zIndex-1,n<0&&(n=0)),this.setValue({id:e.id,zIndex:n},{render:!1,doEvent:!1,history:!1}),(null==(i=e.calculative.singleton)?void 0:i.div)&&setElemPosition(e,e.calculative.singleton.div)}}up(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const e=this.store.data.pens;if(t.children&&t.children.length){const i=[...getAllChildren(t,this.store),t],n=[];for(let t=0;t<e.length;t++){const o=e[t];-1!==i.findIndex((e=>e.id===o.id))&&(o.temIndex=t,n.push(o))}let o=-1,s=0;n.forEach((t=>{t.temIndex-=s,e.splice(t.temIndex,1),s+=1,o=t.temIndex,delete t.temIndex,this.specificLayerMove(t,"up")})),e.splice(o+1,0,...n),this.initTemplateCanvas(n),this.initImageCanvas(n)}else{const i=e.findIndex((e=>e.id===t.id));i>-1&&i!==e.length-1&&(e.splice(i+2,0,e[i]),e.splice(i,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"up")}}this.store.emitter.emit("layer",{type:"up",pens:e})}down(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const e=this.store.data.pens;if(t.children&&t.children.length){const i=[...getAllChildren(t,this.store),t],n=[];for(let t=0;t<e.length;t++){const o=e[t];-1!==i.findIndex((e=>e.id===o.id))&&(o.temIndex=t,n.push(o))}let o=-1,s=0;n.forEach(((t,i)=>{t.temIndex-=s,e.splice(t.temIndex,1),s+=1,0===i&&(o=t.temIndex),delete t.temIndex,this.specificLayerMove(t,"down")})),e.splice(o-1,0,...n),this.initTemplateCanvas(n),this.initImageCanvas(n)}else{const i=e.findIndex((e=>e.id===t.id));i>-1&&0!==i&&(e.splice(i-1,0,e[i]),e.splice(i+1,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"down")}}this.store.emitter.emit("layer",{type:"down",pens:e})}setLayer(e,t,i=this.store.data.pens){const n=i.findIndex((t=>t.id===e.id));n>-1&&(n>t?(i.splice(t,0,i[n]),i.splice(n+1,1)):n<t&&(i.splice(t,0,i[n]),i.splice(n,1)))}changePenId(e,t){this.canvas.changePenId(e,t)}getLines(e,t="all"){var i;if(e.type===PenType.Line)return[];const n=[];return null==(i=e.connectedLines)||i.forEach((({lineId:i})=>{const o=this.store.pens[i];if(o&&!n.find((e=>e.id===o.id)))switch(t){case"all":n.push(o);break;case"in":getToAnchor(o).connectTo===e.id&&n.push(o);break;case"out":getFromAnchor(o).connectTo===e.id&&n.push(o)}})),n}nextNode(e){if(e.type===PenType.Line){const t=this.store.pens[getToAnchor(e).connectTo];return t?[t]:[]}{const t=this.getLines(e,"out"),i=[];return t.forEach((e=>{const t=this.nextNode(e);for(const n of t){!i.find((e=>e.id===n.id))&&i.push(n)}})),i}}previousNode(e){if(e.type===PenType.Line){const t=this.store.pens[getFromAnchor(e).connectTo];return t?[t]:[]}{const t=this.getLines(e,"in"),i=[];return t.forEach((e=>{const t=this.previousNode(e);for(const n of t){!i.find((e=>e.id===n.id))&&i.push(n)}})),i}}getNext(e){var t;if(e.type===PenType.Line)return;const i=[];return null==(t=e.connectedLines)||t.forEach((({lineId:t,anchor:n})=>{var o,s;const r=null==(o=e.anchors)?void 0:o.filter((e=>e.id===n))[0],a=this.findOne(t);if(a.anchors[0].connectTo==e.id){const t=a.anchors[a.anchors.length-1].connectTo;if(t){const n=this.findOne(t),o=null==(s=n.connectedLines)?void 0:s.filter((e=>e.lineId===a.id))[0],l=n.anchors.filter((e=>e.id===o.anchor))[0];i.push({from:e,fromAnchor:r,line:a,to:n,toAnchor:l})}}})),i}addAnchor(e,t,i){if(!e)return;if(e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),e.type===PenType.Line&&(i<0&&(i=e.anchors.length+1+i),i>e.anchors.length&&(i=e.anchors.length),i<0&&(i=0),0==i&&e.anchors[0].connectTo||i==e.anchors.length&&e.anchors[i-1].connectTo))return;let n=null,o=null;t.x<=1&&t.x>=0&&t.y<=1&&t.y>=0?(o={id:t.id||s8(),penId:e.id,x:e.calculative.worldRect.x+e.calculative.worldRect.width*t.x,y:e.calculative.worldRect.y+e.calculative.worldRect.height*t.y},e.calculative.worldRect&&e.rotate%360&&rotatePoint(o,e.rotate,e.calculative.worldRect.center),n={id:o.id,penId:e.id,x:t.x,y:t.y}):(o={id:t.id||s8(),penId:e.id,x:t.x,y:t.y},e.calculative.worldRect&&(e.rotate%360&&rotatePoint(t,-e.rotate,e.calculative.worldRect.center),n={id:o.id,penId:e.id,x:(t.x-e.calculative.worldRect.x)/e.calculative.worldRect.width,y:(t.y-e.calculative.worldRect.y)/e.calculative.worldRect.height})),e.type===PenType.Line?(e.calculative.worldAnchors.splice(i,0,o),e.anchors.splice(i,0,n),this.canvas.updateLines(e),this.canvas.initLineRect(e),this.render()):(e.calculative.worldAnchors.push(o),e.anchors.push(n))}connectLine(e,t,i,n,o=!0){if(!i){const n=t.calculative.worldRect;i=nearestAnchor(e,{x:n.x+n.width/2,y:n.y+n.height/2})}if(!n){const i=e.calculative.worldRect;n=nearestAnchor(t,{x:i.x+i.width/2,y:i.y+i.height/2})}const s=Math.abs(i.x-n.x),r={height:Math.abs(i.y-n.y),lineName:"line",lineWidth:1,name:"line",type:1,width:s,x:Math.min(i.x,n.x),y:Math.min(i.y,n.y),anchors:[{x:i.x>n.x?1:0,y:i.y>n.y?1:0,id:s8()},{x:i.x>n.x?0:1,y:i.x>n.x?0:1,id:s8()}]};return this.addPens([r]),connectLine(e,i,r,r.calculative.worldAnchors[0]),connectLine(t,n,r,r.calculative.worldAnchors[1]),r.calculative.active=!1,this.canvas.updateLines(r),this.canvas.updateLines(e),this.canvas.updateLines(t),this.canvas.initLineRect(r),o&&this.render(),r}toComponent(e=this.store.data.pens,t,i){if(1===e.length){const t=deepClone(e[0]);return t.type=PenType.Node,t.id=void 0,[t]}const n=deepClone(e,!0),o=getRect$1(n);let s={id:s8(),name:"combine",...o,children:[],showChild:t};i&&(s.anchors=[{id:"0",penId:s.id,x:.5,y:0},{id:"1",penId:s.id,x:1,y:.5},{id:"2",penId:s.id,x:.5,y:1},{id:"3",penId:s.id,x:0,y:.5}]);const r=n.filter((e=>!e.parentId)),a=n.find((e=>e.width===o.width&&e.height===o.height)),l=a&&void 0===t;return 1===r.length?s=r[0]:l&&(a.children||(a.children=[]),s=a),n.forEach((e=>{if(e===s||e.parentId===s.id)return;if(e.parentId)return;s.children.push(e.id),e.parentId=s.id;const t=calcRelativeRect(e.calculative.worldRect,o);Object.assign(e,t),e.locked=e.lockedOnCombine??LockState.DisableMove})),l||1===r.length?deepClone(n):deepClone([s,...n])}installPenPlugins(e,t){if(!e.tag&&!e.name&&!e.id)return;let i;e.id?i="id":e.tag?i="tag":e.name&&(i="name"),t.forEach((t=>{let n=t.plugin,o=t.options;if(n&&validationPlugin(n)&&i)if(n.install(e,o),this.penPluginMap.has(n)){let t=this.penPluginMap.get(n).find((t=>t[i]===e[i]));t?t.option=o:this.penPluginMap.get(n).push({[i]:e[i],option:o})}else this.penPluginMap.set(n,[{[i]:e[i],option:o}])}))}uninstallPenPlugins(e,t){let i;e.id?i="id":e.tag?i="tag":e.name&&(i="name"),i&&t.forEach((t=>{let n=t.plugin;n.uninstall(e,t.options);let o=this.penPluginMap.get(n),s=o.findIndex((t=>t[i]===e[i]));-1!==s&&(o.splice(s,1),0===o.length&&this.penPluginMap.delete(n))}))}setVisible(e,t,i=!0){if(this.onSizeUpdate(),this.setValue({id:e.id,visible:t},{render:!1,doEvent:!1}),e.children)for(const o of e.children){const e=this.store.pens[o];e&&this.setVisible(e,t,!1)}let n=getAllChildren(e,this.store);n.push(e),this.initImageCanvas(n),i&&this.render()}clearHover(){this.canvas.clearHover()}closeSocket(){this.closeWebsocket(),this.closeMqtt(),this.closeHttp()}destroy(e){if(this.clear(!1),this.stopDataMock(),this.closeSocket(),this.closeNetwork(),this.closeAll(),le5leTheme.destroyThemeSheet(this.store.id),this.store.emitter.all.clear(),this.canvas.destroy(),this.canvas=void 0,globalStore[this.store.id]=void 0,!e){for(const e in globalStore)delete globalStore[e];globalStore.path2dDraws={},globalStore.canvasDraws={},globalStore.anchors={},globalStore.htmlElements={}}}}export{Meta2d as M,PenType as P,rectangle as a,getter as b,commonjsGlobal as c,deepClone as d,setter as e,formatTime as f,getDefaultExportFromCjs as g,deepSetValue as h,calcRightBottom as i,calcTextLines as j,calcTextRect as k,getTextColor as l,getFont as m,registerAnchors as n,registerCanvasDraw as o,pSBC as p,register as r,setElemPosition as s};
//# sourceMappingURL=meta2d-dfafba89.js.map
