var ct=Object.defineProperty;var ht=(e,t,i)=>t in e?ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var D=(e,t,i)=>(ht(e,typeof t!="symbol"?t+"":t,i),i);import{a as reactive,d as defineComponent,o as onMounted,q as onUnmounted,c as openBlock,e as createElementBlock,_ as _export_sfc}from"./index-5524ce56.js";function rectangle(e,t){const i=t||new Path2D;e.setTheme||(e.setTheme=setTheme);let s=e.calculative.borderRadius||0,r=s;const{x:o,y:n,width:c,height:a,ex:h,ey:l}=e.calculative.worldRect;s<1&&(s=c*s,r=a*r);let u=s<r?s:r;if(c<2*u&&(u=c/2),a<2*u&&(u=a/2),i.moveTo(o+u,n),i.arcTo(h,n,h,l,u),i.arcTo(h,l,o,l,u),i.arcTo(o,l,o,n,u),i.arcTo(o,n,h,n,u),i.closePath(),i instanceof Path2D)return i}function setTheme(e,t){if(e.affectByTheme){for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const s=t[i];e.hasOwnProperty(i)&&(e[i]=s),e.calculative.hasOwnProperty(i)&&(e.calculative[i]=s)}e.hoverTextColor=t.textPrimaryColor,e.iconColor=t.buttonBg,e.calculative.iconColor=t.buttonBg,e.hoverBackground=t.formBg,e.activeBackground=t.activeBg,e.color=t.borderColor,e.calculative.color=t.borderColor,e.textColor=t["textColor-9"],e.calculative.textColor=t["textColor-9"]}}const square=rectangle;function circle(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.ellipse(s+o/2,r+n/2,o/2,n/2,0,0,Math.PI*2),i instanceof Path2D)return i}var PenType;(function(e){e[e.Node=0]="Node",e[e.Line=1]="Line"})(PenType||(PenType={}));var LockState;(function(e){e[e.None=0]="None",e[e.DisableEdit=1]="DisableEdit",e[e.DisableMove=2]="DisableMove",e[e.DisableScale=3]="DisableScale",e[e.DisableMoveScale=4]="DisableMoveScale",e[e.Disable=10]="Disable"})(LockState||(LockState={}));var AnchorMode;(function(e){e[e.Default=0]="Default",e[e.In=1]="In",e[e.Out=2]="Out"})(AnchorMode||(AnchorMode={}));var Gradient;(function(e){e[e.None=0]="None",e[e.Linear=1]="Linear",e[e.Radial=2]="Radial"})(Gradient||(Gradient={}));var CanvasLayer;(function(e){e[e.CanvasTemplate=1]="CanvasTemplate",e[e.CanvasImageBottom=2]="CanvasImageBottom",e[e.CanvasMain=3]="CanvasMain",e[e.CanvasImage=4]="CanvasImage"})(CanvasLayer||(CanvasLayer={}));const needCalcTextRectProps=["text","textWidth","textHeight","textLeft","textTop","fontFamily","fontSize","lineHeight","fontStyle","fontWeight","textAlign","textBaseline","whiteSpace","ellipsis","keepDecimal"],needSetPenProps=["x","y","width","height","flipX","flipY"],needPatchFlagsPenRectProps=["paddingTop","paddingRight","paddingBottom","paddingLeft","flipX","flipY","visible","showChild"],needCalcIconRectProps=["iconLeft","iconTop","iconRotate"];var LineAnimateType;(function(e){e[e.Normal=0]="Normal",e[e.Beads=1]="Beads",e[e.Dot=2]="Dot",e[e.Arrow=3]="Arrow",e[e.WaterDrop=4]="WaterDrop",e[e.Custom=5]="Custom"})(LineAnimateType||(LineAnimateType={}));const isDomShapes=["gif","iframe","video","echarts","highcharts","lightningCharts","vue"],isInteraction=["radio","checkbox","button","inputDom","slider","echarts"],formatAttrs=new Set(["borderRadius","paddingLeft","paddingRight","paddingTop","paddingBottom","progress","progressColor","verticalProgress","reverseProgress","flipX","flipY","input","lineDash","lineCap","lineJoin","strokeType","lineGradientFromColor","lineGradientToColor","lineGradientAngle","color","hoverColor","activeColor","lineWidth","bkType","gradientFromColor","gradientToColor","gradientAngle","gradientRadius","hoverBackground","activeBackground","globalAlpha","anchorColor","anchorRadius","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","textHasShadow","fontFamily","fontSize","textColor","hoverTextColor","activeTextColor","textBackground","fontStyle","fontWeight","textAlign","textBaseline","lineHeight","whiteSpace","textWidth","textHeight","textLeft","textTop","ellipsis","hiddenText","keepDecimal","borderWidth","borderColor","animateLineWidth","lineAnimateType","frames","animateColor","animateType","animateReverse","background","gradientColors","lineGradientColors","animateLineWidth","gradientSmooth","lineSmooth","animations"]);function clearLifeCycle(e){e.onAdd=void 0,e.onValue=void 0,e.onBeforeValue=void 0,e.onDestroy=void 0,e.onMove=void 0,e.onResize=void 0,e.onRotate=void 0,e.onClick=void 0,e.onMouseEnter=void 0,e.onMouseLeave=void 0,e.onMouseDown=void 0,e.onMouseMove=void 0,e.onMouseUp=void 0,e.onShowInput=void 0,e.onInput=void 0,e.onChangeId=void 0,e.onBinds=void 0,e.onStartVideo=void 0,e.onPauseVideo=void 0,e.onStopVideo=void 0,e.onRenderPenRaw=void 0,e.onKeyDown=void 0,e.onContextmenu=void 0,e.onScale=void 0,e.onWheel=void 0,e.onConnectLine=void 0}var HoverType;(function(e){e[e.None=0]="None",e[e.LineAnchor=1]="LineAnchor",e[e.NodeAnchor=2]="NodeAnchor",e[e.Line=3]="Line",e[e.Node=4]="Node",e[e.Resize=5]="Resize",e[e.Rotate=6]="Rotate",e[e.LineAnchorPrev=7]="LineAnchorPrev",e[e.LineAnchorNext=8]="LineAnchorNext"})(HoverType||(HoverType={}));var HotkeyType;(function(e){e[e.None=0]="None",e[e.Translate=1]="Translate",e[e.Select=2]="Select",e[e.Resize=3]="Resize",e[e.AddAnchor=4]="AddAnchor"})(HotkeyType||(HotkeyType={}));var MouseRight;(function(e){e[e.None=0]="None",e[e.Down=1]="Down",e[e.Translate=2]="Translate"})(MouseRight||(MouseRight={}));var Direction;(function(e){e[e.None=-1]="None",e[e.Up=0]="Up",e[e.Right=1]="Right",e[e.Bottom=2]="Bottom",e[e.Left=3]="Left"})(Direction||(Direction={}));const defaultCursors=["nw-resize","ne-resize","se-resize","sw-resize"],rotatedCursors=["n-resize","e-resize","s-resize","w-resize"],defaultDrawLineFns=["curve","polyline","line"],inheritanceProps=["dash","lineWidth","lineCap","lineJoin","strokeType","color","lineGradientFromColor","lineGradientToColor","lineGradientAngle","globalAlpha","bkType","background","gradientFromColor","gradientToColor","gradientAngle","gradientRadius","fontFamily","fontSize","textColor","hoverTextColor","activeTextColor","textBackground","fontStyle","fontWeight","textAlign","textBaseline","lineHeight","whiteSpace","textLeft","textTop","flipX","flipY","lineDash","visible","iconColor"];var PrevNextType;(function(e){e[e.Mirror=0]="Mirror",e[e.Bilateral=1]="Bilateral",e[e.Free=2]="Free"})(PrevNextType||(PrevNextType={}));var TwoWay;(function(e){e[e.Default=0]="Default",e[e.In=1]="In",e[e.Out=2]="Out",e[e.DisableConnected=3]="DisableConnected",e[e.DisableConnectTo=4]="DisableConnectTo",e[e.Disable=10]="Disable"})(TwoWay||(TwoWay={}));var PointType;(function(e){e[e.Default=0]="Default",e[e.Line=1]="Line"})(PointType||(PointType={}));function rotatePoint(e,t,i){if(!t||t%360===0)return;const s=t*Math.PI/180,r=(e.x-i.x)*Math.cos(s)-(e.y-i.y)*Math.sin(s)+i.x,o=(e.x-i.x)*Math.sin(s)+(e.y-i.y)*Math.cos(s)+i.y;e.x=r,e.y=o,e.prev&&rotatePoint(e.prev,t,i),e.next&&rotatePoint(e.next,t,i)}function hitPoint(e,t,i=5,s){if(t.type===PointType.Line){let r=s.rotate;s.flipX&&(r*=-1),s.flipY&&(r*=-1);let o=t.rotate+r;return s.flipX&&(o*=-1),s.flipY&&(o*=-1),pointInRect(e,{x:t.x-t.length*s.calculative.canvas.store.data.scale/2,y:t.y-i,width:t.length*s.calculative.canvas.store.data.scale,height:i*2,rotate:o})}else return e.x>t.x-i&&e.x<t.x+i&&e.y>t.y-i&&e.y<t.y+i}function scalePoint(e,t,i){e.x=i.x-(i.x-e.x)*t,e.y=i.y-(i.y-e.y)*t}function calcRotate(e,t){if(e.x===t.x)return e.y<=t.y?0:180;if(e.y===t.y)return e.x<t.x?270:90;const i=e.x-t.x,s=e.y-t.y;let r=Math.atan(Math.abs(i/s))/(2*Math.PI)*360;return i>0&&s>0?r=180-r:i<0&&s>0?r+=180:i<0&&s<0&&(r=360-r),r}function distance(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}function facePoint(e,t){let i=Direction.None;if(!t)return i;const s=e.x-t.x,r=e.y-t.y;return Math.abs(s)>Math.abs(r)?s>0?i=Direction.Right:i=Direction.Left:r>0?i=Direction.Bottom:i=Direction.Up,i}function translatePoint(e,t,i){e&&(e.x+=t,e.y+=i,e.next&&(e.next.x+=t,e.next.y+=i),e.prev&&(e.prev.x+=t,e.prev.y+=i))}function samePoint(e,t){return e.anchorId===t.anchorId&&e.connectTo===t.connectTo}function getDistance(e,t,i){let s=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))/i.data.scale;t.rotate===0?e.x<t.x?i.pens[t.penId].flipX||(s*=-1):i.pens[t.penId].flipX&&(s*=-1):e.y<t.y?i.pens[t.penId].flipY||(s*=-1):i.pens[t.penId].flipY&&(s*=-1),e.distance=s}const name="@meta2d/core",version="1.0.81",description="@meta2d/core: Powerful, Beautiful, Simple, Open - Web-Based 2D At Its Best .",main="index.js",types="index.d.ts",scripts={copy:"copyfiles  package.json ../../dist/core/",build:"tsc && npm run copy"},keywords=["meta2d","diagram","2D","canvas"],author="alsmile123@qq.com",license="MIT",repository={type:"git",url:"git+https://github.com/le5le-com/meta2d.js.git"},bugs={url:"https://github.com/le5le-com/meta2d.js/issues"},homepage="https://github.com/le5le-com/meta2d.js#readme",devDependencies={"@types/marked":"^4.0.3","@types/offscreencanvas":"latest","@types/zrender":"^4.0.0"},dependencies={mitt:"^2.1.0",mqtt:"^4.2.6"},publishConfig={access:"public"},gitHead="78f2a53ca1839c89b56e2e498d17ba4eb987ad14",pkg={name,version,description,main,types,scripts,keywords,author,license,repository,bugs,homepage,devDependencies,dependencies,publishConfig,gitHead},globalStore={version:pkg.version,path2dDraws:{},canvasDraws:{},anchors:{},lineAnimateDraws:{},htmlElements:{}};function register(e){Object.assign(globalStore.path2dDraws,e)}function registerCanvasDraw(e){Object.assign(globalStore.canvasDraws,e)}function registerAnchors(e){Object.assign(globalStore.anchors,e)}function mitt(e){return{all:e=e||new Map,on:function(t,i){var s=e.get(t);s&&s.push(i)||e.set(t,[i])},off:function(t,i){var s=e.get(t);s&&s.splice(s.indexOf(i)>>>0,1)},emit:function(t,i){(e.get(t)||[]).slice().map(function(s){s(i)}),(e.get("*")||[]).slice().map(function(s){s(t,i)})}}}var KeydownType;(function(e){e[e.None=-1]="None",e[e.Document=0]="Document",e[e.Canvas=1]="Canvas"})(KeydownType||(KeydownType={}));const defaultOptions={fontFamily:'"Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial',fontSize:12,lineHeight:1.5,textAlign:"center",textBaseline:"middle",color:"#222222",activeColor:"#278df8",hoverColor:"rgba(39,141,248,0.50)",anchorColor:"#278DF8",hoverAnchorColor:"#FF4101",anchorRadius:4,anchorBackground:"#fff",dockColor:"rgba(39,141,248,0.50)",dockPenColor:"#1890FF",dragColor:"#1890ff",rotateCursor:"rotate.cur",rightCursor:"right.cur",downCursor:"down.cur",hoverCursor:"pointer",minScale:.1,maxScale:10,keydown:KeydownType.Document,gridSize:20,gridColor:"#e2e2e2",ruleColor:"#888888",drawingLineName:"curve",interval:30,animateInterval:30,autoPolyline:!0,autoAnchor:!0,autoAlignGrid:!1,animateColor:"#30EEDC",ruleLineColor:"#FF4101",shadowOffsetX:0,shadowOffsetY:0,shadowBlur:64,shadowColor:"#00000014",globalAlpha:1,defaultAnchors:[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],measureTextWidth:!0,moveConnectedLine:!0,mouseRightActive:!0,disableClipboard:!1,drawingLineLength:0,disableTouchPadScale:!1,cdn:"",polylineSpace:10,domShapes:[],containerShapes:["tablePlus"],textFlip:!0,textRotate:!0,unavailableKeys:[],diagramOptions:{},svgPathStroke:!0,reconnetTimes:10},themeKeys=["color","hoverColor","activeColor","disabledColor","background","activeBackground","hoverBackground","disabledBackground","anchorColor","hoverAnchorColor","anchorBackground","animateColor","textColor","ruleColor","ruleLineColor","gridColor","lineColor","penBackground","dockPenColor"],defaultTheme={dark:{color:"#bdc7db",background:"#1e2430",parentBackground:"#080b0f",ruleColor:"#222E47",ruleOptions:{background:"#121924",textColor:"#6E7B91"}},light:{color:"#222222",background:"#FFFFFF",parentBackground:"#F0F1F2",ruleColor:"#C8D0E1",ruleOptions:{background:"#F7F8FA",textColor:"#C8D0E1"}}},le5leTheme={cssRuleSelector:":root",style_prefix:"le5le_",vendor_css_prefix:"--le-",dark:["textColor-9: rgba(255,255,255,0.90)","textColor-6: rgba(255,255,255,0.60)","textColor-1: rgba(255,255,255,1)","textColor-4: rgba(255,255,255,0.40)","textPrimaryColor: #7f838c","textSecondColor: rgba(255,255,255,0.90)","textDisabledColor: rgba(255,255,255,0.40)","textActiveColor: #0052d9","buttonBg: #4583ff","buttonDisabledBg: #0057CC","buttonDisabledColor: #FFFFFF26","buttonGradient: linear-gradient(360deg,#4583ff, #33ccff)","containerBg: rgba(21,24,28,0.95)","tabBg: #303746","tabActiveBg: #4583ff","tabDisabledBg: #282e3b","tabDisabledColor: rgba(255,255,255,0.26)","tabActiveColor: rgba(255,255,255,0.90)","formBg: #2a2f36","datePickerCellActiveRangeBg: #2c4475","componentDisabledBg: #282e3b","dataPickerCellActiveBg: #001b52","activeBg: #25375b","popContentBg: #252b37","disabledBg: #7f838c","disabledBg-2: #282E3B","tableStripeColor: rgba(150,192,255,0.10)","tableMenuBg: #303746","tableMenuDividerBg: rgb(76 81 94)","tableMenuHandleBg: #454f64","tableMenuColor: #bdc7db","tableMenuBorderColor: transparent","tableColRowBg: #303746","tableColRowActiveBg: #4A5263","tableColRowColor: rgba(255,255,255,0.6)","paginationColor: rgba(255,255,255,0.6)","paginationActiveColor: #4583ff","paginationActiveBg: rgba(69,131,255,0.20)","sliderBg: #303746","sliderBtnBg: #000000","notificationBorderColor: transparent","notificationBg: #282e3b","borderColor: #424b61","borderOutsideColor: #4583ff","formBorderColor: #424b61","borderInsideColor: rgba(255,255,255,0.40)","shadow: 0px 1px 10px 0px rgba(0,0,0,0.05), 0px 4px 5px 0px rgba(0,0,0,0.08), 0px 2px 4px -1px rgba(0,0,0,0.12)","radius: 4px"],light:["textColor-9: rgba(0,0,0,0.90)","textColor-6: rgba(0,0,0,0.60)","textColor-1: rgba(0,0,0,1)","textColor-4: rgba(0,0,0,0.40)","textPrimaryColor: #7f838c","textSecondColor: #171B27","textDisabledColor: rgba(0, 0, 0, 0.6)","textActiveColor: #0052d9","buttonBg: #4583ff","buttonDisabledBg: #b5c7ff","buttonDisabledColor: #FFFFFF","buttonGradient: linear-gradient(360deg,#4583ff, #33ccff)","containerBg: #ffffff","tabBg: #f1f2f5","tabActiveBg: #4583ff","tabDisabledBg: #e2e6ea","tabDisabledColor: rgba(0,0,0,0.26)","tabActiveColor: #ffffff","formBg: #EFF1F4","datePickerCellActiveRangeBg: #f2f3ff","componentDisabledBg: #eee","dataPickerCellActiveBg: #edefff","activeBg: #f2f3ff","popContentBg: #ffffff","disabledBg: #7f838c","disabledBg-2: #E2E6EA","tableStripeColor: #f1f2f5","tableMenuBg: #ffffff","tableMenuDividerBg: #e2e6ea","tableMenuHandleBg: #ebedf1","tableMenuColor: rgba(0,0,0,0.60)","tableMenuBorderColor: #e2e6ea","tableColRowBg: #ebedf1","tableColRowActiveBg: #bcc4d0","tableColRowColor: rgba(0,0,0,0.4)","paginationColor: rgba(0,0,0,0.6)","paginationActiveColor: #ffffff","paginationActiveBg: #4583ff","sliderBg: #e2e6ea","sliderBtnBg: #ffffff","notificationBorderColor: transparent","notificationBg: #ffffff","borderColor: #d6dbe3","borderOutsideColor: #d6dbe3","formBorderColor: #d4d6d9","borderInsideColor: #e7e7e7","shadow: 0px 2px 4px 0px rgba(107,113,121,0.25)","radius: 4px"],camelCaseToHyphenated(e){return e.replace(/[A-Z]/g,t=>"-"+t.toLowerCase())},_addVendorCssPrefix(e){return e.map(t=>{const[i,s]=t.split(":");return`${this.vendor_css_prefix}${this.camelCaseToHyphenated(i.trim())}:${s.trim()}`})},createThemeSheet(e,t){const i=document.createElement("style");i.type="text/css",i.id=this.style_prefix+t,document.head.appendChild(i);const s=e||"dark",r=this.getTheme(s),o=`${this.cssRuleSelector} { ${r.join(";")} }`;i.innerHTML=o},destroyThemeSheet(e){const t=this.findStyleSheet(this.style_prefix+e);t&&document.head.removeChild(t.ownerNode)},addTheme(e,t){Object.assign(this,{[e]:t})},getTheme(e){return this._addVendorCssPrefix(this[e]||this.light)},getThemeObj(e="dark"){const t=":";return this[e].reduce((s,r)=>{const[o,n]=r.split(t);return s[o]=n,s},{})},findStyleSheet(e){const t=document.styleSheets;for(let i=0;i<t.length;i++){const s=t[i];if(s.ownerNode&&s.ownerNode.id===e)return s}return null},updateCssRule(e,t){const s=this.getTheme(t),r=this.findStyleSheet(this.style_prefix+e);if(!r)return;let o=!1;for(let n=0;n<r.cssRules.length;n++)if(r.cssRules[n].selectorText===this.cssRuleSelector){o=!0;break}if(o)for(let n=0;n<r.cssRules.length;n++){const c=r.cssRules[n];if(c.selectorText===this.cssRuleSelector)if(r.insertRule){r.deleteRule(n);const a=`${this.cssRuleSelector} { ${s.join(";")} }`;r.insertRule(a,n)}else r.addRule&&(c.style.cssText=s.join(";"))}else if(r.insertRule){const n=`${this.cssRuleSelector} { ${s.join(";")} }`;r.insertRule(n,r.cssRules.length)}else if(r.addRule){const n=r.cssRules.find(c=>c.selectorText===this.cssRuleSelector);if(n){const c=s.join(";");n.style.cssText+=`; ${c}`}else r.addRule(this.cssRuleSelector,s.join(";"))}}};var EditType;(function(e){e[e.Add=0]="Add",e[e.Update=1]="Update",e[e.Delete=2]="Delete",e[e.Replace=3]="Replace"})(EditType||(EditType={}));const createStore=()=>({data:{x:0,y:0,scale:1,pens:[],origin:{x:0,y:0},center:{x:0,y:0},paths:{}},histories:[],pens:{},path2dMap:new WeakMap,animateMap:new WeakMap,active:[],animates:new Set,options:{...defaultOptions},theme:{...defaultTheme},emitter:mitt(),bindDatas:{},bind:{},pensNetwork:{},cacheDatas:[],messageEvents:{},templatePens:{},globalTriggers:{}}),useStore=(e="default")=>(globalStore[e]||(globalStore[e]=createStore(),globalStore[e].id=e),globalStore[e]),clearStore=(e,t)=>{const i=e.data.template===t;if(i)for(const s of e.data.pens)s.canvasLayer===CanvasLayer.CanvasTemplate&&(e.templatePens[s.id]=s);e.lastScale=e.data.scale,e.data={x:0,y:0,scale:1,pens:[],origin:{x:0,y:0},center:{x:0,y:0},paths:{},template:i?t:null,lineAnimateDraws:{}},e.sameTemplate=i,e.pens={},e.histories=[],e.historyIndex=null,e.path2dMap=new WeakMap,e.animateMap=new WeakMap,e.bindDatas={},e.bind={},e.pensNetwork={},e.active=[],e.hover=void 0,e.lastHover=void 0,e.animates.clear()};function calcTextRect(e){const{paddingTop:t,paddingBottom:i,paddingLeft:s,paddingRight:r,worldRect:o,canvas:n}=e.calculative;let{textLeft:c,textTop:a,textWidth:h,textHeight:l}=e.calculative,u=s,d=t;const f=o.width-s-r,g=o.height-t-i;h&&h<1&&(h*=o.width),l&&l<1&&(l*=o.height),h<e.calculative.fontSize&&(h=e.calculative.fontSize),u+=(c||0)+o.x,d+=(a||0)+o.y;const y=e.textAlign||n.store.options.textAlign,v=e.textBaseline||n.store.options.textBaseline;switch(y){case"center":u+=(f-(h||f))/2;break;case"right":u+=f-(h||f);break}switch(v){case"middle":d+=(g-(l||g))/2;break;case"bottom":d+=g-(l||g);break}const b={x:u,y:d,width:h||f,height:l||g};calcRightBottom(b),e.calculative.worldTextRect=b,calcTextLines(e),e.calculative.textDrawRect=void 0}function calcTextDrawRect(e,t){const i=t.calculative.fontSize*t.calculative.lineHeight,s=t.calculative.textLines.length*i,r=calcTextAdaptionWidth(e,t),o=t.calculative.worldTextRect;let n=o.x+(o.width-r)/2,c=o.y+(o.height-s)/2;const a=t.calculative.canvas.store.options;switch(t.textAlign||a.textAlign){case"left":n=o.x;break;case"right":n=o.x+o.width-r;break}switch(t.textBaseline||a.textBaseline){case"top":c=o.y;break;case"bottom":c=o.ey-s;break}t.calculative.textDrawRect={x:n,y:c,width:r,height:s},calcRightBottom(t.calculative.textDrawRect)}function calcTextLines(e,t=e.calculative.text){if(t==null){e.calculative.textLines=[];return}t=t.toString();const i=e.calculative.keepDecimal;if(i!=null){const a=Number(t);isNaN(a)||(t=a.toFixed(i))}let s=[];const r=e.calculative.fontSize*e.calculative.lineHeight,o=e.calculative.worldTextRect.height,n=Math.floor(o/r),c=n>1?n:1;switch(e.whiteSpace){case"nowrap":if(e.ellipsis!==!1){const l=wrapLines(t.split(""),e);l[0]&&(s.push(l[0]),l.length>1&&setEllipsisOnLastLine(s))}else s.push(t);break;case"pre-line":s=t.split(/[\n]/g),e.ellipsis!==!1&&s.length>c&&(s=s.slice(0,c),setEllipsisOnLastLine(s));break;case"break-all":default:const a=t.split(/[\n]/g);let h=0;t:for(const l of a){const u=e.whiteSpace==="break-all"?l.split(""):getWords(l);let d=wrapLines(u,e);if(d.length===0&&(d=[""]),e.ellipsis!=!1)for(const f of d)if(h++,h>c){setEllipsisOnLastLine(s);break t}else s.push(f);else s.push(...d)}break}return e.calculative.textLines=s,s}function getWords(e=""){const t=[];let i="";for(let s=0;s<e.length;++s){const r=e.charCodeAt(s);r<33||r>126?(i&&(t.push(i),i=""),t.push(e[s])):i+=e[s]}return i&&t.push(i),t}function wrapLines(e,t){const i=t.calculative.canvas,s=i.offscreen.getContext("2d"),{fontStyle:r,fontWeight:o,fontSize:n,fontFamily:c,lineHeight:a}=t.calculative;s.save();const h=[];let l=e[0]||"";for(let u=1;u<e.length;++u){const d=e[u]||"",f=l+d;let g=0;if(i.store.options.measureTextWidth)s.font=getFont({fontStyle:r,fontWeight:o,fontFamily:c||i.store.options.fontFamily,fontSize:n,lineHeight:a}),g=s.measureText(f).width;else{const v=f.match(/[^\x00-\xff]/g)||"",b=v.length*n,x=f.match(/\s/g)||"",m=x.length*n*.3,T=(f.length-v.length-x.length)*n*.6;g=b+m+T}const y=t.calculative.worldTextRect.width;g<=y+.1?l+=d:(l.length&&h.push(l),l=d)}return l.length&&h.push(l),s.restore(),h}function calcTextAdaptionWidth(e,t){let i=0;return t.calculative.textLineWidths=[],t.calculative.textLines.forEach(s=>{const r=e.measureText(s).width;t.calculative.textLineWidths.push(r),i<r&&(i=r)}),i}function setEllipsisOnLastLine(e){e[e.length-1]=e[e.length-1].slice(0,-3)+"..."}function calcTextAutoWidth(e){let t=e.text.split(`
`);const i=e.calculative.canvas,s=i.offscreen.getContext("2d"),{fontStyle:r,fontWeight:o,fontSize:n,fontFamily:c,lineHeight:a}=e.calculative;let h=0,l=0;s.save();for(let d=0;d<t.length;d++){if(i.store.options.measureTextWidth)s.font=getFont({fontStyle:r,fontWeight:o,fontFamily:c||i.store.options.fontFamily,fontSize:n,lineHeight:a}),l=s.measureText(t[d]).width;else{const f=t[d].match(/[^\x00-\xff]/g)||"",g=f.length*n,y=t[d].match(/\s/g)||"",v=y.length*n*.3,b=(t[d].length-f.length-y.length)*n*.6;l=g+v+b}l>h&&(h=l)}s.restore();let u=t.length*n*a;e.textAlign==="left"||(e.textAlign==="right"?e.x=e.x-(h-e.width):e.x=e.x-(h-e.width)/2),e.textBaseline==="top"||(e.textBaseline==="bottom"?e.y=e.y-(u-e.height):e.y=e.y-(u-e.height)/2),e.height=u+5,e.width=h+5,e.calculative.canvas.updatePenRect(e),e.calculative.canvas.calcActiveRect()}function deepClone(e,t=!1){if(Array.isArray(e)){const i=[];return e.forEach(s=>{i.push(deepClone(s,t))}),i}else if(typeof e=="object"){if(e===null)return null;if(e.constructor===RegExp)return e;const i={};for(const s in e)if(!(["canvas","lastFrame"].includes(s)||e[s]instanceof HTMLImageElement||e[s]instanceof HTMLMediaElement)){{if(s==="calculative"&&!t)continue;if(s==="singleton"){t?i[s]={}:i[s]=e[s];continue}}i[s]=deepClone(e[s],t)}return i}return e}const arrows={};function renderFromArrow(e,t,i){if(!arrows[t.fromArrow])return;const s=getFromAnchor(t),{x:r,y:o}=s,n={x:r,y:o};if(n.step=(t.fromArrowSize||10)*i.data.scale,s.next)n.rotate=calcRotate(s.next,s)+90;else{const a=t.calculative.worldAnchors[1];if(!a)return;a.prev?n.rotate=calcRotate(a.prev,s)+90:n.rotate=calcRotate(a,s)+90}e.save(),e.beginPath(),e.setLineDash([]);const c=t.fromArrowColor||t.calculative.color;c&&(e.strokeStyle=c),arrows[t.fromArrow](e,t,i,n),e.restore()}function renderToArrow(e,t,i){if(!arrows[t.toArrow]||t.calculative.worldAnchors.length<2)return;e.save();const s=getToAnchor(t),{x:r,y:o}=s,n={x:r,y:o};if(n.step=(t.toArrowSize||10)*i.data.scale,s.prev)n.rotate=calcRotate(s.prev,s)+90;else{const a=t.calculative.worldAnchors[t.calculative.worldAnchors.length-2];a.next?n.rotate=calcRotate(a.next,s)+90:n.rotate=calcRotate(a,s)+90}e.beginPath(),e.setLineDash([]);const c=t.toArrowColor||t.calculative.color;c&&(e.strokeStyle=c),arrows[t.toArrow](e,t,i,n),e.restore()}arrows.triangleSolid=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step;e.moveTo(r,s.y-s.step/4),e.lineTo(s.x,s.y),e.lineTo(r,s.y+s.step/4),e.closePath(),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()};arrows.reTriangleSolid=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step/2;e.moveTo(s.x,s.y-s.step/2),e.lineTo(r,s.y),e.lineTo(s.x,s.y+s.step/2),e.closePath(),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()};arrows.triangle=(e,t,i,s)=>{e.save(),e.lineWidth<2&&(e.lineWidth=2),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step;e.moveTo(r,s.y-s.step/4),e.lineTo(s.x,s.y),e.lineTo(r,s.y+s.step/4),e.closePath(),e.stroke(),e.fillStyle=i.data.background||"#ffffff",e.fill(),e.restore()};arrows.circleSolid=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.step/2;e.arc(s.x-r,s.y,r,0,2*Math.PI),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()};arrows.circle=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.step/2;e.arc(s.x-r,s.y,r,0,2*Math.PI),e.stroke(),e.fillStyle=i.data.background||"#ffffff",e.fill(),e.restore()};arrows.diamondSolid=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step,o=s.step/2;e.moveTo(r,s.y),e.lineTo(r+o,s.y-o/2),e.lineTo(s.x,s.y),e.lineTo(r+o,s.y+o/2),e.closePath(),e.stroke(),e.fillStyle=e.strokeStyle,e.fill(),e.restore()};arrows.diamond=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step,o=s.step/2;e.moveTo(r,s.y),e.lineTo(r+o,s.y-o/2),e.lineTo(s.x,s.y),e.lineTo(r+o,s.y+o/2),e.closePath(),e.stroke(),e.fillStyle=i.data.background||"#ffffff",e.fill(),e.restore()};arrows.line=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step;e.moveTo(r,s.y-s.step/3),e.lineTo(s.x,s.y),e.lineTo(r,s.y+s.step/3),e.stroke(),e.restore()};arrows.lineUp=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step;e.moveTo(r,s.y-s.step/3),e.lineTo(s.x,s.y),e.stroke(),e.restore()};arrows.lineDown=(e,t,i,s)=>{e.save(),e.translate(s.x,s.y),e.rotate(s.rotate*Math.PI/180),e.translate(-s.x,-s.y);const r=s.x-s.step;e.moveTo(r,s.y+s.step/3),e.lineTo(s.x,s.y),e.stroke(),e.restore()};function pSBCr(e){const t=parseInt,i=Math.round;let s=e.length,r={};if(s>9){const[o,n,c,a]=e=e.split(",");if(s=e.length,s<3||s>4)return null;r.r=t(o[3]=="a"?o.slice(5):o.slice(4)),r.g=t(n),r.b=t(c),r.a=a?parseFloat(a):-1}else{if(s==8||s==6||s<4)return null;s<6&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+(s>4?e[4]+e[4]:"")),e=t(e.slice(1),16),s==9||s==5?(r.r=e>>24&255,r.g=e>>16&255,r.b=e>>8&255,r.a=i((e&255)/.255)/1e3):(r.r=e>>16,r.g=e>>8&255,r.b=e&255,r.a=-1)}return r}function pSBC(e,t,i,s){let r,o,n,c,a,h,l,u=Math.round,d=typeof i=="string";return typeof e!="number"||e<-1||e>1||typeof t!="string"||t[0]!="r"&&t[0]!="#"||i&&!d||(l=t.length>9,l=d?i.length>9?!0:i=="c"?!l:!1:l,a=pSBCr(t),c=e<0,h=i&&i!="c"?pSBCr(i):c?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},e=c?e*-1:e,c=1-e,!a||!h)?null:(s?(r=u(c*a.r+e*h.r),o=u(c*a.g+e*h.g),n=u(c*a.b+e*h.b)):(r=u((c*a.r**2+e*h.r**2)**.5),o=u((c*a.g**2+e*h.g**2)**.5),n=u((c*a.b**2+e*h.b**2)**.5)),d=a.a,h=h.a,a=d>=0||h>=0,d=a?d<0?h:h<0?d:d*c+h*e:0,l?"rgb"+(a?"a(":"(")+r+","+o+","+n+(a?","+u(d*1e3)/1e3:"")+")":"#"+(4294967296+r*16777216+o*65536+n*256+(a?u(d*255):0)).toString(16).slice(1,a?void 0:-2))}globalThis.pSBC=pSBC;function rgba(e,t){const i=pSBCr(e)||{r:0,g:0,b:0};return i.a<0?`rgba(${i.r},${i.g},${i.b},${t})`:`rgba(${i.r},${i.g},${i.b},${t+i.a})`}function valueInRange(e,t){if(isNaN(e)){console.warn("realValue not number");return}if(typeof t!="string"){console.warn("collection must be string");return}const[i,s]=[t[0],t[t.length-1]];if(!["[","("].includes(i)){console.warn('collection must start with "[" or "("');return}if(!["]",")"].includes(s)){console.warn('collection must end with "]" or ")"');return}const r=t.substring(1,t.length-1).split(",");if(r.length!==2){console.warn("collection must have 2 numbers");return}const[o,n]=[+r[0],+r[1]];if(o>=n){console.warn("startNum must less than endNum");return}return e>o||i==="["&&e===o?e<n||s==="]"&&e===n:!1}function valueInArray(e,t){if(typeof t!="string"){console.warn("collection must be string");return}const[i,s]=[t[0],t[t.length-1]];if(i!=="["||s!=="]"){console.warn('collection must start with "[" and end with "]"');return}const r=t.substring(1,t.length-1).split(",");for(const o of r)if(o.includes("..")){const[n,c]=o.split(".."),[a,h]=[+n,+c];if(a>=h){console.warn("startNum must less than endNum");return}if(e>=a&&e<=h)return!0}else if(e==o)return!0;return!1}function cubicBezierY(e,t,i){const s=1-e;return 3*s*s*e*t+3*s*e*e*i+e*e*e}function s8(){return((1+Math.random())*4294967296|0).toString(16).substring(1)}const formatPadding=e=>{let t=0,i=0,s=0,r=0;return typeof e=="number"?t=i=s=r=e:typeof e=="string"?t=i=s=r=parseInt(e,10):Array.isArray(e)&&(t=e[0],s=isNil(e[1])?e[0]:e[1],r=isNil(e[2])?e[0]:e[2],i=isNil(e[3])?s:e[3]),[t,s,r,i]};function isNil(e){return e==null}async function fileToBase64(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=r=>{t(r.target.result)},s.onerror=r=>{i(r)},s.readAsDataURL(e)})}async function uploadFile(e,t,i,s){const r=new FormData;if(r.append("file",e),i)for(const n in i)i.hasOwnProperty(n)&&r.append(n,i[n]);return(await(await fetch(t,{method:"POST",headers:s,body:r})).json()).url}function loadCss(e,t,i){var s=document.createElement("link");s.href=e,s.rel="stylesheet",t&&(s.onload=t),i&&(s.onerror=i),document.head.appendChild(s)}function queryURLParams(e){let t=e||window.location.search.split("?")[1];const i=new URLSearchParams(t);return Object.fromEntries(i.entries())}function getCookie(e){let t;const i=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(i))?decodeURIComponent(t[2]):""}var TokenType;(function(e){e[e.None=0]="None",e[e.LocalStorage=1]="LocalStorage",e[e.Cookie=2]="Cookie"})(TokenType||(TokenType={}));const isLe5le=location.host.indexOf("le5le.com")!==-1;function getToken(){const e=globalThis.le5leTokenName??"token";switch(globalThis.le5leTokenType){case TokenType.LocalStorage:return localStorage.getItem(e);case TokenType.Cookie:return getCookie(e);default:return isLe5le?getCookie(e):localStorage.getItem(e)}}async function getMeta2dData(e,t){var a,h;if(globalThis.getMeta2dData)return await globalThis.getMeta2dData(t);const i=e.options.navigatorNetWork;let r=`/api/data/${location.href.includes("2d.")||location.href.includes("/2d")?"2d":"v"}/get`,o=((a=queryURLParams())==null?void 0:a.id)||r.includes("${id}");if(!o&&((h=queryURLParams())==null?void 0:h.data)){r=`./projects/${t}`;const u=new URL(window.location);u.searchParams.set("data",t),history.pushState({},"",u)}i!=null&&i.url&&(i.url.includes("${id}")?r=i.url.replace("${id}",t):r=i.url+((i==null?void 0:i.method)==="GET"?`?id=${t}`:""));let n=(i==null?void 0:i.method)||"POST";o||(n="GET");const c=await fetch(r,{headers:{Authorization:`Bearer ${getToken()}`},method:n,body:n==="GET"?void 0:JSON.stringify({id:t})});if(c.ok){let l=await c.text();return l.constructor===Object||l.constructor===Array?l=JSON.parse(JSON.stringify(l)):typeof l=="string"&&(l=JSON.parse(l)),l.data&&(l=l.data),l}else e.emitter.emit("error",{type:"http",error:c})}function getter(e,t){if(t==null)return e;const i=t.split(".");for(;i.length&&(e=e[i.shift()]););return e}function setter(e,t,i){t!=null&&t.split(".").reduce((s,r,o)=>s[r]=t.split(".").length===++o?i:s[r]||{},e)}function isAncestor(e,t){if(!e||!t)return!1;let i=getParent(e);for(;i;){if(i.id===t.id)return!0;i=getParent(i)}return!1}function getParent(e,t){if(!e||!e.parentId||!e.calculative)return;const s=e.calculative.canvas.store.pens[e.parentId];return t&&getParent(s,t)||s}function getAllChildren(e,t){if(!e||!e.children)return[];const i=[];return e.children.forEach(s=>{const r=t.pens[s];r&&(i.push(r),i.push(...getAllChildren(r,t)))}),i}function getAllFollowers(e,t){if(!e||!e.followers)return[];const i=[];return e.followers.forEach(s=>{const r=t.pens[s];r&&!r.parentId&&(i.push(r),i.push(...getAllFollowers(r,t)))}),i}function drawBkLinearGradient(e,t){const{worldRect:i,gradientFromColor:s,gradientToColor:r,gradientAngle:o}=t.calculative;return linearGradient(e,i,s,r,o)}function drawBkRadialGradient(e,t){const{worldRect:i,gradientFromColor:s,gradientToColor:r,gradientRadius:o}=t.calculative;if(!s||!r)return;const{width:n,height:c,center:a}=i,{x:h,y:l}=a;let u=n;u<c&&(u=c),u*=.5;const d=e.createRadialGradient(h,l,u*(o||0),h,l,u);return d.addColorStop(0,s),d.addColorStop(1,r),d}function getLinearGradientPoints(e,t,i,s,r){let o=0;o=Math.PI/2-Math.atan2(s-t,i-e);const n=(e+i)/2,c=(t+s)/2,a=n+r*Math.sin(90*Math.PI/180-o),h=c+r*-Math.cos(90*Math.PI/180-o),l=n+r*Math.sin(270*Math.PI/180-o),u=c+r*-Math.cos(270*Math.PI/180-o);return[a,h,l,u]}function getBkRadialGradient(e,t){const{worldRect:i,gradientColors:s,gradientRadius:r}=t.calculative;if(!s)return;let o=t.calculative.gradientColors;t.calculative.checked&&(o=t.calculative.onGradientColors);const{width:n,height:c,center:a}=i,{x:h,y:l}=a;let u=n;u<c&&(u=c),u*=.5;const{colors:d}=formatGradient(o),f=e.createRadialGradient(h,l,u*(r||0),h,l,u);return d.forEach(g=>{f.addColorStop(g.i,g.color)}),f}function getBkGradient(e,t){const{x:i,y:s,ex:r,width:o,height:n,center:c}=t.calculative.worldRect;let a=[{x:r,y:s+n/2},{x:i,y:s+n/2}],h=t.calculative.gradientColors;t.calculative.checked&&(h=t.calculative.onGradientColors);const{angle:l,colors:u}=formatGradient(h);let d=getGradientR(l,o,n);return a.forEach(f=>{rotatePoint(f,l,c)}),getLinearGradient(e,a,u,d)}function getTextRadialGradient(e,t){const{worldRect:i,textGradientColors:s}=t.calculative;if(!s)return;const{width:r,height:o,center:n}=i,{x:c,y:a}=n;let h=r;h<o&&(h=o),h*=.5;const{colors:l}=formatGradient(s),u=e.createRadialGradient(c,a,0,c,a,h);return l.forEach(d=>{u.addColorStop(d.i,d.color)}),u}function getTextGradient(e,t){const{x:i,y:s,ex:r,width:o,height:n,center:c}=t.calculative.worldRect;let a=[{x:r,y:s+n/2},{x:i,y:s+n/2}];const{angle:h,colors:l}=formatGradient(t.calculative.textGradientColors);let u=getGradientR(h,o,n);return a.forEach(d=>{rotatePoint(d,h,c)}),getLinearGradient(e,a,l,u)}function getGradientR(e,t,i){const s=Math.atan(i/t)/Math.PI*180;let r=(e-90)%360,o=0;return r>s&&r<180-s||r>180+s&&r<360-s||r<0?(r>270?r=360-r:r>180?r=r-180:r>90&&(r=180-r),o=Math.abs(i/Math.sin(r/180*Math.PI)/2)):(r>270?r=360-r:r>180?r=r-180:r>90&&(r=180-r),o=Math.abs(t/Math.cos(r/180*Math.PI)/2)),o}function formatGradient(e){if(typeof e=="string"&&e.startsWith("linear-gradient")){let t=e.slice(16,-2).split("deg,");if(t.length>1){let i=t[1].split("%,");const s=[];return i.forEach(r=>{if(/rgba?/.test(r)){let o=r.split(") ");s.push({color:rgbaToHex(o[0]+")"),i:parseFloat(o[1])/100})}else{let o=r.split(" ");o.length>2?s.push({color:o[1],i:parseFloat(o[2])/100}):s.push({color:o[0],i:parseFloat(o[1])/100})}}),{angle:parseFloat(t[0]),colors:s}}else return{angle:parseFloat(t[0]),colors:[]}}else return{angle:0,colors:[]}}function rgbaToHex(e){if(/rgba?/.test(e)){let t=e.split(",");if(t.length<3)return"";e="#";for(let i=0,s;s=t[i++];)if(i<4)s=parseInt(s.replace(/[^\d]/gi,""),10).toString(16),e+=s.length==1?"0"+s:s;else{s=s.replace(")","");let o=parseInt(s*255+"").toString(16);o=o.length===2?o:"0"+o,e+=o}e=e.toUpperCase()}return e}function getLineGradient(e,t){const{x:i,y:s,ex:r,width:o,height:n,center:c}=t.calculative.worldRect;let a=[{x:r,y:s+n/2},{x:i,y:s+n/2}];const{angle:h,colors:l}=formatGradient(t.calculative.lineGradientColors);let u=getGradientR(h,o,n);return a.forEach(d=>{rotatePoint(d,h,c)}),getLinearGradient(e,a,l,u)}function getLinearGradient(e,t,i,s){let r=getLinearGradientPoints(t[0].x,t[0].y,t[1].x,t[1].y,s),o=e.createLinearGradient(r[0],r[1],r[2],r[3]);return i.forEach(n=>{o.addColorStop(n.i,n.color)}),o}function drawLinearGradientLine(e,t,i){let s=[];t.calculative.gradientColorStop?s=t.calculative.gradientColorStop:(s=formatGradient(t.calculative.lineGradientColors).colors,t.calculative.gradientColorStop=s),e.strokeStyle=getLinearGradient(e,i,s,t.calculative.lineWidth/2),e.beginPath(),e.moveTo(i[0].x,i[0].y),e.lineTo(i[1].x,i[1].y),e.stroke()}function ctxDrawLinearGradientPath(e,t){const i=t.calculative.worldAnchors;let s=t.calculative.lineWidth*(t.calculative.gradientSmooth||t.calculative.lineSmooth||0);for(let r=0;r<i.length-1;r++)if((t.lineName==="curve"||t.lineName==="mind")&&i[r].curvePoints){if(r>0){let c=i[r-1].curvePoints;c?smoothTransition(e,t,s,c[c.length-1],i[r],i[r].curvePoints[0]):smoothTransition(e,t,s,i[r-1],i[r],i[r].curvePoints[0]);let a=getSmoothAdjacent(s,i[r],i[r].curvePoints[0]);drawLinearGradientLine(e,t,[a,i[r].curvePoints[1]])}else drawLinearGradientLine(e,t,[i[r],i[r].curvePoints[0]]),drawLinearGradientLine(e,t,[i[r].curvePoints[0],i[r].curvePoints[1]]);let o=i[r].curvePoints.length-1;for(let c=1;c<o;c++)drawLinearGradientLine(e,t,[i[r].curvePoints[c],i[r].curvePoints[c+1]]);let n=getSmoothAdjacent(s,i[r+1],i[r].curvePoints[o]);drawLinearGradientLine(e,t,[i[r].curvePoints[o],n])}else{let o=i[r],n=i[r+1];if(r>0&&r<i.length-1){let a=i[r-1].curvePoints;a?smoothTransition(e,t,s,a[a.length-1],i[r],i[r+1]):smoothTransition(e,t,s,i[r-1],i[r],i[r+1])}r>0&&r<i.length-1&&(o=getSmoothAdjacent(s,i[r],i[r+1])),r<i.length-2&&(n=getSmoothAdjacent(s,i[r+1],i[r]));let c=!1;if(r===0&&t.fromLineCap&&t.fromLineCap!=="butt"&&(e.save(),c=!0,e.lineCap=t.fromLineCap),r!==0&&r===i.length-2&&t.toLineCap&&t.toLineCap!=="butt"&&(e.save(),c=!0,e.lineCap=t.toLineCap),drawLinearGradientLine(e,t,[o,n]),c&&e.restore(),i.length===2&&r===0){e.save(),c=!0,e.lineCap=t.toLineCap;let a=.1,h=.1;o.x-n.x===0?h=0:a=(o.y-n.y)/(o.x-n.x)*.1,drawLinearGradientLine(e,t,[{x:n.x-h,y:n.y-a},n]),e.restore()}}}function getSmoothAdjacent(e,t,i){let s=Math.sqrt((i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y));return s===0?{x:t.x,y:t.y}:e<s?{x:t.x+(i.x-t.x)*e/s,y:t.y+(i.y-t.y)*e/s}:{x:t.x+(i.x-t.x)/s/2,y:t.y+(i.y-t.y)/s/2}}function smoothTransition(e,t,i,s,r,o){let n=getSmoothAdjacent(i,r,s),c=getSmoothAdjacent(i,r,o),a={x:r.x,y:r.y},h=getBezierPoints(t.calculative.canvas.store.data.smoothNum||20,n,a,c);for(let l=0;l<h.length-1;l++)drawLinearGradientLine(e,t,[{x:h[l].x,y:h[l].y},{x:h[l+1].x,y:h[l+1].y}])}function smoothAnimateTransition(e,t,i,s){let r=getSmoothAdjacent(t,i,s),o={x:i.x,y:i.y};e.quadraticCurveTo(o.x,o.y,r.x,r.y)}function getGradientAnimatePath(e){const t=e.calculative.worldAnchors;let i=e.calculative.lineWidth*(e.calculative.gradientSmooth||e.calculative.lineSmooth||0);const s=new Path2D;for(let r=0;r<t.length-1;r++){t[r];let o=t[r+1];if(r==0&&s.moveTo(t[r].x,t[r].y),r>0&&r<t.length-1){let n=t[r-1].curvePoints;smoothAnimateTransition(s,i,t[r],t[r+1])}r>0&&r<t.length-1&&getSmoothAdjacent(i,t[r],t[r+1]),r<t.length-2&&(o=getSmoothAdjacent(i,t[r+1],t[r])),s.lineTo(o.x,o.y)}return s}function getBezierPoints(e=100,t,i,s,r){let o=null;const n=[];!s&&!r?o=oneBezier:s&&!r?o=twoBezier:s&&r&&(o=threeBezier);for(let c=0;c<e;c++)n.push(o(c/e,t,i,s,r));return r?n.push(r):s&&n.push(s),n}function oneBezier(e,t,i){const{x:s,y:r}=t,{x:o,y:n}=i;let c=s+(o-s)*e,a=r+(n-r)*e;return{x:c,y:a}}function twoBezier(e,t,i,s){const{x:r,y:o}=t,{x:n,y:c}=i,{x:a,y:h}=s;let l=(1-e)*(1-e)*r+2*e*(1-e)*n+e*e*a,u=(1-e)*(1-e)*o+2*e*(1-e)*c+e*e*h;return{x:l,y:u}}function threeBezier(e,t,i,s,r){const{x:o,y:n}=t,{x:c,y:a}=r,{x:h,y:l}=i,{x:u,y:d}=s;let f=o*(1-e)*(1-e)*(1-e)+3*h*e*(1-e)*(1-e)+3*u*e*e*(1-e)+c*e*e*e,g=n*(1-e)*(1-e)*(1-e)+3*l*e*(1-e)*(1-e)+3*d*e*e*(1-e)+a*e*e*e;return{x:f,y:g}}function strokeLinearGradient(e,t){const{worldRect:i,lineGradientFromColor:s,lineGradientToColor:r,lineGradientAngle:o}=t.calculative;return linearGradient(e,i,s,r,o)}function linearGradient(e,t,i,s,r){if(!i||!s)return;const{x:o,y:n,center:c,ex:a,ey:h}=t,l={x:o,y:c.y},u={x:a,y:c.y};r%90===0&&r%180?(l.x=c.x,u.x=c.x,r%270?(l.y=n,u.y=h):(l.y=h,u.y=n)):r&&(rotatePoint(l,r,t.center),rotatePoint(u,r,t.center));const d=e.createLinearGradient(l.x,l.y,u.x,u.y);return d.addColorStop(0,i),d.addColorStop(1,s),d}function getImagePosition(e){const{worldIconRect:t,iconWidth:i,iconHeight:s,imgNaturalWidth:r,imgNaturalHeight:o}=e.calculative;let{x:n,y:c,width:a,height:h}=t;if(i&&(a=i),s&&(h=s),r&&o&&e.imageRatio){const l=t.width/r,u=t.height/o,d=Math.min(l,u),f=r/o;i?h=i/f:s?a=s*f:(a=d*r,h=d*o)}switch(n+=(t.width-a)/2,c+=(t.height-h)/2,e.iconAlign){case"top":c=t.y;break;case"bottom":c=t.ey-h;break;case"left":n=t.x;break;case"right":n=t.ex-a;break;case"left-top":n=t.x,c=t.y;break;case"right-top":n=t.ex-a,c=t.y;break;case"left-bottom":n=t.x,c=t.ey-h;break;case"right-bottom":n=t.ex-a,c=t.ey-h;break}return{x:n,y:c,width:a,height:h}}function drawImage(e,t){const{x:i,y:s,width:r,height:o}=getImagePosition(t),{worldIconRect:n,iconRotate:c,img:a}=t.calculative;if(e.filter=t.filter,c){const{x:h,y:l}=n.center;e.translate(h,l),e.rotate(c*Math.PI/180),e.translate(-h,-l)}if(t.imageRadius){e.save();let h=t.calculative.imageRadius||0,l=h;const{x:u,y:d,width:f,height:g,ex:y,ey:v}=t.calculative.worldRect;h<1&&(h=f*h,l=g*l);let b=h<l?h:l;f<2*b&&(b=f/2),g<2*b&&(b=g/2),e.beginPath(),e.moveTo(u+b,d),e.arcTo(y,d,y,v,b),e.arcTo(y,v,u,v,b),e.arcTo(u,v,u,d,b),e.arcTo(u,d,y,d,b),e.clip(),e.drawImage(a,i,s,r,o),e.restore()}else{let h=s,l=0;if(t.thumbImg){let u=a.naturalWidth,d=a.naturalHeight;l=(o/r*u-d)/2,h=s+l}e.drawImage(a,i,h,r,o-2*l)}}function getTextColor(e,t){const{textColor:i,color:s}=e.calculative,{styles:r}=t;return i||s||r.textColor||r.color}function drawText(e,t){const{fontStyle:i,fontWeight:s,fontSize:r,fontFamily:o,lineHeight:n,text:c,hiddenText:a,canvas:h,textHasShadow:l,textBackground:u,textType:d}=t.calculative;if(c==null||a)return;const f=h.store;e.save(),l||(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0);let g;t.calculative.disabled?g=t.disabledTextColor||t.disabledColor||pSBC(.4,getTextColor(t,f)):t.calculative.hover?g=t.hoverTextColor||t.hoverColor||f.styles.hoverColor:t.calculative.active&&(g=t.activeTextColor||t.activeColor||f.styles.activeColor);let y;d===Gradient.Linear?y=getTextGradient(e,t):d===Gradient.Radial&&(y=getTextRadialGradient(e,t)),e.fillStyle=g||y||getTextColor(t,f),e.font=getFont({fontStyle:i,fontWeight:s,fontFamily:o||f.options.fontFamily,fontSize:r,lineHeight:n}),!t.calculative.textDrawRect&&calcTextDrawRect(e,t);const{x:v,y:b,width:x,height:m}=t.calculative.textDrawRect;u&&(e.save(),e.fillStyle=u,e.fillRect(v,b,x,m),e.restore());const T=.55,I=t.textAlign||f.options.textAlign,P=r*n;t.calculative.textLines.forEach((E,_)=>{const W=t.calculative.textLineWidths[_];let Y=0;I==="center"?Y=(x-W)/2:I==="right"&&(Y=x-W),e.fillText(E,v+Y,b+(_+T)*P);const{textDecorationColor:C,textDecorationDash:k,textDecoration:R}=t;R&&drawUnderLine(e,{x:v+Y,y:b+(_+T)*P,width:W},{textDecorationColor:C,textDecorationDash:k,fontSize:r});const{textStrickoutColor:S,textStrickoutDash:N,textStrickout:H}=t;H&&drawStrickout(e,{x:v+Y,y:b+(_+T)*P,width:W},{textStrickoutColor:S,textStrickoutDash:N,fontSize:r})}),e.restore()}function drawUnderLine(e,t,i){const{textDecorationColor:s,textDecorationDash:r,fontSize:o}=i;let{x:n,y:c,width:a}=t;switch(e.textBaseline){case"top":c+=o;break;case"middle":c+=o/2;break}e.save(),e.beginPath(),e.strokeStyle=s||e.fillStyle,e.lineWidth=1,e.moveTo(n,c),e.setLineDash(r||[]),e.lineTo(n+a,c),e.stroke(),e.restore()}function drawStrickout(e,t,i){const{textStrickoutColor:s,textStrickoutDash:r,fontSize:o}=i;let{x:n,y:c,width:a}=t;switch(e.textBaseline){case"top":c+=o/2;break;case"bottom":c-=o/2;break}e.save(),e.beginPath(),e.strokeStyle=s||e.fillStyle,e.lineWidth=1,e.moveTo(n,c),e.setLineDash(r||[]),e.lineTo(n+a,c),e.stroke(),e.restore()}function drawFillText(e,t,i){if(i==null)return;const{fontStyle:s,fontWeight:r,fontSize:o,fontFamily:n,lineHeight:c,canvas:a}=t.calculative,h=a.store;e.save();let l;t.calculative.hover?l=t.hoverTextColor||t.hoverColor||h.styles.hoverColor:t.calculative.active&&(l=t.activeTextColor||t.activeColor||h.styles.activeColor),e.fillStyle=l||getTextColor(t,h),e.font=getFont({fontStyle:s,fontWeight:r,fontFamily:n||h.options.fontFamily,fontSize:o,lineHeight:c});const u=e.measureText(i).width;let d,f;for(const g of t.calculative.worldAnchors){if(!f){f=g;continue}const y=distance(f,g),v=Math.floor(y/u);d="";for(let x=0;x<v;x++)d+=i;const b=calcRotate(f,g)-270;if(e.save(),b%360!==0){const{x,y:m}=f;e.translate(x,m);let T=b*Math.PI/180;e.rotate(T),e.translate(-x,-m)}e.fillText(d,f.x,f.y+c/2),e.restore(),f=g}e.restore()}function drawIcon(e,t){const i=t.calculative.canvas.store;e.save(),e.shadowColor="",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.textAlign="center",e.textBaseline="middle";const s=t.calculative.worldIconRect;let r=s.x+s.width/2,o=s.y+s.height/2;switch(t.iconAlign){case"top":o=s.y,e.textBaseline="top";break;case"bottom":o=s.ey,e.textBaseline="bottom";break;case"left":r=s.x,e.textAlign="left";break;case"right":r=s.ex,e.textAlign="right";break;case"left-top":r=s.x,o=s.y,e.textAlign="left",e.textBaseline="top";break;case"right-top":r=s.ex,o=s.y,e.textAlign="right",e.textBaseline="top";break;case"left-bottom":r=s.x,o=s.ey,e.textAlign="left",e.textBaseline="bottom";break;case"right-bottom":r=s.ex,o=s.ey,e.textAlign="right",e.textBaseline="bottom";break}const n=t.calculative.iconWeight;let c;const a=t.calculative.iconFamily;t.calculative.iconSize>0?c=t.calculative.iconSize:s.width>s.height?c=s.height:c=s.width,e.font=getFont({fontSize:c,fontWeight:n,fontFamily:a}),e.fillStyle=t.calculative.iconColor||getTextColor(t,i),t.calculative.iconRotate&&(e.translate(s.center.x,s.center.y),e.rotate(t.calculative.iconRotate*Math.PI/180),e.translate(-s.center.x,-s.center.y)),e.beginPath(),e.fillText(t.calculative.icon,r,o),e.restore()}function drawDropdown(e,t){const i=t.calculative.canvas.store.data.scale,s=t.calculative.canvas.inputDiv.dataset.penId,{x:r,y:o,width:n,height:c}=t.calculative.worldRect;e.save(),e.beginPath(),t.id===s?(e.moveTo(r+n-20*i,o+c/2+2*i),e.lineTo(r+n-14*i,o+c/2-4*i),e.lineTo(r+n-8*i,o+c/2+2*i)):(e.moveTo(r+n-20*i,o+c/2-4*i),e.lineTo(r+n-14*i,o+c/2+2*i),e.lineTo(r+n-8*i,o+c/2-4*i)),e.stroke(),e.restore()}function getFont({fontStyle:e="normal",textDecoration:t="normal",fontWeight:i="normal",fontSize:s=12,fontFamily:r="Arial",lineHeight:o=1}={}){return`${e} ${t} ${i} ${s}px/${o} ${r}`}function ctxFlip(e,t){const{x:i,ex:s,y:r,ey:o}=t.calculative.worldRect||{};t.calculative.flipX&&(e.translate(i+s,0),e.scale(-1,1)),t.calculative.flipY&&(e.translate(0,r+o),e.scale(1,-1))}function ctxRotate(e,t,i=!1){const{x:s,y:r}=t.calculative.worldRect.pivot||t.calculative.worldRect.center;e.translate(s,r);let o=t.calculative.rotate*Math.PI/180;i||(t.calculative.flipX&&(o*=-1),t.calculative.flipY&&(o*=-1)),e.rotate(o),e.translate(-s,-r)}function renderPen(e,t,i){e.save(),e.translate(.5,.5),e.beginPath(),drawFilter(e,t);const s=t.calculative.canvas.store,r=t.textFlip||s.options.textFlip,o=t.textRotate||s.options.textRotate;(!r||!o)&&e.save(),ctxFlip(e,t),t.calculative.rotate&&t.name!=="line"&&ctxRotate(e,t),(t.calculative.lineWidth>1||i)&&(e.lineWidth=t.calculative.lineWidth),inspectRect(e,s,t);let n,c=!1,a;t.calculative.disabled?(a=t.disabledColor||s.styles.disabledColor||pSBC(.4,t.calculative.color||s.styles.color),n=t.disabledBackground||s.styles.disabledBackground||pSBC(.4,t.calculative.background||s.styles.penBackground)):t.mouseDownValid&&t.calculative.mouseDown?(a=t.mouseDownColor||pSBC(-.4,t.calculative.color||s.styles.color),n=t.mouseDownBackground||pSBC(-.4,t.calculative.background||s.styles.penBackground)):t.switch&&t.calculative.checked?t.calculative.bkType||(n=t.onBackground):t.calculative.hover?(a=t.hoverColor||s.styles.hoverColor,n=t.hoverBackground||s.styles.hoverBackground):t.calculative.active?(a=t.activeColor||s.styles.activeColor,n=t.activeBackground||s.styles.activeBackground):t.calculative.isDock&&(t.type===PenType.Line?a=s.styles.dockPenColor:n=rgba(s.styles.dockPenColor,.2));const h=t.calculative.strokeImg;if(t.calculative.strokeImage&&h)e.strokeStyle=a||e.createPattern(h,"repeat");else{let u;t.calculative.strokeType?t.calculative.lineGradientColors?t.name==="line"?c=!0:t.calculative.lineGradient?u=t.calculative.lineGradient:(u=getLineGradient(e,t),t.calculative.lineGradient=u):u=strokeLinearGradient(e,t):u=t.calculative.color||(t.type?s.data.lineColor:"")||s.styles.color,e.strokeStyle=a||u}const l=t.calculative.backgroundImg;if(t.calculative.backgroundImage&&l)e.fillStyle=n||e.createPattern(l,"repeat"),n=!0;else{let u;t.calculative.bkType===Gradient.Linear?t.calculative.gradientColors?t.calculative.gradient?u=t.calculative.gradient:(u=getBkGradient(e,t),t.calculative.gradient=u):u=drawBkLinearGradient(e,t):t.calculative.bkType===Gradient.Radial?t.calculative.gradientColors?t.calculative.radialGradient?u=t.calculative.radialGradient:(u=getBkRadialGradient(e,t),t.calculative.radialGradient=u):u=drawBkRadialGradient(e,t):u=t.calculative.background||s.styles.penBackground,e.fillStyle=n||u,n=!!u}if(setLineCap(e,t),setLineJoin(e,t),setGlobalAlpha(e,t),t.calculative.lineDash&&e.setLineDash(t.calculative.lineDash.map(u=>u*t.calculative.canvas.store.data.scale)),t.calculative.lineDashOffset&&(e.lineDashOffset=t.calculative.lineDashOffset),t.calculative.shadowColor&&(e.shadowColor=t.calculative.shadowColor,e.shadowOffsetX=t.calculative.shadowOffsetX,e.shadowOffsetY=t.calculative.shadowOffsetY,e.shadowBlur=t.calculative.shadowBlur),c?(ctxDrawLinearGradientPath(e,t),ctxDrawLinePath(!0,e,t,s)):(ctxDrawPath(!0,e,t,s,n),ctxDrawCanvas(e,t)),!(t.image&&t.calculative.img)&&t.calculative.icon&&drawIcon(e,t),t.dropdownList&&drawDropdown(e,t),(!r||!o)&&e.restore(),r&&!o&&ctxFlip(e,t),!r&&o&&t.calculative.rotate&&t.name!=="line"&&ctxRotate(e,t,!0),drawText(e,t),t.type===PenType.Line&&t.fillTexts)for(const u of t.fillTexts)drawFillText(e,t,u);e.restore()}function setLineCap(e,t){const i=t.lineCap||(t.type?"round":"square");i?e.lineCap=i:t.type&&(e.lineCap="round")}function setLineJoin(e,t){const i=t.lineJoin;i?e.lineJoin=i:t.type&&(e.lineJoin="round")}function renderPenRaw$1(e,t,i,s){var h;e.save(),i&&e.translate(-i.x,-i.y),(h=e.setAttrs)==null||h.call(e,t);let r=!1;const o=t.calculative.canvas.store,n=t.textFlip||o.options.textFlip,c=t.textRotate||o.options.textRotate;e.beginPath(),(!n||!c)&&e.save(),t.calculative.flipX&&(e.translate(t.calculative.worldRect.x+t.calculative.worldRect.ex,0),e.scale(-1,1)),t.calculative.flipY&&(e.translate(0,t.calculative.worldRect.y+t.calculative.worldRect.ey),e.scale(1,-1)),t.calculative.rotate&&t.name!=="line"&&ctxRotate(e,t),(t.calculative.lineWidth>1||s)&&(e.lineWidth=t.calculative.lineWidth);let a;if(t.calculative.hover)e.strokeStyle=t.hoverColor||o.styles.hoverColor,e.fillStyle=t.hoverBackground||o.styles.hoverBackground,a=t.hoverBackground||o.styles.hoverBackground;else if(t.calculative.active)e.strokeStyle=t.activeColor||o.styles.activeColor,e.fillStyle=t.activeBackground||o.styles.activeBackground,a=t.activeBackground||o.styles.activeBackground;else{if(t.strokeImage)t.calculative.strokeImg&&(e.strokeStyle=e.createPattern(t.calculative.strokeImg,"repeat"),a=!0);else{let l;t.calculative.strokeType&&t.calculative.lineGradientColors&&t.name==="line"?r=!0:l=t.calculative.color||o.styles.color,e.strokeStyle=l}t.backgroundImage?t.calculative.backgroundImg&&(e.fillStyle=e.createPattern(t.calculative.backgroundImg,"repeat"),a=!0):(e.fillStyle=t.background,a=!!t.background)}if(setLineCap(e,t),setLineJoin(e,t),setGlobalAlpha(e,t),t.calculative.lineDash&&e.setLineDash(t.calculative.lineDash),t.calculative.lineDashOffset&&(e.lineDashOffset=t.calculative.lineDashOffset),t.calculative.shadowColor&&(e.shadowColor=t.calculative.shadowColor,e.shadowOffsetX=t.calculative.shadowOffsetX,e.shadowOffsetY=t.calculative.shadowOffsetY,e.shadowBlur=t.calculative.shadowBlur),r?(ctxDrawLinearGradientPath(e,t),ctxDrawLinePath(!0,e,t,o)):(ctxDrawPath(!1,e,t,o,a),ctxDrawCanvas(e,t)),t.calculative.img?(e.save(),e.shadowColor="",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,drawImage(e,t),e.restore()):t.calculative.icon&&drawIcon(e,t),t.dropdownList&&drawDropdown(e,t),(!n||!c)&&e.restore(),n&&!c&&(t.calculative.flipX&&(e.translate(t.calculative.worldRect.x+t.calculative.worldRect.ex,0),e.scale(-1,1)),t.calculative.flipY&&(e.translate(0,t.calculative.worldRect.y+t.calculative.worldRect.ey),e.scale(1,-1))),!n&&c&&t.calculative.rotate&&t.name!=="line"&&ctxRotate(e,t,!0),drawText(e,t),t.type===PenType.Line&&t.fillTexts)for(const l of t.fillTexts)drawFillText(e,t,l);e.restore()}function ctxDrawPath(e=!0,t,i,s,r){if(i.name==="drawCommand")return;const o=e?s.path2dMap.get(i):globalStore.path2dDraws[i.name];let n=null,c=null;if(i.type===PenType.Line&&(i.fromLineCap&&i.fromLineCap!=="butt"&&(t.lineCap="butt",n=new Path2D,n.moveTo(i.calculative.worldAnchors[0].x,i.calculative.worldAnchors[0].y),n.lineTo(i.calculative.worldAnchors[0].x,i.calculative.worldAnchors[0].y)),i.toLineCap&&i.toLineCap!=="butt"&&(t.lineCap="butt",c=new Path2D,c.moveTo(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].x,i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].y),c.lineTo(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].x,i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].y))),o){if(i.type===PenType.Line&&i.borderWidth){t.save(),t.beginPath();const h=i.calculative.lineWidth+i.calculative.borderWidth;t.lineWidth=h,t.strokeStyle=i.borderColor,n&&(t.save(),t.lineCap=i.fromLineCap,t.stroke(n),t.restore()),o instanceof Path2D?(r&&t.fill(o),h&&t.stroke(o)):(o(i,t),r&&t.fill(),h&&t.stroke()),c&&(t.save(),t.lineCap=i.toLineCap,t.stroke(c),t.restore()),t.restore()}o instanceof Path2D?i.type?i.close&&r&&t.fill(o):r&&t.fill(o):(t.save(),o(i,t),r&&t.fill(),t.restore());const a=i.calculative.progress;if(a!=null){t.save();const{ex:h,x:l,y:u,width:d,height:f,ey:g}=i.calculative.worldRect;let y=null;if(i.calculative.verticalProgress?y=i.reverseProgress?t.createLinearGradient(l,u,l,u+f*a):t.createLinearGradient(l,g,l,u+f*(1-a)):y=i.reverseProgress?t.createLinearGradient(h,u,l+d*(1-a),u):t.createLinearGradient(l,u,l+d*a,u),i.calculative.progressGradientColors){const{colors:v}=formatGradient(i.calculative.progressGradientColors);v.forEach(b=>{y.addColorStop(b.i,b.color)})}else{const v=i.calculative.progressColor||i.calculative.color||s.options.activeColor||s.data.color;y.addColorStop(0,v),y.addColorStop(1,v)}y.addColorStop(1,"transparent"),t.fillStyle=y,o instanceof Path2D?t.fill(o):(o(i,t),t.fill()),t.restore()}if(i.calculative.lineWidth&&(o instanceof Path2D?(s.options.svgPathStroke||i.name!=="svgPath")&&(n&&(t.save(),t.lineCap=i.fromLineCap,t.stroke(n),t.restore()),t.stroke(o),c&&(t.save(),t.lineCap=i.toLineCap,t.stroke(c),t.restore())):(o(i,t),t.stroke())),i.type){if(i.calculative.animatePos){if(t.save(),setCtxLineAnimate(t,i,s),i.lineAnimateType===LineAnimateType.Arrow||i.lineAnimateType===LineAnimateType.WaterDrop){let h=drawArrow(i,t);h instanceof Path2D?(t.stroke(h),t.fill(h)):(t.stroke(),t.fill())}else o instanceof Path2D?(n&&!i.lineAnimateType&&(t.save(),t.lineCap=i.fromLineCap,t.stroke(n),t.restore()),t.lineCap=i.lineCap,t.stroke(o)):(o(i,t),t.stroke());t.restore()}i.fromArrow&&renderFromArrow(t,i,s),i.toArrow&&renderToArrow(t,i,s),i.calculative.active&&!i.calculative.pencil&&!s.options.disableAnchor&&!s.data.locked&&renderLineAnchors(t,i)}}}function ctxDrawLinePath(e=!0,t,i,s){const r=e?s.path2dMap.get(i):globalStore.path2dDraws[i.name];if(r&&i.type){if(i.calculative.animatePos){if(t.save(),setCtxLineAnimate(t,i,s),t.beginPath(),r instanceof Path2D)if(i.lineName==="polyline"||i.lineName==="line")if(i.lineAnimateType===LineAnimateType.Arrow||i.lineAnimateType===LineAnimateType.WaterDrop){const o=drawArrow(i);t.stroke(o),t.fill(o)}else i.calculative.gradientSmooth||i.calculative.lineSmooth?(i.calculative.gradientAnimatePath||(i.calculative.gradientAnimatePath=getGradientAnimatePath(i)),i.calculative.gradientAnimatePath instanceof Path2D&&t.stroke(i.calculative.gradientAnimatePath)):t.stroke(r);else t.stroke(r);else r(i,t),t.stroke();t.restore()}i.fromArrow&&renderFromArrow(t,i,s),i.toArrow&&renderToArrow(t,i,s),i.calculative.active&&!i.calculative.pencil&&!s.options.disableAnchor&&!s.data.locked&&renderLineAnchors(t,i)}}function setCtxLineAnimate(e,t,i){e.strokeStyle=t.animateColor||i.styles.animateColor,t.animateShadow&&(e.shadowBlur=t.animateShadowBlur||t.animateLineWidth||6,e.shadowColor=t.animateShadowColor||t.animateColor||i.styles.animateColor),t.calculative.animateLineWidth&&(e.lineWidth=t.calculative.animateLineWidth*i.data.scale);let s=0;switch(t.lineAnimateType){case LineAnimateType.Beads:t.animateReverse?e.lineDashOffset=t.calculative.animatePos:e.lineDashOffset=t.length-t.calculative.animatePos,s=t.calculative.lineWidth||5,s<5&&(s=5);const r=t.animateLineDash&&t.animateLineDash.map(n=>n*s/5);e.setLineDash(r||[s,s*2]);break;case LineAnimateType.Dot:t.animateReverse?e.lineDashOffset=t.calculative.animatePos:e.lineDashOffset=t.length-t.calculative.animatePos,s=t.calculative.animateDotSize||t.calculative.lineWidth*2||6,s<6&&(s=6),s>40&&(s=40),e.lineWidth=(t.calculative.animateLineWidth||s)*i.data.scale,e.setLineDash([.1,t.length]);break;case LineAnimateType.Arrow:e.fillStyle=t.animateColor||i.styles.animateColor,e.lineWidth=1;break;case LineAnimateType.WaterDrop:e.fillStyle=t.animateColor||i.styles.animateColor,e.lineWidth=1;break;case LineAnimateType.Custom:if(t.trackTargets&&t.trackTargets.length){const n=t.trackTargets;setTrackAnimateOnPen(t,n);break}const o=t.lineAnimateElement;setElementAnimateOnPen(e,t,o);break;default:t.animateReverse?(e.lineDashOffset=Number.EPSILON,e.setLineDash([0,t.length-t.calculative.animatePos+1,t.calculative.animatePos])):e.setLineDash([t.calculative.animatePos,t.length+.01-t.calculative.animatePos]);break}}function setTrackAnimateOnPen(e,t){if(!Array.isArray(t))return;const i=e.calculative.canvas.store.data.origin,s=e.calculative.canvas.store.data.scale;t.forEach(r=>{var b,x,m;const o=e.calculative.canvas.store.pens[r.id],n=e.calculative.canvas.parent;if(!o)return;const c=calculateLineFrameStates(e,(b=r.offset)==null?void 0:b.instance);if(!c)return;const a=o.width,h=o.height,l=c.x-a/2,u=c.y-h/2,d=(l-i.x)/s,f=(u-i.y)/s,g=a/s,y=h/s,v={x:d+(((x=r.offset)==null?void 0:x.x)||0),y:f+(((m=r.offset)==null?void 0:m.y)||0),width:g,height:y,rotate:c.rotate};n.setValue({id:o.id,...v})})}function setElementAnimateOnPen(e,t,i){const s=globalStore.lineAnimateDraws[i];s&&renderElementOnLine(e,t,s)}function renderElementOnLine(e,t,i){if(t.lineAnimateDash){const s=Array.isArray(t.lineAnimateDash)?t.lineAnimateDash:t.lineAnimateDash.split(",").map(c=>Number(c)),r=t.calculative.canvas.store.data.scale,o=getLineLength(t)/r;computeLineDashSegments(o,s,t.lineAnimateDashOffset,t.lineAnimateElementCount).forEach((c,a)=>{const h=calculateLineFrameStates(t,c.start);if(h){h.index=c.start,h.calculateLineFrameStates=calculateLineFrameStates;try{e.save(),i(e,t,h,a),e.restore()}catch(l){e.restore(),console.warn(l)}}})}}function computeLineDashSegments(e,t,i=0,s,r=0){const o=[];if(!t||t.length===0)return o.push({start:0,end:e,isDash:!0}),o;const n=t.reduce((l,u)=>l+u,0);let c=(-i+r)%n;c<0&&(c+=n);let a=0,h=0;for(s||(s=1/0);h<e&&a<s;)for(let l=0;l<t.length;l++){const u=t[l],d=l%2===0;let f=h,g=h+u-c;if(g>e&&(g=e),d&&g>f){const y=(f+r)%e,v=(g+r)%e;o.push({start:y,end:v,isDash:!0}),a+=1}if(h=g,c=0,h>=e||a>=s)break}return o}function calculateLineFrameStates(e,t=0){let i,s=null;if(e.calculative.worldAnchors.forEach(n=>{s&&(i=createSvgPath(i,s,s.next,n.prev,n)),s=n}),e.close){let n=e.calculative.worldAnchors[0];i=createSvgPath(i,s,s.next,n.prev,n)}let r=0;return e.animateReverse?r=e.length-e.calculative.animatePos-t*e.calculative.canvas.store.data.scale:r=e.calculative.animatePos-t*e.calculative.canvas.store.data.scale,getLinePointPosAndAngle(i,r)}function renderLineAnchors(e,t){const i=t.calculative.canvas.store;e.save(),e.lineWidth=1,e.fillStyle=t.activeColor||i.styles.activeColor,t.calculative.worldAnchors.forEach(s=>{!s.hidden&&!s.isTemp&&renderAnchor(e,s,t)}),e.restore()}function renderAnchor(e,t,i){if(!t)return;const s=i.calculative.canvas.store.activeAnchor===i.calculative.activeAnchor&&i.calculative.activeAnchor===t;let r=3;i.calculative.lineWidth>3&&(r=i.calculative.lineWidth),i.anchorRadius&&(r=i.anchorRadius),t.radius&&(r=t.radius),s?(t.prev&&(e.save(),e.strokeStyle="#4dffff",e.beginPath(),e.moveTo(t.prev.x,t.prev.y),e.lineTo(t.x,t.y),e.stroke(),e.restore(),e.save(),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.prev.x,t.prev.y,r,0,Math.PI*2),e.fill(),e.stroke(),e.restore()),t.next&&(e.save(),e.strokeStyle="#4dffff",e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.next.x,t.next.y),e.stroke(),e.restore(),e.save(),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.next.x,t.next.y,r,0,Math.PI*2),e.fill(),e.stroke(),e.restore(),e.beginPath(),e.arc(t.x,t.y,r,0,Math.PI*2),e.fill(),e.stroke()),e.beginPath(),e.arc(t.x,t.y,r,0,Math.PI*2),e.fill(),e.stroke()):(e.save(),e.fillStyle="#ffffff",e.beginPath(),e.arc(t.x,t.y,r,0,Math.PI*2),e.fill(),e.stroke(),e.restore())}function calcWorldRects(e){const t=e.calculative.canvas.store;let i={x:e.x,y:e.y};if(!e.parentId||e.parentId&&!t.pens[e.parentId])e.parentId=void 0,i.width=e.width,i.height=e.height,i.rotate=e.rotate,calcRightBottom(i),calcCenter(i),e.pivot&&calcPivot(i,e.pivot);else{const s=t.pens[e.parentId];let r=s.calculative.worldRect;r||(r=calcWorldRects(s)),i.x=r.x+r.width*e.x,i.y=r.y+r.height*e.y,i.width=r.width*e.width,i.height=r.height*e.height,s.flipX&&(i.x=r.width-(i.x-r.x+i.width)+r.x),s.flipY&&(i.y=r.height-(i.y-r.y+i.height)+r.y),calcRightBottom(i),i.rotate=r.rotate+e.rotate,calcCenter(i),e.pivot&&calcPivot(i,e.pivot)}return e.calculative.worldRect=i,calcPadding(e,i),i}function calcPadding(e,t){!e.paddingTop&&(e.calculative.paddingTop=0),!e.paddingBottom&&(e.calculative.paddingBottom=0),!e.paddingLeft&&(e.calculative.paddingLeft=0),!e.paddingRight&&(e.calculative.paddingRight=0),Math.abs(e.calculative.paddingTop)<1&&(e.calculative.paddingTop*=t.height),Math.abs(e.calculative.paddingBottom)<1&&(e.calculative.paddingBottom*=t.height),Math.abs(e.calculative.paddingLeft)<1&&(e.calculative.paddingLeft*=t.width),Math.abs(e.calculative.paddingRight)<1&&(e.calculative.paddingRight*=t.width)}function calcPenRect(e){const t=deepClone(e.calculative.worldRect);if(delete t.pivot,!e.parentId){Object.assign(e,t);return}const s=e.calculative.canvas.store.pens[e.parentId].calculative.worldRect;Object.assign(e,calcRelativeRect(t,s))}function calcWorldAnchors(e){const t=e.calculative.canvas.store;let i=[];if(e.anchors){let s=deepClone(e.anchors);e.flipX&&s.forEach(r=>{r.x=.5-(r.x-.5)}),e.flipY&&s.forEach(r=>{r.y=.5-(r.y-.5)}),s.forEach(r=>{i.push(calcWorldPointOfPen(e,r))})}if(!i.length&&!e.type&&!e.calculative.canvas.parent.isCombine(e)){const{x:s,y:r,width:o,height:n}=e.calculative.worldRect;i=t.options.defaultAnchors.map((c,a)=>({id:`${a}`,penId:e.id,x:s+o*c.x,y:r+n*c.y}))}e.calculative.rotate&&i.forEach(s=>{rotatePoint(s,e.calculative.rotate,e.calculative.worldRect.pivot||e.calculative.worldRect.center)}),(!e.type||e.anchors)&&(e.calculative.worldAnchors=i),e.calculative.activeAnchor&&i.length&&(e.calculative.activeAnchor=i.find(s=>{s.id,e.calculative.activeAnchor.id})),e.calculative.gradientAnimatePath=void 0}function calcChildrenInitRect(e){var t;if((t=e.children)!=null&&t.length){let i=e.calculative.worldRect;e.children.forEach(s=>{const r=e.calculative.canvas.store.pens[s];r.calculative.initRect&&r.calculative.initRelativeRect&&(r.calculative.initRect.x=i.x+i.width*r.calculative.initRelativeRect.x,r.calculative.initRect.y=i.y+i.height*r.calculative.initRelativeRect.y,r.calculative.initRect.ex=r.calculative.initRect.x+i.width*r.calculative.initRelativeRect.width,r.calculative.initRect.ey=r.calculative.initRect.y+i.height+r.calculative.initRelativeRect.height,calcCenter(r.calculative.initRect)),calcChildrenInitRect(r)})}}function calcWorldPointOfPen(e,t){const i={...t},{x:s,y:r,width:o,height:n}=e.calculative.worldRect;return i.x=s+o*t.x,i.y=r+n*t.y,t.prev&&(i.prev={penId:e.id,connectTo:t.prev.connectTo,x:s+o*t.prev.x,y:r+n*t.prev.y}),t.next&&(i.next={penId:e.id,connectTo:t.next.connectTo,x:s+o*t.next.x,y:r+n*t.next.y}),i}function calcIconRect(e,t){const{paddingTop:i,paddingBottom:s,paddingLeft:r,paddingRight:o}=t.calculative;let n=r,c=i,a=t.calculative.worldRect.width-r-o,h=t.calculative.worldRect.height-i-s,l=t.calculative.iconLeft,u=t.calculative.iconTop;l&&Math.abs(l)<1&&(l=t.calculative.worldRect.width*l),u&&Math.abs(u)<1&&(u=t.calculative.worldRect.height*u),n+=l||0,c+=u||0,a-=l||0,h-=u||0;let d=t.calculative.iconRotate||0;if(t.parentId){const f=e[t.parentId].calculative;f&&(d+=f.rotate,d%=360)}n=t.calculative.worldRect.x+n,c=t.calculative.worldRect.y+c,t.calculative.worldIconRect={x:n,y:c,width:a,height:h,rotate:d},calcRightBottom(t.calculative.worldIconRect),calcCenter(t.calculative.worldIconRect)}function scalePen(e,t,i){scaleRect(e.calculative.worldRect,t,i,e.pivot),e.calculative.initRect&&scaleRect(e.calculative.initRect,t,i,e.pivot),scaleChildrenInitRect(e,t,i),e.calculative.x&&scalePoint(e.calculative,t,i),e.type&&calcWorldAnchors(e)}function scaleChildrenInitRect(e,t,i){var s;e&&(s=e.children)!=null&&s.length&&e.children.forEach(r=>{const o=e.calculative.canvas.store.pens[r];o&&(o.calculative.initRect&&scaleRect(o.calculative.initRect,t,i),scaleChildrenInitRect(o,t,i))})}function pushPenAnchor(e,t){e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]);const i={id:t.id,penId:e.id,x:t.x,y:t.y};if(e.calculative.worldAnchors.push(i),e.calculative.worldRect){e.rotate%360&&rotatePoint(t,-e.rotate,e.calculative.worldRect.center);const s={id:t.id,penId:e.id,x:(t.x-e.calculative.worldRect.x)/e.calculative.worldRect.width,y:(t.y-e.calculative.worldRect.y)/e.calculative.worldRect.height};e.anchors.push(s)}return i}function addLineAnchor(e,t,i){e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]);const s=getSplitAnchor(e,t,i);return e.calculative.worldAnchors.splice(i+1,0,s),e.anchors.splice(i+1,0,calcRelativePoint(s,e.calculative.worldRect)),e.calculative.activeAnchor=s,s}function removePenAnchor(e,t){if(!e||!e.calculative.worldAnchors)return;let i=e.calculative.worldAnchors.findIndex(s=>s.id===t.id);i>-1&&e.calculative.worldAnchors.splice(i,1),i=e.anchors.findIndex(s=>s.id===t.id),i>-1&&e.anchors.splice(i,1)}function facePen(e,t){if(!t||!t.calculative||!t.calculative.worldRect.center)return Direction.None;if(e.anchorId){let i=t.anchors.filter(s=>s.id===e.anchorId);if(i.length&&i[0].direction>-1)return i[0].direction}return facePoint(e,t.calculative.worldRect.center)}function nearestAnchor(e,t){let i=1/0,s;return e.calculative.worldAnchors.forEach(r=>{const o=distance(t,r);i>o&&(i=o,s=r)}),s}function translateLine(e,t,i){e.x+=t,e.y+=i,e.anchors&&e.anchors.forEach(s=>{translatePoint(s,t,i)}),e.calculative.worldAnchors&&e.calculative.worldAnchors.forEach(s=>{translatePoint(s,t,i)})}function deleteTempAnchor(e){if(e&&e.calculative&&e.calculative.worldAnchors.length){let t=getToAnchor(e);if(!e.anchors||!e.anchors.length)for(;e.calculative.worldAnchors.length&&t!==e.calculative.activeAnchor;)e.calculative.worldAnchors.pop(),t=getToAnchor(e);else t===e.calculative.activeAnchor?e.calculative.worldAnchors=[e.calculative.worldAnchors[0]]:e.calculative.worldAnchors[0]===e.calculative.activeAnchor&&(e.calculative.worldAnchors=[e.calculative.worldAnchors[e.calculative.worldAnchors.length-1]])}}function connectLine(e,t,i,s){var c,a,h,l,u,d;if(!e||!t||!i||!s||t.twoWay===TwoWay.DisableConnected||t.twoWay===TwoWay.Disable||s.twoWay===TwoWay.DisableConnectTo||s.twoWay===TwoWay.Disable)return;if(t.twoWay===TwoWay.In){if(i.calculative.worldAnchors.length===1)return;const f=getToAnchor(i);if(s.id!==f.id)return}if(t.twoWay===TwoWay.Out){const f=getFromAnchor(i);if(s.id!==f.id)return}if(s.connectTo===e.id&&s.anchorId===t.id)return;if(s.connectTo){const f=e.calculative.canvas.store.pens[s.connectTo];disconnectLine(f,getAnchor(f,s.anchorId),i,s)}e.connectedLines||(e.connectedLines=[]),e.connectedLines.findIndex(f=>f.lineId===i.id&&f.lineAnchor===s.id&&f.anchor===t.id)<0&&e.connectedLines.push({lineId:i.id,lineAnchor:s.id,anchor:t.id}),s.connectTo=e.id,s.anchorId=t.id,e.type&&connectLine(i,s,e,t),e.calculative.canvas.store.emitter.emit("connectLine",{line:i,lineAnchor:s,pen:e,anchor:t});let o=((c=i.calculative.worldAnchors)==null?void 0:c.length)>=2?(a=i.calculative.worldAnchors)==null?void 0:a[0].connectTo:void 0,n=((h=i.calculative.worldAnchors)==null?void 0:h.length)>=2?(u=i.calculative.canvas.store.pens[(l=i.calculative.worldAnchors)==null?void 0:l[0].connectTo])==null?void 0:u.anchors.find(f=>{var g;return f.id===((g=i.calculative.worldAnchors)==null?void 0:g[0].anchorId)}):void 0;return(d=e.onConnectLine)==null||d.call(e,e,{line:i,lineAnchor:s,pen:e,anchor:t,fromPen:o,fromAnchor:n}),!0}function disconnectLine(e,t,i,s){if(!(!e||!t||!i||!s)&&!(!e.connectedLines||!e.connectedLines.length))return i.lastConnected||(i.lastConnected={}),i.lastConnected[e.id]||(i.lastConnected[e.id]=deepClone(e.connectedLines)),e.connectedLines.forEach((r,o,n)=>{(r.lineId===i.id||r.lineId===i.id)&&r.lineAnchor===s.id&&r.anchor===t.id&&n.splice(o,1)}),s.connectTo=void 0,s.anchorId=void 0,e.type&&t.connectTo===i.id&&t.anchorId===s.id&&disconnectLine(i,s,e,t),e.calculative.canvas.store.emitter.emit("disconnectLine",{line:i,lineAnchor:s,pen:e,anchor:t}),!0}function getAnchor(e,t){var i;if(!(!e||!t))return(i=e.calculative.worldAnchors)==null?void 0:i.find(s=>s.id===t)}function getFromAnchor(e){if(!(!e||!e.calculative.worldAnchors))return e.calculative.worldAnchors[0]}function getToAnchor(e){if(!(!e||!e.calculative.worldAnchors))return e.calculative.worldAnchors[e.calculative.worldAnchors.length-1]}function setNodeAnimate(e,t){var s,r;if(e.calculative.start===0||!e.frames||!e.frames.length)return e.calculative.start=void 0,0;if(!e.calculative.duration){e.calculative.duration=0;for(const o of e.frames){e.calculative.duration+=o.duration;for(const n in o)n!=="duration"&&!e[n]&&n==="scale"&&(e[n]=1)}}if(e.animateCycle||(e.animateCycle=1/0),e.calculative.start){let o=0;const n=Math.ceil((t-e.calculative.start)/e.calculative.duration);if(n>e.animateCycle)return e.currentAnimation=void 0,e.calculative.start=void 0,setNodeAnimateProcess(e,1),0;const c=(t-e.calculative.start)%e.calculative.duration||e.calculative.duration;let a=0;for(const u of e.frames)if(a+=u.duration,c>a)++o;else break;if(!e.frames[o])return!0;let h=!1;o!==e.calculative.frameIndex&&(h=!0,e.calculative.frameIndex=o,e.calculative.frameDuration=e.frames[o].duration,o>0&&(e.calculative.frameStart+=e.frames[o-1].duration),e.calculative.frameEnd=e.calculative.frameStart+e.calculative.frameDuration);let l=!1;if(n>e.calculative.cycleIndex&&(e.calculative.cycleIndex=n,e.calculative.frameStart=e.calculative.start+e.calculative.duration*(n-1),l=!0),h||l)if(e.calculative.x=e.calculative.initRect.x,e.calculative.y=e.calculative.initRect.y,(r=e.children)!=null&&r.length&&!e.parentId?e.calculative.canvas.rotatePen(e,(e.calculative.initRect.rotate||0)-(e.calculative.rotate||0),e.calculative.initRect):e.calculative.rotate=e.calculative.initRect.rotate||0,o>0){e.prevFrame={};const u=e.frames[o-1];for(const d in u)e.prevFrame[d]=u[d];Object.assign(e.prevFrame,{rotate:u.rotate||0,x:u.x||0,y:u.y||0,scale:u.scale||1})}else initPrevFrame(e)}else{if(e.calculative.start=t,e.calculative.frameIndex=0,e.calculative.frameStart=e.calculative.start,e.calculative.frameDuration=e.frames[0].duration,e.calculative.frameEnd=e.calculative.frameStart+e.calculative.frameDuration,e.calculative.cycleIndex=1,e.calculative.x=e.calculative.worldRect.x,e.calculative.y=e.calculative.worldRect.y,e.calculative.initRect=deepClone(e.calculative.worldRect),e.parentId&&(e.calculative.initRelativeRect={x:e.x,y:e.y,width:e.width,height:e.height}),(s=e.children)!=null&&s.length){const o=e.calculative.canvas.store;e.calculative.childrenVisible={},e.children.forEach(n=>{e.calculative.childrenVisible[n]=o.pens[n].visible})}e.calculative.initRect.rotate=e.calculative.rotate||0,initPrevFrame(e)}const i=(t-e.calculative.frameStart)/e.calculative.frameDuration%1;return i>0&&setNodeAnimateProcess(e,i),!0}function initPrevFrame(e){e.prevFrame={};for(const t in e)(typeof e[t]!="object"||t==="lineDash")&&(e.prevFrame[t]=e[t]);e.prevFrame.rotate=0,e.prevFrame.x=0,e.prevFrame.y=0,e.prevFrame.scale=1}function setNodeAnimateProcess(e,t){var r,o,n,c,a,h;if(t<0)return;t>1&&(t=1);const i=e.frames[e.calculative.frameIndex],s=e.calculative.canvas.store.data.scale;for(const l in i)if(l!=="duration"){if(l==="scale"){e.calculative.worldRect=deepClone(e.calculative.initRect),scaleRect(e.calculative.worldRect,e.prevFrame.scale,e.calculative.worldRect.center);const u=e.prevFrame.scale+(i[l]-e.prevFrame.scale)*t;scaleRect(e.calculative.worldRect,u/e.prevFrame.scale,e.calculative.worldRect.center),e.calculative.patchFlags=!0}else if(l==="x"){const u=getFrameValue(e,l,e.calculative.frameIndex)*s;e.calculative.worldRect.x=e.calculative.initRect.x+u,e.calculative.worldRect.ex=e.calculative.initRect.ex+u,e.calculative.worldRect.center.x=e.calculative.initRect.center.x+u,(r=e.calculative.worldRect.pivot)!=null&&r.x&&(e.calculative.worldRect.pivot.x=((o=e.calculative.initRect.pivot)==null?void 0:o.x)+u),translateRect(e.calculative.worldRect,i[l]*t*s,0),e.calculative.patchFlags=!0}else if(l==="y"){const u=getFrameValue(e,l,e.calculative.frameIndex)*s;e.calculative.worldRect.y=e.calculative.initRect.y+u,e.calculative.worldRect.ey=e.calculative.initRect.ey+u,e.calculative.worldRect.center.y=e.calculative.initRect.center.y+u,(n=e.calculative.worldRect.pivot)!=null&&n.x&&(e.calculative.worldRect.pivot.y=((c=e.calculative.initRect.pivot)==null?void 0:c.y)+u),translateRect(e.calculative.worldRect,0,i[l]*t*s),e.calculative.patchFlags=!0}else if(l==="width"){const u=getFrameValue(e,l,e.calculative.frameIndex)*s;e.calculative.worldRect.width=e.calculative.initRect.width+u,e.calculative.worldRect.ex=e.calculative.initRect.ex+u,e.calculative.worldRect.center.x=e.calculative.initRect.center.x+u;let d=i[l]*t*s;e.calculative.worldRect.width+=d,e.calculative.worldRect.ex+=d,e.calculative.worldRect.center.x+=d,e.calculative.patchFlags=!0}else if(l==="height"){const u=getFrameValue(e,l,e.calculative.frameIndex)*s;e.calculative.worldRect.height=e.calculative.initRect.height+u,e.calculative.worldRect.ey=e.calculative.initRect.ey+u,e.calculative.worldRect.center.y=e.calculative.initRect.center.y+u;let d=i[l]*t*s;e.calculative.worldRect.height+=d,e.calculative.worldRect.ey+=d,e.calculative.worldRect.center.y+=d,e.calculative.patchFlags=!0}else if(l==="rotate"){e.prevFrame[l]>=360&&(e.prevFrame[l]%=360);const u=getFrameValue(e,l,e.calculative.frameIndex),d=(e.calculative.initRect.rotate+u+i[l]*t)%360-(e.calculative.rotate||0);(a=e.children)!=null&&a.length?e.calculative.canvas.rotatePen(e,d,e.calculative.initRect):e.calculative.rotate=(e.calculative.initRect.rotate+u+i[l]*t)%360,e.calculative.patchFlags=!0}else if(l==="image")e.image=i.image,e.calculative.image=void 0,e.calculative.canvas.loadImage(e),e.canvasLayer===CanvasLayer.CanvasImageBottom?e.calculative.canvas.canvasImageBottom.init():e.canvasLayer===CanvasLayer.CanvasImage&&e.calculative.canvas.canvasImage.init();else if(isLinear(i[l],l,e)){e.prevFrame[l]==null&&(l==="globalAlpha"?e.prevFrame[l]=1:e.prevFrame[l]=0);const u=e.prevFrame[l]+(i[l]-e.prevFrame[l])*t;e.calculative[l]=Math.round(u*100)/100}else{if(l==="visible"&&!e.calculative.image){if((h=e.children)!=null&&h.length){const d=getAllChildren(e,e.calculative.canvas.store);e.calculative.canvas.initImageCanvas(d)}}e.calculative[l]=i[l];const u={};u[l]=i[l],setChildValue(e,u)}l==="text"&&calcTextLines(e)}}function isLinear(e,t,i){const s=["strokeType","bkType","showChild"];return typeof e=="number"&&i.linear!==!1&&!s.includes(t)}function setLineAnimate(e,t){if(e.calculative.start===0)return e.calculative.start=void 0,e.calculative.cycleStart=void 0,0;e.animateCycle||(e.animateCycle=1/0),e.animateSpan||(e.animateSpan=1);const i=(t-e.calculative.cycleStart)/1e3;if(e.animateTimingFunction&&e.duration){const s=Array.isArray(e.animateTimingFunction)?e.animateTimingFunction:e.animateTimingFunction.split(","),r=e.duration,o=i/r,n=cubicBezierY(o,s[1],s[3]);e.calculative.animatePos=n*e.length}else e.calculative.animatePos+=e.animateSpan*(e.calculative.canvas.store.data.scale||1);if(e.calculative.cycleStart||(e.calculative.cycleStart=t),!e.calculative.start)e.calculative.start=Date.now(),e.calculative.animatePos=e.animateSpan*(e.calculative.canvas.store.data.scale||1),e.calculative.cycleIndex=1;else if(e.calculative.animatePos>e.length||i>e.duration){if(++e.calculative.cycleIndex,e.calculative.cycleIndex>e.animateCycle)return e.currentAnimation=void 0,e.calculative.start=void 0,e.calculative.cycleStart=void 0,0;e.calculative.cycleStart=void 0,e.calculative.animatePos=e.animateSpan}return!0}function setChildrenActive(e,t=!0){if(!e.children||e.childActive===!1)return;const i=e.calculative.canvas.store;e.children.forEach(s=>{const r=i.pens[s];r&&(r.calculative.active=t,setChildrenActive(r,t))})}function setHover(e,t=!0){if(!e)return;const i=e.calculative.canvas.store;e.calculative.hover=t,e.childHover!==!1&&e.children&&e.children.forEach(s=>{var r,o;((r=i.pens[s])==null?void 0:r.hoverColor)==null&&((o=i.pens[s])==null?void 0:o.hoverBackground)==null&&setHover(i.pens[s],t)})}function setElemPosition(e,t){if(!t)return;const i=e.calculative.canvas.store,s=e.calculative.worldRect;if(t.style.opacity=e.globalAlpha+"",t.style.position="absolute",t.style.outline="none",t.style.left=s.x+i.data.x+"px",t.style.top=s.y+i.data.y+"px",t.style.width=s.width+"px",t.style.height=s.height+"px",t.style.display=e.calculative.inView!=!1?e.calculative.cssDisplay||"inline":"none",!e.calculative.rotate&&(e.calculative.rotate=0),t.style.transform=`rotate(${e.calculative.rotate}deg)`,e.calculative.rotate||(e.calculative.flipX&&(t.style.transform="rotateY(180deg)"),e.calculative.flipY&&(t.style.transform="rotateX(180deg)"),e.calculative.flipX&&e.calculative.flipY&&(t.style.transform="rotateZ(180deg)")),t.style.zIndex=e.calculative.zIndex!==void 0?e.calculative.zIndex+"":"5",e.calculative.zIndex>e.calculative.canvas.maxZindex&&(e.calculative.canvas.maxZindex=e.calculative.zIndex),e.locked===LockState.DisableEdit||e.locked===LockState.DisableMove||i.data.locked?(t.style.userSelect="initial",t.style.pointerEvents="initial",e.name==="gif"&&(t.style.userSelect="none",t.style.pointerEvents="none")):(t.style.userSelect="none",t.style.pointerEvents="none"),e.className&&(t.className=e.className),e.styles)for(let r in e.styles)t.style[r]=e.styles[r]}function getPensLock(e){return e.every(t=>t.locked)}function getPensDisableRotate(e){return e.every(t=>t.disableRotate)}function rotatePen(e,t,i){var s;e.type?(e.calculative.worldAnchors.forEach(r=>{rotatePoint(r,t,i.center)}),initLineRect(e),calcPenRect(e)):(e.calculative.rotate?e.calculative.rotate+=t:e.calculative.rotate=t,rotatePoint(e.calculative.worldRect.center,t,i.center),e.parentId&&(e.calculative.worldRect.x=e.calculative.worldRect.center.x-e.calculative.worldRect.width/2,e.calculative.worldRect.y=e.calculative.worldRect.center.y-e.calculative.worldRect.height/2,e.x=(e.calculative.worldRect.x-i.x)/i.width,e.y=(e.calculative.worldRect.y-i.y)/i.height)),(s=e.children)==null||s.forEach(r=>{const o=e.calculative.canvas.store.pens[r];rotatePen(o,t,i)})}function initLineRect(e){var r;if(!((r=e.calculative.worldAnchors)!=null&&r.length)||!isFinite(e.x)||!isFinite(e.x)||e.x==null||e.y==null)return;const t=getLineRect(e);e.parentId||Object.assign(e,t);const{fontSize:i,lineHeight:s}=e.calculative.canvas.store.options;e.fontSize?e.fontSize<0&&(e.fontSize=0,e.calculative.fontSize=0):(e.fontSize=i>=0?i:12,e.calculative.fontSize=e.fontSize*e.calculative.canvas.store.data.scale),e.lineHeight||(e.lineHeight=s,e.calculative.lineHeight=e.lineHeight),calcCenter(t),e.calculative.worldRect=t,calcPadding(e,t),calcTextRect(e),e.calculative.worldAnchors&&(e.anchors=e.calculative.worldAnchors.map(o=>calcRelativePoint(o,e.calculative.worldRect)))}function getPensDisableResize(e){return e.every(t=>t.disableSize||t.pivot)}function getFrameValue(e,t,i){if(!e.frames||!t)return 0;let s=0;for(let r=0;r<i;r++)e.frames[r]&&(s+=e.frames[r][t]||0);return s}function isShowChild(e,t){var s;let i=e;for(;i&&i.parentId;){const r=i;i=t.pens[i.parentId];const o=(s=i==null?void 0:i.calculative)==null?void 0:s.showChild;if(o!=null&&i.children[o]!==r.id)return!1}return!0}function calcInView(e,t=!1){var r,o,n;const{store:i,canvasRect:s}=e.calculative.canvas;if(t&&((r=e.children)==null||r.forEach(c=>{const a=i.pens[c];a&&calcInView(a,!0)})),e.calculative.inView=!0,isShowChild(e,i)?(e.visible==!1||e.calculative.visible==!1)&&(e.calculative.inView=!1,(e.canvasLayer===CanvasLayer.CanvasImageBottom||e.canvasLayer===CanvasLayer.CanvasImage)&&((o=e.frames)!=null&&o.length)&&(e.calculative.inView=e.frames.some(c=>c.hasOwnProperty("visible")))):e.calculative.inView=!1,e.calculative.inView){const{x:c,y:a,width:h,height:l,rotate:u}=e.calculative.worldRect,d={x:c+i.data.x,y:a+i.data.y,width:h,height:l,rotate:u};calcRightBottom(d),rectInRect(d,s)||(e.calculative.inView=!1)}(n=e.calculative.singleton)!=null&&n.div&&setElemPosition(e,e.calculative.singleton.div)}function inspectRect(e,t,i){if(t.fillWorldTextRect){e.save(),e.fillStyle="#c3deb7";const{x:s,y:r,width:o,height:n}=i.calculative.worldTextRect;e.fillRect(s,r,o,n),e.restore()}}function setGlobalAlpha(e,t){const i=t.calculative.globalAlpha;typeof i=="number"&&i<1&&!isNaN(i)&&(e.globalAlpha=i)}function ctxDrawCanvas(e,t){const i=drawFuncGenerator(e,t)||globalStore.canvasDraws[t.name];i&&(e.save(),i(e,t),e.restore())}function drawFuncGenerator(e,t){const i=t.drawCommand;if(!(!i||t.name==="line"))return(s,r)=>{i.forEach(o=>{try{o.steps=o.steps.flat(1/0),o.steps.reduce((n,c)=>{const a=commandTransfer(c,r,n.x,n.y);try{if(a.c){if(a.c.startsWith("_")){const l=a.c.split("_")[1];return typeof a.v.value=="number"&&(a.v.value*=r.calculative.canvas.store.data.scale),(a.p||s)[l]=a.v.value,{x:n.x,y:n.y}}let h=[];for(const l in a.v)h.push(a.v[l]);return(a.p||s)[a.c](...h),{x:a.startX||a.v.x,y:a.startY||a.v.y}}return{x:n.x,y:n.y}}catch{}},{})}catch{}}),s.stroke()}}function commandTransfer(e,t,i,s){var o;const r={visio:dealWithVisio,dxf:dealWithDXF,canvas:dealWithCanvas};return((o=r[t.parseType])==null?void 0:o.call(r,e,t,i,s))||e}function dealWithDXF(e,t,i,s){const{x:r,y:o,width:n,height:c}=t.calculative.worldRect,{originWidth:a,originHeight:h}=t.dxfOrigin;switch(e.c){case"beginPath":return{c:"beginPath",v:{}};case"closePath":return{c:"closePath",v:{}};case"moveTo":return{c:"moveTo",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o}};case"lineTo":return{c:"lineTo",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o}};case"arc":return{c:"ellipse",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o,rx:e.v.xr*(n/a),ry:e.v.yr*(c/h),rotation:e.v.rotation||0,startAngle:e.v.startAngle,endAngle:e.v.endAngle,a:e.v.aclockwise??!0}};case"ellipse":return{c:"ellipse",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o,rx:e.v.xr*(n/a),ry:e.v.yr*(c/h),rotation:e.v.rotation||0,startAngle:e.v.startAngle,endAngle:e.v.endAngle,a:e.v.aclockwise??!0}};case"_font":return{c:"_font",v:{value:e.v.fontSize*t.calculative.canvas.store.data.scale+"px "+(e.v.fontFamily||t.calculative.canvas.store.options.fontFamily)}};case"_fillStyle":return{c:"_fillStyle",v:{value:t.color||e.v.value}};default:const l={c:e.c,v:{...e.v}};return l.v.x!==void 0&&(l.v.x=e.v.x*(n/a)+r),l.v.y!==void 0&&(l.v.y=e.v.y*(c/h)+o),l}}function dealWithCanvas(e,t,i,s){const{x:r,y:o,width:n,height:c}=t.calculative.worldRect,{originWidth:a,originHeight:h}=t.origin;switch(e.c){case"beginPath":return{c:"beginPath",v:{}};case"closePath":return{c:"closePath",v:{}};case"moveTo":return{c:"moveTo",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o}};case"lineTo":return{c:"lineTo",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o}};case"arc":return{c:"ellipse",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o,rx:e.v.xr*(n/a),ry:e.v.yr*(c/h),rotation:e.v.rotation||0,startAngle:e.v.startAngle,endAngle:e.v.endAngle,a:e.v.aclockwise??!0}};case"ellipse":return{c:"ellipse",v:{x:e.v.x*(n/a)+r,y:e.v.y*(c/h)+o,rx:e.v.xr*(n/a),ry:e.v.yr*(c/h),rotation:e.v.rotation||0,startAngle:e.v.startAngle,endAngle:e.v.endAngle,a:e.v.aclockwise??!0}};case"_font":return{c:"_font",v:{value:e.v.fontSize*t.calculative.canvas.store.data.scale+"px "+(e.v.fontFamily||t.calculative.canvas.store.options.fontFamily)}};default:const l={c:e.c,v:{...e.v}};return l.v.x!==void 0&&(l.v.x=e.v.x*(n/a)+r),l.v.y!==void 0&&(l.v.y=e.v.y*(c/h)+o),l}}function dealWithVisio(e,t,i,s){const{x:r,y:o,width:n,height:c}=t.calculative.worldRect,{width:a,height:h}=t.origin;switch(e.c){case"MoveTo":return{c:"moveTo",v:{x:+e.v.X*100*(n/a)+r,y:+e.v.Y*100*(c/h)+o}};case"RelMoveTo":return{c:"moveTo",v:{x:+e.v.X*a*(n/a)+r,y:+e.v.Y*h*(c/h)+o}};case"LineTo":return{c:"lineTo",v:{x:+e.v.X*100*(n/a)+r,y:+e.v.Y*100*(c/h)+o}};case"RelLineTo":return{c:"lineTo",v:{x:+e.v.X*a*(n/a)+r,y:+e.v.Y*h*(c/h)+o}};case"Ellipse":let l=e.v.X,u=e.v.Y,d=Math.abs(e.v.A-e.v.C),f=Math.abs(e.v.B-e.v.D);return{c:"ellipse",v:{x:l*100*(n/a)+r,y:u*100*(c/h)+o,radiuX:d*100*(n/a),radiuY:f*100*(c/h),rotation:0,startAngle:0,endAngle:Math.PI*2,anticlockwise:!0}};case"EllipticalArcTo":const g=e.v.X*100*(n/a)+r,y=e.v.Y*100*(c/h)+o,v=e.v.A*100*(n/a)+r,b=e.v.B*100*(c/h)+o;e.v.C;const x=e.v.D*(n/c)*(h/a),m=(g-i)*(b-s)-(y-s)*(v-i)>0,T=calculateEllipseParameters(i,s,g,y,v,b,x);return!e.orign&&(e.orign={}),!e.orign.startA&&(e.orign.startA=calculateAngleInRadians(T.x0,T.y0,i,s)),!e.orign.endA&&(e.orign.endA=calculateAngleInRadians(T.x0,T.y0,g,y)),{c:"ellipse",v:{centerX:T.x0,centerY:T.y0,radiuX:T.a,radiuY:T.b,rotation:0,startAngle:e.orign.startA,endAngle:e.orign.endA,anticlockwise:m},startX:g,startY:y};case"RelEllipticalArcTo":const I=e.v.X*a*(n/a)+r,P=e.v.Y*h*(c/h)+o,E=e.v.A*a*(n/a)+r,_=e.v.B*h*(c/h)+o;e.v.C;const W=e.v.D*(n/c)*(h/a),Y=(I-i)*(_-s)-(P-s)*(E-i)>0,C=calculateEllipseParameters(i,s,I,P,E,_,W);return!e.orign&&(e.orign={}),!e.orign.startA&&(e.orign.startA=calculateAngleInRadians(C.x0,C.y0,i,s)),!e.orign.endA&&(e.orign.endA=calculateAngleInRadians(C.x0,C.y0,I,P)),{c:"ellipse",v:{centerX:C.x0,centerY:C.y0,radiuX:C.a,radiuY:C.b,rotation:0,startAngle:e.orign.startA,endAngle:e.orign.endA,anticlockwise:Y},startX:I,startY:P};case"ArcTo":let k=e.v.X*100*n/a+r,R=e.v.Y*100*c/h+o,S=e.v.A*100*(n/c)*(h/a),N=(i+k)/2,H=(s+R)/2,K=Math.sqrt((k-i)**2+(R-s)**2),F=K**2/(8*S)+S/2,L=-(R-s)/K,O=(k-i)/K,z=N+L*F,B=H+O*F,U=z,$=B,q=Math.atan2(s-$,i-U),Q=Math.atan2(R-$,k-U);return{c:"arc",v:{x:U,y:$,radius:F,startAngle:q,endAngle:Q,aclockwise:!0}};default:const X=deepClone(e);return Object.entries(X.v).forEach(([J,p])=>{var w,A;(w=J.endsWith)!=null&&w.call(J,"_x")?typeof p=="number"&&(X.v[J]=p*(n/a)+r):(A=J.endsWith)!=null&&A.call(J,"_y")?typeof p=="number"&&(X.v[J]=p*(c/h)+o):typeof p=="number"&&(X.v[J]=p)}),X}}function drawFilter(e,t){e.filter=t.filter}function setChildValue(e,t){for(const i in t)inheritanceProps.includes(i)&&(i=="fontSize"&&t[i]<0&&(t[i]=0),e[i]=t[i],["fontSize","lineWidth"].includes(i)?(e.calculative[i]=t[i]*e.calculative.canvas.store.data.scale,calcTextRect(e)):e.calculative[i]=t[i]);if(e.calculative.canvas.parent.isCombine(e)){const i=e.children;i==null||i.forEach(s=>{let r=deepClone(t);e.calculative.childrenVisible&&e.calculative.childrenVisible[s]===!1&&delete r.visible;const o=e.calculative.canvas.store.pens[s];o&&setChildValue(o,r)})}}function calculateEllipseParameters(e,t,i,s,r,o,n){let c=(e-i)*(e+i)*(s-o)-(i-r)*(i+r)*(t-s)+n*n*(t-s)*(s-o)*(t-o),a=2*((e-i)*(s-o)-(i-r)*(t-s)),h=c/a,l=(e-i)*(i-r)*(e-r)+n*n*((i-r)*(t-s)*(t+s)-(e-i)*(s-o)*(s+o)),u=2*n*n*((i-r)*(t-s)-(e-i)*(s-o)),d=l/u,f=Math.sqrt(Math.pow(e-h,2)+Math.pow(n*(t-d),2)),g=f/n;return{x0:h,y0:d,a:f,b:g}}function calculateAngleInRadians(e,t,i,s){let r=i-e,o=s-t,n=Math.atan2(o,r);return n<0&&(n+=2*Math.PI),n}function calcAnchorDock(e,t,i){let s,r,o=1/0,n=1/0;const c=8;for(const a of e.data.pens){if(a.calculative.inView===!1)continue;getPointsByPen(a).forEach(l=>{if(l===t||l===i)return;let u=(a.calculative.worldRect.center.x-t.x)*(a.calculative.worldRect.center.x-t.x)+(a.calculative.worldRect.center.y-t.y)*(a.calculative.worldRect.center.y-t.y);const d=Math.abs(l.x-t.x);d>0&&d<c&&u<o&&(s={x:Math.round(l.x)+.5,y:Math.round(l.y)+.5,prev:{x:Math.round(t.x)+.5,y:Math.round(t.y)+.5},step:l.x-t.x},o=u);const f=Math.abs(l.y-t.y);f>0&&f<c&&u<n&&(r={x:Math.round(l.x)+.5,y:Math.round(l.y)+.5,prev:{x:Math.round(t.x)+.5,y:Math.round(t.y)+.5},step:l.y-t.y},n=u)})}return{xDock:s,yDock:r}}function calcMoveDock(e,t,i,s){let r=[];return i.length===1?(r=deepClone(getPointsByPen(i[0])),r.forEach(o=>{o.x+=s.x,o.y+=s.y})):(calcCenter(t),r=[t.center,...rectToPoints(t)]),calcDockByPoints(e,r,t,!0)}function getPointsByPen(e){if(e.type){if(e.type===PenType.Line)return e.calculative.worldAnchors}else{const t=rectToPoints(e.calculative.worldRect);return calcCenter(e.calculative.worldRect),[...e.calculative.worldAnchors,...t,e.calculative.worldRect.center]}}function calcResizeDock(e,t,i,s){const r=rectToPoints(t);return calcDockByPoints(e,r,t)}function calcDockByPoints(e,t,i,s=!1){let r,o,n=1/0,c=1/0;const a=10,h=expandRect(i,a);return e.data.pens.forEach(l=>{const{inView:u,worldRect:d,active:f}=l.calculative;if(u===!1||!s&&f||rectInFourAngRect(h,d)||l.type&&e.active.some(y=>isConnectLine(e,y,l)))return;const g=getPointsByPen(l);if(g)for(const y of g)for(const v of t){const b=y.x-v.x,x=y.y-v.y,m=Math.abs(b),T=Math.abs(x);i.center||(i.center={x:i.x+i.width/2,y:i.y+i.height/2}),m<a&&m<n&&(r={x:Math.round(y.x)+.5,y:Math.round(y.y)+.5,step:b,prev:{x:Math.round(v.x)+.5,y:Math.round(v.y)+.5},penId:l.id,anchorId:v.id,dockAnchorId:y.id},n=m),T<a&&T<c&&(o={x:Math.round(y.x)+.5,y:Math.round(y.y)+.5,step:x,prev:{x:Math.round(v.x)+.5,y:Math.round(v.y)+.5},penId:l.id,anchorId:v.id,dockAnchorId:y.id},c=T)}}),{xDock:r,yDock:o}}function isConnectLine(e,t,i){if(!i.type)return!1;if(Array.isArray(t==null?void 0:t.connectedLines)){for(const s of t==null?void 0:t.connectedLines)if(s.lineId===i.id)return!0}if(Array.isArray(t==null?void 0:t.children))for(const s of t.children){const r=e.pens[s];if(isConnectLine(e,r,i))return!0}return!1}function isEqual(e,t){return e.toFixed(12)==t}function randomId(e){if(e.id=s8(),Array.isArray(e.anchors))for(const t of e.anchors)e.type&&(t.id=s8()),t.penId=e.id,t.prev&&(e.type&&(t.prev.id=s8()),t.prev.penId=e.id),t.next&&(e.type&&(t.next.id=s8()),t.next.penId=e.id)}function rewritePenLifeCycle(){let e=null,t=new Map;return(i,s,r,o=!1)=>{if(t.has(i)&&t.get(i)?e=t.get(i):t.set(i,e=new Map),typeof r!="function")return()=>{console.warn("[rewritePenLifeCycle] warn: not a function ")};let n=new Set,c=new Map;e.has(s)&&e.get(s)?n=e.get(s):(c.set(s,i[s]),e.set(s,n)),o?n.delete(r):n.add(r);let a=c.get(s),h=(...l)=>{a==null||a(...l),n.forEach(u=>{u(...l)})};i[s]=h}}let setLifeCycleFunc=rewritePenLifeCycle();function validationPlugin(e){return!e.name&&!e.install?(console.error("installPenPlugin Error: Validation Failed"),!1):!0}function pointInRect(e,t){if(!t)return;if(t.ex==null&&calcRightBottom(t),!t.rotate||t.rotate%360===0)return e.x>t.x&&e.x<t.ex&&e.y>t.y&&e.y<t.ey;t.center||calcCenter(t);const i=[{x:t.x,y:t.y},{x:t.ex,y:t.y},{x:t.ex,y:t.ey},{x:t.x,y:t.ey}];return i.forEach(s=>{rotatePoint(s,t.rotate,t.pivot||t.center)}),pointInVertices(e,i)}function pointInSimpleRect(e,t,i=0){const{x:s,y:r,ex:o,ey:n}=t;return e.x>=s-i&&e.x<=o+i&&e.y>=r-i&&e.y<=n+i}function calcCenter(e){e.center||(e.center={}),e.center.x=e.x+e.width/2,e.center.y=e.y+e.height/2}function calcRightBottom(e){e.ex=e.x+e.width,e.ey=e.y+e.height}function calcPivot(e,t){e.pivot||(e.pivot={}),e.pivot.x=e.x+e.width*t.x,e.pivot.y=e.y+e.height*t.y}function pointInVertices(e,t){if(t.length<3)return!1;let i=!1,s=t[t.length-1];for(const r of t)s.y>e.y!=r.y>e.y&&r.x+(e.y-r.y)*(s.x-r.x)/(s.y-r.y)>e.x&&(i=!i),s=r;return i}function getRect$1(e){const t=[];e.forEach(s=>{if(s.isRuleLine)return;const r=s.calculative.worldRect;if(r){const o=rectToPoints(r);t.push(...o)}});const i=getRectOfPoints(t);return calcCenter(i),i}function rectToPoints(e){const t=[{x:e.x,y:e.y},{x:e.ex,y:e.y},{x:e.ex,y:e.ey},{x:e.x,y:e.ey}];return e.rotate&&(e.center||calcCenter(e),t.forEach(i=>{rotatePoint(i,e.rotate,e.pivot||e.center)})),t}function getRectOfPoints(e){let t=1/0,i=1/0,s=-1/0,r=-1/0;return e==null||e.forEach(o=>{!isFinite(o.x)||!isFinite(o.y)||(t=Math.min(t,o.x),i=Math.min(i,o.y),s=Math.max(s,o.x),r=Math.max(r,o.y))}),{x:t,y:i,ex:s,ey:r,width:s-t,height:r-i}}function rectInRect(e,t,i){return e.rotate&&(e=getRectOfPoints(rectToPoints(e))),i?e.x>t.x&&e.ex<t.ex&&e.y>t.y&&e.ey<t.ey:!(e.x>t.ex||e.ex<t.x||e.ey<t.y||e.y>t.ey)}function rectInFourAngRect(e,t){return(t.x>e.ex||t.ex<e.x)&&(t.y>e.ey||t.ey<e.y)}function expandRect(e,t){const i=formatPadding(t),s={x:e.x-i[3],y:e.y-i[0],width:e.width+i[1]+i[3],height:e.height+i[0]+i[2]};return calcRightBottom(s),s}function translateRect(e,t,i){e.x+=t,e.y+=i,e.ex+=t,e.ey+=i,e.center&&(e.center.x+=t,e.center.y+=i),e.pivot&&(e.pivot.x+=t,e.pivot.y+=i)}function getIntersectPoint(e,t){const i=(e.to.y-e.from.y)/(e.to.x-e.from.x),s=(t.to.y-t.from.y)/(t.to.x-t.from.x);return getIntersectPointByK({k:i,point:e.from},{k:s,point:t.from})}function getIntersectPointByK(e,t){if(isEqual(e.k,0))return{x:t.point.x,y:e.point.y};if(isEqual(t.k,0))return{x:e.point.x,y:t.point.y};const i=e.point.y-e.k*e.point.x,r=(t.point.y-t.k*t.point.x-i)/(e.k-t.k),o=e.k*r+i;return{x:r,y:o}}function pointsToRect(e,t){const i=getIntersectPoint({from:e[0],to:e[2]},{from:e[1],to:e[3]});for(const s of e)rotatePoint(s,-t,i);return getRectOfPoints(e)}function resizeRect(e,t,i,s){let r=e.rotate?e.rotate%360:0;if(r){const o=rectToPoints(e),n=(o[0].y-o[1].y)/(o[0].x-o[1].x),c=(o[1].y-o[2].y)/(o[1].x-o[2].x);if(s<4){if(o[s].x+=t,e.ratio)if(s===0||s===2){let l=t*Math.tan((90-(360-r)-Math.atan(e.width/e.height)/Math.PI*180)/180*Math.PI);o[s].y+=l}else{let l=t*Math.tan((90-(360-r)+Math.atan(e.width/e.height)/Math.PI*180)/180*Math.PI);o[s].y+=l}else o[s].y+=i;const h=o[(s+2)%4];o[(s+1)%4]=getIntersectPointByK({k:s%2?c:n,point:o[s]},{k:s%2?n:c,point:h}),o[(s+4-1)%4]=getIntersectPointByK({k:s%2?n:c,point:o[s]},{k:s%2?c:n,point:h})}else{const h=[4,6].includes(s)?c:n;isEqual(h,0)?(o[s%4].x+=t,o[(s+1)%4].x+=t):(o[s%4].y+=i,o[s%4].x+=i/h,o[(s+1)%4].y+=i,o[(s+1)%4].x+=i/h)}if((o[0].x-o[1].x)**2+(o[0].y-o[1].y)**2<25||(o[1].x-o[2].x)**2+(o[1].y-o[2].y)**2<25)return;const a=pointsToRect(o,e.rotate);calcCenter(a),Object.assign(e,a);return}switch(s){case 0:if(e.width-t<5||e.height-i<5)break;e.x+=t,e.y+=i,e.width-=t,e.height-=i;break;case 1:if(e.width+t<5||e.height-i<5)break;e.ex+=t,e.y+=i,e.width+=t,e.height-=i;break;case 2:if(e.width+t<5||e.height+i<5)break;e.ex+=t,e.ey+=i,e.width+=t,e.height+=i;break;case 3:if(e.width-t<5||e.height+i<5)break;e.x+=t,e.ey+=i,e.width-=t,e.height+=i;break;case 4:if(e.height-i<5)break;e.y+=i,e.height-=i;break;case 5:if(e.width+t<5)break;e.ex+=t,e.width+=t;break;case 6:if(e.height+i<5)break;e.ey+=i,e.height+=i;break;case 7:if(e.width-t<5)break;e.x+=t,e.width-=t;break}}function scaleRect(e,t,i,s){e&&(e.width*=t,e.height*=t,scalePoint(e,t,i),calcRightBottom(e),calcCenter(e),s&&calcPivot(e,s))}function calcRelativeRect(e,t){const i={x:(e.x-t.x)/t.width,y:(e.y-t.y)/t.height,width:e.width/t.width,height:e.height/t.height};return calcRightBottom(i),i}function calcRelativePoint(e,t){const{x:i,y:s,width:r,height:o}=t,{penId:n,connectTo:c}=e,a=Object.assign({},e,{x:r?(e.x-i)/r:0,y:o?(e.y-s)/o:0});return e.prev&&(a.prev={penId:n,connectTo:c,x:r?(e.prev.x-i)/r:0,y:o?(e.prev.y-s)/o:0}),e.next&&(a.next={penId:n,connectTo:c,x:r?(e.next.x-i)/r:0,y:o?(e.next.y-s)/o:0}),a}function pointInPolygon(e,t){let i=!1;for(let s=0,r=t.length-1;s<t.length;r=s++){let o=t[s].x,n=t[s].y,c=t[r].x,a=t[r].y;n>e.y!=a>e.y&&e.x<(c-o)*(e.y-n)/(a-n)+o&&(i=!i)}return i}const commandRegex=/^[\t\n\f\r ]*([MLHVZCSQTAmlhvzcsqta])[\t\n\f\r ]*/,flagRegex=/^[01]/,numberRegex=/^[+-]?(([0-9]*\.[0-9]+)|([0-9]+\.)|([0-9]+))([eE][+-]?[0-9]+)?/,commaWsp=/^(([\t\n\f\r ]+,?[\t\n\f\r ]*)|(,[\t\n\f\r ]*))/,grammar={M:[numberRegex,numberRegex],L:[numberRegex,numberRegex],H:[numberRegex],V:[numberRegex],Z:[],C:[numberRegex,numberRegex,numberRegex,numberRegex,numberRegex,numberRegex],S:[numberRegex,numberRegex,numberRegex,numberRegex],Q:[numberRegex,numberRegex,numberRegex,numberRegex],T:[numberRegex,numberRegex],A:[numberRegex,numberRegex,numberRegex,flagRegex,flagRegex,numberRegex,numberRegex]};function parseSvgPath(e){let t=0;const i=[];for(;t<e.length;){const s=e.slice(t).match(commandRegex);if(s!==null){const r=s[1];t+=s[0].length;const o=parseCommands(r,e,t);t=o.cursor,i.push(...o.commands)}else throw new Error("malformed path (first error at "+t+")")}return{commands:i}}function getRect(e){let t=1/0,i=1/0,s=-1/0,r=-1/0;return calcWorldPositions(e),e.commands.forEach(o=>{o.worldPoints.forEach((n,c)=>{c%2===0?(n<t&&(t=n),n>s&&(s=n)):(n<i&&(i=n),n>r&&(r=n))})}),{x:t,y:i,ex:s,ey:r,width:s-t+1,height:r-i+1}}function translatePath(e,t,i){i==null&&(i=t),e.commands.forEach((s,r)=>{if(!(s.relative&&r))switch(s.key){case"A":case"a":s.values[5]+=t,s.values[6]+=i;break;case"V":case"v":s.values[0]+=i;break;default:s.values.forEach((o,n)=>{s.values[n]=o+(n%2===0?t:i)});break}})}function scalePath(e,t,i){i==null&&(i=t),e.commands.forEach(s=>{switch(s.key){case"A":case"a":const r=s.values[0],o=s.values[1],n=Math.PI*s.values[2]/180,c=Math.cos(n),a=Math.sin(n),h=o*o*i*i*c*c+r*r*i*i*a*a,l=2*t*i*c*a*(o*o-r*r),u=r*r*t*t*c*c+o*o*t*t*a*a,d=-(r*r*o*o*t*t*i*i),f=l*l-4*h*u,g=Math.sqrt((h-u)*(h-u)+l*l);s.values[2]=l!==0?Math.atan((u-h-g)/l)*180/Math.PI:h<u?0:90,s.values[0]=-Math.sqrt(2*f*d*(h+u+g))/f,s.values[1]=-Math.sqrt(2*f*d*(h+u-g))/f,s.values[5]*=t,s.values[6]*=i,s.values[4]=t*i>=0?s.values[4]:1-s.values[4];break;case"V":case"v":s.values[0]*=i;break;default:s.values.forEach((y,v)=>{s.values[v]=y*(v%2===0?t:i)});break}})}function pathToString(e){let t="";return e.commands.forEach(i=>{t+=i.key+" ",i.values.forEach(s=>{t+=s+" "})}),t}function parseCommands(e,t,i){const s=grammar[e.toUpperCase()],r=[];for(;i<=t.length;){const o={key:e,values:[]};for(const n of s){const c=t.slice(i).match(n);if(c!==null){o.values.push(+c[0]),i+=c[0].length;const a=t.slice(i).match(commaWsp);a!==null&&(i+=a[0].length)}else{if(o.values.length===0)return{cursor:i,commands:r};throw new Error("malformed path (first error at "+i+")")}}if(o.relative=o.key.toUpperCase()!==o.key,r.push(o),s.length===0)return{cursor:i,commands:r};e==="m"&&(e="l"),e==="M"&&(e="L")}throw new Error("malformed path (first error at "+i+")")}function calcWorldPoints(e,t){const i=[];let s=e.relative&&t?{x:t.worldPoints[t.worldPoints.length-2],y:t.worldPoints[t.worldPoints.length-1]}:{x:0,y:0};for(let r=0;r<e.values.length-1;r+=2)i.push(s.x+e.values[r]),i.push(s.y+e.values[r+1]);e.worldPoints=i}function calcWorldPositions(e){let t,i=0,s=0;e.commands.forEach(r=>{switch(r.key){case"Z":case"z":r.worldPoints=[i,s];break;case"H":r.worldPoints=[r.values[0],t.worldPoints[t.worldPoints.length-1]];break;case"h":r.worldPoints=[r.values[0]+t.worldPoints[t.worldPoints.length-2],t.worldPoints[t.worldPoints.length-1]];break;case"V":r.worldPoints=[t.worldPoints[t.worldPoints.length-2],r.values[0]];break;case"v":r.worldPoints=[t.worldPoints[t.worldPoints.length-2],r.values[0]+t.worldPoints[t.worldPoints.length-1]];break;case"A":r.worldPoints=[t.worldPoints[t.worldPoints.length-2],r.values[0]+t.worldPoints[t.worldPoints.length-1]];break;default:calcWorldPoints(r,t);break}(r.key==="M"||r.key==="m"||r.key==="Z"||r.key==="z")&&(i=r.worldPoints[r.worldPoints.length-2],s=r.worldPoints[r.worldPoints.length-1]),t=r})}function svgPath(e,t){var a;const s=e.calculative.canvas.store.data.paths[e.pathId];if(!s)return new Path2D;const r=parseSvgPath(s);e.calculative.svgRect=getRect(r),calcCenter(e.calculative.svgRect),(e.calculative.svgRect.width!==e.calculative.worldRect.width||e.calculative.svgRect.height!==e.calculative.worldRect.height)&&scalePath(r,e.calculative.worldRect.width/e.calculative.svgRect.width,e.calculative.worldRect.height/e.calculative.svgRect.height);const o=getRect(r);calcCenter(o),translatePath(r,e.calculative.worldRect.x-o.x,e.calculative.worldRect.y-o.y);const n=pathToString(r);if(t){(a=t.svgPath)==null||a.call(t,n);return}return new Path2D(n)}function diamond(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s+o/2,r),i.lineTo(s+o,r+n/2),i.lineTo(s+o/2,r+n),i.lineTo(s,r+n/2),i.lineTo(s+o/2,r),i.closePath(),i instanceof Path2D)return i}function triangle(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s+o/2,r),i.lineTo(s+o,r+n),i.lineTo(s,r+n),i.lineTo(s+o/2,r),i.closePath(),i instanceof Path2D)return i}function triangleAnchors(e){const t=[{x:.5,y:0},{x:.75,y:.5},{x:.5,y:1},{x:.25,y:.5}];e.anchors=t.map(({x:i,y:s},r)=>({id:`${r}`,penId:e.id,x:i,y:s}))}function pentagon(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s+o/2,r),i.lineTo(s+o,r+n*2/5),i.lineTo(s+o*4/5,r+n),i.lineTo(s+o/5,r+n),i.lineTo(s,r+n*2/5),i.closePath(),i instanceof Path2D)return i}function pentagonAnchors(e){const t=[{x:.5,y:0},{x:1,y:.4},{x:.8,y:1},{x:.2,y:1},{x:0,y:.4}];e.anchors=t.map(({x:i,y:s},r)=>({id:`${r}`,penId:e.id,x:i,y:s}))}function pentagram(e,t){e.onResize||(e.onResize=resize$2);const i=t||new Path2D,{width:s,height:r,center:o}=e.calculative.worldRect,n=s>r?r:s,c=o.x,a=o.y,h=a-n/2,l=a-n/4,u=-(l-a)*Math.sin(Math.PI/180*324)+c,d=(l-a)*Math.cos(Math.PI/180*324)+a;i.moveTo(u,d);for(let f=0;f<5;++f)i.lineTo(-(h-a)*Math.sin(Math.PI/180*72*f)+c,(h-a)*Math.cos(Math.PI/180*72*f)+a),i.lineTo((u-c)*Math.cos(Math.PI/180*72*(f+1))-(d-a)*Math.sin(Math.PI/180*72*(f+1))+c,(u-c)*Math.sin(Math.PI/180*72*(f+1))+(d-a)*Math.cos(Math.PI/180*72*(f+1))+a);if(i.closePath(),i instanceof Path2D)return i}function pentagramAnchors(e){const{width:t,height:i}=e,s=t>i?i:t,r=[];for(let o=0;o<5;++o)r.push({flag:1,id:String(o),penId:e.id,x:.5+s/2*Math.sin(Math.PI/180*72*o)/t,y:-s/2*Math.cos(Math.PI/180*72*o)/i+.5});e.anchors=r}function resize$2(e){const t=e.anchors.filter(i=>i.flag!==1);pentagramAnchors(e),e.anchors=e.anchors.concat(...t)}function hexagon(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s+o/4,r),i.lineTo(s+o*3/4,r),i.lineTo(s+o,r+n/2),i.lineTo(s+o*3/4,r+n),i.lineTo(s+o*1/4,r+n),i.lineTo(s,r+n/2),i.lineTo(s+o/4,r),i.closePath(),i instanceof Path2D)return i}function leftArrow(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s,r+n/2),i.lineTo(s+n/2,r),i.lineTo(s+n/2,r+n/3),i.lineTo(s+o,r+n/3),i.lineTo(s+o,r+n*2/3),i.lineTo(s+n/2,r+n*2/3),i.lineTo(s+n/2,r+n*2/3),i.lineTo(s+n/2,r+n),i.closePath(),i instanceof Path2D)return i}function rightArrow(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s,r+n/3),i.lineTo(s+(o-n/2),r+n/3),i.lineTo(s+(o-n/2),r),i.lineTo(s+o,r+n/2),i.lineTo(s+(o-n/2),r+n),i.lineTo(s+(o-n/2),r+n*2/3),i.lineTo(s,r+n*2/3),i.closePath(),i instanceof Path2D)return i}function twowayArrow(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s,r+n/2),i.lineTo(s+n/2,r),i.lineTo(s+n/2,r+n/3),i.lineTo(s+(o-n/2),r+n/3),i.lineTo(s+(o-n/2),r),i.lineTo(s+o,r+n/2),i.lineTo(s+(o-n/2),r+n),i.lineTo(s+(o-n/2),r+n*2/3),i.lineTo(s+n/2,r+n*2/3),i.lineTo(s+n/2,r+n),i.closePath(),i instanceof Path2D)return i}function message(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n,ey:c}=e.calculative.worldRect;if(i.moveTo(s,r),i.lineTo(s+o,r),i.lineTo(s+o,r+n*3/4),i.lineTo(s+o*8/16,r+n*3/4),i.lineTo(s+o/4,c),i.lineTo(s+o*5/16,r+n*3/4),i.lineTo(s,r+n*3/4),i.closePath(),i instanceof Path2D)return i}function cloud(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s+o/5,r+n*13/16),i.bezierCurveTo(s-o/15,r+n*13/16,s-o/15,r+n*7/16,s+o/5,r+n*7/16),i.bezierCurveTo(s+o/5,r,s+o*4/5,r,s+o*4/5,r+n*7/16),i.bezierCurveTo(s+o*16/15,r+n*7/16,s+o*16/15,r+n*13/16,s+o*4/5,r+n*13/16),i.closePath(),i instanceof Path2D)return i}function file(e,t){const i=t||new Path2D,{x:s,y:r,width:o,ex:n,ey:c}=e.calculative.worldRect,a=o/6;if(i.moveTo(s,r),i.lineTo(n-a,r),i.lineTo(n,r+a),i.lineTo(n,c),i.lineTo(s,c),i.closePath(),i.moveTo(n-a,r),i.lineTo(n-a,r+a),i.lineTo(n,r+a),i.closePath(),i instanceof Path2D)return i}function cube(e,t){const{x:i,y:s,width:r,ex:o,ey:n}=t.calculative.worldRect;let c=r*.25;const a=t.z;a>1?c=a*t.calculative.canvas.store.data.scale:a>0&&(c=r*a);const h={x:i,y:s+c},l={x:o-c,y:s+c},u={x:o-c,y:n};face(e,[h,l,u,{x:i,y:n}],t.backgroundFront||t.background,t.color),face(e,[h,{x:i+c,y:s},{x:o,y:s},l],t.backgroundUp||t.background,t.color),face(e,[l,{x:o,y:s},{x:o,y:n-c},u],t.backgroundRight||t.background,t.color)}function face(e,t,i="",s=""){e.save(),i&&(e.fillStyle=i),s&&(e.strokeStyle=s),e.beginPath();for(let r=0;r<t.length;++r)r?e.lineTo(t[r].x,t[r].y):e.moveTo(t[r].x,t[r].y);e.closePath(),i&&e.fill(),e.stroke(),e.restore()}function people(e,t){const i=t||new Path2D,{x:s,y:r,width:o,ex:n,ey:c}=e.calculative.worldRect,a=o/4,h=s+o/2;if(i.arc(h,r+a,a,0,Math.PI*2),i.moveTo(s,r+a*3),i.lineTo(n,r+a*3),i.moveTo(h,r+a*2),i.lineTo(h,r+a*4),i.moveTo(h,r+a*4),i.lineTo(s,c),i.moveTo(h,r+a*4),i.lineTo(n,c),i.closePath(),i instanceof Path2D)return i}function curve(e,t,i){if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),i)t.calculative.activeAnchor&&(t.calculative.activeAnchor.next={penId:t.id,x:i.x,y:i.y},distance(t.calculative.activeAnchor.next,t.calculative.activeAnchor)<5?t.calculative.activeAnchor.next=void 0:(t.calculative.activeAnchor.prev={...t.calculative.activeAnchor.next},rotatePoint(t.calculative.activeAnchor.prev,180,t.calculative.activeAnchor)));else{const s=t.calculative.worldAnchors[0];if(!s.next){const o=facePen(s,e.pens[s.connectTo]);calcCurveCP(s,o,50),s.prev=void 0}const r=t.calculative.worldAnchors[t.calculative.worldAnchors.length-1];if(r&&r!==s&&!r.prev){const o=facePen(r,e.pens[r.connectTo]);calcCurveCP(r,o,-50),r.next=void 0}}}function calcCurveCP(e,t,i){switch(t){case Direction.Up:e.prev={penId:e.penId,x:e.x,y:e.y+i},e.next={penId:e.penId,x:e.x,y:e.y-i};break;case Direction.Right:e.prev={penId:e.penId,x:e.x-i,y:e.y},e.next={penId:e.penId,x:e.x+i,y:e.y};break;case Direction.Bottom:e.prev={penId:e.penId,x:e.x,y:e.y-i},e.next={penId:e.penId,x:e.x,y:e.y+i};break;case Direction.Left:e.prev={penId:e.penId,x:e.x+i,y:e.y},e.next={penId:e.penId,x:e.x-i,y:e.y};break}}function getQuadraticPoint(e,t,i,s){const r=1-e,o=r*r*t.x+2*r*e*i.x+e*e*s.x,n=r*r*t.y+2*r*e*i.y+e*e*s.y;return{x:o,y:n,step:e}}function getBezierPoint(e,t,i,s,r){const{x:o,y:n}=t,{x:c,y:a}=r,{x:h,y:l}=i,{x:u,y:d}=s,f=1-e,g=o*f*f*f+3*h*e*f*f+3*u*e*e*f+c*e*e*e,y=n*f*f*f+3*l*e*f*f+3*d*e*e*f+a*e*e*e;return{x:g,y,step:e}}function lerp(e,t,i){return{x:e.x+i*(t.x-e.x),y:e.y+i*(t.y-e.y)}}function getSplitAnchor(e,t,i){let s=e.calculative.worldAnchors[i],r=e.calculative.worldAnchors[i+1];!r&&e.close&&(r=e.calculative.worldAnchors[0]);const o=t.step;let n;if(s.next&&r.prev){const c=s,a=s.next,h=r.prev,l=r,u=lerp(c,a,o),d=lerp(a,h,o),f=lerp(h,l,o),g=lerp(u,d,o),y=lerp(d,f,o);n=lerp(g,y,o),g.penId=e.id,n.prev=g,y.penId=e.id,n.next=y,s.next.x=u.x,s.next.y=u.y,r.prev.x=f.x,r.prev.y=f.y}else if(s.next||r.prev){const c=s,a=s.next||r.prev,h=r,l=lerp(c,a,o),u=lerp(a,h,o);n=t,l.penId=e.id,u.penId=e.id,n.prev=l,n.next=u,s.next=void 0,r.prev=void 0}else n=t;return n.penId=e.id,n.id=s8(),n.prevNextType=PrevNextType.Bilateral,n}function mind(e,t,i){if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),t.calculative.worldAnchors.length<2)return;let s=t.calculative.activeAnchor,r=i||getToAnchor(t);if(!s||!r)return;const o=20,n=e.pens[s.connectTo];let c=facePen(s,n);switch(c===Direction.None&&(r.x>s.x?c=Direction.Right:c=Direction.Left),s.next={id:s8(),penId:t.id,x:s.x,y:s.y,prevNextType:2},r.prev={id:s8(),penId:t.id,x:r.x,y:r.y,prevNextType:2},c){case Direction.Up:s.next.y-=o,r.prev.y=s.y;break;case Direction.Bottom:s.next.y+=o,r.prev.y=s.y;break;case Direction.Left:s.next.x-=o,r.prev.x=s.x;break;default:s.next.x+=o,r.prev.x=s.x;break}}function line(e,t){const i=t||new Path2D;if((e.lineName==="line"||e.lineName==="polyline")&&e.calculative.lineSmooth){let r=getGradientAnimatePath(e);if(i instanceof Path2D&&i.addPath(r),i instanceof Path2D)return i}const s=e.calculative.worldAnchors;if(s.length>1){let r;s.forEach(o=>{r?draw(i,r,o):o.start=!0,r=o}),e.close&&(e.lineName==="curve"?draw(i,r,s[0]):i.closePath())}if(i instanceof Path2D)return i}function lineSegment(e,t,i){var o;if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),t.calculative.worldAnchors.length<2||((o=t.anchors)==null?void 0:o.length)>1)return;const s=getFromAnchor(t),r=getToAnchor(t);!s||!r||!r.id||s===r||(s.next=void 0,deleteTempAnchor(t),r.prev=void 0,t.calculative.worldAnchors.push(r))}function draw(e,t,i){!i||i.isTemp||(t.start&&e.moveTo(t.x,t.y),t.next?i.prev?e.bezierCurveTo(t.next.x,t.next.y,i.prev.x,i.prev.y,i.x,i.y):e.quadraticCurveTo(t.next.x,t.next.y,i.x,i.y):i.prev?e.quadraticCurveTo(i.prev.x,i.prev.y,i.x,i.y):e.lineTo(i.x,i.y))}function getLineRect(e){return getLineLength(e),getRectOfPoints(getLinePoints(e))}function getLinePoints(e){const t=[];let i;return e.calculative.worldAnchors.forEach(s=>{t.push(s),i&&t.push(...getPoints(i,s,e)),i=s}),e.close&&e.calculative.worldAnchors.length>1&&t.push(...getPoints(i,e.calculative.worldAnchors[0],e)),t}function getLineR(e){return e!=null&&e.lineWidth?e.lineWidth/2+4:4}function getPoints(e,t,i){const s=[];if(!t)return s;let r=.02;if(e.lineLength&&!i.parentId&&(r=getLineR(i)/e.lineLength),e.next)if(t.prev)for(let o=r;o<1;o+=r)s.push(getBezierPoint(o,e,e.next,t.prev,t));else for(let o=r;o<1;o+=r)s.push(getQuadraticPoint(o,e,e.next,t));else if(t.prev)for(let o=r;o<1;o+=r)s.push(getQuadraticPoint(o,e,t.prev,t));else s.push({x:t.x,y:t.y});return s.length>1&&(e.curvePoints=s),s}function pointInLine(e,t){const i=getLineR(t);let s=0,r,o;for(const n of t.calculative.worldAnchors){if(r){if(o=pointInLineSegment(e,r,n,i),o)return{i:s,point:o};++s}r=n}if(t.close&&t.calculative.worldAnchors.length>1&&(o=pointInLineSegment(e,r,t.calculative.worldAnchors[0],i)))return{i:s,point:o}}function pointInLineSegment(e,t,i,s=4){if(!t.next&&!i.prev){const{x:r,y:o}=t,{x:n,y:c}=i,a=Math.min(r,n),h=Math.max(r,n),l=Math.min(o,c),u=Math.max(o,c);return e.x>=a-s&&e.x<=h+s&&e.y>=l-s&&e.y<=u+s?pointToLine(e,t,i,s):void 0}else if(t.curvePoints){for(const r of t.curvePoints)if(hitPoint(e,r,s))return r}}function pointToLine(e,t,i,s=4){if(t.x===i.x){if(Math.abs(e.x-t.x)<=s)return{x:t.x,y:e.y}}else{const r=(t.y-i.y)/(t.x-i.x),o=t.y-r*t.x;if(Math.abs((r*e.x+o-e.y)/Math.sqrt(r*r+1))<=s){const a=(e.x+r*e.y-r*o)/(r*r+1);return{x:a,y:r*a+o}}}}function lineLen(e,t,i,s){if(!t&&!i)return Math.sqrt(Math.pow(Math.abs(e.x-s.x),2)+Math.pow(Math.abs(e.y-s.y),2))||0;const r=document.createElementNS("http://www.w3.org/2000/svg","path");return t&&i?r.setAttribute("d",`M${e.x} ${e.y} C${t.x} ${t.y} ${i.x} ${i.y} ${s.x} ${s.y}`):t?r.setAttribute("d",`M${e.x} ${e.y} Q${t.x} ${t.y} ${s.x} ${s.y}`):r.setAttribute("d",`M${e.x} ${e.y} Q${i.x} ${i.y} ${s.x} ${s.y}`),r.getTotalLength()||0}function getLineLength(e){if(e.calculative.worldAnchors.length<2)return 0;let t=0,i;if(e.calculative.worldAnchors.forEach(s=>{i&&(i.lineLength=lineLen(i,i.next,s.prev,s),t+=i.lineLength),i=s}),e.close){const s=getFromAnchor(e);i.lineLength=lineLen(i,i.next,s.prev,s),t+=i.lineLength}return e.calculative.animatePos&&(e.calculative.animatePos=t/e.length*e.calculative.animatePos),e.length=t,t}function lineInRect(e,t){const i=e.calculative.worldAnchors;for(let s=0;s<i.length-1;s++){const r=i[s],o=i[s+1];if(!r.next&&!o.prev){if(isLineIntersectRectangle(r,o,t))return!0}else if(isBezierIntersectRectangle(r,o,t))return!0}return!1}function isLineIntersectRectangle(e,t,i){if(pointInSimpleRect(e,i)||pointInSimpleRect(t,i))return!0;const s=e.x,r=e.y,o=t.x,n=t.y;let c=i.x,a=i.y,h=i.ex,l=i.ey;const u=r-n,d=o-s,f=s*n-o*r;if(u*c+d*a+f>=0&&u*h+d*l+f<=0||u*c+d*a+f<=0&&u*h+d*l+f>=0||u*c+d*l+f>=0&&u*h+d*a+f<=0||u*c+d*l+f<=0&&u*h+d*a+f>=0){if(c>h){const g=c;c=h,h=g}if(a<l){const g=a;a=l,l=g}return!(s<c&&o<c||s>h&&o>h||r>a&&n>a||r<l&&n<l)}else return!1}function isBezierIntersectRectangle(e,t,i){if(!e.next&&!t.prev)return isLineIntersectRectangle(e,t,i);if(e.next&&t.prev)for(let r=.02;r<1;r+=.02){const o=getBezierPoint(r,e,e.next,t.prev,t);if(pointInSimpleRect(o,i))return!0}else if(e.next||t.prev)for(let r=.02;r<1;r+=.02){const o=getQuadraticPoint(r,e,e.next||t.prev,t);if(pointInSimpleRect(o,i))return!0}return!1}function createSvgPath(e,t,i,s,r){let o="";return e||(o+=`M${t.x} ${t.y} `,e=document.createElementNS("http://www.w3.org/2000/svg","path"),e.setAttribute("d",o)),o=e.getAttribute("d")||"",i&&s?o+=`C${i.x} ${i.y} ${s.x} ${s.y} ${r.x} ${r.y}`:i?o+=`Q${i.x} ${i.y} ${r.x} ${r.y}`:o+=`Q${(s==null?void 0:s.x)||t.x} ${(s==null?void 0:s.y)||t.y} ${r.x} ${r.y}`,e.setAttribute("d",o),e}function getLinePointPosAndAngle(e,t){const i=e.getTotalLength();if(t<0||t>i)return null;const s=.01,r=e.getPointAtLength(t),o=e.getPointAtLength(t-s),n=Math.atan2(r.y-o.y,r.x-o.x);return{x:r.x,y:r.y,rotate:n/Math.PI*180,progress:t/i}}let faceSpace=10;function polyline(e,t,i){var y;if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),faceSpace=e.options.polylineSpace||10,t.calculative.worldAnchors.length<2)return;let s=getFromAnchor(t),r=getToAnchor(t);if(!s||!r)return;let o;if((y=t.anchors)!=null&&y.length&&s===t.calculative.activeAnchor?(o=!0,s=r,r=getFromAnchor(t)):(!t.anchors||!t.anchors.length)&&s!==t.calculative.activeAnchor&&(s=t.calculative.activeAnchor),!s||!r)return;s.next=void 0,r.prev=void 0;const n=r.connectTo;deleteTempAnchor(t);const c=[],a=e.pens[s.connectTo],h=e.pens[r.connectTo],l=facePen(s,a),u=facePen(r,h);let d=getFacePoint(s,l,faceSpace);d&&(s=d,c.push(d)),d=getFacePoint(r,u,faceSpace);const f=r;let g;if(d&&(r=d,f.connectTo&&(d.y>f.y&&s.y<f.y||d.y<f.y&&s.y>f.y))){g=d;let v=faceSpace;s.x<d.x&&(v=-v),Math.abs(s.x-d.x)<v&&(v=-v),r={x:d.x+v,y:d.y,id:s8()}}switch(l){case Direction.Up:c.push(...getNextPointsOfUp(s,r,u));break;case Direction.Right:c.push(...getNextPointsOfRight(s,r,u));break;case Direction.Bottom:c.push(...getNextPointsOfBottom(s,r,u));break;case Direction.Left:c.push(...getNextPointsOfLeft(s,r,u));break;default:c.push(...getNextPoints(t,s,r));break}if(c.forEach(v=>{v.id=s8(),v.penId=t.id,t.calculative.worldAnchors.push(v)}),t.calculative.worldAnchors.push(r),g&&t.calculative.worldAnchors.push(g),d&&t.calculative.worldAnchors.push(f),o&&t.calculative.worldAnchors.reverse(),n){const v=t.calculative.worldAnchors.length-2;t.calculative.worldAnchors[v].isTemp=!1,t.calculative.worldAnchors[1].isTemp=!1}}function getFacePoint(e,t,i){const s={x:e.x,y:e.y,id:s8()};switch(t){case Direction.Up:s.y-=i;break;case Direction.Right:s.x+=i;break;case Direction.Bottom:s.y+=i;break;case Direction.Left:s.x-=i;break;default:return}return s}function getNextPointsOfUp(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let r,o;switch(i){case Direction.Up:e.y<t.y?(r=t.x,o=e.y):(r=e.x,o=t.y),s.push({x:r,y:o});break;case Direction.Bottom:if(r=t.x,o=e.y,t.y>e.y)r=e.x+(t.x-e.x)/2,s.push({x:r,y:e.y},{x:r,y:t.y});else{const n=(e.y+t.y)/2;s.push({x:e.x,y:n},{x:t.x,y:n})}break;case Direction.Right:r=t.x,o=e.y,t.x<e.x&&t.y<e.y&&(r=e.x,o=t.y),s.push({x:r,y:o});break;case Direction.Left:r=t.x,o=e.y,t.x>e.x&&t.y<e.y&&(r=e.x,o=t.y),s.push({x:r,y:o});break;default:if(t.y>e.y-faceSpace)r=e.x+(t.x-e.x)/2,s.push({x:r,y:e.y},{x:r,y:t.y});else{const n=(e.y+t.y+faceSpace)/2;s.push({x:e.x,y:n},{x:t.x,y:n})}break}return s}function getNextPointsOfRight(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let r,o;switch(i){case Direction.Up:r=e.x,o=t.y,t.x>e.x&&t.y>e.y&&(r=t.x,o=e.y),s.push({x:r,y:o});break;case Direction.Bottom:r=e.x,o=t.y,t.x>e.x&&t.y<e.y&&(r=t.x,o=e.y),s.push({x:r,y:o});break;case Direction.Left:if(r=t.x,o=e.y,t.x<e.x)o=e.y+(t.y-e.y)/2,s.push({x:e.x,y:o},{x:t.x,y:o});else{const n=(e.x+t.x)/2;s.push({x:n,y:o},{x:n,y:t.y})}break;case Direction.Right:t.x<e.x?s.push({x:e.x,y:t.y}):s.push({x:t.x,y:e.y});break;default:if(r=t.x,o=t.y,t.x<e.x+faceSpace)s.push({x:e.x,y:o});else{const n=(e.x+t.x-faceSpace)/2;s.push({x:n,y:e.y},{x:n,y:o})}break}return s}function getNextPointsOfBottom(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let r,o;switch(i){case Direction.Up:if(r=e.x,o=t.y,t.y<e.y)r=e.x+(t.x-e.x)/2,s.push({x:r,y:e.y},{x:r,y:t.y});else{const n=(e.y+t.y)/2;s.push({x:r,y:n},{x:t.x,y:n})}break;case Direction.Right:r=t.x,o=e.y,t.x<e.x&&t.y>e.y&&(r=e.x,o=t.y),s.push({x:r,y:o});break;case Direction.Bottom:e.y>t.y?(r=t.x,o=e.y):(r=e.x,o=t.y),s.push({x:r,y:o});break;case Direction.Left:r=t.x,o=e.y,t.x>e.x&&t.y>e.y&&(r=e.x,o=t.y),s.push({x:r,y:o});break;default:if(r=e.x,t.y<e.y+faceSpace)r=e.x+(t.x-e.x)/2,s.push({x:r,y:e.y},{x:r,y:t.y});else{const n=(e.y+t.y-faceSpace)/2;s.push({x:r,y:n},{x:t.x,y:n})}break}return s}function getNextPointsOfLeft(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let r,o;switch(i){case Direction.Up:r=e.x,o=t.y,t.x<e.x&&t.y>e.y&&(r=t.x,o=e.y),s.push({x:r,y:o});break;case Direction.Bottom:r=e.x,o=t.y,t.x<e.x&&t.y<e.y&&(r=t.x,o=e.y),s.push({x:r,y:o});break;case Direction.Right:if(r=e.x,o=t.y,t.x>e.x)r=t.x,o=e.y+(t.y-e.y)/2,s.push({x:e.x,y:o},{x:t.x,y:o});else{const n=(e.x+t.x)/2;s.push({x:n,y:e.y},{x:n,y:t.y})}break;case Direction.Left:t.x>e.x?s.push({x:e.x,y:t.y}):s.push({x:t.x,y:e.y});break;default:if(r=e.x,o=t.y,t.x<e.x-faceSpace){const n=(e.x+t.x+faceSpace)/2;s.push({x:n,y:e.y},{x:n,y:o})}else s.push({x:e.x,y:o});break}return s}function getNextPoints(e,t,i){const s=[];e.calculative.drawlineH==null&&(e.calculative.drawlineH=Math.abs(i.x-t.x)>Math.abs(i.y-t.y));let r=e.calculative.worldAnchors.findIndex(o=>o.id==t.id);if(r>1){let o=e.calculative.worldAnchors[r-1];if(o.x===t.x&&o.y!==t.y)return s.push({x:i.x,y:t.y}),s;if(o.y===t.y&&o.x!==t.x)return s.push({x:t.x,y:i.y}),s}return e.calculative.worldAnchors.length&&(i.isTemp=void 0,e.calculative.drawlineH?(s.push({x:i.x,y:t.y}),Math.abs(i.y-t.y)<faceSpace&&(i.isTemp=!0)):(s.push({x:t.x,y:i.y}),Math.abs(i.x-t.x)<faceSpace&&(i.isTemp=!0))),s}function anchorInHorizontal(e,t,i=!0){var r,o;let s=e.calculative.worldAnchors;i||(s=[],e.calculative.worldAnchors.forEach(n=>{s.unshift(n)}));for(let n=0;n<s.length&&s[n].id!==t.id;n++)if(s[n].y!==t.y||s[n].x===((r=s[n+1])==null?void 0:r.x)&&s[n].y!==((o=s[n+1])==null?void 0:o.y))return!1;return!0}function anchorInVertical(e,t,i=!0){var r,o;let s=e.calculative.worldAnchors;i||(s=[],e.calculative.worldAnchors.forEach(n=>{s.unshift(n)}));for(let n=0;n<s.length&&s[n].id!==t.id;n++)if(s[n].x!==t.x||s[n].y===((r=s[n+1])==null?void 0:r.y)&&s[n].x!==((o=s[n+1])==null?void 0:o.x))return!1;return!0}function translatePolylineAnchor(e,t,i){if(!e.calculative.worldAnchors)return;const s=e.calculative.worldAnchors.findIndex(a=>a.id===t.id),r=getFromAnchor(e),o=getToAnchor(e);let n=e.calculative.worldAnchors[s-1],c=e.calculative.worldAnchors[s+1];if(e.calculative.h==null&&(r.connectTo&&(anchorInHorizontal(e,t,!0)?e.calculative.h=!0:anchorInVertical(e,t,!0)&&(e.calculative.h=!1)),e.calculative.h==null&&o.connectTo&&(anchorInHorizontal(e,t,!1)?e.calculative.h=!0:anchorInVertical(e,t,!1)&&(e.calculative.h=!1)),e.calculative.h==null&&(n?e.calculative.h=n.y===t.y:c&&(e.calculative.h=c.y===t.y))),e.calculative.h){if(t.x=i.x,r.connectTo&&anchorInHorizontal(e,t,!0)){c&&c.y!==t.y&&(c.x=t.x);return}if(o.connectTo&&anchorInHorizontal(e,t,!1)){n&&n.y!==t.y&&(n.x=t.x);return}const a=e.anchors[s];let h;for(let l=s-1;l>-1;l--)if(n=e.anchors[l],h==null&&(h=n.y===a.y),h===!0)if(n.y===a.y)e.calculative.worldAnchors[l].y=i.y;else break;else if(n.x===a.x)e.calculative.worldAnchors[l].x=i.x;else break;h=void 0;for(let l=s+1;l<e.calculative.worldAnchors.length&&(c=e.anchors[l],c);l++)if(h==null&&(h=c.y===a.y),h===!0)if(c.y===a.y)e.calculative.worldAnchors[l].y=i.y;else break;else if(c.x===a.x)e.calculative.worldAnchors[l].x=i.x;else break;t.y=i.y}else{if(t.y=i.y,r.connectTo&&anchorInVertical(e,t,!0)){c&&c.x!==t.x&&(c.y=t.y);return}if(o.connectTo&&anchorInVertical(e,t,!1)){n&&n.x!==t.x&&(n.y=t.y);return}const a=e.anchors[s];let h;for(let l=s-1;l>-1;l--)if(n=e.anchors[l],h==null&&(h=n.x===a.x),h===!0)if(n.x===a.x)e.calculative.worldAnchors[l].x=i.x;else break;else if(n.y===a.y)e.calculative.worldAnchors[l].y=i.y;else break;h=void 0;for(let l=s+1;l<e.calculative.worldAnchors.length&&(c=e.anchors[l],c);l++)if(h==null&&(h=c.x===a.x),h===!0)if(c.x===a.x)e.calculative.worldAnchors[l].x=i.x;else break;else if(c.y===a.y)e.calculative.worldAnchors[l].y=i.y;else break;t.x=i.x}}function simplify(e,t,i,s){const r=[];let o,n,c,a,h,l,u,d,f,g,y,v,b,x;f=e[i],g=e[s],c=f.x,a=f.y,u=g.x-c,d=g.y-a,x=u*u+d*d,o=t;for(let m=i+1;m<s;m++)y=e[m],u!==0||d!==0?(v=((y.x-c)*u+(y.y-a)*d)/x,v>1?(h=y.x-g.x,l=y.y-g.y):v>0?(h=y.x-(c+u*v),l=y.y-(a+d*v)):(h=y.x-c,l=y.y-a)):(h=y.x-c,l=y.y-a),b=h*h+l*l,b>o&&(n=m,o=b);return o>t&&(n-i>1&&r.push(...simplify(e,t,i,n)),r.push({id:e[n].id,penId:e[n].penId,x:e[n].x,y:e[n].y}),s-n>1&&r.push(...simplify(e,t,n,s))),r}function smoothLine(e,t=.8,i=!1){if(e.length<3)return e;let s,r,o,n,c,a,h,l,u,d,f,g,y,v,b;const x=(m,T,I,P)=>(n=Math.sqrt(m*m+T*T),n>0?(g=m/n,v=T/n):(g=1,v=0),c=Math.sqrt(I*I+P*P),c>0?(y=I/c,b=P/c):(y=1,b=0),Math.acos(g*y+v*b));d=[],f=e.length,s=e[0],e[f-1],d.push({...e[0]});for(let m=0;m<f-1;m++){if(r=e[m],o=e[m+1],u=Math.abs(x(r.x-s.x,r.y-s.y,o.x-r.x,o.y-r.y)),n)if(u<t*3.14)if(i&&(n=Math.min(n,c),c=n),a=(g+y)/2,h=(v+b)/2,l=Math.sqrt(a*a+h*h),l===0)d.push({...r});else{a/=l,h/=l;const T={...r};T.prevNextType=PrevNextType.Bilateral,T.prev={penId:T.penId,x:r.x-a*n*.25,y:r.y-h*n*.25},T.next={penId:T.penId,x:r.x+a*c*.25,y:r.y+h*c*.25},d.push(T)}else d.push({...r});s=r}return d.push({...e[e.length-1]}),d}function drawArrow(e,t){const i=t||new Path2D,s=e.calculative.worldAnchors;let r=e.calculative.canvas.store.data.scale,o=(e.calculative.animateLineWidth||6)*r,n=(e.animateLineWidth*2||12)*r;e.lineAnimateType===LineAnimateType.WaterDrop&&(n=(e.animateLineWidth*4||24)*r);let c=(e.animateInterval||100)*r,a=e.calculative.lineWidth*(e.calculative.lineSmooth||0),h=(e.calculative.animateLineWidth/2||3)*r;if(e.animateReverse&&(n=-n,o=-o),s.length>1){let l,u=0;for(let d=0;d<s.length;d++){let f=s[d];if(l){let g=getAngle(l,f),y={x:l.x+(e.calculative.animatePos-u)%c*Math.cos(g*Math.PI/180),y:l.y-(e.calculative.animatePos-u)%c*Math.sin(g*Math.PI/180)};e.animateReverse&&(y={x:l.x+(e.length-(e.calculative.animatePos+u))%c*Math.cos(g*Math.PI/180),y:l.y-(e.length-(e.calculative.animatePos+u))%c*Math.sin(g*Math.PI/180)});let v=Math.sqrt((y.x-l.x)**2+(y.y-l.y)**2),b=Math.sqrt((f.x-l.x)**2+(f.y-l.y)**2);for(;v<b;)(e.animateReverse&&v-n<b||!e.animateReverse&&v>n)&&v>a+n&&b-v>a&&(e.lineAnimateType===LineAnimateType.Arrow?arrow(i,y,o,g,h,n):e.lineAnimateType===LineAnimateType.WaterDrop&&waterDrop(i,y,e.animateReverse,g,h,n)),y.x+=c*Math.cos(g*Math.PI/180),y.y-=c*Math.sin(g*Math.PI/180),v=Math.sqrt((y.x-l.x)**2+(y.y-l.y)**2)}l=f}}if(i instanceof Path2D)return i}function getAngle(e,t){let i=t.x-e.x,s=t.y-e.y,r=Math.atan(s/i)*180/Math.PI;return t.x>=e.x?r=-r:r=180-r,r}function getRotatePoint(e,t,i){let s=(180-i)*Math.PI/180;return{x:(e.x-t.x)*Math.cos(s)-(e.y-t.y)*Math.sin(s)+t.x,y:(e.x-t.x)*Math.sin(s)+(e.y-t.y)*Math.cos(s)+t.y}}function arrow(e,t,i,s,r,o){let n=getRotatePoint({x:t.x+i,y:t.y+.57*i},{x:t.x,y:t.y},s),c=getRotatePoint({x:t.x+i,y:t.y-.57*i},{x:t.x,y:t.y},s),a=getRotatePoint({x:t.x+i,y:t.y+r/2},{x:t.x,y:t.y},s),h=getRotatePoint({x:t.x+o,y:t.y+r/2},{x:t.x,y:t.y},s),l=getRotatePoint({x:t.x+i,y:t.y-r/2},{x:t.x,y:t.y},s),u=getRotatePoint({x:t.x+o,y:t.y-r/2},{x:t.x,y:t.y},s);e.moveTo(n.x,n.y),e.lineTo(t.x,t.y),e.lineTo(c.x,c.y),e.lineTo(l.x,l.y),e.lineTo(u.x,u.y),e.lineTo(h.x,h.y),e.lineTo(a.x,a.y),e.lineTo(n.x,n.y)}function waterDrop(e,t,i,s,r,o){let n=r/2;i&&(n=-r/2);let c=getRotatePoint({x:t.x,y:t.y+n},{x:t.x,y:t.y},s),a=getRotatePoint({x:t.x+o,y:t.y},{x:t.x,y:t.y},s),h=Math.PI/2;i&&(h=-Math.PI/2),e.moveTo(t.x,t.y),e.arc(t.x,t.y,r/2,-h-s/180*Math.PI,h-s/180*Math.PI,!1),e.lineTo(a.x,a.y),e.lineTo(c.x,c.y)}function iframe(e){var i;e.onDestroy||(e.onDestroy=destory$3,e.onMove=move$3,e.onResize=move$3,e.onRotate=move$3,e.onValue=move$3,e.onMouseMove=mouseMove$1,e.onBeforeValue=beforeValue,e.onRenderPenRaw=renderPenRaw),e.calculative.singleton||(e.calculative.singleton={});const t=e.calculative.worldRect;if(!e.calculative.singleton.div){const s=document.createElement("div");s.style.position="absolute",s.style.outline="none",s.style.left="-9999px",s.style.top="-9999px",s.style.width=t.width+"px",s.style.height=t.height+"px",document.body.appendChild(s),(i=e.calculative.canvas.externalElements)==null||i.parentElement.appendChild(s),setElemPosition(e,s),e.calculative.singleton.div=s;const r=document.createElement("iframe");r.style.width="100%",r.style.height="100%",r.scrolling=e.scrolling||"no",r.frameBorder="0",r.style.border="none",r.src=e.iframe,e.calculative.iframe=e.iframe,s.appendChild(r),generateAroundDiv(e),r.onload=()=>{r.setAttribute("document.domain","")}}return e.calculative.patchFlags&&setElemPosition(e,e.calculative.singleton.div),e.onRenderPenRaw(e),new Path2D}function destory$3(e){updatePointerEvents(e),e.calculative.singleton&&e.calculative.singleton.div&&(e.calculative.singleton.div.remove(),delete e.calculative.singleton.div)}function move$3(e){e.calculative.singleton.div&&setElemPosition(e,e.calculative.singleton.div)}function beforeValue(e,t){if(t.iframe&&e.calculative.singleton.div&&(e.calculative.singleton.div.children[0].src=t.iframe,e.calculative.iframe=t.iframe),t.operationalRect||t["operationalRect.x"]!==void 0||t["operationalRect.y"]!==void 0||t["operationalRect.width"]!==void 0||t["operationalRect.height"]!==void 0){e.operationalRect||(e.operationalRect={});let i=deepClone(t);i.operationalRect||(i.operationalRect={}),i["operationalRect.x"]!==void 0&&(i.operationalRect.x=i["operationalRect.x"]),i["operationalRect.y"]!==void 0&&(i.operationalRect.y=i["operationalRect.y"]),i["operationalRect.width"]!==void 0&&(i.operationalRect.width=i["operationalRect.width"]),i["operationalRect.height"]!==void 0&&(i.operationalRect.height=i["operationalRect.height"]),Object.assign(e.operationalRect,i.operationalRect),e.calculative.singleton.div&&(e.calculative.singleton.div.children.length===1?generateAroundDiv(e):(e.calculative.singleton.div.children[1].style.height=e.operationalRect.y*100+"%",e.calculative.singleton.div.children[1].style.left=e.operationalRect.x*100+"%",e.calculative.singleton.div.children[1].style.width=e.operationalRect.width*100+"%",e.calculative.singleton.div.children[2].style.width=(1-e.operationalRect.x-e.operationalRect.width)*100+"%",e.calculative.singleton.div.children[3].style.height=(1-e.operationalRect.y-e.operationalRect.height)*100+"%",e.calculative.singleton.div.children[3].style.left=e.operationalRect.x*100+"%",e.calculative.singleton.div.children[3].style.width=e.operationalRect.width*100+"%",e.calculative.singleton.div.children[4].style.width=e.operationalRect.x*100+"%"))}if(t.blur!==void 0)for(let i=1;i<5;i++)e.calculative.singleton.div.children[i].style["backdrop-filter"]=`blur(${t.blur||2}px)`;if(t.blurBackground!==void 0)for(let i=1;i<5;i++)e.calculative.singleton.div.children[i].style.backgroundColor=t.blurBackground;return t}function mouseMove$1(e,t){if(!(!e.calculative.canvas.store.data.locked&&!e.locked)&&initOperationalRect(e.operationalRect)&&e.calculative.zIndex<5&&t.x>e.x+e.width*e.operationalRect.x&&t.x<e.x+e.width*(e.operationalRect.x+e.operationalRect.width)&&t.y>e.y+e.height*e.operationalRect.y&&t.y<e.y+e.height*(e.operationalRect.y+e.operationalRect.height)&&e.calculative.singleton.div){let i=e.calculative.singleton.div.parentNode.children;for(let s=0;s<6;s++)i[s].style.pointerEvents="none"}}function initOperationalRect(e){return e?!e.width||!e.height?!1:(e.x===void 0&&(e.x=(1-e.width)/2),e.y===void 0&&(e.y=(1-e.height)/2),!0):!1}function generateAroundDiv(e){if(!initOperationalRect(e.operationalRect))return;const t=e.calculative.singleton.div;if(!t)return;const i=document.createElement("div");i.style.position="absolute",i.style.left=e.operationalRect.x*100+"%",i.style.top="0px",i.style.width=e.operationalRect.width*100+"%",i.style.height=e.operationalRect.y*100+"%",i.style["backdrop-filter"]=`blur(${e.blur||2}px)`,i.style.backgroundColor=e.blurBackground,t.appendChild(i);const s=document.createElement("div");s.style.position="absolute",s.style.right="0px",s.style.top="0px",s.style.width=(1-e.operationalRect.x-e.operationalRect.width)*100+"%",s.style.height="100%",s.style["backdrop-filter"]=`blur(${e.blur||2}px)`,s.style.backgroundColor=e.blurBackground,t.appendChild(s);const r=document.createElement("div");r.style.position="absolute",r.style.left=e.operationalRect.x*100+"%",r.style.bottom="0px",r.style.width=e.operationalRect.width*100+"%",r.style.height=(1-e.operationalRect.y-e.operationalRect.height)*100+"%",r.style["backdrop-filter"]=`blur(${e.blur||2}px)`,r.style.backgroundColor=e.blurBackground,t.appendChild(r);const o=document.createElement("div");o.style.position="absolute",o.style.left="0px",o.style.top="0px",o.style.width=e.operationalRect.x*100+"%",o.style.height="100%",o.style["backdrop-filter"]=`blur(${e.blur||2}px)`,o.style.backgroundColor=e.blurBackground,t.appendChild(o);let n=()=>{updatePointerEvents(e)};i.onmouseenter=n,r.onmouseenter=n,s.onmouseenter=n,o.onmouseenter=n,t.onmouseleave=n}function updatePointerEvents(e){if(!(!e.calculative.canvas.store.data.locked&&!e.locked)&&e.calculative.zIndex<5){let t=e.calculative.singleton.div.parentNode.children;for(let i=1;i<6;i++)t[i].style.pointerEvents="initial"}}function renderPenRaw(e){if(e.thumbImg&&!e.calculative.img){const t=new Image;t.crossOrigin=e.crossOrigin==="undefined"?void 0:e.crossOrigin||"anonymous",e.calculative.canvas.store.options.cdn&&!(e.thumbImg.startsWith("http")||e.thumbImg.startsWith("//")||e.thumbImg.startsWith("data:image"))?t.src=e.calculative.canvas.store.options.cdn+e.thumbImg:t.src=e.thumbImg,t.onerror=i=>{t.remove(),e.calculative.img=void 0},e.calculative.img=t}}const videos={},mutedIcons=['<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M473.088 125.44L256 256H52.224C23.552 256 0 279.552 0 308.224V716.8c0 28.16 23.04 51.2 51.2 51.2h204.8l217.088 130.56c16.896 10.24 38.912-2.048 38.912-22.016V147.456c0-19.968-21.504-32.256-38.912-22.016zM699.904 320.512c-20.992-18.944-53.248-17.408-72.192 3.584-18.944 20.992-17.408 53.248 3.584 72.192 0.512 0.512 58.368 54.784 58.368 121.344 0 37.888-19.456 74.752-58.368 110.08-20.992 18.944-22.528 51.2-3.584 72.192 10.24 11.264 24.064 16.896 37.888 16.896 12.288 0 24.576-4.608 34.304-13.312 61.44-55.296 92.16-117.76 92.16-185.856 0-112.64-88.576-193.536-92.16-197.12z" fill="" p-id="2434"></path><path d="M853.504 166.4c-20.992-18.944-53.248-16.896-72.192 4.096-18.944 20.992-16.896 53.248 4.096 72.192 1.536 1.024 135.68 122.88 135.68 280.576 0 90.624-45.568 177.152-135.68 257.536-20.992 18.944-23.04 51.2-4.096 72.192 10.24 11.264 24.064 16.896 38.4 16.896 12.288 0 24.576-4.096 34.304-12.8 112.64-100.864 169.984-212.992 169.984-333.824-1.024-202.752-163.84-350.208-170.496-356.864z"></path></svg>','<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" ><path d="M256 768H51.2c-28.16 0-51.2-23.04-51.2-51.2V308.224C0 279.552 23.552 256 52.224 256H256v512zM512 147.456v728.576c0 19.968-21.504 32.256-38.912 22.016L256 768V256l217.088-130.56c17.408-10.24 38.912 2.048 38.912 22.016zM623.104 656.896c-19.968-19.968-19.968-52.224 0-72.192l217.088-217.088c19.968-19.968 52.224-19.968 72.192 0 19.968 19.968 19.968 52.224 0 72.192l-217.088 217.088c-19.456 19.968-52.224 19.968-72.192 0z" fill="" p-id="2582"></path><path d="M623.104 367.104c19.968-19.968 52.224-19.968 72.192 0l217.088 217.088c19.968 19.968 19.968 52.224 0 72.192-19.968 19.968-52.224 19.968-72.192 0l-217.088-217.088c-19.968-19.456-19.968-52.224 0-72.192z"></path></svg>'];function video(e){var t;if(e.onDestroy||(e.onDestroy=destory$2,e.onMove=move$2,e.onResize=move$2,e.onRotate=move$2,e.onClick=click,e.onValue=value$2,e.onChangeId=changeId$1),videos[e.id])e.video&&e.calculative.media&&e.video!==e.calculative.video?(console.warn("video , "),e.calculative.media.src=e.video,e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop,e.calculative.video=e.video):e.audio&&e.calculative.media&&e.audio!==e.calculative.audio&&(e.calculative.media.src=e.audio,e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop,e.calculative.audio=e.audio);else{const i=document.createElement("div"),s=document.createElement("div");s.style.position="absolute",s.style.outline="none",s.style.left="0",s.style.bottom="0",s.style.width="0",s.style.height="2px",s.style.background="#52c41a",s.style.zIndex="1",e.hideProgress&&(s.style.display="none");const r=document.createElement("div");r.innerHTML=mutedIcons[1],r.style.position="absolute",r.style.right="0",r.style.bottom="0",r.style.width="20px",r.style.height="20px",r.style.fill="hsla(0, 0%, 100%, .8)",r.style.zIndex="1",r.style.display="none",i.appendChild(s),i.appendChild(r),r.onclick=n=>{n.stopPropagation(),e.calculative.media.muted?(r.innerHTML=mutedIcons[0],e.calculative.media.muted=!1):(r.innerHTML=mutedIcons[1],e.calculative.media.muted=!0)},e.calculative.singleton||(e.calculative.singleton={}),e.calculative.singleton.muted=r,i.onmouseenter=n=>{r.style.display="block"},i.onmouseleave=n=>{r.style.display="none"},i.onclick=n=>{n.stopPropagation(),click(e)};let o;e.audio?(o=document.createElement("audio"),o.controls=e.controls,o.src=e.audio):(o=document.createElement("video"),o.src=e.video),o.loop=e.playLoop,o.ontimeupdate=()=>{resizeProcessWidth(s,o,e.calculative.worldRect.width)},o.onended=()=>{e.calculative.onended&&e.calculative.onended(e)},e.calculative.media=o,o.style.position="absolute",o.style.outline="none",o.style.left="0",o.style.top="0",o.style.width="100%",o.style.height="100%",i.appendChild(o),videos[e.id]=i,(t=e.calculative.canvas.externalElements)==null||t.parentElement.appendChild(i),setElemPosition(e,i),e.autoPlay&&(o.autoplay=!0,o.muted=!0)}return e.calculative.patchFlags&&setElemPosition(e,videos[e.id]),new Path2D}function destory$2(e){videos[e.id].onclick=null,videos[e.id].remove(),videos[e.id]=void 0}function move$2(e){setElemPosition(e,videos[e.id]);const t=videos[e.id].children[0],i=videos[e.id].children[1];resizeProcessWidth(t,i,e.calculative.worldRect.width)}function click(e){e.calculative.media&&(e.calculative.media.muted=!1,e.calculative.singleton.muted.innerHTML=mutedIcons[0],e.calculative.media.paused?e.calculative.media.play():e.calculative.media.pause())}function resizeProcessWidth(e,t,i){e.style.width=t.currentTime/t.duration*i+"px"}function changeId$1(e,t,i){videos[t]&&(videos[i]=videos[t],delete videos[t])}function value$2(e){const t=videos[e.id];if(!t)return;setElemPosition(e,t);const i=e.calculative.media.getAttribute("src");e.video?i!==e.video&&(e.calculative.media.src=e.video):e.audio&&i!==e.audio&&(e.calculative.media.src=e.audio),e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop}function createOffscreen(){try{const e=new OffscreenCanvas(0,0),t=e.getContext("2d");return t&&t.arc?e:document.createElement("canvas")}catch{return document.createElement("canvas")}}class Tooltip{constructor(t,i){D(this,"parentElement");D(this,"store");D(this,"box");D(this,"text");D(this,"arrowUp");D(this,"arrowDown");D(this,"x");D(this,"y");D(this,"currentPen");this.parentElement=t,this.store=i,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.box.className="meta2d-tooltip",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),t.appendChild(this.box),this.box.onmouseleave=()=>{this.hide(),this.store.lastHover=void 0};let s;for(let r=0;r<document.styleSheets.length;r++)document.styleSheets[r].title==="le5le.com/tooltip"&&(s=document.styleSheets[r]);if(!s){let r=document.createElement("style");r.type="text/css",r.title="le5le.com/tooltip",document.head.appendChild(r),r=document.createElement("style"),r.type="text/css",document.head.appendChild(r),s=r.sheet,s.insertRule(".meta2d-tooltip{position:absolute;padding:8px 0;z-index:10;left: -9999px;top: -9999px;}"),s.insertRule(".meta2d-tooltip .text{max-width:320px;min-height:30px;max-height:400px;outline:none;padding:8px 16px;border-radius:4px;background:#777777;color:#ffffff;line-height:1.8;overflow-y:auto;}"),s.insertRule(".meta2d-tooltip .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-5px;left:50%;transform:translateX(-50%)}"),s.insertRule(".meta2d-tooltip .arrow.down{top:initial;bottom: -1px;}")}}static getTitle(t){if(t.titleFnJs&&!t.titleFn)try{t.titleFn=new Function("pen",t.titleFnJs)}catch(i){console.log("titleFnJs",i)}return t.titleFn?t.titleFn(t):String(t.title)}setText(t){const i=this.box.getBoundingClientRect();let s=globalThis.marked;const r=Tooltip.getTitle(t);if(s){this.text.innerHTML=s(r);const o=this.text.getElementsByTagName("A");for(let n=0;n<o.length;++n)o[n].setAttribute("target","_blank")}else this.text.innerHTML=r;return i}updateText(t){var r;if(((r=this.currentPen)==null?void 0:r.id)!==t.id||Tooltip.titleEmpty(t))return;const i=this.setText(t),s=this.box.getBoundingClientRect();this.changePositionByText(i,s)}changePositionByText(t,i){this.x-=(i.width-t.width)/2,this.y-=i.height-t.height,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}static titleEmpty(t){return!t.title&&!t.titleFn&&!t.titleFnJs}show(t,i){if(this.currentPen=t,Tooltip.titleEmpty(t)){let c=getParent(t,!0);c&&this.show(c,i);return}this.setText(t);const s=this.box.getBoundingClientRect(),r=t.calculative.worldRect;let o=t.calculative.canvas.store.data.x+i.x-s.width/2,n=t.calculative.canvas.store.data.y+i.y-s.height;t.type||(o=t.calculative.canvas.store.data.x+r.x-(s.width-r.width)/2,n=t.calculative.canvas.store.data.y+r.ey-s.height-r.height),n>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#777777"):(n+=s.height+r.height+5,this.arrowUp.style.borderBottomColor="#777777",this.arrowDown.style.borderTopColor="transparent"),this.x=o,this.y=n,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.currentPen=null,this.x=-9999,this.box.style.left="-9999px"}translate(t,i){this.x<-1e3||(this.x+=t,this.y+=i,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px")}destroy(){this.box.onmouseleave=null}}class Scroll{constructor(t){D(this,"parent");D(this,"h");D(this,"v");D(this,"isDownH");D(this,"isDownV");D(this,"x");D(this,"y");D(this,"hSize");D(this,"vSize");D(this,"scrollX");D(this,"scrollY");D(this,"lastScrollX");D(this,"lastScrollY");D(this,"rect");D(this,"isShow");D(this,"pageMode");D(this,"onMouseDownH",t=>{t.preventDefault(),t.stopPropagation(),this.isDownH=t.x,this.x=this.parent.store.data.x||0,this.lastScrollX=this.scrollX});D(this,"onMouseDownV",t=>{t.preventDefault(),t.stopPropagation(),this.isDownV=t.y,this.y=this.parent.store.data.y||0,this.lastScrollY=this.scrollY});D(this,"onMouseMove",t=>{if(this.isDownH){const i=t.x-this.isDownH;this.scrollX=this.lastScrollX+i,this.h.style.left=`${this.scrollX}px`,this.parent.store.data.x=this.x-i*this.rect.width/this.parent.parentElement.clientWidth}if(this.isDownV){const i=t.y-this.isDownV;if(this.pageMode&&this.canMouseMove(i))return;this.scrollY=this.lastScrollY+i,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y=this.y-i*this.rect.height/this.parent.parentElement.clientHeight}(this.isDownH||this.isDownV)&&(this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())});D(this,"onMouseUp",t=>{!this.isDownH&&!this.isDownV||(this.isDownH=void 0,this.isDownV=void 0,this.scrollX<20?(this.scrollX=20,this.h.style.left=`${this.scrollX}px`):this.scrollX>this.parent.parentElement.clientWidth-this.hSize-20&&(this.scrollX=this.parent.parentElement.clientWidth-this.hSize-20,this.h.style.left=`${this.scrollX}px`),this.scrollY<20?(this.scrollY=20,this.v.style.top=`${this.scrollY}px`):this.scrollY>this.parent.parentElement.clientHeight-this.vSize-20&&(this.scrollY=this.parent.parentElement.clientHeight-this.vSize-20,this.v.style.top=`${this.scrollY}px`),this.resize())});this.parent=t,this.h=document.createElement("div"),this.v=document.createElement("div"),this.parent.externalElements.appendChild(this.h),this.parent.externalElements.appendChild(this.v),this.h.className="meta2d-scroll h",this.h.onmousedown=this.onMouseDownH,this.v.className="meta2d-scroll v",this.v.onmousedown=this.onMouseDownV,document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp);let i;for(let s=0;s<document.styleSheets.length;s++)document.styleSheets[s].title==="le5le/scroll"&&(i=document.styleSheets[s]);if(!i){let s=document.createElement("style");s.type="text/css",s.title="le5le.com/scroll",document.head.appendChild(s),s=document.createElement("style"),s.type="text/css",document.head.appendChild(s),i=s.sheet,i.insertRule(".meta2d-scroll{position:absolute;width:8px;height:200px;background:#dddddd;border-radius:10px;z-index:20;cursor:default;}"),i.insertRule(".meta2d-scroll:hover{background:#cccccc;cursor:pointer}"),i.insertRule(".meta2d-scroll.v{right:0;top:calc(50% - 100px);}"),i.insertRule(".meta2d-scroll.h{bottom:2px;left:calc(50% - 100px);width:200px;height:8px;}")}this.init()}init(){this.isShow=!0,this.resize(),this.initPos()}canMouseMove(t){const i=this.parent.parent.getRect();return t<0&&i.y+this.parent.store.data.y>=0||t>0&&i.ey-this.parent.height+this.parent.store.data.y<=0}changeMode(){this.pageMode=!0,this.h.style.display="none",this.parent.parent.getRect().height<this.parent.height&&(this.v.style.display="none")}initPos(){this.scrollX=(this.parent.parentElement.clientWidth-this.hSize)/2,this.scrollY=(this.parent.parentElement.clientHeight-this.vSize)/2,this.h.style.left=`${this.scrollX}px`,this.v.style.top=`${this.scrollY}px`}resize(){this.rect=getRect$1(this.parent.store.data.pens),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.parent.store.data.x>0?this.rect.width+=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x):this.rect.width-=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x),this.parent.store.data.y>0?this.rect.height+=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y):this.rect.height-=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.hSize=1e3*this.parent.parentElement.clientWidth/this.rect.width/3,this.vSize=1e3*this.parent.parentElement.clientHeight/this.rect.height/3,this.h.style.width=this.hSize+"px",this.v.style.height=this.vSize+"px"}show(){this.isShow=!0,this.h.style.display="block",this.v.style.display="block",document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}hide(){this.isShow=!1,this.h.style.display="none",this.v.style.display="none",this.destroy()}translate(t,i){t&&(this.scrollX-=t*this.parent.parentElement.clientWidth/this.rect.width,this.h.style.left=`${this.scrollX}px`),i&&(this.scrollY-=i*this.parent.parentElement.clientHeight/this.rect.height,this.v.style.top=`${this.scrollY}px`)}wheel(t){let i=10;t&&(i=-10),!(this.pageMode&&this.canMouseMove(i))&&(this.scrollY+=i,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y-=i*this.rect.height/this.parent.parentElement.clientHeight,this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())}destroy(){document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}}class CanvasImage{constructor(t,i,s){D(this,"parentElement");D(this,"store");D(this,"isBottom");D(this,"canvas",document.createElement("canvas"));D(this,"otherOffsreen",createOffscreen());D(this,"offscreen",createOffscreen());D(this,"animateOffsScreen",createOffscreen());D(this,"fitOffscreen",createOffscreen());D(this,"fitFlag",!1);D(this,"currentFit");D(this,"activeFit");this.parentElement=t,this.store=i,this.isBottom=s,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(t,i){this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.otherOffsreen.width=t,this.otherOffsreen.height=i,this.offscreen.width=t,this.offscreen.height=i,this.animateOffsScreen.width=t,this.animateOffsScreen.height=i,this.fitOffscreen.width=t,this.fitOffscreen.height=i,this.otherOffsreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.otherOffsreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.animateOffsScreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.animateOffsScreen.getContext("2d").textBaseline="middle",this.fitOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.fitOffscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.store.data.pens)this.hasImage(t)&&(t.calculative.imageDrawed=!1);this.isBottom?this.store.patchFlagsBackground=!0:this.store.patchFlagsTop=!0}clear(){this.otherOffsreen.getContext("2d").clearRect(0,0,this.otherOffsreen.width,this.otherOffsreen.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}hasImage(t){return t.calculative.hasImage=t.calculative&&t.calculative.inView&&(this.isBottom&&t.canvasLayer===CanvasLayer.CanvasImageBottom||!this.isBottom&&t.canvasLayer===CanvasLayer.CanvasImage)&&t.image&&t.calculative.img&&t.name!=="gif",t.calculative.hasImage}render(){var n;let t=!1,i=!1;for(const c of this.store.data.pens)this.hasImage(c)&&(this.store.animates.has(c)?i=!0:c.calculative.imageDrawed||(t=!0),c.parentId&&this.store.animates.has(getParent(c,!0))&&(i=!0));const s=this.store.patchFlagsBackground,r=this.store.patchFlagsTop;if(r&&!this.isBottom){const c=this.otherOffsreen.getContext("2d");c.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderRule(c)}if(this.store.patchFlagsLast&&this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),t){const c=this.offscreen.getContext("2d");c.save(),c.clearRect(0,0,this.canvas.width,this.canvas.height),c.translate(this.store.data.x,this.store.data.y);for(const a of this.store.data.pens)!a.calculative.hasImage||this.store.animates.has(a)||this.store.animates.has(getParent(a,!0))||a.canvasLayer!==CanvasLayer.CanvasTemplate&&(a.name==="combine"&&!a.draw||(a.calculative.imageDrawed=!0,c.save(),ctxFlip(c,a),a.calculative.rotate&&ctxRotate(c,a),setGlobalAlpha(c,a),drawImage(c,a),c.restore()));c.restore()}if(i){const c=this.animateOffsScreen.getContext("2d");c.save(),c.clearRect(0,0,this.canvas.width,this.canvas.height),c.translate(this.store.data.x,this.store.data.y);for(const a of this.store.animates)a.calculative.hasImage&&a.canvasLayer!==CanvasLayer.CanvasTemplate&&(a.visible===!1||a.calculative.visible===!1||(a.calculative.imageDrawed=!0,c.save(),ctxFlip(c,a),a.calculative.rotate&&ctxRotate(c,a),setGlobalAlpha(c,a),drawImage(c,a),c.restore()));for(const a of this.store.data.pens)!a.calculative.hasImage||!a.parentId||a.canvasLayer!==CanvasLayer.CanvasTemplate&&(a.visible===!1||a.calculative.visible===!1||this.store.animates.has(getParent(a,!0))&&(a.calculative.imageDrawed=!0,c.save(),ctxFlip(c,a),a.calculative.rotate&&ctxRotate(c,a),setGlobalAlpha(c,a),drawImage(c,a),c.restore()));c.restore()}if(!this.isBottom&&!this.store.data.locked&&this.fitFlag){const c=(this.store.data.width||this.store.options.width)*this.store.data.scale,a=(this.store.data.height||this.store.options.height)*this.store.data.scale,h=this.store.data.origin.x+this.store.data.x||this.store.options.x||0,l=this.store.data.origin.y+this.store.data.y||this.store.options.y||0,u=this.fitOffscreen.getContext("2d");u.save(),u.clearRect(0,0,this.canvas.width,this.canvas.height),u.fillStyle="#ffffff66",u.strokeStyle=this.store.styles.activeColor,(n=this.store.data.fits)==null||n.forEach((d,f)=>{u.fillRect(h+c*d.x,l+a*d.y,c*d.width,a*d.height),d.active&&u.strokeRect(h+c*d.x,l+a*d.y,c*d.width,a*d.height)}),u.restore()}if(t||i||s&&this.isBottom||r&&!this.isBottom){const c=this.canvas.getContext("2d");c.clearRect(0,0,this.canvas.width,this.canvas.height),this.isBottom&&(this.store.patchFlagsBackground=!1),c.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),c.drawImage(this.animateOffsScreen,0,0,this.canvas.width,this.canvas.height),this.isBottom||(c.drawImage(this.otherOffsreen,0,0,this.canvas.width,this.canvas.height),this.store.patchFlagsTop=!1,!this.store.data.locked&&this.fitFlag&&c.drawImage(this.fitOffscreen,0,0,this.canvas.width,this.canvas.height))}}renderRule(t){var m,T,I,P,E,_,W,Y;const{data:i,options:s}=this.store,{rule:r,ruleColor:o,scale:n,origin:c}=i;if(!(r??s.rule))return;const a=n*10;t.save();const h=o||s.ruleColor||"#ccc";t.strokeStyle=rgba(h,.7);const l=c.x+i.x,u=c.y+i.y,{width:d,height:f}=this.canvas;let g=((m=s.ruleOptions)==null?void 0:m.height)||20;(T=s.ruleOptions)!=null&&T.background&&(t.beginPath(),t.fillStyle=(I=s.ruleOptions)==null?void 0:I.background,t.rect(0,0,d,g),t.fill(),t.rect(0,0,g,f),t.fill()),(P=s.ruleOptions)!=null&&P.underline&&(t.beginPath(),t.fillStyle=rgba(h,.7),t.moveTo(0,g),t.lineTo(d,g),t.stroke(),t.moveTo(g,0),t.lineTo(g,f),t.stroke());let y=g/4;((E=s.ruleOptions)==null?void 0:E.baseline)==="bottom"&&(y=g*3/4),t.beginPath(),t.lineWidth=g/2,t.lineDashOffset=-l%a,t.setLineDash([1,a-1]),t.moveTo(0,y),t.lineTo(d,y),t.stroke(),t.beginPath(),t.lineDashOffset=-u%a,t.moveTo(y,0),t.lineTo(y,f),t.stroke(),t.strokeStyle=h,t.beginPath(),t.lineWidth=g,t.lineDashOffset=-l%(a*10),t.setLineDash([1,a*10-1]),t.moveTo(0,g/2),t.lineTo(d,g/2),t.stroke(),t.beginPath(),t.lineDashOffset=-u%(a*10),t.moveTo(g/2,0),t.lineTo(g/2,f),t.stroke(),t.beginPath(),t.fillStyle=((_=s.ruleOptions)==null?void 0:_.textColor)||t.strokeStyle;let v=0-Math.floor(l/a/10)*100,b=((W=s.ruleOptions)==null?void 0:W.textTop)||16,x=((Y=s.ruleOptions)==null?void 0:Y.textLeft)||4;l<0&&(v-=100);for(let C=l%(a*10);C<d;C+=10*a,v+=100)a<3&&v%500||t.fillText(v.toString(),C+x,b);v=0-Math.floor(u/a/10)*100,u<0&&(v-=100);for(let C=u%(a*10);C<f;C+=10*a,v+=100)a<3&&v%500||(t.save(),t.beginPath(),t.translate(b,C-x),t.rotate(270*Math.PI/180),t.fillText(v.toString(),0,0),t.restore());t.restore()}}class MagnifierCanvas{constructor(t,i,s){D(this,"parentCanvas");D(this,"parentElement");D(this,"store");D(this,"canvas",document.createElement("canvas"));D(this,"magnifierScreen",createOffscreen());D(this,"offscreen",createOffscreen());D(this,"domOffscreen",createOffscreen());D(this,"magnifierSize",300);D(this,"magnifier");this.parentCanvas=t,this.parentElement=i,this.store=s,i.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none"}resize(t,i){this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.offscreen.width=t,this.offscreen.height=i,this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.domOffscreen.width=t,this.domOffscreen.height=i,this.domOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.domOffscreen.getContext("2d").textBaseline="middle",this.magnifierScreen.width=this.magnifierSize+5,this.magnifierScreen.height=this.magnifierSize+5}renderMagnifier(){if(!this.magnifier)return;const t=this.magnifierSize/2,i=this.magnifierSize+5,s=this.magnifierScreen.getContext("2d");s.clearRect(0,0,i,i),s.lineWidth=5,s.save(),s.translate(2.5,2.5),s.save(),s.arc(t,t,t,0,Math.PI*2,!1),s.clip(),s.translate(-t,-t),s.scale(2,2);const r={x:(this.parentCanvas.mousePos.x+this.store.data.x)*this.store.dpiRatio,y:(this.parentCanvas.mousePos.y+this.store.data.y)*this.store.dpiRatio};[this.parentCanvas.canvasTemplate.bgOffscreen,this.parentCanvas.canvasTemplate.offscreen,this.parentCanvas.canvasImageBottom.offscreen,this.parentCanvas.canvasImageBottom.animateOffsScreen,this.parentCanvas.offscreen,this.parentCanvas.canvasImage.offscreen,this.parentCanvas.canvasImage.animateOffsScreen,this.domOffscreen].forEach(a=>{s.drawImage(a,r.x-t,r.y-t,this.magnifierSize,this.magnifierSize,0,0,this.magnifierSize,this.magnifierSize)}),s.restore(),s.beginPath();const n=s.createRadialGradient(t,t,t-5,t,t,t);n.addColorStop(0,"rgba(0,0,0,0.2)"),n.addColorStop(.8,"rgb(200,200,200)"),n.addColorStop(.9,"rgb(200,200,200)"),n.addColorStop(1,"rgba(200,200,200,0.9)"),s.strokeStyle=n,s.arc(t,t,t,0,Math.PI*2,!1),s.stroke(),s.restore(),this.offscreen.getContext("2d").drawImage(this.magnifierScreen,0,0,this.magnifierSize+5,this.magnifierSize+5,(r.x-t-2.5)/this.store.dpiRatio,(r.y-t-2.5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio)}updateDomOffscreen(){const t=this.domOffscreen.getContext("2d");t.clearRect(0,0,this.domOffscreen.width,this.domOffscreen.height);for(const i of this.store.data.pens)if((i.externElement||i.name==="gif")&&i.calculative.img){t.save(),t.translate(this.store.data.x,this.store.data.y);const{x:s,y:r,width:o,height:n}=i.calculative.worldRect;t.drawImage(i.calculative.img,s,r,o,n),t.restore()}}render(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.renderMagnifier();const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height)}}function lockedError(e){if(e.data.locked)throw new Error("canvas is locked")}class Dialog{constructor(t,i){D(this,"parentElement");D(this,"box");D(this,"iframe");D(this,"dialog");D(this,"close");D(this,"title");D(this,"body");D(this,"x");D(this,"y");D(this,"url");D(this,"meta2dDiv");D(this,"dialogMeta2d");D(this,"store");this.parentElement=t,this.store=i,this.box=document.createElement("div"),this.dialog=document.createElement("div");let s=document.createElement("div");this.title=document.createElement("div"),this.close=document.createElement("span"),this.close.innerHTML=`
      <svg fill="none" viewBox="0 0 16 16" width="1em" height="1em">
      <path
        fill="currentColor"
        d="M8 8.92L11.08 12l.92-.92L8.92 8 12 4.92 11.08 4 8 7.08 4.92 4 4 4.92 7.08 8 4 11.08l.92.92L8 8.92z"
        fill-opacity="0.9"
      ></path>
    </svg>`,this.body=document.createElement("div"),this.iframe=document.createElement("iframe"),this.iframe.setAttribute("frameborder","0"),this.meta2dDiv=document.createElement("div"),this.box.className="meta2d-dialog_mask",this.dialog.className="meta2d-dialog",this.body.className="meta2d-dialog_body",s.className="meta2d-dialog_header",this.title.className="meta2d-dialog-content",this.close.className="meta2d-dialog-close",this.meta2dDiv.className="meta2d-dialog-meta2d",s.appendChild(this.title),s.appendChild(this.close),this.body.appendChild(this.iframe),this.body.appendChild(this.meta2dDiv),this.dialog.appendChild(s),this.dialog.appendChild(this.body),this.box.appendChild(this.dialog),t.appendChild(this.box),this.dialog.onclick=o=>{o.stopPropagation()},this.box.onclick=()=>{this.hide()},this.close.onclick=()=>{this.hide()};let r;for(let o=0;o<document.styleSheets.length;o++)document.styleSheets[o].title==="le5le.com/dialog"&&(r=document.styleSheets[o]);if(!r){let o=document.createElement("style");o.type="text/css",o.title="le5le.com/dialog",document.head.appendChild(o),o=document.createElement("style"),o.type="text/css",document.head.appendChild(o),r=o.sheet,r.insertRule(`.meta2d-dialog_mask {
        display: none;
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: #0000006f;
        z-index: 9999;`),r.insertRule(`.meta2d-dialog_mask .meta2d-dialog {
            position: absolute;
            top: 15vh;
            left: 10%;
            width: 80%;
            height:420px;
            padding: 16px 20px;
            border-radius: 9px;
            background-color: #1e2430;
            z-index: 19999;
            overflow: auto;
        }`),r.insertRule(`.meta2d-dialog_header {
            display: flex;
            position: relative;
            z-index: 999;
        }`),r.insertRule(`.meta2d-dialog-content {
            width: calc(100% - 20px);
            font-weight: 600;
            font-size: 14px;
            color: #bdc7db;
            padding-bottom:8px;
        }`),r.insertRule(`.meta2d-dialog-close {
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            color: #617b91;
            position: absolute;
            right:20px;
            top:2px;
        }`),r.insertRule(`.meta2d-dialog-close svg{
            width: 18px;
            height: 18px;
        }`),r.insertRule(`.meta2d-dialog-close :hover{
            cursor: pointer;
        }`),r.insertRule(`.meta2d-dialog_body{
          width: 100%;
          height: 100%;
        } `),r.insertRule(`.meta2d-dialog_body iframe{
            width: 100%;
            height: 100%;
        }`),r.insertRule(`.meta2d-dialog_body .meta2d-dialog-meta2d{
          width: 100%;
          height: 100%;
          display: none;
      }`)}}async show(t,i,s,r){if(!i)return;const o=this.isUrl(i);if(o?(this.meta2dDiv.style.display="none",this.iframe.style.display="block"):(this.iframe.style.display="none",this.meta2dDiv.style.display="block"),o&&i!==this.url&&(this.iframe.setAttribute("src",i),this.url=i),t&&(this.title.innerText=t),t?(this.dialog.style.padding="16px 20px",this.title.style.display="block",this.body.style.height="calc(100% - 26px)",this.close.style.top="2px",this.close.style.right="2px",this.body.style.background="#1e2430"):(this.dialog.style.padding="0px",this.title.style.display="none",this.body.style.height="100%",this.body.style.overflow="hidden",this.close.style.top="18px",this.close.style.right="20px",this.body.style.background="transparent"),s&&(this.dialog.style.width=s.width?s.width+"px":"80%",this.dialog.style.height=s.height?s.height+"px":"420px",this.dialog.style.top=s.y?s.y+"px":s.height?`calc( 50% - ${s.height/2}px )`:"15vh",this.dialog.style.left=s.x?s.x+"px":`calc( 50% - ${s.width?s.width/2+"px":"40%"} )`),o&&r){let n=0;const c=setInterval(()=>{this.iframe.contentWindow.meta2d&&(clearInterval(c),setTimeout(()=>{this.iframe.contentWindow.postMessage(JSON.stringify({name:"dialog",data:r}),"*")},100)),n++,n>50&&clearInterval(c)},300)}if((!this.dialogMeta2d||o)&&(this.box.style.display="block"),!o){this.meta2dDiv.style.display="block",this.dialogMeta2d||(globalThis.mainMeta2d=globalThis.meta2d,this.dialogMeta2d=new Meta2d(this.meta2dDiv),globalThis.meta2d=globalThis.mainMeta2d);const n=await getMeta2dData(this.store,i);n&&(this.box.style.display="block",this.dialogMeta2d.clear(!0),this.dialogMeta2d.open(n,!1),this.dialogMeta2d.lock(1),this.dialogMeta2d.resize(),this.dialogMeta2d.fitView(!0,0),this.dialogMeta2d.render(!0))}}hide(){this.box.style.display="none"}isUrl(t){return!!(t.startsWith("http")||t.includes("?")||t.includes("/"))}destroy(){var t;this.dialog.onclick=void 0,this.box.onclick=void 0,this.close.onclick=void 0,(t=this.dialogMeta2d)==null||t.destroy(!0)}}class Title{constructor(t){D(this,"parentElement");D(this,"box");D(this,"currentAnchor");this.parentElement=t,this.box=document.createElement("div"),this.box.className="meta2d-title",t.appendChild(this.box);let i;for(let s=0;s<document.styleSheets.length;s++)document.styleSheets[s].title==="le5le.com/title"&&(i=document.styleSheets[s]);if(!i){let s=document.createElement("style");s.type="text/css",s.title="le5le.com/title",document.head.appendChild(s),s=document.createElement("style"),s.type="text/css",document.head.appendChild(s),i=s.sheet,i.insertRule(".meta2d-title{position:absolute;padding:0;z-index:10;left: -9999px;top: -9999px;background:#fff;color:#000; cursor: crosshair;border: 1px solid black;}")}}static getTitle(t){}setText(t){this.box.innerText=t.title}updateText(t){var i;((i=this.currentAnchor)==null?void 0:i.id)===t.id&&(Title.titleEmpty(t)||(this.setText(t),this.changePositionByAnchor(t)))}changePositionByAnchor(t){this.box.style.left=t.x+10+"px",this.box.style.top=t.y+10+"px"}static titleEmpty(t){return!t.title}show(t,i){if(Title.titleEmpty(t))return;this.currentAnchor=t,this.setText(t);let s={x:i.calculative.canvas.store.data.x+t.x,y:i.calculative.canvas.store.data.y+t.y};this.changePositionByAnchor(s)}hide(){this.box.style.left="-9999px",this.box.innerText="",this.currentAnchor=null}destroy(){this.box.onmouseleave=null}}class CanvasTemplate{constructor(t,i){D(this,"parentElement");D(this,"store");D(this,"canvas",document.createElement("canvas"));D(this,"offscreen",createOffscreen());D(this,"bgOffscreen",createOffscreen());D(this,"patchFlags");D(this,"bgPatchFlags");D(this,"fit");this.parentElement=t,this.store=i,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(t,i){this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.bgOffscreen.width=t,this.bgOffscreen.height=i,this.offscreen.width=t,this.offscreen.height=i,this.bgOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.bgOffscreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.patchFlags=!0,this.bgPatchFlags=!0}hidden(){this.canvas.style.display="none"}show(){this.canvas.style.display="block"}clear(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.bgPatchFlags=!0,this.patchFlags=!0}render(){if(this.bgPatchFlags){const t=this.bgOffscreen.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.store.data.width||this.store.options.width,s=this.store.data.height||this.store.options.height,r=this.store.data.x||this.store.options.x||0,o=this.store.data.y||this.store.options.y||0,n=this.store.data.background||this.store.styles.background;n&&(t.save(),t.fillStyle=n,t.globalAlpha=this.store.data.globalAlpha??this.store.options.globalAlpha,i&&s&&!this.fit?(t.shadowOffsetX=this.store.options.shadowOffsetX,t.shadowOffsetY=this.store.options.shadowOffsetY,t.shadowBlur=this.store.options.shadowBlur,t.shadowColor=this.store.options.shadowColor,t.fillRect(this.store.data.origin.x+r,this.store.data.origin.y+o,i*this.store.data.scale,s*this.store.data.scale)):t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore()),i&&s&&this.store.bkImg&&(t.save(),this.fit?t.drawImage(this.store.bkImg,0,0,this.canvas.offsetWidth,this.canvas.offsetHeight):t.drawImage(this.store.bkImg,this.store.data.origin.x+r,this.store.data.origin.y+o,i*this.store.data.scale,s*this.store.data.scale),t.restore()),this.renderGrid(t)}if(this.patchFlags){const t=this.offscreen.getContext("2d");t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.translate(this.store.data.x,this.store.data.y);for(const i of this.store.data.pens)if(isFinite(i.x)&&i.canvasLayer===CanvasLayer.CanvasTemplate&&i.calculative.inView){if(i.name==="combine"&&!i.draw)continue;renderPen(t,i),i.image&&i.name!=="gif"&&i.calculative.img&&(t.save(),ctxFlip(t,i),i.calculative.rotate&&ctxRotate(t,i),setGlobalAlpha(t,i),drawImage(t,i),t.restore())}t.restore()}if(this.patchFlags||this.bgPatchFlags){const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.bgOffscreen,0,0,this.canvas.width,this.canvas.height),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),this.patchFlags=!1,this.bgPatchFlags=!1}}renderGrid(t){const{data:i,options:s}=this.store,{grid:r,gridRotate:o,gridColor:n,gridSize:c,scale:a,origin:h}=i;if(!(r??s.grid))return;t.save();const l=(i.width||s.width)*a,u=(i.height||s.height)*a,d=(i.x||s.x||0)+h.x,f=(i.y||s.y||0)+h.y;o&&(t.translate(l/2,u/2),t.rotate(o*Math.PI/180),t.translate(-l/2,-u/2)),t.lineWidth=1,t.strokeStyle=n||s.gridColor,t.beginPath();let g=(c||s.gridSize)*a;if(g=g<0?0:g,!l||!u){const y=this.store.dpiRatio,v=this.canvas.width/y,b=this.canvas.height/y,x=d/g,m=f/g,T=g*10,I=d-Math.ceil(x)*g,P=f-Math.ceil(m)*g,E=v+I+T,_=b+P+T;for(let W=I;W<=E;W+=g)t.moveTo(W,P),t.lineTo(W,b+P+T);for(let W=P;W<=_;W+=g)t.moveTo(I,W),t.lineTo(v+I+T,W)}else{const y=l+d,v=u+f;for(let b=d;b<=y;b+=g)t.moveTo(b,f),t.lineTo(b,u+f);for(let b=f;b<=v;b+=g)t.moveTo(d,b),t.lineTo(l+d,b)}t.stroke(),t.restore()}}const status$1={success:{},info:{icon:'<svg fill="none" viewBox="0 0 24 24"><path fill="#0052d9" d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{},error:{}};class Popconfirm{constructor(t,i){D(this,"parentElement");D(this,"store");D(this,"box");D(this,"text");D(this,"arrowUp");D(this,"arrowDown");D(this,"icon");D(this,"confirm");D(this,"cancel");D(this,"x");D(this,"y");this.parentElement=t,this.store=i,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.icon=document.createElement("div"),this.confirm=document.createElement("button"),this.cancel=document.createElement("button"),this.box.className="meta2d-popconfirm",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.icon.className="icon",this.confirm.className="confirm",this.cancel.className="cancel",this.confirm.innerHTML="",this.cancel.innerHTML="",this.icon.innerHTML=status$1.info.icon,this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),this.box.appendChild(this.confirm),this.box.appendChild(this.cancel),this.box.appendChild(this.icon),t.appendChild(this.box);let s;for(let r=0;r<document.styleSheets.length;r++)document.styleSheets[r].title==="le5le.com/popconfirm"&&(s=document.styleSheets[r]);if(!s){let r=document.createElement("style");r.type="text/css",r.title="le5le.com/popconfirm",document.head.appendChild(r),r=document.createElement("style"),r.type="text/css",document.head.appendChild(r),s=r.sheet,s.insertRule(".meta2d-popconfirm{position:absolute;z-index:999;left: -9999px;top: -9999px;padding:16px;max-width:400px;background:#fff;border-radius:6px;box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);}"),s.insertRule(".meta2d-popconfirm .text{outline:none;padding:0px 0px 40px 28px;border-radius:4px;color:rgba(0, 0, 0, 0.9);overflow-y:auto;line-height:22px;font-size:13px;}"),s.insertRule(".meta2d-popconfirm .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-18px;left:50%;transform:translateX(-50%)}"),s.insertRule(".meta2d-popconfirm .arrow.down{top:initial;bottom: -18px;}"),s.insertRule(".meta2d-popconfirm .icon{position:absolute;width:22px;height:22px;left:16px;top:16px;}"),s.insertRule(".meta2d-popconfirm .confirm{position:absolute;right:16px;bottom:16px;width:40px;height:24px;text-align:center;background:#4582e6;color:#fff;border-radius:3px;border-color:transparent}"),s.insertRule(".meta2d-popconfirm .confirm:hover{background:#003cab;}"),s.insertRule(".meta2d-popconfirm .cancel{position:absolute;right:64px;bottom:16px;width:40px;height:24px;text-align:center;background:#dcdcdc;color:rgba(0, 0, 0, 0.9);border-radius:3px;border-color:transparent}"),s.insertRule(".meta2d-popconfirm .cancel:hover{background:#a6a6a6;}")}}show(t,i){if(!t)return;const s=this.box.getBoundingClientRect(),r=t.calculative.worldRect;let o=t.calculative.canvas.store.data.x+i.x-s.width/2,n=t.calculative.canvas.store.data.y+i.y-s.height-20;t.type||(o=t.calculative.canvas.store.data.x+r.x-(s.width-r.width)/2,n=t.calculative.canvas.store.data.y+r.ey-s.height-r.height),n>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#fff",n-=10):(n+=s.height+r.height+5,n+=10,this.arrowUp.style.borderBottomColor="#fff",this.arrowDown.style.borderTopColor="transparent"),this.x=o,this.y=n,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.x=-9999,this.box.style.left="-9999px"}showModal(t,i,s){return new Promise(r=>{this.text.innerHTML=s||"",this.show(t,i),this.confirm.onclick=()=>{r(!0),this.hide()},this.cancel.onclick=()=>{r(!1),this.hide()}})}destroy(){this.box=null}}const movingSuffix="-moving";class Canvas{constructor(t,i,s){D(this,"parent");D(this,"parentElement");D(this,"store");D(this,"canvas",document.createElement("canvas"));D(this,"offscreen",createOffscreen());D(this,"width");D(this,"height");D(this,"externalElements",document.createElement("div"));D(this,"clientRect");D(this,"canvasRect");D(this,"activeRect");D(this,"initActiveRect");D(this,"dragRect");D(this,"lastRotate",0);D(this,"sizeCPs");D(this,"activeInitPos");D(this,"hoverType",HoverType.None);D(this,"resizeIndex",0);D(this,"mouseDown");D(this,"hotkeyType");D(this,"mouseRight");D(this,"addCaches");D(this,"touchCenter");D(this,"initTouchDis");D(this,"initScale");D(this,"touchScaling");D(this,"touchMoving");D(this,"startTouches");D(this,"lastOffsetX",0);D(this,"lastOffsetY",0);D(this,"drawingLineName");D(this,"drawLineFns",[...defaultDrawLineFns]);D(this,"drawingLine");D(this,"pencil");D(this,"pencilLine");D(this,"movingPens");D(this,"patchFlagsLines",new Set);D(this,"dock");D(this,"prevAnchor");D(this,"nextAnchor");D(this,"lastMouseTime",0);D(this,"hoverTimer",0);D(this,"fitTimer",0);D(this,"willInactivePen");D(this,"patchFlags",!1);D(this,"lastRender",0);D(this,"touchStart",0);D(this,"touchStartTimer");D(this,"timer");D(this,"lastAnimateRender",0);D(this,"animateRendering",!1);D(this,"renderTimer");D(this,"initPens");D(this,"pointSize",8);D(this,"pasteOffset",!0);D(this,"opening",!1);D(this,"maxZindex",5);D(this,"canMoveLine",!1);D(this,"randomIdObj");D(this,"keyOptions");D(this,"beforeAddPen");D(this,"beforeAddPens");D(this,"beforeAddAnchor");D(this,"beforeRemovePens");D(this,"beforeRemoveAnchor");D(this,"customResizeDock");D(this,"customMoveDock");D(this,"inputParent",document.createElement("div"));D(this,"inputDiv",document.createElement("div"));D(this,"dropdown",document.createElement("ul"));D(this,"tooltip");D(this,"popconfirm");D(this,"title");D(this,"mousePos",{x:0,y:0});D(this,"scroll");D(this,"movingAnchor");D(this,"canvasTemplate");D(this,"canvasImage");D(this,"canvasImageBottom");D(this,"magnifierCanvas");D(this,"dialog");D(this,"autoPolylineFlag",!1);D(this,"stopPropagation",t=>{t.stopPropagation()});D(this,"curve",curve);D(this,"polyline",polyline);D(this,"mind",mind);D(this,"line",lineSegment);D(this,"onCopy",t=>{this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements||this.copy()});D(this,"onCut",t=>{this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements||this.cut()});D(this,"onPaste",async t=>{if(this.store.data.locked||this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements)return;let i;if(navigator.clipboard&&t.clipboardData){const s=t.clipboardData.items;if(s){for(let r=0;r<s.length;r++)if(s[r].type.indexOf("image")!==-1&&s[r].getAsFile()){i=!0;break}}}if(i){const s=t.clipboardData.items;if(s){for(let r=0;r<s.length;r++)if(s[r].type.indexOf("image")!==-1&&s[r].getAsFile()){const{x:o,y:n}=this.mousePos,c=s[r].getAsFile();let a=s[r].type.slice(6)==="gif"?"gif":"image";if(c!==null){const h=a==="gif",l=await this.fileToPen(c,h);l.height=l.height/l.width*100,l.width=100,l.x=o-50/2,l.y=n-l.height/l.width*50,l.externElement=h,this.addPens([l]),this.active([l]),this.copy([l])}}}}else this.paste()});D(this,"onMessage",t=>{if(typeof t.data!="string"||!t.data||t.data.startsWith("setImmediate")||t.data.startsWith("webpackHotUpdate"))return;let i=JSON.parse(t.data);typeof i=="object"?this.parent.doMessageEvent(i.name,JSON.stringify(i.data)):this.parent.doMessageEvent(i)});D(this,"onwheel",t=>{if(this.inputDiv.contentEditable==="true"||this.drawingLine||this.pencil)return;if(this.store.hover&&this.store.hover.onWheel){this.store.hover.onWheel(this.store.hover,t);return}if(this.store.data.disableScale||this.store.options.disableScale||(t.preventDefault(),t.stopPropagation(),this.mouseDown&&(this.hoverType===HoverType.Node||this.hoverType===HoverType.Line))||this.store.data.locked===LockState.Disable||this.store.data.locked===LockState.DisableScale||this.store.data.locked===LockState.DisableMoveScale)return;if(!t.ctrlKey&&Math.abs(t.wheelDelta)<100&&t.deltaY.toString().indexOf(".")===-1){if(this.store.options.scroll&&!t.metaKey&&this.scroll){this.scroll.wheel(t.deltaY<0);return}const o=this.store.data.scale||1;this.translate(-t.deltaX/o,-t.deltaY/o);return}if(Math.abs(t.wheelDelta)>100&&this.store.options.scroll&&this.scroll&&!this.store.options.scrollButScale&&!(t.ctrlKey||t.metaKey)){this.scroll.wheel(t.deltaY<0);return}if(this.store.options.disableTouchPadScale)return;let i=.015;if(this.store.options.scaleOff)i=this.store.options.scaleOff,t.deltaY>0&&(i=-this.store.options.scaleOff);else if(/mac os /i.test(navigator.userAgent))t.ctrlKey?t.deltaY>0&&(i*=-1):i*=t.wheelDeltaY/240;else{let n=.2;t.deltaY.toString().indexOf(".")!==-1&&(n=.01),t.deltaY>0?i=-n:i=n}let{offsetX:s,offsetY:r}=t;this.scale(this.store.data.scale+i,{x:s,y:r}),this.externalElements.focus()});D(this,"onkeydown",t=>{var o,n,c;if(this.store.data.locked>=LockState.DisableEdit&&t.target.tagName!=="INPUT"&&t.target.tagName!=="TEXTAREA"&&!t.target.dataset.meta2dIgnore&&this.store.active.forEach(a=>{var h;(h=a.onKeyDown)==null||h.call(a,a,t.key)}),this.store.data.locked>=LockState.DisableEdit||t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"||t.target.dataset.meta2dIgnore||this.store.options.unavailableKeys.includes(t.key))return;this.keyOptions||(this.keyOptions={}),this.keyOptions.altKey=t.altKey,this.keyOptions.shiftKey=t.shiftKey,this.keyOptions.ctrlKey=t.ctrlKey,this.keyOptions.metaKey=t.metaKey,this.keyOptions.F=!1,(t.key==="F"||t.key==="f")&&(this.keyOptions.F=!0);let i=10,s=10,r=null;if(this.store.options.strictScope){const a=this.store.data.width||this.store.options.width,h=this.store.data.height||this.store.options.height;a&&h&&(r={x:this.store.data.origin.x,y:this.store.data.origin.y,width:a*this.store.data.scale,height:h*this.store.data.scale})}switch(t.key){case" ":this.hotkeyType=HotkeyType.Translate;break;case"Control":this.drawingLine?this.drawingLine.calculative.drawlineH=!this.drawingLine.calculative.drawlineH:this.hotkeyType||(this.patchFlags=!0,this.hotkeyType=HotkeyType.Select);break;case"Meta":break;case"Shift":this.store.active.length===1&&this.store.active[0].type&&this.store.activeAnchor?this.toggleAnchorHand():this.hotkeyType||(this.patchFlags=!0,this.store.options.resizeMode||(this.hotkeyType=HotkeyType.Resize));break;case"Alt":if(!t.ctrlKey&&!t.shiftKey&&this.drawingLine){const a=getToAnchor(this.drawingLine);a!==this.drawingLine.calculative.activeAnchor?(deleteTempAnchor(this.drawingLine),this.drawingLine.calculative.worldAnchors.push(a)):this.drawingLine.calculative.worldAnchors.push({x:a.x,y:a.y});const h=this.drawLineFns.indexOf(this.drawingLineName);this.drawingLineName=this.drawLineFns[(h+1)%this.drawLineFns.length],this.drawingLine.lineName=this.drawingLineName,this.drawline(),this.patchFlags=!0}t.preventDefault();break;case"a":case"A":t.ctrlKey||t.metaKey?(this.active(this.store.data.pens.filter(a=>!a.parentId&&a.locked!==LockState.Disable)),t.preventDefault()):this.toggleAnchorMode();break;case"Delete":case"Backspace":if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){this.deleteFit();break}!this.store.data.locked&&this.delete();break;case"ArrowLeft":if(this.movingAnchor){this.translateAnchor(-1,0);break}if(i=-1,t.shiftKey&&(i=-5),(t.ctrlKey||t.metaKey)&&(i=-10),i=i*this.store.data.scale,this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+i,y:this.store.activeAnchor.y},{});break}r&&this.activeRect.x+i<r.x&&(i=r.x-this.activeRect.x),this.translatePens(this.store.active,i,0);break;case"ArrowUp":if(this.movingAnchor){this.translateAnchor(0,-1);break}if(s=-1,t.shiftKey&&(s=-5),(t.ctrlKey||t.metaKey)&&(s=-10),s=s*this.store.data.scale,r&&this.activeRect.y+s<r.y&&(s=r.y-this.activeRect.y),this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+s},{});break}this.translatePens(this.store.active,0,s);break;case"ArrowRight":if(this.movingAnchor){this.translateAnchor(1,0);break}if(i=1,t.shiftKey&&(i=5),(t.ctrlKey||t.metaKey)&&(i=10),i=i*this.store.data.scale,this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+i,y:this.store.activeAnchor.y},{});break}r&&this.activeRect.x+this.activeRect.width+i>r.x+r.width&&(i=r.x+r.width-(this.activeRect.x+this.activeRect.width)),this.translatePens(this.store.active,i,0);break;case"ArrowDown":if(this.movingAnchor){this.translateAnchor(0,1);break}if(s=1,t.shiftKey&&(s=5),(t.ctrlKey||t.metaKey)&&(s=10),s=s*this.store.data.scale,r&&this.activeRect.y+this.activeRect.height+s>r.y+r.height&&(s=r.y+r.height-(this.activeRect.y+this.activeRect.height)),this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+s},{});break}this.translatePens(this.store.active,0,s);break;case"d":case"D":(o=this.store.active[0])!=null&&o.locked||this.removeAnchorHand();break;case"h":case"H":(n=this.store.active[0])!=null&&n.locked||this.addAnchorHand();break;case"m":case"M":this.toggleMagnifier();break;case"g":case"G":if(t.ctrlKey||t.metaKey){t.shiftKey?this.parent.uncombine():this.store.active.length>1&&this.parent.combine(this.store.active),t.preventDefault();break}this.hoverType===HoverType.NodeAnchor&&(this.movingAnchor=this.store.hoverAnchor,this.externalElements.style.cursor="move");break;case"s":case"S":!this.store.data.locked&&this.hoverType===HoverType.LineAnchor&&this.store.hover===this.store.active[0]&&this.splitLine(this.store.active[0],this.store.hoverAnchor),(t.ctrlKey||t.metaKey)&&this.store.emitter.emit("save",{event:t});break;case"c":case"C":(t.ctrlKey||t.metaKey)&&this.store.options.disableClipboard&&this.copy();break;case"x":case"X":(t.ctrlKey||t.metaKey)&&this.store.options.disableClipboard&&this.cut();break;case"":case"v":case"V":!t.ctrlKey&&!t.metaKey&&(this.pencil&&this.stopPencil(),this.drawingLineName?(this.finishDrawline(),this.drawingLineName=""):this.drawingLineName=this.store.options.drawingLineName),!this.store.data.locked&&(t.ctrlKey||t.metaKey)&&(this.store.options.disableClipboard||!this.store.options.disableClipboard&&t.altKey)&&this.paste();break;case"b":case"B":this.drawingLineName&&(this.finishDrawline(),this.drawingLineName=""),this.pencil?this.stopPencil():this.drawingPencil();break;case"y":case"Y":(t.ctrlKey||t.metaKey)&&this.redo();break;case"z":case"Z":t.ctrlKey||t.metaKey?this.undo():t.shiftKey&&this.redo();break;case"Enter":this.drawingLineName&&(this.finishDrawline(!0),this.store.active[0].anchors[0].connectTo?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName),this.store.active&&(this.store.active.forEach(a=>{a.type?(a.close=!a.close,a.close&&getLinePoints(a),this.store.path2dMap.set(a,globalStore.path2dDraws.line(a)),getLineLength(a)):a.calculative.focus=!0}),this.render());break;case"Escape":this.drawingLineName&&this.finishDrawline(),this.drawingLineName=void 0,this.stopPencil(),this.store.active&&this.store.active.forEach(a=>{a.type||(a.calculative.focus=!1)}),this.movingPens&&(this.getAllByPens(this.movingPens).forEach(a=>{this.store.pens[a.id]=void 0}),this.movingPens=void 0,this.mouseDown=void 0,this.clearDock(),(c=this.store.active)==null||c.forEach(a=>{this.updateLines(a)}),this.calcActiveRect(),this.patchFlags=!0),this.hotkeyType=HotkeyType.None,this.movingAnchor=void 0,this.magnifierCanvas.magnifier&&(this.magnifierCanvas.magnifier=!1,this.patchFlags=!0);break;case"E":case"e":this.store.options.disableAnchor=!this.store.options.disableAnchor,this.store.emitter.emit("disableAnchor",this.store.options.disableAnchor);break;case"=":(t.ctrlKey||t.metaKey)&&(this.scale(this.store.data.scale+.1),t.preventDefault(),t.stopPropagation());break;case"-":(t.ctrlKey||t.metaKey)&&(this.scale(this.store.data.scale-.1),t.preventDefault(),t.stopPropagation());break;case"l":case"L":this.canMoveLine=!0;break;case"[":this.parent.down();break;case"]":this.parent.up();break;case"{":this.parent.bottom();break;case"}":this.parent.top();break;case"F":case"f":!this.store.data.locked&&(t.ctrlKey||t.metaKey)&&!this.store.options.disableClipboard&&this.paste(),this.setFollowers();break}this.render(!1)});D(this,"onkeyup",t=>{switch(t.key){case"l":case"L":this.canMoveLine=!1;break}this.hotkeyType&&this.render(),this.hotkeyType<HotkeyType.AddAnchor&&(this.hotkeyType=HotkeyType.None)});D(this,"ondrop",async t=>{if(this.store.data.locked){console.warn("canvas is locked, can not drop");return}t.preventDefault(),t.stopPropagation();const i=t.dataTransfer.getData("Meta2d")||t.dataTransfer.getData("Text");let s=null;try{i&&(s=JSON.parse(i))}catch{}if(!s){const{files:r}=t.dataTransfer;if(r.length&&r[0].type.match("image.*")&&!(this.addCaches&&this.addCaches.length)){const o=r[0].type==="image/gif";s=await this.fileToPen(r[0],o)}else if(this.addCaches&&this.addCaches.length)s=this.addCaches,this.addCaches=[];else{this.store.emitter.emit("drop",void 0);return}}if(s=Array.isArray(s)?s:[s],s[0]&&s[0].draggable!==!1){const r={x:t.offsetX,y:t.offsetY};this.calibrateMouse(r),this.dropPens(s,r),this.addCaches=[],this.getContainerHover(r),this.mousePos.x=r.x,this.mousePos.y=r.y,this.store.emitter.emit("mouseup",{x:r.x,y:r.y,pen:this.store.hoverContainer})}this.store.emitter.emit("drop",s||i)});D(this,"ontouchstart",t=>{this.store.data.locked!==LockState.Disable&&(this.touchStartTimer&&clearTimeout(this.touchStartTimer),this.touchStartTimer=setTimeout(()=>{this.touchStart=performance.now();const i=t.touches[0].pageX-this.clientRect.x,s=t.touches[0].pageY-this.clientRect.y,r={x:i,y:s};if(this.calibrateMouse(r),this.getHover(r),this.onMouseDown({x:i,y:s,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY,pageX:t.touches[0].pageX,pageY:t.touches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1}),t.touches.length===2){this.initTouchDis=Math.hypot(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY),this.initScale=this.store.data.scale,this.startTouches=t.touches,this.touchCenter={x:t.touches[0].pageX+(t.touches[1].pageX-t.touches[0].pageX)/2-this.clientRect.x,y:t.touches[0].pageY+(t.touches[1].pageY-t.touches[0].pageY)/2-this.clientRect.y};return}else t.touches.length===3&&(this.store.emitter.emit("contextmenu",{e:{x:i,y:s,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY,pageX:t.touches[0].pageX,pageY:t.touches[0].pageY},clientRect:this.clientRect}),t.preventDefault(),t.stopPropagation());this.touchStartTimer=void 0},50))});D(this,"ontouchmove",t=>{var c;if(this.store.data.locked===LockState.Disable)return;t.stopPropagation(),t.preventDefault();const i=performance.now();if(i-this.touchStart<50)return;this.touchStart=i;const s=t.touches,r=s.length,o=t.touches[0].pageX-this.clientRect.x,n=t.touches[0].pageY-this.clientRect.y;if(r===1)this.onMouseMove({x:o,y:n,clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,pageX:t.changedTouches[0].pageX,pageY:t.changedTouches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1});else if(r===2&&((c=this.startTouches)==null?void 0:c.length)===2){if(!this.touchMoving&&!this.touchScaling){const a=this.startTouches[0].pageX-s[0].pageX,h=this.startTouches[1].pageX-s[1].pageX,l=this.startTouches[0].pageY-s[0].pageY,u=this.startTouches[1].pageY-s[1].pageY;(a>=0&&h<0||a<=0&&h>0)&&(l>=0&&u<0||l<=0&&u>0)?this.touchScaling=!0:this.touchMoving=!0}if(this.touchScaling){if(this.store.data.disableScale||this.store.options.disableScale)return;const a=Math.hypot(s[0].pageX-s[1].pageX,s[0].pageY-s[1].pageY)/this.initTouchDis;this.scale(this.initScale*a,deepClone(this.touchCenter))}if(this.touchMoving){if(this.store.data.locked>=LockState.DisableMove&&this.store.data.locked!==LockState.DisableScale||this.store.data.disableScale||this.store.options.disableScale)return;if(this.lastOffsetX){const{scale:a}=this.store.data;this.translate((o-this.lastOffsetX)/a,(n-this.lastOffsetY)/a)}this.lastOffsetX=o,this.lastOffsetY=n}}});D(this,"ontouchend",t=>{if(this.store.data.locked===LockState.Disable)return;this.touchCenter=void 0,this.touchScaling=void 0,this.touchMoving=void 0,this.startTouches=void 0,this.lastOffsetX=0,this.lastOffsetY=0;const i=t.changedTouches[0].pageX-this.clientRect.x,s=t.changedTouches[0].pageY-this.clientRect.y;this.onMouseUp({x:i,y:s,clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,pageX:t.changedTouches[0].pageX,pageY:t.changedTouches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1}),setTimeout(()=>{this.render()},20)});D(this,"onGesturestart",t=>{t.preventDefault()});D(this,"onMouseDown",t=>{var i,s,r,o,n;if(t.buttons===2&&!this.drawingLine&&(this.mouseRight=MouseRight.Down),this.hideInput(),this.popconfirm.hide(),this.store.data.locked===LockState.Disable||t.buttons!==1&&t.buttons!==2){this.hoverType=HoverType.None;return}if(!this.magnifierCanvas.magnifier){if(this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.mouseDown=t,this.lastMouseTime=performance.now(),this.canvasImage.fitFlag){this.canvasImage.currentFit||this.calcuActiveFit();return}if(this.hotkeyType===HotkeyType.AddAnchor){this.setAnchor(this.store.pointAt);return}if(!this.store.options.autoAnchor&&!this.drawingLine&&t.shiftKey&&t.ctrlKey&&t.altKey){this.setAnchor(this.store.pointAt),this.drawingLineName=this.store.options.drawingLineName;const c=this.store.activeAnchor;if(!c)return;const a={id:s8(),x:c.x,y:c.y};this.drawingLine=this.createDrawingLine(a);let h=getFromAnchor(this.drawingLine);this.drawingLine.calculative.activeAnchor=h,connectLine(this.store.hover,c,this.drawingLine,a),this.drawline();return}if(!(this.hotkeyType===HotkeyType.Translate||this.mouseRight===MouseRight.Down&&!this.store.options.mouseRightActive)){if(this.drawingLine){if(this.store.hoverAnchor){const a=getToAnchor(this.drawingLine);this.store.hoverAnchor.type===PointType.Line?getDistance(a,this.store.hoverAnchor,this.store):(a.x=this.store.hoverAnchor.x,a.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,a),this.drawline(),this.finishDrawline(!0);return}if(!this.store.options.autoAnchor&&t.shiftKey&&t.altKey&&t.ctrlKey){this.setAnchor(this.store.pointAt);const a=getToAnchor(this.drawingLine),h=this.store.activeAnchor;if(!h)return;a.x=h.x,a.y=h.y,connectLine(this.store.hover,h,this.drawingLine,a),this.drawline(),this.finishDrawline(!0);return}if(t.buttons===2||this.drawingLineName==="mind"&&((i=this.drawingLine)==null?void 0:i.calculative.worldAnchors.length)>1||this.store.options.drawingLineLength&&((s=this.drawingLine)==null?void 0:s.calculative.worldAnchors.length)>this.store.options.drawingLineLength){this.finishDrawline(!0),(r=this.store.active[0])!=null&&r.anchors[0].connectTo||this.store.active.length==0?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName;return}if(this.store.options.autoAnchor&&this.hoverType===HoverType.Node){const a=getToAnchor(this.drawingLine),h=nearestAnchor(this.store.hover,t);a.x=h.x,a.y=h.y,this.drawingLine.autoTo=!0,connectLine(this.store.hover,h,this.drawingLine,a),this.drawline(),this.finishDrawline(!0);return}const c=getToAnchor(this.drawingLine);c.isTemp?(this.drawingLine.calculative.activeAnchor=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2],c.isTemp=void 0):(this.drawingLine.calculative.activeAnchor=c,this.drawingLine.calculative.worldAnchors.push({x:c.x,y:c.y,penId:c.penId})),this.drawingLine.calculative.drawlineH=void 0,this.drawingLineName!=="polyline"&&this.drawline()}if(this.drawingLineName){if(this.hoverType===HoverType.Node)if(this.store.options.autoAnchor){this.inactive(!0);const c=nearestAnchor(this.store.hover,t);this.store.hoverAnchor=c;const a={id:s8(),x:c.x,y:c.y};this.drawingLine=this.createDrawingLine(a),this.drawingLine.autoFrom=!0,connectLine(this.store.hover,c,this.drawingLine,a)}else this.inactive(),this.hoverType=HoverType.None;else if(this.hoverType===HoverType.NodeAnchor){this.drawingLineName=this.store.options.drawingLineName;const c={id:s8(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};this.drawingLine=this.createDrawingLine(c),this.drawingLine.calculative.activeAnchor=c,connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,c)}else if(!this.drawingLine&&this.drawingLineName!=="curve"){this.inactive(!0);const c={id:s8(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(c),this.drawingLine.calculative.activeAnchor=c}}else if(this.pencil){this.inactive(!0);const c=s8(),a={x:t.x,y:t.y,id:s8(),penId:c};this.pencilLine=this.getInitPencilLine(a)}else{switch(this.hoverType){case HoverType.None:(this.store.data.rule||this.store.options.rule)&&!this.store.options.disableRuleLine&&this.addRuleLine(t),this.store.options.resizeMode&&(this.hotkeyType=HotkeyType.None),this.inactive();break;case HoverType.Node:case HoverType.Line:if(this.store.hover){if((o=this.store.active)!=null&&o.length&&this.store.active.length===1&&this.store.hover.id===this.store.active[0].id){this.calcActiveRect();break}const c=getParent(this.store.hover,!0);let a=c||this.store.hover;c&&(c.container||(n=this.store.options.containerShapes)!=null&&n.includes(c.name))&&(a=this.store.hover),t.ctrlKey&&!t.shiftKey?(a.calculative.active?this.willInactivePen=a:this.store.active.length>0&&(a.calculative.active=!0,setChildrenActive(a),this.store.active.push(a),this.store.emitter.emit("active",this.store.active)),this.patchFlags=!0):t.ctrlKey&&t.shiftKey&&this.store.hover.parentId?this.active([this.store.hover]):(!(this.activeRect&&pointInRect({x:t.x,y:t.y},this.activeRect))||this.store.active.length==1)&&(a.calculative.active||(this.active([a]),this.store.options.resizeMode&&(this.hotkeyType=HotkeyType.Resize))),this.calcActiveRect()}break;case HoverType.LineAnchor:this.store.activeAnchor=this.store.hoverAnchor,this.store.hover.calculative.activeAnchor=this.store.hoverAnchor,this.active([this.store.hover]);break;case HoverType.LineAnchorPrev:case HoverType.LineAnchorNext:this.store.activeAnchor&&(this.prevAnchor={...this.store.activeAnchor.prev},this.nextAnchor={...this.store.activeAnchor.next});break;case HoverType.Resize:this.activeInitPos=[],this.store.active.forEach(c=>{this.activeInitPos.push({x:(c.calculative.worldRect.x-this.activeRect.x)/this.activeRect.width,y:(c.calculative.worldRect.y-this.activeRect.y)/this.activeRect.height})});break}this.store.hover&&(this.store.hover.calculative.mouseDown=!0),this.store.emitter.emit("mousedown",{x:t.x,y:t.y,pen:this.store.hover})}this.render()}}});D(this,"onMouseMove",t=>{var s,r,o,n,c,a,h,l;if(this.store.data.locked===LockState.Disable){this.hoverType=HoverType.None;return}if(this.mouseDown&&!this.mouseDown.restore&&t.buttons!==1&&t.buttons!==2){this.onMouseUp(t);return}if(this.lastMouseTime){if(performance.now()-this.lastMouseTime<50){this.lastMouseTime=0;return}this.lastMouseTime=0}if(this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.magnifierCanvas.magnifier){this.render();return}if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){const u=performance.now();u-this.fitTimer>100&&(this.mouseDown?this.updateFit(t):this.inFitBorder(this.mousePos),this.fitTimer=u);return}if(this.mouseDown&&!this.store.options.disableTranslate&&!this.store.data.disableTranslate){if(this.mouseRight===MouseRight.Down&&(this.mouseRight=MouseRight.Translate),this.store.data.locked===LockState.DisableEdit||this.store.data.locked===LockState.DisableScale||this.hotkeyType===HotkeyType.Translate||this.mouseRight===MouseRight.Translate){const{scale:u}=this.store.data;let d=(t.x-this.mouseDown.x)/u,f=(t.y-this.mouseDown.y)/u;t.shiftKey&&!t.ctrlKey&&(f=0),t.ctrlKey&&(d=0),this.translate(d,f);return}if(this.store.data.locked)return;if(!this.drawingLine&&!this.pencil){if(!this.drawingLineName&&!this.movingAnchor){if(this.hoverType===HoverType.NodeAnchor){if(!this.store.hoverAnchor)return;this.drawingLineName=this.store.options.drawingLineName;const u={id:s8(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};this.drawingLine=this.createDrawingLine(u),this.drawingLine.calculative.activeAnchor=u,connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,u),this.drawline();return}}else if(this.drawingLineName&&this.hoverType===HoverType.None){const u={id:s8(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(u),this.drawingLine.calculative.activeAnchor=u,this.drawline();return}if(t.buttons===1&&(t.ctrlKey||!this.hoverType&&!this.hotkeyType)&&!(t.ctrlKey&&(this.store.activeAnchor||(s=this.store.active)!=null&&s.length))){this.dragRect={x:Math.min(this.mouseDown.x,t.x),y:Math.min(this.mouseDown.y,t.y),ex:Math.max(this.mouseDown.x,t.x),ey:Math.max(this.mouseDown.y,t.y),width:Math.abs(t.x-this.mouseDown.x),height:Math.abs(t.y-this.mouseDown.y)},this.render();return}if(this.movingAnchor){const u=t.x-this.movingAnchor.x,d=t.y-this.movingAnchor.y;this.translateAnchor(u,d),this.render();return}else if(!((r=this.store.active[0])!=null&&r.locked)){const u={x:t.x,y:t.y};if(this.hoverType===HoverType.LineAnchor){(this.dockInAnchor(t)||((o=this.store.active[0])==null?void 0:o.lineName)==="line")&&!this.store.options.disableDock&&!this.store.options.disableLineDock&&(this.clearDock(),this.dock=calcAnchorDock(this.store,u,this.store.activeAnchor),(n=this.dock)!=null&&n.xDock&&(u.x+=this.dock.xDock.step),(c=this.dock)!=null&&c.yDock&&(u.y+=this.dock.yDock.step)),this.moveLineAnchor(u,t);return}if(this.hoverType===HoverType.LineAnchorPrev){this.moveLineAnchorPrev(t);return}if(this.hoverType===HoverType.LineAnchorNext){this.moveLineAnchorNext(t);return}}if(this.hoverType===HoverType.Rotate){this.rotatePens({x:t.x,y:t.y});return}if(this.hoverType===HoverType.Resize){this.resizePens(t);return}if(this.hoverType===HoverType.Node||this.hoverType===HoverType.Line){const u=t.x-this.mouseDown.x,d=t.y-this.mouseDown.y,f=20;if(t.ctrlKey&&!t.shiftKey&&(Math.abs(u)>=f||Math.abs(d)>=f)&&(this.willInactivePen=void 0),this.store.active.length===1){const g=this.store.active[0];if((g.locked===void 0||g.locked<LockState.DisableMove)&&((a=g==null?void 0:g.onMouseMove)==null||a.call(g,g,this.mousePos)),g.calculative.focus)return}this.movePens(t),this.getContainerHover(t);return}}else if(this.pencil){const{x:u,y:d}=t,f={x:u,y:d};f.id=s8(),f.penId=this.pencilLine.id,this.pencilLine.calculative.worldAnchors.push(f),this.store.path2dMap.set(this.pencilLine,globalStore.path2dDraws[this.pencilLine.name](this.pencilLine)),this.patchFlags=!0}}if(this.drawingLine){const{x:u,y:d}=t,f={x:u,y:d};if(f.id=s8(),f.penId=this.drawingLine.id,!this.store.options.disableDock&&!this.store.options.disableLineDock&&(this.clearDock(),this.dock=calcAnchorDock(this.store,f),(h=this.dock)!=null&&h.xDock&&(f.x+=this.dock.xDock.step),(l=this.dock)!=null&&l.yDock&&(f.y+=this.dock.yDock.step)),this.mouseDown&&this.drawingLineName==="curve"&&!this.drawingLine.calculative.worldAnchors[0].connectTo)this.drawline(f);else{let g;if(this.drawingLine.calculative.worldAnchors.length>1&&(g=getToAnchor(this.drawingLine)),g?(g.prev=void 0,g.next=void 0,g.id||(g.id=s8()),g.x=f.x,g.y=f.y,g.connectTo=void 0):(g={...f},this.drawingLine.calculative.worldAnchors.push(g)),(this.hoverType===HoverType.NodeAnchor||this.hoverType===HoverType.LineAnchor)&&(this.store.hoverAnchor.type!==PointType.Line&&(g.x=this.store.hoverAnchor.x,g.y=this.store.hoverAnchor.y),g.connectTo=this.store.hoverAnchor.penId,this.drawingLineName==="polyline"&&(g.isTemp=!1)),this.drawingLineName==="line"){if(t.ctrlKey&&!t.shiftKey)g.x=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].x;else if(t.shiftKey&&!t.ctrlKey)g.y=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].y;else if(t.shiftKey&&t.ctrlKey){let y=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2];this.getSpecialAngle(g,y)}}this.drawline()}}globalThis.debug&&console.time("hover");const i=performance.now();i-this.hoverTimer>50&&(this.hoverTimer=i,this.getHover(t)),globalThis.debug&&console.timeEnd("hover"),this.hotkeyType===HotkeyType.AddAnchor&&(this.patchFlags=!0),this.render(!1)});D(this,"onMouseUp",t=>{if(this.store.data.locked===LockState.Disable){this.hoverType=HoverType.None;return}if(this.mouseDown){if(this.mouseRight===MouseRight.Down&&(this.store.hover&&this.store.hover.onContextmenu?this.store.hover.onContextmenu(this.store.hover,t):this.store.emitter.emit("contextmenu",{e:t,clientRect:this.clientRect,pen:this.store.hover})),this.mouseRight=MouseRight.None,this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.pencil&&this.finishPencil(),this.drawingLine){if(this.store.hoverAnchor){const i=getToAnchor(this.drawingLine);this.store.hoverAnchor.type===PointType.Line?getDistance(i,this.store.hoverAnchor,this.store):(i.x=this.store.hoverAnchor.x,i.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,i),this.drawline(),this.finishDrawline(!0);return}if(this.store.options.autoAnchor&&this.hoverType===HoverType.Node){const i=getToAnchor(this.drawingLine),s=nearestAnchor(this.store.hover,t);i.x=s.x,i.y=s.y,this.drawingLine.autoTo=!0,connectLine(this.store.hover,s,this.drawingLine,i),this.drawline(),this.finishDrawline(!0);return}}if(this.hoverType===HoverType.LineAnchor&&this.store.hover&&this.store.active[0]&&this.store.active[0].name==="line"&&this.store.active[0]!==this.store.hover){const i=this.store.active[0],s=getFromAnchor(i),r=getToAnchor(i);if(this.store.hoverAnchor){const o=this.store.hover,n=getFromAnchor(o)===this.store.hoverAnchor,c=getToAnchor(o)===this.store.hoverAnchor,a=s===this.store.activeAnchor,h=r===this.store.activeAnchor;if((t.ctrlKey||t.altKey)&&o.type===PenType.Line&&(n||c)&&(a||h)){const l=o.calculative.worldAnchors.map(u=>({...u,penId:i.id}));n?l.shift():c&&l.pop(),(n&&a||c&&h)&&l.reverse(),a?(i.calculative.worldAnchors[0].connectTo=void 0,i.calculative.worldAnchors.unshift(...l)):h&&(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].connectTo=void 0,i.calculative.worldAnchors.push(...l)),this.delete([o]),this.render()}else this.store.activeAnchor&&(this.store.hoverAnchor.type===PointType.Line?getDistance(this.store.activeAnchor,this.store.hoverAnchor,this.store):(this.store.activeAnchor.x=this.store.hoverAnchor.x,this.store.activeAnchor.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,i,this.store.activeAnchor));this[i.lineName]&&i.lineName!=="polyline"&&this[i.lineName](this.store,i),this.store.path2dMap.set(i,globalStore.path2dDraws.line(i)),this.initLineRect(i)}else s===this.store.activeAnchor&&i.autoFrom?this.calcAutoAnchor(i,s,this.store.hover):r===this.store.activeAnchor&&i.autoTo&&this.calcAutoAnchor(i,r,this.store.hover)}if(this.addCaches&&this.addCaches.length){if(!this.store.data.locked){if(this.dragRect&&this.addCaches.length===1){const i=this.addCaches[0];i.width=this.dragRect.width/this.store.data.scale,i.height=this.dragRect.height/this.store.data.scale,t.x=(this.dragRect.x+this.dragRect.ex)/2,t.y=(this.dragRect.y+this.dragRect.ey)/2}this.dropPens(this.addCaches,t)}this.addCaches=void 0}if(this.hoverType===HoverType.Rotate&&(this.getSizeCPs(),this.store.active.forEach(i=>{i.rotate=i.calculative.rotate})),this.patchFlagsLines.forEach(i=>{i.type&&this.initLineRect(i)}),this.patchFlagsLines.clear(),this.dragRect)if(this.canvasImage.fitFlag)this.makeFit();else{const i=this.store.data.pens.filter(s=>{if(s.visible===!1||s.locked>=LockState.DisableMove||s.parentId||s.isRuleLine)return!1;if(rectInRect(s.calculative.worldRect,this.dragRect,t.ctrlKey||this.store.options.dragAllIn))return s.type===PenType.Line&&!this.store.options.dragAllIn?lineInRect(s,this.dragRect):!0});this.active(i)}if(t.button!==2&&(distance(this.mouseDown,t)<2&&(this.store.hover&&this.store.hover.input&&(this.store.hover.onShowInput?this.store.hover.onShowInput(this.store.hover,t):this.showInput(this.store.hover)),this.store.emitter.emit("click",{x:t.x,y:t.y,pen:this.store.hover})),this.store.hover&&(this.store.hover.calculative.mouseDown=!1),this.store.hover!=this.store.hoverContainer&&this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hover}),this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hoverContainer})),this.willInactivePen){this.willInactivePen.calculative.active=void 0,setChildrenActive(this.willInactivePen,!1);const i=this.store.active.findIndex(s=>s===this.willInactivePen);i>=0&&this.store.active.splice(i,1),this.calcActiveRect(),this.willInactivePen=void 0,this.store.emitter.emit("inactive",[this.willInactivePen]),this.render()}this.movingPens&&(t.altKey&&!t.shiftKey?this.copyMovedPens():this.movedActivePens(t.ctrlKey&&t.shiftKey),this.getAllByPens(this.movingPens).forEach(i=>{this.store.pens[i.id]=void 0}),this.movingPens=void 0),this.store.active&&this.store.active[0]&&(this.store.active[0].calculative.h=void 0),this.mouseDown=void 0,this.lastOffsetX=0,this.lastOffsetY=0,this.clearDock(),this.dragRect=void 0,this.initActiveRect=void 0,this.render()}});D(this,"clearDock",()=>{var o,n,c,a;const t=(n=(o=this.dock)==null?void 0:o.xDock)==null?void 0:n.penId,i=(a=(c=this.dock)==null?void 0:c.yDock)==null?void 0:a.penId,s=this.store.pens[t];s&&(s.calculative.isDock=!1);const r=this.store.pens[i];r&&(r.calculative.isDock=!1),this.dock=void 0});D(this,"onResize",()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.resize(),this.timer=void 0},100)});D(this,"onScroll",()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.clientRect=this.canvas.getBoundingClientRect(),this.timer=void 0},100)});D(this,"calibrateMouse",t=>(t.x-=this.store.data.x,t.y-=this.store.data.y,t));D(this,"getContainerHover",t=>{var s;if(this.dragRect)return;this.store.hoverContainer=void 0;const i=this.store.data.pens.filter(r=>{var o;return r.container||((o=this.store.options.containerShapes)==null?void 0:o.includes(r.name))});if(i.length)for(let r=i.length-1;r>=0;--r){const o=i[r];if(!(o.visible==!1||o.calculative.inView==!1||o.locked===LockState.Disable)){if(pointInRect(t,o.calculative.worldRect))this.store.hoverContainer=o,(s=o==null?void 0:o.onMouseMove)==null||s.call(o,o,t),this.store.lastHoverContainer!==this.store.hoverContainer&&(this.patchFlags=!0,this.store.lastHoverContainer&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.hoverContainer&&(this.store.hoverContainer.calculative.containerHover=!0,this.store.emitter.emit("enter",this.store.hoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer);else if(o===this.store.hoverContainer&&(this.store.hoverContainer=void 0,this.store.lastHoverContainer!==this.store.hoverContainer)){this.patchFlags=!0;const n=this.store.lastHoverContainer.calculative.canvas.store.pens[this.store.lastHoverContainer.id+movingSuffix];this.store.lastHoverContainer&&!n&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer}}}});D(this,"getHover",t=>{var r,o;if(this.dragRect||this.canvasImage.fitFlag)return;let i=HoverType.None;this.store.hover=void 0,this.store.hoverAnchor=void 0,this.title.hide(),this.store.pointAt=void 0,this.store.pointAtIndex=void 0;const s=this.store.active.length===1&&this.store.active[0].type;if(!this.drawingLineName&&this.hotkeyType!==HotkeyType.AddAnchor&&this.activeRect&&!s&&!this.store.data.locked){const n=getPensLock(this.store.active),c=getPensDisableRotate(this.store.active)||this.store.options.disableRotate,a=getPensDisableResize(this.store.active)||this.store.options.disableSize;if(!n&&!c){const h={x:this.activeRect.center.x,y:this.activeRect.y-30};this.activeRect.rotate&&rotatePoint(h,this.activeRect.rotate,this.activeRect.pivot||this.activeRect.center),!this.hotkeyType&&hitPoint(t,h,this.pointSize)&&(i=HoverType.Rotate,this.externalElements.style.cursor=`url("${this.store.options.rotateCursor}"), auto`)}if(!n&&!a)for(let h=0;h<8;h++){const l=h<4;if((this.hotkeyType===HotkeyType.Resize||l&&!this.hotkeyType)&&hitPoint(t,this.sizeCPs[h],this.pointSize)){let d=l?defaultCursors:rotatedCursors,f=0;Math.abs(this.activeRect.rotate%90-45)<25?(d=l?rotatedCursors:defaultCursors,f=Math.round((this.activeRect.rotate-45)/90)+(l?0:1)):f=Math.round(this.activeRect.rotate/90),i=HoverType.Resize,this.resizeIndex=h,this.externalElements.style.cursor=d[(h+f)%4];break}}}i===HoverType.None&&(i=this.inPens(t,this.store.data.pens)),!i&&!s&&pointInRect(t,this.activeRect)&&(i=HoverType.Node,this.externalElements.style.cursor="move"),this.hoverType=i,i===HoverType.None&&(this.drawingLineName||this.pencil?this.externalElements.style.cursor="crosshair":this.mouseDown||(this.externalElements.style.cursor="default"),this.store.hover=void 0),this.store.lastHover!==this.store.hover&&(this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1,setHover(getParent(this.store.lastHover,!0)||this.store.lastHover,!1),this.store.emitter.emit("leave",this.store.lastHover),this.tooltip.hide()),this.store.hover&&(this.store.hover.calculative.hover=!0,setHover(getParent(this.store.hover,!0)||this.store.hover),this.store.emitter.emit("enter",this.store.hover),this.tooltip.show(this.store.hover,t)),this.store.lastHover=this.store.hover),(o=(r=this.store.hover)==null?void 0:r.onMouseMove)==null||o.call(r,this.store.hover,this.mousePos)});D(this,"inPens",(t,i)=>{var r;let s=HoverType.None;t:for(let o=i.length-1;o>=0;--o){const n=i[o];if(n.visible==!1||n.calculative.inView==!1||n.locked===LockState.Disable)continue;const c=getLineR(n);if(!(!n.calculative.active&&!pointInSimpleRect(t,n.calculative.worldRect,c)&&!pointInRect(t,n.calculative.worldRect))){if(!this.store.data.locked&&this.hotkeyType!==HotkeyType.Resize&&n.calculative.worldAnchors){for(const a of n.calculative.worldAnchors)if(s=this.inAnchor(t,n,a),s){let h=deepClone(a);Object.assign(h,t),this.title.show(h,n);break t}}if(n.type){if(n.isRuleLine){let h=((r=this.store.options.ruleOptions)==null?void 0:r.height)||20;if(t.x+this.store.data.x>h&&t.y+this.store.data.y>h)break}const a=pointInLine(t,n);if(a){!this.store.data.locked&&!n.locked?this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move":this.externalElements.style.cursor=this.store.options.hoverCursor,n.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=n,this.store.pointAt=a.point,this.store.pointAtIndex=a.i,this.initTemplateCanvas([this.store.hover]),s=HoverType.Line;break}}else{if(n.children){const h=[];if(n.children.forEach(l=>{this.store.pens[l]&&h.push(this.store.pens[l])}),s=this.inPens(t,h),s)break}let a=!1;if(n.name==="line"?a=pointInSimpleRect(t,n.calculative.worldRect,n.lineWidth):a=pointInRect(t,n.calculative.worldRect),a){if(n.type===PenType.Node&&n.name==="line"&&!pointInPolygon(t,n.calculative.worldAnchors))continue;if(!this.store.data.locked&&!n.locked?this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move":this.externalElements.style.cursor=this.store.options.hoverCursor,n.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=n,this.initTemplateCanvas([this.store.hover]),s=HoverType.Node,this.store.pointAt=t,!t.ctrlKey){let{x:h,y:l,ex:u,ey:d,rotate:f,center:g}=this.store.hover.calculative.worldRect;if(f){const y=[{x:h,y:l},{x:u,y:l},{x:u,y:d},{x:h,y:d}];y.forEach(b=>{rotatePoint(b,f,g)});let v=y[y.length-1];for(const b of y){if(v.y>t.y!=b.y>t.y){const x=b.x+(t.y-b.y)*(v.x-b.x)/(v.y-b.y);Math.abs(x-this.store.pointAt.x)<10&&(this.store.pointAt.x=x)}v=b}}else this.store.pointAt.x-10<h?this.store.pointAt.x=h:this.store.pointAt.x+10>u&&(this.store.pointAt.x=u),this.store.pointAt.y-10<l?this.store.pointAt.y=l:this.store.pointAt.y+10>d&&(this.store.pointAt.y=d)}break}}}}return s});D(this,"dockInAnchor",t=>{var i,s;this.store.hover=void 0;for(let r=this.store.data.pens.length-1;r>=0;--r){const o=this.store.data.pens[r];if(o.visible==!1||o.locked===LockState.Disable||o===this.store.active[0])continue;let n=getLineR(o);if(n+=2*this.store.options.anchorRadius,!!pointInSimpleRect(t,o.calculative.worldRect,n)&&(this.store.hover=o,this.hotkeyType!==HotkeyType.Resize&&o.calculative.worldAnchors))for(const c of o.calculative.worldAnchors){if(c.twoWay===TwoWay.In){const a=getToAnchor(this.store.active[0]);if(this.store.activeAnchor.id!==a.id)continue}if(c.twoWay===TwoWay.Out){const a=getFromAnchor(this.store.active[0]);if(this.store.activeAnchor.id!==a.id)continue}if(!(c.twoWay===TwoWay.DisableConnected||c.twoWay===TwoWay.Disable||((i=this.store.activeAnchor)==null?void 0:i.twoWay)===TwoWay.DisableConnectTo||((s=this.store.activeAnchor)==null?void 0:s.twoWay)===TwoWay.Disable)&&(this.title.hide(),this.inAnchor(t,o,c))){let a=deepClone(c);return Object.assign(a,t),this.title.show(a,o),!0}}}});D(this,"imageTimer");D(this,"templateImageTimer");D(this,"render",t=>{if(t&&(this.opening=!1),this.opening)return;let i;if(t==null||t===!0||t===1/0?(i=performance.now(),this.patchFlags=!0):t>1?i=t:i=performance.now(),!this.patchFlags)return;if(i-this.lastRender<this.store.options.interval){this.renderTimer&&cancelAnimationFrame(this.renderTimer),this.renderTimer=requestAnimationFrame(this.render);return}this.renderTimer=void 0,this.lastRender=i;const s=this.offscreen.getContext("2d");s.clearRect(0,0,this.offscreen.width,this.offscreen.height),s.save(),s.translate(this.store.data.x,this.store.data.y),globalThis.debugRender&&console.time("renderPens"),this.renderPens(),globalThis.debugRender&&console.timeEnd("renderPens"),this.renderBorder(),this.renderHoverPoint(),s.restore(),this.magnifierCanvas.magnifier&&this.magnifierCanvas.render();const r=this.canvas.getContext("2d");r.clearRect(0,0,this.canvas.width,this.canvas.height),r.drawImage(this.offscreen,0,0,this.width,this.height),this.canvasTemplate.render(),this.canvasImageBottom.render(),this.canvasImage.render(),this.patchFlags=!1});D(this,"renderPens",()=>{const t=this.offscreen.getContext("2d");t.strokeStyle=this.store.styles.color;for(const i of this.store.data.pens)isFinite(i.x)&&i.canvasLayer!==CanvasLayer.CanvasTemplate&&(i.name==="combine"&&!i.draw||i.calculative.inView&&(i.canvasLayer===CanvasLayer.CanvasMain&&i.name!=="gif"&&i.image&&i.calculative.img&&(t.save(),ctxFlip(t,i),i.calculative.rotate&&ctxRotate(t,i),setGlobalAlpha(t,i),drawImage(t,i),t.restore()),renderPen(t,i)));this.drawingLine&&renderPen(t,this.drawingLine),this.pencilLine&&renderPen(t,this.pencilLine),this.movingPens&&this.movingPens.forEach(i=>{this.renderPenContainChild(t,i)})});D(this,"renderPenContainChild",(t,i)=>{var s;i.calculative.inView&&(i.name==="combine"&&!i.draw||renderPen(t,i)),(s=i.children)==null||s.forEach(r=>{const o=this.store.pens[r];o&&this.renderPenContainChild(t,o)})});D(this,"renderBorder",()=>{if(!this.store.data.locked&&this.activeRect&&!(this.store.active.length===1&&this.store.active[0].type)&&!this.movingPens){const t=this.offscreen.getContext("2d");t.save(),t.translate(.5,.5);const i=this.activeRect.pivot||this.activeRect.center;if(this.activeRect.rotate&&(t.translate(i.x,i.y),t.rotate(this.activeRect.rotate*Math.PI/180),t.translate(-i.x,-i.y)),t.strokeStyle=this.store.styles.activeColor,t.globalAlpha=this.store.options.activeGlobalAlpha===void 0?.3:this.store.options.activeGlobalAlpha,t.beginPath(),t.lineWidth=this.store.options.activeLineWidth||1,t.setLineDash(this.store.options.activeLineDash||[]),t.strokeRect(this.activeRect.x,this.activeRect.y,this.activeRect.width,this.activeRect.height),t.setLineDash([]),t.lineWidth=1,t.globalAlpha=1,getPensLock(this.store.active)||getPensDisableRotate(this.store.active)||this.store.options.disableRotate){t.restore();return}t.beginPath(),t.moveTo(this.activeRect.center.x,this.activeRect.y),t.lineTo(this.activeRect.center.x,this.activeRect.y-30),t.stroke(),t.beginPath(),t.strokeStyle=this.store.styles.activeColor,t.fillStyle="#ffffff",t.arc(this.activeRect.center.x,this.activeRect.y-30,5,0,Math.PI*2),t.fill(),t.stroke(),t.restore()}});D(this,"renderHoverPoint",()=>{if(this.store.data.locked)return;const t=this.offscreen.getContext("2d");if(t.save(),t.translate(.5,.5),!this.store.options.disableAnchor&&this.store.hover&&!this.store.hover.disableAnchor&&(this.hotkeyType!==HotkeyType.Resize||this.store.active.length!==1||this.store.active[0]!==this.store.hover)){const i=[...this.store.hover.calculative.worldAnchors];this.store.pointAt&&this.hotkeyType===HotkeyType.AddAnchor&&i.push(this.store.pointAt),i&&(t.strokeStyle=this.store.hover.anchorColor||this.store.styles.anchorColor,t.fillStyle=this.store.hover.anchorBackground||this.store.options.anchorBackground,i.forEach(s=>{if(s.hidden&&s.locked>LockState.DisableEdit)return;if(s===this.store.hoverAnchor){t.save();const o=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;t.strokeStyle=o,t.fillStyle=o}t.beginPath();let r=s.radius||this.store.hover.anchorRadius||this.store.options.anchorRadius;if(this.store.hover.type&&!s.radius&&!this.store.hover.anchorRadius&&(r=3,this.store.hover.calculative.lineWidth>3&&(r=this.store.hover.calculative.lineWidth)),s.type===PointType.Line){let o=this.store.pens[s.penId].rotate||0;this.store.pens[s.penId].calculative.flipX&&(o*=-1),this.store.pens[s.penId].calculative.flipY&&(o*=-1);let n=s.rotate+o;this.store.pens[s.penId].calculative.flipX&&(n*=-1),this.store.pens[s.penId].calculative.flipY&&(n*=-1),t.save(),t.translate(s.x,s.y),t.rotate(n*Math.PI/180),t.translate(-s.x,-s.y),t.rect(s.x-s.length*this.store.data.scale/2,s.y-r,s.length*this.store.data.scale,r*2),t.restore()}else t.arc(s.x,s.y,r,0,Math.PI*2);if(this.store.hover.type&&this.store.hoverAnchor===s?(t.save(),t.strokeStyle=this.store.hover.activeColor||this.store.styles.activeColor,t.fillStyle=t.strokeStyle):(s.color||s.background)&&(t.save(),t.strokeStyle=s.color,t.fillStyle=s.background),t.fill(),t.stroke(),s===this.store.hoverAnchor&&t.restore(),(this.store.hover.type&&this.store.hoverAnchor===s||s.color||s.background)&&t.restore(),!this.store.hover.parentId&&this.store.hover.children&&this.store.hover.children.length>0&&s===this.store.hoverAnchor){t.save(),t.beginPath(),t.lineWidth=3;const o=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;globalThis.pSBC&&(t.strokeStyle=globalThis.pSBC(.5,o)),t.arc(s.x,s.y,r+1.5,0,Math.PI*2),t.stroke(),t.restore()}}))}this.hotkeyType!==HotkeyType.AddAnchor&&!this.movingPens&&this.activeRect&&!(this.store.active.length===1&&this.store.active[0].type)&&!getPensLock(this.store.active)&&!getPensDisableResize(this.store.active)&&!this.store.options.disableSize&&(t.strokeStyle=this.store.styles.activeColor,t.fillStyle="#ffffff",this.sizeCPs.forEach((i,s)=>{this.activeRect.rotate&&(t.save(),t.translate(i.x,i.y),t.rotate(this.activeRect.rotate*Math.PI/180),t.translate(-i.x,-i.y)),(s<4||this.hotkeyType===HotkeyType.Resize)&&(t.beginPath(),t.fillRect(i.x-4.5,i.y-4.5,8,8),t.strokeRect(i.x-5.5,i.y-5.5,10,10)),this.activeRect.rotate&&t.restore()})),!this.store.data.locked&&this.dragRect&&(t.save(),t.fillStyle=rgba(this.store.options.dragColor,.2),t.strokeStyle=this.store.options.dragColor,t.beginPath(),t.strokeRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),t.fillRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),t.restore()),this.dock&&(t.strokeStyle=this.store.options.dockColor,this.dock.xDock&&(t.beginPath(),t.moveTo(this.dock.xDock.x,this.dock.xDock.y),t.lineTo(this.dock.xDock.x,this.dock.xDock.prev.y),t.stroke()),this.dock.yDock&&(t.beginPath(),t.moveTo(this.dock.yDock.x,this.dock.yDock.y),t.lineTo(this.dock.yDock.prev.x,this.dock.yDock.y),t.stroke())),t.restore()});D(this,"transTimeout");D(this,"pastePen",(t,i)=>{const s=t.id;if(randomId(t),t.parentId=i,t.type===PenType.Line?this.changeNodeConnectedLine(s,t,this.store.clipboard.pens):this.changeLineAnchors(s,t,this.store.clipboard.pens),!t.parentId){const o=this.getPenRect(t,this.store.clipboard.origin,this.store.clipboard.scale),n=this.getPenRect(this.store.clipboard.initRect,this.store.clipboard.origin,this.store.clipboard.scale),{origin:c,scale:a}=this.store.data;t.x=c.x+o.x*a,t.y=c.y+o.y*a,t.width=o.width*a,t.height=o.height*a,n.x=c.x+n.x*a,n.y=c.y+n.y*a,calcCenter(n),this.store.clipboard.pos&&(t.x-=n.center.x-this.store.clipboard.pos.x,t.y-=n.center.y-this.store.clipboard.pos.y),this.keyOptions&&this.keyOptions.altKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey)?(t.x=-this.store.data.x+this.width/2-t.width/2,t.y=-this.store.data.y+this.height/2-t.height/2):this.keyOptions&&this.keyOptions.shiftKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey||this.keyOptions.F)||(t.x+=this.store.clipboard.offset*this.store.data.scale,t.y+=this.store.clipboard.offset*this.store.data.scale)}this.makePen(t);const r=[];if(Array.isArray(t.children))for(const o of t.children){const n=this.store.clipboard.pens.find(c=>c.id===o);n&&r.push(this.pastePen(n,t.id).id)}return t.children=r,calcInView(t,!0),t});D(this,"ondblclick",t=>{var i,s,r;if(this.store.hover&&(!this.store.data.locked||this.store.hover.dbInput)&&!this.store.options.disableInput)if(this.store.hover.onShowInput)this.store.hover.onShowInput(this.store.hover,t);else if(this.store.hover&&this.store.hover.parentId)if(((i=this.store.active)==null?void 0:i.length)===1&&this.store.active[0].id===this.store.hover.id)this.showInput(this.store.hover);else{if(this.store.pens[this.store.hover.parentId].children.forEach(o=>{this.store.pens[o].calculative.active=!1,this.store.pens[o].calculative.hover=!1}),this.store.hover.parentId){let o=this.store.hover.id;const n=this.calibrateMouse({x:t.offsetX,y:t.offsetY});let c=1/0;(r=(s=this.store.pens[this.store.hover.parentId])==null?void 0:s.children)==null||r.forEach(a=>{const h=this.store.pens[a];if(pointInRect(n,h.calculative.worldRect)){const l=Math.sqrt((n.x-h.calculative.worldRect.center.x)**2+(n.y-h.calculative.worldRect.center.y)**2);l<c&&(c=l,o=a)}}),this.store.hover=this.store.pens[o],this.store.pens[o].calculative.hover=!0}this.active([this.store.hover])}else this.showInput(this.store.hover);this.store.emitter.emit("dblclick",{x:t.x,y:t.y,pen:this.store.hover})});D(this,"showInput",(t,i,s="transparent")=>{if(!window||!this.store.hover||this.store.hover.locked||this.store.hover.externElement||this.store.hover.disableInput||this.store.hover.disabled)return;if(this.inputDiv.dataset.penId===t.id){this.inputDiv.dataset.isInput="true",this.inputDiv.contentEditable="true",this.inputDiv.focus();const l=window.getSelection();l.selectAllChildren(this.inputDiv),l.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,this.inputDiv.scrollLeft=this.inputDiv.scrollWidth;return}!i&&!t.dbInput?this.setInputStyle(t):(this.inputDiv.style.width="100%",this.inputDiv.style.height="100%");const r=i||t.calculative.worldTextRect,c=`${(t.calculative.tempText===void 0?t.text+""||"":t.calculative.tempText).replace(/\x20/g,"&nbsp;").split(/[\s\n]/).join("</div><div>")}</div>`.replace("</div>","").replace(/\<div\>\<\/div\>/g,"<div><br></div>");this.inputDiv.innerHTML=c,this.inputParent.style.left=r.x+this.store.data.x-(t.calculative.textLeft||0)+"px",this.inputParent.style.top=r.y+this.store.data.y-(t.calculative.textTop||0)+"px";let a=r.width;this.inputParent.style.width=(a<0?12:a)+"px",this.inputParent.style.height=r.height+(t.textTop||0)+"px",this.inputParent.style.zIndex="9999",this.inputParent.style.background=s,t.rotate%360?this.inputParent.style.transform=`rotate(${t.rotate}deg)`:this.inputParent.style.transform=null,this.inputParent.style.display="flex",this.inputDiv.dataset.penId=t.id,this.inputDiv.contentEditable=t.disableInput==null?"true":t.disableInput.toString(),t.dropdownList&&this.dropdown.style.display!=="block"&&(this.dropdown.style.background=t.dropdownBackground||this.store.styles.popContentBg||"#fff",this.dropdown.style.color=t.dropdownColor||"#bdc7db",this.dropdown.style.width=this.inputParent.style.width,this.dropdown.style.fontSize=(t.fontSize||12)+"px",this.setDropdownList(),this.externalElements.style.zIndex="9999"),this.inputDiv.contentEditable="true",this.inputDiv.focus();const h=window.getSelection();h.selectAllChildren(this.inputDiv),h.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,this.inputDiv.scrollLeft=this.inputDiv.scrollWidth,t.calculative.text=void 0,this.initTemplateCanvas([t]),this.render()});D(this,"setInputStyle",t=>{t.text||(t.text="");let i;for(let a=0;a<document.styleSheets.length;a++)document.styleSheets[a].title==="le5le.com"&&(i=document.styleSheets[a]);let s="overflow: scroll;",r="",o=1;const{scale:n}=this.store.data;if(t.fontSize<12&&(o=12/t.fontSize),t.textAlign?s+=`text-align: ${t.textAlign};`:s+="text-align: center;",t.textAlign&&t.whiteSpace==="pre-line"&&(s+=`align-items: ${{left:"start",center:"center",right:"end"}[t.textAlign]};`),t.textBaseline?s+=`justify-content: ${{top:"start",middle:"center",bottom:"end"}[t.textBaseline]};`:s+="justify-content: center;",t.fontFamily&&(s+=`font-family: ${t.fontFamily};`),t.fontSize&&(t.fontSize*n<12?(s+=`font-size:${t.fontSize}px;`,s+=`zoom:${t.fontSize/12*n};`):s+=`font-size:${t.fontSize*n}px;`),s+=`color:${getTextColor(t,this.store)};`,t.fontStyle&&(s+=`font-style: ${t.fontStyle};`),t.fontWeight&&(s+=`font-weight: ${t.fontWeight};`),t.textLeft&&(s+=`margin-left:${n>1?t.textLeft*o:t.textLeft*o/n}px;`),t.textTop&&(s+=`margin-top:${n>1?t.textTop*o:t.textTop*o/n}px;`),t.lineHeight&&(s+=`line-height:${n>1?t.fontSize*t.lineHeight*n:t.fontSize*t.lineHeight*o}px;`),t.textHeight)s+=`height:${n>1?t.textHeight*o*n:t.textHeight*o}px;`;else{let a=t.calculative.worldRect.height/n;a<0&&(a=0);let h=t.fontSize*n<12?a*o:a*n*o;h<t.fontSize*t.lineHeight*n&&(h=t.fontSize*t.lineHeight*n,s+=`top:-${h/2}px;`),s+=`height:${h}px;`}let c=null;if(t.textWidth)c=t.textWidth<1&&t.textWidth>-1?t.textWidth*t.calculative.worldRect.width:t.textWidth,t.whiteSpace!=="pre-line"&&(c<t.fontSize?s+=`width:${t.fontSize*1.2*o}px;`:s+=`width:${n>1?c*o*n:c*o}px;`);else if(t.whiteSpace===void 0||t.whiteSpace==="break-all"){let a=(t.calculative.worldTextRect.width||12)/n;a<0&&(a=0),s+=`width:${t.fontSize*n<12?a*o:a*n}px;`}if(t.whiteSpace&&(t.whiteSpace==="pre-line"?s+="white-space:pre;":(s+=`white-space:${t.whiteSpace};`,t.whiteSpace==="nowrap"&&(r+="display:contents;"))),t.whiteSpace!=="nowrap"){let a=t.fontSize*1.2*t.text.length,h=(c||t.calculative.worldRect.width/n)*Math.floor(t.calculative.worldRect.height/n/(t.lineHeight*t.fontSize));a>h&&(s+="justify-content: start;")}i.deleteRule(0),i.deleteRule(0),i.insertRule(`.meta2d-input
      .input-div{
        resize:none;border:none;outline:none;background:transparent;position:absolute;flex-grow:1;height:100%;width: 100%;position:absolute;left:0;top:0;display:flex;flex-direction: column;cursor: text;${s}}`),i.insertRule(`.input-div div{${r}}`)});D(this,"hideInput",()=>{if(this.externalElements.style.zIndex="5",this.inputParent.style.display==="flex"){this.inputParent.style.display="none";const t=this.store.pens[this.inputDiv.dataset.penId];if(!t)return;if(t.calculative.text=t.text,this.inputDiv.dataset.value=this.inputDiv.innerHTML.replace(/\<div\>/g,`
`).replace(/\<\/div\>/g,"").replace(/\<br\>/g,"").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,""),this.inputDiv.dataset.value=this.convertSpecialCharacter(this.inputDiv.dataset.value),t.onInput)t.onInput(t,this.inputDiv.dataset.value);else if(t.text!==this.inputDiv.dataset.value){const i=[deepClone(t,!0)];t.text=this.inputDiv.dataset.value,t.calculative.text=t.text,this.inputDiv.dataset.penId=void 0,t.text&&t.textAutoAdjust&&!t.parentId&&calcTextAutoWidth(t),calcTextRect(t),this.patchFlags=!0,this.pushHistory({type:EditType.Update,pens:[deepClone(t,!0)],initPens:i}),this.store.emitter.emit("change",t),this.store.emitter.emit("valueUpdate",t)}else t.text===this.inputDiv.dataset.value&&t.calculative.textLines.length==0&&calcTextRect(t);this.initTemplateCanvas([t])}this.inputDiv.dataset.penId=void 0,this.dropdown.style.display="none",this.inputDiv.dataset.isInput="false",this.inputDiv.contentEditable="false",this.render()});D(this,"setDropdownList",t=>{this.clearDropdownList();const i=this.store.pens[this.inputDiv.dataset.penId];if(!this.store.data.locked&&!["tablePlus"].includes(i.name))return;if(this.dropdown.style.display="block",!i||!i.dropdownList){this.dropdown.style.display="none";return}if(!i.dropdownList.length){const o=document.createElement("div");o.innerText="None",o.style.padding="5px 12px",o.style.color="#ddd",this.dropdown.appendChild(o);return}const s=this.inputDiv.innerHTML.replace(/\<div\>/g,`
`).replace(/\<\/div\>/g,"").replace(/\<br\>/g,"");let r=0;for(const o of i.dropdownList){const n=typeof o=="string"?o:o.text;t&&s?n.includes(s)&&this.dropdownAppendOption(n,r):this.dropdownAppendOption(n,r),++r}if(!this.dropdown.hasChildNodes()){const o=document.createElement("div");o.innerText="None",o.style.padding="5px 12px",o.style.color="#ddd",this.dropdown.appendChild(o)}});D(this,"selectDropdown",t=>{const i=t.target,s=this.store.pens[this.inputDiv.dataset.penId];if(!i||!s||!s.dropdownList)return;const r=+i.dataset.i,o=s.dropdownList[r];if(!o)return;const n=[deepClone(s,!0)];typeof o=="object"?(this.updateValue(s,{...o}),s.calculative.text=void 0,this.calcActiveRect()):s.text=o+"",this.inputDiv.innerText=s.text,this.hideInput(),this.pushHistory({type:EditType.Update,pens:[deepClone(s,!0)],initPens:n}),this.render(),this.store.emitter.emit("change",s),this.store.emitter.emit("valueUpdate",s)});D(this,"inFitBorder",t=>{let i;const s=this.store.data.width||this.store.options.width,r=this.store.data.height||this.store.options.height;let o={x:(t.x-this.store.data.origin.x)/this.store.data.scale,y:(t.y-this.store.data.origin.y)/this.store.data.scale};const n=this.canvasImage.activeFit;this.externalElements.style.cursor="default",o.y>r*n.y-10&&o.y<r*n.y+10&&(i="top",this.externalElements.style.cursor="row-resize"),o.y>r*(n.y+n.height)-10&&o.y<r*(n.y+n.height)+10&&(i="bottom",this.externalElements.style.cursor="row-resize"),o.x>s*n.x-10&&o.x<s*n.x&&(i="left",this.externalElements.style.cursor="col-resize"),o.x>s*(n.x+n.width)-10&&o.x<s*(n.x+n.width)+10&&(i="right",this.externalElements.style.cursor="col-resize"),this.canvasImage.currentFit=i});this.parent=t,this.parentElement=i,this.store=s,this.canvasTemplate=new CanvasTemplate(i,s),this.canvasTemplate.canvas.style.zIndex="1",this.canvasImageBottom=new CanvasImage(i,s,!0),this.canvasImageBottom.canvas.style.zIndex="2",i.appendChild(this.canvas),this.canvas.style.position="absolute",this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.zIndex="3",this.canvasImage=new CanvasImage(i,s),this.canvasImage.canvas.style.zIndex="4",this.magnifierCanvas=new MagnifierCanvas(this,i,s),this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.position="absolute",this.externalElements.style.left="0",this.externalElements.style.top="0",this.externalElements.style.outline="none",this.externalElements.style.background="transparent",this.externalElements.style.zIndex="5",i.style.position="relative",i.appendChild(this.externalElements),this.createInput(),this.tooltip=new Tooltip(i,s),this.tooltip.box.onmouseleave=r=>{this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1);let o=this.store.data.pens.find(n=>n.calculative.hover===!0);setHover(o,!1)},this.popconfirm=new Popconfirm(i,s),this.dialog=new Dialog(i,s),this.title=new Title(i),this.store.options.scroll&&(this.scroll=new Scroll(this)),this.store.dpiRatio=globalThis.devicePixelRatio||1,this.store.dpiRatio<1?this.store.dpiRatio=1:this.store.dpiRatio>1&&this.store.dpiRatio<1.5&&(this.store.dpiRatio=1.5),this.clientRect=this.externalElements.getBoundingClientRect(),this.listen(),window==null||window.addEventListener("resize",this.onResize),window==null||window.addEventListener("scroll",this.onScroll),window==null||window.addEventListener("message",this.onMessage)}listen(){switch(this.externalElements.addEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=t=>t.preventDefault(),this.externalElements.ondrop=this.ondrop,this.externalElements.oncontextmenu=t=>t.preventDefault(),this.store.options.interval=50,this.externalElements.ontouchstart=this.ontouchstart,this.externalElements.ontouchmove=this.ontouchmove,this.externalElements.ontouchend=this.ontouchend,this.externalElements.onmousedown=t=>{this.onMouseDown({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons})},this.externalElements.onmousemove=t=>{t.target===this.externalElements&&this.onMouseMove({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons})},this.externalElements.onmouseup=t=>{this.onMouseUp({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons,button:t.button})},this.externalElements.onmouseleave=t=>{this.store.data.pens.forEach(i=>{i.calculative.hover&&(i.calculative.hover=!1)}),this.store.hover&&(this.store.hover.calculative.hover=!1,this.store.hover=void 0),this.render(),t.toElement!==this.tooltip.box&&t.toElement!==this.tooltip.arrowUp&&t.toElement!==this.tooltip.arrowDown&&(this.tooltip.hide(),this.store.lastHover=void 0)},this.externalElements.ondblclick=this.ondblclick,this.externalElements.tabIndex=0,this.externalElements.onblur=()=>{this.mouseDown=void 0},this.externalElements.onwheel=this.onwheel,document.addEventListener("copy",this.onCopy),document.addEventListener("cut",this.onCut),document.addEventListener("paste",this.onPaste),this.store.options.keydown){case KeydownType.Document:document.addEventListener("keydown",this.onkeydown),document.addEventListener("keyup",this.onkeyup);break;case KeydownType.Canvas:this.externalElements.addEventListener("keydown",this.onkeydown),this.externalElements.addEventListener("keyup",this.onkeyup);break}}splitLine(t,i){const s=t.calculative.worldAnchors,r=s.findIndex(l=>l===i);if([-1,0,s.length-1].includes(r))return;const o=deepClone(t,!0),n=deepClone(t,!0),c=s8();n.id=c,n.calculative.canvas=this,n.calculative.active=!1,n.calculative.hover=!1;const a=deepClone(s.slice(0,r+1)),h=deepClone(s.slice(r)).map(l=>(l.penId=c,l));t.calculative.worldAnchors=a,n.calculative.worldAnchors=h,this.initLineRect(t),this.initLineRect(n),this.store.data.pens.push(n),this.store.pens[c]=n,this.pushHistory({type:EditType.Add,pens:[deepClone(n,!0)],step:2}),this.pushHistory({type:EditType.Update,initPens:[o],pens:[deepClone(t,!0)],step:2})}translateAnchor(t,i){this.movingAnchor.x+=t,this.movingAnchor.y+=i;const s=this.movingAnchor.penId;if(s){const r=this.store.pens[s],o=r.calculative.worldRect;this.movingAnchor.x<o.x?this.movingAnchor.x=o.x:this.movingAnchor.x>o.ex&&(this.movingAnchor.x=o.ex),this.movingAnchor.y<o.y?this.movingAnchor.y=o.y:this.movingAnchor.y>o.ey&&(this.movingAnchor.y=o.ey);const n=calcRelativePoint(this.movingAnchor,o),c=r.anchors.findIndex(a=>a.id===this.movingAnchor.id);r.anchors[c]=n,this.patchFlags=!0}}async fileToPen(t,i){let s="";return this.store.options.uploadFn?s=await this.store.options.uploadFn(t):this.store.options.uploadUrl?s=await uploadFile(t,this.store.options.uploadUrl,this.store.options.uploadParams,this.store.options.uploadHeaders):s=await fileToBase64(t),new Promise((r,o)=>{const n=new Image;n.onload=()=>{globalStore.htmlElements[s]=n,r({width:n.width,height:n.height,name:i?"gif":"image",image:s})},n.onerror=c=>{o(c)},n.crossOrigin="anonymous",n.src=s})}async dropPens(t,i){var a,h,l,u;this.randomIdObj={};for(const d of t)!d.parentId&&this.randomCombineId(d,t);if(Object.keys(this.randomIdObj).length!==0){const d=Object.keys(this.randomIdObj).join("|"),f=new RegExp(`(${d})`,"g");for(const g of t){if(g.type?(g.anchors[0].connectTo=this.randomIdObj[g.anchors[0].connectTo],g.anchors[g.anchors.length-1].connectTo=this.randomIdObj[g.anchors[g.anchors.length-1].connectTo]):(a=g.connectedLines)==null||a.forEach(y=>{y.lineAnchor=this.randomIdObj[y.lineAnchor],y.lineId=this.randomIdObj[y.lineId]}),(h=g.animations)!=null&&h.length){const y=JSON.stringify(g.animations).replace(f,v=>this.randomIdObj[v]);g.animations=JSON.parse(y)}if((l=g.triggers)!=null&&l.length){const y=JSON.stringify(g.triggers).replace(f,v=>this.randomIdObj[v]);g.triggers=JSON.parse(y)}if((u=g.events)!=null&&u.length){const y=JSON.stringify(g.events).replace(f,v=>this.randomIdObj[v]);g.events=JSON.parse(y)}}}for(const d of t)d.id||(d.id=s8()),!d.calculative&&(d.calculative={canvas:this}),this.store.pens[d.id]=d;let s=0,r=0,o=0;for(const d of t)d.parentId||(d.width*=this.store.data.scale,d.height*=this.store.data.scale,d.x=i.x-d.width/2+o,d.y=i.y-d.height/2+r,d.tags&&d.tags.includes("meta3d")&&(d.x=this.store.data.origin.x,d.y=this.store.data.origin.y),d.dataset&&(s%2===0?o=d.width-40*this.store.data.scale:o=0,s++,s%2===0&&(r+=d.height+10*this.store.data.scale)));const n=this.store.data.width||this.store.options.width,c=this.store.data.height||this.store.options.height;if(n&&c){let d={x:this.store.data.origin.x,y:this.store.data.origin.y,width:n*this.store.data.scale,height:c*this.store.data.scale},f=!0;for(const g of t)if(!g.parentId){let y=[{x:g.x,y:g.y},{x:g.x+g.width,y:g.y},{x:g.x,y:g.y+g.height},{x:g.x+g.width,y:g.y+g.height},{x:g.x+g.width/2,y:g.y+g.height/2}];if(g.x===d.x&&g.y===d.y&&g.width===d.width&&g.height===d.height||y.some(v=>pointInRect(v,d))){f=!1,this.store.options.strictScope&&(g.x<d.x&&(g.x=d.x),g.y<d.y&&(g.y=d.y),g.x+g.width>d.x+d.width&&(g.x=d.x+d.width-g.width),g.y+g.height>d.y+d.height&&(g.y=d.y+d.height-g.height));break}}if(f){console.info("");return}}await this.addPens(t,!0),this.active(t.filter(d=>!d.parentId)),this.render(),this.externalElements.focus()}randomCombineId(t,i,s){let r=null;t.type?t.anchors[0].connectTo||t.anchors[t.anchors.length-1].connectTo?r=[t.id,t.anchors[0].id,t.anchors[t.anchors.length-1].id]:r=[t.id]:i.length>1&&(r=[t.id]),randomId(t),i.length>1&&(r.length===1?this.randomIdObj[r[0]]=t.id:(this.randomIdObj[r[0]]=t.id,this.randomIdObj[r[1]]=t.anchors[0].id,this.randomIdObj[r[2]]=t.anchors[t.anchors.length-1].id)),t.parentId=s;const o=[];if(Array.isArray(t.children))for(const n of t.children){const c=i.find(a=>a.id===n);c&&o.push(this.randomCombineId(c,i,t.id).id)}return t.children=o,t}async addPens(t,i,s){if(this.beforeAddPens&&await this.beforeAddPens(t)!=!0)return[];const r=[];for(const o of t)this.beforeAddPen&&this.beforeAddPen(o)!=!0||(s&&(o.x=o.x*this.store.data.scale+this.store.data.origin.x,o.y=o.y*this.store.data.scale+this.store.data.origin.y,o.width=o.width*this.store.data.scale,o.height=o.height*this.store.data.scale),this.makePen(o),r.push(o));return this.render(),this.store.emitter.emit("add",r),i&&this.pushHistory({type:EditType.Add,pens:deepClone(r,!0)}),r}getInitPencilLine(t){const{data:i,options:s}=this.store,r=i.scale,o=i.lineWidth||1;return{id:t.penId,name:"line",x:t.x,y:t.y,type:PenType.Line,calculative:{canvas:this,pencil:!0,active:!0,worldAnchors:[t],lineWidth:o*r},fromArrow:i.fromArrow||s.fromArrow,toArrow:i.toArrow||s.toArrow,lineWidth:o}}createDrawingLine(t){this.inactive();const{data:i,options:s}=this.store,r=i.scale,o=i.lineWidth||1;return t.penId=s8(),{id:t.penId,name:"line",lineName:this.drawingLineName,x:t.x,y:t.y,type:PenType.Line,calculative:{canvas:this,active:!0,worldAnchors:[t],lineWidth:o*r},fromArrow:i.fromArrow||s.fromArrow,toArrow:i.toArrow||s.toArrow,lineWidth:o}}addRuleLine(t){const{x:i,y:s,scale:r,origin:o}=this.store.data,n=t.x+i,c=t.y+s;let a=t.x,h=t.y,l=0,u=0,d=0,f=0;if(n<=c&&n<20)a=-i,l=this.width,d=1,t.ctrlKey||(h=Math.round((h-o.y)/(r*10))*(r*10)+o.y);else if(c<n&&c<20)h=-s,u=this.height,f=1,t.ctrlKey||(a=Math.round((a-o.x)/(r*10))*(r*10)+o.x);else return;this.addPen({isRuleLine:!0,type:PenType.Line,name:"line",lineName:"line",x:a,y:h,width:l,height:u,color:this.store.options.ruleLineColor,anchors:[{x:0,y:0},{x:d,y:f}]})}clearRuleLines(){this.delete(this.ruleLines)}get ruleLines(){return this.store.data.pens.filter(t=>t.isRuleLine)}alignPenToGrid(t){var s;if(this.store.options.autoAlignGrid&&this.store.data.grid&&!t.type){const r=this.store.data.gridSize||this.store.options.gridSize,{origin:o,scale:n}=this.store.data,{x:c,y:a}=t,h={x:c,y:a},l=this.getPenRect(t),u=parseInt((l.x/r).toFixed()),d=parseInt((l.y/r).toFixed()),f=u*r,g=d*r;h.x=o.x+f*n,h.y=o.y+g*n,Object.assign(t,h),(s=t.onMove)==null||s.call(t,t),this.updatePenRect(t),this.calcActiveRect(),this.getSizeCPs()}}movedActivePens(t){let i=this.getAllFollowersByPens(this.store.active,!1);const s=deepClone(i,!0),r=this.store.data.gridSize||this.store.options.gridSize,{origin:o,scale:n}=this.store.data,c=this.store.options.autoAlignGrid&&(this.store.data.grid||this.store.options.grid);if(i.forEach(d=>{var b;const f=this.movingPens.findIndex(x=>x.id===d.id+movingSuffix);if(f<0)return;const{x:g,y}=this.movingPens[f],v={x:g,y};if(c&&!this.movingPens[f].type){const x=this.getPenRect(this.movingPens[f]),m=parseInt((x.x/r).toFixed()),T=parseInt((x.y/r).toFixed()),I=m*r,P=T*r;v.x=o.x+I*n,v.y=o.y+P*n}Object.assign(d,v),(b=d.onMove)==null||b.call(d,d),this.updatePenRect(d),this.updateLines(d),this.store.emitter.emit("updateLines",d),this.patchFlagsLines.forEach(x=>{x.type&&this.initLineRect(x)}),this.patchFlagsLines.clear(),d.calculative.x=d.x,d.calculative.y=d.y,d.calculative.initRect&&(d.calculative.initRect.x=d.calculative.x,d.calculative.initRect.y=d.calculative.y,d.calculative.initRect.ex=d.calculative.x+d.calculative.width,d.calculative.initRect.ey=d.calculative.y+d.calculative.height),calcChildrenInitRect(d),d.parentId&&this.parent.updateRectbyChild(d.calculative.worldRect,d,this.store.pens[d.parentId])}),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),!this.dock)return;const{xDock:a,yDock:h}=this.dock;let l;a&&(l=this.store.pens[a.penId]),!l&&h&&(l=this.store.pens[h.penId]);const u=deepClone(this.store.active,!0);if(t&&this.store.active.length===1&&(l==null?void 0:l.type)===1&&(a!=null&&a.anchorId||h!=null&&h.anchorId)){const d=getFromAnchor(l),f=getToAnchor(l);if(a!=null&&a.anchorId){const g=this.store.pens[this.store.active[0].id+movingSuffix].calculative.worldAnchors.find(y=>y.id===a.anchorId);g.x===d.x&&g.y===d.y?(s.push(deepClone(l,!0)),connectLine(this.store.active[0],g,l,d),u.push(deepClone(l,!0))):g.x===f.x&&g.y===f.y&&(s.push(deepClone(l,!0)),connectLine(this.store.active[0],g,l,f),u.push(deepClone(l,!0)))}else if(h!=null&&h.anchorId){const g=this.store.pens[this.store.active[0].id+movingSuffix].calculative.worldAnchors.find(y=>y.id===h.anchorId);g.x===d.x&&g.y===d.y?(s.push(deepClone(l,!0)),connectLine(this.store.active[0],g,l,d),u.push(deepClone(l,!0))):g.x===f.x&&g.y===f.y&&(s.push(deepClone(l,!0)),connectLine(this.store.active[0],g,l,f),u.push(deepClone(l,!0)))}}c&&(this.calcActiveRect(),this.getSizeCPs()),this.pushHistory({type:EditType.Update,pens:u,initPens:s}),this.store.emitter.emit("translatePens",u)}copyMovedPens(){this.copy(this.store.active.map((t,i)=>{const{x:s,y:r}=this.movingPens[i];return this.updateLines(t),{...t,x:s,y:r}})),this.pasteOffset=!1,this.paste()}initImageCanvas(t){t.some(i=>this.hasImage(i,!1))&&this.canvasImage.init(),t.some(i=>this.hasImage(i,!0))&&this.canvasImageBottom.init()}initTemplateCanvas(t){t.some(i=>i.canvasLayer===CanvasLayer.CanvasTemplate)&&this.canvasTemplate.init()}hasImage(t,i){var s;return t.image&&t.name!=="gif"?i?t.canvasLayer===CanvasLayer.CanvasImageBottom:t.canvasLayer===CanvasLayer.CanvasImage:(s=t.children)==null?void 0:s.some(r=>{const o=this.store.pens[r];return o&&this.hasImage(o,i)})}inactive(t){this.store.active.length&&(this.initTemplateCanvas(this.store.active),this.store.active.forEach(i=>{i.calculative.active=void 0,i.calculative.activeAnchor=void 0,i.calculative.hover=!1,setChildrenActive(i,!1)}),!t&&this.store.emitter.emit("inactive",this.store.active),this.store.active=[],this.activeRect=void 0,this.sizeCPs=void 0,this.store.activeAnchor=void 0,this.patchFlags=!0)}active(t,i=!0){if(this.store.active){i&&this.store.emitter.emit("inactive",this.store.active);for(const s of this.store.active)s.calculative.active=void 0,s.calculative.hover=!1,setChildrenActive(s,!1)}this.store.active=[],t.forEach(s=>{s.calculative.active=!0,setChildrenActive(s)}),this.store.active.push(...t),this.activeRect=void 0,this.calcActiveRect(),this.initTemplateCanvas(t),this.patchFlags=!0,i&&this.store.emitter.emit("active",this.store.active)}getSizeCPs(){this.sizeCPs=rectToPoints(this.activeRect);const t=[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],{x:i,y:s,width:r,height:o,rotate:n,center:c}=this.activeRect;t.forEach(a=>{const h={x:a.x*r+i,y:a.y*o+s};rotatePoint(h,n,c),this.sizeCPs.push(h)})}getSpecialAngle(t,i){let s=0;t.x-i.x!==0?(s=Math.atan((i.y-t.y)/(t.x-i.x))*180/Math.PI,t.x<i.x&&(s>0?s-=180:s+=180)):i.y>t.y?s=90:i.y<t.y&&(s=-90),s=Math.round(s/15)*15;let r=Math.sqrt((i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y));t.x=i.x+Math.cos(s/180*Math.PI)*r,t.y=i.y-Math.sin(s/180*Math.PI)*r}clearHover(){this.hoverType=HoverType.None,this.store.hover=null,this.store.hoverAnchor=null}inAnchor(t,i,s){var r;if(this.store.hoverAnchor=void 0,this.movingAnchor=void 0,!s||s.locked>LockState.DisableEdit||!(i.type&&i.calculative.active)&&this.store.options.disableAnchor||i.disableAnchor)return HoverType.None;if((this.mouseDown||this.drawingLine)&&i.name==="line"&&s.connectTo){const o=this.findOne(s.connectTo);if(o!=null&&o.calculative&&!(o!=null&&o.calculative.active)){i=o;const n=o.calculative.worldAnchors.find(c=>c.id===s.anchorId);n&&(s=n)}}if(s.twoWay===TwoWay.Disable&&i.name!=="line")return HoverType.None;if(i.name==="line"&&s.connectTo){let o=(r=this.findOne(s.connectTo))==null?void 0:r.anchors.find(n=>n.id===s.anchorId);if(o&&o.twoWay)return HoverType.None}if(this.drawingLine){if(s.twoWay===TwoWay.Out)return HoverType.None}else if(!(this.mouseDown&&this.hoverType===HoverType.LineAnchor)){if(s.twoWay===TwoWay.In)return HoverType.None}if(hitPoint(t,s,this.pointSize,s.penId?this.store.pens[s.penId]:void 0))return s!==this.store.hoverAnchor&&(this.patchFlags=!0),this.store.hoverAnchor=s,this.store.hover=i,i.type?s.connectTo&&!i.calculative.active&&(this.store.hover=this.store.pens[s.connectTo],this.store.hover)?(this.store.hoverAnchor=this.store.hover.calculative.worldAnchors.find(o=>o.id===s.anchorId),this.store.hoverAnchor?(this.externalElements.style.cursor="crosshair",HoverType.NodeAnchor):HoverType.None):(this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="pointer",HoverType.LineAnchor):(this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="crosshair",HoverType.NodeAnchor);if(!this.mouseDown&&i.type){if(i.calculative.active&&s.prev&&hitPoint(t,s.prev,this.pointSize))return this.store.hoverAnchor=s,this.store.hover=i,this.externalElements.style.cursor="pointer",HoverType.LineAnchorPrev;if(i.calculative.active&&s.next&&hitPoint(t,s.next,this.pointSize))return this.store.hoverAnchor=s,this.store.hover=i,this.externalElements.style.cursor="pointer",HoverType.LineAnchorNext}return HoverType.None}resize(t,i){t=t||this.parentElement.clientWidth,i=i||this.parentElement.clientHeight,this.width=t,this.height=i,this.canvasRect={x:0,y:0,width:t,height:i},calcRightBottom(this.canvasRect),this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",this.externalElements.style.width=t+"px",this.externalElements.style.height=i+"px",this.canvasTemplate.resize(t,i),this.canvasImage.resize(t,i),this.canvasImageBottom.resize(t,i),this.magnifierCanvas.resize(t,i),t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.offscreen.width=t,this.offscreen.height=i,this.clientRect=this.externalElements.getBoundingClientRect(),this.canvas.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle";for(const s of this.store.data.pens)s.isRuleLine&&(s.width?s.height||(s.width=this.width):s.height=this.height,this.updatePenRect(s)),calcInView(s);this.render()}clearCanvas(){this.activeRect=void 0,this.sizeCPs=void 0,this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.offscreen.width,this.offscreen.height),this.store.data.template||this.canvasTemplate.clear(),this.canvasImage.clear(),this.canvasImageBottom.clear()}async addPen(t,i,s,r){if(!(this.beforeAddPens&&await this.beforeAddPens([t])!=!0)&&!(this.beforeAddPen&&this.beforeAddPen(t)!=!0))return r&&(t.x=t.x*this.store.data.scale+this.store.data.origin.x,t.y=t.y*this.store.data.scale+this.store.data.origin.y,t.width=t.width*this.store.data.scale,t.height=t.height*this.store.data.scale),this.makePen(t),this.active([t]),this.render(),s&&this.store.emitter.emit("add",[t]),i&&this.pushHistory({type:EditType.Add,pens:[t]}),t}pushHistory(t){var r;if(this.store.data.locked)return;const{origin:i,scale:s}=this.store.data;t.origin=deepClone(i),t.scale=s,t.type!==EditType.Update&&t.pens&&t.pens.forEach(o=>{o.calculative&&(o.calculative.layer=this.store.data.pens.findIndex(n=>n.id===o.id))}),this.store.historyIndex<this.store.histories.length-1&&this.store.histories.splice(this.store.historyIndex+1,this.store.histories.length-this.store.historyIndex-1),(r=t.pens)==null||r.forEach(o=>{let n;if(t.initPens)for(const c of t.initPens)c.id===o.id&&(n=c);if(n)for(const c in o)n[c]==null&&(n[c]=void 0)}),this.store.histories.push(t),this.store.historyIndex=this.store.histories.length-1,this.store.emitter.emit("update",{previous:t.initPens,current:t.pens})}undo(){if(this.store.data.locked||this.store.historyIndex==null||this.store.historyIndex<0)return;const t=this.store.histories[this.store.historyIndex--];this.doEditAction(t,!0);let i=t.step;for(;i>1;){const s=this.store.histories[this.store.historyIndex--];this.doEditAction(s,!0),i--}(t.type==EditType.Add||t.type==EditType.Delete||t.type==EditType.Update)&&this.activeHistory()}redo(){if(this.store.data.locked||this.store.historyIndex==null||this.store.historyIndex>this.store.histories.length-2)return;const t=this.store.histories[++this.store.historyIndex];this.doEditAction(t,!1);let i=t.step;for(;i>1;){const s=this.store.histories[++this.store.historyIndex];this.doEditAction(s,!1),i--}(t.type==EditType.Add||t.type==EditType.Delete||t.type==EditType.Update)&&this.activeHistory()}activeHistory(){let t=this.store.histories[this.store.historyIndex+1];const i=[];if(t&&t.type===EditType.Update){t.pens.forEach(r=>{i.push(this.store.pens[r.id])}),this.active(i);return}let s=this.store.histories[this.store.historyIndex];s&&(s.type===EditType.Add||s.type===EditType.Delete)&&(s.pens.forEach(r=>{i.push(this.store.pens[r.id])}),this.active(i))}doEditAction(t,i){switch(this.inactive(),this.store.hoverAnchor=void 0,this.store.hover=void 0,t.type){case EditType.Add:t.pens.forEach(o=>{var a;const n=deepClone(o,!0),c=this.store.data.pens.findIndex(h=>h.id===n.id);c>-1&&((a=n.onDestroy)==null||a.call(n,this.store.pens[n.id]),this.store.data.pens.splice(c,1),this.store.pens[n.id]=void 0,n.calculative||(n.calculative={}),n.calculative.canvas=this,this.store.animates.delete(n),this.store.animateMap.delete(n))}),t.type=EditType.Delete;break;case EditType.Update:const s=i?t.initPens:t.pens,r=i?t.pens:t.initPens;s.forEach(o=>{const n=deepClone(o,!0),c=this.store.data.pens.findIndex(a=>a.id===n.id);if(c>-1){if(n.calculative=this.store.data.pens[c].calculative,this.store.data.pens[c].type&&this.store.data.pens[c].lastConnected){for(let h in this.store.data.pens[c].lastConnected)if(this.store.pens[h]){let l=deepClone(this.store.data.pens[c].lastConnected[h]);this.store.pens[h].connectedLines=l,n.anchors.forEach(u=>{l.forEach(d=>{u.id===d.lineAnchor&&(u.connectTo=h)})})}}this.store.data.pens[c]=n,this.store.pens[n.id]=n;for(const h in n)(typeof n[h]!="object"||h==="lineDash")&&(n.calculative[h]=n[h]);n.calculative.image=void 0;const a=this.getPenRect(n,t.origin,t.scale);if(this.setPenRect(n,a,!1),this.updateLines(n,!0),n.calculative.canvas.parent.isCombine(n)){let h=r.find(l=>l.id===n.id);inheritanceProps.forEach(l=>{n[l]!==h[l]&&this.parent.setValue({id:n.id,[l]:n[l]},{render:!0,doEvent:!1})})}}});break;case EditType.Delete:t.pens.reverse().forEach(o=>{var c,a;const n=deepClone(o,!0);if(n.calculative||(n.calculative={}),this.store.data.pens.splice(((c=n.calculative)==null?void 0:c.layer)!==-1?(a=n.calculative)==null?void 0:a.layer:this.store.data.pens.length,0,n),this.store.pens[n.id]=n,n.type&&n.lastConnected)for(let h in n.lastConnected)this.store.pens[h]&&(this.store.pens[h].connectedLines=n.lastConnected[h]);n.calculative.canvas=this}),t.pens.reverse().forEach(o=>{const n=this.store.pens[o.id],c=this.getPenRect(n,t.origin,t.scale);this.setPenRect(n,c,!1),n.calculative.image=void 0,n.calculative.backgroundImage=void 0,n.calculative.strokeImage=void 0,this.loadImage(n)}),t.type=EditType.Add;break;case EditType.Replace:{const o=i?t.initPens:t.pens;(i?t.pens:t.initPens).forEach(c=>{var l;const a=deepClone(c,!0);if(this.store.data.pens.findIndex(u=>u.id===a.id)>-1){(l=a.onDestroy)==null||l.call(a,this.store.data.pens.find(d=>d.id===a.id));const u=this.store.data.pens.findIndex(d=>d.id===a.id);this.store.data.pens.splice(u,1),this.store.pens[a.id]=void 0,a.calculative||(a.calculative={}),a.calculative.canvas=this,this.store.animates.delete(a),this.store.animateMap.delete(a)}}),o.reverse().forEach(c=>{var h,l;const a=deepClone(c,!0);if(a.calculative||(a.calculative={}),this.store.data.pens.splice(((h=a.calculative)==null?void 0:h.layer)!==-1?(l=a.calculative)==null?void 0:l.layer:this.store.data.pens.length,0,a),this.store.pens[a.id]=a,a.type&&a.lastConnected)for(let u in a.lastConnected)this.store.pens[u]&&(this.store.pens[u].connectedLines=a.lastConnected[u]);a.calculative.canvas=this}),o.reverse().forEach(c=>{const a=this.store.data.pens.find(l=>l.id===c.id),h=this.getPenRect(a,t.origin,t.scale);this.setPenRect(a,h,!1),a.calculative.image=void 0,a.calculative.backgroundImage=void 0,a.calculative.strokeImage=void 0,this.loadImage(a)}),t.type=EditType.Replace;break}}if(t.type===EditType.Update){let s=[...t.pens,...t.initPens];this.initImageCanvas(s),this.initTemplateCanvas(s)}else this.initImageCanvas(t.pens),this.initTemplateCanvas(t.pens);this.parent.onSizeUpdate(),this.render(),this.store.emitter.emit(i?"undo":"redo",t)}makePen(t){var r;if(t.id||(t.id=s8()),Math.abs(this.store.lastScale-this.store.data.scale)<1e-4&&this.store.sameTemplate&&this.store.templatePens[t.id]&&t.canvasLayer===CanvasLayer.CanvasTemplate){t=this.store.templatePens[t.id],this.store.data.pens.push(t),this.updatePenRect(t);return}if(t.copyIndex?(this.store.data.pens.splice(t.copyIndex+1,0,t),delete t.copyIndex):this.store.data.pens.push(t),this.store.pens[t.id]=t,t.path){!t.pathId&&(t.pathId=s8());const o=this.store.data.paths;!o[t.pathId]&&(o[t.pathId]=t.path),t.path=void 0}t.lineWidth==null&&(t.lineWidth=1);const{fontSize:i,lineHeight:s}=this.store.options;t.fontSize?t.fontSize<0&&(t.fontSize=0):t.fontSize=i>=0?i:12,t.lineHeight||(t.lineHeight=s),t.image&&t.name!=="gif"&&t.canvasLayer===void 0&&(t.isBottom?t.canvasLayer=CanvasLayer.CanvasImageBottom:t.canvasLayer=CanvasLayer.CanvasImage,delete t.isBottom),t.template&&(t.canvasLayer=CanvasLayer.CanvasTemplate),t.calculative={canvas:this,singleton:(r=t.calculative)==null?void 0:r.singleton},(t.video||t.audio)&&(t.calculative.onended=o=>{this.nextAnimate(o)});for(const o in t)(typeof t[o]!="object"||o==="lineDash")&&(t.calculative[o]=t[o]);if(t.calculative.image=void 0,t.calculative.backgroundImage=void 0,t.calculative.strokeImage=void 0,!t.anchors&&globalStore.anchors[t.name]&&(t.anchors||(t.anchors=[]),globalStore.anchors[t.name](t)),!t.anchors){const o=deepClone(this.store.options.defaultAnchors);o.forEach((n,c)=>{n.id=`${c}`,n.penId=t.id}),t.anchors=o}this.updatePenRect(t),!t.anchors&&t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(o=>calcRelativePoint(o,t.calculative.worldRect))),!t.rotate&&(t.rotate=0),this.loadImage(t),this.parent.penNetwork(t)}drawline(t){var i;this.drawingLine&&((i=this[this.drawingLineName])==null||i.call(this,this.store,this.drawingLine,t),this.store.path2dMap.set(this.drawingLine,globalStore.path2dDraws.line(this.drawingLine)),this.patchFlags=!0)}initLineRect(t){var o;if(!t)return;if(!((o=t.calculative.worldAnchors)!=null&&o.length)){this._del([t]);return}if(!isFinite(t.x)||!isFinite(t.x)||t.x==null||t.y==null)return;const i=getLineRect(t);t.parentId||Object.assign(t,i);const{fontSize:s,lineHeight:r}=this.store.options;t.fontSize||(t.fontSize=s>=0?s:12,t.calculative.fontSize=t.fontSize*this.store.data.scale),t.lineHeight||(t.lineHeight=r,t.calculative.lineHeight=t.lineHeight),calcCenter(i),t.calculative.worldRect=i,calcPadding(t,i),calcTextRect(t),calcInView(t),t.calculative&&(t.calculative.gradientAnimatePath=void 0),this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)),t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(n=>calcRelativePoint(n,t.calculative.worldRect)))}drawingPencil(){lockedError(this.store),this.pencil=!0,this.externalElements.style.cursor="crosshair"}stopPencil(){this.pencil=!1,this.pencilLine=void 0,this.externalElements.style.cursor="default"}async finishDrawline(t){if(!this.drawingLine)return;const i=getFromAnchor(this.drawingLine);let s=getToAnchor(this.drawingLine);if(s.isTemp&&(this.drawingLine.calculative.worldAnchors.pop(),s=getToAnchor(this.drawingLine)),!t&&(!s.connectTo&&this.drawingLine.calculative.worldAnchors.pop(),getFromAnchor(this.drawingLine)===this.drawingLine.calculative.activeAnchor)){this.drawingLine=void 0,this.render();return}if(!i.connectTo||!s.connectTo){if(this.store.options.disableEmptyLine){i.connectTo&&(this.store.pens[i.connectTo].connectedLines=this.store.pens[i.connectTo].connectedLines.filter(n=>n.lineId!==this.drawingLine.id)),this.drawingLine=void 0,this.render();return}}else if(this.store.options.disableRepeatLine&&this.store.data.pens.find(c=>{if(c.type){const a=getFromAnchor(c),h=getToAnchor(c);return samePoint(a,i)&&samePoint(h,s)}})){this.drawingLine=void 0,this.render();return}const r=getLineRect(this.drawingLine);Object.assign(this.drawingLine,r),this.drawingLine.calculative.worldRect=r,this.drawingLine.calculative.activeAnchor=getToAnchor(this.drawingLine),this.store.activeAnchor=this.drawingLine.calculative.activeAnchor,(!this.beforeAddPens||await this.beforeAddPens([this.drawingLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.drawingLine))&&(this.initLineRect(this.drawingLine),this.store.data.pens.push(this.drawingLine),this.store.pens[this.drawingLine.id]=this.drawingLine,this.store.emitter.emit("add",[this.drawingLine]),this.active([this.drawingLine]),this.pushHistory({type:EditType.Add,pens:deepClone([this.drawingLine],!0)})),this.store.path2dMap.set(this.drawingLine,globalStore.path2dDraws[this.drawingLine.name](this.drawingLine)),this.drawingLine=void 0,this.drawingLineName=void 0,this.render()}async finishPencil(){if(this.pencilLine){const t=simplify(this.pencilLine.calculative.worldAnchors,10,0,this.pencilLine.calculative.worldAnchors.length-1);let i=getFromAnchor(this.pencilLine);t.unshift({id:i.id,penId:i.penId,x:i.x,y:i.y}),i=getToAnchor(this.pencilLine),t.push({id:i.id,penId:i.penId,x:i.x,y:i.y}),this.pencilLine.calculative.worldAnchors=smoothLine(t),this.pencilLine.calculative.worldAnchors.length>1&&(this.pencilLine.calculative.pencil=!1,this.store.path2dMap.set(this.pencilLine,globalStore.path2dDraws[this.pencilLine.name](this.pencilLine)),(!this.beforeAddPens||await this.beforeAddPens([this.pencilLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.pencilLine))&&(this.initLineRect(this.pencilLine),this.store.data.pens.push(this.pencilLine),this.store.pens[this.pencilLine.id]=this.pencilLine,this.store.emitter.emit("add",[this.pencilLine]),this.active([this.pencilLine]),this.pushHistory({type:EditType.Add,pens:deepClone([this.pencilLine],!0)}))),this.pencilLine=void 0,this.render()}}firefoxLoadSvg(t){const i=new Image,s=new XMLHttpRequest;s.open("GET",t.image,!0),s.onload=()=>{const n=new DOMParser().parseFromString(s.responseText,"text/xml").getElementsByTagName("svg")[0],{width:c,height:a}=t.calculative.worldRect;n.setAttribute("width",`${c}px`),n.setAttribute("height",`${a}px`);const l="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(new XMLSerializer().serializeToString(n))));i.src=l,i.onload=()=>{t.calculative.img=i,t.calculative.imgNaturalWidth=i.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=i.naturalHeight||t.iconHeight,globalStore.htmlElements[t.image]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}},s.send()}loadImage(t){if(t.image!==t.calculative.image||!t.calculative.img){if(t.calculative.img=void 0,t.image)if(globalStore.htmlElements[t.image]){const i=globalStore.htmlElements[t.image];t.calculative.img=i,t.calculative.imgNaturalWidth=i.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=i.naturalHeight||t.iconHeight,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}else if(navigator.userAgent.includes("Firefox")&&t.image.endsWith(".svg"))this.firefoxLoadSvg(t);else{const i=new Image;i.crossOrigin=t.crossOrigin==="undefined"?void 0:t.crossOrigin||"anonymous",i.src=t.image,this.store.options.cdn&&!(t.image.startsWith("http")||t.image.startsWith("//")||t.image.startsWith("data:image"))&&(i.src=this.store.options.cdn+t.image),i.onload=()=>{t.calculative.img=i,t.calculative.imgNaturalWidth=i.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=i.naturalHeight||t.iconHeight,globalStore.htmlElements[t.image]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}}t.calculative.image=t.image}if(t.backgroundImage!==t.calculative.backgroundImage){if(t.calculative.backgroundImg=void 0,t.backgroundImage)if(globalStore.htmlElements[t.backgroundImage]){const i=globalStore.htmlElements[t.backgroundImage];t.calculative.backgroundImg=i}else{const i=new Image;i.crossOrigin="anonymous",i.src=t.backgroundImage,this.store.options.cdn&&!(t.backgroundImage.startsWith("http")||t.backgroundImage.startsWith("//")||t.backgroundImage.startsWith("data:image"))&&(i.src=this.store.options.cdn+t.backgroundImage),i.onload=()=>{t.calculative.backgroundImg=i,globalStore.htmlElements[t.backgroundImage]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}}t.calculative.backgroundImage=t.backgroundImage}if(t.strokeImage!==t.calculative.strokeImage){if(t.calculative.strokeImg=void 0,t.strokeImage)if(globalStore.htmlElements[t.strokeImage]){const i=globalStore.htmlElements[t.strokeImage];t.calculative.strokeImg=i}else{const i=new Image;i.crossOrigin="anonymous",i.src=t.strokeImage,this.store.options.cdn&&!(t.strokeImage.startsWith("http")||t.strokeImage.startsWith("//")||t.strokeImage.startsWith("data:image"))&&(i.src=this.store.options.cdn+t.strokeImage),i.onload=()=>{t.calculative.strokeImg=i,globalStore.htmlElements[t.strokeImage]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&t.name!=="gif"&&this.templateImageLoaded()}}t.calculative.strokeImage=t.strokeImage}}imageLoaded(){this.imageTimer&&clearTimeout(this.imageTimer),this.imageTimer=setTimeout(()=>{this.canvasImage.init(),this.canvasImageBottom.init(),this.render()},100)}templateImageLoaded(){this.templateImageTimer&&clearTimeout(this.templateImageTimer),this.templateImageTimer=setTimeout(()=>{this.canvasTemplate.init(),this.render()},100)}setCalculativeByScale(t){const i=this.store.data.scale;t.calculative.lineWidth=t.lineWidth*i,t.calculative.fontSize=t.fontSize*i,t.fontSize<1&&t.fontSize>0&&(t.calculative.fontSize=t.fontSize*t.calculative.worldRect.height),t.calculative.iconSize=t.iconSize*i,t.calculative.iconWidth=t.iconWidth*i,t.calculative.iconHeight=t.iconHeight*i,t.calculative.iconLeft=t.iconLeft<1&&t.iconLeft>-1?t.iconLeft:t.iconLeft*i,t.calculative.iconTop=t.iconTop<1&&t.iconTop>-1?t.iconTop:t.iconTop*i,t.calculative.textWidth=t.textWidth<1&&t.textWidth>-1?t.textWidth:t.textWidth*i,t.calculative.textHeight=t.textHeight<1&&t.textHeight>-1?t.textHeight:t.textHeight*i,t.calculative.textLeft=t.textLeft<1&&t.textLeft>-1?t.textLeft*t.calculative.worldRect.width:t.textLeft*i,t.calculative.textTop=t.textTop<1&&t.textTop>-1?t.textTop*t.calculative.worldRect.height:t.textTop*i,t.type===PenType.Line&&t.borderWidth&&(t.calculative.borderWidth=t.borderWidth*i)}updatePenRect(t,{worldRectIsReady:i,playingAnimate:s}={}){i?calcPenRect(t):calcWorldRects(t),s||this.setCalculativeByScale(t),calcWorldAnchors(t),calcIconRect(this.store.pens,t),calcTextRect(t),calcInView(t),globalStore.path2dDraws[t.name]&&this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)),t.calculative.patchFlags=!0,this.patchFlags=!0,t.children&&t.children.forEach(r=>{const o=this.store.pens[r];o&&this.updatePenRect(o,{worldRectIsReady:!1})}),t.type&&this.initLineRect(t),t.calculative.gradientTimer&&clearTimeout(t.calculative.gradientTimer),t.calculative.gradientTimer=setTimeout(()=>{t.calculative.lineGradient&&(t.calculative.lineGradient=null),t.calculative.gradient&&(t.calculative.gradient=null),t.calculative.radialGradient&&(t.calculative.radialGradient=null),this.patchFlags=!0,t.calculative.gradientTimer=void 0},50)}initGlobalStyle(){const t={},i={},s={};themeKeys.forEach(o=>{var n;if(this.store.options[o]!==void 0&&(t[o]=this.store.options[o]),this.store.data[o]!==void 0&&(i[o]=this.store.data[o]),this.store.data.theme){const c=(n=this.store.theme[this.store.data.theme])==null?void 0:n[o];c!==void 0&&(s[o]=c)}}),this.store.styles={};const r=le5leTheme.getThemeObj(this.store.data.theme);Object.assign(this.store.styles,t,i,s,r)}translate(t=0,i=0){if(this.store.data.x+=t*this.store.data.scale,this.store.data.y+=i*this.store.data.scale,this.store.data.x=Math.round(this.store.data.x),this.store.data.y=Math.round(this.store.data.y),this.store.options.padding){let s=formatPadding(this.store.options.padding);const r=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;this.width<(r+s[1]+s[3])*this.store.data.scale&&(this.store.data.x+this.store.data.origin.x>s[3]*this.store.data.scale&&(this.store.data.x=s[3]*this.store.data.scale-this.store.data.origin.x),this.store.data.x+this.store.data.origin.x+r*this.store.data.scale<this.width-s[1]*this.store.data.scale&&(this.store.data.x=this.width-s[1]*this.store.data.scale-(this.store.data.origin.x+r*this.store.data.scale))),this.height<(o+s[0]+s[2])*this.store.data.scale&&(this.store.data.y+this.store.data.origin.y>s[0]*this.store.data.scale&&(this.store.data.y=s[0]*this.store.data.scale-this.store.data.origin.y),this.store.data.y+this.store.data.origin.y+o*this.store.data.scale<this.height-s[2]*this.store.data.scale&&(this.store.data.y=this.height-s[2]*this.store.data.scale-(this.store.data.origin.y+o*this.store.data.scale)))}this.store.data.asyncTranslate?(clearTimeout(this.transTimeout),this.transTimeout=setTimeout(()=>{this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()},300)):(this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()),this.store.emitter.emit("translate",{x:this.store.data.x,y:this.store.data.y}),this.tooltip.translate(t,i),this.scroll&&this.scroll.isShow&&this.scroll.translate(t,i),this.onMovePens()}onMovePens(){var i;const t=this.parent.map;t&&t.isShow&&t.setView();for(const s of this.store.data.pens)calcInView(s),(i=s.onMove)==null||i.call(s,s),s.isRuleLine&&(s.width?s.height||(s.x=-this.store.data.x):s.y=-this.store.data.y,this.updatePenRect(s))}scale(t,i={x:0,y:0}){var c;const s=this.store.data.minScale||this.store.options.minScale,r=this.store.data.maxScale||this.store.options.maxScale;if(!(t>=s&&t<=r))return;this.calibrateMouse(i);const o=t/this.store.data.scale;this.store.data.scale=t,this.store.data.center=i,(c=this.store.clipboard)!=null&&c.pos&&scalePoint(this.store.clipboard.pos,o,i),scalePoint(this.store.data.origin,o,i),this.store.data.pens.forEach(a=>{if(!a.parentId){if(scalePen(a,o,i),a.onScale&&a.onScale(a),a.isRuleLine){const h=1/o,l=a.calculative.worldRect.center;a.width&&a.height||scalePen(a,h,l)}this.updatePenRect(a,{worldRectIsReady:!0}),this.execPenResize(a)}}),this.onMovePens(),this.calcActiveRect(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init();const n=this.parent.map;n&&n.isShow&&n.setView(),this.render(),this.store.emitter.emit("scale",this.store.data.scale)}templateScale(t,i={x:0,y:0}){const{minScale:s,maxScale:r}=this.store.options;if(!(t>=s&&t<=r))return;const o=t/this.store.data.scale;this.store.data.scale=t,this.store.data.center={x:0,y:0},this.store.data.origin={x:0,y:0},this.store.data.pens.forEach(n=>{if(!n.parentId){if(scalePen(n,o,i),n.onScale&&n.onScale(n),n.isRuleLine){const c=o>1?1:1/o/o,a=n.calculative.worldRect.center;n.width&&n.height||scalePen(n,c,a)}this.execPenResize(n)}}),this.calcActiveRect()}rotatePens(t){this.initPens||(this.initPens=deepClone(this.getAllByPens(this.store.active))),this.activeRect.rotate=calcRotate(t,this.activeRect.center),this.activeRect.rotate%90<10&&(this.activeRect.rotate-=this.activeRect.rotate%90),this.activeRect.rotate%90>80&&(this.activeRect.rotate+=90-this.activeRect.rotate%90),this.store.active.length===1&&(this.lastRotate=this.store.active[0].rotate||0);const i=this.activeRect.rotate-this.lastRotate;for(const s of this.store.active){if(s.parentId)return;this.rotatePen(s,i,this.activeRect),s.onRotate&&s.onRotate(s),this.updateLines(s)}this.lastRotate=this.activeRect.rotate,this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("rotatePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.getAllByPens(this.store.active)),initPens:this.initPens}),this.initPens=void 0},200)}resizePens(t){if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),!this.initActiveRect){this.initActiveRect=deepClone(this.activeRect);return}const i={x:this.mouseDown.x,y:this.mouseDown.y},s={x:t.x,y:t.y};let r=s.x-i.x,o=s.y-i.y;const n=deepClone(this.initActiveRect);if(resizeRect(n,r,o,this.resizeIndex),calcCenter(n),!this.store.options.disableDock){this.clearDock();const f=this.customResizeDock||calcResizeDock;this.dock=f(this.store,n,this.store.active,this.resizeIndex);const{xDock:g,yDock:y}=this.dock;if(g){r+=g.step;const v=this.store.pens[g.penId];v.calculative.isDock=!0}if(y){o+=y.step;const v=this.store.pens[y.penId];v.calculative.isDock=!0}}const c=this.activeRect.width,a=this.activeRect.height;let h=r-this.lastOffsetX,l=o-this.lastOffsetY;if(this.lastOffsetX=r,this.lastOffsetY=o,(t.ctrlKey||this.initPens.length===1&&this.initPens[0].ratio)&&(l=([1,3].includes(this.resizeIndex)?-1:1)*(h*a)/c),this.activeRect.ratio=this.initPens[0].ratio,resizeRect(this.activeRect,h,l,this.resizeIndex),this.store.options.strictScope){const f=this.store.data.width||this.store.options.width,g=this.store.data.height||this.store.options.height;if(f&&g){let y={x:this.store.data.origin.x,y:this.store.data.origin.y,width:f*this.store.data.scale,height:g*this.store.data.scale};this.activeRect.x<y.x&&(this.activeRect.width=this.activeRect.width-(y.x-this.activeRect.x),this.activeRect.x=y.x),this.activeRect.y<y.y&&(this.activeRect.height=this.activeRect.height-(y.y-this.activeRect.y),this.activeRect.y=y.y),this.activeRect.x+this.activeRect.width>y.x+y.width&&(this.activeRect.width=this.activeRect.width-(this.activeRect.x+this.activeRect.width-(y.x+y.width)),this.activeRect.x=y.x+y.width-this.activeRect.width,this.activeRect.ex=this.activeRect.x+this.activeRect.width),this.activeRect.y+this.activeRect.height>y.y+y.height&&(this.activeRect.height=this.activeRect.height-(this.activeRect.y+this.activeRect.height-(y.y+y.height)),this.activeRect.y=y.y+y.height-this.activeRect.height,this.activeRect.ey=this.activeRect.y+this.activeRect.height)}}calcCenter(this.activeRect);const u=this.activeRect.width/c,d=this.activeRect.height/a;this.store.active.forEach((f,g)=>{f.calculative.worldRect.x=this.activeInitPos[g].x*this.activeRect.width+this.activeRect.x,f.calculative.worldRect.y=this.activeInitPos[g].y*this.activeRect.height+this.activeRect.y,f.calculative.worldRect.width*=u,f.calculative.iconWidth&&(f.calculative.iconWidth*=u),f.calculative.worldRect.height*=d,f.calculative.iconHeight&&(f.calculative.iconHeight*=d),calcRightBottom(f.calculative.worldRect),calcCenter(f.calculative.worldRect),this.updatePenRect(f,{worldRectIsReady:!0}),this.execPenResize(f),this.updateLines(f)}),this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("resizePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}movePens(t){var c,a;if(!this.activeRect||this.store.data.locked)return;if(!this.initActiveRect){this.initActiveRect=deepClone(this.activeRect);return}if(!this.store.options.moveConnectedLine&&!this.canMoveLine&&this.store.active.length===1&&((c=this.store.active[0].anchors[0])!=null&&c.connectTo||(a=this.store.active[0].anchors[this.store.active[0].anchors.length-1])!=null&&a.connectTo)||(this.movingPens||(this.initMovingPens(),this.store.active.forEach(h=>{setHover(h,!1)}),this.store.hover=void 0),!this.mouseDown))return;let i=t.x-this.mouseDown.x,s=t.y-this.mouseDown.y;t.shiftKey&&!t.ctrlKey&&(s=0),t.ctrlKey&&(i=0);const r=deepClone(this.initActiveRect);translateRect(r,i,s);let o=!1;if(this.store.options.strictScope){const h=this.store.data.width||this.store.options.width,l=this.store.data.height||this.store.options.height;if(h&&l){let u={x:this.store.data.origin.x,y:this.store.data.origin.y,width:h*this.store.data.scale,height:l*this.store.data.scale};r.x<u.x&&(r.x=u.x,o=!0),r.y<u.y&&(r.y=u.y,o=!0),r.x+r.width>u.x+u.width&&(r.x=u.x+u.width-r.width,o=!0),r.y+r.height>u.y+u.height&&(r.y=u.y+u.height-r.height,o=!0)}}const n={x:r.x-this.activeRect.x,y:r.y-this.activeRect.y};if(!this.store.options.disableDock&&!o){this.clearDock();const h=this.customMoveDock||calcMoveDock;this.dock=h(this.store,r,this.movingPens,n);const{xDock:l,yDock:u}=this.dock;let d;l&&(n.x+=l.step,d=this.store.pens[l.penId],d.calculative.isDock=!0),u&&(n.y+=u.step,d=this.store.pens[u.penId],d.calculative.isDock=!0)}this.translatePens(this.movingPens,n.x,n.y,!0)}changeIdsByMoving(t,i){t.id+=movingSuffix,t.parentId&&i.find(s=>s.id===t.parentId)&&(t.parentId+=movingSuffix),t.children&&(t.children=t.children.map(s=>s+movingSuffix)),t.connectedLines&&(t.connectedLines=t.connectedLines.map(s=>(i.find(r=>r.id===s.lineId)&&(s.lineId+=movingSuffix),s))),t.type&&t.calculative.worldAnchors&&(t.calculative.worldAnchors=t.calculative.worldAnchors.map(s=>(s.connectTo&&i.find(r=>r.id===s.connectTo)&&(s.connectTo+=movingSuffix),s)))}initMovingPens(){var s,r;if(!this.store.options.moveConnectedLine&&!this.canMoveLine)for(let o=0;o<this.store.active.length;o++){const n=this.store.active[o];((s=n.anchors[0])!=null&&s.connectTo||(r=n.anchors[n.anchors.length-1])!=null&&r.connectTo)&&(this.store.active.splice(o,1),n.calculative.active=void 0,--o)}this.movingPens=deepClone(this.store.active,!0),this.movingPens=this.getAllFollowersByPens(this.movingPens);const t=this.getAllByPens(this.movingPens),i=deepClone(t,!0);t.forEach(o=>{this.changeIdsByMoving(o,i),this.store.pens[o.id]=o,o.calculative.canvas=this;const n={globalAlpha:.5};o.lineWidth===0&&(n.lineWidth=1),(o.name.endsWith("Dom")||isDomShapes.includes(o.name)||this.store.options.domShapes.includes(o.name)||o.image)&&(n.name="rectangle",n.onDestroy=void 0),this.updateValue(o,n),o.calculative.image=void 0})}moveLineAnchor(t,i){var c,a,h,l,u;if(!this.activeRect||this.store.data.locked)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),(c=this.store.activeAnchor)!=null&&c.connectTo){const d=this.store.pens[this.store.activeAnchor.connectTo];disconnectLine(d,getAnchor(d,this.store.activeAnchor.anchorId),this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor)}let s=(a=this.store.activeAnchor)==null?void 0:a.id,r=(l=(h=this.store.pens[this.store.activeAnchor.penId])==null?void 0:h.connectedLines)==null?void 0:l.filter(d=>d.anchor===s);r&&r.length>0&&r.forEach(d=>{const f=this.store.pens[d.lineId];disconnectLine(this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor,f,getAnchor(f,d.lineAnchor))});const o=this.store.active[0];getFromAnchor(o);const n=getToAnchor(o);if(o.lineName==="polyline"&&!i.shiftKey)translatePolylineAnchor(o,this.store.activeAnchor,t);else{let d=0,f=0;if(o.lineName==="line"){let g=o.calculative.worldAnchors.findIndex(v=>v.id===this.store.activeAnchor.id);g===0&&(g=2);let y=o.calculative.worldAnchors[g-1];if(i.ctrlKey&&i.shiftKey){let v=deepClone(t);this.getSpecialAngle(v,y),d=v.x-this.store.activeAnchor.x,f=v.y-this.store.activeAnchor.y}else if(!i.ctrlKey&&i.shiftKey){let v={x:t.x,y:y.y};d=v.x-this.store.activeAnchor.x,f=v.y-this.store.activeAnchor.y}else if(i.ctrlKey&&!i.shiftKey){let v={x:y.x,y:t.y};d=v.x-this.store.activeAnchor.x,f=v.y-this.store.activeAnchor.y}else d=t.x-this.store.activeAnchor.x,f=t.y-this.store.activeAnchor.y}else!i.ctrlKey&&i.shiftKey?(d=t.x-this.store.activeAnchor.x,f=0):i.ctrlKey&&!i.shiftKey?(d=0,f=t.y-this.store.activeAnchor.y):(d=t.x-this.store.activeAnchor.x,f=t.y-this.store.activeAnchor.y);translatePoint(this.store.activeAnchor,d,f),this.store.hover&&this.store.hoverAnchor&&this.store.hoverAnchor.penId!==this.store.activeAnchor.penId&&(this.store.hoverAnchor.type===PointType.Line?(d=t.x-this.store.activeAnchor.x,f=t.y-this.store.activeAnchor.y,getDistance(this.store.activeAnchor,this.store.hoverAnchor,this.store)):(d=this.store.hoverAnchor.x-this.store.activeAnchor.x,f=this.store.hoverAnchor.y-this.store.activeAnchor.y),translatePoint(this.store.activeAnchor,d,f),n.prev=void 0,o.lineName!=="polyline"&&((u=this[o.lineName])==null||u.call(this,this.store,o)))}this.patchFlagsLines.add(o),this.store.path2dMap.set(o,globalStore.path2dDraws[o.name](o)),this.render(),this.store.active[0].calculative&&(this.store.active[0].calculative.gradientAnimatePath=void 0),this.store.emitter.emit("moveLineAnchor",{pen:this.store.active[0],anchor:this.store.activeAnchor}),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},500)}moveLineAnchorPrev(t){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),this.store.activeAnchor.prev.x=t.x,this.store.activeAnchor.prev.y=t.y,this.store.activeAnchor.next){if(!this.store.activeAnchor.prevNextType)this.store.activeAnchor.next.x=t.x,this.store.activeAnchor.next.y=t.y,rotatePoint(this.store.activeAnchor.next,180,this.store.activeAnchor);else if(this.store.activeAnchor.prevNextType===PrevNextType.Bilateral&&this.prevAnchor){const s=calcRotate(t,this.store.activeAnchor),r=calcRotate(this.prevAnchor,this.store.activeAnchor);this.store.activeAnchor.next.x=this.nextAnchor.x,this.store.activeAnchor.next.y=this.nextAnchor.y,rotatePoint(this.store.activeAnchor.next,s-r,this.store.activeAnchor)}}const i=this.store.active[0];this.patchFlagsLines.add(i),this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}moveLineAnchorNext(t){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),this.store.activeAnchor.next.x=t.x,this.store.activeAnchor.next.y=t.y,this.store.activeAnchor.prev){if(!this.store.activeAnchor.prevNextType)this.store.activeAnchor.prev.x=t.x,this.store.activeAnchor.prev.y=t.y,rotatePoint(this.store.activeAnchor.prev,180,this.store.activeAnchor);else if(this.store.activeAnchor.prevNextType===PrevNextType.Bilateral&&this.nextAnchor){const s=calcRotate(t,this.store.activeAnchor),r=calcRotate(this.nextAnchor,this.store.activeAnchor);this.store.activeAnchor.prev.x=this.prevAnchor.x,this.store.activeAnchor.prev.y=this.prevAnchor.y,rotatePoint(this.store.activeAnchor.prev,s-r,this.store.activeAnchor)}}const i=this.store.active[0];this.patchFlagsLines.add(i),this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}async setAnchor(t){var r;const i=[deepClone(this.store.hover,!0)],s=this.store.hover;if(this.store.hoverAnchor){if(this.beforeRemoveAnchor&&!await this.beforeRemoveAnchor(s,this.store.hoverAnchor))return;s.type===PenType.Line&&((r=s.calculative.worldAnchors)==null?void 0:r.length)<=2?this.delete([s]):(removePenAnchor(s,this.store.hoverAnchor),s.type===PenType.Line&&this.initLineRect(s)),this.store.hoverAnchor=void 0,this.store.activeAnchor=void 0,this.externalElements.style.cursor="default"}else if(s){if(this.beforeAddAnchor&&!await this.beforeAddAnchor(s,this.store.pointAt))return;if(s.type===PenType.Line){this.store.activeAnchor=addLineAnchor(s,this.store.pointAt,this.store.pointAtIndex),this.initLineRect(s);const o={x:t.x,y:t.y};this.getHover(o)}else{const o={id:s8(),x:t.x,y:t.y};this.store.activeAnchor=pushPenAnchor(s,o)}}this.hotkeyType=HotkeyType.None,this.render(),s&&this.pushHistory({type:EditType.Update,pens:[deepClone(s,!0)],initPens:i})}checkDisconnect(t,i){if(t.id.indexOf(movingSuffix)>0){const s=t.id;t=this.store.pens[s.replace(movingSuffix,"")]}t.anchors.forEach(s=>{if(s.connectTo&&!i.find(r=>r.id===s.connectTo||r.id===s.connectTo+movingSuffix)){const r=this.store.pens[s.connectTo];if(!r||r.type)return;disconnectLine(r,getAnchor(r,s.anchorId),t,s)}})}translatePens(t=this.store.active,i,s,r){if(!t||!t.length||t.some(a=>{if(a.locked>=LockState.DisableMove)return!0}))return;const n=!r&&deepClone(t,!0);this.activeRect&&translateRect(this.activeRect,i,s);const c=this.getAllByPens(t);t.forEach(a=>{var h,l;if(!(a.locked>=LockState.DisableMove)){if(a.type===PenType.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine||a.isRuleLine)return;translateLine(a,i,s),this.checkDisconnect(a,c),this.store.path2dMap.set(a,globalStore.path2dDraws[a.name](a)),r||(this.initLineRect(a),(h=a.connectedLines)==null||h.forEach(u=>{const d=this.store.pens[u.lineId];this.initLineRect(d)}))}else translateRect(a.calculative.worldRect,i,s),this.updatePenRect(a,{worldRectIsReady:!0}),a.calculative.x=a.x,a.calculative.y=a.y,a.calculative.initRect&&(a.calculative.initRect.x=a.calculative.x,a.calculative.initRect.y=a.calculative.y,a.calculative.initRect.ex=a.calculative.x+a.calculative.width,a.calculative.initRect.ey=a.calculative.y+a.calculative.height);this.updateLines(a),(l=a.onMove)==null||l.call(a,a)}}),this.activeRect&&this.getSizeCPs(),this.render(),this.tooltip.translate(i,s),r||(this.pushHistory({type:EditType.Update,pens:deepClone(t,!0),initPens:n}),this.initImageCanvas(t),this.initTemplateCanvas(t),this.store.emitter.emit("translatePens",t)),this.store.emitter.emit("translatingPens",t)}templateTranslatePens(t=this.store.active,i,s){if(!t||!t.length)return;const r=this.getAllByPens(t);t.forEach(o=>{var n;if(o.type===PenType.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)return;translateLine(o,i,s),this.checkDisconnect(o,r),this.store.path2dMap.set(o,globalStore.path2dDraws[o.name](o))}else translateRect(o.calculative.worldRect,i,s),this.updatePenRect(o,{worldRectIsReady:!0}),o.calculative.x=o.x,o.calculative.y=o.y,o.calculative.initRect&&(o.calculative.initRect.x=o.calculative.x,o.calculative.initRect.y=o.calculative.y,o.calculative.initRect.ex=o.calculative.x+o.calculative.width,o.calculative.initRect.ey=o.calculative.y+o.calculative.height);(n=o.onMove)==null||n.call(o,o)})}calcAutoAnchor(t,i,s,r){const o=getFromAnchor(t),n=getToAnchor(t),c=nearestAnchor(s,i===o?n:o);c&&(i.x=c.x,i.y=c.y,i.prev=void 0,i.next=void 0,r?r.anchor=c.id:connectLine(s,c,t,i),this[t.lineName]&&this[t.lineName](this.store,t),this.store.path2dMap.set(t,globalStore.path2dDraws.line(t)),this.initLineRect(t))}restoreNodeAnimate(t){var i,s;if(t.calculative.initRect){if(t.keepAnimateState)for(const r in t)t.calculative[r]!==void 0&&r!=="x"&&r!=="y"&&r!=="width"&&r!=="height"&&r!=="initRect"&&(typeof t[r]!="object"||r==="lineDash")&&(r==="fontSize"||r==="lineWidth"?t[r]=t.calculative[r]/t.calculative.canvas.store.data.scale:t[r]=t.calculative[r]);else{const r=t.calculative.initRect.rotate-t.calculative.rotate;for(const n in t)n!=="x"&&n!=="y"&&n!=="width"&&n!=="height"&&n!=="initRect"&&n!=="rotate"&&(typeof t[n]!="object"||n==="lineDash")&&(t.calculative[n]=t[n]);(i=t.children)!=null&&i.length?r&&rotatePen(t,r,t.calculative.worldRect):t.calculative.rotate=t.rotate;const o=deepClone(this.store.animateMap.get(t));o&&(o.id=t.id,this.parent.setValue(o,{doEvent:!1,render:!0,history:!1})),t.calculative.worldRect=t.calculative.initRect}this.updatePenRect(t,{worldRectIsReady:!0}),this.updateLines(t),t.image&&t.name!=="gif"&&(this.canvasImage.init(),this.canvasImageBottom.init()),t.calculative.text!==t.text&&(t.calculative.text=t.text,calcTextLines(t)),(s=this.store.active)!=null&&s.length&&this.calcActiveRect(),t.calculative.initRect=void 0}}updateLines(t,i){var s;(s=t.children)==null||s.forEach(r=>{const o=this.store.pens[r];o&&this.updateLines(o,i)}),t.connectedLines&&t.connectedLines.forEach((r,o)=>{const n=this.store.pens[r.lineId];if(!n||n.calculative.active)return;const c=getAnchor(n,r.lineAnchor);if(!c)return;if(!c.connectTo){t.connectedLines.splice(o,1);return}if(n.autoFrom){const d=getFromAnchor(n);d.id===c.id&&this.calcAutoAnchor(n,d,t,r)}if(n.autoTo){const d=getToAnchor(n);d.id===c.id&&this.calcAutoAnchor(n,d,t,r)}const a=getAnchor(t,r.anchor);if(!a)return;let h=t.rotate;t.flipX&&(h*=-1),t.flipY&&(h*=-1);let l=c.distance*this.store.data.scale*Math.cos((h+a.rotate)/180*Math.PI)||0,u=c.distance*this.store.data.scale*Math.sin((h+a.rotate)/180*Math.PI)||0;if(t.flipX&&(l=-l),t.flipY&&(u=-u),translatePoint(c,a.x-c.x+l,a.y-c.y+u),this.store.options.autoPolyline&&!this.autoPolylineFlag&&n.autoPolyline!==!1&&n.lineName==="polyline"){let d=getFromAnchor(n),f=getToAnchor(n),g=!1;d.id===c.id?(d=c,g=!0):f.id===c.id&&(f=c,g=!0),g&&(n.calculative.worldAnchors=[d,f],n.calculative.activeAnchor=d,this.polyline(this.store,n,f),this.initLineRect(n))}this.store.path2dMap.set(n,globalStore.path2dDraws[n.name](n)),this.patchFlagsLines.add(n),n.calculative.gradientSmooth&&(n.calculative.gradientAnimatePath=getGradientAnimatePath(n)),i&&getLineLength(n)})}calcActiveRect(){const t=this.store.active.filter(i=>(!i.locked||i.locked<LockState.DisableMove)&&i.visible!=!1);if(t.length)t.length===1?(this.activeRect=deepClone(t[0].calculative.worldRect),this.activeRect.rotate=t[0].calculative.rotate||0,calcCenter(this.activeRect)):(this.activeRect=getRect$1(t),this.activeRect.rotate=0);else return;this.lastRotate=0,this.getSizeCPs()}rotatePen(t,i,s){t.type?(t.calculative.worldAnchors.forEach(r=>{rotatePoint(r,i,s.center)}),this.initLineRect(t),calcPenRect(t)):(t.calculative.rotate?t.calculative.rotate+=i:t.calculative.rotate=i,rotatePoint(t.calculative.worldRect.center,i,s.center),t.parentId?(t.calculative.worldRect.x=t.calculative.worldRect.center.x-t.calculative.worldRect.width/2,t.calculative.worldRect.y=t.calculative.worldRect.center.y-t.calculative.worldRect.height/2,t.x=(t.calculative.worldRect.x-s.x)/s.width,t.y=(t.calculative.worldRect.y-s.y)/s.height):(t.x=t.calculative.worldRect.center.x-t.width/2,t.y=t.calculative.worldRect.center.y-t.height/2),t.rotate=t.calculative.rotate,this.updatePenRect(t),t.children&&t.children.forEach(r=>{const o=this.store.pens[r];this.rotatePen(o,i,t.calculative.worldRect)}))}nextAnimate(t){if(!t)return;this.store.emitter.emit("animateEnd",t);let i;t.nextAnimate&&(i=this.store.data.pens.filter(s=>s.id===t.nextAnimate||s.tags&&s.tags.indexOf(t.nextAnimate)>-1)),i&&(i.forEach(s=>{var r,o,n,c,a;if(s.calculative.pause){const h=Date.now()-s.calculative.pause;s.calculative.pause=void 0,s.calculative.frameStart+=h,s.calculative.frameEnd+=h}else if(s.name==="video")s.calculative.media.currentTime=0,(r=s.calculative.media)==null||r.play(),(o=s.onStartVideo)==null||o.call(s,s);else if(s.type||(n=s.frames)!=null&&n.length||s.animations&&s.animations.length){if(s.type){if((a=s.animations)!=null&&a.length){const h=deepClone(s.animations[0]);delete h.name,h.currentAnimation=0,this.parent.setValue({id:s.id,...h},{doEvent:!1,history:!1})}}else{if(!s.frames&&s.animations&&s.animations.length){let h=(c=s.animations)==null?void 0:c.findIndex(d=>d.autoPlay),l=h===-1?0:h;const u=deepClone(s.animations[l]);delete u.name,u.currentAnimation=l,!s.type&&u.frames&&(u.showDuration=this.parent.calcAnimateDuration(u)),this.parent.setValue({id:s.id,...u},{doEvent:!1,history:!1})}this.store.animateMap.set(s,this.getFrameProps(s))}this.store.animates.add(s)}}),this.animate())}getFrameProps(t){let i={};return t.frames&&t.frames.forEach(s=>{for(let r in s)!["duration","x","y","width","height","rotate"].includes(r)&&!i[r]&&(i[r]=t[r])}),i}animate(){this.animateRendering||requestAnimationFrame(()=>{const t=Date.now();if(t-this.lastAnimateRender<this.store.options.animateInterval){this.store.animates.size>0&&this.animate();return}this.lastAnimateRender=t,this.animateRendering=!0;const i=[];let s=!1;for(const r of this.store.animates)if(!r.calculative.pause){if(r.calculative.active&&!r.type&&!this.movingPens&&(s=!0),!r.type)setNodeAnimate(r,t)?r.calculative.patchFlags&&(calcCenter(r.calculative.worldRect),this.updatePenRect(r,{worldRectIsReady:!0,playingAnimate:!0})):(requestAnimationFrame(()=>{this.restoreNodeAnimate(r)}),i.push(r),this.nextAnimate(r)),this.updateLines(r,!0);else if(!setLineAnimate(r,t)){if(r.keepAnimateState){for(const o in r)r.calculative[o]!==void 0&&o!=="length"&&(typeof r[o]!="object"||o==="lineDash")&&(o==="lineWidth"?r[o]=r.calculative[o]/r.calculative.canvas.store.data.scale:r[o]=r.calculative[o]);calcPenRect(r)}else for(const o in r)(typeof r[o]!="object"||o==="lineDash")&&(o==="lineWidth"?r.calculative[o]=r[o]*r.calculative.canvas.store.data.scale:r.calculative[o]=r[o]);i.push(r),this.nextAnimate(r)}this.patchFlags=!0}s&&this.calcActiveRect(),i.forEach(r=>{this.store.animates.delete(r)}),this.render(!1),this.animateRendering=!1,this.animate()})}get clipboardName(){return"meta2d-clipboard"}async copy(t,i=!0){const s=s8(),{origin:r,scale:o}=this.store.data;this.store.clipboard=void 0,localStorage.removeItem(this.clipboardName),sessionStorage.setItem("page",s);let n=this.getAllByPens(deepClone(t||this.store.active,!0));n.forEach(a=>{a.copyIndex=this.store.data.pens.findIndex(h=>h.id===a.id),a.pathId&&(a.path=this.store.data.paths[a.pathId])}),n.sort((a,h)=>a.copyIndex-h.copyIndex);const c={meta2d:!0,pens:n,origin:deepClone(r),scale:o,page:s,initRect:deepClone(this.activeRect),offset:10,mousePos:deepClone(this.mousePos)};if(navigator.clipboard&&!this.store.options.disableClipboard&&!navigator.userAgent.includes("Firefox"))try{await navigator.clipboard.writeText(JSON.stringify(c))}catch{localStorage.setItem(this.clipboardName,JSON.stringify(c))}else localStorage.setItem(this.clipboardName,JSON.stringify(c));i&&this.store.emitter.emit("copy",c.pens)}cut(t){this.copy(t,!1),this.delete(t),this.store.emitter.emit("cut",t)}async paste(){var a,h;let t,i;if(navigator.clipboard&&!this.store.options.disableClipboard&&!navigator.userAgent.includes("Firefox"))try{t=await((a=navigator.clipboard)==null?void 0:a.readText())}catch{t=localStorage.getItem(this.clipboardName)}else t=localStorage.getItem(this.clipboardName);if(t){try{i=JSON.parse(t)}catch(l){console.warn("json",l.message);return}if(!i||!i.meta2d)return}else return;if(this.beforeAddPens&&await this.beforeAddPens(i.pens)!=!0)return;let s,r;this.store.clipboard&&(s=this.store.clipboard.offset+10,r=this.store.clipboard.pos),this.store.clipboard=deepClone(i);const o=sessionStorage.getItem("page"),n=this.store.data.scale;if(this.store.clipboard.mousePos&&(Math.abs(this.store.clipboard.mousePos.x-this.mousePos.x)>100*n||Math.abs(this.store.clipboard.mousePos.y-this.mousePos.y)>100*n)){let l=-this.store.clipboard.initRect.width/this.store.clipboard.scale/10/n,u=-this.store.clipboard.initRect.height/this.store.clipboard.scale/10/n,d=(n-this.store.clipboard.scale)*this.store.clipboard.initRect.width/2+l,f=(n-this.store.clipboard.scale)*this.store.clipboard.initRect.height/2+u;this.store.clipboard.pens.length>1&&(d=(n-1)*this.store.clipboard.initRect.width/this.store.clipboard.scale/2,f=(n-1)*this.store.clipboard.initRect.height/this.store.clipboard.scale/2),this.store.clipboard.pos={x:this.mousePos.x-d,y:this.mousePos.y-f},this.store.clipboard.offset=0}else o!==i.page?(this.store.clipboard.pos={x:this.mousePos.x,y:this.mousePos.y},this.store.clipboard.offset=0):this.pasteOffset?(s&&(this.store.clipboard.offset=s),r&&(this.store.clipboard.pos=r)):(this.store.clipboard.offset=0,this.pasteOffset=!0);(h=this.keyOptions)!=null&&h.F||this.store.clipboard.pens.forEach(l=>{delete l.copyIndex});const c=this.store.clipboard.pens.filter(l=>!l.parentId);for(const l of c)this.pastePen(l,void 0);sessionStorage.setItem("page",i.page),this.active(c),this.pushHistory({type:EditType.Add,pens:this.store.clipboard.pens}),this.render(),this.store.emitter.emit("add",this.store.clipboard.pens),this.store.emitter.emit("paste",this.store.clipboard.pens)}getAllByPens(t){const i=[];for(const s of t)i.push(...deepClone(getAllChildren(s,this.store),!0));return i.concat(t)}getAllFollowersByPens(t,i=!0){const s=t;for(const r of t){let o=getAllFollowers(r,this.store);i&&(o=deepClone(o,!0));for(const n of o)s.find(c=>c.id===n.id)||s.push(n)}return s}setFollowers(t=this.store.active){if(t)if(t.length<2)t[0].followers=[];else{let i=t.map(r=>r.id);i.pop();const s=t[t.length-1];s.followers?i.forEach(r=>{s.followers.includes(r)||s.followers.push(r)}):s.followers=i}}changeLineAnchors(t,i,s){if(Array.isArray(i.connectedLines))for(let r=0;r<i.connectedLines.length;r++){const{lineId:o}=i.connectedLines[r],n=s.find(c=>c.id===o);if(n){const c=n.anchors[0],a=n.anchors[n.anchors.length-1];c.connectTo===t&&(c.connectTo=i.id),a.connectTo===t&&(a.connectTo=i.id)}else i.connectedLines.splice(r,1),r--}}changeNodeConnectedLine(t,i,s){var c;const r=i.anchors[0],o=i.anchors[i.anchors.length-1],n=[r,o];for(const a of n){const h=a.connectTo;if(h){const l=s.find(u=>u.id===h);l?(c=l.connectedLines)==null||c.forEach(u=>{u.lineId===t&&(u.lineId=i.id,u.lineAnchor=a.id)}):(a.connectTo=void 0,a.prev&&(a.prev.connectTo=void 0),a.next&&(a.next.connectTo=void 0))}}}async delete(t=this.store.active,i=!1,s=!0){if(!t||!t.length||this.beforeRemovePens&&await this.beforeRemovePens(t)!=!0||(i||(t=t.filter(o=>!o.locked)),!t||!t.length))return;const r=[];if(this._del(t,r,i),this.initImageCanvas(r),this.initTemplateCanvas(r),this.inactive(),this.clearHover(),this.render(),s){if(r.length===0)return;this.pushHistory({type:EditType.Delete,pens:r})}this.store.emitter.emit("delete",t)}_del(t,i,s){t&&t.forEach(r=>{if(r.type&&(r.lastConnected={}),r.parentId)if(this.getLockedParent(r)){console.warn("");return}else{const n=getParent(r),c=n.children.indexOf(r.id);n.children.splice(c,1),i&&this.getDelPens(r,i),this.delForce(r)}else{if(!s&&r.locked)return;i&&this.getDelPens(r,i),this.delForce(r)}})}getDelPens(t,i){if(!t)return;if(this.store.data.pens.findIndex(r=>r.id===t.id)>-1){const r=this.store.pens[t.id];r&&r.calculative&&(r.calculative.active=void 0),i.push(r)}t.children&&t.children.forEach(r=>{this.getDelPens(this.store.pens[r],i)})}getLockedParent(t){if(!t.parentId)return!1;const i=getParent(t);if(i.locked)return i;this.getLockedParent(i)}delForce(t){var s;if(!t)return;const i=this.store.data.pens.findIndex(r=>r.id===t.id);i>-1&&(this.delConnectedLines(this.store.data.pens[i]),this.store.data.pens.splice(i,1),this.store.pens[t.id]=void 0,delete this.store.pens[t.id],t.pathId&&delete this.store.data.paths[t.pathId]),this.store.animates.delete(t),this.store.animateMap.delete(t),t.children&&t.children.forEach(r=>{this.delForce(this.store.pens[r])}),(s=t.onDestroy)==null||s.call(t,t)}delConnectedLines(t){var i;if(t.connectedLines)for(let s=0;s<t.connectedLines.length;s++){const{lineId:r,lineAnchor:o}=t.connectedLines[s],n=this.store.pens[r];if(n){let c=n.anchors.find(a=>a.id===o);(c==null?void 0:c.connectTo)===t.id&&(c.connectTo=void 0,c.anchorId=void 0,c.prev&&(c.prev.connectTo=void 0),c.next&&(c.next.connectTo=void 0)),c=getAnchor(n,o),c&&(c.connectTo=void 0,c.anchorId=void 0,c.prev&&(c.prev.connectTo=void 0),c.next&&(c.next.connectTo=void 0))}}t.type&&((i=t.calculative.worldAnchors)==null||i.forEach((s,r)=>{var n;if(!s.connectTo)return;const o=this.store.pens[s.connectTo];o&&((n=o.calculative.worldAnchors)==null||n.forEach(c=>{disconnectLine(o,c,t,s)}))}))}convertSpecialCharacter(t){var i={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return t.replace(/&(lt|gt|nbsp|amp|quot);/gi,function(s,r){return i[r]})}createInput(){this.inputParent.classList.add("meta2d-input"),this.inputDiv.classList.add("input-div"),this.inputParent.appendChild(this.inputDiv),this.dropdown.onmouseleave=()=>{this.store.hover=null},this.inputParent.appendChild(this.dropdown),this.externalElements.appendChild(this.inputParent),this.inputParent.onmousedown=this.stopPropagation,this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.contentEditable="false",this.dropdown.onmousedown=this.stopPropagation;let t;for(let i=0;i<document.styleSheets.length;i++)document.styleSheets[i].title==="le5le.com"&&(t=document.styleSheets[i]);if(!t){const i=document.createElement("style");i.title="le5le.com",document.head.appendChild(i),t=i.sheet,t.insertRule(".meta2d-input{display:none;position:absolute;outline:none;align-items: center;}"),t.insertRule(".meta2d-input textarea{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;left:0;top:0}"),t.insertRule(".meta2d-input .right{width:10px;height:10px;flex-shrink:0;border-top: 1px solid;border-right: 1px solid;margin-right: 5px;transition: all .3s cubic-bezier(.645,.045,.355,1);position:absolute;right:1px;}"),t.insertRule(".meta2d-input ul{position:absolute;top:100%;margin-top:4px; width:calc(100% + 10px);min-height:30px;border-radius: 2px;box-shadow: 0 2px 8px #00000026;list-style-type: none;background-color: #fff;padding: 4px 0;max-height: 105px;overflow-y: auto;}"),t.insertRule(".meta2d-input ul li{padding: 5px 12px;line-height: 22px;white-space: nowrap;cursor: pointer;}"),t.insertRule(".meta2d-input ul li:hover{background: #eeeeee;}"),t.insertRule(".input-div::-webkit-scrollbar {display:none}"),t.insertRule(".input-div{scrollbar-width: none;}"),t.insertRule(".meta2d-input .input-div{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;width: 100%;left:0;top:0;display:flex;text-align: center;justify-content: center;flex-direction: column;}"),t.insertRule(".input-div div{}")}this.inputDiv.onfocus=i=>{if(navigator.userAgent.includes("Firefox")){if(!i.target.innerText){let s=this.inputDiv.offsetWidth/2;window.getComputedStyle(this.inputDiv,null).textAlign!=="center"&&(s=0),this.inputDiv.innerHTML=`<br style="margin-left:${s}px;margin-top:4px;" />`}}else if(i.target.innerText)this.inputDiv.style.paddingTop="";else{let s=window.getComputedStyle(this.inputDiv,null);s.justifyContent==="center"&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(s.lineHeight)/2}px`)}},this.inputDiv.onblur=()=>{setTimeout(()=>{this.hideInput()},300)},this.inputDiv.oninput=i=>{const s=this.store.pens[this.inputDiv.dataset.penId];if(s&&s.inputType==="number"){const r=i.target.innerText,o=r.replace(/[^0-9]/g,"");r!==o&&(i.preventDefault(),i.target.innerText=o)}if(navigator.userAgent.includes("Firefox")){if(!i.target.innerText.trim()){let r=this.inputDiv.offsetWidth/2;window.getComputedStyle(this.inputDiv,null).textAlign!=="center"&&(r=0),this.inputDiv.innerHTML=`<br style="margin-left:${r}px;margin-top:4px;" />`}}else if(i.target.innerText)this.inputDiv.style.paddingTop="";else{let r=window.getComputedStyle(this.inputDiv,null);r.justifyContent==="center"&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(r.lineHeight)/2}px`)}this.store.emitter.emit("input",s)},this.inputDiv.onclick=i=>{i.stopPropagation();const s=this.store.pens[this.inputDiv.dataset.penId];this.dropdown.style.display==="block"?this.dropdown.style.display="none":s!=null&&s.dropdownList&&this.store.data.locked&&(this.dropdown.style.display="block"),this.store.emitter.emit("clickInput",s)},this.inputDiv.onkeyup=i=>{this.setDropdownList(!0);const s=this.store.pens[this.inputDiv.dataset.penId];this.store.emitter.emit("input",{pen:s,text:i.key}),i.stopPropagation()},this.inputDiv.onkeydown=i=>{i.stopPropagation()},this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.onwheel=i=>{i.stopPropagation()},this.inputDiv.onpaste=i=>{i.preventDefault();let s="";i.clipboardData&&i.clipboardData.getData&&(s=i.clipboardData.getData("text/plain")),document.execCommand("insertHTML",!1,s)}}clearDropdownList(){if(this.dropdown.hasChildNodes())for(let t=0;t<this.dropdown.childNodes.length;t++)this.dropdown.childNodes[t].remove(),--t}dropdownAppendOption(t,i){const s=document.createElement("li");s.onwheel=this.stopPropagation,s.innerText=t,s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.title=t,s.style.zoom=this.store.data.scale,s.onmousedown=this.stopPropagation,s.dataset.i=i+"",s.onclick=this.selectDropdown;const r=this.store.pens[this.inputDiv.dataset.penId];s.onmouseenter=()=>{s.style.background=r.dropdownHoverBackground||this.store.styles.activeBg||"#eee",s.style.color=r.dropdownHoverColor||"#bdc7db"},s.onmouseleave=()=>{s.style.background=r.dropdownBackground||this.store.styles.popContentBg||"#fff",s.style.color=r.dropdownColor||"#bdc7db"},this.dropdown.appendChild(s)}find(t){return this.store.data.pens.filter(i=>i.id==t||i.tags&&i.tags.indexOf(t)>-1)}findOne(t){return this.store.data.pens.find(i=>i.id==t||i.tags&&i.tags.indexOf(t)>-1)}changePenId(t,i){var r,o,n,c,a,h,l;if(t===i)return;const s=this.store.pens[t];if(s&&!this.store.pens[i]){if(s.id=i,this.store.pens[i]=this.store.pens[t],(r=s.onChangeId)==null||r.call(s,s,t,i),delete this.store.pens[t],s.parentId){const u=this.store.pens[s.parentId],d=(o=u.children)==null?void 0:o.findIndex(f=>f===t);d!==-1&&((n=u.children)==null||n.splice(d,1,i))}(c=s.children)==null||c.forEach(u=>{const d=this.store.pens[u];d.parentId=i}),s.formId&&s.followers.forEach(u=>{const d=this.store.pens[u];d.formId=i}),s.type===PenType.Line?this.changeNodeConnectedLine(t,s,this.store.data.pens):(this.changeLineAnchors(t,s,this.store.data.pens),(a=s.connectedLines)==null||a.forEach(({lineId:u})=>{const d=this.store.pens[u];calcWorldAnchors(d)})),(h=s.anchors)==null||h.forEach(u=>u.penId=i),(l=s.calculative.worldAnchors)==null||l.forEach(u=>u.penId=i)}}updateValue(t,i){var g,y;const s=this.getPenRect(t),r=t.name;Object.assign(t,i);const o=r!==t.name;i.newId&&this.changePenId(t.id,i.newId);let n=!1,c=!1,a=!1,h=!1,l=!1,u=!1,d,f=!1;for(const v in i)v.indexOf(".")===-1?(v==="rotate"?t.disableRotate?t.rotate=t.calculative.rotate||0:d=t.calculative.rotate||0:v==="canvasLayer"||v==="isBottom"||v==="showChild"?u=!0:v==="image"&&(f=!0),(typeof t[v]!="object"||v==="lineDash")&&(!t.disableRotate||v!=="rotate")&&(t.calculative[v]=i[v]),needCalcTextRectProps.includes(v)&&(c=!0),["name","borderRadius","lineSmooth","close"].includes(v)&&(n=!0),needSetPenProps.includes(v)&&(l=!0),needPatchFlagsPenRectProps.includes(v)&&(a=!0),needCalcIconRectProps.includes(v)&&(h=!0),t.image&&t.name!=="gif"&&["globalAlpha","flipY","flipX","x","y","width","height","iconWidth","iconHeight","imageRatio","iconLeft","iconTop","iconAlign","rotate","visible"].includes(v)&&(f=!0)):(delete t[v],setter(t,v,i[v])),v.split(".")[0]==="anchors"&&calcWorldAnchors(t);if(this.setCalculativeByScale(t),o&&((g=t.onDestroy)==null||g.call(t,t),clearLifeCycle(t)),l){const v={x:i.x??s.x,y:i.y??s.y,width:i.width??s.width,height:i.height??s.height};this.setPenRect(t,v,!1),this.updateLines(t,!0),this.store.active&&this.store.active.length&&t.id===this.store.active[0].id&&this.calcActiveRect()}else a?this.updatePenRect(t):(c&&calcTextRect(t),h&&calcIconRect(this.store.pens,t),n&&globalStore.path2dDraws[t.name]&&this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)));if(d!==void 0){const v=t.calculative.rotate;t.calculative.rotate=d,this.rotatePen(t,v-d,t.calculative.worldRect)}(i.image||i.backgroundImage||i.strokeImage)&&(t.calculative.image=void 0,t.calculative.backgroundImage=void 0,t.calculative.strokeImage=void 0,this.loadImage(t)),i.lineGradientColors&&(t.calculative.lineGradient=void 0,t.calculative.gradientColorStop=void 0),i.gradientColors&&(t.calculative.gradient=void 0,t.calculative.radialGradient=void 0),i.gradientRadius&&(t.calculative.gradient=void 0,t.calculative.radialGradient=void 0),i.animateLineWidth&&(t.calculative.gradientAnimatePath=void 0),i.gradientSmooth&&(t.calculative.gradientAnimatePath=void 0),u?(this.canvasImage.init(),this.canvasImageBottom.init()):f&&(t.canvasLayer===void 0&&(t.canvasLayer=CanvasLayer.CanvasImageBottom,t.calculative.canvasLayer=CanvasLayer.CanvasImageBottom),t.canvasLayer===CanvasLayer.CanvasImageBottom?this.canvasImageBottom.init():t.canvasLayer===CanvasLayer.CanvasImage&&this.canvasImage.init()),(i.canvasLayer!==void 0||t.canvasLayer===CanvasLayer.CanvasTemplate)&&this.initTemplateCanvas([t]),i.zIndex!==void 0&&(y=t.calculative.singleton)!=null&&y.div&&setElemPosition(t,t.calculative.singleton.div)}execPenResize(t){var i,s;(i=t.onResize)==null||i.call(t,t),(s=t.children)==null||s.forEach(r=>{const o=this.store.pens[r];o&&this.execPenResize(o)})}setPenRect(t,i,s=!0){if(t.parentId)Object.assign(t,i);else{const{origin:r,scale:o}=this.store.data;t.x=r.x+i.x*o,t.y=r.y+i.y*o,t.width=i.width*o,t.height=i.height*o}this.updatePenRect(t),this.execPenResize(t),s&&this.render()}getPenRect(t,i=this.store.data.origin,s=this.store.data.scale){if(t)return t.parentId?{x:t.x,y:t.y,width:t.width,height:t.height}:{x:(t.x-i.x)/s,y:(t.y-i.y)/s,width:t.width/s,height:t.height/s}}toPng(t=2,i,s=!1,r){const o=getRect$1(this.store.data.pens),n=this.store.data.scale;if(!isFinite(o.width))throw new Error("can not to png, because width is not finite");const c=deepClone(o),a=this.store.data,h=s&&this.store.bkImg;let l=!1,u=!1;if(h){if(o.x+=a.x,o.y+=a.y,calcRightBottom(o),rectInRect(o,this.canvasRect,!0))Object.assign(o,this.canvasRect);else{const I=getRectOfPoints([...rectToPoints(o),...rectToPoints(this.canvasRect)]);Object.assign(o,I)}l=o.x===0,u=o.y===0}const d=this.store.data.width||this.store.options.width,f=this.store.data.height||this.store.options.height;let g=!1;d&&f&&!this.store.data.component&&(g=!0),g&&(o.x=this.store.data.origin.x,o.y=this.store.data.origin.y,o.width=d*this.store.data.scale,o.height=f*this.store.data.scale);const y=deepClone(o),v=formatPadding(t);o.x-=v[3]*n,o.y-=v[0]*n,o.width+=(v[3]+v[1])*n,o.height+=(v[0]+v[2])*n;const b=(r||1920)/o.width;o.width*=b,o.height*=b,calcRightBottom(o);const x=document.createElement("canvas");if(x.width=o.width,x.height=o.height,x.width>32767||x.height>32767||!navigator.userAgent.includes("Firefox")&&x.height*x.width>268435456||navigator.userAgent.includes("Firefox")&&x.height*x.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const m=x.getContext("2d");m.textBaseline="middle",m.scale(b,b);const T=this.store.data.background||this.store.styles.background;if(T&&g&&(m.save(),m.fillStyle=T,m.fillRect(0,0,y.width+(v[1]+v[3])*n,y.height+(v[0]+v[2])*n),m.restore()),h)if(g)m.drawImage(this.store.bkImg,v[3]*n||0,v[0]*n||0,y.width,y.height);else{const I=o.x<0?-o.x:0,P=o.y<0?-o.y:0;m.drawImage(this.store.bkImg,I,P,this.canvasRect.width,this.canvasRect.height)}if(T&&!g)if(h){const I=o.x<0?-o.x:0,P=o.y<0?-o.y:0;m.save(),m.fillStyle=T,m.fillRect(I,P,this.canvasRect.width,this.canvasRect.height),m.restore()}else m.save(),m.fillStyle=T,m.fillRect(0,0,c.width+(v[3]+v[1])*n,c.height+(v[0]+v[2])*n),m.restore();h?g?m.translate(-o.x,-o.y):m.translate((l?a.x:-c.x)+v[3]*n||0,(u?a.y:-c.y)+v[0]*n||0):m.translate(-o.x,-o.y);for(const I of this.store.data.pens){if(!isShowChild(I,this.store)||I.visible==!1||I.name==="combine"&&!I.draw)continue;const{active:P}=I.calculative;I.calculative.active=!1,I.calculative.img?renderPenRaw$1(m,I):renderPen(m,I,!0),I.calculative.active=P}if(i){x.toBlob(i);return}return x.toDataURL()}activeToPng(t=2,i){return this.pensToPng(this.store.active,t,i)}pensToPng(t=this.store.active,i=2,s){if(t.length===0)return;const r=this.getAllByPens(t);let o=r.map(f=>f.id);const n=getRect$1(r);if(!isFinite(n.width))throw new Error("can not to png, because width is not finite");const c=deepClone(n),a=formatPadding(i);n.x-=a[3],n.y-=a[0],n.width+=a[3]+a[1],n.height+=a[0]+a[2],calcRightBottom(n);const h=(s||n.width)/n.width;n.width*=h,n.height*=h;const l=document.createElement("canvas");if(l.width=n.width,l.height=n.height,l.width>32767||l.height>32767||!navigator.userAgent.includes("Firefox")&&l.height*l.width>268435456||navigator.userAgent.includes("Firefox")&&l.height*l.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const u=l.getContext("2d");u.textBaseline="middle",u.scale(h,h);const d=this.store.data.background||this.store.styles.background;d&&(u.save(),u.fillStyle=d,u.fillRect(0,0,c.width+(a[3]+a[1]),c.height+(a[0]+a[2])),u.restore()),u.translate(-c.x+a[3],-c.y+a[0]);for(const f of this.store.data.pens)if(o.includes(f.id)){if(!isShowChild(f,this.store)||f.visible==!1||f.name==="combine"&&!f.draw)continue;const{active:g}=f.calculative;f.calculative.active=!1,f.calculative.img?renderPenRaw$1(u,f):renderPen(u,f),f.calculative.active=g}return l.toDataURL()}toggleAnchorMode(){var t;if(this.hotkeyType)this.hotkeyType===HotkeyType.AddAnchor&&(this.hotkeyType=HotkeyType.None,this.store.hoverAnchor?this.externalElements.style.cursor="vertical-text":this.store.hover&&(this.externalElements.style.cursor="move"));else{if(this.store.options.disableAnchor||(t=this.store.hover)!=null&&t.disableAnchor)return;this.hotkeyType=HotkeyType.AddAnchor,this.store.hover&&(this.externalElements.style.cursor="pointer")}this.patchFlags=!0}addAnchorHand(){if(this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){const t=[deepClone(this.store.active[0],!0)];this.store.activeAnchor.prev?this.store.activeAnchor.next||(this.store.activeAnchor.next={...this.store.activeAnchor.prev},rotatePoint(this.store.activeAnchor.next,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.next||(this.store.activeAnchor.next={penId:this.store.activeAnchor.penId,x:this.store.activeAnchor.x+50,y:this.store.activeAnchor.y}),this.store.activeAnchor.prev={...this.store.activeAnchor.next},rotatePoint(this.store.activeAnchor.prev,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:EditType.Update,pens:[deepClone(this.store.active[0],!0)],initPens:t})}}removeAnchorHand(){if(this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){const t=[deepClone(this.store.active[0],!0)];this.hoverType===HoverType.LineAnchorPrev?(this.store.activeAnchor.prev=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):this.hoverType===HoverType.LineAnchorNext?(this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.prev=void 0,this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:EditType.Update,pens:[deepClone(this.store.active[0])],initPens:t})}}toggleAnchorHand(){this.store.active.length===1&&this.store.active[0].type&&this.store.activeAnchor&&(this.store.activeAnchor.prevNextType||(this.store.activeAnchor.prevNextType=PrevNextType.Mirror),this.store.activeAnchor.prevNextType=(this.store.activeAnchor.prevNextType+1)%3)}gotoView(t,i){let s=getRect$1(this.store.data.pens);if(!isFinite(s.width))throw new Error("can not move view, because width is not finite");const r=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;r&&o&&(s={x:this.store.data.origin.x,y:this.store.data.origin.y,width:r*this.store.data.scale,height:o*this.store.data.scale}),this.store.data.x=this.canvas.clientWidth/2-t*s.width-s.x,this.store.data.y=this.canvas.clientHeight/2-i*s.height-s.y,this.onMovePens(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()}showMagnifier(){this.magnifierCanvas.canvas.style.zIndex="100",this.externalElements.style.zIndex="101",this.magnifierCanvas.magnifier=!0,this.magnifierCanvas.updateDomOffscreen(),this.externalElements.style.cursor="default",this.render()}hideMagnifier(){this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.zIndex="5",this.magnifierCanvas.magnifier=!1,this.externalElements.style.cursor="default",this.magnifierCanvas.render(),this.render()}showFit(){this.store.data.locked=0,this.canvasImage.fitFlag=!0,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach(t=>t.active=!1),this.canvasImage.init(),this.canvasImage.render()}hideFit(){this.canvasImage.fitFlag=!1,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.canvasImage.init(),this.canvasImage.render()}makeFit(){if(this.dragRect.width<100&&this.dragRect.height<100)return;const t=this.store.data.pens.filter(h=>{if(h.parentId||h.isRuleLine)return!1;if(rectInRect(h.calculative.worldRect,this.dragRect,!0))return h.type===PenType.Line&&!this.store.options.dragAllIn?lineInRect(h,this.dragRect):!0});if(!t.length)return;const i=this.parent.getRect(t),s=this.store.data.scale,r=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;let n=(Math.floor(i.x)-this.store.data.origin.x)/s/r,c=(Math.floor(i.y)-this.store.data.origin.y)/s/o,a={x:n,y:c,width:(Math.ceil(i.width)+1)/s/r,height:(Math.ceil(i.height)+1)/s/o,children:t.map(h=>h.id),id:s8(),active:!0};a.x<-.1&&(a.x=-.1),a.y<-.1&&(a.y=-.1),a.width>.5?(a.left=!0,a.right=!0,a.leftValue=(a.x-0)*s*r,a.rightValue=(1-(a.x+a.width))*s*r):a.x<.5?(a.left=!0,a.leftValue=(a.x-0)*s*r):(a.right=!0,a.rightValue=(1-(a.x+a.width))*s*r),a.leftValue<1&&(a.leftValue=0),a.rightValue<1&&(a.rightValue=0),a.height>.5?(a.top=!0,a.bottom=!0,a.topValue=(a.y-0)*s*o,a.bottomValue=(1-(a.y+a.height))*s*o):a.y<.5?(a.top=!0,a.topValue=(a.y-0)*s*o):(a.bottom=!0,a.bottomValue=(1-(a.y+a.height))*s*o),a.topValue<1&&(a.topValue=0),a.bottomValue<1&&(a.bottomValue=0),this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach(h=>{h.active=!1}),this.store.data.fits.push(a),this.canvasImage.activeFit=a,this.store.emitter.emit("fit",a),this.canvasImage.init(),this.canvasImage.render()}updateFit(t){const i=this.store.data.scale,s=this.store.data.width||this.store.options.width,r=this.store.data.height||this.store.options.height;let o=(t.x-this.store.data.origin.x)/i/s,n=(t.y-this.store.data.origin.y)/i/r;if(this.canvasImage.currentFit){const c=this.canvasImage.activeFit;if(this.canvasImage.currentFit==="top"){n<-.1&&(n=-.1);let l=n-c.y;if(c.height-=l,c.height<.01){c.height=.01;return}c.y=n}if(this.canvasImage.currentFit==="bottom"&&(n>1.1&&(n=1.1),c.height=n-c.y,c.height<=.01&&(c.height=.01)),this.canvasImage.currentFit==="left"){o<-.1&&(o=-.1);let l=o-c.x;if(c.width-=l,c.width<.01){c.width=.01;return}c.x=o}this.canvasImage.currentFit==="right"&&(o>1.1&&(o=1.1),c.width=o-c.x,c.width<=.01&&(c.width=.01));let a={x:c.x*s*i+this.store.data.origin.x,y:c.y*r*i+this.store.data.origin.y,width:c.width*s*i,height:c.height*r*i};calcRightBottom(a);const h=this.store.data.pens.filter(l=>{if(l.parentId||l.isRuleLine)return!1;if(rectInRect(l.calculative.worldRect,a,!0))return l.type===PenType.Line&&!this.store.options.dragAllIn?lineInRect(l,a):!0});c.left=void 0,c.leftValue=void 0,c.right=void 0,c.rightValue=void 0,c.top=void 0,c.topValue=void 0,c.bottom=void 0,c.bottomValue=void 0,c.width>.5?(c.left=!0,c.right=!0,c.leftValue=(c.x-0)*i*s,c.rightValue=(1-(c.x+c.width))*i*s):c.x<.5?(c.left=!0,c.leftValue=(c.x-0)*i*s):(c.right=!0,c.rightValue=(1-(c.x+c.width))*i*s),Math.abs(c.leftValue)<1&&(c.leftValue=0),Math.abs(c.rightValue)<1&&(c.rightValue=0),c.height>.5?(c.top=!0,c.bottom=!0,c.topValue=(c.y-0)*i*r,c.bottomValue=(1-(c.y+c.height))*i*r):c.y<.5?(c.top=!0,c.topValue=(c.y-0)*i*r):(c.bottom=!0,c.bottomValue=(1-(c.y+c.height))*i*r),Math.abs(c.topValue)<1&&(c.topValue=0),Math.abs(c.bottomValue)<1&&(c.bottomValue=0),c.children=h.map(l=>l.id),this.store.emitter.emit("fit",c),this.mouseDown.x=t.x,this.mouseDown.y=t.y,this.canvasImage.init(),this.canvasImage.render()}}updateFitRect(t=this.canvasImage.activeFit){const i=this.store.data.width||this.store.options.width,s=this.store.data.height||this.store.options.height;t.left&&(t.leftValue?t.x=Math.abs(t.leftValue)<1?t.leftValue:t.leftValue/i:t.x=0),t.right&&(t.rightValue?t.width=1-(Math.abs(t.rightValue)<1?t.rightValue:t.rightValue/i)-t.x:t.width=1-t.x),t.top&&(t.topValue?t.y=Math.abs(t.topValue)<1?t.topValue:t.topValue/s:t.y=0),t.bottom&&(t.bottomValue?t.height=1-(Math.abs(t.bottomValue)<1?t.bottomValue:t.bottomValue/s)-t.y:t.height=1-t.y),this.canvasImage.init(),this.canvasImage.render()}deleteFit(t=this.canvasImage.activeFit){if(!t)return;const i=this.store.data.fits.findIndex(s=>s.id===t.id);this.store.data.fits.splice(i,1),this.canvasImage.activeFit=void 0,this.canvasImage.init(),this.canvasImage.render(),this.store.emitter.emit("fit",void 0)}calcuActiveFit(){var c;const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;let s=(this.mouseDown.x-this.store.data.origin.x)/this.store.data.scale/t,r=(this.mouseDown.y-this.store.data.origin.y)/this.store.data.scale/i,o=-1,n=-1;(c=this.store.data.fits)==null||c.forEach((a,h)=>{a.ex=null,a.ey=null,pointInRect({x:s,y:r},a)&&(o=h),a.active&&(n=h)}),o!==-1&&o!==n?(this.canvasImage.activeFit=this.store.data.fits[o],this.store.data.fits[o].active=!0,n!==-1&&(this.store.data.fits[n].active=!1),this.store.emitter.emit("fit",this.store.data.fits[o])):o===-1&&n!==-1&&(this.store.data.fits[n].active=!1,this.store.emitter.emit("fit",void 0),this.canvasImage.activeFit=null),this.inactive(),this.canvasImage.init(),this.canvasImage.render()}toggleMagnifier(){this.magnifierCanvas.magnifier=!this.magnifierCanvas.magnifier,this.magnifierCanvas.magnifier&&(this.externalElements.style.cursor="default"),this.render()}destroy(){var t,i,s,r;switch(this.scroll&&this.scroll.destroy(),(t=this.tooltip)==null||t.destroy(),(i=this.dialog)==null||i.destroy(),(s=this.title)==null||s.destroy(),(r=this.popconfirm)==null||r.destroy(),this.externalElements.removeEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=o=>o.preventDefault(),this.externalElements.ondrop=void 0,this.externalElements.ontouchstart=void 0,this.externalElements.ontouchmove=void 0,this.externalElements.ontouchend=void 0,this.externalElements.onmousedown=void 0,this.externalElements.onmousemove=void 0,this.externalElements.onmouseup=void 0,this.externalElements.onmouseleave=void 0,this.externalElements.ondblclick=void 0,this.store.options.keydown){case KeydownType.Document:document.removeEventListener("keydown",this.onkeydown),document.removeEventListener("keyup",this.onkeyup);break;case KeydownType.Canvas:this.externalElements.removeEventListener("keydown",this.onkeydown),this.externalElements.removeEventListener("keyup",this.onkeyup);break}document.removeEventListener("copy",this.onCopy),document.removeEventListener("cut",this.onCut),document.removeEventListener("paste",this.onPaste),window&&window.removeEventListener("message",this.onMessage),window&&window.removeEventListener("resize",this.onResize),window&&window.removeEventListener("scroll",this.onScroll),this.parentElement.innerHTML=""}}function form(e,t){const i=t||new Path2D;e.onDestroy||(e.onDestroy=destory$1,e.onMove=move$1,e.onRotate=move$1,e.onMouseEnter=mouseEnter,e.onMouseLeave=mouseLeave,e.onMouseMove=mouseMove,e.onMouseUp=mouseUp,e.onInput=input),e.formId=e.id;let s=e.calculative.borderRadius||0,r=s;const{x:o,y:n,width:c,height:a,ex:h,ey:l}=e.calculative.worldRect;e.calculative.worldTextRect,s<1&&(s=c*s,r=a*r);let u=s<r?s:r;if(c<2*u&&(u=c/2),a<2*u&&(u=a/2),i.moveTo(o+u,n),i.arcTo(h,n,h,l,u),i.arcTo(h,l,o,l,u),i.arcTo(o,l,o,n,u),i.arcTo(o,n,h,n,u),i instanceof Path2D)return i}function input(e,t){e.text=t,e.calculative.text=e.text,e.calculative.canvas.updatePenRect(e)}function destory$1(e){}function move$1(e){}function mouseEnter(e){}function mouseLeave(e){const t=e.calculative.canvas.store.active;t&&t.length&&t.forEach(i=>{if(e.followers){let s=e.followers.findIndex(r=>r===i.id);if(s!==-1){const r=e.calculative.canvas.store.pens[i.id+movingSuffix];r&&r.calculative&&(rectInRect(r.calculative.worldRect,e.calculative.worldRect,!0)||(e.followers.splice(s,1),delete i.formId))}}})}function mouseUp(e){const t=e.calculative.canvas.store.active;t&&t.length&&t.forEach(i=>{const s=e.calculative.canvas.store.pens[i.id+movingSuffix];if(s&&s.calculative){let r=deepClone(e.calculative.worldRect);r.x-=1,r.y-=1,r.width+=2,r.height+=2,rectInRect(s.calculative.worldRect,r,!0)&&(e.followers||(e.followers=[]),e.followers.includes(i.id)||e.followers.push(i.id),i.formId=e.id)}})}function mouseMove(e,t){}function updateFormData(e,t){if(e.formId&&e.formKey&&e.formValue){const i=e.calculative.canvas.store.pens[e.formId];i&&(i.formData||(i.formData={}),i.formData[e.formKey]=e[e.formValue])}}function reset(e){const t=e.calculative.canvas.store.pens[e.formId];t.followers.forEach(i=>{const s=e.calculative.canvas.store.pens[i];if(s.formId&&s.formKey&&t.formData[s.formKey]){const r=s[s.formValue];let o="";Array.isArray(r)&&(o=[]),e.calculative.canvas.parent.setValue({id:s.id,[s.formValue]:o},{render:!1,doEvent:!1,history:!1})}}),t.formData={},e.calculative.canvas.parent.render()}const gifsList={};function gif(e){e.onDestroy||(e.onDestroy=destory,e.onMove=move,e.onResize=resize$1,e.onRotate=move,e.onValue=value$1,e.onChangeId=changeId);const t=new Path2D;if(!e.image)return;const s=e.calculative.canvas.store.id+"-"+e.id;if(!gifsList[s]){const r=new Image;r.crossOrigin="anonymous",r.src=e.image,e.calculative.canvas.parent.store.options.cdn&&!(e.image.startsWith("http")||e.image.startsWith("//")||e.image.startsWith("data:image"))&&(r.src=e.calculative.canvas.parent.store.options.cdn+e.image),gifsList[s]=r,r.onload=()=>{var o;gifsList[s]===r&&(e.calculative.img=r,e.calculative.imgNaturalWidth=r.naturalWidth||e.iconWidth,e.calculative.imgNaturalHeight=r.naturalHeight||e.iconHeight,(o=e.calculative.canvas.externalElements)==null||o.parentElement.appendChild(r),setImagePosition(e,r))}}return e.calculative.patchFlags&&gifsList[s]&&setImagePosition(e,gifsList[s]),t}function destory(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&(gifsList[i].remove(),gifsList[i]=void 0)}function move(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&setImagePosition(e,gifsList[i])}function resize$1(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&setImagePosition(e,gifsList[i])}function value$1(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&(setImagePosition(e,gifsList[i]),gifsList[i].getAttribute("src")!==e.image&&(gifsList[i].src=e.image))}function changeId(e,t,i){const s=e.calculative.canvas.store.id;gifsList[s+"-"+t]&&(gifsList[s+"-"+i]=gifsList[s+"-"+t],delete gifsList[s+"-"+t])}function setImagePosition(e,t){t.style.objectFit=e.imageRatio?"contain":"fill",setElemPosition(e,t)}function mindNode(e,t){return e.onResize||(e.onResize=resize,e.onValue=value),rectangle(e,t)}function resize(e){const t=e.anchors.filter(i=>i.flag!==1);mindNodeAnchors(e),e.anchors=e.anchors.concat(...t)}function value(e){resize(e),calcWorldAnchors(e)}function mindNodeAnchors(e){const t=[],{x:i,y:s,width:r,height:o}=e,n=borderRadius(e),c=5;for(let u=0;u<c;u++){if(u===2)continue;let d=i+r*(u+1)/(c+1),f=s;d<i+n?f=getYByCircle(i+n,f+n,d,n,-1):d>i+r-n&&(f=getYByCircle(i+r-n,f+n,d,n,-1)),t.push({id:String(t.length),flag:1,penId:e.id,x:(d-i)/r,y:(f-s)/o})}const a=3;for(let u=0;u<a;u++){let d=s+o*(u+1)/(a+1),f=i+r;d<s+n?f=getXByCircle(f-n,s+n,d,n):d>s+o-n&&(f=getXByCircle(f-n,s+o-n,d,n)),t.push({id:String(t.length),flag:1,penId:e.id,x:(f-i)/r,y:(d-s)/o})}const h=5;for(let u=0;u<h;u++){if(u===2)continue;let d=i+r*(u+1)/(h+1),f=s+o;d<i+n?f=getYByCircle(i+n,f-n,d,n):d>i+r-n&&(f=getYByCircle(i+r-n,f-n,d,n)),t.push({id:String(t.length),flag:1,penId:e.id,x:(d-i)/r,y:(f-s)/o})}const l=3;for(let u=0;u<l;u++){let d=s+o*(u+1)/(l+1),f=i;d<s+n?f=getXByCircle(f+n,s+n,d,n,-1):d>s+o-n&&(f=getXByCircle(f+n,s+o-n,d,n,-1)),t.push({id:String(t.length),flag:1,penId:e.id,x:(f-i)/r,y:(d-s)/o})}e.anchors=t}function borderRadius(e){let t=e.calculative.borderRadius||0,i=e.calculative.borderRadius||0;const{width:s,height:r}=e;e.calculative.borderRadius<1&&(t=s*e.calculative.borderRadius,i=r*e.calculative.borderRadius);let o=t<i?t:i;return s<2*o&&(o=s/2),r<2*o&&(o=r/2),o}function getXByCircle(e,t,i,s,r=1){return r*Math.sqrt(s**2-(i-t)**2)+e}function getYByCircle(e,t,i,s,r=1){return r*Math.sqrt(s**2-(i-e)**2)+t}function mindLine(e,t){const i=t||new Path2D,{x:s,y:r,width:o,height:n}=e.calculative.worldRect;if(i.moveTo(s,r+n),i.lineTo(s+o,r+n),i.closePath(),i instanceof Path2D)return i}function mindLineAnchors(e){const t=[{x:0,y:1},{x:1,y:1}];e.anchors=t.map(({x:i,y:s},r)=>({id:r+"",x:i,y:s,penId:e.id}))}function commonPens(){return{rectangle,square,circle,svgPath,diamond,triangle,pentagon,pentagram,hexagon,leftArrow,rightArrow,twowayArrow,message,cloud,file,people,line,iframe,video,gif,mindNode,mindLine,mindNode2:rectangle,form,combine:rectangle}}function commonAnchors(){return{triangle:triangleAnchors,pentagon:pentagonAnchors,pentagram:pentagramAnchors,mindNode:mindNodeAnchors,mindLine:mindLineAnchors}}var EventAction;(function(e){e[e.Link=0]="Link",e[e.SetProps=1]="SetProps",e[e.StartAnimate=2]="StartAnimate",e[e.PauseAnimate=3]="PauseAnimate",e[e.StopAnimate=4]="StopAnimate",e[e.JS=5]="JS",e[e.GlobalFn=6]="GlobalFn",e[e.Emit=7]="Emit",e[e.StartVideo=8]="StartVideo",e[e.PauseVideo=9]="PauseVideo",e[e.StopVideo=10]="StopVideo",e[e.SendPropData=11]="SendPropData",e[e.SendVarData=12]="SendVarData",e[e.Navigator=13]="Navigator",e[e.Dialog=14]="Dialog",e[e.SendData=15]="SendData",e[e.PostMessage=16]="PostMessage",e[e.PostMessageToParent=17]="PostMessageToParent",e[e.Message=18]="Message"})(EventAction||(EventAction={}));class ViewMap{constructor(t){D(this,"parent");D(this,"box");D(this,"boxWidth",320);D(this,"boxHeight",180);D(this,"ratio",this.boxWidth/this.boxHeight);D(this,"padding",5);D(this,"img");D(this,"isShow");D(this,"isDown");D(this,"view");D(this,"timer");D(this,"onMouseDown",t=>{t.preventDefault(),t.stopPropagation(),this.isDown=!0});D(this,"onMouseMove",t=>{if(t.preventDefault(),t.stopPropagation(),this.isDown)try{this.parent.gotoView(t.offsetX/this.box.clientWidth,t.offsetY/this.box.clientHeight)}catch(i){console.warn(i.message),this.isDown=!1}});D(this,"onMouseUp",t=>{t.preventDefault(),t.stopPropagation();try{this.parent.gotoView(t.offsetX/this.box.clientWidth,t.offsetY/this.box.clientHeight)}catch(i){console.warn(i.message)}finally{this.isDown=!1}});D(this,"onWheel",t=>{let i=.015;if(this.parent.store.options.scaleOff)i=this.parent.store.options.scaleOff,t.deltaY>0&&(i=-this.parent.store.options.scaleOff);else if(/mac os /i.test(navigator.userAgent))t.ctrlKey?t.deltaY>0&&(i*=-1):i*=t.wheelDeltaY/240;else{let a=.2;t.deltaY.toString().indexOf(".")!==-1&&(a=.01),t.deltaY>0?i=-a:i=a}let{offsetX:s,offsetY:r}=t;const o=this.parent.store.data.width||this.parent.store.options.width,n=this.parent.store.data.height||this.parent.store.options.height;if(o&&n)s=s/this.boxWidth*o*this.parent.store.data.scale+this.parent.store.data.origin.x+this.parent.store.data.x,r=r/this.boxHeight*n*this.parent.store.data.scale+this.parent.store.data.origin.y+this.parent.store.data.y;else{const c=this.parent.parent.getRect();s=s/this.boxWidth*c.width+c.x+this.parent.store.data.x,r=r/this.boxHeight*c.height+c.y+this.parent.store.data.y}this.parent.scale(this.parent.store.data.scale+i,{x:s,y:r})});var s;this.parent=t,this.box=document.createElement("div"),this.img=new Image,this.view=document.createElement("div"),this.box.appendChild(this.img),this.box.appendChild(this.view),(s=this.parent.externalElements)==null||s.parentElement.appendChild(this.box),this.box.className="meta2d-map",this.box.onmousedown=this.onMouseDown,this.box.onmousemove=this.onMouseMove,this.box.onmouseup=this.onMouseUp,this.box.onwheel=this.onWheel;let i;for(let r=0;r<document.styleSheets.length;r++)document.styleSheets[r].title==="le5le/map"&&(i=document.styleSheets[r]);if(!i){let r=document.createElement("style");r.type="text/css",r.title="le5le.com/map",document.head.appendChild(r),r=document.createElement("style"),r.type="text/css",document.head.appendChild(r),i=r.sheet,i.insertRule(`.meta2d-map{display:flex;width:${this.boxWidth+2*this.padding}px;height:${this.boxHeight+2*this.padding}px;padding:${this.padding}px;background:#f4f4f4;border:1px solid #ffffff;box-shadow: 0px 0px 14px 0px rgba(0,10,38,0.30);border-radius:8px;position:absolute;z-index:9999;right:0;bottom:0;justify-content:center;align-items:center;cursor:default;user-select:none;overflow: hidden;}`),i.insertRule(".meta2d-map img{max-width:100%;max-height:100%;pointer-events: none;}"),i.insertRule(".meta2d-map div{pointer-events: none;border:1px solid #1890ff;position:absolute}")}}show(){this.box.style.display="flex",this.parent.store.data.pens.length?(this.img.style.display="block",this.img.src=this.parent.toPng(0,void 0,!0),this.setView()):this.img.style.display="none",this.isShow=!0}hide(){this.box.style.display="none",this.isShow=!1}setView(){const t=this.parent.store.data;if(t.pens.length){let i=getRect$1(t.pens);const s=this.parent.store.data.width||this.parent.store.options.width,r=this.parent.store.data.height||this.parent.store.options.height;if(s&&r?i={x:this.parent.store.data.origin.x,y:this.parent.store.data.origin.y,width:s*this.parent.store.data.scale,height:r*this.parent.store.data.scale}:(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.parent.store.bkImg&&(this.img.src=this.parent.toPng(0,void 0,!0))},300)),translateRect(i,t.x,t.y),i.width/i.height>this.ratio){const u=i.width/this.ratio;i.y-=(u-i.height)/2,i.height=u,calcRightBottom(i)}else{const u=i.height*this.ratio;i.x-=(u-i.width)/2,i.width=u,calcRightBottom(i)}const n=this.parent.canvasRect;let c=0,a=0;if(i.x<0)c=-i.x/i.width;else if(i.x+i.width>n.width){let u=0;n.width>i.width&&(u=n.width-i.width),c=(-i.x+u)/i.width}if(i.y<0)a=-i.y/i.height;else if(i.y+i.height>n.height){let u=0;n.height>i.height&&(u=n.height-i.height),a=(-i.y+u)/i.height}const h=n.width>i.width?1:n.width/i.width,l=n.height>i.height?1:n.height/i.height;this.view.style.left=this.padding+c*this.boxWidth+"px",this.view.style.width=h*this.boxWidth+"px",this.view.style.top=this.padding+a*this.boxHeight+"px",this.view.style.height=l*this.boxHeight+"px"}}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function commonjsRequire(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var mqtt_min={exports:{}};(function(e,t){(function(i){e.exports=i()})(function(){return function(){return function i(s,r,o){function n(h,l){if(!r[h]){if(!s[h]){var u=typeof commonjsRequire=="function"&&commonjsRequire;if(!l&&u)return u(h,!0);if(c)return c(h,!0);var d=new Error("Cannot find module '"+h+"'");throw d.code="MODULE_NOT_FOUND",d}var f=r[h]={exports:{}};s[h][0].call(f.exports,function(g){return n(s[h][1][g]||g)},f,f.exports,i,s,r,o)}return r[h].exports}for(var c=typeof commonjsRequire=="function"&&commonjsRequire,a=0;a<o.length;a++)n(o[a]);return n}}()({1:[function(i,s,r){(function(o,n){(function(){const c=i("events").EventEmitter,a=i("./store"),h=i("./topic-alias-recv"),l=i("./topic-alias-send"),u=i("mqtt-packet"),d=i("./default-message-id-provider"),f=i("readable-stream").Writable,g=i("inherits"),y=i("reinterval"),v=i("rfdc/default"),b=i("./validations"),x=i("xtend"),m=i("debug")("mqttjs:client"),T=o?o.nextTick:function(R){setTimeout(R,0)},I=n.setImmediate||function(R){T(R)},P={keepalive:60,reschedulePings:!0,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,connectTimeout:3e4,clean:!0,resubscribe:!0},E={0:"",1:"Unacceptable protocol version",2:"Identifier rejected",3:"Server unavailable",4:"Bad username or password",5:"Not authorized",16:"No matching subscribers",17:"No subscription existed",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",132:"Unsupported Protocol Version",133:"Client Identifier not valid",134:"Bad User Name or Password",135:"Not authorized",136:"Server unavailable",137:"Server busy",138:"Banned",139:"Server shutting down",140:"Bad authentication method",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",145:"Packet identifier in use",146:"Packet Identifier not found",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"};function _(R,S){let N;S.properties&&(N=S.properties.topicAlias);let H=S.topic.toString();if(H.length===0){if(N===void 0)return new Error("Unregistered Topic Alias");if((H=R.topicAliasSend.getTopicByAlias(N))===void 0)return new Error("Unregistered Topic Alias");S.topic=H}N&&delete S.properties.topicAlias}function W(R,S,N){m("sendPacket :: packet: %O",S),m("sendPacket :: emitting `packetsend`"),R.emit("packetsend",S),m("sendPacket :: writing to stream");const H=u.writeToStream(S,R.stream,R.options);m("sendPacket :: writeToStream result %s",H),!H&&N&&N!==C?(m("sendPacket :: handle events on `drain` once through callback."),R.stream.once("drain",N)):N&&(m("sendPacket :: invoking cb"),N())}function Y(R,S,N,H){m("storeAndSend :: store packet with cmd %s to outgoingStore",S.cmd);let K,F=S;if(F.cmd==="publish"&&(F=v(S),K=_(R,F)))return N&&N(K);R.outgoingStore.put(F,function(L){if(L)return N&&N(L);H(),W(R,S,N)})}function C(R){m("nop ::",R)}function k(R,S){let N;const H=this;if(!(this instanceof k))return new k(R,S);for(N in this.options=S||{},P)this.options[N]===void 0?this.options[N]=P[N]:this.options[N]=S[N];m("MqttClient :: options.protocol",S.protocol),m("MqttClient :: options.protocolVersion",S.protocolVersion),m("MqttClient :: options.username",S.username),m("MqttClient :: options.keepalive",S.keepalive),m("MqttClient :: options.reconnectPeriod",S.reconnectPeriod),m("MqttClient :: options.rejectUnauthorized",S.rejectUnauthorized),m("MqttClient :: options.topicAliasMaximum",S.topicAliasMaximum),this.options.clientId=typeof S.clientId=="string"?S.clientId:"mqttjs_"+Math.random().toString(16).substr(2,8),m("MqttClient :: clientId",this.options.clientId),this.options.customHandleAcks=S.protocolVersion===5&&S.customHandleAcks?S.customHandleAcks:function(){arguments[3](0)},this.streamBuilder=R,this.messageIdProvider=this.options.messageIdProvider===void 0?new d:this.options.messageIdProvider,this.outgoingStore=S.outgoingStore||new a,this.incomingStore=S.incomingStore||new a,this.queueQoSZero=S.queueQoSZero===void 0||S.queueQoSZero,this._resubscribeTopics={},this.messageIdToTopic={},this.pingTimer=null,this.connected=!1,this.disconnecting=!1,this.queue=[],this.connackTimer=null,this.reconnectTimer=null,this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={},this._storeProcessingQueue=[],this.outgoing={},this._firstConnection=!0,S.topicAliasMaximum>0&&(S.topicAliasMaximum>65535?m("MqttClient :: options.topicAliasMaximum is out of range"):this.topicAliasRecv=new h(S.topicAliasMaximum)),this.on("connect",function(){const K=this.queue;m("connect :: sending queued packets"),function F(){const L=K.shift();m("deliver :: entry %o",L);let O=null;if(!L)return void H._resubscribe();O=L.packet,m("deliver :: call _sendPacket for %o",O);let z=!0;O.messageId&&O.messageId!==0&&(H.messageIdProvider.register(O.messageId)||(z=!1)),z?H._sendPacket(O,function(B){L.cb&&L.cb(B),F()}):(m("messageId: %d has already used. The message is skipped and removed.",O.messageId),F())}()}),this.on("close",function(){m("close :: connected set to `false`"),this.connected=!1,m("close :: clearing connackTimer"),clearTimeout(this.connackTimer),m("close :: clearing ping timer"),H.pingTimer!==null&&(H.pingTimer.clear(),H.pingTimer=null),this.topicAliasRecv&&this.topicAliasRecv.clear(),m("close :: calling _setupReconnect"),this._setupReconnect()}),c.call(this),m("MqttClient :: setting up stream"),this._setupStream()}g(k,c),k.prototype._setupStream=function(){const R=this,S=new f,N=u.parser(this.options);let H=null;const K=[];function F(){if(K.length)T(L);else{const z=H;H=null,z()}}function L(){m("work :: getting next packet in queue");const z=K.shift();if(z)m("work :: packet pulled from queue"),R._handlePacket(z,F);else{m("work :: no packets in queue");const B=H;H=null,m("work :: done flag is %s",!!B),B&&B()}}m("_setupStream :: calling method to clear reconnect"),this._clearReconnect(),m("_setupStream :: using streamBuilder provided to client to create stream"),this.stream=this.streamBuilder(this),N.on("packet",function(z){m("parser :: on packet push to packets array."),K.push(z)}),S._write=function(z,B,U){H=U,m("writable stream :: parsing buffer"),N.parse(z),L()},m("_setupStream :: pipe stream to writable stream"),this.stream.pipe(S),this.stream.on("error",function(z){m("streamErrorHandler :: error",z.message),z.code?(m("streamErrorHandler :: emitting error"),R.emit("error",z)):C(z)}),this.stream.on("close",function(){var z;m("(%s)stream :: on close",R.options.clientId),(z=R.outgoing)&&(m("flushVolatile :: deleting volatile messages from the queue and setting their callbacks as error function"),Object.keys(z).forEach(function(B){z[B].volatile&&typeof z[B].cb=="function"&&(z[B].cb(new Error("Connection closed")),delete z[B])})),m("stream: emit close to MqttClient"),R.emit("close")}),m("_setupStream: sending packet `connect`");const O=Object.create(this.options);if(O.cmd="connect",this.topicAliasRecv&&(O.properties||(O.properties={}),this.topicAliasRecv&&(O.properties.topicAliasMaximum=this.topicAliasRecv.max)),W(this,O),N.on("error",this.emit.bind(this,"error")),this.options.properties){if(!this.options.properties.authenticationMethod&&this.options.properties.authenticationData)return R.end(()=>this.emit("error",new Error("Packet has no Authentication Method"))),this;this.options.properties.authenticationMethod&&this.options.authPacket&&typeof this.options.authPacket=="object"&&W(this,x({cmd:"auth",reasonCode:0},this.options.authPacket))}this.stream.setMaxListeners(1e3),clearTimeout(this.connackTimer),this.connackTimer=setTimeout(function(){m("!!connectTimeout hit!! Calling _cleanUp with force `true`"),R._cleanUp(!0)},this.options.connectTimeout)},k.prototype._handlePacket=function(R,S){const N=this.options;if(N.protocolVersion===5&&N.properties&&N.properties.maximumPacketSize&&N.properties.maximumPacketSize<R.length)return this.emit("error",new Error("exceeding packets size "+R.cmd)),this.end({reasonCode:149,properties:{reasonString:"Maximum packet size was exceeded"}}),this;switch(m("_handlePacket :: emitting packetreceive"),this.emit("packetreceive",R),R.cmd){case"publish":this._handlePublish(R,S);break;case"puback":case"pubrec":case"pubcomp":case"suback":case"unsuback":this._handleAck(R),S();break;case"pubrel":this._handlePubrel(R,S);break;case"connack":this._handleConnack(R),S();break;case"auth":this._handleAuth(R),S();break;case"pingresp":this._handlePingresp(R),S();break;case"disconnect":this._handleDisconnect(R),S()}},k.prototype._checkDisconnecting=function(R){return this.disconnecting&&(R&&R!==C?R(new Error("client disconnecting")):this.emit("error",new Error("client disconnecting"))),this.disconnecting},k.prototype.publish=function(R,S,N,H){m("publish :: message `%s` to topic `%s`",S,R);const K=this.options;if(typeof N=="function"&&(H=N,N=null),N=x({qos:0,retain:!1,dup:!1},N),this._checkDisconnecting(H))return this;const F=this,L=function(){let O=0;if((N.qos===1||N.qos===2)&&(O=F._nextId())===null)return m("No messageId left"),!1;const z={cmd:"publish",topic:R,payload:S,qos:N.qos,retain:N.retain,messageId:O,dup:N.dup};switch(K.protocolVersion===5&&(z.properties=N.properties),m("publish :: qos",N.qos),N.qos){case 1:case 2:F.outgoing[z.messageId]={volatile:!1,cb:H||C},m("MqttClient:publish: packet cmd: %s",z.cmd),F._sendPacket(z,void 0,N.cbStorePut);break;default:m("MqttClient:publish: packet cmd: %s",z.cmd),F._sendPacket(z,H,N.cbStorePut)}return!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!L())&&this._storeProcessingQueue.push({invoke:L,cbStorePut:N.cbStorePut,callback:H}),this},k.prototype.subscribe=function(){const R=this,S=new Array(arguments.length);for(let $=0;$<arguments.length;$++)S[$]=arguments[$];const N=[];let H=S.shift();const K=H.resubscribe;let F=S.pop()||C,L=S.pop();const O=this.options.protocolVersion;delete H.resubscribe,typeof H=="string"&&(H=[H]),typeof F!="function"&&(L=F,F=C);const z=b.validateTopics(H);if(z!==null)return I(F,new Error("Invalid topic "+z)),this;if(this._checkDisconnecting(F))return m("subscribe: discconecting true"),this;const B={qos:0};if(O===5&&(B.nl=!1,B.rap=!1,B.rh=0),L=x(B,L),Array.isArray(H)?H.forEach(function($){if(m("subscribe: array topic %s",$),!Object.prototype.hasOwnProperty.call(R._resubscribeTopics,$)||R._resubscribeTopics[$].qos<L.qos||K){const q={topic:$,qos:L.qos};O===5&&(q.nl=L.nl,q.rap=L.rap,q.rh=L.rh,q.properties=L.properties),m("subscribe: pushing topic `%s` and qos `%s` to subs list",q.topic,q.qos),N.push(q)}}):Object.keys(H).forEach(function($){if(m("subscribe: object topic %s",$),!Object.prototype.hasOwnProperty.call(R._resubscribeTopics,$)||R._resubscribeTopics[$].qos<H[$].qos||K){const q={topic:$,qos:H[$].qos};O===5&&(q.nl=H[$].nl,q.rap=H[$].rap,q.rh=H[$].rh,q.properties=L.properties),m("subscribe: pushing `%s` to subs list",q),N.push(q)}}),!N.length)return F(null,[]),this;const U=function(){const $=R._nextId();if($===null)return m("No messageId left"),!1;const q={cmd:"subscribe",subscriptions:N,qos:1,retain:!1,dup:!1,messageId:$};if(L.properties&&(q.properties=L.properties),R.options.resubscribe){m("subscribe :: resubscribe true");const Q=[];N.forEach(function(X){if(R.options.reconnectPeriod>0){const J={qos:X.qos};O===5&&(J.nl=X.nl||!1,J.rap=X.rap||!1,J.rh=X.rh||0,J.properties=X.properties),R._resubscribeTopics[X.topic]=J,Q.push(X.topic)}}),R.messageIdToTopic[q.messageId]=Q}return R.outgoing[q.messageId]={volatile:!0,cb:function(Q,X){if(!Q){const J=X.granted;for(let p=0;p<J.length;p+=1)N[p].qos=J[p]}F(Q,N)}},m("subscribe :: call _sendPacket"),R._sendPacket(q),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!U())&&this._storeProcessingQueue.push({invoke:U,callback:F}),this},k.prototype.unsubscribe=function(){const R=this,S=new Array(arguments.length);for(let O=0;O<arguments.length;O++)S[O]=arguments[O];let N=S.shift(),H=S.pop()||C,K=S.pop();typeof N=="string"&&(N=[N]),typeof H!="function"&&(K=H,H=C);const F=b.validateTopics(N);if(F!==null)return I(H,new Error("Invalid topic "+F)),this;if(R._checkDisconnecting(H))return this;const L=function(){const O=R._nextId();if(O===null)return m("No messageId left"),!1;const z={cmd:"unsubscribe",qos:1,messageId:O};return typeof N=="string"?z.unsubscriptions=[N]:Array.isArray(N)&&(z.unsubscriptions=N),R.options.resubscribe&&z.unsubscriptions.forEach(function(B){delete R._resubscribeTopics[B]}),typeof K=="object"&&K.properties&&(z.properties=K.properties),R.outgoing[z.messageId]={volatile:!0,cb:H},m("unsubscribe: call _sendPacket"),R._sendPacket(z),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!L())&&this._storeProcessingQueue.push({invoke:L,callback:H}),this},k.prototype.end=function(R,S,N){const H=this;function K(){m("end :: (%s) :: finish :: calling _cleanUp with force %s",H.options.clientId,R),H._cleanUp(R,()=>{m("end :: finish :: calling process.nextTick on closeStores"),T((function(){m("end :: closeStores: closing incoming and outgoing stores"),H.disconnected=!0,H.incomingStore.close(function(F){H.outgoingStore.close(function(L){if(m("end :: closeStores: emitting end"),H.emit("end"),N){const O=F||L;m("end :: closeStores: invoking callback with args"),N(O)}})}),H._deferredReconnect&&H._deferredReconnect()}).bind(H))},S)}return m("end :: (%s)",this.options.clientId),R!=null&&typeof R=="boolean"||(N=S||C,S=R,R=!1,typeof S!="object"&&(N=S,S=null,typeof N!="function"&&(N=C))),typeof S!="object"&&(N=S,S=null),m("end :: cb? %s",!!N),N=N||C,this.disconnecting?(N(),this):(this._clearReconnect(),this.disconnecting=!0,!R&&Object.keys(this.outgoing).length>0?(m("end :: (%s) :: calling finish in 10ms once outgoing is empty",H.options.clientId),this.once("outgoingEmpty",setTimeout.bind(null,K,10))):(m("end :: (%s) :: immediately calling finish",H.options.clientId),K()),this)},k.prototype.removeOutgoingMessage=function(R){const S=this.outgoing[R]?this.outgoing[R].cb:null;return delete this.outgoing[R],this.outgoingStore.del({messageId:R},function(){S(new Error("Message removed"))}),this},k.prototype.reconnect=function(R){m("client reconnect");const S=this,N=function(){R?(S.options.incomingStore=R.incomingStore,S.options.outgoingStore=R.outgoingStore):(S.options.incomingStore=null,S.options.outgoingStore=null),S.incomingStore=S.options.incomingStore||new a,S.outgoingStore=S.options.outgoingStore||new a,S.disconnecting=!1,S.disconnected=!1,S._deferredReconnect=null,S._reconnect()};return this.disconnecting&&!this.disconnected?this._deferredReconnect=N:N(),this},k.prototype._reconnect=function(){m("_reconnect: emitting reconnect to client"),this.emit("reconnect"),this.connected?(this.end(()=>{this._setupStream()}),m("client already connected. disconnecting first.")):(m("_reconnect: calling _setupStream"),this._setupStream())},k.prototype._setupReconnect=function(){const R=this;!R.disconnecting&&!R.reconnectTimer&&R.options.reconnectPeriod>0?(this.reconnecting||(m("_setupReconnect :: emit `offline` state"),this.emit("offline"),m("_setupReconnect :: set `reconnecting` to `true`"),this.reconnecting=!0),m("_setupReconnect :: setting reconnectTimer for %d ms",R.options.reconnectPeriod),R.reconnectTimer=setInterval(function(){m("reconnectTimer :: reconnect triggered!"),R._reconnect()},R.options.reconnectPeriod)):m("_setupReconnect :: doing nothing...")},k.prototype._clearReconnect=function(){m("_clearReconnect : clearing reconnect timer"),this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=null)},k.prototype._cleanUp=function(R,S){const N=arguments[2];if(S&&(m("_cleanUp :: done callback provided for on stream close"),this.stream.on("close",S)),m("_cleanUp :: forced? %s",R),R)this.options.reconnectPeriod===0&&this.options.clean&&(H=this.outgoing)&&(m("flush: queue exists? %b",!!H),Object.keys(H).forEach(function(K){typeof H[K].cb=="function"&&(H[K].cb(new Error("Connection closed")),delete H[K])})),m("_cleanUp :: (%s) :: destroying stream",this.options.clientId),this.stream.destroy();else{const K=x({cmd:"disconnect"},N);m("_cleanUp :: (%s) :: call _sendPacket with disconnect packet",this.options.clientId),this._sendPacket(K,I.bind(null,this.stream.end.bind(this.stream)))}var H;this.disconnecting||(m("_cleanUp :: client not disconnecting. Clearing and resetting reconnect."),this._clearReconnect(),this._setupReconnect()),this.pingTimer!==null&&(m("_cleanUp :: clearing pingTimer"),this.pingTimer.clear(),this.pingTimer=null),S&&!this.connected&&(m("_cleanUp :: (%s) :: removing stream `done` callback `close` listener",this.options.clientId),this.stream.removeListener("close",S),S())},k.prototype._sendPacket=function(R,S,N){m("_sendPacket :: (%s) ::  start",this.options.clientId),N=N||C,S=S||C;const H=function(K,F){if(K.options.protocolVersion===5&&F.cmd==="publish"){let L;F.properties&&(L=F.properties.topicAlias);const O=F.topic.toString();if(K.topicAliasSend)if(L){if(O.length!==0&&(m("applyTopicAlias :: register topic: %s - alias: %d",O,L),!K.topicAliasSend.put(O,L)))return m("applyTopicAlias :: error out of range. topic: %s - alias: %d",O,L),new Error("Sending Topic Alias out of range")}else O.length!==0&&(K.options.autoAssignTopicAlias?(L=K.topicAliasSend.getAliasByTopic(O))?(F.topic="",F.properties={...F.properties,topicAlias:L},m("applyTopicAlias :: auto assign(use) topic: %s - alias: %d",O,L)):(L=K.topicAliasSend.getLruAlias(),K.topicAliasSend.put(O,L),F.properties={...F.properties,topicAlias:L},m("applyTopicAlias :: auto assign topic: %s - alias: %d",O,L)):K.options.autoUseTopicAlias&&(L=K.topicAliasSend.getAliasByTopic(O))&&(F.topic="",F.properties={...F.properties,topicAlias:L},m("applyTopicAlias :: auto use topic: %s - alias: %d",O,L)));else if(L)return m("applyTopicAlias :: error out of range. topic: %s - alias: %d",O,L),new Error("Sending Topic Alias out of range")}}(this,R);if(H)S(H);else{if(!this.connected)return R.cmd==="auth"?(this._shiftPingInterval(),void W(this,R,S)):(m("_sendPacket :: client not connected. Storing packet offline."),void this._storePacket(R,S,N));switch(this._shiftPingInterval(),R.cmd){case"publish":break;case"pubrel":return void Y(this,R,S,N);default:return void W(this,R,S)}switch(R.qos){case 2:case 1:Y(this,R,S,N);break;case 0:default:W(this,R,S)}m("_sendPacket :: (%s) ::  end",this.options.clientId)}},k.prototype._storePacket=function(R,S,N){m("_storePacket :: packet: %o",R),m("_storePacket :: cb? %s",!!S),N=N||C;let H=R;if(H.cmd==="publish"){const K=_(this,H=v(R));if(K)return S&&S(K)}(H.qos||0)===0&&this.queueQoSZero||H.cmd!=="publish"?this.queue.push({packet:H,cb:S}):H.qos>0?(S=this.outgoing[H.messageId]?this.outgoing[H.messageId].cb:null,this.outgoingStore.put(H,function(K){if(K)return S&&S(K);N()})):S&&S(new Error("No connection to broker"))},k.prototype._setupPingTimer=function(){m("_setupPingTimer :: keepalive %d (seconds)",this.options.keepalive);const R=this;!this.pingTimer&&this.options.keepalive&&(this.pingResp=!0,this.pingTimer=y(function(){R._checkPing()},1e3*this.options.keepalive))},k.prototype._shiftPingInterval=function(){this.pingTimer&&this.options.keepalive&&this.options.reschedulePings&&this.pingTimer.reschedule(1e3*this.options.keepalive)},k.prototype._checkPing=function(){m("_checkPing :: checking ping..."),this.pingResp?(m("_checkPing :: ping response received. Clearing flag and sending `pingreq`"),this.pingResp=!1,this._sendPacket({cmd:"pingreq"})):(m("_checkPing :: calling _cleanUp with force true"),this._cleanUp(!0))},k.prototype._handlePingresp=function(){this.pingResp=!0},k.prototype._handleConnack=function(R){m("_handleConnack");const S=this.options,N=S.protocolVersion===5?R.reasonCode:R.returnCode;if(clearTimeout(this.connackTimer),delete this.topicAliasSend,R.properties){if(R.properties.topicAliasMaximum){if(R.properties.topicAliasMaximum>65535)return void this.emit("error",new Error("topicAliasMaximum from broker is out of range"));R.properties.topicAliasMaximum>0&&(this.topicAliasSend=new l(R.properties.topicAliasMaximum))}R.properties.serverKeepAlive&&S.keepalive&&(S.keepalive=R.properties.serverKeepAlive,this._shiftPingInterval()),R.properties.maximumPacketSize&&(S.properties||(S.properties={}),S.properties.maximumPacketSize=R.properties.maximumPacketSize)}if(N===0)this.reconnecting=!1,this._onConnect(R);else if(N>0){const H=new Error("Connection refused: "+E[N]);H.code=N,this.emit("error",H)}},k.prototype._handleAuth=function(R){const S=this.options.protocolVersion,N=S===5?R.reasonCode:R.returnCode;if(S!==5){const K=new Error("Protocol error: Auth packets are only supported in MQTT 5. Your version:"+S);return K.code=N,void this.emit("error",K)}const H=this;this.handleAuth(R,function(K,F){if(K)H.emit("error",K);else if(N===24)H.reconnecting=!1,H._sendPacket(F);else{const L=new Error("Connection refused: "+E[N]);K.code=N,H.emit("error",L)}})},k.prototype.handleAuth=function(R,S){S()},k.prototype._handlePublish=function(R,S){m("_handlePublish: packet %o",R),S=S!==void 0?S:C;let N=R.topic.toString();const H=R.payload,K=R.qos,F=R.messageId,L=this,O=this.options,z=[0,16,128,131,135,144,145,151,153];if(this.options.protocolVersion===5){let B;if(R.properties&&(B=R.properties.topicAlias),B!==void 0)if(N.length===0){if(!(B>0&&B<=65535))return m("_handlePublish :: topic alias out of range. alias: %d",B),void this.emit("error",new Error("Received Topic Alias is out of range"));{const U=this.topicAliasRecv.getTopicByAlias(B);if(!U)return m("_handlePublish :: unregistered topic alias. alias: %d",B),void this.emit("error",new Error("Received unregistered Topic Alias"));m("_handlePublish :: topic complemented by alias. topic: %s - alias: %d",N=U,B)}}else{if(!this.topicAliasRecv.put(N,B))return m("_handlePublish :: topic alias out of range. alias: %d",B),void this.emit("error",new Error("Received Topic Alias is out of range"));m("_handlePublish :: registered topic: %s - alias: %d",N,B)}}switch(m("_handlePublish: qos %d",K),K){case 2:O.customHandleAcks(N,H,R,function(B,U){return B instanceof Error||(U=B,B=null),B?L.emit("error",B):z.indexOf(U)===-1?L.emit("error",new Error("Wrong reason code for pubrec")):void(U?L._sendPacket({cmd:"pubrec",messageId:F,reasonCode:U},S):L.incomingStore.put(R,function(){L._sendPacket({cmd:"pubrec",messageId:F},S)}))});break;case 1:O.customHandleAcks(N,H,R,function(B,U){return B instanceof Error||(U=B,B=null),B?L.emit("error",B):z.indexOf(U)===-1?L.emit("error",new Error("Wrong reason code for puback")):(U||L.emit("message",N,H,R),void L.handleMessage(R,function($){if($)return S&&S($);L._sendPacket({cmd:"puback",messageId:F,reasonCode:U},S)}))});break;case 0:this.emit("message",N,H,R),this.handleMessage(R,S);break;default:m("_handlePublish: unknown QoS. Doing nothing.")}},k.prototype.handleMessage=function(R,S){S()},k.prototype._handleAck=function(R){const S=R.messageId,N=R.cmd;let H=null;const K=this.outgoing[S]?this.outgoing[S].cb:null,F=this;let L;if(K){switch(m("_handleAck :: packet type",N),N){case"pubcomp":case"puback":{const O=R.reasonCode;O&&O>0&&O!==16&&((L=new Error("Publish error: "+E[O])).code=O,K(L,R)),delete this.outgoing[S],this.outgoingStore.del(R,K),this.messageIdProvider.deallocate(S),this._invokeStoreProcessingQueue();break}case"pubrec":{H={cmd:"pubrel",qos:2,messageId:S};const O=R.reasonCode;O&&O>0&&O!==16?((L=new Error("Publish error: "+E[O])).code=O,K(L,R)):this._sendPacket(H);break}case"suback":delete this.outgoing[S],this.messageIdProvider.deallocate(S);for(let O=0;O<R.granted.length;O++)if(128&R.granted[O]){const z=this.messageIdToTopic[S];z&&z.forEach(function(B){delete F._resubscribeTopics[B]})}this._invokeStoreProcessingQueue(),K(null,R);break;case"unsuback":delete this.outgoing[S],this.messageIdProvider.deallocate(S),this._invokeStoreProcessingQueue(),K(null);break;default:F.emit("error",new Error("unrecognized packet type"))}this.disconnecting&&Object.keys(this.outgoing).length===0&&this.emit("outgoingEmpty")}else m("_handleAck :: Server sent an ack in error. Ignoring.")},k.prototype._handlePubrel=function(R,S){m("handling pubrel packet"),S=S!==void 0?S:C;const N=this,H={cmd:"pubcomp",messageId:R.messageId};N.incomingStore.get(R,function(K,F){K?N._sendPacket(H,S):(N.emit("message",F.topic,F.payload,F),N.handleMessage(F,function(L){if(L)return S(L);N.incomingStore.del(F,C),N._sendPacket(H,S)}))})},k.prototype._handleDisconnect=function(R){this.emit("disconnect",R)},k.prototype._nextId=function(){return this.messageIdProvider.allocate()},k.prototype.getLastMessageId=function(){return this.messageIdProvider.getLastAllocated()},k.prototype._resubscribe=function(){m("_resubscribe");const R=Object.keys(this._resubscribeTopics);if(!this._firstConnection&&(this.options.clean||this.options.protocolVersion===5&&!this.connackPacket.sessionPresent)&&R.length>0)if(this.options.resubscribe)if(this.options.protocolVersion===5){m("_resubscribe: protocolVersion 5");for(let S=0;S<R.length;S++){const N={};N[R[S]]=this._resubscribeTopics[R[S]],N.resubscribe=!0,this.subscribe(N,{properties:N[R[S]].properties})}}else this._resubscribeTopics.resubscribe=!0,this.subscribe(this._resubscribeTopics);else this._resubscribeTopics={};this._firstConnection=!1},k.prototype._onConnect=function(R){if(this.disconnected)return void this.emit("connect",R);const S=this;this.connackPacket=R,this.messageIdProvider.clear(),this._setupPingTimer(),this.connected=!0,function N(){let H=S.outgoingStore.createStream();function K(){S._storeProcessing=!1,S._packetIdsDuringStoreProcessing={}}function F(){H.destroy(),H=null,S._flushStoreProcessingQueue(),K()}S.once("close",F),H.on("error",function(L){K(),S._flushStoreProcessingQueue(),S.removeListener("close",F),S.emit("error",L)}),H.on("end",function(){let L=!0;for(const O in S._packetIdsDuringStoreProcessing)if(!S._packetIdsDuringStoreProcessing[O]){L=!1;break}L?(K(),S.removeListener("close",F),S._invokeAllStoreProcessingQueue(),S.emit("connect",R)):N()}),function L(){if(!H)return;S._storeProcessing=!0;const O=H.read(1);let z;O?S._packetIdsDuringStoreProcessing[O.messageId]?L():S.disconnecting||S.reconnectTimer?H.destroy&&H.destroy():(z=S.outgoing[O.messageId]?S.outgoing[O.messageId].cb:null,S.outgoing[O.messageId]={volatile:!1,cb:function(B,U){z&&z(B,U),L()}},S._packetIdsDuringStoreProcessing[O.messageId]=!0,S.messageIdProvider.register(O.messageId)?S._sendPacket(O):m("messageId: %d has already used.",O.messageId)):H.once("readable",L)}()}()},k.prototype._invokeStoreProcessingQueue=function(){if(this._storeProcessingQueue.length>0){const R=this._storeProcessingQueue[0];if(R&&R.invoke())return this._storeProcessingQueue.shift(),!0}return!1},k.prototype._invokeAllStoreProcessingQueue=function(){for(;this._invokeStoreProcessingQueue(););},k.prototype._flushStoreProcessingQueue=function(){for(const R of this._storeProcessingQueue)R.cbStorePut&&R.cbStorePut(new Error("Connection closed")),R.callback&&R.callback(new Error("Connection closed"));this._storeProcessingQueue.splice(0)},s.exports=k}).call(this)}).call(this,i("_process"),typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{"./default-message-id-provider":7,"./store":8,"./topic-alias-recv":9,"./topic-alias-send":10,"./validations":11,_process:50,debug:18,events:22,inherits:24,"mqtt-packet":40,"readable-stream":69,reinterval:70,"rfdc/default":71,xtend:81}],2:[function(i,s,r){const{Buffer:o}=i("buffer"),n=i("readable-stream").Transform,c=i("duplexify");let a,h,l,u=!1;s.exports=function(d,f){if(f.hostname=f.hostname||f.host,!f.hostname)throw new Error("Could not determine host. Specify host manually.");const g=f.protocolId==="MQIsdp"&&f.protocolVersion===3?"mqttv3.1":"mqtt";(function(v){v.hostname||(v.hostname="localhost"),v.path||(v.path="/"),v.wsOptions||(v.wsOptions={})})(f);const y=function(v,b){const x=v.protocol==="alis"?"wss":"ws";let m=x+"://"+v.hostname+v.path;return v.port&&v.port!==80&&v.port!==443&&(m=x+"://"+v.hostname+":"+v.port+v.path),typeof v.transformWsUrl=="function"&&(m=v.transformWsUrl(m,v,b)),m}(f,d);return(a=f.my).connectSocket({url:y,protocols:g}),h=function(){const v=new n;return v._write=function(b,x,m){a.sendSocketMessage({data:b.buffer,success:function(){m()},fail:function(){m(new Error)}})},v._flush=function(b){a.closeSocket({success:function(){b()}})},v}(),l=c.obj(),u||(u=!0,a.onSocketOpen(function(){l.setReadable(h),l.setWritable(h),l.emit("connect")}),a.onSocketMessage(function(v){if(typeof v.data=="string"){const b=o.from(v.data,"base64");h.push(b)}else{const b=new FileReader;b.addEventListener("load",function(){let x=b.result;x=x instanceof ArrayBuffer?o.from(x):o.from(x,"utf8"),h.push(x)}),b.readAsArrayBuffer(v.data)}}),a.onSocketClose(function(){l.end(),l.destroy()}),a.onSocketError(function(v){l.destroy(v)})),l}},{buffer:17,duplexify:20,"readable-stream":69}],3:[function(i,s,r){const o=i("net"),n=i("debug")("mqttjs:tcp");s.exports=function(c,a){a.port=a.port||1883,a.hostname=a.hostname||a.host||"localhost";const h=a.port,l=a.hostname;return n("port %d and host %s",h,l),o.createConnection(h,l)}},{debug:18,net:16}],4:[function(i,s,r){const o=i("tls"),n=i("net"),c=i("debug")("mqttjs:tls");s.exports=function(a,h){h.port=h.port||8883,h.host=h.hostname||h.host||"localhost",n.isIP(h.host)===0&&(h.servername=h.host),h.rejectUnauthorized=h.rejectUnauthorized!==!1,delete h.path,c("port %d host %s rejectUnauthorized %b",h.port,h.host,h.rejectUnauthorized);const l=o.connect(h);function u(d){h.rejectUnauthorized&&a.emit("error",d),l.end()}return l.on("secureConnect",function(){h.rejectUnauthorized&&!l.authorized?l.emit("error",new Error("TLS not authorized")):l.removeListener("error",u)}),l.on("error",u),l}},{debug:18,net:16,tls:16}],5:[function(i,s,r){(function(o){(function(){const{Buffer:n}=i("buffer"),c=i("ws"),a=i("debug")("mqttjs:ws"),h=i("duplexify"),l=i("readable-stream").Transform,u=["rejectUnauthorized","ca","cert","key","pfx","passphrase"],d=o!==void 0&&o.title==="browser"||typeof __webpack_require__=="function";function f(y,v){let b=y.protocol+"://"+y.hostname+":"+y.port+y.path;return typeof y.transformWsUrl=="function"&&(b=y.transformWsUrl(b,y,v)),b}function g(y){const v=y;return y.hostname||(v.hostname="localhost"),y.port||(y.protocol==="wss"?v.port=443:v.port=80),y.path||(v.path="/"),y.wsOptions||(v.wsOptions={}),d||y.protocol!=="wss"||u.forEach(function(b){Object.prototype.hasOwnProperty.call(y,b)&&!Object.prototype.hasOwnProperty.call(y.wsOptions,b)&&(v.wsOptions[b]=y[b])}),v}s.exports=d?function(y,v){let b;a("browserStreamBuilder");const x=function(R){const S=g(R);if(S.hostname||(S.hostname=S.host),!S.hostname){if(typeof document>"u")throw new Error("Could not determine host. Specify host manually.");const N=new URL(document.URL);S.hostname=N.hostname,S.port||(S.port=N.port)}return S.objectMode===void 0&&(S.objectMode=!(S.binary===!0||S.binary===void 0)),S}(v).browserBufferSize||524288,m=v.browserBufferTimeout||1e3,T=!v.objectMode,I=function(R,S){const N=S.protocolId==="MQIsdp"&&S.protocolVersion===3?"mqttv3.1":"mqtt",H=f(S,R),K=new WebSocket(H,[N]);return K.binaryType="arraybuffer",K}(y,v),P=function(R,S,N){const H=new l({objectModeMode:R.objectMode});return H._write=S,H._flush=N,H}(v,function R(S,N,H){I.bufferedAmount>x&&setTimeout(R,m,S,N,H),T&&typeof S=="string"&&(S=n.from(S,"utf8"));try{I.send(S)}catch(K){return H(K)}H()},function(R){I.close(),R()});v.objectMode||(P._writev=k),P.on("close",()=>{I.close()});const E=I.addEventListener!==void 0;function _(){b.setReadable(P),b.setWritable(P),b.emit("connect")}function W(){b.end(),b.destroy()}function Y(R){b.destroy(R)}function C(R){let S=R.data;S=S instanceof ArrayBuffer?n.from(S):n.from(S,"utf8"),P.push(S)}function k(R,S){const N=new Array(R.length);for(let H=0;H<R.length;H++)typeof R[H].chunk=="string"?N[H]=n.from(R[H],"utf8"):N[H]=R[H].chunk;this._write(n.concat(N),"binary",S)}return I.readyState===I.OPEN?b=P:(b=b=h(void 0,void 0,v),v.objectMode||(b._writev=k),E?I.addEventListener("open",_):I.onopen=_),b.socket=I,E?(I.addEventListener("close",W),I.addEventListener("error",Y),I.addEventListener("message",C)):(I.onclose=W,I.onerror=Y,I.onmessage=C),b}:function(y,v){a("streamBuilder");const b=g(v),x=f(b,y),m=function(I,P,E){a("createWebSocket"),a("protocol: "+E.protocolId+" "+E.protocolVersion);const _=E.protocolId==="MQIsdp"&&E.protocolVersion===3?"mqttv3.1":"mqtt";return a("creating new Websocket for url: "+P+" and protocol: "+_),new c(P,[_],E.wsOptions)}(0,x,b),T=c.createWebSocketStream(m,b.wsOptions);return T.url=x,m.on("close",()=>{T.destroy()}),T}}).call(this)}).call(this,i("_process"))},{_process:50,buffer:17,debug:18,duplexify:20,"readable-stream":69,ws:80}],6:[function(i,s,r){const{Buffer:o}=i("buffer"),n=i("readable-stream").Transform,c=i("duplexify");let a,h,l;s.exports=function(u,d){if(d.hostname=d.hostname||d.host,!d.hostname)throw new Error("Could not determine host. Specify host manually.");const f=d.protocolId==="MQIsdp"&&d.protocolVersion===3?"mqttv3.1":"mqtt";(function(v){v.hostname||(v.hostname="localhost"),v.path||(v.path="/"),v.wsOptions||(v.wsOptions={})})(d);const g=function(v,b){const x=v.protocol==="wxs"?"wss":"ws";let m=x+"://"+v.hostname+v.path;return v.port&&v.port!==80&&v.port!==443&&(m=x+"://"+v.hostname+":"+v.port+v.path),typeof v.transformWsUrl=="function"&&(m=v.transformWsUrl(m,v,b)),m}(d,u);a=wx.connectSocket({url:g,protocols:[f]}),h=function(){const v=new n;return v._write=function(b,x,m){a.send({data:b.buffer,success:function(){m()},fail:function(T){m(new Error(T))}})},v._flush=function(b){a.close({success:function(){b()}})},v}(),(l=c.obj())._destroy=function(v,b){a.close({success:function(){b&&b(v)}})};const y=l.destroy;return l.destroy=(function(){l.destroy=y;const v=this;setTimeout(function(){a.close({fail:function(){v._destroy(new Error)}})},0)}).bind(l),a.onOpen(function(){l.setReadable(h),l.setWritable(h),l.emit("connect")}),a.onMessage(function(v){let b=v.data;b=b instanceof ArrayBuffer?o.from(b):o.from(b,"utf8"),h.push(b)}),a.onClose(function(){l.end(),l.destroy()}),a.onError(function(v){l.destroy(new Error(v.errMsg))}),l}},{buffer:17,duplexify:20,"readable-stream":69}],7:[function(i,s,r){function o(){if(!(this instanceof o))return new o;this.nextId=Math.max(1,Math.floor(65535*Math.random()))}o.prototype.allocate=function(){const n=this.nextId++;return this.nextId===65536&&(this.nextId=1),n},o.prototype.getLastAllocated=function(){return this.nextId===1?65535:this.nextId-1},o.prototype.register=function(n){return!0},o.prototype.deallocate=function(n){},o.prototype.clear=function(){},s.exports=o},{}],8:[function(i,s,r){const o=i("xtend"),n=i("readable-stream").Readable,c={objectMode:!0},a={clean:!0};function h(l){if(!(this instanceof h))return new h(l);this.options=l||{},this.options=o(a,l),this._inflights=new Map}h.prototype.put=function(l,u){return this._inflights.set(l.messageId,l),u&&u(),this},h.prototype.createStream=function(){const l=new n(c),u=[];let d=!1,f=0;return this._inflights.forEach(function(g,y){u.push(g)}),l._read=function(){!d&&f<u.length?this.push(u[f++]):this.push(null)},l.destroy=function(){if(d)return;const g=this;d=!0,setTimeout(function(){g.emit("close")},0)},l},h.prototype.del=function(l,u){return(l=this._inflights.get(l.messageId))?(this._inflights.delete(l.messageId),u(null,l)):u&&u(new Error("missing packet")),this},h.prototype.get=function(l,u){return(l=this._inflights.get(l.messageId))?u(null,l):u&&u(new Error("missing packet")),this},h.prototype.close=function(l){this.options.clean&&(this._inflights=null),l&&l()},s.exports=h},{"readable-stream":69,xtend:81}],9:[function(i,s,r){function o(n){if(!(this instanceof o))return new o(n);this.aliasToTopic={},this.max=n}o.prototype.put=function(n,c){return!(c===0||c>this.max)&&(this.aliasToTopic[c]=n,this.length=Object.keys(this.aliasToTopic).length,!0)},o.prototype.getTopicByAlias=function(n){return this.aliasToTopic[n]},o.prototype.clear=function(){this.aliasToTopic={}},s.exports=o},{}],10:[function(i,s,r){const o=i("lru-cache"),n=i("number-allocator").NumberAllocator;function c(a){if(!(this instanceof c))return new c(a);a>0&&(this.aliasToTopic=new o({max:a}),this.topicToAlias={},this.numberAllocator=new n(1,a),this.max=a,this.length=0)}c.prototype.put=function(a,h){if(h===0||h>this.max)return!1;const l=this.aliasToTopic.get(h);return l&&delete this.topicToAlias[l],this.aliasToTopic.set(h,a),this.topicToAlias[a]=h,this.numberAllocator.use(h),this.length=this.aliasToTopic.length,!0},c.prototype.getTopicByAlias=function(a){return this.aliasToTopic.get(a)},c.prototype.getAliasByTopic=function(a){const h=this.topicToAlias[a];return h!==void 0&&this.aliasToTopic.get(h),h},c.prototype.clear=function(){this.aliasToTopic.reset(),this.topicToAlias={},this.numberAllocator.clear(),this.length=0},c.prototype.getLruAlias=function(){return this.numberAllocator.firstVacant()||this.aliasToTopic.keys()[this.aliasToTopic.length-1]},s.exports=c},{"lru-cache":37,"number-allocator":46}],11:[function(i,s,r){function o(n){const c=n.split("/");for(let a=0;a<c.length;a++)if(c[a]!=="+"){if(c[a]==="#")return a===c.length-1;if(c[a].indexOf("+")!==-1||c[a].indexOf("#")!==-1)return!1}return!0}s.exports={validateTopics:function(n){if(n.length===0)return"empty_topic_list";for(let c=0;c<n.length;c++)if(!o(n[c]))return n[c];return null}}},{}],12:[function(i,s,r){(function(o){(function(){const n=i("../client"),c=i("../store"),a=i("url"),h=i("xtend"),l=i("debug")("mqttjs"),u={};function d(f,g){if(l("connecting to an MQTT broker..."),typeof f!="object"||g||(g=f,f=null),g=g||{},f){const v=a.parse(f,!0);if(v.port!=null&&(v.port=Number(v.port)),(g=h(v,g)).protocol===null)throw new Error("Missing protocol");g.protocol=g.protocol.replace(/:$/,"")}if(function(v){let b;v.auth&&((b=v.auth.match(/^(.+):(.+)$/))?(v.username=b[1],v.password=b[2]):v.username=v.auth)}(g),g.query&&typeof g.query.clientId=="string"&&(g.clientId=g.query.clientId),g.cert&&g.key){if(!g.protocol)throw new Error("Missing secure protocol key");if(["mqtts","wss","wxs","alis"].indexOf(g.protocol)===-1)switch(g.protocol){case"mqtt":g.protocol="mqtts";break;case"ws":g.protocol="wss";break;case"wx":g.protocol="wxs";break;case"ali":g.protocol="alis";break;default:throw new Error('Unknown protocol for secure connection: "'+g.protocol+'"!')}}if(!u[g.protocol]){const v=["mqtts","wss"].indexOf(g.protocol)!==-1;g.protocol=["mqtt","mqtts","ws","wss","wx","wxs","ali","alis"].filter(function(b,x){return(!v||x%2!=0)&&typeof u[b]=="function"})[0]}if(g.clean===!1&&!g.clientId)throw new Error("Missing clientId for unclean clients");g.protocol&&(g.defaultProtocol=g.protocol);const y=new n(function(v){return g.servers&&(v._reconnectCount&&v._reconnectCount!==g.servers.length||(v._reconnectCount=0),g.host=g.servers[v._reconnectCount].host,g.port=g.servers[v._reconnectCount].port,g.protocol=g.servers[v._reconnectCount].protocol?g.servers[v._reconnectCount].protocol:g.defaultProtocol,g.hostname=g.host,v._reconnectCount++),l("calling streambuilder for",g.protocol),u[g.protocol](v,g)},g);return y.on("error",function(){}),y}o!==void 0&&o.title!=="browser"||typeof __webpack_require__!="function"?(u.mqtt=i("./tcp"),u.tcp=i("./tcp"),u.ssl=i("./tls"),u.tls=i("./tls"),u.mqtts=i("./tls")):(u.wx=i("./wx"),u.wxs=i("./wx"),u.ali=i("./ali"),u.alis=i("./ali")),u.ws=i("./ws"),u.wss=i("./ws"),s.exports=d,s.exports.connect=d,s.exports.MqttClient=n,s.exports.Store=c}).call(this)}).call(this,i("_process"))},{"../client":1,"../store":8,"./ali":2,"./tcp":3,"./tls":4,"./ws":5,"./wx":6,_process:50,debug:18,url:76,xtend:81}],13:[function(i,s,r){r.byteLength=function(f){var g=u(f),y=g[0],v=g[1];return 3*(y+v)/4-v},r.toByteArray=function(f){var g,y,v=u(f),b=v[0],x=v[1],m=new c(function(P,E,_){return 3*(E+_)/4-_}(0,b,x)),T=0,I=x>0?b-4:b;for(y=0;y<I;y+=4)g=n[f.charCodeAt(y)]<<18|n[f.charCodeAt(y+1)]<<12|n[f.charCodeAt(y+2)]<<6|n[f.charCodeAt(y+3)],m[T++]=g>>16&255,m[T++]=g>>8&255,m[T++]=255&g;return x===2&&(g=n[f.charCodeAt(y)]<<2|n[f.charCodeAt(y+1)]>>4,m[T++]=255&g),x===1&&(g=n[f.charCodeAt(y)]<<10|n[f.charCodeAt(y+1)]<<4|n[f.charCodeAt(y+2)]>>2,m[T++]=g>>8&255,m[T++]=255&g),m},r.fromByteArray=function(f){for(var g,y=f.length,v=y%3,b=[],x=0,m=y-v;x<m;x+=16383)b.push(d(f,x,x+16383>m?m:x+16383));return v===1?(g=f[y-1],b.push(o[g>>2]+o[g<<4&63]+"==")):v===2&&(g=(f[y-2]<<8)+f[y-1],b.push(o[g>>10]+o[g>>4&63]+o[g<<2&63]+"=")),b.join("")};for(var o=[],n=[],c=typeof Uint8Array<"u"?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",h=0,l=a.length;h<l;++h)o[h]=a[h],n[a.charCodeAt(h)]=h;function u(f){var g=f.length;if(g%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var y=f.indexOf("=");return y===-1&&(y=g),[y,y===g?0:4-y%4]}function d(f,g,y){for(var v,b,x=[],m=g;m<y;m+=3)v=(f[m]<<16&16711680)+(f[m+1]<<8&65280)+(255&f[m+2]),x.push(o[(b=v)>>18&63]+o[b>>12&63]+o[b>>6&63]+o[63&b]);return x.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},{}],14:[function(i,s,r){const{Buffer:o}=i("buffer"),n=Symbol.for("BufferList");function c(a){if(!(this instanceof c))return new c(a);c._init.call(this,a)}c._init=function(a){Object.defineProperty(this,n,{value:!0}),this._bufs=[],this.length=0,a&&this.append(a)},c.prototype._new=function(a){return new c(a)},c.prototype._offset=function(a){if(a===0)return[0,0];let h=0;for(let l=0;l<this._bufs.length;l++){const u=h+this._bufs[l].length;if(a<u||l===this._bufs.length-1)return[l,a-h];h=u}},c.prototype._reverseOffset=function(a){const h=a[0];let l=a[1];for(let u=0;u<h;u++)l+=this._bufs[u].length;return l},c.prototype.get=function(a){if(a>this.length||a<0)return;const h=this._offset(a);return this._bufs[h[0]][h[1]]},c.prototype.slice=function(a,h){return typeof a=="number"&&a<0&&(a+=this.length),typeof h=="number"&&h<0&&(h+=this.length),this.copy(null,0,a,h)},c.prototype.copy=function(a,h,l,u){if((typeof l!="number"||l<0)&&(l=0),(typeof u!="number"||u>this.length)&&(u=this.length),l>=this.length||u<=0)return a||o.alloc(0);const d=!!a,f=this._offset(l),g=u-l;let y=g,v=d&&h||0,b=f[1];if(l===0&&u===this.length){if(!d)return this._bufs.length===1?this._bufs[0]:o.concat(this._bufs,this.length);for(let x=0;x<this._bufs.length;x++)this._bufs[x].copy(a,v),v+=this._bufs[x].length;return a}if(y<=this._bufs[f[0]].length-b)return d?this._bufs[f[0]].copy(a,h,b,b+y):this._bufs[f[0]].slice(b,b+y);d||(a=o.allocUnsafe(g));for(let x=f[0];x<this._bufs.length;x++){const m=this._bufs[x].length-b;if(!(y>m)){this._bufs[x].copy(a,v,b,b+y),v+=m;break}this._bufs[x].copy(a,v,b),v+=m,y-=m,b&&(b=0)}return a.length>v?a.slice(0,v):a},c.prototype.shallowSlice=function(a,h){if(a=a||0,h=typeof h!="number"?this.length:h,a<0&&(a+=this.length),h<0&&(h+=this.length),a===h)return this._new();const l=this._offset(a),u=this._offset(h),d=this._bufs.slice(l[0],u[0]+1);return u[1]===0?d.pop():d[d.length-1]=d[d.length-1].slice(0,u[1]),l[1]!==0&&(d[0]=d[0].slice(l[1])),this._new(d)},c.prototype.toString=function(a,h,l){return this.slice(h,l).toString(a)},c.prototype.consume=function(a){if(a=Math.trunc(a),Number.isNaN(a)||a<=0)return this;for(;this._bufs.length;){if(!(a>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(a),this.length-=a;break}a-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this},c.prototype.duplicate=function(){const a=this._new();for(let h=0;h<this._bufs.length;h++)a.append(this._bufs[h]);return a},c.prototype.append=function(a){if(a==null)return this;if(a.buffer)this._appendBuffer(o.from(a.buffer,a.byteOffset,a.byteLength));else if(Array.isArray(a))for(let h=0;h<a.length;h++)this.append(a[h]);else if(this._isBufferList(a))for(let h=0;h<a._bufs.length;h++)this.append(a._bufs[h]);else typeof a=="number"&&(a=a.toString()),this._appendBuffer(o.from(a));return this},c.prototype._appendBuffer=function(a){this._bufs.push(a),this.length+=a.length},c.prototype.indexOf=function(a,h,l){if(l===void 0&&typeof h=="string"&&(l=h,h=void 0),typeof a=="function"||Array.isArray(a))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if(typeof a=="number"?a=o.from([a]):typeof a=="string"?a=o.from(a,l):this._isBufferList(a)?a=a.slice():Array.isArray(a.buffer)?a=o.from(a.buffer,a.byteOffset,a.byteLength):o.isBuffer(a)||(a=o.from(a)),h=Number(h||0),isNaN(h)&&(h=0),h<0&&(h=this.length+h),h<0&&(h=0),a.length===0)return h>this.length?this.length:h;const u=this._offset(h);let d=u[0],f=u[1];for(;d<this._bufs.length;d++){const g=this._bufs[d];for(;f<g.length;)if(g.length-f>=a.length){const y=g.indexOf(a,f);if(y!==-1)return this._reverseOffset([d,y]);f=g.length-a.length+1}else{const y=this._reverseOffset([d,f]);if(this._match(y,a))return y;f++}f=0}return-1},c.prototype._match=function(a,h){if(this.length-a<h.length)return!1;for(let l=0;l<h.length;l++)if(this.get(a+l)!==h[l])return!1;return!0},function(){const a={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const h in a)(function(l){c.prototype[l]=a[l]===null?function(u,d){return this.slice(u,u+d)[l](0,d)}:function(u=0){return this.slice(u,u+a[l])[l](0)}})(h)}(),c.prototype._isBufferList=function(a){return a instanceof c||c.isBufferList(a)},c.isBufferList=function(a){return a!=null&&a[n]},s.exports=c},{buffer:17}],15:[function(i,s,r){const o=i("readable-stream").Duplex,n=i("inherits"),c=i("./BufferList");function a(h){if(!(this instanceof a))return new a(h);if(typeof h=="function"){this._callback=h;const l=(function(u){this._callback&&(this._callback(u),this._callback=null)}).bind(this);this.on("pipe",function(u){u.on("error",l)}),this.on("unpipe",function(u){u.removeListener("error",l)}),h=null}c._init.call(this,h),o.call(this)}n(a,o),Object.assign(a.prototype,c.prototype),a.prototype._new=function(h){return new a(h)},a.prototype._write=function(h,l,u){this._appendBuffer(h),typeof u=="function"&&u()},a.prototype._read=function(h){if(!this.length)return this.push(null);h=Math.min(h,this.length),this.push(this.slice(0,h)),this.consume(h)},a.prototype.end=function(h){o.prototype.end.call(this,h),this._callback&&(this._callback(null,this.slice()),this._callback=null)},a.prototype._destroy=function(h,l){this._bufs.length=0,this.length=0,l(h)},a.prototype._isBufferList=function(h){return h instanceof a||h instanceof c||a.isBufferList(h)},a.isBufferList=c.isBufferList,s.exports=a,s.exports.BufferListStream=a,s.exports.BufferList=c},{"./BufferList":14,inherits:24,"readable-stream":69}],16:[function(i,s,r){},{}],17:[function(i,s,r){(function(o){(function(){var n=i("base64-js"),c=i("ieee754");r.Buffer=l,r.SlowBuffer=function(p){return+p!=p&&(p=0),l.alloc(+p)},r.INSPECT_MAX_BYTES=50;var a=2147483647;function h(p){if(p>a)throw new RangeError('The value "'+p+'" is invalid for option "size"');var w=new Uint8Array(p);return w.__proto__=l.prototype,w}function l(p,w,A){if(typeof p=="number"){if(typeof w=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return f(p)}return u(p,w,A)}function u(p,w,A){if(typeof p=="string")return function(V,G){if(typeof G=="string"&&G!==""||(G="utf8"),!l.isEncoding(G))throw new TypeError("Unknown encoding: "+G);var tt=0|v(V,G),Z=h(tt),et=Z.write(V,G);return et!==tt&&(Z=Z.slice(0,et)),Z}(p,w);if(ArrayBuffer.isView(p))return g(p);if(p==null)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof p);if(X(p,ArrayBuffer)||p&&X(p.buffer,ArrayBuffer))return function(V,G,tt){if(G<0||V.byteLength<G)throw new RangeError('"offset" is outside of buffer bounds');if(V.byteLength<G+(tt||0))throw new RangeError('"length" is outside of buffer bounds');var Z;return Z=G===void 0&&tt===void 0?new Uint8Array(V):tt===void 0?new Uint8Array(V,G):new Uint8Array(V,G,tt),Z.__proto__=l.prototype,Z}(p,w,A);if(typeof p=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');var M=p.valueOf&&p.valueOf();if(M!=null&&M!==p)return l.from(M,w,A);var j=function(V){if(l.isBuffer(V)){var G=0|y(V.length),tt=h(G);return tt.length===0||V.copy(tt,0,0,G),tt}if(V.length!==void 0)return typeof V.length!="number"||J(V.length)?h(0):g(V);if(V.type==="Buffer"&&Array.isArray(V.data))return g(V.data)}(p);if(j)return j;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof p[Symbol.toPrimitive]=="function")return l.from(p[Symbol.toPrimitive]("string"),w,A);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof p)}function d(p){if(typeof p!="number")throw new TypeError('"size" argument must be of type number');if(p<0)throw new RangeError('The value "'+p+'" is invalid for option "size"')}function f(p){return d(p),h(p<0?0:0|y(p))}function g(p){for(var w=p.length<0?0:0|y(p.length),A=h(w),M=0;M<w;M+=1)A[M]=255&p[M];return A}function y(p){if(p>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return 0|p}function v(p,w){if(l.isBuffer(p))return p.length;if(ArrayBuffer.isView(p)||X(p,ArrayBuffer))return p.byteLength;if(typeof p!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof p);var A=p.length,M=arguments.length>2&&arguments[2]===!0;if(!M&&A===0)return 0;for(var j=!1;;)switch(w){case"ascii":case"latin1":case"binary":return A;case"utf8":case"utf-8":return $(p).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*A;case"hex":return A>>>1;case"base64":return q(p).length;default:if(j)return M?-1:$(p).length;w=(""+w).toLowerCase(),j=!0}}function b(p,w,A){var M=p[w];p[w]=p[A],p[A]=M}function x(p,w,A,M,j){if(p.length===0)return-1;if(typeof A=="string"?(M=A,A=0):A>2147483647?A=2147483647:A<-2147483648&&(A=-2147483648),J(A=+A)&&(A=j?0:p.length-1),A<0&&(A=p.length+A),A>=p.length){if(j)return-1;A=p.length-1}else if(A<0){if(!j)return-1;A=0}if(typeof w=="string"&&(w=l.from(w,M)),l.isBuffer(w))return w.length===0?-1:m(p,w,A,M,j);if(typeof w=="number")return w&=255,typeof Uint8Array.prototype.indexOf=="function"?j?Uint8Array.prototype.indexOf.call(p,w,A):Uint8Array.prototype.lastIndexOf.call(p,w,A):m(p,[w],A,M,j);throw new TypeError("val must be string, number or Buffer")}function m(p,w,A,M,j){var V,G=1,tt=p.length,Z=w.length;if(M!==void 0&&((M=String(M).toLowerCase())==="ucs2"||M==="ucs-2"||M==="utf16le"||M==="utf-16le")){if(p.length<2||w.length<2)return-1;G=2,tt/=2,Z/=2,A/=2}function et(at,st){return G===1?at[st]:at.readUInt16BE(st*G)}if(j){var it=-1;for(V=A;V<tt;V++)if(et(p,V)===et(w,it===-1?0:V-it)){if(it===-1&&(it=V),V-it+1===Z)return it*G}else it!==-1&&(V-=V-it),it=-1}else for(A+Z>tt&&(A=tt-Z),V=A;V>=0;V--){for(var nt=!0,ot=0;ot<Z;ot++)if(et(p,V+ot)!==et(w,ot)){nt=!1;break}if(nt)return V}return-1}function T(p,w,A,M){A=Number(A)||0;var j=p.length-A;M?(M=Number(M))>j&&(M=j):M=j;var V=w.length;M>V/2&&(M=V/2);for(var G=0;G<M;++G){var tt=parseInt(w.substr(2*G,2),16);if(J(tt))return G;p[A+G]=tt}return G}function I(p,w,A,M){return Q($(w,p.length-A),p,A,M)}function P(p,w,A,M){return Q(function(j){for(var V=[],G=0;G<j.length;++G)V.push(255&j.charCodeAt(G));return V}(w),p,A,M)}function E(p,w,A,M){return P(p,w,A,M)}function _(p,w,A,M){return Q(q(w),p,A,M)}function W(p,w,A,M){return Q(function(j,V){for(var G,tt,Z,et=[],it=0;it<j.length&&!((V-=2)<0);++it)G=j.charCodeAt(it),tt=G>>8,Z=G%256,et.push(Z),et.push(tt);return et}(w,p.length-A),p,A,M)}function Y(p,w,A){return w===0&&A===p.length?n.fromByteArray(p):n.fromByteArray(p.slice(w,A))}function C(p,w,A){A=Math.min(p.length,A);for(var M=[],j=w;j<A;){var V,G,tt,Z,et=p[j],it=null,nt=et>239?4:et>223?3:et>191?2:1;if(j+nt<=A)switch(nt){case 1:et<128&&(it=et);break;case 2:(192&(V=p[j+1]))==128&&(Z=(31&et)<<6|63&V)>127&&(it=Z);break;case 3:V=p[j+1],G=p[j+2],(192&V)==128&&(192&G)==128&&(Z=(15&et)<<12|(63&V)<<6|63&G)>2047&&(Z<55296||Z>57343)&&(it=Z);break;case 4:V=p[j+1],G=p[j+2],tt=p[j+3],(192&V)==128&&(192&G)==128&&(192&tt)==128&&(Z=(15&et)<<18|(63&V)<<12|(63&G)<<6|63&tt)>65535&&Z<1114112&&(it=Z)}it===null?(it=65533,nt=1):it>65535&&(it-=65536,M.push(it>>>10&1023|55296),it=56320|1023&it),M.push(it),j+=nt}return function(ot){var at=ot.length;if(at<=k)return String.fromCharCode.apply(String,ot);for(var st="",rt=0;rt<at;)st+=String.fromCharCode.apply(String,ot.slice(rt,rt+=k));return st}(M)}r.kMaxLength=a,l.TYPED_ARRAY_SUPPORT=function(){try{var p=new Uint8Array(1);return p.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},p.foo()===42}catch{return!1}}(),l.TYPED_ARRAY_SUPPORT||typeof console>"u"||typeof console.error!="function"||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}}),typeof Symbol<"u"&&Symbol.species!=null&&l[Symbol.species]===l&&Object.defineProperty(l,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),l.poolSize=8192,l.from=function(p,w,A){return u(p,w,A)},l.prototype.__proto__=Uint8Array.prototype,l.__proto__=Uint8Array,l.alloc=function(p,w,A){return function(M,j,V){return d(M),M<=0?h(M):j!==void 0?typeof V=="string"?h(M).fill(j,V):h(M).fill(j):h(M)}(p,w,A)},l.allocUnsafe=function(p){return f(p)},l.allocUnsafeSlow=function(p){return f(p)},l.isBuffer=function(p){return p!=null&&p._isBuffer===!0&&p!==l.prototype},l.compare=function(p,w){if(X(p,Uint8Array)&&(p=l.from(p,p.offset,p.byteLength)),X(w,Uint8Array)&&(w=l.from(w,w.offset,w.byteLength)),!l.isBuffer(p)||!l.isBuffer(w))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(p===w)return 0;for(var A=p.length,M=w.length,j=0,V=Math.min(A,M);j<V;++j)if(p[j]!==w[j]){A=p[j],M=w[j];break}return A<M?-1:M<A?1:0},l.isEncoding=function(p){switch(String(p).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(p,w){if(!Array.isArray(p))throw new TypeError('"list" argument must be an Array of Buffers');if(p.length===0)return l.alloc(0);var A;if(w===void 0)for(w=0,A=0;A<p.length;++A)w+=p[A].length;var M=l.allocUnsafe(w),j=0;for(A=0;A<p.length;++A){var V=p[A];if(X(V,Uint8Array)&&(V=l.from(V)),!l.isBuffer(V))throw new TypeError('"list" argument must be an Array of Buffers');V.copy(M,j),j+=V.length}return M},l.byteLength=v,l.prototype._isBuffer=!0,l.prototype.swap16=function(){var p=this.length;if(p%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var w=0;w<p;w+=2)b(this,w,w+1);return this},l.prototype.swap32=function(){var p=this.length;if(p%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var w=0;w<p;w+=4)b(this,w,w+3),b(this,w+1,w+2);return this},l.prototype.swap64=function(){var p=this.length;if(p%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var w=0;w<p;w+=8)b(this,w,w+7),b(this,w+1,w+6),b(this,w+2,w+5),b(this,w+3,w+4);return this},l.prototype.toString=function(){var p=this.length;return p===0?"":arguments.length===0?C(this,0,p):(function(w,A,M){var j=!1;if((A===void 0||A<0)&&(A=0),A>this.length||((M===void 0||M>this.length)&&(M=this.length),M<=0)||(M>>>=0)<=(A>>>=0))return"";for(w||(w="utf8");;)switch(w){case"hex":return N(this,A,M);case"utf8":case"utf-8":return C(this,A,M);case"ascii":return R(this,A,M);case"latin1":case"binary":return S(this,A,M);case"base64":return Y(this,A,M);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return H(this,A,M);default:if(j)throw new TypeError("Unknown encoding: "+w);w=(w+"").toLowerCase(),j=!0}}).apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(p){if(!l.isBuffer(p))throw new TypeError("Argument must be a Buffer");return this===p||l.compare(this,p)===0},l.prototype.inspect=function(){var p="",w=r.INSPECT_MAX_BYTES;return p=this.toString("hex",0,w).replace(/(.{2})/g,"$1 ").trim(),this.length>w&&(p+=" ... "),"<Buffer "+p+">"},l.prototype.compare=function(p,w,A,M,j){if(X(p,Uint8Array)&&(p=l.from(p,p.offset,p.byteLength)),!l.isBuffer(p))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof p);if(w===void 0&&(w=0),A===void 0&&(A=p?p.length:0),M===void 0&&(M=0),j===void 0&&(j=this.length),w<0||A>p.length||M<0||j>this.length)throw new RangeError("out of range index");if(M>=j&&w>=A)return 0;if(M>=j)return-1;if(w>=A)return 1;if(w>>>=0,A>>>=0,M>>>=0,j>>>=0,this===p)return 0;for(var V=j-M,G=A-w,tt=Math.min(V,G),Z=this.slice(M,j),et=p.slice(w,A),it=0;it<tt;++it)if(Z[it]!==et[it]){V=Z[it],G=et[it];break}return V<G?-1:G<V?1:0},l.prototype.includes=function(p,w,A){return this.indexOf(p,w,A)!==-1},l.prototype.indexOf=function(p,w,A){return x(this,p,w,A,!0)},l.prototype.lastIndexOf=function(p,w,A){return x(this,p,w,A,!1)},l.prototype.write=function(p,w,A,M){if(w===void 0)M="utf8",A=this.length,w=0;else if(A===void 0&&typeof w=="string")M=w,A=this.length,w=0;else{if(!isFinite(w))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");w>>>=0,isFinite(A)?(A>>>=0,M===void 0&&(M="utf8")):(M=A,A=void 0)}var j=this.length-w;if((A===void 0||A>j)&&(A=j),p.length>0&&(A<0||w<0)||w>this.length)throw new RangeError("Attempt to write outside buffer bounds");M||(M="utf8");for(var V=!1;;)switch(M){case"hex":return T(this,p,w,A);case"utf8":case"utf-8":return I(this,p,w,A);case"ascii":return P(this,p,w,A);case"latin1":case"binary":return E(this,p,w,A);case"base64":return _(this,p,w,A);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return W(this,p,w,A);default:if(V)throw new TypeError("Unknown encoding: "+M);M=(""+M).toLowerCase(),V=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var k=4096;function R(p,w,A){var M="";A=Math.min(p.length,A);for(var j=w;j<A;++j)M+=String.fromCharCode(127&p[j]);return M}function S(p,w,A){var M="";A=Math.min(p.length,A);for(var j=w;j<A;++j)M+=String.fromCharCode(p[j]);return M}function N(p,w,A){var M=p.length;(!w||w<0)&&(w=0),(!A||A<0||A>M)&&(A=M);for(var j="",V=w;V<A;++V)j+=U(p[V]);return j}function H(p,w,A){for(var M=p.slice(w,A),j="",V=0;V<M.length;V+=2)j+=String.fromCharCode(M[V]+256*M[V+1]);return j}function K(p,w,A){if(p%1!=0||p<0)throw new RangeError("offset is not uint");if(p+w>A)throw new RangeError("Trying to access beyond buffer length")}function F(p,w,A,M,j,V){if(!l.isBuffer(p))throw new TypeError('"buffer" argument must be a Buffer instance');if(w>j||w<V)throw new RangeError('"value" argument is out of bounds');if(A+M>p.length)throw new RangeError("Index out of range")}function L(p,w,A,M,j,V){if(A+M>p.length)throw new RangeError("Index out of range");if(A<0)throw new RangeError("Index out of range")}function O(p,w,A,M,j){return w=+w,A>>>=0,j||L(p,0,A,4),c.write(p,w,A,M,23,4),A+4}function z(p,w,A,M,j){return w=+w,A>>>=0,j||L(p,0,A,8),c.write(p,w,A,M,52,8),A+8}l.prototype.slice=function(p,w){var A=this.length;p=~~p,w=w===void 0?A:~~w,p<0?(p+=A)<0&&(p=0):p>A&&(p=A),w<0?(w+=A)<0&&(w=0):w>A&&(w=A),w<p&&(w=p);var M=this.subarray(p,w);return M.__proto__=l.prototype,M},l.prototype.readUIntLE=function(p,w,A){p>>>=0,w>>>=0,A||K(p,w,this.length);for(var M=this[p],j=1,V=0;++V<w&&(j*=256);)M+=this[p+V]*j;return M},l.prototype.readUIntBE=function(p,w,A){p>>>=0,w>>>=0,A||K(p,w,this.length);for(var M=this[p+--w],j=1;w>0&&(j*=256);)M+=this[p+--w]*j;return M},l.prototype.readUInt8=function(p,w){return p>>>=0,w||K(p,1,this.length),this[p]},l.prototype.readUInt16LE=function(p,w){return p>>>=0,w||K(p,2,this.length),this[p]|this[p+1]<<8},l.prototype.readUInt16BE=function(p,w){return p>>>=0,w||K(p,2,this.length),this[p]<<8|this[p+1]},l.prototype.readUInt32LE=function(p,w){return p>>>=0,w||K(p,4,this.length),(this[p]|this[p+1]<<8|this[p+2]<<16)+16777216*this[p+3]},l.prototype.readUInt32BE=function(p,w){return p>>>=0,w||K(p,4,this.length),16777216*this[p]+(this[p+1]<<16|this[p+2]<<8|this[p+3])},l.prototype.readIntLE=function(p,w,A){p>>>=0,w>>>=0,A||K(p,w,this.length);for(var M=this[p],j=1,V=0;++V<w&&(j*=256);)M+=this[p+V]*j;return M>=(j*=128)&&(M-=Math.pow(2,8*w)),M},l.prototype.readIntBE=function(p,w,A){p>>>=0,w>>>=0,A||K(p,w,this.length);for(var M=w,j=1,V=this[p+--M];M>0&&(j*=256);)V+=this[p+--M]*j;return V>=(j*=128)&&(V-=Math.pow(2,8*w)),V},l.prototype.readInt8=function(p,w){return p>>>=0,w||K(p,1,this.length),128&this[p]?-1*(255-this[p]+1):this[p]},l.prototype.readInt16LE=function(p,w){p>>>=0,w||K(p,2,this.length);var A=this[p]|this[p+1]<<8;return 32768&A?4294901760|A:A},l.prototype.readInt16BE=function(p,w){p>>>=0,w||K(p,2,this.length);var A=this[p+1]|this[p]<<8;return 32768&A?4294901760|A:A},l.prototype.readInt32LE=function(p,w){return p>>>=0,w||K(p,4,this.length),this[p]|this[p+1]<<8|this[p+2]<<16|this[p+3]<<24},l.prototype.readInt32BE=function(p,w){return p>>>=0,w||K(p,4,this.length),this[p]<<24|this[p+1]<<16|this[p+2]<<8|this[p+3]},l.prototype.readFloatLE=function(p,w){return p>>>=0,w||K(p,4,this.length),c.read(this,p,!0,23,4)},l.prototype.readFloatBE=function(p,w){return p>>>=0,w||K(p,4,this.length),c.read(this,p,!1,23,4)},l.prototype.readDoubleLE=function(p,w){return p>>>=0,w||K(p,8,this.length),c.read(this,p,!0,52,8)},l.prototype.readDoubleBE=function(p,w){return p>>>=0,w||K(p,8,this.length),c.read(this,p,!1,52,8)},l.prototype.writeUIntLE=function(p,w,A,M){p=+p,w>>>=0,A>>>=0,M||F(this,p,w,A,Math.pow(2,8*A)-1,0);var j=1,V=0;for(this[w]=255&p;++V<A&&(j*=256);)this[w+V]=p/j&255;return w+A},l.prototype.writeUIntBE=function(p,w,A,M){p=+p,w>>>=0,A>>>=0,M||F(this,p,w,A,Math.pow(2,8*A)-1,0);var j=A-1,V=1;for(this[w+j]=255&p;--j>=0&&(V*=256);)this[w+j]=p/V&255;return w+A},l.prototype.writeUInt8=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,1,255,0),this[w]=255&p,w+1},l.prototype.writeUInt16LE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,2,65535,0),this[w]=255&p,this[w+1]=p>>>8,w+2},l.prototype.writeUInt16BE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,2,65535,0),this[w]=p>>>8,this[w+1]=255&p,w+2},l.prototype.writeUInt32LE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,4,4294967295,0),this[w+3]=p>>>24,this[w+2]=p>>>16,this[w+1]=p>>>8,this[w]=255&p,w+4},l.prototype.writeUInt32BE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,4,4294967295,0),this[w]=p>>>24,this[w+1]=p>>>16,this[w+2]=p>>>8,this[w+3]=255&p,w+4},l.prototype.writeIntLE=function(p,w,A,M){if(p=+p,w>>>=0,!M){var j=Math.pow(2,8*A-1);F(this,p,w,A,j-1,-j)}var V=0,G=1,tt=0;for(this[w]=255&p;++V<A&&(G*=256);)p<0&&tt===0&&this[w+V-1]!==0&&(tt=1),this[w+V]=(p/G>>0)-tt&255;return w+A},l.prototype.writeIntBE=function(p,w,A,M){if(p=+p,w>>>=0,!M){var j=Math.pow(2,8*A-1);F(this,p,w,A,j-1,-j)}var V=A-1,G=1,tt=0;for(this[w+V]=255&p;--V>=0&&(G*=256);)p<0&&tt===0&&this[w+V+1]!==0&&(tt=1),this[w+V]=(p/G>>0)-tt&255;return w+A},l.prototype.writeInt8=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,1,127,-128),p<0&&(p=255+p+1),this[w]=255&p,w+1},l.prototype.writeInt16LE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,2,32767,-32768),this[w]=255&p,this[w+1]=p>>>8,w+2},l.prototype.writeInt16BE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,2,32767,-32768),this[w]=p>>>8,this[w+1]=255&p,w+2},l.prototype.writeInt32LE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,4,2147483647,-2147483648),this[w]=255&p,this[w+1]=p>>>8,this[w+2]=p>>>16,this[w+3]=p>>>24,w+4},l.prototype.writeInt32BE=function(p,w,A){return p=+p,w>>>=0,A||F(this,p,w,4,2147483647,-2147483648),p<0&&(p=4294967295+p+1),this[w]=p>>>24,this[w+1]=p>>>16,this[w+2]=p>>>8,this[w+3]=255&p,w+4},l.prototype.writeFloatLE=function(p,w,A){return O(this,p,w,!0,A)},l.prototype.writeFloatBE=function(p,w,A){return O(this,p,w,!1,A)},l.prototype.writeDoubleLE=function(p,w,A){return z(this,p,w,!0,A)},l.prototype.writeDoubleBE=function(p,w,A){return z(this,p,w,!1,A)},l.prototype.copy=function(p,w,A,M){if(!l.isBuffer(p))throw new TypeError("argument should be a Buffer");if(A||(A=0),M||M===0||(M=this.length),w>=p.length&&(w=p.length),w||(w=0),M>0&&M<A&&(M=A),M===A||p.length===0||this.length===0)return 0;if(w<0)throw new RangeError("targetStart out of bounds");if(A<0||A>=this.length)throw new RangeError("Index out of range");if(M<0)throw new RangeError("sourceEnd out of bounds");M>this.length&&(M=this.length),p.length-w<M-A&&(M=p.length-w+A);var j=M-A;if(this===p&&typeof Uint8Array.prototype.copyWithin=="function")this.copyWithin(w,A,M);else if(this===p&&A<w&&w<M)for(var V=j-1;V>=0;--V)p[V+w]=this[V+A];else Uint8Array.prototype.set.call(p,this.subarray(A,M),w);return j},l.prototype.fill=function(p,w,A,M){if(typeof p=="string"){if(typeof w=="string"?(M=w,w=0,A=this.length):typeof A=="string"&&(M=A,A=this.length),M!==void 0&&typeof M!="string")throw new TypeError("encoding must be a string");if(typeof M=="string"&&!l.isEncoding(M))throw new TypeError("Unknown encoding: "+M);if(p.length===1){var j=p.charCodeAt(0);(M==="utf8"&&j<128||M==="latin1")&&(p=j)}}else typeof p=="number"&&(p&=255);if(w<0||this.length<w||this.length<A)throw new RangeError("Out of range index");if(A<=w)return this;var V;if(w>>>=0,A=A===void 0?this.length:A>>>0,p||(p=0),typeof p=="number")for(V=w;V<A;++V)this[V]=p;else{var G=l.isBuffer(p)?p:l.from(p,M),tt=G.length;if(tt===0)throw new TypeError('The value "'+p+'" is invalid for argument "value"');for(V=0;V<A-w;++V)this[V+w]=G[V%tt]}return this};var B=/[^+/0-9A-Za-z-_]/g;function U(p){return p<16?"0"+p.toString(16):p.toString(16)}function $(p,w){var A;w=w||1/0;for(var M=p.length,j=null,V=[],G=0;G<M;++G){if((A=p.charCodeAt(G))>55295&&A<57344){if(!j){if(A>56319){(w-=3)>-1&&V.push(239,191,189);continue}if(G+1===M){(w-=3)>-1&&V.push(239,191,189);continue}j=A;continue}if(A<56320){(w-=3)>-1&&V.push(239,191,189),j=A;continue}A=65536+(j-55296<<10|A-56320)}else j&&(w-=3)>-1&&V.push(239,191,189);if(j=null,A<128){if((w-=1)<0)break;V.push(A)}else if(A<2048){if((w-=2)<0)break;V.push(A>>6|192,63&A|128)}else if(A<65536){if((w-=3)<0)break;V.push(A>>12|224,A>>6&63|128,63&A|128)}else{if(!(A<1114112))throw new Error("Invalid code point");if((w-=4)<0)break;V.push(A>>18|240,A>>12&63|128,A>>6&63|128,63&A|128)}}return V}function q(p){return n.toByteArray(function(w){if((w=(w=w.split("=")[0]).trim().replace(B,"")).length<2)return"";for(;w.length%4!=0;)w+="=";return w}(p))}function Q(p,w,A,M){for(var j=0;j<M&&!(j+A>=w.length||j>=p.length);++j)w[j+A]=p[j];return j}function X(p,w){return p instanceof w||p!=null&&p.constructor!=null&&p.constructor.name!=null&&p.constructor.name===w.name}function J(p){return p!=p}}).call(this)}).call(this,i("buffer").Buffer)},{"base64-js":13,buffer:17,ieee754:23}],18:[function(i,s,r){(function(o){(function(){r.formatArgs=function(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const a="color: "+this.color;c.splice(1,0,a,"color: inherit");let h=0,l=0;c[0].replace(/%[a-zA-Z%]/g,u=>{u!=="%%"&&u==="%c"&&(l=++h)}),c.splice(l,0,a)},r.save=function(c){try{c?r.storage.setItem("debug",c):r.storage.removeItem("debug")}catch{}},r.load=function(){let c;try{c=r.storage.getItem("debug")}catch{}return!c&&o!==void 0&&"env"in o&&(c=o.env.DEBUG),c},r.useColors=function(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},r.storage=function(){try{return localStorage}catch{}}(),r.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),r.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],r.log=console.debug||console.log||(()=>{}),s.exports=i("./common")(r);const{formatters:n}=s.exports;n.j=function(c){try{return JSON.stringify(c)}catch(a){return"[UnexpectedJSONParseError]: "+a.message}}}).call(this)}).call(this,i("_process"))},{"./common":19,_process:50}],19:[function(i,s,r){s.exports=function(o){function n(h){let l,u,d,f=null;function g(...y){if(!g.enabled)return;const v=g,b=Number(new Date),x=b-(l||b);v.diff=x,v.prev=l,v.curr=b,l=b,y[0]=n.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let m=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(T,I)=>{if(T==="%%")return"%";m++;const P=n.formatters[I];if(typeof P=="function"){const E=y[m];T=P.call(v,E),y.splice(m,1),m--}return T}),n.formatArgs.call(v,y),(v.log||n.log).apply(v,y)}return g.namespace=h,g.useColors=n.useColors(),g.color=n.selectColor(h),g.extend=c,g.destroy=n.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(u!==n.namespaces&&(u=n.namespaces,d=n.enabled(h)),d),set:y=>{f=y}}),typeof n.init=="function"&&n.init(g),g}function c(h,l){const u=n(this.namespace+(l===void 0?":":l)+h);return u.log=this.log,u}function a(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}return n.debug=n,n.default=n,n.coerce=function(h){return h instanceof Error?h.stack||h.message:h},n.disable=function(){const h=[...n.names.map(a),...n.skips.map(a).map(l=>"-"+l)].join(",");return n.enable(""),h},n.enable=function(h){let l;n.save(h),n.namespaces=h,n.names=[],n.skips=[];const u=(typeof h=="string"?h:"").split(/[\s,]+/),d=u.length;for(l=0;l<d;l++)u[l]&&((h=u[l].replace(/\*/g,".*?"))[0]==="-"?n.skips.push(new RegExp("^"+h.substr(1)+"$")):n.names.push(new RegExp("^"+h+"$")))},n.enabled=function(h){if(h[h.length-1]==="*")return!0;let l,u;for(l=0,u=n.skips.length;l<u;l++)if(n.skips[l].test(h))return!1;for(l=0,u=n.names.length;l<u;l++)if(n.names[l].test(h))return!0;return!1},n.humanize=i("ms"),n.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(o).forEach(h=>{n[h]=o[h]}),n.names=[],n.skips=[],n.formatters={},n.selectColor=function(h){let l=0;for(let u=0;u<h.length;u++)l=(l<<5)-l+h.charCodeAt(u),l|=0;return n.colors[Math.abs(l)%n.colors.length]},n.enable(n.load()),n}},{ms:45}],20:[function(i,s,r){(function(o,n){(function(){var c=i("readable-stream"),a=i("end-of-stream"),h=i("inherits"),l=i("stream-shift"),u=n.from&&n.from!==Uint8Array.from?n.from([0]):new n([0]),d=function(v,b){v._corked?v.once("uncork",b):b()},f=function(v,b){return function(x){x?function(m,T){m._autoDestroy&&m.destroy(T)}(v,x.message==="premature close"?null:x):b&&!v._ended&&v.end()}},g=function(){},y=function(v,b,x){if(!(this instanceof y))return new y(v,b,x);c.Duplex.call(this,x),this._writable=null,this._readable=null,this._readable2=null,this._autoDestroy=!x||x.autoDestroy!==!1,this._forwardDestroy=!x||x.destroy!==!1,this._forwardEnd=!x||x.end!==!1,this._corked=1,this._ondrain=null,this._drained=!1,this._forwarding=!1,this._unwrite=null,this._unread=null,this._ended=!1,this.destroyed=!1,v&&this.setWritable(v),b&&this.setReadable(b)};h(y,c.Duplex),y.obj=function(v,b,x){return x||(x={}),x.objectMode=!0,x.highWaterMark=16,new y(v,b,x)},y.prototype.cork=function(){++this._corked==1&&this.emit("cork")},y.prototype.uncork=function(){this._corked&&--this._corked==0&&this.emit("uncork")},y.prototype.setWritable=function(v){if(this._unwrite&&this._unwrite(),this.destroyed)v&&v.destroy&&v.destroy();else if(v!==null&&v!==!1){var b=this,x=a(v,{writable:!0,readable:!1},f(this,this._forwardEnd)),m=function(){var T=b._ondrain;b._ondrain=null,T&&T()};this._unwrite&&o.nextTick(m),this._writable=v,this._writable.on("drain",m),this._unwrite=function(){b._writable.removeListener("drain",m),x()},this.uncork()}else this.end()},y.prototype.setReadable=function(v){if(this._unread&&this._unread(),this.destroyed)v&&v.destroy&&v.destroy();else{if(v===null||v===!1)return this.push(null),void this.resume();var b,x=this,m=a(v,{writable:!1,readable:!0},f(this)),T=function(){x._forward()},I=function(){x.push(null)};this._drained=!0,this._readable=v,this._readable2=v._readableState?v:(b=v,new c.Readable({objectMode:!0,highWaterMark:16}).wrap(b)),this._readable2.on("readable",T),this._readable2.on("end",I),this._unread=function(){x._readable2.removeListener("readable",T),x._readable2.removeListener("end",I),m()},this._forward()}},y.prototype._read=function(){this._drained=!0,this._forward()},y.prototype._forward=function(){if(!this._forwarding&&this._readable2&&this._drained){var v;for(this._forwarding=!0;this._drained&&(v=l(this._readable2))!==null;)this.destroyed||(this._drained=this.push(v));this._forwarding=!1}},y.prototype.destroy=function(v,b){if(b||(b=g),this.destroyed)return b(null);this.destroyed=!0;var x=this;o.nextTick(function(){x._destroy(v),b(null)})},y.prototype._destroy=function(v){if(v){var b=this._ondrain;this._ondrain=null,b?b(v):this.emit("error",v)}this._forwardDestroy&&(this._readable&&this._readable.destroy&&this._readable.destroy(),this._writable&&this._writable.destroy&&this._writable.destroy()),this.emit("close")},y.prototype._write=function(v,b,x){if(!this.destroyed)return this._corked?d(this,this._write.bind(this,v,b,x)):v===u?this._finish(x):this._writable?void(this._writable.write(v)===!1?this._ondrain=x:this.destroyed||x()):x()},y.prototype._finish=function(v){var b=this;this.emit("preend"),d(this,function(){var x,m;x=b._forwardEnd&&b._writable,m=function(){b._writableState.prefinished===!1&&(b._writableState.prefinished=!0),b.emit("prefinish"),d(b,v)},x?x._writableState&&x._writableState.finished?m():x._writableState?x.end(m):(x.end(),m()):m()})},y.prototype.end=function(v,b,x){return typeof v=="function"?this.end(null,null,v):typeof b=="function"?this.end(v,null,b):(this._ended=!0,v&&this.write(v),this._writableState.ending||this._writableState.destroyed||this.write(u),c.Writable.prototype.end.call(this,x))},s.exports=y}).call(this)}).call(this,i("_process"),i("buffer").Buffer)},{_process:50,buffer:17,"end-of-stream":21,inherits:24,"readable-stream":69,"stream-shift":74}],21:[function(i,s,r){(function(o){(function(){var n=i("once"),c=function(){},a=function(h,l,u){if(typeof l=="function")return a(h,null,l);l||(l={}),u=n(u||c);var d=h._writableState,f=h._readableState,g=l.readable||l.readable!==!1&&h.readable,y=l.writable||l.writable!==!1&&h.writable,v=!1,b=function(){h.writable||x()},x=function(){y=!1,g||u.call(h)},m=function(){g=!1,y||u.call(h)},T=function(W){u.call(h,W?new Error("exited with error code: "+W):null)},I=function(W){u.call(h,W)},P=function(){o.nextTick(E)},E=function(){if(!v)return(!g||f&&f.ended&&!f.destroyed)&&(!y||d&&d.ended&&!d.destroyed)?void 0:u.call(h,new Error("premature close"))},_=function(){h.req.on("finish",x)};return function(W){return W.setHeader&&typeof W.abort=="function"}(h)?(h.on("complete",x),h.on("abort",P),h.req?_():h.on("request",_)):y&&!d&&(h.on("end",b),h.on("close",b)),function(W){return W.stdio&&Array.isArray(W.stdio)&&W.stdio.length===3}(h)&&h.on("exit",T),h.on("end",m),h.on("finish",x),l.error!==!1&&h.on("error",I),h.on("close",P),function(){v=!0,h.removeListener("complete",x),h.removeListener("abort",P),h.removeListener("request",_),h.req&&h.req.removeListener("finish",x),h.removeListener("end",b),h.removeListener("close",b),h.removeListener("finish",x),h.removeListener("exit",T),h.removeListener("end",m),h.removeListener("error",I),h.removeListener("close",P)}};s.exports=a}).call(this)}).call(this,i("_process"))},{_process:50,once:48}],22:[function(i,s,r){var o=Object.create||function(m){var T=function(){};return T.prototype=m,new T},n=Object.keys||function(m){var T=[];for(var I in m)Object.prototype.hasOwnProperty.call(m,I)&&T.push(I);return I},c=Function.prototype.bind||function(m){var T=this;return function(){return T.apply(m,arguments)}};function a(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=o(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}s.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._maxListeners=void 0;var h,l=10;try{var u={};Object.defineProperty&&Object.defineProperty(u,"x",{value:0}),h=u.x===0}catch{h=!1}function d(m){return m._maxListeners===void 0?a.defaultMaxListeners:m._maxListeners}function f(m,T,I,P){var E,_,W;if(typeof I!="function")throw new TypeError('"listener" argument must be a function');if((_=m._events)?(_.newListener&&(m.emit("newListener",T,I.listener?I.listener:I),_=m._events),W=_[T]):(_=m._events=o(null),m._eventsCount=0),W){if(typeof W=="function"?W=_[T]=P?[I,W]:[W,I]:P?W.unshift(I):W.push(I),!W.warned&&(E=d(m))&&E>0&&W.length>E){W.warned=!0;var Y=new Error("Possible EventEmitter memory leak detected. "+W.length+' "'+String(T)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');Y.name="MaxListenersExceededWarning",Y.emitter=m,Y.type=T,Y.count=W.length,typeof console=="object"&&console.warn&&console.warn("%s: %s",Y.name,Y.message)}}else W=_[T]=I,++m._eventsCount;return m}function g(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var m=new Array(arguments.length),T=0;T<m.length;++T)m[T]=arguments[T];this.listener.apply(this.target,m)}}function y(m,T,I){var P={fired:!1,wrapFn:void 0,target:m,type:T,listener:I},E=c.call(g,P);return E.listener=I,P.wrapFn=E,E}function v(m,T,I){var P=m._events;if(!P)return[];var E=P[T];return E?typeof E=="function"?I?[E.listener||E]:[E]:I?function(_){for(var W=new Array(_.length),Y=0;Y<W.length;++Y)W[Y]=_[Y].listener||_[Y];return W}(E):x(E,E.length):[]}function b(m){var T=this._events;if(T){var I=T[m];if(typeof I=="function")return 1;if(I)return I.length}return 0}function x(m,T){for(var I=new Array(T),P=0;P<T;++P)I[P]=m[P];return I}h?Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(m){if(typeof m!="number"||m<0||m!=m)throw new TypeError('"defaultMaxListeners" must be a positive number');l=m}}):a.defaultMaxListeners=l,a.prototype.setMaxListeners=function(m){if(typeof m!="number"||m<0||isNaN(m))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=m,this},a.prototype.getMaxListeners=function(){return d(this)},a.prototype.emit=function(m){var T,I,P,E,_,W,Y=m==="error";if(W=this._events)Y=Y&&W.error==null;else if(!Y)return!1;if(Y){if(arguments.length>1&&(T=arguments[1]),T instanceof Error)throw T;var C=new Error('Unhandled "error" event. ('+T+")");throw C.context=T,C}if(!(I=W[m]))return!1;var k=typeof I=="function";switch(P=arguments.length){case 1:(function(R,S,N){if(S)R.call(N);else for(var H=R.length,K=x(R,H),F=0;F<H;++F)K[F].call(N)})(I,k,this);break;case 2:(function(R,S,N,H){if(S)R.call(N,H);else for(var K=R.length,F=x(R,K),L=0;L<K;++L)F[L].call(N,H)})(I,k,this,arguments[1]);break;case 3:(function(R,S,N,H,K){if(S)R.call(N,H,K);else for(var F=R.length,L=x(R,F),O=0;O<F;++O)L[O].call(N,H,K)})(I,k,this,arguments[1],arguments[2]);break;case 4:(function(R,S,N,H,K,F){if(S)R.call(N,H,K,F);else for(var L=R.length,O=x(R,L),z=0;z<L;++z)O[z].call(N,H,K,F)})(I,k,this,arguments[1],arguments[2],arguments[3]);break;default:for(E=new Array(P-1),_=1;_<P;_++)E[_-1]=arguments[_];(function(R,S,N,H){if(S)R.apply(N,H);else for(var K=R.length,F=x(R,K),L=0;L<K;++L)F[L].apply(N,H)})(I,k,this,E)}return!0},a.prototype.addListener=function(m,T){return f(this,m,T,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(m,T){return f(this,m,T,!0)},a.prototype.once=function(m,T){if(typeof T!="function")throw new TypeError('"listener" argument must be a function');return this.on(m,y(this,m,T)),this},a.prototype.prependOnceListener=function(m,T){if(typeof T!="function")throw new TypeError('"listener" argument must be a function');return this.prependListener(m,y(this,m,T)),this},a.prototype.removeListener=function(m,T){var I,P,E,_,W;if(typeof T!="function")throw new TypeError('"listener" argument must be a function');if(!(P=this._events))return this;if(!(I=P[m]))return this;if(I===T||I.listener===T)--this._eventsCount==0?this._events=o(null):(delete P[m],P.removeListener&&this.emit("removeListener",m,I.listener||T));else if(typeof I!="function"){for(E=-1,_=I.length-1;_>=0;_--)if(I[_]===T||I[_].listener===T){W=I[_].listener,E=_;break}if(E<0)return this;E===0?I.shift():function(Y,C){for(var k=C,R=k+1,S=Y.length;R<S;k+=1,R+=1)Y[k]=Y[R];Y.pop()}(I,E),I.length===1&&(P[m]=I[0]),P.removeListener&&this.emit("removeListener",m,W||T)}return this},a.prototype.removeAllListeners=function(m){var T,I,P;if(!(I=this._events))return this;if(!I.removeListener)return arguments.length===0?(this._events=o(null),this._eventsCount=0):I[m]&&(--this._eventsCount==0?this._events=o(null):delete I[m]),this;if(arguments.length===0){var E,_=n(I);for(P=0;P<_.length;++P)(E=_[P])!=="removeListener"&&this.removeAllListeners(E);return this.removeAllListeners("removeListener"),this._events=o(null),this._eventsCount=0,this}if(typeof(T=I[m])=="function")this.removeListener(m,T);else if(T)for(P=T.length-1;P>=0;P--)this.removeListener(m,T[P]);return this},a.prototype.listeners=function(m){return v(this,m,!0)},a.prototype.rawListeners=function(m){return v(this,m,!1)},a.listenerCount=function(m,T){return typeof m.listenerCount=="function"?m.listenerCount(T):b.call(m,T)},a.prototype.listenerCount=b,a.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],23:[function(i,s,r){r.read=function(o,n,c,a,h){var l,u,d=8*h-a-1,f=(1<<d)-1,g=f>>1,y=-7,v=c?h-1:0,b=c?-1:1,x=o[n+v];for(v+=b,l=x&(1<<-y)-1,x>>=-y,y+=d;y>0;l=256*l+o[n+v],v+=b,y-=8);for(u=l&(1<<-y)-1,l>>=-y,y+=a;y>0;u=256*u+o[n+v],v+=b,y-=8);if(l===0)l=1-g;else{if(l===f)return u?NaN:1/0*(x?-1:1);u+=Math.pow(2,a),l-=g}return(x?-1:1)*u*Math.pow(2,l-a)},r.write=function(o,n,c,a,h,l){var u,d,f,g=8*l-h-1,y=(1<<g)-1,v=y>>1,b=h===23?Math.pow(2,-24)-Math.pow(2,-77):0,x=a?0:l-1,m=a?1:-1,T=n<0||n===0&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(d=isNaN(n)?1:0,u=y):(u=Math.floor(Math.log(n)/Math.LN2),n*(f=Math.pow(2,-u))<1&&(u--,f*=2),(n+=u+v>=1?b/f:b*Math.pow(2,1-v))*f>=2&&(u++,f/=2),u+v>=y?(d=0,u=y):u+v>=1?(d=(n*f-1)*Math.pow(2,h),u+=v):(d=n*Math.pow(2,v-1)*Math.pow(2,h),u=0));h>=8;o[c+x]=255&d,x+=m,d/=256,h-=8);for(u=u<<h|d,g+=h;g>0;o[c+x]=255&u,x+=m,u/=256,g-=8);o[c+x-m]|=128*T}},{}],24:[function(i,s,r){typeof Object.create=="function"?s.exports=function(o,n){n&&(o.super_=n,o.prototype=Object.create(n.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}))}:s.exports=function(o,n){if(n){o.super_=n;var c=function(){};c.prototype=n.prototype,o.prototype=new c,o.prototype.constructor=o}}},{}],25:[function(i,s,r){Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function n(c,a){this.color=!0,this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0,this.leftChild=void 0,this.rightChild=void 0,this.key=c,this.value=a}return n.prototype.rotateLeft=function(){var c=this.parent,a=this.brother,h=this.leftChild,l=this.rightChild;if(!l)throw new Error("unknown error");var u=l.leftChild,d=l.rightChild;return c&&(c.leftChild===this?c.leftChild=l:c.rightChild===this&&(c.rightChild=l)),l.parent=c,l.brother=a,l.leftChild=this,l.rightChild=d,a&&(a.brother=l),this.parent=l,this.brother=d,this.leftChild=h,this.rightChild=u,d&&(d.parent=l,d.brother=this),h&&(h.parent=this,h.brother=u),u&&(u.parent=this,u.brother=h),l},n.prototype.rotateRight=function(){var c=this.parent,a=this.brother,h=this.leftChild;if(!h)throw new Error("unknown error");var l=this.rightChild,u=h.leftChild,d=h.rightChild;return c&&(c.leftChild===this?c.leftChild=h:c.rightChild===this&&(c.rightChild=h)),h.parent=c,h.brother=a,h.leftChild=u,h.rightChild=this,a&&(a.brother=h),u&&(u.parent=h,u.brother=this),this.parent=h,this.brother=u,this.leftChild=d,this.rightChild=l,d&&(d.parent=this,d.brother=l),l&&(l.parent=this,l.brother=d),h},n.prototype.remove=function(){if(this.leftChild||this.rightChild)throw new Error("can only remove leaf node");this.parent&&(this===this.parent.leftChild?this.parent.leftChild=void 0:this===this.parent.rightChild&&(this.parent.rightChild=void 0)),this.brother&&(this.brother.brother=void 0),this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0},n.TreeNodeColorType={red:!0,black:!1},n}();Object.freeze(o),r.default=o},{}],26:[function(i,s,r){var o=this&&this.__generator||function(c,a){var h,l,u,d,f={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return d={next:g(0),throw:g(1),return:g(2)},typeof Symbol=="function"&&(d[Symbol.iterator]=function(){return this}),d;function g(y){return function(v){return function(b){if(h)throw new TypeError("Generator is already executing.");for(;f;)try{if(h=1,l&&(u=2&b[0]?l.return:b[0]?l.throw||((u=l.return)&&u.call(l),0):l.next)&&!(u=u.call(l,b[1])).done)return u;switch(l=0,u&&(b=[2&b[0],u.value]),b[0]){case 0:case 1:u=b;break;case 4:return f.label++,{value:b[1],done:!1};case 5:f.label++,l=b[1],b=[0];continue;case 7:b=f.ops.pop(),f.trys.pop();continue;default:if(!(u=(u=f.trys).length>0&&u[u.length-1])&&(b[0]===6||b[0]===2)){f=0;continue}if(b[0]===3&&(!u||b[1]>u[0]&&b[1]<u[3])){f.label=b[1];break}if(b[0]===6&&f.label<u[1]){f.label=u[1],u=b;break}if(u&&f.label<u[2]){f.label=u[2],f.ops.push(b);break}u[2]&&f.ops.pop(),f.trys.pop();continue}b=a.call(c,f)}catch(x){b=[6,x],l=0}finally{h=u=0}if(5&b[0])throw b[1];return{value:b[0]?b[1]:void 0,done:!0}}([y,v])}}};function n(c){var a=this;c===void 0&&(c=[]);var h=[],l=0,u=0,d=0,f=0,g=0,y=0;this.size=function(){return y},this.empty=function(){return y===0},this.clear=function(){l=d=u=f=g=y=0,b.call(this,n.bucketSize),y=0},this.front=function(){return h[l][u]},this.back=function(){return h[d][f]},this.forEach=function(x){if(!this.empty()){var m=0;if(l!==d){for(I=u;I<n.bucketSize;++I)x(h[l][I],m++);for(I=l+1;I<d;++I)for(var T=0;T<n.bucketSize;++T)x(h[I][T],m++);for(I=0;I<=f;++I)x(h[d][I],m++)}else for(var I=u;I<=f;++I)x(h[l][I],m++)}};var v=function(x){var m=l*n.bucketSize+u,T=m+x,I=d*n.bucketSize+f;if(T<m||T>I)throw new Error("pos should more than 0 and less than queue's size");return{curNodeBucketIndex:Math.floor(T/n.bucketSize),curNodePointerIndex:T%n.bucketSize}};this.getElementByPos=function(x){var m=v(x),T=m.curNodeBucketIndex,I=m.curNodePointerIndex;return h[T][I]},this.eraseElementByPos=function(x){var m=this;if(x<0||x>y)throw new Error("pos should more than 0 and less than queue's size");if(x===0)this.popFront();else if(x===this.size())this.popBack();else{for(var T=[],I=x+1;I<y;++I)T.push(this.getElementByPos(I));this.cut(x),this.popBack(),T.forEach(function(P){return m.pushBack(P)})}},this.eraseElementByValue=function(x){if(!this.empty()){var m=[];this.forEach(function(P){P!==x&&m.push(P)});for(var T=m.length,I=0;I<T;++I)this.setElementByPos(I,m[I]);this.cut(T-1)}};var b=function(x){for(var m=[],T=x*n.sigma,I=Math.max(Math.ceil(T/n.bucketSize),2),P=0;P<I;++P)m.push(new Array(n.bucketSize));var E=Math.ceil(x/n.bucketSize),_=Math.floor(I/2)-Math.floor(E/2),W=_,Y=0;if(this.size())for(P=0;P<E;++P){for(var C=0;C<n.bucketSize;++C)if(m[_+P][C]=this.front(),this.popFront(),this.empty()){W=_+P,Y=C;break}if(this.empty())break}h=m,l=_,u=0,d=W,f=Y,g=I,y=x};this.pushBack=function(x){this.empty()||(d===g-1&&f===n.bucketSize-1&&b.call(this,this.size()),f<n.bucketSize-1?++f:d<g-1&&(++d,f=0)),++y,h[d][f]=x},this.popBack=function(){this.empty()||(this.size()!==1&&(f>0?--f:l<d&&(--d,f=n.bucketSize-1)),y>0&&--y)},this.setElementByPos=function(x,m){var T=v(x),I=T.curNodeBucketIndex,P=T.curNodePointerIndex;h[I][P]=m},this.insert=function(x,m,T){var I=this;if(T===void 0&&(T=1),x===0)for(;T--;)this.pushFront(m);else if(x===this.size())for(;T--;)this.pushBack(m);else{for(var P=[],E=x;E<y;++E)P.push(this.getElementByPos(E));for(this.cut(x-1),E=0;E<T;++E)this.pushBack(m);P.forEach(function(_){return I.pushBack(_)})}},this.find=function(x){if(l===d){for(var m=u;m<=f;++m)if(h[l][m]===x)return!0;return!1}for(m=u;m<n.bucketSize;++m)if(h[l][m]===x)return!0;for(m=l+1;m<d;++m)for(var T=0;T<n.bucketSize;++T)if(h[m][T]===x)return!0;for(m=0;m<=f;++m)if(h[d][m]===x)return!0;return!1},this.reverse=function(){for(var x=0,m=y-1;x<m;){var T=this.getElementByPos(x);this.setElementByPos(x,this.getElementByPos(m)),this.setElementByPos(m,T),++x,--m}},this.unique=function(){if(!this.empty()){var x=[],m=this.front();this.forEach(function(I,P){P!==0&&I===m||(x.push(I),m=I)});for(var T=0;T<y;++T)this.setElementByPos(T,x[T]);this.cut(x.length-1)}},this.sort=function(x){var m=[];this.forEach(function(I){m.push(I)}),m.sort(x);for(var T=0;T<y;++T)this.setElementByPos(T,m[T])},this.pushFront=function(x){this.empty()||(l===0&&u===0&&b.call(this,this.size()),u>0?--u:l>0&&(--l,u=n.bucketSize-1)),++y,h[l][u]=x},this.popFront=function(){this.empty()||(this.size()!==1&&(u<n.bucketSize-1?++u:l<d&&(++l,u=0)),y>0&&--y)},this.shrinkToFit=function(){var x=this,m=[];this.forEach(function(E){m.push(E)});var T=m.length;h=[];for(var I=Math.ceil(T/n.bucketSize),P=0;P<I;++P)h.push(new Array(n.bucketSize));this.clear(),m.forEach(function(E){return x.pushBack(E)})},this.cut=function(x){if(x<0)this.clear();else{var m=v(x),T=m.curNodeBucketIndex,I=m.curNodePointerIndex;d=T,f=I,y=x+1}},this[Symbol.iterator]=function(){return function(){var x,m;return o(this,function(T){switch(T.label){case 0:if(y===0)return[2];if(l!==d)return[3,5];m=u,T.label=1;case 1:return m<=f?[4,h[l][m]]:[3,4];case 2:T.sent(),T.label=3;case 3:return++m,[3,1];case 4:return[2];case 5:m=u,T.label=6;case 6:return m<n.bucketSize?[4,h[l][m]]:[3,9];case 7:T.sent(),T.label=8;case 8:return++m,[3,6];case 9:m=l+1,T.label=10;case 10:if(!(m<d))return[3,15];x=0,T.label=11;case 11:return x<n.bucketSize?[4,h[m][x]]:[3,14];case 12:T.sent(),T.label=13;case 13:return++x,[3,11];case 14:return++m,[3,10];case 15:m=0,T.label=16;case 16:return m<=f?[4,h[d][m]]:[3,19];case 17:T.sent(),T.label=18;case 18:return++m,[3,16];case 19:return[2]}})}()},function(){var x=n.bucketSize;c.size?x=c.size():c.length&&(x=c.length);var m=x*n.sigma;g=Math.ceil(m/n.bucketSize),g=Math.max(g,3);for(var T=0;T<g;++T)h.push(new Array(n.bucketSize));var I=Math.ceil(x/n.bucketSize);l=Math.floor(g/2)-Math.floor(I/2),d=l,c.forEach(function(P){return a.pushBack(P)})}(),Object.freeze(this)}Object.defineProperty(r,"__esModule",{value:!0}),n.sigma=3,n.bucketSize=5e3,Object.freeze(n),r.default=n},{}],27:[function(i,s,r){var o=this&&this.__generator||function(l,u){var d,f,g,y,v={label:0,sent:function(){if(1&g[0])throw g[1];return g[1]},trys:[],ops:[]};return y={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(y[Symbol.iterator]=function(){return this}),y;function b(x){return function(m){return function(T){if(d)throw new TypeError("Generator is already executing.");for(;v;)try{if(d=1,f&&(g=2&T[0]?f.return:T[0]?f.throw||((g=f.return)&&g.call(f),0):f.next)&&!(g=g.call(f,T[1])).done)return g;switch(f=0,g&&(T=[2&T[0],g.value]),T[0]){case 0:case 1:g=T;break;case 4:return v.label++,{value:T[1],done:!1};case 5:v.label++,f=T[1],T=[0];continue;case 7:T=v.ops.pop(),v.trys.pop();continue;default:if(!(g=(g=v.trys).length>0&&g[g.length-1])&&(T[0]===6||T[0]===2)){v=0;continue}if(T[0]===3&&(!g||T[1]>g[0]&&T[1]<g[3])){v.label=T[1];break}if(T[0]===6&&v.label<g[1]){v.label=g[1],g=T;break}if(g&&v.label<g[2]){v.label=g[2],v.ops.push(T);break}g[2]&&v.ops.pop(),v.trys.pop();continue}T=u.call(l,v)}catch(I){T=[6,I],f=0}finally{d=g=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([x,m])}}},n=this&&this.__values||function(l){var u=typeof Symbol=="function"&&Symbol.iterator,d=u&&l[u],f=0;if(d)return d.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&f>=l.length&&(l=void 0),{value:l&&l[f++],done:!l}}};throw new TypeError(u?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0});var c=i("../LinkList/LinkList"),a=i("../Map/Map");function h(l,u,d){var f=this;if(l===void 0&&(l=[]),u===void 0&&(u=h.initSize),d=d||function(b){var x,m,T=0,I="";if(typeof b=="number")T=((T=Math.floor(b))<<5)-T,T&=T;else{I=typeof b!="string"?JSON.stringify(b):b;try{for(var P=n(I),E=P.next();!E.done;E=P.next())T=(T<<5)-T+E.value.charCodeAt(0),T&=T}catch(_){x={error:_}}finally{try{E&&!E.done&&(m=P.return)&&m.call(P)}finally{if(x)throw x.error}}}return T^=T>>>16},(u&u-1)!=0)throw new Error("initBucketNum must be 2 to the power of n");var g=0,y=[],v=Math.max(h.initSize,Math.min(h.maxSize,u));this.size=function(){return g},this.empty=function(){return g===0},this.clear=function(){g=0,v=u,y=[]},this.forEach=function(b){var x=0;y.forEach(function(m){m.forEach(function(T){b(T,x++)})})},this.setElement=function(b,x){var m,T;if(b==null)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(x!=null){var I=d(b)&v-1;if(y[I]){var P=y[I].size();if(y[I]instanceof c.default){try{for(var E=n(y[I]),_=E.next();!_.done;_=E.next()){var W=_.value;if(W.key===b)return void(W.value=x)}}catch(C){m={error:C}}finally{try{_&&!_.done&&(T=E.return)&&T.call(E)}finally{if(m)throw m.error}}y[I].pushBack({key:b,value:x}),y[I].size()>=h.treeifyThreshold&&(y[I]=new a.default(y[I]))}else y[I].setElement(b,x);var Y=y[I].size();g+=Y-P}else++g,y[I]=new c.default([{key:b,value:x}]);g>v*h.sigma&&(function(C){if(!(C>=h.maxSize)){v=2*C;var k=[];y.forEach(function(R,S){if(!R.empty()){if(R instanceof c.default&&R.size()===1){var N=R.front(),H=N.key,K=N.value;k[d(H)&v-1]=new c.default([{key:H,value:K}])}else if(R instanceof a.default){var F=new c.default,L=new c.default;R.forEach(function(B){d(B.key)&C?L.pushBack(B):F.pushBack(B)}),F.size()>h.untreeifyThreshold?k[S]=new a.default(F):F.size()&&(k[S]=F),L.size()>h.untreeifyThreshold?k[S+C]=new a.default(L):L.size()&&(k[S+C]=L)}else{var O=new c.default,z=new c.default;R.forEach(function(B){d(B.key)&C?z.pushBack(B):O.pushBack(B)}),O.size()&&(k[S]=O),z.size()&&(k[S+C]=z)}y[S].clear()}}),y=k}}).call(this,v)}else this.eraseElementByKey(b)},this.getElementByKey=function(b){var x,m,T=d(b)&v-1;if(y[T]){if(y[T]instanceof a.default)return y[T].getElementByKey(b);try{for(var I=n(y[T]),P=I.next();!P.done;P=I.next()){var E=P.value;if(E.key===b)return E.value}}catch(_){x={error:_}}finally{try{P&&!P.done&&(m=I.return)&&m.call(I)}finally{if(x)throw x.error}}}},this.eraseElementByKey=function(b){var x,m,T=d(b)&v-1;if(y[T]){var I=y[T].size();if(y[T]instanceof a.default)y[T].eraseElementByKey(b),y[T].size()<=h.untreeifyThreshold&&(y[T]=new c.default(y[T]));else{var P=-1;try{for(var E=n(y[T]),_=E.next();!_.done;_=E.next())if(++P,_.value.key===b){y[T].eraseElementByPos(P);break}}catch(Y){x={error:Y}}finally{try{_&&!_.done&&(m=E.return)&&m.call(E)}finally{if(x)throw x.error}}}var W=y[T].size();g+=W-I}},this.find=function(b){var x,m,T=d(b)&v-1;if(!y[T])return!1;if(y[T]instanceof a.default)return y[T].find(b);try{for(var I=n(y[T]),P=I.next();!P.done;P=I.next())if(P.value.key===b)return!0}catch(E){x={error:E}}finally{try{P&&!P.done&&(m=I.return)&&m.call(I)}finally{if(x)throw x.error}}return!1},this[Symbol.iterator]=function(){return function(){var b,x,m,T,I,P;return o(this,function(E){switch(E.label){case 0:b=0,E.label=1;case 1:if(!(b<v))return[3,10];for(;b<v&&!y[b];)++b;if(b>=v)return[3,10];E.label=2;case 2:E.trys.push([2,7,8,9]),I=void 0,x=n(y[b]),m=x.next(),E.label=3;case 3:return m.done?[3,6]:[4,m.value];case 4:E.sent(),E.label=5;case 5:return m=x.next(),[3,3];case 6:return[3,9];case 7:return T=E.sent(),I={error:T},[3,9];case 8:try{m&&!m.done&&(P=x.return)&&P.call(x)}finally{if(I)throw I.error}return[7];case 9:return++b,[3,1];case 10:return[2]}})}()},l.forEach(function(b){var x=b.key,m=b.value;return f.setElement(x,m)}),Object.freeze(this)}h.initSize=16,h.maxSize=1<<30,h.sigma=.75,h.treeifyThreshold=8,h.untreeifyThreshold=6,h.minTreeifySize=64,Object.freeze(h),r.default=h},{"../LinkList/LinkList":29,"../Map/Map":30}],28:[function(i,s,r){var o=this&&this.__generator||function(l,u){var d,f,g,y,v={label:0,sent:function(){if(1&g[0])throw g[1];return g[1]},trys:[],ops:[]};return y={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(y[Symbol.iterator]=function(){return this}),y;function b(x){return function(m){return function(T){if(d)throw new TypeError("Generator is already executing.");for(;v;)try{if(d=1,f&&(g=2&T[0]?f.return:T[0]?f.throw||((g=f.return)&&g.call(f),0):f.next)&&!(g=g.call(f,T[1])).done)return g;switch(f=0,g&&(T=[2&T[0],g.value]),T[0]){case 0:case 1:g=T;break;case 4:return v.label++,{value:T[1],done:!1};case 5:v.label++,f=T[1],T=[0];continue;case 7:T=v.ops.pop(),v.trys.pop();continue;default:if(!(g=(g=v.trys).length>0&&g[g.length-1])&&(T[0]===6||T[0]===2)){v=0;continue}if(T[0]===3&&(!g||T[1]>g[0]&&T[1]<g[3])){v.label=T[1];break}if(T[0]===6&&v.label<g[1]){v.label=g[1],g=T;break}if(g&&v.label<g[2]){v.label=g[2],v.ops.push(T);break}g[2]&&v.ops.pop(),v.trys.pop();continue}T=u.call(l,v)}catch(I){T=[6,I],f=0}finally{d=g=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([x,m])}}},n=this&&this.__values||function(l){var u=typeof Symbol=="function"&&Symbol.iterator,d=u&&l[u],f=0;if(d)return d.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&f>=l.length&&(l=void 0),{value:l&&l[f++],done:!l}}};throw new TypeError(u?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0});var c=i("../Set/Set"),a=i("../LinkList/LinkList");function h(l,u,d){var f=this;if(l===void 0&&(l=[]),u===void 0&&(u=h.initSize),d=d||function(b){var x=0,m="";if(typeof b=="number")x=((x=Math.floor(b))<<5)-x,x&=x;else{m=typeof b!="string"?JSON.stringify(b):b;for(var T=0;T<m.length;T++)x=(x<<5)-x+m.charCodeAt(T),x&=x}return x^=x>>>16},(u&u-1)!=0)throw new Error("initBucketNum must be 2 to the power of n");var g=0,y=[],v=Math.max(h.initSize,Math.min(h.maxSize,u));this.size=function(){return g},this.empty=function(){return g===0},this.clear=function(){g=0,v=u,y=[]},this.forEach=function(b){var x=0;y.forEach(function(m){m.forEach(function(T){b(T,x++)})})},this.insert=function(b){if(b==null)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");var x=d(b)&v-1;if(y[x]){var m=y[x].size();if(y[x]instanceof a.default){if(y[x].find(b))return;y[x].pushBack(b),y[x].size()>=h.treeifyThreshold&&(y[x]=new c.default(y[x]))}else y[x].insert(b);var T=y[x].size();g+=T-m}else y[x]=new a.default([b]),++g;g>v*h.sigma&&(function(I){if(!(I>=h.maxSize)){v=2*I;var P=[];y.forEach(function(E,_){if(!E.empty()){if(E instanceof a.default&&E.size()===1){var W=E.front();if(W===void 0)throw new Error("unknown error");P[d(W)&v-1]=new a.default([W])}else if(E instanceof c.default){var Y=new a.default,C=new a.default;E.forEach(function(S){d(S)&I?C.pushBack(S):Y.pushBack(S)}),Y.size()>h.untreeifyThreshold?P[_]=new c.default(Y):Y.size()&&(P[_]=Y),C.size()>h.untreeifyThreshold?P[_+I]=new c.default(C):C.size()&&(P[_+I]=C)}else{var k=new a.default,R=new a.default;E.forEach(function(S){d(S)&I?R.pushBack(S):k.pushBack(S)}),k.size()&&(P[_]=k),R.size()&&(P[_+I]=R)}y[_].clear()}}),y=P}}).call(this,v)},this.eraseElementByValue=function(b){var x=d(b)&v-1;if(y[x]){var m=y[x].size();y[x].eraseElementByValue(b),y[x]instanceof c.default&&y[x].size()<=h.untreeifyThreshold&&(y[x]=new a.default(y[x]));var T=y[x].size();g+=T-m}},this.find=function(b){var x=d(b)&v-1;return!!y[x]&&y[x].find(b)},this[Symbol.iterator]=function(){return function(){var b,x,m,T,I,P;return o(this,function(E){switch(E.label){case 0:b=0,E.label=1;case 1:if(!(b<v))return[3,10];for(;b<v&&!y[b];)++b;if(b>=v)return[3,10];E.label=2;case 2:E.trys.push([2,7,8,9]),I=void 0,x=n(y[b]),m=x.next(),E.label=3;case 3:return m.done?[3,6]:[4,m.value];case 4:E.sent(),E.label=5;case 5:return m=x.next(),[3,3];case 6:return[3,9];case 7:return T=E.sent(),I={error:T},[3,9];case 8:try{m&&!m.done&&(P=x.return)&&P.call(x)}finally{if(I)throw I.error}return[7];case 9:return++b,[3,1];case 10:return[2]}})}()},l.forEach(function(b){return f.insert(b)}),Object.freeze(this)}h.initSize=16,h.maxSize=1<<30,h.sigma=.75,h.treeifyThreshold=8,h.untreeifyThreshold=6,h.minTreeifySize=64,Object.freeze(h),r.default=h},{"../LinkList/LinkList":29,"../Set/Set":33}],29:[function(i,s,r){var o=this&&this.__generator||function(a,h){var l,u,d,f,g={label:0,sent:function(){if(1&d[0])throw d[1];return d[1]},trys:[],ops:[]};return f={next:y(0),throw:y(1),return:y(2)},typeof Symbol=="function"&&(f[Symbol.iterator]=function(){return this}),f;function y(v){return function(b){return function(x){if(l)throw new TypeError("Generator is already executing.");for(;g;)try{if(l=1,u&&(d=2&x[0]?u.return:x[0]?u.throw||((d=u.return)&&d.call(u),0):u.next)&&!(d=d.call(u,x[1])).done)return d;switch(u=0,d&&(x=[2&x[0],d.value]),x[0]){case 0:case 1:d=x;break;case 4:return g.label++,{value:x[1],done:!1};case 5:g.label++,u=x[1],x=[0];continue;case 7:x=g.ops.pop(),g.trys.pop();continue;default:if(!(d=(d=g.trys).length>0&&d[d.length-1])&&(x[0]===6||x[0]===2)){g=0;continue}if(x[0]===3&&(!d||x[1]>d[0]&&x[1]<d[3])){g.label=x[1];break}if(x[0]===6&&g.label<d[1]){g.label=d[1],d=x;break}if(d&&g.label<d[2]){g.label=d[2],g.ops.push(x);break}d[2]&&g.ops.pop(),g.trys.pop();continue}x=h.call(a,g)}catch(m){x=[6,m],u=0}finally{l=d=0}if(5&x[0])throw x[1];return{value:x[0]?x[1]:void 0,done:!0}}([v,b])}}};Object.defineProperty(r,"__esModule",{value:!0});var n=function(){return function(a){this.value=void 0,this.pre=void 0,this.next=void 0,this.value=a}}();function c(a){var h=this;a===void 0&&(a=[]);var l=0,u=void 0,d=void 0;this.size=function(){return l},this.empty=function(){return l===0},this.clear=function(){u=d=void 0,l=0},this.front=function(){return u==null?void 0:u.value},this.back=function(){return d==null?void 0:d.value},this.forEach=function(f){for(var g=u,y=0;g;){if(g.value===void 0)throw new Error("unknown error");f(g.value,y++),g=g.next}},this.getElementByPos=function(f){if(f<0||f>=l)throw new Error("pos must more then 0 and less then the list length");for(var g=u;f--&&g;)g=g.next;if(!g||g.value===void 0)throw new Error("unknown error");return g.value},this.eraseElementByPos=function(f){if(f<0||f>=l)throw new Error("erase pos must more then 0 and less then the list length");if(f===0)this.popFront();else if(f===l-1)this.popBack();else{for(var g=u;f--;){if(!(g!=null&&g.next))throw new Error("unknown error");g=g.next}if(!g||!g.pre||!g.next)throw new Error("unknown error");var y=g.pre,v=g.next;v.pre=y,y.next=v,l>0&&--l}},this.eraseElementByValue=function(f){for(;u&&u.value===f;)this.popFront();for(;d&&d.value===f;)this.popBack();if(u)for(var g=u;g;){if(g.value===f){var y=g.pre,v=g.next;v&&(v.pre=y),y&&(y.next=v),l>0&&--l}g=g.next}},this.pushBack=function(f){if(f==null)throw new Error("you can't push null or undefined here");++l;var g=new n(f);d?(d.next=g,g.pre=d,d=g):u=d=g},this.popBack=function(){d&&(l>0&&--l,d&&(u===d?u=d=void 0:(d=d.pre)&&(d.next=void 0)))},this.setElementByPos=function(f,g){if(g==null)throw new Error("you can't set null or undefined here");if(f<0||f>=l)throw new Error("pos must more then 0 and less then the list length");for(var y=u;f--;){if(!y)throw new Error("unknown error");y=y.next}y&&(y.value=g)},this.insert=function(f,g,y){if(y===void 0&&(y=1),g==null)throw new Error("you can't insert null or undefined here");if(f<0||f>l)throw new Error("insert pos must more then 0 and less then or equal to the list length");if(y<0)throw new Error("insert size must more than 0");if(f===0)for(;y--;)this.pushFront(g);else if(f===l)for(;y--;)this.pushBack(g);else{for(var v=u,b=1;b<f;++b){if(!(v!=null&&v.next))throw new Error("unknown error");v=v==null?void 0:v.next}if(!v)throw new Error("unknown error");var x=v.next;for(l+=y;y--;)v.next=new n(g),v.next.pre=v,v=v.next;v.next=x,x&&(x.pre=v)}},this.find=function(f){for(var g=u;g;){if(g.value===f)return!0;g=g.next}return!1},this.reverse=function(){for(var f=u,g=d,y=0;f&&g&&2*y<l;){var v=f.value;f.value=g.value,g.value=v,f=f.next,g=g.pre,++y}},this.unique=function(){for(var f=u;f;){for(var g=f;g&&g.next&&g.value===g.next.value;)g=g.next,l>0&&--l;f.next=g.next,f.next&&(f.next.pre=f),f=f.next}},this.sort=function(f){var g=[];this.forEach(function(v){g.push(v)}),g.sort(f);var y=u;g.forEach(function(v){y&&(y.value=v,y=y.next)})},this.pushFront=function(f){if(f==null)throw new Error("you can't push null or undefined here");++l;var g=new n(f);u?(g.next=u,u.pre=g,u=g):u=d=g},this.popFront=function(){u&&(l>0&&--l,u&&(u===d?u=d=void 0:(u=u.next)&&(u.pre=void 0)))},this.merge=function(f){var g=this,y=u;f.forEach(function(v){for(;y&&y.value!==void 0&&y.value<=v;)y=y.next;if(y===void 0)g.pushBack(v),y=d;else if(y===u)g.pushFront(v),y=u;else{++l;var b=y.pre;b&&(b.next=new n(v),b.next.pre=b,b.next.next=y,y&&(y.pre=b.next))}})},this[Symbol.iterator]=function(){return function(){var f;return o(this,function(g){switch(g.label){case 0:f=u,g.label=1;case 1:if(f===void 0)return[3,3];if(!f.value)throw new Error("unknown error");return[4,f.value];case 2:return g.sent(),f=f.next,[3,1];case 3:return[2]}})}()},a.forEach(function(f){return h.pushBack(f)}),Object.freeze(this)}Object.freeze(c),r.default=c},{}],30:[function(i,s,r){var o=this&&this.__generator||function(h,l){var u,d,f,g,y={label:0,sent:function(){if(1&f[0])throw f[1];return f[1]},trys:[],ops:[]};return g={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g;function v(b){return function(x){return function(m){if(u)throw new TypeError("Generator is already executing.");for(;y;)try{if(u=1,d&&(f=2&m[0]?d.return:m[0]?d.throw||((f=d.return)&&f.call(d),0):d.next)&&!(f=f.call(d,m[1])).done)return f;switch(d=0,f&&(m=[2&m[0],f.value]),m[0]){case 0:case 1:f=m;break;case 4:return y.label++,{value:m[1],done:!1};case 5:y.label++,d=m[1],m=[0];continue;case 7:m=y.ops.pop(),y.trys.pop();continue;default:if(!(f=(f=y.trys).length>0&&f[f.length-1])&&(m[0]===6||m[0]===2)){y=0;continue}if(m[0]===3&&(!f||m[1]>f[0]&&m[1]<f[3])){y.label=m[1];break}if(m[0]===6&&y.label<f[1]){y.label=f[1],f=m;break}if(f&&y.label<f[2]){y.label=f[2],y.ops.push(m);break}f[2]&&y.ops.pop(),y.trys.pop();continue}m=l.call(h,y)}catch(T){m=[6,T],d=0}finally{u=f=0}if(5&m[0])throw m[1];return{value:m[0]?m[1]:void 0,done:!0}}([b,x])}}},n=this&&this.__values||function(h){var l=typeof Symbol=="function"&&Symbol.iterator,u=l&&h[l],d=0;if(u)return u.call(h);if(h&&typeof h.length=="number")return{next:function(){return h&&d>=h.length&&(h=void 0),{value:h&&h[d++],done:!h}}};throw new TypeError(l?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0});var c=i("../Base/TreeNode");function a(h,l){var u=this;h===void 0&&(h=[]),l=l||function(C,k){return C<k?-1:C>k?1:0};var d=0,f=new c.default;f.color=c.default.TreeNodeColorType.black,this.size=function(){return d},this.empty=function(){return d===0},this.clear=function(){d=0,f.key=f.value=void 0,f.leftChild=f.rightChild=f.brother=void 0};var g=function(C){if(!C||C.key===void 0)throw new Error("unknown error");return C.leftChild?g(C.leftChild):C},y=function(C){if(!C||C.key===void 0)throw new Error("unknown error");return C.rightChild?y(C.rightChild):C};this.front=function(){if(!this.empty()){var C=g(f);if(C.key===void 0||C.value===void 0)throw new Error("unknown error");return{key:C.key,value:C.value}}},this.back=function(){if(!this.empty()){var C=y(f);if(C.key===void 0||C.value===void 0)throw new Error("unknown error");return{key:C.key,value:C.value}}},this.forEach=function(C){var k,R,S=0;try{for(var N=n(this),H=N.next();!H.done;H=N.next())C(H.value,S++)}catch(K){k={error:K}}finally{try{H&&!H.done&&(R=N.return)&&R.call(N)}finally{if(k)throw k.error}}},this.getElementByPos=function(C){var k,R;if(C<0||C>=this.size())throw new Error("pos must more than 0 and less than set's size");var S=0;try{for(var N=n(this),H=N.next();!H.done;H=N.next()){var K=H.value;if(S===C)return K;++S}}catch(F){k={error:F}}finally{try{H&&!H.done&&(R=N.return)&&R.call(N)}finally{if(k)throw k.error}}throw new Error("unknown Error")};var v=function(C,k){if(C&&C.key!==void 0&&C.value!==void 0){var R=l(C.key,k);return R===0?{key:C.key,value:C.value}:R<0?v(C.rightChild,k):v(C.leftChild,k)||{key:C.key,value:C.value}}};this.lowerBound=function(C){return v(f,C)};var b=function(C,k){if(C&&C.key!==void 0&&C.value!==void 0)return l(C.key,k)<=0?b(C.rightChild,k):b(C.leftChild,k)||{key:C.key,value:C.value}};this.upperBound=function(C){return b(f,C)};var x=function(C,k){if(C&&C.key!==void 0&&C.value!==void 0){var R=l(C.key,k);return R===0?{key:C.key,value:C.value}:R>0?x(C.leftChild,k):x(C.rightChild,k)||{key:C.key,value:C.value}}};this.reverseLowerBound=function(C){return x(f,C)};var m=function(C,k){if(C&&C.key!==void 0&&C.value!==void 0)return l(C.key,k)>=0?m(C.leftChild,k):m(C.rightChild,k)||{key:C.key,value:C.value}};this.reverseUpperBound=function(C){return m(f,C)};var T=function(C){var k=C.parent;if(!k){if(C===f)return;throw new Error("unknown error")}if(C.color!==c.default.TreeNodeColorType.red){var R=C.brother;if(!R)throw new Error("unknown error");if(C===k.leftChild)if(R.color===c.default.TreeNodeColorType.red){R.color=c.default.TreeNodeColorType.black,k.color=c.default.TreeNodeColorType.red;var S=k.rotateLeft();f===k&&(f=S),T(C)}else R.color===c.default.TreeNodeColorType.black&&(R.rightChild&&R.rightChild.color===c.default.TreeNodeColorType.red?(R.color=k.color,k.color=c.default.TreeNodeColorType.black,R.rightChild&&(R.rightChild.color=c.default.TreeNodeColorType.black),S=k.rotateLeft(),f===k&&(f=S),C.color=c.default.TreeNodeColorType.black):R.rightChild&&R.rightChild.color!==c.default.TreeNodeColorType.black||!R.leftChild||R.leftChild.color!==c.default.TreeNodeColorType.red?R.leftChild&&R.leftChild.color!==c.default.TreeNodeColorType.black||R.rightChild&&R.rightChild.color!==c.default.TreeNodeColorType.black||(R.color=c.default.TreeNodeColorType.red,T(k)):(R.color=c.default.TreeNodeColorType.red,R.leftChild&&(R.leftChild.color=c.default.TreeNodeColorType.black),S=R.rotateRight(),f===R&&(f=S),T(C)));else C===k.rightChild&&(R.color===c.default.TreeNodeColorType.red?(R.color=c.default.TreeNodeColorType.black,k.color=c.default.TreeNodeColorType.red,S=k.rotateRight(),f===k&&(f=S),T(C)):R.color===c.default.TreeNodeColorType.black&&(R.leftChild&&R.leftChild.color===c.default.TreeNodeColorType.red?(R.color=k.color,k.color=c.default.TreeNodeColorType.black,R.leftChild&&(R.leftChild.color=c.default.TreeNodeColorType.black),S=k.rotateRight(),f===k&&(f=S),C.color=c.default.TreeNodeColorType.black):R.leftChild&&R.leftChild.color!==c.default.TreeNodeColorType.black||!R.rightChild||R.rightChild.color!==c.default.TreeNodeColorType.red?R.leftChild&&R.leftChild.color!==c.default.TreeNodeColorType.black||R.rightChild&&R.rightChild.color!==c.default.TreeNodeColorType.black||(R.color=c.default.TreeNodeColorType.red,T(k)):(R.color=c.default.TreeNodeColorType.red,R.rightChild&&(R.rightChild.color=c.default.TreeNodeColorType.black),S=R.rotateLeft(),f===R&&(f=S),T(C))))}else C.color=c.default.TreeNodeColorType.black},I=function(C){for(var k=C;k.leftChild||k.rightChild;){if(k.rightChild){k=g(k.rightChild);var R=C.key;C.key=k.key,k.key=R;var S=C.value;C.value=k.value,k.value=S,C=k}k.leftChild&&(k=y(k.leftChild),R=C.key,C.key=k.key,k.key=R,S=C.value,C.value=k.value,k.value=S,C=k)}T(k),k&&k.remove(),--d,f.color=c.default.TreeNodeColorType.black},P=function(C,k){return!(!C||C.key===void 0)&&(!!P(C.leftChild,k)||!!k(C)||P(C.rightChild,k))};this.eraseElementByPos=function(C){if(C<0||C>=d)throw new Error("pos must more than 0 and less than set's size");var k=0;P(f,function(R){return C===k?(I(R),!0):(++k,!1)})},this.eraseElementByKey=function(C){if(!this.empty()){var k=W(f,C);k!==void 0&&k.key!==void 0&&l(k.key,C)===0&&I(k)}};var E=function(C,k){if(!C||C.key===void 0)throw new Error("unknown error");var R=l(k,C.key);return R<0?C.leftChild?E(C.leftChild,k):(C.leftChild=new c.default,C.leftChild.parent=C,C.leftChild.brother=C.rightChild,C.rightChild&&(C.rightChild.brother=C.leftChild),C.leftChild):R>0?C.rightChild?E(C.rightChild,k):(C.rightChild=new c.default,C.rightChild.parent=C,C.rightChild.brother=C.leftChild,C.leftChild&&(C.leftChild.brother=C.rightChild),C.rightChild):C},_=function(C){var k=C.parent;if(!k){if(C===f)return;throw new Error("unknown error")}if(k.color!==c.default.TreeNodeColorType.black&&k.color===c.default.TreeNodeColorType.red){var R=k.brother,S=k.parent;if(!S)throw new Error("unknown error");if(R&&R.color===c.default.TreeNodeColorType.red)R.color=k.color=c.default.TreeNodeColorType.black,S.color=c.default.TreeNodeColorType.red,_(S);else if(!R||R.color===c.default.TreeNodeColorType.black)if(k===S.leftChild)if(C===k.leftChild){k.color=c.default.TreeNodeColorType.black,S.color=c.default.TreeNodeColorType.red;var N=S.rotateRight();S===f&&(f=N)}else C===k.rightChild&&(N=k.rotateLeft(),S===f&&(f=N),_(k));else k===S.rightChild&&(C===k.leftChild?(N=k.rotateRight(),S===f&&(f=N),_(k)):C===k.rightChild&&(k.color=c.default.TreeNodeColorType.black,S.color=c.default.TreeNodeColorType.red,N=S.rotateLeft(),S===f&&(f=N)))}};this.setElement=function(C,k){if(C==null)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(k!=null){if(this.empty())return++d,f.key=C,f.value=k,void(f.color=c.default.TreeNodeColorType.black);var R=E(f,C);R.key===void 0||l(R.key,C)!==0?(++d,R.key=C,R.value=k,_(R),f.color=c.default.TreeNodeColorType.black):R.value=k}else this.eraseElementByKey(C)};var W=function(C,k){if(C&&C.key!==void 0){var R=l(k,C.key);return R<0?W(C.leftChild,k):R>0?W(C.rightChild,k):C}};this.find=function(C){return!!W(f,C)},this.getElementByKey=function(C){var k=W(f,C);if((k==null?void 0:k.key)===void 0||(k==null?void 0:k.value)===void 0)throw new Error("unknown error");return k.value},this.union=function(C){var k=this;C.forEach(function(R){var S=R.key,N=R.value;return k.setElement(S,N)})},this.getHeight=function(){if(this.empty())return 0;var C=function(k){return k?Math.max(C(k.leftChild),C(k.rightChild))+1:1};return C(f)};var Y=function(C){return o(this,function(k){switch(k.label){case 0:return C&&C.key!==void 0&&C.value!==void 0?[5,n(Y(C.leftChild))]:[2];case 1:return k.sent(),[4,{key:C.key,value:C.value}];case 2:return k.sent(),[5,n(Y(C.rightChild))];case 3:return k.sent(),[2]}})};this[Symbol.iterator]=function(){return Y(f)},h.forEach(function(C){var k=C.key,R=C.value;return u.setElement(k,R)}),Object.freeze(this)}Object.freeze(a),r.default=a},{"../Base/TreeNode":25}],31:[function(i,s,r){function o(n,c){n===void 0&&(n=[]),c=c||function(d,f){return d>f?-1:d<f?1:0};var a=[];n.forEach(function(d){return a.push(d)});var h=a.length,l=function(d,f){if(d<0||d>=h)throw new Error("unknown error");if(f<0||f>=h)throw new Error("unknown error");var g=a[d];a[d]=a[f],a[f]=g},u=function(d){if(d<0||d>=h)throw new Error("unknown error");var f=2*d+1,g=2*d+2;f<h&&c(a[d],a[f])>0&&l(d,f),g<h&&c(a[d],a[g])>0&&l(d,g)};(function(){for(var d=Math.floor((h-1)/2);d>=0;--d)for(var f=d,g=2*f+1;g<h;){var y=g+1,v=g;if(y<h&&c(a[g],a[y])>0&&(v=y),c(a[f],a[v])<=0)break;l(f,v),g=2*(f=v)+1}})(),this.size=function(){return h},this.empty=function(){return h===0},this.clear=function(){h=0,a.length=0},this.push=function(d){if(a.push(d),++h!==1)for(var f=h-1;f>0;){var g=Math.floor((f-1)/2);if(c(a[g],d)<=0)break;u(g),f=g}},this.pop=function(){if(!this.empty())if(this.size()!==1){var d=a[h-1];--h;for(var f=0;f<this.size();){var g=2*f+1,y=2*f+2;if(g>=this.size())break;var v=g;if(y<this.size()&&c(a[g],a[y])>0&&(v=y),c(a[v],d)>=0)break;a[f]=a[v],f=v}a[f]=d}else--h},this.top=function(){return a[0]},Object.freeze(this)}Object.defineProperty(r,"__esModule",{value:!0}),Object.freeze(o),r.default=o},{}],32:[function(i,s,r){Object.defineProperty(r,"__esModule",{value:!0});var o=i("../LinkList/LinkList");function n(c){c===void 0&&(c=[]);var a=new o.default(c);this.size=function(){return a.size()},this.empty=function(){return a.empty()},this.clear=function(){a.clear()},this.push=function(h){a.pushBack(h)},this.pop=function(){a.popFront()},this.front=function(){return a.front()},Object.freeze(this)}Object.freeze(n),r.default=n},{"../LinkList/LinkList":29}],33:[function(i,s,r){var o=this&&this.__generator||function(h,l){var u,d,f,g,y={label:0,sent:function(){if(1&f[0])throw f[1];return f[1]},trys:[],ops:[]};return g={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g;function v(b){return function(x){return function(m){if(u)throw new TypeError("Generator is already executing.");for(;y;)try{if(u=1,d&&(f=2&m[0]?d.return:m[0]?d.throw||((f=d.return)&&f.call(d),0):d.next)&&!(f=f.call(d,m[1])).done)return f;switch(d=0,f&&(m=[2&m[0],f.value]),m[0]){case 0:case 1:f=m;break;case 4:return y.label++,{value:m[1],done:!1};case 5:y.label++,d=m[1],m=[0];continue;case 7:m=y.ops.pop(),y.trys.pop();continue;default:if(!(f=(f=y.trys).length>0&&f[f.length-1])&&(m[0]===6||m[0]===2)){y=0;continue}if(m[0]===3&&(!f||m[1]>f[0]&&m[1]<f[3])){y.label=m[1];break}if(m[0]===6&&y.label<f[1]){y.label=f[1],f=m;break}if(f&&y.label<f[2]){y.label=f[2],y.ops.push(m);break}f[2]&&y.ops.pop(),y.trys.pop();continue}m=l.call(h,y)}catch(T){m=[6,T],d=0}finally{u=f=0}if(5&m[0])throw m[1];return{value:m[0]?m[1]:void 0,done:!0}}([b,x])}}},n=this&&this.__values||function(h){var l=typeof Symbol=="function"&&Symbol.iterator,u=l&&h[l],d=0;if(u)return u.call(h);if(h&&typeof h.length=="number")return{next:function(){return h&&d>=h.length&&(h=void 0),{value:h&&h[d++],done:!h}}};throw new TypeError(l?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0});var c=i("../Base/TreeNode");function a(h,l){var u=this;h===void 0&&(h=[]),l=l||function(C,k){return C<k?-1:C>k?1:0};var d=0,f=new c.default;f.color=c.default.TreeNodeColorType.black,this.size=function(){return d},this.empty=function(){return d===0},this.clear=function(){d=0,f.key=void 0,f.leftChild=f.rightChild=f.brother=f.parent=void 0,f.color=c.default.TreeNodeColorType.black};var g=function(C){if(!C||C.key===void 0)throw new Error("unknown error");return C.leftChild?g(C.leftChild):C},y=function(C){if(!C||C.key===void 0)throw new Error("unknown error");return C.rightChild?y(C.rightChild):C};this.front=function(){if(!this.empty())return g(f).key},this.back=function(){if(!this.empty())return y(f).key},this.forEach=function(C){var k,R,S=0;try{for(var N=n(this),H=N.next();!H.done;H=N.next())C(H.value,S++)}catch(K){k={error:K}}finally{try{H&&!H.done&&(R=N.return)&&R.call(N)}finally{if(k)throw k.error}}},this.getElementByPos=function(C){var k,R;if(C<0||C>=this.size())throw new Error("pos must more than 0 and less than set's size");var S=0;try{for(var N=n(this),H=N.next();!H.done;H=N.next()){var K=H.value;if(S===C)return K;++S}}catch(F){k={error:F}}finally{try{H&&!H.done&&(R=N.return)&&R.call(N)}finally{if(k)throw k.error}}throw new Error("unknown error")};var v=function(C){var k=C.parent;if(!k){if(C===f)return;throw new Error("unknown error")}if(C.color!==c.default.TreeNodeColorType.red){var R=C.brother;if(!R)throw new Error("unknown error");if(C===k.leftChild)if(R.color===c.default.TreeNodeColorType.red){R.color=c.default.TreeNodeColorType.black,k.color=c.default.TreeNodeColorType.red;var S=k.rotateLeft();f===k&&(f=S),v(C)}else R.color===c.default.TreeNodeColorType.black&&(R.rightChild&&R.rightChild.color===c.default.TreeNodeColorType.red?(R.color=k.color,k.color=c.default.TreeNodeColorType.black,R.rightChild&&(R.rightChild.color=c.default.TreeNodeColorType.black),S=k.rotateLeft(),f===k&&(f=S),C.color=c.default.TreeNodeColorType.black):R.rightChild&&R.rightChild.color!==c.default.TreeNodeColorType.black||!R.leftChild||R.leftChild.color!==c.default.TreeNodeColorType.red?R.leftChild&&R.leftChild.color!==c.default.TreeNodeColorType.black||R.rightChild&&R.rightChild.color!==c.default.TreeNodeColorType.black||(R.color=c.default.TreeNodeColorType.red,v(k)):(R.color=c.default.TreeNodeColorType.red,R.leftChild&&(R.leftChild.color=c.default.TreeNodeColorType.black),S=R.rotateRight(),f===R&&(f=S),v(C)));else C===k.rightChild&&(R.color===c.default.TreeNodeColorType.red?(R.color=c.default.TreeNodeColorType.black,k.color=c.default.TreeNodeColorType.red,S=k.rotateRight(),f===k&&(f=S),v(C)):R.color===c.default.TreeNodeColorType.black&&(R.leftChild&&R.leftChild.color===c.default.TreeNodeColorType.red?(R.color=k.color,k.color=c.default.TreeNodeColorType.black,R.leftChild&&(R.leftChild.color=c.default.TreeNodeColorType.black),S=k.rotateRight(),f===k&&(f=S),C.color=c.default.TreeNodeColorType.black):R.leftChild&&R.leftChild.color!==c.default.TreeNodeColorType.black||!R.rightChild||R.rightChild.color!==c.default.TreeNodeColorType.red?R.leftChild&&R.leftChild.color!==c.default.TreeNodeColorType.black||R.rightChild&&R.rightChild.color!==c.default.TreeNodeColorType.black||(R.color=c.default.TreeNodeColorType.red,v(k)):(R.color=c.default.TreeNodeColorType.red,R.rightChild&&(R.rightChild.color=c.default.TreeNodeColorType.black),S=R.rotateLeft(),f===R&&(f=S),v(C))))}else C.color=c.default.TreeNodeColorType.black},b=function(C){for(var k=C;k.leftChild||k.rightChild;){if(k.rightChild){k=g(k.rightChild);var R=C.key;C.key=k.key,k.key=R,C=k}k.leftChild&&(k=y(k.leftChild),R=C.key,C.key=k.key,k.key=R,C=k)}v(k),k&&k.remove(),--d,f.color=c.default.TreeNodeColorType.black},x=function(C,k){return!(!C||C.key===void 0)&&(!!x(C.leftChild,k)||!!k(C)||x(C.rightChild,k))};this.eraseElementByPos=function(C){if(C<0||C>=d)throw new Error("pos must more than 0 and less than set's size");var k=0;x(f,function(R){return C===k?(b(R),!0):(++k,!1)})},this.eraseElementByValue=function(C){if(!this.empty()){var k=I(f,C);k!==void 0&&k.key!==void 0&&l(k.key,C)===0&&b(k)}};var m=function(C,k){if(!C||C.key===void 0)throw new Error("unknown error");var R=l(k,C.key);return R<0?C.leftChild?m(C.leftChild,k):(C.leftChild=new c.default,C.leftChild.parent=C,C.leftChild.brother=C.rightChild,C.rightChild&&(C.rightChild.brother=C.leftChild),C.leftChild):R>0?C.rightChild?m(C.rightChild,k):(C.rightChild=new c.default,C.rightChild.parent=C,C.rightChild.brother=C.leftChild,C.leftChild&&(C.leftChild.brother=C.rightChild),C.rightChild):C},T=function(C){var k=C.parent;if(!k){if(C===f)return;throw new Error("unknown error")}if(k.color!==c.default.TreeNodeColorType.black&&k.color===c.default.TreeNodeColorType.red){var R=k.brother,S=k.parent;if(!S)throw new Error("unknown error");if(R&&R.color===c.default.TreeNodeColorType.red)R.color=k.color=c.default.TreeNodeColorType.black,S.color=c.default.TreeNodeColorType.red,T(S);else if(!R||R.color===c.default.TreeNodeColorType.black)if(k===S.leftChild)if(C===k.leftChild){k.color=c.default.TreeNodeColorType.black,S.color=c.default.TreeNodeColorType.red;var N=S.rotateRight();S===f&&(f=N)}else C===k.rightChild&&(N=k.rotateLeft(),S===f&&(f=N),T(k));else k===S.rightChild&&(C===k.leftChild?(N=k.rotateRight(),S===f&&(f=N),T(k)):C===k.rightChild&&(k.color=c.default.TreeNodeColorType.black,S.color=c.default.TreeNodeColorType.red,N=S.rotateLeft(),S===f&&(f=N)))}};this.insert=function(C){if(C==null)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(this.empty())return++d,f.key=C,void(f.color=c.default.TreeNodeColorType.black);var k=m(f,C);k.key!==void 0&&l(k.key,C)===0||(++d,k.key=C,T(k),f.color=c.default.TreeNodeColorType.black)};var I=function(C,k){if(C&&C.key!==void 0){var R=l(k,C.key);return R<0?I(C.leftChild,k):R>0?I(C.rightChild,k):C}};this.find=function(C){var k=I(f,C);return k!==void 0&&k.key!==void 0&&l(k.key,C)===0};var P=function(C,k){if(C&&C.key!==void 0){var R=l(C.key,k);if(R===0)return C.key;if(R<0)return P(C.rightChild,k);var S=P(C.leftChild,k);return S!==void 0?S:C.key}};this.lowerBound=function(C){return P(f,C)};var E=function(C,k){if(C&&C.key!==void 0){if(l(C.key,k)<=0)return E(C.rightChild,k);var R=E(C.leftChild,k);return R!==void 0?R:C.key}};this.upperBound=function(C){return E(f,C)};var _=function(C,k){if(C&&C.key!==void 0){var R=l(C.key,k);if(R===0)return C.key;if(R>0)return _(C.leftChild,k);var S=_(C.rightChild,k);return S!==void 0?S:C.key}};this.reverseLowerBound=function(C){return _(f,C)};var W=function(C,k){if(C&&C.key!==void 0){if(l(C.key,k)>=0)return W(C.leftChild,k);var R=W(C.rightChild,k);return R!==void 0?R:C.key}};this.reverseUpperBound=function(C){return W(f,C)},this.union=function(C){var k=this;C.forEach(function(R){return k.insert(R)})},this.getHeight=function(){if(this.empty())return 0;var C=function(k){return k?Math.max(C(k.leftChild),C(k.rightChild))+1:1};return C(f)};var Y=function(C){return o(this,function(k){switch(k.label){case 0:return C&&C.key!==void 0?[5,n(Y(C.leftChild))]:[2];case 1:return k.sent(),[4,C.key];case 2:return k.sent(),[5,n(Y(C.rightChild))];case 3:return k.sent(),[2]}})};this[Symbol.iterator]=function(){return Y(f)},h.forEach(function(C){return u.insert(C)}),Object.freeze(this)}Object.freeze(a),r.default=a},{"../Base/TreeNode":25}],34:[function(i,s,r){function o(n){var c=this;n===void 0&&(n=[]);var a=0,h=[];this.size=function(){return a},this.empty=function(){return a===0},this.clear=function(){a=0,h.length=0},this.push=function(l){h.push(l),++a},this.pop=function(){h.pop(),a>0&&--a},this.top=function(){return h[a-1]},n.forEach(function(l){return c.push(l)}),Object.freeze(this)}Object.defineProperty(r,"__esModule",{value:!0}),Object.freeze(o),r.default=o},{}],35:[function(i,s,r){var o=this&&this.__generator||function(l,u){var d,f,g,y,v={label:0,sent:function(){if(1&g[0])throw g[1];return g[1]},trys:[],ops:[]};return y={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(y[Symbol.iterator]=function(){return this}),y;function b(x){return function(m){return function(T){if(d)throw new TypeError("Generator is already executing.");for(;v;)try{if(d=1,f&&(g=2&T[0]?f.return:T[0]?f.throw||((g=f.return)&&g.call(f),0):f.next)&&!(g=g.call(f,T[1])).done)return g;switch(f=0,g&&(T=[2&T[0],g.value]),T[0]){case 0:case 1:g=T;break;case 4:return v.label++,{value:T[1],done:!1};case 5:v.label++,f=T[1],T=[0];continue;case 7:T=v.ops.pop(),v.trys.pop();continue;default:if(!(g=(g=v.trys).length>0&&g[g.length-1])&&(T[0]===6||T[0]===2)){v=0;continue}if(T[0]===3&&(!g||T[1]>g[0]&&T[1]<g[3])){v.label=T[1];break}if(T[0]===6&&v.label<g[1]){v.label=g[1],g=T;break}if(g&&v.label<g[2]){v.label=g[2],v.ops.push(T);break}g[2]&&v.ops.pop(),v.trys.pop();continue}T=u.call(l,v)}catch(I){T=[6,I],f=0}finally{d=g=0}if(5&T[0])throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}([x,m])}}},n=this&&this.__read||function(l,u){var d=typeof Symbol=="function"&&l[Symbol.iterator];if(!d)return l;var f,g,y=d.call(l),v=[];try{for(;(u===void 0||u-- >0)&&!(f=y.next()).done;)v.push(f.value)}catch(b){g={error:b}}finally{try{f&&!f.done&&(d=y.return)&&d.call(y)}finally{if(g)throw g.error}}return v},c=this&&this.__spreadArray||function(l,u,d){if(d||arguments.length===2)for(var f,g=0,y=u.length;g<y;g++)!f&&g in u||(f||(f=Array.prototype.slice.call(u,0,g)),f[g]=u[g]);return l.concat(f||Array.prototype.slice.call(u))},a=this&&this.__values||function(l){var u=typeof Symbol=="function"&&Symbol.iterator,d=u&&l[u],f=0;if(d)return d.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&f>=l.length&&(l=void 0),{value:l&&l[f++],done:!l}}};throw new TypeError(u?"Object is not iterable.":"Symbol.iterator is not defined.")};function h(l){var u=this;l===void 0&&(l=[]);var d=0,f=[];this.size=function(){return d},this.empty=function(){return d===0},this.clear=function(){d=0,f.length=0},this.front=function(){if(!this.empty())return f[0]},this.back=function(){if(!this.empty())return f[d-1]},this.forEach=function(g){f.forEach(g)},this.getElementByPos=function(g){if(g<0||g>=d)throw new Error("pos must more than 0 and less than vector's size");return f[g]},this.eraseElementByPos=function(g){if(g<0||g>=d)throw new Error("pos must more than 0 and less than vector's size");for(var y=g;y<d-1;++y)f[y]=f[y+1];this.popBack()},this.eraseElementByValue=function(g){var y=[];this.forEach(function(b){b!==g&&y.push(b)}),y.forEach(function(b,x){f[x]=b});for(var v=y.length;d>v;)this.popBack()},this.pushBack=function(g){f.push(g),++d},this.popBack=function(){f.pop(),d>0&&--d},this.setElementByPos=function(g,y){if(g<0||g>=d)throw new Error("pos must more than 0 and less than vector's size");f[g]=y},this.insert=function(g,y,v){if(v===void 0&&(v=1),g<0||g>d)throw new Error("pos must more than 0 and less than or equal to vector's size");f.splice.apply(f,c([g,0],n(new Array(v).fill(y)),!1)),d+=v},this.find=function(g){return f.includes(g)},this.reverse=function(){f.reverse()},this.unique=function(){var g,y=[];this.forEach(function(b,x){x!==0&&b===g||(y.push(b),g=b)}),y.forEach(function(b,x){f[x]=b});for(var v=y.length;d>v;)this.popBack()},this.sort=function(g){f.sort(g)},this[Symbol.iterator]=function(){return function(){return o(this,function(g){switch(g.label){case 0:return[5,a(f)];case 1:return[2,g.sent()]}})}()},l.forEach(function(g){return u.pushBack(g)}),Object.freeze(this)}Object.defineProperty(r,"__esModule",{value:!0}),Object.freeze(h),r.default=h},{}],36:[function(i,s,r){Object.defineProperty(r,"__esModule",{value:!0}),r.HashMap=r.HashSet=r.Map=r.Set=r.PriorityQueue=r.Deque=r.LinkList=r.Queue=r.Stack=r.Vector=void 0;var o=i("./Vector/Vector");r.Vector=o.default;var n=i("./Stack/Stack");r.Stack=n.default;var c=i("./Queue/Queue");r.Queue=c.default;var a=i("./LinkList/LinkList");r.LinkList=a.default;var h=i("./Deque/Deque");r.Deque=h.default;var l=i("./PriorityQueue/PriorityQueue");r.PriorityQueue=l.default;var u=i("./Set/Set");r.Set=u.default;var d=i("./Map/Map");r.Map=d.default;var f=i("./HashSet/HashSet");r.HashSet=f.default;var g=i("./HashMap/HashMap");r.HashMap=g.default},{"./Deque/Deque":26,"./HashMap/HashMap":27,"./HashSet/HashSet":28,"./LinkList/LinkList":29,"./Map/Map":30,"./PriorityQueue/PriorityQueue":31,"./Queue/Queue":32,"./Set/Set":33,"./Stack/Stack":34,"./Vector/Vector":35}],37:[function(i,s,r){const o=i("yallist"),n=Symbol("max"),c=Symbol("length"),a=Symbol("lengthCalculator"),h=Symbol("allowStale"),l=Symbol("maxAge"),u=Symbol("dispose"),d=Symbol("noDisposeOnSet"),f=Symbol("lruList"),g=Symbol("cache"),y=Symbol("updateAgeOnGet"),v=()=>1,b=(E,_,W)=>{const Y=E[g].get(_);if(Y){const C=Y.value;if(x(E,C)){if(T(E,Y),!E[h])return}else W&&(E[y]&&(Y.value.now=Date.now()),E[f].unshiftNode(Y));return C.value}},x=(E,_)=>{if(!_||!_.maxAge&&!E[l])return!1;const W=Date.now()-_.now;return _.maxAge?W>_.maxAge:E[l]&&W>E[l]},m=E=>{if(E[c]>E[n])for(let _=E[f].tail;E[c]>E[n]&&_!==null;){const W=_.prev;T(E,_),_=W}},T=(E,_)=>{if(_){const W=_.value;E[u]&&E[u](W.key,W.value),E[c]-=W.length,E[g].delete(W.key),E[f].removeNode(_)}};class I{constructor(_,W,Y,C,k){this.key=_,this.value=W,this.length=Y,this.now=C,this.maxAge=k||0}}const P=(E,_,W,Y)=>{let C=W.value;x(E,C)&&(T(E,W),E[h]||(C=void 0)),C&&_.call(Y,C.value,C.key,E)};s.exports=class{constructor(E){if(typeof E=="number"&&(E={max:E}),E||(E={}),E.max&&(typeof E.max!="number"||E.max<0))throw new TypeError("max must be a non-negative number");this[n]=E.max||1/0;const _=E.length||v;if(this[a]=typeof _!="function"?v:_,this[h]=E.stale||!1,E.maxAge&&typeof E.maxAge!="number")throw new TypeError("maxAge must be a number");this[l]=E.maxAge||0,this[u]=E.dispose,this[d]=E.noDisposeOnSet||!1,this[y]=E.updateAgeOnGet||!1,this.reset()}set max(E){if(typeof E!="number"||E<0)throw new TypeError("max must be a non-negative number");this[n]=E||1/0,m(this)}get max(){return this[n]}set allowStale(E){this[h]=!!E}get allowStale(){return this[h]}set maxAge(E){if(typeof E!="number")throw new TypeError("maxAge must be a non-negative number");this[l]=E,m(this)}get maxAge(){return this[l]}set lengthCalculator(E){typeof E!="function"&&(E=v),E!==this[a]&&(this[a]=E,this[c]=0,this[f].forEach(_=>{_.length=this[a](_.value,_.key),this[c]+=_.length})),m(this)}get lengthCalculator(){return this[a]}get length(){return this[c]}get itemCount(){return this[f].length}rforEach(E,_){_=_||this;for(let W=this[f].tail;W!==null;){const Y=W.prev;P(this,E,W,_),W=Y}}forEach(E,_){_=_||this;for(let W=this[f].head;W!==null;){const Y=W.next;P(this,E,W,_),W=Y}}keys(){return this[f].toArray().map(E=>E.key)}values(){return this[f].toArray().map(E=>E.value)}reset(){this[u]&&this[f]&&this[f].length&&this[f].forEach(E=>this[u](E.key,E.value)),this[g]=new Map,this[f]=new o,this[c]=0}dump(){return this[f].map(E=>!x(this,E)&&{k:E.key,v:E.value,e:E.now+(E.maxAge||0)}).toArray().filter(E=>E)}dumpLru(){return this[f]}set(E,_,W){if((W=W||this[l])&&typeof W!="number")throw new TypeError("maxAge must be a number");const Y=W?Date.now():0,C=this[a](_,E);if(this[g].has(E)){if(C>this[n])return T(this,this[g].get(E)),!1;const R=this[g].get(E).value;return this[u]&&(this[d]||this[u](E,R.value)),R.now=Y,R.maxAge=W,R.value=_,this[c]+=C-R.length,R.length=C,this.get(E),m(this),!0}const k=new I(E,_,C,Y,W);return k.length>this[n]?(this[u]&&this[u](E,_),!1):(this[c]+=k.length,this[f].unshift(k),this[g].set(E,this[f].head),m(this),!0)}has(E){if(!this[g].has(E))return!1;const _=this[g].get(E).value;return!x(this,_)}get(E){return b(this,E,!0)}peek(E){return b(this,E,!1)}pop(){const E=this[f].tail;return E?(T(this,E),E.value):null}del(E){T(this,this[g].get(E))}load(E){this.reset();const _=Date.now();for(let W=E.length-1;W>=0;W--){const Y=E[W],C=Y.e||0;if(C===0)this.set(Y.k,Y.v);else{const k=C-_;k>0&&this.set(Y.k,Y.v,k)}}}prune(){this[g].forEach((E,_)=>b(this,_,!1))}}},{yallist:83}],38:[function(i,s,r){(function(o){(function(){const n=s.exports;n.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},n.codes={};for(const a in n.types){const h=n.types[a];n.codes[h]=a}n.CMD_SHIFT=4,n.CMD_MASK=240,n.DUP_MASK=8,n.QOS_MASK=3,n.QOS_SHIFT=1,n.RETAIN_MASK=1,n.VARBYTEINT_MASK=127,n.VARBYTEINT_FIN_MASK=128,n.VARBYTEINT_MAX=268435455,n.SESSIONPRESENT_MASK=1,n.SESSIONPRESENT_HEADER=o.from([n.SESSIONPRESENT_MASK]),n.CONNACK_HEADER=o.from([n.codes.connack<<n.CMD_SHIFT]),n.USERNAME_MASK=128,n.PASSWORD_MASK=64,n.WILL_RETAIN_MASK=32,n.WILL_QOS_MASK=24,n.WILL_QOS_SHIFT=3,n.WILL_FLAG_MASK=4,n.CLEAN_SESSION_MASK=2,n.CONNECT_HEADER=o.from([n.codes.connect<<n.CMD_SHIFT]),n.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},n.propertiesCodes={};for(const a in n.properties){const h=n.properties[a];n.propertiesCodes[h]=a}function c(a){return[0,1,2].map(h=>[0,1].map(l=>[0,1].map(u=>{const d=o.alloc(1);return d.writeUInt8(n.codes[a]<<n.CMD_SHIFT|(l?n.DUP_MASK:0)|h<<n.QOS_SHIFT|u,0,!0),d})))}n.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},n.PUBLISH_HEADER=c("publish"),n.SUBSCRIBE_HEADER=c("subscribe"),n.SUBSCRIBE_OPTIONS_QOS_MASK=3,n.SUBSCRIBE_OPTIONS_NL_MASK=1,n.SUBSCRIBE_OPTIONS_NL_SHIFT=2,n.SUBSCRIBE_OPTIONS_RAP_MASK=1,n.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,n.SUBSCRIBE_OPTIONS_RH_MASK=3,n.SUBSCRIBE_OPTIONS_RH_SHIFT=4,n.SUBSCRIBE_OPTIONS_RH=[0,16,32],n.SUBSCRIBE_OPTIONS_NL=4,n.SUBSCRIBE_OPTIONS_RAP=8,n.SUBSCRIBE_OPTIONS_QOS=[0,1,2],n.UNSUBSCRIBE_HEADER=c("unsubscribe"),n.ACKS={unsuback:c("unsuback"),puback:c("puback"),pubcomp:c("pubcomp"),pubrel:c("pubrel"),pubrec:c("pubrec")},n.SUBACK_HEADER=o.from([n.codes.suback<<n.CMD_SHIFT]),n.VERSION3=o.from([3]),n.VERSION4=o.from([4]),n.VERSION5=o.from([5]),n.VERSION131=o.from([131]),n.VERSION132=o.from([132]),n.QOS=[0,1,2].map(a=>o.from([a])),n.EMPTY={pingreq:o.from([n.codes.pingreq<<4,0]),pingresp:o.from([n.codes.pingresp<<4,0]),disconnect:o.from([n.codes.disconnect<<4,0])}}).call(this)}).call(this,i("buffer").Buffer)},{buffer:17}],39:[function(i,s,r){(function(o){(function(){const n=i("./writeToStream"),c=i("events");class a extends c{constructor(){super(),this._array=new Array(20),this._i=0}write(l){return this._array[this._i++]=l,!0}concat(){let l=0;const u=new Array(this._array.length),d=this._array;let f,g=0;for(f=0;f<d.length&&d[f]!==void 0;f++)typeof d[f]!="string"?u[f]=d[f].length:u[f]=o.byteLength(d[f]),l+=u[f];const y=o.allocUnsafe(l);for(f=0;f<d.length&&d[f]!==void 0;f++)typeof d[f]!="string"?(d[f].copy(y,g),g+=u[f]):(y.write(d[f],g),g+=u[f]);return y}}s.exports=function(h,l){const u=new a;return n(h,u,l),u.concat()}}).call(this)}).call(this,i("buffer").Buffer)},{"./writeToStream":44,buffer:17,events:22}],40:[function(i,s,r){r.parser=i("./parser").parser,r.generate=i("./generate"),r.writeToStream=i("./writeToStream")},{"./generate":39,"./parser":43,"./writeToStream":44}],41:[function(i,s,r){(function(o){(function(){const c={},a=o.isBuffer(o.from([1,2]).subarray(0,1));function h(l){const u=o.allocUnsafe(2);return u.writeUInt8(l>>8,0),u.writeUInt8(255&l,1),u}s.exports={cache:c,generateCache:function(){for(let l=0;l<65536;l++)c[l]=h(l)},generateNumber:h,genBufVariableByteInt:function(l){let u=0,d=0;const f=o.allocUnsafe(4);do u=l%128|0,(l=l/128|0)>0&&(u|=128),f.writeUInt8(u,d++);while(l>0&&d<4);return l>0&&(d=0),a?f.subarray(0,d):f.slice(0,d)},generate4ByteBuffer:function(l){const u=o.allocUnsafe(4);return u.writeUInt32BE(l,0),u}}}).call(this)}).call(this,i("buffer").Buffer)},{buffer:17}],42:[function(i,s,r){s.exports=class{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}}},{}],43:[function(i,s,r){const o=i("bl"),n=i("events"),c=i("./packet"),a=i("./constants"),h=i("debug")("mqtt-packet:parser");class l extends n{constructor(){super(),this.parser=this.constructor.parser}static parser(d){return this instanceof l?(this.settings=d||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):new l().parser(d)}_resetState(){h("_resetState: resetting packet, error, _list, and _stateCounter"),this.packet=new c,this.error=null,this._list=o(),this._stateCounter=0}parse(d){for(this.error&&this._resetState(),this._list.append(d),h("parse: current state: %s",this._states[this._stateCounter]);(this.packet.length!==-1||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,h("parse: state complete. _stateCounter is now: %d",this._stateCounter),h("parse: packet.length: %d, buffer list length: %d",this.packet.length,this._list.length),this._stateCounter>=this._states.length&&(this._stateCounter=0);return h("parse: exited while loop. packet: %d, buffer list length: %d",this.packet.length,this._list.length),this._list.length}_parseHeader(){const d=this._list.readUInt8(0);return this.packet.cmd=a.types[d>>a.CMD_SHIFT],this.packet.retain=(d&a.RETAIN_MASK)!=0,this.packet.qos=d>>a.QOS_SHIFT&a.QOS_MASK,this.packet.dup=(d&a.DUP_MASK)!=0,h("_parseHeader: packet: %o",this.packet),this._list.consume(1),!0}_parseLength(){const d=this._parseVarByteNum(!0);return d&&(this.packet.length=d.value,this._list.consume(d.bytes)),h("_parseLength %d",d.value),!!d}_parsePayload(){h("_parsePayload: payload %O",this._list);let d=!1;if(this.packet.length===0||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}d=!0}return h("_parsePayload complete result: %s",d),d}_parseConnect(){let d,f,g,y;h("_parseConnect");const v={},b=this.packet,x=this._parseString();if(x===null)return this._emitError(new Error("Cannot parse protocolId"));if(x!=="MQTT"&&x!=="MQIsdp")return this._emitError(new Error("Invalid protocolId"));if(b.protocolId=x,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(b.protocolVersion=this._list.readUInt8(this._pos),b.protocolVersion>=128&&(b.bridgeMode=!0,b.protocolVersion=b.protocolVersion-128),b.protocolVersion!==3&&b.protocolVersion!==4&&b.protocolVersion!==5)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(v.username=this._list.readUInt8(this._pos)&a.USERNAME_MASK,v.password=this._list.readUInt8(this._pos)&a.PASSWORD_MASK,v.will=this._list.readUInt8(this._pos)&a.WILL_FLAG_MASK,v.will&&(b.will={},b.will.retain=(this._list.readUInt8(this._pos)&a.WILL_RETAIN_MASK)!=0,b.will.qos=(this._list.readUInt8(this._pos)&a.WILL_QOS_MASK)>>a.WILL_QOS_SHIFT),b.clean=(this._list.readUInt8(this._pos)&a.CLEAN_SESSION_MASK)!=0,this._pos++,b.keepalive=this._parseNum(),b.keepalive===-1)return this._emitError(new Error("Packet too short"));if(b.protocolVersion===5){const T=this._parseProperties();Object.getOwnPropertyNames(T).length&&(b.properties=T)}const m=this._parseString();if(m===null)return this._emitError(new Error("Packet too short"));if(b.clientId=m,h("_parseConnect: packet.clientId: %s",b.clientId),v.will){if(b.protocolVersion===5){const T=this._parseProperties();Object.getOwnPropertyNames(T).length&&(b.will.properties=T)}if((d=this._parseString())===null)return this._emitError(new Error("Cannot parse will topic"));if(b.will.topic=d,h("_parseConnect: packet.will.topic: %s",b.will.topic),(f=this._parseBuffer())===null)return this._emitError(new Error("Cannot parse will payload"));b.will.payload=f,h("_parseConnect: packet.will.paylaod: %s",b.will.payload)}if(v.username){if((y=this._parseString())===null)return this._emitError(new Error("Cannot parse username"));b.username=y,h("_parseConnect: packet.username: %s",b.username)}if(v.password){if((g=this._parseBuffer())===null)return this._emitError(new Error("Cannot parse password"));b.password=g}return this.settings=b,h("_parseConnect: complete"),b}_parseConnack(){h("_parseConnack");const d=this.packet;if(this._list.length<1)return null;if(d.sessionPresent=!!(this._list.readUInt8(this._pos++)&a.SESSIONPRESENT_MASK),this.settings.protocolVersion===5)this._list.length>=2?d.reasonCode=this._list.readUInt8(this._pos++):d.reasonCode=0;else{if(this._list.length<2)return null;d.returnCode=this._list.readUInt8(this._pos++)}if(d.returnCode===-1||d.reasonCode===-1)return this._emitError(new Error("Cannot parse return code"));if(this.settings.protocolVersion===5){const f=this._parseProperties();Object.getOwnPropertyNames(f).length&&(d.properties=f)}h("_parseConnack: complete")}_parsePublish(){h("_parsePublish");const d=this.packet;if(d.topic=this._parseString(),d.topic===null)return this._emitError(new Error("Cannot parse topic"));if(!(d.qos>0)||this._parseMessageId()){if(this.settings.protocolVersion===5){const f=this._parseProperties();Object.getOwnPropertyNames(f).length&&(d.properties=f)}d.payload=this._list.slice(this._pos,d.length),h("_parsePublish: payload from buffer list: %o",d.payload)}}_parseSubscribe(){h("_parseSubscribe");const d=this.packet;let f,g,y,v,b,x,m;if(d.qos!==1)return this._emitError(new Error("Wrong subscribe header"));if(d.subscriptions=[],this._parseMessageId()){if(this.settings.protocolVersion===5){const T=this._parseProperties();Object.getOwnPropertyNames(T).length&&(d.properties=T)}for(;this._pos<d.length;){if((f=this._parseString())===null)return this._emitError(new Error("Cannot parse topic"));if(this._pos>=d.length)return this._emitError(new Error("Malformed Subscribe Payload"));y=(g=this._parseByte())&a.SUBSCRIBE_OPTIONS_QOS_MASK,x=(g>>a.SUBSCRIBE_OPTIONS_NL_SHIFT&a.SUBSCRIBE_OPTIONS_NL_MASK)!=0,b=(g>>a.SUBSCRIBE_OPTIONS_RAP_SHIFT&a.SUBSCRIBE_OPTIONS_RAP_MASK)!=0,v=g>>a.SUBSCRIBE_OPTIONS_RH_SHIFT&a.SUBSCRIBE_OPTIONS_RH_MASK,m={topic:f,qos:y},this.settings.protocolVersion===5?(m.nl=x,m.rap=b,m.rh=v):this.settings.bridgeMode&&(m.rh=0,m.rap=!0,m.nl=!0),h("_parseSubscribe: push subscription `%s` to subscription",m),d.subscriptions.push(m)}}}_parseSuback(){h("_parseSuback");const d=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(this.settings.protocolVersion===5){const f=this._parseProperties();Object.getOwnPropertyNames(f).length&&(d.properties=f)}for(;this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseUnsubscribe(){h("_parseUnsubscribe");const d=this.packet;if(d.unsubscriptions=[],this._parseMessageId()){if(this.settings.protocolVersion===5){const f=this._parseProperties();Object.getOwnPropertyNames(f).length&&(d.properties=f)}for(;this._pos<d.length;){const f=this._parseString();if(f===null)return this._emitError(new Error("Cannot parse topic"));h("_parseUnsubscribe: push topic `%s` to unsubscriptions",f),d.unsubscriptions.push(f)}}}_parseUnsuback(){h("_parseUnsuback");const d=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if(this.settings.protocolVersion===5){const f=this._parseProperties();for(Object.getOwnPropertyNames(f).length&&(d.properties=f),d.granted=[];this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseConfirmation(){h("_parseConfirmation: packet.cmd: `%s`",this.packet.cmd);const d=this.packet;if(this._parseMessageId(),this.settings.protocolVersion===5&&(d.length>2?(d.reasonCode=this._parseByte(),h("_parseConfirmation: packet.reasonCode `%d`",d.reasonCode)):d.reasonCode=0,d.length>3)){const f=this._parseProperties();Object.getOwnPropertyNames(f).length&&(d.properties=f)}return!0}_parseDisconnect(){const d=this.packet;if(h("_parseDisconnect"),this.settings.protocolVersion===5){this._list.length>0?d.reasonCode=this._parseByte():d.reasonCode=0;const f=this._parseProperties();Object.getOwnPropertyNames(f).length&&(d.properties=f)}return h("_parseDisconnect result: true"),!0}_parseAuth(){h("_parseAuth");const d=this.packet;if(this.settings.protocolVersion!==5)return this._emitError(new Error("Not supported auth packet for this version MQTT"));d.reasonCode=this._parseByte();const f=this._parseProperties();return Object.getOwnPropertyNames(f).length&&(d.properties=f),h("_parseAuth: result: true"),!0}_parseMessageId(){const d=this.packet;return d.messageId=this._parseNum(),d.messageId===null?(this._emitError(new Error("Cannot parse messageId")),!1):(h("_parseMessageId: packet.messageId %d",d.messageId),!0)}_parseString(d){const f=this._parseNum(),g=f+this._pos;if(f===-1||g>this._list.length||g>this.packet.length)return null;const y=this._list.toString("utf8",this._pos,g);return this._pos+=f,h("_parseString: result: %s",y),y}_parseStringPair(){return h("_parseStringPair"),{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const d=this._parseNum(),f=d+this._pos;if(d===-1||f>this._list.length||f>this.packet.length)return null;const g=this._list.slice(this._pos,f);return this._pos+=d,h("_parseBuffer: result: %o",g),g}_parseNum(){if(this._list.length-this._pos<2)return-1;const d=this._list.readUInt16BE(this._pos);return this._pos+=2,h("_parseNum: result: %s",d),d}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const d=this._list.readUInt32BE(this._pos);return this._pos+=4,h("_parse4ByteNum: result: %s",d),d}_parseVarByteNum(d){h("_parseVarByteNum");let f,g=0,y=1,v=0,b=!1;const x=this._pos?this._pos:0;for(;g<4&&x+g<this._list.length;){if(v+=y*((f=this._list.readUInt8(x+g++))&a.VARBYTEINT_MASK),y*=128,(f&a.VARBYTEINT_FIN_MASK)==0){b=!0;break}if(this._list.length<=g)break}return!b&&g===4&&this._list.length>=g&&this._emitError(new Error("Invalid variable byte integer")),x&&(this._pos+=g),h("_parseVarByteNum: result: %o",b=!!b&&(d?{bytes:g,value:v}:v)),b}_parseByte(){let d;return this._pos<this._list.length&&(d=this._list.readUInt8(this._pos),this._pos++),h("_parseByte: result: %o",d),d}_parseByType(d){switch(h("_parseByType: type: %s",d),d){case"byte":return this._parseByte()!==0;case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){h("_parseProperties");const d=this._parseVarByteNum(),f=this._pos+d,g={};for(;this._pos<f;){const y=this._parseByte();if(!y)return this._emitError(new Error("Cannot parse property code type")),!1;const v=a.propertiesCodes[y];if(!v)return this._emitError(new Error("Unknown property")),!1;if(v!=="userProperties")g[v]?Array.isArray(g[v])?g[v].push(this._parseByType(a.propertiesTypes[v])):(g[v]=[g[v]],g[v].push(this._parseByType(a.propertiesTypes[v]))):g[v]=this._parseByType(a.propertiesTypes[v]);else{g[v]||(g[v]=Object.create(null));const b=this._parseByType(a.propertiesTypes[v]);if(g[v][b.name])if(Array.isArray(g[v][b.name]))g[v][b.name].push(b.value);else{const x=g[v][b.name];g[v][b.name]=[x],g[v][b.name].push(b.value)}else g[v][b.name]=b.value}}return g}_newPacket(){return h("_newPacket"),this.packet&&(this._list.consume(this.packet.length),h("_newPacket: parser emit packet: packet.cmd: %s, packet.payload: %s, packet.length: %d",this.packet.cmd,this.packet.payload,this.packet.length),this.emit("packet",this.packet)),h("_newPacket: new packet"),this.packet=new c,this._pos=0,!0}_emitError(d){h("_emitError"),this.error=d,this.emit("error",d)}}s.exports=l},{"./constants":38,"./packet":42,bl:15,debug:18,events:22}],44:[function(i,s,r){(function(o){(function(){const n=i("./constants"),c=o.allocUnsafe(0),a=o.from([0]),h=i("./numbers"),l=i("process-nextick-args").nextTick,u=i("debug")("mqtt-packet:writeToStream"),d=h.cache,f=h.generateNumber,g=h.generateCache,y=h.genBufVariableByteInt,v=h.generate4ByteBuffer;let b=W,x=!0;function m(F,L,O){switch(u("generate called"),L.cork&&(L.cork(),l(T,L)),x&&(x=!1,g()),u("generate: packet.cmd: %s",F.cmd),F.cmd){case"connect":return function(z,B,U){const $=z||{},q=$.protocolId||"MQTT";let Q=$.protocolVersion||4;const X=$.will;let J=$.clean;const p=$.keepalive||0,w=$.clientId||"",A=$.username,M=$.password,j=$.properties;J===void 0&&(J=!0);let V=0;if(!q||typeof q!="string"&&!o.isBuffer(q))return B.emit("error",new Error("Invalid protocolId")),!1;if(V+=q.length+2,Q!==3&&Q!==4&&Q!==5)return B.emit("error",new Error("Invalid protocol version")),!1;if(V+=1,(typeof w=="string"||o.isBuffer(w))&&(w||Q>=4)&&(w||J))V+=o.byteLength(w)+2;else{if(Q<4)return B.emit("error",new Error("clientId must be supplied before 3.1.1")),!1;if(1*J==0)return B.emit("error",new Error("clientId must be given if cleanSession set to 0")),!1}if(typeof p!="number"||p<0||p>65535||p%1!=0)return B.emit("error",new Error("Invalid keepalive")),!1;if(V+=2,V+=1,Q===5){var G=k(B,j);if(!G)return!1;V+=G.length}if(X){if(typeof X!="object")return B.emit("error",new Error("Invalid will")),!1;if(!X.topic||typeof X.topic!="string")return B.emit("error",new Error("Invalid will topic")),!1;if(V+=o.byteLength(X.topic)+2,V+=2,X.payload){if(!(X.payload.length>=0))return B.emit("error",new Error("Invalid will payload")),!1;typeof X.payload=="string"?V+=o.byteLength(X.payload):V+=X.payload.length}var tt={};if(Q===5){if(!(tt=k(B,X.properties)))return!1;V+=tt.length}}let Z=!1;if(A!=null){if(!K(A))return B.emit("error",new Error("Invalid username")),!1;Z=!0,V+=o.byteLength(A)+2}if(M!=null){if(!Z)return B.emit("error",new Error("Username is required to use password")),!1;if(!K(M))return B.emit("error",new Error("Invalid password")),!1;V+=H(M)+2}B.write(n.CONNECT_HEADER),P(B,V),C(B,q),$.bridgeMode&&(Q+=128),B.write(Q===131?n.VERSION131:Q===132?n.VERSION132:Q===4?n.VERSION4:Q===5?n.VERSION5:n.VERSION3);let et=0;return et|=A!=null?n.USERNAME_MASK:0,et|=M!=null?n.PASSWORD_MASK:0,et|=X&&X.retain?n.WILL_RETAIN_MASK:0,et|=X&&X.qos?X.qos<<n.WILL_QOS_SHIFT:0,et|=X?n.WILL_FLAG_MASK:0,et|=J?n.CLEAN_SESSION_MASK:0,B.write(o.from([et])),b(B,p),Q===5&&G.write(),C(B,w),X&&(Q===5&&tt.write(),E(B,X.topic),C(B,X.payload)),A!=null&&C(B,A),M!=null&&C(B,M),!0}(F,L);case"connack":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=$===5?q.reasonCode:q.returnCode,X=q.properties;let J=2;if(typeof Q!="number")return B.emit("error",new Error("Invalid return code")),!1;let p=null;if($===5){if(!(p=k(B,X)))return!1;J+=p.length}return B.write(n.CONNACK_HEADER),P(B,J),B.write(q.sessionPresent?n.SESSIONPRESENT_HEADER:a),B.write(o.from([Q])),p!=null&&p.write(),!0}(F,L,O);case"publish":return function(z,B,U){u("publish: packet: %o",z);const $=U?U.protocolVersion:4,q=z||{},Q=q.qos||0,X=q.retain?n.RETAIN_MASK:0,J=q.topic,p=q.payload||c,w=q.messageId,A=q.properties;let M=0;if(typeof J=="string")M+=o.byteLength(J)+2;else{if(!o.isBuffer(J))return B.emit("error",new Error("Invalid topic")),!1;M+=J.length+2}if(o.isBuffer(p)?M+=p.length:M+=o.byteLength(p),Q&&typeof w!="number")return B.emit("error",new Error("Invalid messageId")),!1;Q&&(M+=2);let j=null;if($===5){if(!(j=k(B,A)))return!1;M+=j.length}return B.write(n.PUBLISH_HEADER[Q][q.dup?1:0][X?1:0]),P(B,M),b(B,H(J)),B.write(J),Q>0&&b(B,w),j!=null&&j.write(),u("publish: payload: %o",p),B.write(p)}(F,L,O);case"puback":case"pubrec":case"pubrel":case"pubcomp":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=q.cmd||"puback",X=q.messageId,J=q.dup&&Q==="pubrel"?n.DUP_MASK:0;let p=0;const w=q.reasonCode,A=q.properties;let M=$===5?3:2;if(Q==="pubrel"&&(p=1),typeof X!="number")return B.emit("error",new Error("Invalid messageId")),!1;let j=null;if($===5&&typeof A=="object"){if(!(j=R(B,A,U,M)))return!1;M+=j.length}return B.write(n.ACKS[Q][p][J][0]),P(B,M),b(B,X),$===5&&B.write(o.from([w])),j!==null&&j.write(),!0}(F,L,O);case"subscribe":return function(z,B,U){u("subscribe: packet: ");const $=U?U.protocolVersion:4,q=z||{},Q=q.dup?n.DUP_MASK:0,X=q.messageId,J=q.subscriptions,p=q.properties;let w=0;if(typeof X!="number")return B.emit("error",new Error("Invalid messageId")),!1;w+=2;let A=null;if($===5){if(!(A=k(B,p)))return!1;w+=A.length}if(typeof J!="object"||!J.length)return B.emit("error",new Error("Invalid subscriptions")),!1;for(let j=0;j<J.length;j+=1){const V=J[j].topic,G=J[j].qos;if(typeof V!="string")return B.emit("error",new Error("Invalid subscriptions - invalid topic")),!1;if(typeof G!="number")return B.emit("error",new Error("Invalid subscriptions - invalid qos")),!1;if($===5){if(typeof(J[j].nl||!1)!="boolean")return B.emit("error",new Error("Invalid subscriptions - invalid No Local")),!1;if(typeof(J[j].rap||!1)!="boolean")return B.emit("error",new Error("Invalid subscriptions - invalid Retain as Published")),!1;const et=J[j].rh||0;if(typeof et!="number"||et>2)return B.emit("error",new Error("Invalid subscriptions - invalid Retain Handling")),!1}w+=o.byteLength(V)+2+1}u("subscribe: writing to stream: %o",n.SUBSCRIBE_HEADER),B.write(n.SUBSCRIBE_HEADER[1][Q?1:0][0]),P(B,w),b(B,X),A!==null&&A.write();let M=!0;for(const j of J){const V=j.topic,G=j.qos,tt=+j.nl,Z=+j.rap,et=j.rh;let it;E(B,V),it=n.SUBSCRIBE_OPTIONS_QOS[G],$===5&&(it|=tt?n.SUBSCRIBE_OPTIONS_NL:0,it|=Z?n.SUBSCRIBE_OPTIONS_RAP:0,it|=et?n.SUBSCRIBE_OPTIONS_RH[et]:0),M=B.write(o.from([it]))}return M}(F,L,O);case"suback":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=q.messageId,X=q.granted,J=q.properties;let p=0;if(typeof Q!="number")return B.emit("error",new Error("Invalid messageId")),!1;if(p+=2,typeof X!="object"||!X.length)return B.emit("error",new Error("Invalid qos vector")),!1;for(let A=0;A<X.length;A+=1){if(typeof X[A]!="number")return B.emit("error",new Error("Invalid qos vector")),!1;p+=1}let w=null;if($===5){if(!(w=R(B,J,U,p)))return!1;p+=w.length}return B.write(n.SUBACK_HEADER),P(B,p),b(B,Q),w!==null&&w.write(),B.write(o.from(X))}(F,L,O);case"unsubscribe":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=q.messageId,X=q.dup?n.DUP_MASK:0,J=q.unsubscriptions,p=q.properties;let w=0;if(typeof Q!="number")return B.emit("error",new Error("Invalid messageId")),!1;if(w+=2,typeof J!="object"||!J.length)return B.emit("error",new Error("Invalid unsubscriptions")),!1;for(let j=0;j<J.length;j+=1){if(typeof J[j]!="string")return B.emit("error",new Error("Invalid unsubscriptions")),!1;w+=o.byteLength(J[j])+2}let A=null;if($===5){if(!(A=k(B,p)))return!1;w+=A.length}B.write(n.UNSUBSCRIBE_HEADER[1][X?1:0][0]),P(B,w),b(B,Q),A!==null&&A.write();let M=!0;for(let j=0;j<J.length;j++)M=E(B,J[j]);return M}(F,L,O);case"unsuback":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=q.messageId,X=q.dup?n.DUP_MASK:0,J=q.granted,p=q.properties,w=q.cmd;let A=2;if(typeof Q!="number")return B.emit("error",new Error("Invalid messageId")),!1;if($===5){if(typeof J!="object"||!J.length)return B.emit("error",new Error("Invalid qos vector")),!1;for(let j=0;j<J.length;j+=1){if(typeof J[j]!="number")return B.emit("error",new Error("Invalid qos vector")),!1;A+=1}}let M=null;if($===5){if(!(M=R(B,p,U,A)))return!1;A+=M.length}return B.write(n.ACKS[w][0][X][0]),P(B,A),b(B,Q),M!==null&&M.write(),$===5&&B.write(o.from(J)),!0}(F,L,O);case"pingreq":case"pingresp":return function(z,B,U){return B.write(n.EMPTY[z.cmd])}(F,L);case"disconnect":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=q.reasonCode,X=q.properties;let J=$===5?1:0,p=null;if($===5){if(!(p=R(B,X,U,J)))return!1;J+=p.length}return B.write(o.from([n.codes.disconnect<<4])),P(B,J),$===5&&B.write(o.from([Q])),p!==null&&p.write(),!0}(F,L,O);case"auth":return function(z,B,U){const $=U?U.protocolVersion:4,q=z||{},Q=q.reasonCode,X=q.properties;let J=$===5?1:0;$!==5&&B.emit("error",new Error("Invalid mqtt version for auth packet"));const p=R(B,X,U,J);return p?(J+=p.length,B.write(o.from([n.codes.auth<<4])),P(B,J),B.write(o.from([Q])),p!==null&&p.write(),!0):!1}(F,L,O);default:return L.emit("error",new Error("Unknown command")),!1}}function T(F){F.uncork()}Object.defineProperty(m,"cacheNumbers",{get:()=>b===W,set(F){F?(d&&Object.keys(d).length!==0||(x=!0),b=W):(x=!1,b=Y)}});const I={};function P(F,L){if(L>n.VARBYTEINT_MAX)return F.emit("error",new Error(`Invalid variable byte integer: ${L}`)),!1;let O=I[L];return O||(O=y(L),L<16384&&(I[L]=O)),u("writeVarByteInt: writing to stream: %o",O),F.write(O)}function E(F,L){const O=o.byteLength(L);return b(F,O),u("writeString: %s",L),F.write(L,"utf8")}function _(F,L,O){E(F,L),E(F,O)}function W(F,L){return u("writeNumberCached: number: %d",L),u("writeNumberCached: %o",d[L]),F.write(d[L])}function Y(F,L){const O=f(L);return u("writeNumberGenerated: %o",O),F.write(O)}function C(F,L){typeof L=="string"?E(F,L):L?(b(F,L.length),F.write(L)):b(F,0)}function k(F,L){if(typeof L!="object"||L.length!=null)return{length:1,write(){N(F,{},0)}};let O=0;function z(B,U){let $=0;switch(n.propertiesTypes[B]){case"byte":if(typeof U!="boolean")return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=2;break;case"int8":if(typeof U!="number"||U<0||U>255)return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=2;break;case"binary":if(U&&U===null)return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=1+o.byteLength(U)+2;break;case"int16":if(typeof U!="number"||U<0||U>65535)return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=3;break;case"int32":if(typeof U!="number"||U<0||U>4294967295)return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=5;break;case"var":if(typeof U!="number"||U<0||U>268435455)return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=1+o.byteLength(y(U));break;case"string":if(typeof U!="string")return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=3+o.byteLength(U.toString());break;case"pair":if(typeof U!="object")return F.emit("error",new Error(`Invalid ${B}: ${U}`)),!1;$+=Object.getOwnPropertyNames(U).reduce((q,Q)=>{const X=U[Q];return Array.isArray(X)?q+=X.reduce((J,p)=>J+=3+o.byteLength(Q.toString())+2+o.byteLength(p.toString()),0):q+=3+o.byteLength(Q.toString())+2+o.byteLength(U[Q].toString()),q},0);break;default:return F.emit("error",new Error(`Invalid property ${B}: ${U}`)),!1}return $}if(L)for(const B in L){let U=0,$=0;const q=L[B];if(Array.isArray(q))for(let Q=0;Q<q.length;Q++){if(!($=z(B,q[Q])))return!1;U+=$}else{if(!($=z(B,q)))return!1;U=$}if(!U)return!1;O+=U}return{length:o.byteLength(y(O))+O,write(){N(F,L,O)}}}function R(F,L,O,z){const B=["reasonString","userProperties"],U=O&&O.properties&&O.properties.maximumPacketSize?O.properties.maximumPacketSize:0;let $=k(F,L);if(U)for(;z+$.length>U;){const q=B.shift();if(!q||!L[q])return!1;delete L[q],$=k(F,L)}return $}function S(F,L,O){switch(n.propertiesTypes[L]){case"byte":F.write(o.from([n.properties[L]])),F.write(o.from([+O]));break;case"int8":F.write(o.from([n.properties[L]])),F.write(o.from([O]));break;case"binary":F.write(o.from([n.properties[L]])),C(F,O);break;case"int16":F.write(o.from([n.properties[L]])),b(F,O);break;case"int32":F.write(o.from([n.properties[L]])),function(z,B){const U=v(B);u("write4ByteNumber: %o",U),z.write(U)}(F,O);break;case"var":F.write(o.from([n.properties[L]])),P(F,O);break;case"string":F.write(o.from([n.properties[L]])),E(F,O);break;case"pair":Object.getOwnPropertyNames(O).forEach(z=>{const B=O[z];Array.isArray(B)?B.forEach(U=>{F.write(o.from([n.properties[L]])),_(F,z.toString(),U.toString())}):(F.write(o.from([n.properties[L]])),_(F,z.toString(),B.toString()))});break;default:return F.emit("error",new Error(`Invalid property ${L} value: ${O}`)),!1}}function N(F,L,O){P(F,O);for(const z in L)if(Object.prototype.hasOwnProperty.call(L,z)&&L[z]!==null){const B=L[z];if(Array.isArray(B))for(let U=0;U<B.length;U++)S(F,z,B[U]);else S(F,z,B)}}function H(F){return F?F instanceof o?F.length:o.byteLength(F):0}function K(F){return typeof F=="string"||F instanceof o}s.exports=m}).call(this)}).call(this,i("buffer").Buffer)},{"./constants":38,"./numbers":41,buffer:17,debug:18,"process-nextick-args":49}],45:[function(i,s,r){var o=1e3,n=60*o,c=60*n,a=24*c,h=7*a,l=365.25*a;function u(d,f,g,y){var v=f>=1.5*g;return Math.round(d/g)+" "+y+(v?"s":"")}s.exports=function(d,f){f=f||{};var g=typeof d;if(g==="string"&&d.length>0)return function(y){if(!((y=String(y)).length>100)){var v=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(y);if(v){var b=parseFloat(v[1]);switch((v[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return b*l;case"weeks":case"week":case"w":return b*h;case"days":case"day":case"d":return b*a;case"hours":case"hour":case"hrs":case"hr":case"h":return b*c;case"minutes":case"minute":case"mins":case"min":case"m":return b*n;case"seconds":case"second":case"secs":case"sec":case"s":return b*o;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return b;default:return}}}}(d);if(g==="number"&&isFinite(d))return f.long?function(y){var v=Math.abs(y);return v>=a?u(y,v,a,"day"):v>=c?u(y,v,c,"hour"):v>=n?u(y,v,n,"minute"):v>=o?u(y,v,o,"second"):y+" ms"}(d):function(y){var v=Math.abs(y);return v>=a?Math.round(y/a)+"d":v>=c?Math.round(y/c)+"h":v>=n?Math.round(y/n)+"m":v>=o?Math.round(y/o)+"s":y+"ms"}(d);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(d))}},{}],46:[function(i,s,r){const o=i("./lib/number-allocator.js");s.exports.NumberAllocator=o},{"./lib/number-allocator.js":47}],47:[function(i,s,r){const o=i("js-sdsl").Set,n=i("debug")("number-allocator:trace"),c=i("debug")("number-allocator:error");function a(l,u){this.low=l,this.high=u}function h(l,u){if(!(this instanceof h))return new h(l,u);this.min=l,this.max=u,this.ss=new o([],(d,f)=>d.compare(f)),n("Create"),this.clear()}a.prototype.equals=function(l){return this.low===l.low&&this.high===l.high},a.prototype.compare=function(l){return this.low<l.low&&this.high<l.low?-1:l.low<this.low&&l.high<this.low?1:0},h.prototype.firstVacant=function(){return this.ss.size()===0?null:this.ss.front().low},h.prototype.alloc=function(){if(this.ss.size()===0)return n("alloc():empty"),null;const l=this.ss.front(),u=l.low;return u+1<=l.high?++l.low:this.ss.eraseElementByPos(0),n("alloc():"+u),u},h.prototype.use=function(l){const u=new a(l,l),d=this.ss.lowerBound(u);if(d){if(d.equals(u))return this.ss.eraseElementByValue(d),n("use():"+l),!0;if(d.low>l)return!1;if(d.low===l)return++d.low,n("use():"+l),!0;if(d.high===l)return--d.high,n("use():"+l),!0;const f=d.low;return d.low=l+1,this.ss.insert(new a(f,l-1)),n("use():"+l),!0}return n("use():failed"),!1},h.prototype.free=function(l){if(l<this.min||l>this.max)return void c("free():"+l+" is out of range");const u=new a(l,l),d=this.ss.lowerBound(u);if(d){if(d.low<=l&&l<=d.high)return void c("free():"+l+" has already been vacant");if(d===this.ss.front())l+1===d.low?--d.low:this.ss.insert(u);else{const f=this.ss.reverseLowerBound(u);f.high+1===l?l+1===d.low?(this.ss.eraseElementByValue(f),d.low=f.low):f.high=l:l+1===d.low?d.low=l:this.ss.insert(u)}}else{if(d===this.ss.front())return void this.ss.insert(u);const f=this.ss.reverseLowerBound(u);f.high+1===l?f.high=l:this.ss.insert(u)}n("free():"+l)},h.prototype.clear=function(){n("clear()"),this.ss.clear(),this.ss.insert(new a(this.min,this.max))},h.prototype.intervalCount=function(){return this.ss.size()},h.prototype.dump=function(){console.log("length:"+this.ss.size());for(const l of this.ss)console.log(l)},s.exports=h},{debug:18,"js-sdsl":36}],48:[function(i,s,r){var o=i("wrappy");function n(a){var h=function(){return h.called?h.value:(h.called=!0,h.value=a.apply(this,arguments))};return h.called=!1,h}function c(a){var h=function(){if(h.called)throw new Error(h.onceError);return h.called=!0,h.value=a.apply(this,arguments)},l=a.name||"Function wrapped with `once`";return h.onceError=l+" shouldn't be called more than once",h.called=!1,h}s.exports=o(n),s.exports.strict=o(c),n.proto=n(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return n(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return c(this)},configurable:!0})})},{wrappy:79}],49:[function(i,s,r){(function(o){(function(){o===void 0||!o.version||o.version.indexOf("v0.")===0||o.version.indexOf("v1.")===0&&o.version.indexOf("v1.8.")!==0?s.exports={nextTick:function(n,c,a,h){if(typeof n!="function")throw new TypeError('"callback" argument must be a function');var l,u,d=arguments.length;switch(d){case 0:case 1:return o.nextTick(n);case 2:return o.nextTick(function(){n.call(null,c)});case 3:return o.nextTick(function(){n.call(null,c,a)});case 4:return o.nextTick(function(){n.call(null,c,a,h)});default:for(l=new Array(d-1),u=0;u<l.length;)l[u++]=arguments[u];return o.nextTick(function(){n.apply(null,l)})}}}:s.exports=o}).call(this)}).call(this,i("_process"))},{_process:50}],50:[function(i,s,r){var o,n,c=s.exports={};function a(){throw new Error("setTimeout has not been defined")}function h(){throw new Error("clearTimeout has not been defined")}function l(m){if(o===setTimeout)return setTimeout(m,0);if((o===a||!o)&&setTimeout)return o=setTimeout,setTimeout(m,0);try{return o(m,0)}catch{try{return o.call(null,m,0)}catch{return o.call(this,m,0)}}}(function(){try{o=typeof setTimeout=="function"?setTimeout:a}catch{o=a}try{n=typeof clearTimeout=="function"?clearTimeout:h}catch{n=h}})();var u,d=[],f=!1,g=-1;function y(){f&&u&&(f=!1,u.length?d=u.concat(d):g=-1,d.length&&v())}function v(){if(!f){var m=l(y);f=!0;for(var T=d.length;T;){for(u=d,d=[];++g<T;)u&&u[g].run();g=-1,T=d.length}u=null,f=!1,function(I){if(n===clearTimeout)return clearTimeout(I);if((n===h||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(I);try{n(I)}catch{try{return n.call(null,I)}catch{return n.call(this,I)}}}(m)}}function b(m,T){this.fun=m,this.array=T}function x(){}c.nextTick=function(m){var T=new Array(arguments.length-1);if(arguments.length>1)for(var I=1;I<arguments.length;I++)T[I-1]=arguments[I];d.push(new b(m,T)),d.length!==1||f||l(v)},b.prototype.run=function(){this.fun.apply(null,this.array)},c.title="browser",c.browser=!0,c.env={},c.argv=[],c.version="",c.versions={},c.on=x,c.addListener=x,c.once=x,c.off=x,c.removeListener=x,c.removeAllListeners=x,c.emit=x,c.prependListener=x,c.prependOnceListener=x,c.listeners=function(m){return[]},c.binding=function(m){throw new Error("process.binding is not supported")},c.cwd=function(){return"/"},c.chdir=function(m){throw new Error("process.chdir is not supported")},c.umask=function(){return 0}},{}],51:[function(i,s,r){(function(o){(function(){(function(n){var c=typeof r=="object"&&r&&!r.nodeType&&r,a=typeof s=="object"&&s&&!s.nodeType&&s,h=typeof o=="object"&&o;h.global!==h&&h.window!==h&&h.self!==h||(n=h);var l,u,d=2147483647,f=36,g=1,y=26,v=38,b=700,x=72,m=128,T="-",I=/^xn--/,P=/[^\x20-\x7E]/,E=/[\x2E\u3002\uFF0E\uFF61]/g,_={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},W=f-g,Y=Math.floor,C=String.fromCharCode;function k(z){throw new RangeError(_[z])}function R(z,B){for(var U=z.length,$=[];U--;)$[U]=B(z[U]);return $}function S(z,B){var U=z.split("@"),$="";return U.length>1&&($=U[0]+"@",z=U[1]),$+R((z=z.replace(E,".")).split("."),B).join(".")}function N(z){for(var B,U,$=[],q=0,Q=z.length;q<Q;)(B=z.charCodeAt(q++))>=55296&&B<=56319&&q<Q?(64512&(U=z.charCodeAt(q++)))==56320?$.push(((1023&B)<<10)+(1023&U)+65536):($.push(B),q--):$.push(B);return $}function H(z){return R(z,function(B){var U="";return B>65535&&(U+=C((B-=65536)>>>10&1023|55296),B=56320|1023&B),U+=C(B)}).join("")}function K(z,B){return z+22+75*(z<26)-((B!=0)<<5)}function F(z,B,U){var $=0;for(z=U?Y(z/b):z>>1,z+=Y(z/B);z>W*y>>1;$+=f)z=Y(z/W);return Y($+(W+1)*z/(z+v))}function L(z){var B,U,$,q,Q,X,J,p,w,A,M,j=[],V=z.length,G=0,tt=m,Z=x;for((U=z.lastIndexOf(T))<0&&(U=0),$=0;$<U;++$)z.charCodeAt($)>=128&&k("not-basic"),j.push(z.charCodeAt($));for(q=U>0?U+1:0;q<V;){for(Q=G,X=1,J=f;q>=V&&k("invalid-input"),((p=(M=z.charCodeAt(q++))-48<10?M-22:M-65<26?M-65:M-97<26?M-97:f)>=f||p>Y((d-G)/X))&&k("overflow"),G+=p*X,!(p<(w=J<=Z?g:J>=Z+y?y:J-Z));J+=f)X>Y(d/(A=f-w))&&k("overflow"),X*=A;Z=F(G-Q,B=j.length+1,Q==0),Y(G/B)>d-tt&&k("overflow"),tt+=Y(G/B),G%=B,j.splice(G++,0,tt)}return H(j)}function O(z){var B,U,$,q,Q,X,J,p,w,A,M,j,V,G,tt,Z=[];for(j=(z=N(z)).length,B=m,U=0,Q=x,X=0;X<j;++X)(M=z[X])<128&&Z.push(C(M));for($=q=Z.length,q&&Z.push(T);$<j;){for(J=d,X=0;X<j;++X)(M=z[X])>=B&&M<J&&(J=M);for(J-B>Y((d-U)/(V=$+1))&&k("overflow"),U+=(J-B)*V,B=J,X=0;X<j;++X)if((M=z[X])<B&&++U>d&&k("overflow"),M==B){for(p=U,w=f;!(p<(A=w<=Q?g:w>=Q+y?y:w-Q));w+=f)tt=p-A,G=f-A,Z.push(C(K(A+tt%G,0))),p=Y(tt/G);Z.push(C(K(p,0))),Q=F(U,V,$==q),U=0,++$}++U,++B}return Z.join("")}if(l={version:"1.4.1",ucs2:{decode:N,encode:H},decode:L,encode:O,toASCII:function(z){return S(z,function(B){return P.test(B)?"xn--"+O(B):B})},toUnicode:function(z){return S(z,function(B){return I.test(B)?L(B.slice(4).toLowerCase()):B})}},c&&a)if(s.exports==c)a.exports=l;else for(u in l)l.hasOwnProperty(u)&&(c[u]=l[u]);else n.punycode=l})(this)}).call(this)}).call(this,typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{}],52:[function(i,s,r){function o(c,a){return Object.prototype.hasOwnProperty.call(c,a)}s.exports=function(c,a,h,l){a=a||"&",h=h||"=";var u={};if(typeof c!="string"||c.length===0)return u;var d=/\+/g;c=c.split(a);var f=1e3;l&&typeof l.maxKeys=="number"&&(f=l.maxKeys);var g=c.length;f>0&&g>f&&(g=f);for(var y=0;y<g;++y){var v,b,x,m,T=c[y].replace(d,"%20"),I=T.indexOf(h);I>=0?(v=T.substr(0,I),b=T.substr(I+1)):(v=T,b=""),x=decodeURIComponent(v),m=decodeURIComponent(b),o(u,x)?n(u[x])?u[x].push(m):u[x]=[u[x],m]:u[x]=m}return u};var n=Array.isArray||function(c){return Object.prototype.toString.call(c)==="[object Array]"}},{}],53:[function(i,s,r){var o=function(h){switch(typeof h){case"string":return h;case"boolean":return h?"true":"false";case"number":return isFinite(h)?h:"";default:return""}};s.exports=function(h,l,u,d){return l=l||"&",u=u||"=",h===null&&(h=void 0),typeof h=="object"?c(a(h),function(f){var g=encodeURIComponent(o(f))+u;return n(h[f])?c(h[f],function(y){return g+encodeURIComponent(o(y))}).join(l):g+encodeURIComponent(o(h[f]))}).join(l):d?encodeURIComponent(o(d))+u+encodeURIComponent(o(h)):""};var n=Array.isArray||function(h){return Object.prototype.toString.call(h)==="[object Array]"};function c(h,l){if(h.map)return h.map(l);for(var u=[],d=0;d<h.length;d++)u.push(l(h[d],d));return u}var a=Object.keys||function(h){var l=[];for(var u in h)Object.prototype.hasOwnProperty.call(h,u)&&l.push(u);return l}},{}],54:[function(i,s,r){r.decode=r.parse=i("./decode"),r.encode=r.stringify=i("./encode")},{"./decode":52,"./encode":53}],55:[function(i,s,r){var o={};function n(a,h,l){l||(l=Error);var u=function(d){var f,g;function y(v,b,x){return d.call(this,function(m,T,I){return typeof h=="string"?h:h(m,T,I)}(v,b,x))||this}return g=d,(f=y).prototype=Object.create(g.prototype),f.prototype.constructor=f,f.__proto__=g,y}(l);u.prototype.name=l.name,u.prototype.code=a,o[a]=u}function c(a,h){if(Array.isArray(a)){var l=a.length;return a=a.map(function(u){return String(u)}),l>2?"one of ".concat(h," ").concat(a.slice(0,l-1).join(", "),", or ")+a[l-1]:l===2?"one of ".concat(h," ").concat(a[0]," or ").concat(a[1]):"of ".concat(h," ").concat(a[0])}return"of ".concat(h," ").concat(String(a))}n("ERR_INVALID_OPT_VALUE",function(a,h){return'The value "'+h+'" is invalid for option "'+a+'"'},TypeError),n("ERR_INVALID_ARG_TYPE",function(a,h,l){var u,d,f;if(typeof h=="string"&&(d="not ",h.substr(0,d.length)===d)?(u="must not be",h=h.replace(/^not /,"")):u="must be",function(y,v,b){return(b===void 0||b>y.length)&&(b=y.length),y.substring(b-v.length,b)===v}(a," argument"))f="The ".concat(a," ").concat(u," ").concat(c(h,"type"));else{var g=function(y,v,b){return typeof b!="number"&&(b=0),!(b+v.length>y.length)&&y.indexOf(v,b)!==-1}(a,".")?"property":"argument";f='The "'.concat(a,'" ').concat(g," ").concat(u," ").concat(c(h,"type"))}return f+=". Received type ".concat(typeof l)},TypeError),n("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),n("ERR_METHOD_NOT_IMPLEMENTED",function(a){return"The "+a+" method is not implemented"}),n("ERR_STREAM_PREMATURE_CLOSE","Premature close"),n("ERR_STREAM_DESTROYED",function(a){return"Cannot call "+a+" after a stream was destroyed"}),n("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),n("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),n("ERR_STREAM_WRITE_AFTER_END","write after end"),n("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),n("ERR_UNKNOWN_ENCODING",function(a){return"Unknown encoding: "+a},TypeError),n("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),s.exports.codes=o},{}],56:[function(i,s,r){(function(o){(function(){var n=Object.keys||function(y){var v=[];for(var b in y)v.push(b);return v};s.exports=d;var c=i("./_stream_readable"),a=i("./_stream_writable");i("inherits")(d,c);for(var h=n(a.prototype),l=0;l<h.length;l++){var u=h[l];d.prototype[u]||(d.prototype[u]=a.prototype[u])}function d(y){if(!(this instanceof d))return new d(y);c.call(this,y),a.call(this,y),this.allowHalfOpen=!0,y&&(y.readable===!1&&(this.readable=!1),y.writable===!1&&(this.writable=!1),y.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",f)))}function f(){this._writableState.ended||o.nextTick(g,this)}function g(y){y.end()}Object.defineProperty(d.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(d.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(d.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState!==void 0&&this._writableState!==void 0&&this._readableState.destroyed&&this._writableState.destroyed},set:function(y){this._readableState!==void 0&&this._writableState!==void 0&&(this._readableState.destroyed=y,this._writableState.destroyed=y)}})}).call(this)}).call(this,i("_process"))},{"./_stream_readable":58,"./_stream_writable":60,_process:50,inherits:24}],57:[function(i,s,r){s.exports=n;var o=i("./_stream_transform");function n(c){if(!(this instanceof n))return new n(c);o.call(this,c)}i("inherits")(n,o),n.prototype._transform=function(c,a,h){h(null,c)}},{"./_stream_transform":59,inherits:24}],58:[function(i,s,r){(function(o,n){(function(){var c;s.exports=k,k.ReadableState=C,i("events").EventEmitter;var a=function(p,w){return p.listeners(w).length},h=i("./internal/streams/stream"),l=i("buffer").Buffer,u=n.Uint8Array||function(){},d,f=i("util");d=f&&f.debuglog?f.debuglog("stream"):function(){};var g,y,v,b=i("./internal/streams/buffer_list"),x=i("./internal/streams/destroy"),m=i("./internal/streams/state").getHighWaterMark,T=i("../errors").codes,I=T.ERR_INVALID_ARG_TYPE,P=T.ERR_STREAM_PUSH_AFTER_EOF,E=T.ERR_METHOD_NOT_IMPLEMENTED,_=T.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;i("inherits")(k,h);var W=x.errorOrDestroy,Y=["error","close","destroy","pause","resume"];function C(p,w,A){c=c||i("./_stream_duplex"),p=p||{},typeof A!="boolean"&&(A=w instanceof c),this.objectMode=!!p.objectMode,A&&(this.objectMode=this.objectMode||!!p.readableObjectMode),this.highWaterMark=m(this,p,"readableHighWaterMark",A),this.buffer=new b,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=p.emitClose!==!1,this.autoDestroy=!!p.autoDestroy,this.destroyed=!1,this.defaultEncoding=p.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,p.encoding&&(g||(g=i("string_decoder/").StringDecoder),this.decoder=new g(p.encoding),this.encoding=p.encoding)}function k(p){if(c=c||i("./_stream_duplex"),!(this instanceof k))return new k(p);var w=this instanceof c;this._readableState=new C(p,this,w),this.readable=!0,p&&(typeof p.read=="function"&&(this._read=p.read),typeof p.destroy=="function"&&(this._destroy=p.destroy)),h.call(this)}function R(p,w,A,M,j){d("readableAddChunk",w);var V,G=p._readableState;if(w===null)G.reading=!1,function(tt,Z){if(d("onEofChunk"),!Z.ended){if(Z.decoder){var et=Z.decoder.end();et&&et.length&&(Z.buffer.push(et),Z.length+=Z.objectMode?1:et.length)}Z.ended=!0,Z.sync?K(tt):(Z.needReadable=!1,Z.emittedReadable||(Z.emittedReadable=!0,F(tt)))}}(p,G);else if(j||(V=function(tt,Z){var et;it=Z,l.isBuffer(it)||it instanceof u||typeof Z=="string"||Z===void 0||tt.objectMode||(et=new I("chunk",["string","Buffer","Uint8Array"],Z));var it;return et}(G,w)),V)W(p,V);else if(G.objectMode||w&&w.length>0)if(typeof w=="string"||G.objectMode||Object.getPrototypeOf(w)===l.prototype||(w=function(tt){return l.from(tt)}(w)),M)G.endEmitted?W(p,new _):S(p,G,w,!0);else if(G.ended)W(p,new P);else{if(G.destroyed)return!1;G.reading=!1,G.decoder&&!A?(w=G.decoder.write(w),G.objectMode||w.length!==0?S(p,G,w,!1):L(p,G)):S(p,G,w,!1)}else M||(G.reading=!1,L(p,G));return!G.ended&&(G.length<G.highWaterMark||G.length===0)}function S(p,w,A,M){w.flowing&&w.length===0&&!w.sync?(w.awaitDrain=0,p.emit("data",A)):(w.length+=w.objectMode?1:A.length,M?w.buffer.unshift(A):w.buffer.push(A),w.needReadable&&K(p)),L(p,w)}Object.defineProperty(k.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState!==void 0&&this._readableState.destroyed},set:function(p){this._readableState&&(this._readableState.destroyed=p)}}),k.prototype.destroy=x.destroy,k.prototype._undestroy=x.undestroy,k.prototype._destroy=function(p,w){w(p)},k.prototype.push=function(p,w){var A,M=this._readableState;return M.objectMode?A=!0:typeof p=="string"&&((w=w||M.defaultEncoding)!==M.encoding&&(p=l.from(p,w),w=""),A=!0),R(this,p,w,!1,A)},k.prototype.unshift=function(p){return R(this,p,null,!0,!1)},k.prototype.isPaused=function(){return this._readableState.flowing===!1},k.prototype.setEncoding=function(p){g||(g=i("string_decoder/").StringDecoder);var w=new g(p);this._readableState.decoder=w,this._readableState.encoding=this._readableState.decoder.encoding;for(var A=this._readableState.buffer.head,M="";A!==null;)M+=w.write(A.data),A=A.next;return this._readableState.buffer.clear(),M!==""&&this._readableState.buffer.push(M),this._readableState.length=M.length,this};var N=1073741824;function H(p,w){return p<=0||w.length===0&&w.ended?0:w.objectMode?1:p!=p?w.flowing&&w.length?w.buffer.head.data.length:w.length:(p>w.highWaterMark&&(w.highWaterMark=function(A){return A>=N?A=N:(A--,A|=A>>>1,A|=A>>>2,A|=A>>>4,A|=A>>>8,A|=A>>>16,A++),A}(p)),p<=w.length?p:w.ended?w.length:(w.needReadable=!0,0))}function K(p){var w=p._readableState;d("emitReadable",w.needReadable,w.emittedReadable),w.needReadable=!1,w.emittedReadable||(d("emitReadable",w.flowing),w.emittedReadable=!0,o.nextTick(F,p))}function F(p){var w=p._readableState;d("emitReadable_",w.destroyed,w.length,w.ended),w.destroyed||!w.length&&!w.ended||(p.emit("readable"),w.emittedReadable=!1),w.needReadable=!w.flowing&&!w.ended&&w.length<=w.highWaterMark,$(p)}function L(p,w){w.readingMore||(w.readingMore=!0,o.nextTick(O,p,w))}function O(p,w){for(;!w.reading&&!w.ended&&(w.length<w.highWaterMark||w.flowing&&w.length===0);){var A=w.length;if(d("maybeReadMore read 0"),p.read(0),A===w.length)break}w.readingMore=!1}function z(p){var w=p._readableState;w.readableListening=p.listenerCount("readable")>0,w.resumeScheduled&&!w.paused?w.flowing=!0:p.listenerCount("data")>0&&p.resume()}function B(p){d("readable nexttick read 0"),p.read(0)}function U(p,w){d("resume",w.reading),w.reading||p.read(0),w.resumeScheduled=!1,p.emit("resume"),$(p),w.flowing&&!w.reading&&p.read(0)}function $(p){var w=p._readableState;for(d("flow",w.flowing);w.flowing&&p.read()!==null;);}function q(p,w){return w.length===0?null:(w.objectMode?A=w.buffer.shift():!p||p>=w.length?(A=w.decoder?w.buffer.join(""):w.buffer.length===1?w.buffer.first():w.buffer.concat(w.length),w.buffer.clear()):A=w.buffer.consume(p,w.decoder),A);var A}function Q(p){var w=p._readableState;d("endReadable",w.endEmitted),w.endEmitted||(w.ended=!0,o.nextTick(X,w,p))}function X(p,w){if(d("endReadableNT",p.endEmitted,p.length),!p.endEmitted&&p.length===0&&(p.endEmitted=!0,w.readable=!1,w.emit("end"),p.autoDestroy)){var A=w._writableState;(!A||A.autoDestroy&&A.finished)&&w.destroy()}}function J(p,w){for(var A=0,M=p.length;A<M;A++)if(p[A]===w)return A;return-1}k.prototype.read=function(p){d("read",p),p=parseInt(p,10);var w=this._readableState,A=p;if(p!==0&&(w.emittedReadable=!1),p===0&&w.needReadable&&((w.highWaterMark!==0?w.length>=w.highWaterMark:w.length>0)||w.ended))return d("read: emitReadable",w.length,w.ended),w.length===0&&w.ended?Q(this):K(this),null;if((p=H(p,w))===0&&w.ended)return w.length===0&&Q(this),null;var M,j=w.needReadable;return d("need readable",j),(w.length===0||w.length-p<w.highWaterMark)&&d("length less than watermark",j=!0),w.ended||w.reading?d("reading or ended",j=!1):j&&(d("do read"),w.reading=!0,w.sync=!0,w.length===0&&(w.needReadable=!0),this._read(w.highWaterMark),w.sync=!1,w.reading||(p=H(A,w))),(M=p>0?q(p,w):null)===null?(w.needReadable=w.length<=w.highWaterMark,p=0):(w.length-=p,w.awaitDrain=0),w.length===0&&(w.ended||(w.needReadable=!0),A!==p&&w.ended&&Q(this)),M!==null&&this.emit("data",M),M},k.prototype._read=function(p){W(this,new E("_read()"))},k.prototype.pipe=function(p,w){var A=this,M=this._readableState;switch(M.pipesCount){case 0:M.pipes=p;break;case 1:M.pipes=[M.pipes,p];break;default:M.pipes.push(p)}M.pipesCount+=1,d("pipe count=%d opts=%j",M.pipesCount,w);var j=(!w||w.end!==!1)&&p!==o.stdout&&p!==o.stderr?G:at;function V(st,rt){d("onunpipe"),st===A&&rt&&rt.hasUnpiped===!1&&(rt.hasUnpiped=!0,d("cleanup"),p.removeListener("close",nt),p.removeListener("finish",ot),p.removeListener("drain",tt),p.removeListener("error",it),p.removeListener("unpipe",V),A.removeListener("end",G),A.removeListener("end",at),A.removeListener("data",et),Z=!0,!M.awaitDrain||p._writableState&&!p._writableState.needDrain||tt())}function G(){d("onend"),p.end()}M.endEmitted?o.nextTick(j):A.once("end",j),p.on("unpipe",V);var tt=function(st){return function(){var rt=st._readableState;d("pipeOnDrain",rt.awaitDrain),rt.awaitDrain&&rt.awaitDrain--,rt.awaitDrain===0&&a(st,"data")&&(rt.flowing=!0,$(st))}}(A);p.on("drain",tt);var Z=!1;function et(st){d("ondata");var rt=p.write(st);d("dest.write",rt),rt===!1&&((M.pipesCount===1&&M.pipes===p||M.pipesCount>1&&J(M.pipes,p)!==-1)&&!Z&&(d("false write response, pause",M.awaitDrain),M.awaitDrain++),A.pause())}function it(st){d("onerror",st),at(),p.removeListener("error",it),a(p,"error")===0&&W(p,st)}function nt(){p.removeListener("finish",ot),at()}function ot(){d("onfinish"),p.removeListener("close",nt),at()}function at(){d("unpipe"),A.unpipe(p)}return A.on("data",et),function(st,rt,lt){if(typeof st.prependListener=="function")return st.prependListener(rt,lt);st._events&&st._events[rt]?Array.isArray(st._events[rt])?st._events[rt].unshift(lt):st._events[rt]=[lt,st._events[rt]]:st.on(rt,lt)}(p,"error",it),p.once("close",nt),p.once("finish",ot),p.emit("pipe",A),M.flowing||(d("pipe resume"),A.resume()),p},k.prototype.unpipe=function(p){var w=this._readableState,A={hasUnpiped:!1};if(w.pipesCount===0)return this;if(w.pipesCount===1)return p&&p!==w.pipes?this:(p||(p=w.pipes),w.pipes=null,w.pipesCount=0,w.flowing=!1,p&&p.emit("unpipe",this,A),this);if(!p){var M=w.pipes,j=w.pipesCount;w.pipes=null,w.pipesCount=0,w.flowing=!1;for(var V=0;V<j;V++)M[V].emit("unpipe",this,{hasUnpiped:!1});return this}var G=J(w.pipes,p);return G===-1?this:(w.pipes.splice(G,1),w.pipesCount-=1,w.pipesCount===1&&(w.pipes=w.pipes[0]),p.emit("unpipe",this,A),this)},k.prototype.on=function(p,w){var A=h.prototype.on.call(this,p,w),M=this._readableState;return p==="data"?(M.readableListening=this.listenerCount("readable")>0,M.flowing!==!1&&this.resume()):p==="readable"&&(M.endEmitted||M.readableListening||(M.readableListening=M.needReadable=!0,M.flowing=!1,M.emittedReadable=!1,d("on readable",M.length,M.reading),M.length?K(this):M.reading||o.nextTick(B,this))),A},k.prototype.addListener=k.prototype.on,k.prototype.removeListener=function(p,w){var A=h.prototype.removeListener.call(this,p,w);return p==="readable"&&o.nextTick(z,this),A},k.prototype.removeAllListeners=function(p){var w=h.prototype.removeAllListeners.apply(this,arguments);return p!=="readable"&&p!==void 0||o.nextTick(z,this),w},k.prototype.resume=function(){var p=this._readableState;return p.flowing||(d("resume"),p.flowing=!p.readableListening,function(w,A){A.resumeScheduled||(A.resumeScheduled=!0,o.nextTick(U,w,A))}(this,p)),p.paused=!1,this},k.prototype.pause=function(){return d("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(d("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},k.prototype.wrap=function(p){var w=this,A=this._readableState,M=!1;for(var j in p.on("end",function(){if(d("wrapped end"),A.decoder&&!A.ended){var G=A.decoder.end();G&&G.length&&w.push(G)}w.push(null)}),p.on("data",function(G){d("wrapped data"),A.decoder&&(G=A.decoder.write(G)),(!A.objectMode||G!=null)&&(A.objectMode||G&&G.length)&&(w.push(G)||(M=!0,p.pause()))}),p)this[j]===void 0&&typeof p[j]=="function"&&(this[j]=function(G){return function(){return p[G].apply(p,arguments)}}(j));for(var V=0;V<Y.length;V++)p.on(Y[V],this.emit.bind(this,Y[V]));return this._read=function(G){d("wrapped _read",G),M&&(M=!1,p.resume())},this},typeof Symbol=="function"&&(k.prototype[Symbol.asyncIterator]=function(){return y===void 0&&(y=i("./internal/streams/async_iterator")),y(this)}),Object.defineProperty(k.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(k.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(k.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(p){this._readableState&&(this._readableState.flowing=p)}}),k._fromList=q,Object.defineProperty(k.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),typeof Symbol=="function"&&(k.from=function(p,w){return v===void 0&&(v=i("./internal/streams/from")),v(k,p,w)})}).call(this)}).call(this,i("_process"),typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/async_iterator":61,"./internal/streams/buffer_list":62,"./internal/streams/destroy":63,"./internal/streams/from":65,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,events:22,inherits:24,"string_decoder/":75,util:16}],59:[function(i,s,r){s.exports=u;var o=i("../errors").codes,n=o.ERR_METHOD_NOT_IMPLEMENTED,c=o.ERR_MULTIPLE_CALLBACK,a=o.ERR_TRANSFORM_ALREADY_TRANSFORMING,h=o.ERR_TRANSFORM_WITH_LENGTH_0,l=i("./_stream_duplex");function u(g){if(!(this instanceof u))return new u(g);l.call(this,g),this._transformState={afterTransform:(function(y,v){var b=this._transformState;b.transforming=!1;var x=b.writecb;if(x===null)return this.emit("error",new c);b.writechunk=null,b.writecb=null,v!=null&&this.push(v),x(y);var m=this._readableState;m.reading=!1,(m.needReadable||m.length<m.highWaterMark)&&this._read(m.highWaterMark)}).bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,g&&(typeof g.transform=="function"&&(this._transform=g.transform),typeof g.flush=="function"&&(this._flush=g.flush)),this.on("prefinish",d)}function d(){var g=this;typeof this._flush!="function"||this._readableState.destroyed?f(this,null,null):this._flush(function(y,v){f(g,y,v)})}function f(g,y,v){if(y)return g.emit("error",y);if(v!=null&&g.push(v),g._writableState.length)throw new h;if(g._transformState.transforming)throw new a;return g.push(null)}i("inherits")(u,l),u.prototype.push=function(g,y){return this._transformState.needTransform=!1,l.prototype.push.call(this,g,y)},u.prototype._transform=function(g,y,v){v(new n("_transform()"))},u.prototype._write=function(g,y,v){var b=this._transformState;if(b.writecb=v,b.writechunk=g,b.writeencoding=y,!b.transforming){var x=this._readableState;(b.needTransform||x.needReadable||x.length<x.highWaterMark)&&this._read(x.highWaterMark)}},u.prototype._read=function(g){var y=this._transformState;y.writechunk===null||y.transforming?y.needTransform=!0:(y.transforming=!0,this._transform(y.writechunk,y.writeencoding,y.afterTransform))},u.prototype._destroy=function(g,y){l.prototype._destroy.call(this,g,function(v){y(v)})}},{"../errors":55,"./_stream_duplex":56,inherits:24}],60:[function(i,s,r){(function(o,n){(function(){function c(L){var O=this;this.next=null,this.entry=null,this.finish=function(){(function(z,B,U){var $=z.entry;for(z.entry=null;$;){var q=$.callback;B.pendingcb--,q(U),$=$.next}B.corkedRequestsFree.next=z})(O,L)}}var a;s.exports=k,k.WritableState=C;var h={deprecate:i("util-deprecate")},l=i("./internal/streams/stream"),u=i("buffer").Buffer,d=n.Uint8Array||function(){},f,g=i("./internal/streams/destroy"),y=i("./internal/streams/state").getHighWaterMark,v=i("../errors").codes,b=v.ERR_INVALID_ARG_TYPE,x=v.ERR_METHOD_NOT_IMPLEMENTED,m=v.ERR_MULTIPLE_CALLBACK,T=v.ERR_STREAM_CANNOT_PIPE,I=v.ERR_STREAM_DESTROYED,P=v.ERR_STREAM_NULL_VALUES,E=v.ERR_STREAM_WRITE_AFTER_END,_=v.ERR_UNKNOWN_ENCODING,W=g.errorOrDestroy;function Y(){}function C(L,O,z){a=a||i("./_stream_duplex"),L=L||{},typeof z!="boolean"&&(z=O instanceof a),this.objectMode=!!L.objectMode,z&&(this.objectMode=this.objectMode||!!L.writableObjectMode),this.highWaterMark=y(this,L,"writableHighWaterMark",z),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var B=L.decodeStrings===!1;this.decodeStrings=!B,this.defaultEncoding=L.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(U){(function($,q){var Q=$._writableState,X=Q.sync,J=Q.writecb;if(typeof J!="function")throw new m;if(function(w){w.writing=!1,w.writecb=null,w.length-=w.writelen,w.writelen=0}(Q),q)(function(w,A,M,j,V){--A.pendingcb,M?(o.nextTick(V,j),o.nextTick(F,w,A),w._writableState.errorEmitted=!0,W(w,j)):(V(j),w._writableState.errorEmitted=!0,W(w,j),F(w,A))})($,Q,X,q,J);else{var p=H(Q)||$.destroyed;p||Q.corked||Q.bufferProcessing||!Q.bufferedRequest||N($,Q),X?o.nextTick(S,$,Q,p,J):S($,Q,p,J)}})(O,U)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=L.emitClose!==!1,this.autoDestroy=!!L.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new c(this)}function k(L){var O=this instanceof(a=a||i("./_stream_duplex"));if(!O&&!f.call(k,this))return new k(L);this._writableState=new C(L,this,O),this.writable=!0,L&&(typeof L.write=="function"&&(this._write=L.write),typeof L.writev=="function"&&(this._writev=L.writev),typeof L.destroy=="function"&&(this._destroy=L.destroy),typeof L.final=="function"&&(this._final=L.final)),l.call(this)}function R(L,O,z,B,U,$,q){O.writelen=B,O.writecb=q,O.writing=!0,O.sync=!0,O.destroyed?O.onwrite(new I("write")):z?L._writev(U,O.onwrite):L._write(U,$,O.onwrite),O.sync=!1}function S(L,O,z,B){z||function(U,$){$.length===0&&$.needDrain&&($.needDrain=!1,U.emit("drain"))}(L,O),O.pendingcb--,B(),F(L,O)}function N(L,O){O.bufferProcessing=!0;var z=O.bufferedRequest;if(L._writev&&z&&z.next){var B=O.bufferedRequestCount,U=new Array(B),$=O.corkedRequestsFree;$.entry=z;for(var q=0,Q=!0;z;)U[q]=z,z.isBuf||(Q=!1),z=z.next,q+=1;U.allBuffers=Q,R(L,O,!0,O.length,U,"",$.finish),O.pendingcb++,O.lastBufferedRequest=null,$.next?(O.corkedRequestsFree=$.next,$.next=null):O.corkedRequestsFree=new c(O),O.bufferedRequestCount=0}else{for(;z;){var X=z.chunk,J=z.encoding,p=z.callback;if(R(L,O,!1,O.objectMode?1:X.length,X,J,p),z=z.next,O.bufferedRequestCount--,O.writing)break}z===null&&(O.lastBufferedRequest=null)}O.bufferedRequest=z,O.bufferProcessing=!1}function H(L){return L.ending&&L.length===0&&L.bufferedRequest===null&&!L.finished&&!L.writing}function K(L,O){L._final(function(z){O.pendingcb--,z&&W(L,z),O.prefinished=!0,L.emit("prefinish"),F(L,O)})}function F(L,O){var z=H(O);if(z&&(function(U,$){$.prefinished||$.finalCalled||(typeof U._final!="function"||$.destroyed?($.prefinished=!0,U.emit("prefinish")):($.pendingcb++,$.finalCalled=!0,o.nextTick(K,U,$)))}(L,O),O.pendingcb===0&&(O.finished=!0,L.emit("finish"),O.autoDestroy))){var B=L._readableState;(!B||B.autoDestroy&&B.endEmitted)&&L.destroy()}return z}i("inherits")(k,l),C.prototype.getBuffer=function(){for(var L=this.bufferedRequest,O=[];L;)O.push(L),L=L.next;return O},function(){try{Object.defineProperty(C.prototype,"buffer",{get:h.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}}(),typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(f=Function.prototype[Symbol.hasInstance],Object.defineProperty(k,Symbol.hasInstance,{value:function(L){return!!f.call(this,L)||this===k&&L&&L._writableState instanceof C}})):f=function(L){return L instanceof this},k.prototype.pipe=function(){W(this,new T)},k.prototype.write=function(L,O,z){var B,U=this._writableState,$=!1,q=!U.objectMode&&(B=L,u.isBuffer(B)||B instanceof d);return q&&!u.isBuffer(L)&&(L=function(Q){return u.from(Q)}(L)),typeof O=="function"&&(z=O,O=null),q?O="buffer":O||(O=U.defaultEncoding),typeof z!="function"&&(z=Y),U.ending?function(Q,X){var J=new E;W(Q,J),o.nextTick(X,J)}(this,z):(q||function(Q,X,J,p){var w;return J===null?w=new P:typeof J=="string"||X.objectMode||(w=new b("chunk",["string","Buffer"],J)),!w||(W(Q,w),o.nextTick(p,w),!1)}(this,U,L,z))&&(U.pendingcb++,$=function(Q,X,J,p,w,A){if(!J){var M=function(tt,Z,et){return tt.objectMode||tt.decodeStrings===!1||typeof Z!="string"||(Z=u.from(Z,et)),Z}(X,p,w);p!==M&&(J=!0,w="buffer",p=M)}var j=X.objectMode?1:p.length;X.length+=j;var V=X.length<X.highWaterMark;if(V||(X.needDrain=!0),X.writing||X.corked){var G=X.lastBufferedRequest;X.lastBufferedRequest={chunk:p,encoding:w,isBuf:J,callback:A,next:null},G?G.next=X.lastBufferedRequest:X.bufferedRequest=X.lastBufferedRequest,X.bufferedRequestCount+=1}else R(Q,X,!1,j,p,w,A);return V}(this,U,q,L,O,z)),$},k.prototype.cork=function(){this._writableState.corked++},k.prototype.uncork=function(){var L=this._writableState;L.corked&&(L.corked--,L.writing||L.corked||L.bufferProcessing||!L.bufferedRequest||N(this,L))},k.prototype.setDefaultEncoding=function(L){if(typeof L=="string"&&(L=L.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((L+"").toLowerCase())>-1))throw new _(L);return this._writableState.defaultEncoding=L,this},Object.defineProperty(k.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(k.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),k.prototype._write=function(L,O,z){z(new x("_write()"))},k.prototype._writev=null,k.prototype.end=function(L,O,z){var B=this._writableState;return typeof L=="function"?(z=L,L=null,O=null):typeof O=="function"&&(z=O,O=null),L!=null&&this.write(L,O),B.corked&&(B.corked=1,this.uncork()),B.ending||function(U,$,q){$.ending=!0,F(U,$),q&&($.finished?o.nextTick(q):U.once("finish",q)),$.ended=!0,U.writable=!1}(this,B,z),this},Object.defineProperty(k.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(k.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState!==void 0&&this._writableState.destroyed},set:function(L){this._writableState&&(this._writableState.destroyed=L)}}),k.prototype.destroy=g.destroy,k.prototype._undestroy=g.undestroy,k.prototype._destroy=function(L,O){O(L)}}).call(this)}).call(this,i("_process"),typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/destroy":63,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,inherits:24,"util-deprecate":78}],61:[function(i,s,r){(function(o){(function(){var n;function c(T,I,P){return I in T?Object.defineProperty(T,I,{value:P,enumerable:!0,configurable:!0,writable:!0}):T[I]=P,T}var a=i("./end-of-stream"),h=Symbol("lastResolve"),l=Symbol("lastReject"),u=Symbol("error"),d=Symbol("ended"),f=Symbol("lastPromise"),g=Symbol("handlePromise"),y=Symbol("stream");function v(T,I){return{value:T,done:I}}function b(T){var I=T[h];if(I!==null){var P=T[y].read();P!==null&&(T[f]=null,T[h]=null,T[l]=null,I(v(P,!1)))}}var x=Object.getPrototypeOf(function(){}),m=Object.setPrototypeOf((c(n={get stream(){return this[y]},next:function(){var T=this,I=this[u];if(I!==null)return Promise.reject(I);if(this[d])return Promise.resolve(v(void 0,!0));if(this[y].destroyed)return new Promise(function(W,Y){o.nextTick(function(){T[u]?Y(T[u]):W(v(void 0,!0))})});var P,E=this[f];if(E)P=new Promise(function(W,Y){return function(C,k){W.then(function(){Y[d]?C(v(void 0,!0)):Y[g](C,k)},k)}}(E,this));else{var _=this[y].read();if(_!==null)return Promise.resolve(v(_,!1));P=new Promise(this[g])}return this[f]=P,P}},Symbol.asyncIterator,function(){return this}),c(n,"return",function(){var T=this;return new Promise(function(I,P){T[y].destroy(null,function(E){E?P(E):I(v(void 0,!0))})})}),n),x);s.exports=function(T){var I,P=Object.create(m,(c(I={},y,{value:T,writable:!0}),c(I,h,{value:null,writable:!0}),c(I,l,{value:null,writable:!0}),c(I,u,{value:null,writable:!0}),c(I,d,{value:T._readableState.endEmitted,writable:!0}),c(I,g,{value:function(E,_){var W=P[y].read();W?(P[f]=null,P[h]=null,P[l]=null,E(v(W,!1))):(P[h]=E,P[l]=_)},writable:!0}),I));return P[f]=null,a(T,function(E){if(E&&E.code!=="ERR_STREAM_PREMATURE_CLOSE"){var _=P[l];return _!==null&&(P[f]=null,P[h]=null,P[l]=null,_(E)),void(P[u]=E)}var W=P[h];W!==null&&(P[f]=null,P[h]=null,P[l]=null,W(v(void 0,!0))),P[d]=!0}),T.on("readable",(function(E){o.nextTick(b,E)}).bind(null,P)),P}}).call(this)}).call(this,i("_process"))},{"./end-of-stream":64,_process:50}],62:[function(i,s,r){function o(u,d){var f=Object.keys(u);if(Object.getOwnPropertySymbols){var g=Object.getOwnPropertySymbols(u);d&&(g=g.filter(function(y){return Object.getOwnPropertyDescriptor(u,y).enumerable})),f.push.apply(f,g)}return f}function n(u,d,f){return d in u?Object.defineProperty(u,d,{value:f,enumerable:!0,configurable:!0,writable:!0}):u[d]=f,u}function c(u,d){for(var f=0;f<d.length;f++){var g=d[f];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(u,g.key,g)}}var a=i("buffer").Buffer,h=i("util").inspect,l=h&&h.custom||"inspect";s.exports=function(){function u(){(function(g,y){if(!(g instanceof y))throw new TypeError("Cannot call a class as a function")})(this,u),this.head=null,this.tail=null,this.length=0}var d,f;return d=u,(f=[{key:"push",value:function(g){var y={data:g,next:null};this.length>0?this.tail.next=y:this.head=y,this.tail=y,++this.length}},{key:"unshift",value:function(g){var y={data:g,next:this.head};this.length===0&&(this.tail=y),this.head=y,++this.length}},{key:"shift",value:function(){if(this.length!==0){var g=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,g}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(g){if(this.length===0)return"";for(var y=this.head,v=""+y.data;y=y.next;)v+=g+y.data;return v}},{key:"concat",value:function(g){if(this.length===0)return a.alloc(0);for(var y,v,b,x=a.allocUnsafe(g>>>0),m=this.head,T=0;m;)y=m.data,v=x,b=T,a.prototype.copy.call(y,v,b),T+=m.data.length,m=m.next;return x}},{key:"consume",value:function(g,y){var v;return g<this.head.data.length?(v=this.head.data.slice(0,g),this.head.data=this.head.data.slice(g)):v=g===this.head.data.length?this.shift():y?this._getString(g):this._getBuffer(g),v}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(g){var y=this.head,v=1,b=y.data;for(g-=b.length;y=y.next;){var x=y.data,m=g>x.length?x.length:g;if(m===x.length?b+=x:b+=x.slice(0,g),(g-=m)===0){m===x.length?(++v,y.next?this.head=y.next:this.head=this.tail=null):(this.head=y,y.data=x.slice(m));break}++v}return this.length-=v,b}},{key:"_getBuffer",value:function(g){var y=a.allocUnsafe(g),v=this.head,b=1;for(v.data.copy(y),g-=v.data.length;v=v.next;){var x=v.data,m=g>x.length?x.length:g;if(x.copy(y,y.length-g,0,m),(g-=m)===0){m===x.length?(++b,v.next?this.head=v.next:this.head=this.tail=null):(this.head=v,v.data=x.slice(m));break}++b}return this.length-=b,y}},{key:l,value:function(g,y){return h(this,function(v){for(var b=1;b<arguments.length;b++){var x=arguments[b]!=null?arguments[b]:{};b%2?o(Object(x),!0).forEach(function(m){n(v,m,x[m])}):Object.getOwnPropertyDescriptors?Object.defineProperties(v,Object.getOwnPropertyDescriptors(x)):o(Object(x)).forEach(function(m){Object.defineProperty(v,m,Object.getOwnPropertyDescriptor(x,m))})}return v}({},y,{depth:0,customInspect:!1}))}}])&&c(d.prototype,f),u}()},{buffer:17,util:16}],63:[function(i,s,r){(function(o){(function(){function n(h,l){a(h,l),c(h)}function c(h){h._writableState&&!h._writableState.emitClose||h._readableState&&!h._readableState.emitClose||h.emit("close")}function a(h,l){h.emit("error",l)}s.exports={destroy:function(h,l){var u=this,d=this._readableState&&this._readableState.destroyed,f=this._writableState&&this._writableState.destroyed;return d||f?(l?l(h):h&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,o.nextTick(a,this,h)):o.nextTick(a,this,h)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(h||null,function(g){!l&&g?u._writableState?u._writableState.errorEmitted?o.nextTick(c,u):(u._writableState.errorEmitted=!0,o.nextTick(n,u,g)):o.nextTick(n,u,g):l?(o.nextTick(c,u),l(g)):o.nextTick(c,u)}),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(h,l){var u=h._readableState,d=h._writableState;u&&u.autoDestroy||d&&d.autoDestroy?h.destroy(l):h.emit("error",l)}}}).call(this)}).call(this,i("_process"))},{_process:50}],64:[function(i,s,r){var o=i("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function n(){}s.exports=function c(a,h,l){if(typeof h=="function")return c(a,null,h);h||(h={}),l=function(I){var P=!1;return function(){if(!P){P=!0;for(var E=arguments.length,_=new Array(E),W=0;W<E;W++)_[W]=arguments[W];I.apply(this,_)}}}(l||n);var u=h.readable||h.readable!==!1&&a.readable,d=h.writable||h.writable!==!1&&a.writable,f=function(){a.writable||y()},g=a._writableState&&a._writableState.finished,y=function(){d=!1,g=!0,u||l.call(a)},v=a._readableState&&a._readableState.endEmitted,b=function(){u=!1,v=!0,d||l.call(a)},x=function(I){l.call(a,I)},m=function(){var I;return u&&!v?(a._readableState&&a._readableState.ended||(I=new o),l.call(a,I)):d&&!g?(a._writableState&&a._writableState.ended||(I=new o),l.call(a,I)):void 0},T=function(){a.req.on("finish",y)};return function(I){return I.setHeader&&typeof I.abort=="function"}(a)?(a.on("complete",y),a.on("abort",m),a.req?T():a.on("request",T)):d&&!a._writableState&&(a.on("end",f),a.on("close",f)),a.on("end",b),a.on("finish",y),h.error!==!1&&a.on("error",x),a.on("close",m),function(){a.removeListener("complete",y),a.removeListener("abort",m),a.removeListener("request",T),a.req&&a.req.removeListener("finish",y),a.removeListener("end",f),a.removeListener("close",f),a.removeListener("finish",y),a.removeListener("end",b),a.removeListener("error",x),a.removeListener("close",m)}}},{"../../../errors":55}],65:[function(i,s,r){s.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],66:[function(i,s,r){var o,n=i("../../../errors").codes,c=n.ERR_MISSING_ARGS,a=n.ERR_STREAM_DESTROYED;function h(d){if(d)throw d}function l(d){d()}function u(d,f){return d.pipe(f)}s.exports=function(){for(var d=arguments.length,f=new Array(d),g=0;g<d;g++)f[g]=arguments[g];var y,v=function(x){return x.length?typeof x[x.length-1]!="function"?h:x.pop():h}(f);if(Array.isArray(f[0])&&(f=f[0]),f.length<2)throw new c("streams");var b=f.map(function(x,m){var T=m<f.length-1;return function(I,P,E,_){_=function(C){var k=!1;return function(){k||(k=!0,C.apply(void 0,arguments))}}(_);var W=!1;I.on("close",function(){W=!0}),o===void 0&&(o=i("./end-of-stream")),o(I,{readable:P,writable:E},function(C){if(C)return _(C);W=!0,_()});var Y=!1;return function(C){if(!W&&!Y)return Y=!0,function(k){return k.setHeader&&typeof k.abort=="function"}(I)?I.abort():typeof I.destroy=="function"?I.destroy():void _(C||new a("pipe"))}}(x,T,m>0,function(I){y||(y=I),I&&b.forEach(l),T||(b.forEach(l),v(y))})});return f.reduce(u)}},{"../../../errors":55,"./end-of-stream":64}],67:[function(i,s,r){var o=i("../../../errors").codes.ERR_INVALID_OPT_VALUE;s.exports={getHighWaterMark:function(n,c,a,h){var l=function(u,d,f){return u.highWaterMark!=null?u.highWaterMark:d?u[f]:null}(c,h,a);if(l!=null){if(!isFinite(l)||Math.floor(l)!==l||l<0)throw new o(h?a:"highWaterMark",l);return Math.floor(l)}return n.objectMode?16:16384}}},{"../../../errors":55}],68:[function(i,s,r){s.exports=i("events").EventEmitter},{events:22}],69:[function(i,s,r){(r=s.exports=i("./lib/_stream_readable.js")).Stream=r,r.Readable=r,r.Writable=i("./lib/_stream_writable.js"),r.Duplex=i("./lib/_stream_duplex.js"),r.Transform=i("./lib/_stream_transform.js"),r.PassThrough=i("./lib/_stream_passthrough.js"),r.finished=i("./lib/internal/streams/end-of-stream.js"),r.pipeline=i("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":56,"./lib/_stream_passthrough.js":57,"./lib/_stream_readable.js":58,"./lib/_stream_transform.js":59,"./lib/_stream_writable.js":60,"./lib/internal/streams/end-of-stream.js":64,"./lib/internal/streams/pipeline.js":66}],70:[function(i,s,r){s.exports=function(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("interval needed");var o;if(arguments.length>0){o=new Array(arguments.length-2);for(var n=0;n<o.length;n++)o[n]=arguments[n+2]}return new function(c,a,h){var l=this;this._callback=c,this._args=h,this._interval=setInterval(c,a,this._args),this.reschedule=function(u){u||(u=l._interval),l._interval&&clearInterval(l._interval),l._interval=setInterval(l._callback,u,l._args)},this.clear=function(){l._interval&&(clearInterval(l._interval),l._interval=void 0)},this.destroy=function(){l._interval&&clearInterval(l._interval),l._callback=void 0,l._interval=void 0,l._args=void 0}}(arguments[0],arguments[1],o)}},{}],71:[function(i,s,r){s.exports=i("./index.js")()},{"./index.js":72}],72:[function(i,s,r){(function(o){(function(){function n(c){return c instanceof o?o.from(c):new c.constructor(c.buffer.slice(),c.byteOffset,c.length)}s.exports=function(c){return(c=c||{}).circles?function(h){var l=[],u=[];return h.proto?function f(g){if(typeof g!="object"||g===null)return g;if(g instanceof Date)return new Date(g);if(Array.isArray(g))return d(g,f);if(g instanceof Map)return new Map(d(Array.from(g),f));if(g instanceof Set)return new Set(d(Array.from(g),f));var y={};for(var v in l.push(g),u.push(y),g){var b=g[v];if(typeof b!="object"||b===null)y[v]=b;else if(b instanceof Date)y[v]=new Date(b);else if(b instanceof Map)y[v]=new Map(d(Array.from(b),f));else if(b instanceof Set)y[v]=new Set(d(Array.from(b),f));else if(ArrayBuffer.isView(b))y[v]=n(b);else{var x=l.indexOf(b);y[v]=x!==-1?u[x]:f(b)}}return l.pop(),u.pop(),y}:function f(g){if(typeof g!="object"||g===null)return g;if(g instanceof Date)return new Date(g);if(Array.isArray(g))return d(g,f);if(g instanceof Map)return new Map(d(Array.from(g),f));if(g instanceof Set)return new Set(d(Array.from(g),f));var y={};for(var v in l.push(g),u.push(y),g)if(Object.hasOwnProperty.call(g,v)!==!1){var b=g[v];if(typeof b!="object"||b===null)y[v]=b;else if(b instanceof Date)y[v]=new Date(b);else if(b instanceof Map)y[v]=new Map(d(Array.from(b),f));else if(b instanceof Set)y[v]=new Set(d(Array.from(b),f));else if(ArrayBuffer.isView(b))y[v]=n(b);else{var x=l.indexOf(b);y[v]=x!==-1?u[x]:f(b)}}return l.pop(),u.pop(),y};function d(f,g){for(var y=Object.keys(f),v=new Array(y.length),b=0;b<y.length;b++){var x=y[b],m=f[x];if(typeof m!="object"||m===null)v[x]=m;else if(m instanceof Date)v[x]=new Date(m);else if(ArrayBuffer.isView(m))v[x]=n(m);else{var T=l.indexOf(m);v[x]=T!==-1?u[T]:g(m)}}return v}}(c):c.proto?function h(l){if(typeof l!="object"||l===null)return l;if(l instanceof Date)return new Date(l);if(Array.isArray(l))return a(l,h);if(l instanceof Map)return new Map(a(Array.from(l),h));if(l instanceof Set)return new Set(a(Array.from(l),h));var u={};for(var d in l){var f=l[d];typeof f!="object"||f===null?u[d]=f:f instanceof Date?u[d]=new Date(f):f instanceof Map?u[d]=new Map(a(Array.from(f),h)):f instanceof Set?u[d]=new Set(a(Array.from(f),h)):ArrayBuffer.isView(f)?u[d]=n(f):u[d]=h(f)}return u}:function h(l){if(typeof l!="object"||l===null)return l;if(l instanceof Date)return new Date(l);if(Array.isArray(l))return a(l,h);if(l instanceof Map)return new Map(a(Array.from(l),h));if(l instanceof Set)return new Set(a(Array.from(l),h));var u={};for(var d in l)if(Object.hasOwnProperty.call(l,d)!==!1){var f=l[d];typeof f!="object"||f===null?u[d]=f:f instanceof Date?u[d]=new Date(f):f instanceof Map?u[d]=new Map(a(Array.from(f),h)):f instanceof Set?u[d]=new Set(a(Array.from(f),h)):ArrayBuffer.isView(f)?u[d]=n(f):u[d]=h(f)}return u};function a(h,l){for(var u=Object.keys(h),d=new Array(u.length),f=0;f<u.length;f++){var g=u[f],y=h[g];typeof y!="object"||y===null?d[g]=y:y instanceof Date?d[g]=new Date(y):ArrayBuffer.isView(y)?d[g]=n(y):d[g]=l(y)}return d}}}).call(this)}).call(this,i("buffer").Buffer)},{buffer:17}],73:[function(i,s,r){var o=i("buffer"),n=o.Buffer;function c(h,l){for(var u in h)l[u]=h[u]}function a(h,l,u){return n(h,l,u)}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?s.exports=o:(c(o,r),r.Buffer=a),a.prototype=Object.create(n.prototype),c(n,a),a.from=function(h,l,u){if(typeof h=="number")throw new TypeError("Argument must not be a number");return n(h,l,u)},a.alloc=function(h,l,u){if(typeof h!="number")throw new TypeError("Argument must be a number");var d=n(h);return l!==void 0?typeof u=="string"?d.fill(l,u):d.fill(l):d.fill(0),d},a.allocUnsafe=function(h){if(typeof h!="number")throw new TypeError("Argument must be a number");return n(h)},a.allocUnsafeSlow=function(h){if(typeof h!="number")throw new TypeError("Argument must be a number");return o.SlowBuffer(h)}},{buffer:17}],74:[function(i,s,r){s.exports=function(o){var n=o._readableState;return n?n.objectMode||typeof o._duplexState=="number"?o.read():o.read((c=n,c.buffer.length?c.buffer.head?c.buffer.head.data.length:c.buffer[0].length:c.length)):null;var c}},{}],75:[function(i,s,r){var o=i("safe-buffer").Buffer,n=o.isEncoding||function(v){switch((v=""+v)&&v.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function c(v){var b;switch(this.encoding=function(x){var m=function(T){if(!T)return"utf8";for(var I;;)switch(T){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return T;default:if(I)return;T=(""+T).toLowerCase(),I=!0}}(x);if(typeof m!="string"&&(o.isEncoding===n||!n(x)))throw new Error("Unknown encoding: "+x);return m||x}(v),this.encoding){case"utf16le":this.text=l,this.end=u,b=4;break;case"utf8":this.fillLast=h,b=4;break;case"base64":this.text=d,this.end=f,b=3;break;default:return this.write=g,void(this.end=y)}this.lastNeed=0,this.lastTotal=0,this.lastChar=o.allocUnsafe(b)}function a(v){return v<=127?0:v>>5==6?2:v>>4==14?3:v>>3==30?4:v>>6==2?-1:-2}function h(v){var b=this.lastTotal-this.lastNeed,x=function(m,T,I){if((192&T[0])!=128)return m.lastNeed=0,"";if(m.lastNeed>1&&T.length>1){if((192&T[1])!=128)return m.lastNeed=1,"";if(m.lastNeed>2&&T.length>2&&(192&T[2])!=128)return m.lastNeed=2,""}}(this,v);return x!==void 0?x:this.lastNeed<=v.length?(v.copy(this.lastChar,b,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(v.copy(this.lastChar,b,0,v.length),void(this.lastNeed-=v.length))}function l(v,b){if((v.length-b)%2==0){var x=v.toString("utf16le",b);if(x){var m=x.charCodeAt(x.length-1);if(m>=55296&&m<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=v[v.length-2],this.lastChar[1]=v[v.length-1],x.slice(0,-1)}return x}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=v[v.length-1],v.toString("utf16le",b,v.length-1)}function u(v){var b=v&&v.length?this.write(v):"";if(this.lastNeed){var x=this.lastTotal-this.lastNeed;return b+this.lastChar.toString("utf16le",0,x)}return b}function d(v,b){var x=(v.length-b)%3;return x===0?v.toString("base64",b):(this.lastNeed=3-x,this.lastTotal=3,x===1?this.lastChar[0]=v[v.length-1]:(this.lastChar[0]=v[v.length-2],this.lastChar[1]=v[v.length-1]),v.toString("base64",b,v.length-x))}function f(v){var b=v&&v.length?this.write(v):"";return this.lastNeed?b+this.lastChar.toString("base64",0,3-this.lastNeed):b}function g(v){return v.toString(this.encoding)}function y(v){return v&&v.length?this.write(v):""}r.StringDecoder=c,c.prototype.write=function(v){if(v.length===0)return"";var b,x;if(this.lastNeed){if((b=this.fillLast(v))===void 0)return"";x=this.lastNeed,this.lastNeed=0}else x=0;return x<v.length?b?b+this.text(v,x):this.text(v,x):b||""},c.prototype.end=function(v){var b=v&&v.length?this.write(v):"";return this.lastNeed?b+"":b},c.prototype.text=function(v,b){var x=function(T,I,P){var E=I.length-1;if(E<P)return 0;var _=a(I[E]);return _>=0?(_>0&&(T.lastNeed=_-1),_):--E<P||_===-2?0:(_=a(I[E]))>=0?(_>0&&(T.lastNeed=_-2),_):--E<P||_===-2?0:(_=a(I[E]))>=0?(_>0&&(_===2?_=0:T.lastNeed=_-3),_):0}(this,v,b);if(!this.lastNeed)return v.toString("utf8",b);this.lastTotal=x;var m=v.length-(x-this.lastNeed);return v.copy(this.lastChar,0,m),v.toString("utf8",b,m)},c.prototype.fillLast=function(v){if(this.lastNeed<=v.length)return v.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);v.copy(this.lastChar,this.lastTotal-this.lastNeed,0,v.length),this.lastNeed-=v.length}},{"safe-buffer":73}],76:[function(i,s,r){var o=i("punycode"),n=i("./util");function c(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}r.parse=I,r.resolve=function(P,E){return I(P,!1,!0).resolve(E)},r.resolveObject=function(P,E){return P?I(P,!1,!0).resolveObject(E):E},r.format=function(P){return n.isString(P)&&(P=I(P)),P instanceof c?P.format():c.prototype.format.call(P)},r.Url=c;var a=/^([a-z0-9.+-]+:)/i,h=/:[0-9]*$/,l=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,u=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r",`
`,"	"]),d=["'"].concat(u),f=["%","/","?",";","#"].concat(d),g=["/","?","#"],y=/^[+a-z0-9A-Z_-]{0,63}$/,v=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,b={javascript:!0,"javascript:":!0},x={javascript:!0,"javascript:":!0},m={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},T=i("querystring");function I(P,E,_){if(P&&n.isObject(P)&&P instanceof c)return P;var W=new c;return W.parse(P,E,_),W}c.prototype.parse=function(P,E,_){if(!n.isString(P))throw new TypeError("Parameter 'url' must be a string, not "+typeof P);var W=P.indexOf("?"),Y=W!==-1&&W<P.indexOf("#")?"?":"#",C=P.split(Y);C[0]=C[0].replace(/\\/g,"/");var k=P=C.join(Y);if(k=k.trim(),!_&&P.split("#").length===1){var R=l.exec(k);if(R)return this.path=k,this.href=k,this.pathname=R[1],R[2]?(this.search=R[2],this.query=E?T.parse(this.search.substr(1)):this.search.substr(1)):E&&(this.search="",this.query={}),this}var S=a.exec(k);if(S){var N=(S=S[0]).toLowerCase();this.protocol=N,k=k.substr(S.length)}if(_||S||k.match(/^\/\/[^@\/]+@[^@\/]+/)){var H=k.substr(0,2)==="//";!H||S&&x[S]||(k=k.substr(2),this.slashes=!0)}if(!x[S]&&(H||S&&!m[S])){for(var K,F,L=-1,O=0;O<g.length;O++)(z=k.indexOf(g[O]))!==-1&&(L===-1||z<L)&&(L=z);for((F=L===-1?k.lastIndexOf("@"):k.lastIndexOf("@",L))!==-1&&(K=k.slice(0,F),k=k.slice(F+1),this.auth=decodeURIComponent(K)),L=-1,O=0;O<f.length;O++){var z;(z=k.indexOf(f[O]))!==-1&&(L===-1||z<L)&&(L=z)}L===-1&&(L=k.length),this.host=k.slice(0,L),k=k.slice(L),this.parseHost(),this.hostname=this.hostname||"";var B=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!B)for(var U=this.hostname.split(/\./),$=(O=0,U.length);O<$;O++){var q=U[O];if(q&&!q.match(y)){for(var Q="",X=0,J=q.length;X<J;X++)q.charCodeAt(X)>127?Q+="x":Q+=q[X];if(!Q.match(y)){var p=U.slice(0,O),w=U.slice(O+1),A=q.match(v);A&&(p.push(A[1]),w.unshift(A[2])),w.length&&(k="/"+w.join(".")+k),this.hostname=p.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),B||(this.hostname=o.toASCII(this.hostname));var M=this.port?":"+this.port:"",j=this.hostname||"";this.host=j+M,this.href+=this.host,B&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),k[0]!=="/"&&(k="/"+k))}if(!b[N])for(O=0,$=d.length;O<$;O++){var V=d[O];if(k.indexOf(V)!==-1){var G=encodeURIComponent(V);G===V&&(G=escape(V)),k=k.split(V).join(G)}}var tt=k.indexOf("#");tt!==-1&&(this.hash=k.substr(tt),k=k.slice(0,tt));var Z=k.indexOf("?");if(Z!==-1?(this.search=k.substr(Z),this.query=k.substr(Z+1),E&&(this.query=T.parse(this.query)),k=k.slice(0,Z)):E&&(this.search="",this.query={}),k&&(this.pathname=k),m[N]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){M=this.pathname||"";var et=this.search||"";this.path=M+et}return this.href=this.format(),this},c.prototype.format=function(){var P=this.auth||"";P&&(P=(P=encodeURIComponent(P)).replace(/%3A/i,":"),P+="@");var E=this.protocol||"",_=this.pathname||"",W=this.hash||"",Y=!1,C="";this.host?Y=P+this.host:this.hostname&&(Y=P+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(Y+=":"+this.port)),this.query&&n.isObject(this.query)&&Object.keys(this.query).length&&(C=T.stringify(this.query));var k=this.search||C&&"?"+C||"";return E&&E.substr(-1)!==":"&&(E+=":"),this.slashes||(!E||m[E])&&Y!==!1?(Y="//"+(Y||""),_&&_.charAt(0)!=="/"&&(_="/"+_)):Y||(Y=""),W&&W.charAt(0)!=="#"&&(W="#"+W),k&&k.charAt(0)!=="?"&&(k="?"+k),E+Y+(_=_.replace(/[?#]/g,function(R){return encodeURIComponent(R)}))+(k=k.replace("#","%23"))+W},c.prototype.resolve=function(P){return this.resolveObject(I(P,!1,!0)).format()},c.prototype.resolveObject=function(P){if(n.isString(P)){var E=new c;E.parse(P,!1,!0),P=E}for(var _=new c,W=Object.keys(this),Y=0;Y<W.length;Y++){var C=W[Y];_[C]=this[C]}if(_.hash=P.hash,P.href==="")return _.href=_.format(),_;if(P.slashes&&!P.protocol){for(var k=Object.keys(P),R=0;R<k.length;R++){var S=k[R];S!=="protocol"&&(_[S]=P[S])}return m[_.protocol]&&_.hostname&&!_.pathname&&(_.path=_.pathname="/"),_.href=_.format(),_}if(P.protocol&&P.protocol!==_.protocol){if(!m[P.protocol]){for(var N=Object.keys(P),H=0;H<N.length;H++){var K=N[H];_[K]=P[K]}return _.href=_.format(),_}if(_.protocol=P.protocol,P.host||x[P.protocol])_.pathname=P.pathname;else{for(var F=(P.pathname||"").split("/");F.length&&!(P.host=F.shift()););P.host||(P.host=""),P.hostname||(P.hostname=""),F[0]!==""&&F.unshift(""),F.length<2&&F.unshift(""),_.pathname=F.join("/")}if(_.search=P.search,_.query=P.query,_.host=P.host||"",_.auth=P.auth,_.hostname=P.hostname||P.host,_.port=P.port,_.pathname||_.search){var L=_.pathname||"",O=_.search||"";_.path=L+O}return _.slashes=_.slashes||P.slashes,_.href=_.format(),_}var z=_.pathname&&_.pathname.charAt(0)==="/",B=P.host||P.pathname&&P.pathname.charAt(0)==="/",U=B||z||_.host&&P.pathname,$=U,q=_.pathname&&_.pathname.split("/")||[],Q=(F=P.pathname&&P.pathname.split("/")||[],_.protocol&&!m[_.protocol]);if(Q&&(_.hostname="",_.port=null,_.host&&(q[0]===""?q[0]=_.host:q.unshift(_.host)),_.host="",P.protocol&&(P.hostname=null,P.port=null,P.host&&(F[0]===""?F[0]=P.host:F.unshift(P.host)),P.host=null),U=U&&(F[0]===""||q[0]==="")),B)_.host=P.host||P.host===""?P.host:_.host,_.hostname=P.hostname||P.hostname===""?P.hostname:_.hostname,_.search=P.search,_.query=P.query,q=F;else if(F.length)q||(q=[]),q.pop(),q=q.concat(F),_.search=P.search,_.query=P.query;else if(!n.isNullOrUndefined(P.search))return Q&&(_.hostname=_.host=q.shift(),(A=!!(_.host&&_.host.indexOf("@")>0)&&_.host.split("@"))&&(_.auth=A.shift(),_.host=_.hostname=A.shift())),_.search=P.search,_.query=P.query,n.isNull(_.pathname)&&n.isNull(_.search)||(_.path=(_.pathname?_.pathname:"")+(_.search?_.search:"")),_.href=_.format(),_;if(!q.length)return _.pathname=null,_.search?_.path="/"+_.search:_.path=null,_.href=_.format(),_;for(var X=q.slice(-1)[0],J=(_.host||P.host||q.length>1)&&(X==="."||X==="..")||X==="",p=0,w=q.length;w>=0;w--)(X=q[w])==="."?q.splice(w,1):X===".."?(q.splice(w,1),p++):p&&(q.splice(w,1),p--);if(!U&&!$)for(;p--;p)q.unshift("..");!U||q[0]===""||q[0]&&q[0].charAt(0)==="/"||q.unshift(""),J&&q.join("/").substr(-1)!=="/"&&q.push("");var A,M=q[0]===""||q[0]&&q[0].charAt(0)==="/";return Q&&(_.hostname=_.host=M?"":q.length?q.shift():"",(A=!!(_.host&&_.host.indexOf("@")>0)&&_.host.split("@"))&&(_.auth=A.shift(),_.host=_.hostname=A.shift())),(U=U||_.host&&q.length)&&!M&&q.unshift(""),q.length?_.pathname=q.join("/"):(_.pathname=null,_.path=null),n.isNull(_.pathname)&&n.isNull(_.search)||(_.path=(_.pathname?_.pathname:"")+(_.search?_.search:"")),_.auth=P.auth||_.auth,_.slashes=_.slashes||P.slashes,_.href=_.format(),_},c.prototype.parseHost=function(){var P=this.host,E=h.exec(P);E&&((E=E[0])!==":"&&(this.port=E.substr(1)),P=P.substr(0,P.length-E.length)),P&&(this.hostname=P)}},{"./util":77,punycode:51,querystring:54}],77:[function(i,s,r){s.exports={isString:function(o){return typeof o=="string"},isObject:function(o){return typeof o=="object"&&o!==null},isNull:function(o){return o===null},isNullOrUndefined:function(o){return o==null}}},{}],78:[function(i,s,r){(function(o){(function(){function n(c){try{if(!o.localStorage)return!1}catch{return!1}var a=o.localStorage[c];return a!=null&&String(a).toLowerCase()==="true"}s.exports=function(c,a){if(n("noDeprecation"))return c;var h=!1;return function(){if(!h){if(n("throwDeprecation"))throw new Error(a);n("traceDeprecation")?console.trace(a):console.warn(a),h=!0}return c.apply(this,arguments)}}}).call(this)}).call(this,typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{}],79:[function(i,s,r){s.exports=function o(n,c){if(n&&c)return o(n)(c);if(typeof n!="function")throw new TypeError("need wrapper function");return Object.keys(n).forEach(function(h){a[h]=n[h]}),a;function a(){for(var h=new Array(arguments.length),l=0;l<h.length;l++)h[l]=arguments[l];var u=n.apply(this,h),d=h[h.length-1];return typeof u=="function"&&u!==d&&Object.keys(d).forEach(function(f){u[f]=d[f]}),u}}},{}],80:[function(i,s,r){s.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},{}],81:[function(i,s,r){s.exports=function(){for(var n={},c=0;c<arguments.length;c++){var a=arguments[c];for(var h in a)o.call(a,h)&&(n[h]=a[h])}return n};var o=Object.prototype.hasOwnProperty},{}],82:[function(i,s,r){s.exports=function(o){o.prototype[Symbol.iterator]=function*(){for(let n=this.head;n;n=n.next)yield n.value}}},{}],83:[function(i,s,r){function o(l){var u=this;if(u instanceof o||(u=new o),u.tail=null,u.head=null,u.length=0,l&&typeof l.forEach=="function")l.forEach(function(g){u.push(g)});else if(arguments.length>0)for(var d=0,f=arguments.length;d<f;d++)u.push(arguments[d]);return u}function n(l,u,d){var f=u===l.head?new h(d,null,u,l):new h(d,u,u.next,l);return f.next===null&&(l.tail=f),f.prev===null&&(l.head=f),l.length++,f}function c(l,u){l.tail=new h(u,l.tail,null,l),l.head||(l.head=l.tail),l.length++}function a(l,u){l.head=new h(u,null,l.head,l),l.tail||(l.tail=l.head),l.length++}function h(l,u,d,f){if(!(this instanceof h))return new h(l,u,d,f);this.list=f,this.value=l,u?(u.next=this,this.prev=u):this.prev=null,d?(d.prev=this,this.next=d):this.next=null}s.exports=o,o.Node=h,o.create=o,o.prototype.removeNode=function(l){if(l.list!==this)throw new Error("removing node which does not belong to this list");var u=l.next,d=l.prev;return u&&(u.prev=d),d&&(d.next=u),l===this.head&&(this.head=u),l===this.tail&&(this.tail=d),l.list.length--,l.next=null,l.prev=null,l.list=null,u},o.prototype.unshiftNode=function(l){if(l!==this.head){l.list&&l.list.removeNode(l);var u=this.head;l.list=this,l.next=u,u&&(u.prev=l),this.head=l,this.tail||(this.tail=l),this.length++}},o.prototype.pushNode=function(l){if(l!==this.tail){l.list&&l.list.removeNode(l);var u=this.tail;l.list=this,l.prev=u,u&&(u.next=l),this.tail=l,this.head||(this.head=l),this.length++}},o.prototype.push=function(){for(var l=0,u=arguments.length;l<u;l++)c(this,arguments[l]);return this.length},o.prototype.unshift=function(){for(var l=0,u=arguments.length;l<u;l++)a(this,arguments[l]);return this.length},o.prototype.pop=function(){if(this.tail){var l=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,l}},o.prototype.shift=function(){if(this.head){var l=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,l}},o.prototype.forEach=function(l,u){u=u||this;for(var d=this.head,f=0;d!==null;f++)l.call(u,d.value,f,this),d=d.next},o.prototype.forEachReverse=function(l,u){u=u||this;for(var d=this.tail,f=this.length-1;d!==null;f--)l.call(u,d.value,f,this),d=d.prev},o.prototype.get=function(l){for(var u=0,d=this.head;d!==null&&u<l;u++)d=d.next;if(u===l&&d!==null)return d.value},o.prototype.getReverse=function(l){for(var u=0,d=this.tail;d!==null&&u<l;u++)d=d.prev;if(u===l&&d!==null)return d.value},o.prototype.map=function(l,u){u=u||this;for(var d=new o,f=this.head;f!==null;)d.push(l.call(u,f.value,this)),f=f.next;return d},o.prototype.mapReverse=function(l,u){u=u||this;for(var d=new o,f=this.tail;f!==null;)d.push(l.call(u,f.value,this)),f=f.prev;return d},o.prototype.reduce=function(l,u){var d,f=this.head;if(arguments.length>1)d=u;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");f=this.head.next,d=this.head.value}for(var g=0;f!==null;g++)d=l(d,f.value,g),f=f.next;return d},o.prototype.reduceReverse=function(l,u){var d,f=this.tail;if(arguments.length>1)d=u;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");f=this.tail.prev,d=this.tail.value}for(var g=this.length-1;f!==null;g--)d=l(d,f.value,g),f=f.prev;return d},o.prototype.toArray=function(){for(var l=new Array(this.length),u=0,d=this.head;d!==null;u++)l[u]=d.value,d=d.next;return l},o.prototype.toArrayReverse=function(){for(var l=new Array(this.length),u=0,d=this.tail;d!==null;u++)l[u]=d.value,d=d.prev;return l},o.prototype.slice=function(l,u){(u=u||this.length)<0&&(u+=this.length),(l=l||0)<0&&(l+=this.length);var d=new o;if(u<l||u<0)return d;l<0&&(l=0),u>this.length&&(u=this.length);for(var f=0,g=this.head;g!==null&&f<l;f++)g=g.next;for(;g!==null&&f<u;f++,g=g.next)d.push(g.value);return d},o.prototype.sliceReverse=function(l,u){(u=u||this.length)<0&&(u+=this.length),(l=l||0)<0&&(l+=this.length);var d=new o;if(u<l||u<0)return d;l<0&&(l=0),u>this.length&&(u=this.length);for(var f=this.length,g=this.tail;g!==null&&f>u;f--)g=g.prev;for(;g!==null&&f>l;f--,g=g.prev)d.push(g.value);return d},o.prototype.splice=function(l,u,...d){l>this.length&&(l=this.length-1),l<0&&(l=this.length+l);for(var f=0,g=this.head;g!==null&&f<l;f++)g=g.next;var y=[];for(f=0;g&&f<u;f++)y.push(g.value),g=this.removeNode(g);for(g===null&&(g=this.tail),g!==this.head&&g!==this.tail&&(g=g.prev),f=0;f<d.length;f++)g=n(this,g,d[f]);return y},o.prototype.reverse=function(){for(var l=this.head,u=this.tail,d=l;d!==null;d=d.prev){var f=d.prev;d.prev=d.next,d.next=f}return this.head=u,this.tail=l,this};try{i("./iterator.js")(o)}catch{}},{"./iterator.js":82}]},{},[12])(12)})})(mqtt_min);var mqtt_minExports=mqtt_min.exports;const status={success:{color:"#2ba471",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM7.5 10.59l3 3 6-6L17.91 9l-7.41 7.41L6.09 12l1.41-1.41z"></path></svg>'},info:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{color:"#e37318",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},error:{color:"#d54941",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},question:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zm-.17-11.11c.43-.53.97-.97 1.4-1.32A2 2 0 0012 7a2 2 0 00-1.89 1.33l-.33.95L7.9 8.6l.34-.94a4 4 0 116.24 4.47 7 7 0 00-1.1 1.01c-.27.34-.37.61-.37.85v1.25h-2V14c0-.87.39-1.57.83-2.11zM11 18.25v-2h2v2h-2z"></path></svg>'}},messageList={};class Message{constructor(t,i){D(this,"parentElement");D(this,"box");D(this,"icon");D(this,"text");D(this,"closeBtn");D(this,"duration");D(this,"content");D(this,"theme");D(this,"placement");D(this,"height");D(this,"id");this.parentElement=t,this.box=document.createElement("div"),this.icon=document.createElement("div"),this.text=document.createElement("div"),this.box.className="meta2d-message",this.icon.className="icon",this.text.className="text",this.icon.innerHTML=status[i.theme||"info"].icon,this.text.innerHTML=i.content,this.box.appendChild(this.icon),this.box.appendChild(this.text),i.closeBtn&&(this.closeBtn=document.createElement("div"),this.closeBtn.className="close",this.closeBtn.innerHTML="x",this.closeBtn.onclick=()=>{this.close()},this.box.appendChild(this.closeBtn)),t.appendChild(this.box);let s;for(let r=0;r<document.styleSheets.length;r++)document.styleSheets[r].title==="le5le.com/message"&&(s=document.styleSheets[r]);if(!s){let r=document.createElement("style");r.type="text/css",r.title="le5le.com/message",document.head.appendChild(r),r=document.createElement("style"),r.type="text/css",document.head.appendChild(r),s=r.sheet,s.insertRule(`.meta2d-message{
           position:absolute;
           z-index:999;
           transform: translateX(-50%); 
           padding:12px 16px;
           max-width:400px;
           background:#fff;
           border-radius:6px;
           box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);
           display:flex;
           animation: fadein .5s;}`),s.insertRule(`
        @keyframes fadein {
          0% {
              transform: translate(-50%, -100%);
          }
          100% {
              transform: translate(-50%,0);
          }
      }`),s.insertRule(".meta2d-message .icon{width:20px;height:20px;}"),s.insertRule(".meta2d-message .text{color:rgba(0, 0, 0, 0.9);font-size:12px;margin-left:8px;line-height:20px;}"),s.insertRule(".meta2d-message .close{width:20px;height:20px;padding-left: 16px; cursor: pointer;}")}this.id=i.id||s8(),this.duration=i.duration??3e3,this.placement=i.placement||"top",this.theme=i.theme||"info",this.height=i.height}init(){messageList[this.id]=this,this.duration&&setTimeout(()=>{this.close()},this.duration);let t=-1;Object.keys(messageList).forEach(i=>{var s;((s=messageList[i])==null?void 0:s.placement)===this.placement&&t++}),this.setPosition(this.placement,t),this.icon.children[0].style.fill=status[this.theme].color}setPosition(t,i=0){switch(t){case"top":this.box.style.top=`${30+i*(this.height||60)}px`,this.box.style.left="50%";break;case"bottom":this.box.style.bottom=`${30+i*(this.height||60)}px`,this.box.style.left="50%";break;case"left":this.box.style.top=`${30+i*(this.height||60)}px`,this.box.style.left="30px";break;case"right":this.box.style.top=`${30+i*(this.height||60)}px`,this.box.style.right="30px";break}}close(){Object.keys(messageList).forEach(t=>{var i;if(((i=messageList[t])==null?void 0:i.placement)===this.placement)switch(this.placement){case"top":case"left":case"right":messageList[t].box.style.top=parseInt(messageList[t].box.style.top)-60+"px";break;case"bottom":messageList[t].box.style.bottom=parseInt(messageList[t].box.style.bottom)-60+"px";break}}),messageList[this.id]=null,delete messageList[this.id],this.box.remove()}}function connectJetLinks(e,t){if(e.jetLinksList.length){let i=t.url;i.startsWith("/")&&(i=(location.protocol==="https:"?"wss://":"ws://")+window.location.host+i),e.jetLinksClient=new WebSocket(`${i}/${localStorage.getItem("X-Access-Token")||getCookie("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||""}`),e.jetLinksClient.onmessage=s=>{var o;const r=JSON.parse(s.data);if(r.payload)if((o=r.payload)!=null&&o.properties){const n=[];for(let c in r.payload.properties)c.startsWith("_")||n.push({id:`${r.payload.headers.productId}#${r.payload.deviceId}#${c}`,value:r.payload.properties[c]});e.setDatas(n,{history:!1})}else r.topic.startsWith("/notifications")&&doWarning(e,r)},e.jetLinksClient.onopen=()=>{e.jetLinksList.forEach(s=>{e.jetLinksClient.send(JSON.stringify({type:"sub",topic:`/device${s.topic}/message/property/report`,parameter:{deviceId:s.deviceId,properties:s.properties,history:1},id:s.topic+"-"+s8()}))}),t.notification&&e.jetLinksClient.send(JSON.stringify({type:"sub",topic:"/notifications",id:"notification",parameter:{}}))}}}function doWarning(e,t){var n,c;let i=t.payload.topicName,s=t.payload.message,r=t.payload.notifyTime,o=`<div style="padding:0px 12px 0px 0px;width:300px;">
      <div style="display:flex;height: 20px;justify-content: space-between">
        <div style="color: #000000d9;
      font-size: 14px;
      font-weight: 700;">${i}</div><div style="color: #00000073;">${getTime(r)}</div>
      </div>
      <span>${s}</span>
   </div>`;e.message({content:o,duration:0,closeBtn:!0,placement:"right",height:75}),(n=t.payload.detail)!=null&&n.alarmConfigId&&playMp3(e,(c=t.payload.detail)==null?void 0:c.alarmConfigId)}globalThis.doWarning=doWarning;function getTime(e){const t=new Date(e),i=t.getFullYear(),s=(t.getMonth()+1+"").padStart(2,"0"),r=(t.getDate()+"").padStart(2,"0"),o=(t.getHours()+"").padStart(2,"0"),n=(t.getMinutes()+"").padStart(2,"0"),c=(t.getSeconds()+"").padStart(2,"0");return i+"-"+s+"-"+r+" "+o+":"+n+":"+c}function closeJetLinks(e){e.jetLinksClient&&(e.jetLinksClient.close(),e.jetLinksClient=void 0)}function getSendData(e,t,i){const s=[];return i.list.forEach((r,o)=>{var c,a;const n=r.params?e.findOne(r.params):t;s[o]={deviceId:n.deviceId,productId:n.productId,properties:{}};for(let h in r.value)if(r.value[h]===void 0||r.value[h]===""){const l=(c=n.realTimes)==null?void 0:c.find(u=>u.propertyId===h);l&&(s[o].properties[h]=n[l.key])}else if(typeof r.value[h]=="string"&&((a=r.value[h])==null?void 0:a.indexOf("${"))>-1){let l=r.value[h].match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));l!=null&&l.length&&(s[o].properties[h]=n[l[0]]??e.getDynamicParam(l[0]))}else s[o].properties[h]=r.value[h]}),s}async function sendJetLinksData(e,t){t.forEach(async i=>{let s=i.deviceId;if(s&&s.indexOf("${")>-1){let o=s.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));o!=null&&o.length&&(s=e.getDynamicParam(o[0])||s)}(await fetch(`/api/device-instance/${s}/property`,{headers:{"X-Access-Token":localStorage.getItem("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||"","Content-Type":"application/json"},method:"put",body:JSON.stringify(i.properties)})).ok?(console.info(""),e.message({theme:"success",content:""})):e.message({theme:"error",content:""})})}async function playMp3(e,t){const i=await fetch(`/api/alarm/config/${t}`,{headers:{"X-Access-Token":localStorage.getItem("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||"","Content-Type":"application/json"},method:"GET"});if(i.ok){let s=i.json();console.log("alarm"),s.result.media&&createAudio(e,s.result.media,s.result.playTimes)}}function createAudio(e,t,i){if(e.store.globalAudio||(e.store.globalAudio=document.createElement("audio")),e.store.globalAudio.src=t,e.store.globalAudio.play(),i===-1)e.store.globalAudio.loop=!0;else{e.store.globalAudio.loop=!1;let s=0;e.store.globalAudio.onended=()=>{s++,s<i&&e.store.globalAudio.play()}}}globalThis.createAudio=createAudio;class Meta2d{constructor(e,t={}){D(this,"store");D(this,"canvas");D(this,"websocket");D(this,"mqttClient");D(this,"websockets");D(this,"mqttClients");D(this,"eventSources");D(this,"penPluginMap",new Map);D(this,"socketFn");D(this,"events",{});D(this,"map");D(this,"mapTimer");D(this,"facePen",facePen);D(this,"getWords",getWords);D(this,"calcTextLines",calcTextLines);D(this,"calcTextRect",calcTextRect);D(this,"calcTextDrawRect",calcTextDrawRect);D(this,"jetLinksList",[]);D(this,"jetLinksClient");D(this,"register",register);D(this,"registerCanvasDraw",registerCanvasDraw);D(this,"registerAnchors",registerAnchors);D(this,"registerLineAnimateDraws",(name,drawFunc)=>{drawFunc=typeof drawFunc=="string"?drawFunc:drawFunc.toString(),this.store.data.lineAnimateDraws[name]=drawFunc,globalStore.lineAnimateDraws[name]=eval(drawFunc)});D(this,"websocketTimes",0);D(this,"mqttTimes",0);D(this,"httpTimer");D(this,"httpTimerList",[]);D(this,"updateTimer");D(this,"updateTimerList",[]);D(this,"sqlTimerList",[]);D(this,"iotMqttClient");D(this,"iotTimer");D(this,"iotWebsocketClient");D(this,"onEvent",(e,t)=>{switch(e){case"add":t.forEach(i=>{var s;(s=i.onAdd)==null||s.call(i,i)}),this.onSizeUpdate();break;case"enter":t&&t.onMouseEnter&&t.onMouseEnter(t,this.canvas.mousePos),this.store.data.locked&&this.doEvent(t,e);break;case"leave":t&&t.onMouseLeave&&t.onMouseLeave(t,this.canvas.mousePos),this.store.data.locked&&this.doEvent(t,e);break;case"active":case"inactive":this.store.data.locked&&t.forEach(i=>{this.doEvent(i,e)});break;case"click":if(this.store.data.locked&&t.pen&&!t.pen.disabled&&t.pen.switch&&(t.pen.checked=!t.pen.checked,t.pen.calculative.checked=t.pen.checked,t.pen.calculative.gradient=void 0,t.pen.calculative.radialGradient=void 0),t.pen&&t.pen.formId){const i=this.store.pens[t.pen.formId];t.pen.formType==="submit"?this.store.data.locked&&i&&!i.disabled&&this.doEvent(i,"submit"):t.pen.formType==="reset"&&(reset(t.pen),this.store.data.locked&&i&&!i.disabled&&this.doEvent(i,"reset"))}t.pen&&t.pen.onClick&&!t.pen.disabled&&t.pen.onClick(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"contextmenu":t.pen&&t.pen.onContextmenu&&!t.pen.disabled&&t.pen.onContextmenu(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"mousedown":t.pen&&t.pen.onMouseDown&&!t.pen.disabled&&t.pen.onMouseDown(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"mouseup":t.pen&&t.pen.onMouseUp&&!t.pen.disabled&&t.pen.onMouseUp(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"dblclick":this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"valueUpdate":t&&updateFormData(t,t.formValue),this.store.data.locked&&this.doEvent(t,e),this.canvas.tooltip.updateText(t);break;case"update":case"delete":case"translatePens":case"rotatePens":case"resizePens":this.onSizeUpdate();break;case"navigator":this.store.data.id||console.warn(""),this.navigatorTo(t.params);break;case"input":this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,e);break;case"change":t.pen&&updateFormData(t.pen),t.pen?this.store.data.locked&&!t.pen.disabled&&this.doEvent(t.pen,e):this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,e);break}this.doMessageEvent(e,t)});D(this,"doEvent",(e,t)=>{var r,o,n,c,a,h,l,u,d,f;if(!e)return;let i=!1,s=[];if((r=e.events)==null||r.forEach((g,y)=>{var v;if(g.actions&&g.actions.length){if(g.name===t){let b=!1;g.conditions&&g.conditions.length?g.conditionType==="and"?b=g.conditions.every(x=>this.judgeCondition(e,x.key,x)):g.conditionType==="or"&&(b=g.conditions.some(x=>this.judgeCondition(e,x.key,x))):b=!0,b&&s.push(y)}}else if(i=!0,this.events[g.action]&&g.name===t){let b=!((v=g.where)!=null&&v.type);if(g.where){const{fn:x,fnJs:m,comparison:T,key:I,value:P}=g.where;if(x)b=x(e,{meta2d:this});else if(m){try{g.where.fn=new Function("pen","context",m)}catch(E){console.error("Error: make function:",E)}g.where.fn&&(b=g.where.fn(e,{meta2d:this}))}else{let E=e[I];switch(["x","y","width","height"].includes(I)&&(E=this.getPenRect(e)[I]),T){case">":b=E>+P;break;case">=":b=E>=+P;break;case"<":b=E<+P;break;case"<=":b=E<=+P;break;case"=":case"==":b=E==P;break;case"!=":b=E!=P;break;case"[)":b=valueInRange(+E,P);break;case"![)":b=!valueInRange(+E,P);break;case"[]":b=valueInArray(E,P);break;case"![]":b=!valueInArray(E,P);break}}}b&&s.push(y)}}),i?(o=e.events)==null||o.forEach((g,y)=>{s.includes(y)&&this.events[g.action](e,g)}):(n=e.events)==null||n.forEach(async(g,y)=>{if(s.includes(y)){if(g.confirm&&!await this.canvas.popconfirm.showModal(e,this.canvas.mousePos,g.confirmTitle))return;g.actions.forEach(v=>{if(v.timeout){let b=setTimeout(()=>{this.events[v.action]&&(this.events[v.action](e,v),clearTimeout(b),b=null)},v.timeout)}else this.events[v.action]&&this.events[v.action](e,v)})}}),t==="valueUpdate"){(c=e.realTimes)==null||c.forEach(y=>{var b,x;let v=[];(b=y.triggers)==null||b.forEach((m,T)=>{var P;let I=!1;(P=m.conditions)!=null&&P.length?m.conditionType==="and"?I=m.conditions.every(E=>this.judgeCondition(e,y.key,E)):m.conditionType==="or"&&(I=m.conditions.some(E=>this.judgeCondition(e,y.key,E))):I=!0,I&&v.push(T)}),(x=y.triggers)==null||x.forEach((m,T)=>{var I;v.includes(T)&&((I=m.actions)==null||I.forEach(P=>{if(P.timeout){let E=setTimeout(()=>{this.events[P.action]&&(this.events[P.action](e,P),clearTimeout(E),E=null)},P.timeout)}else this.events[P.action](e,P)}))})});let g=[];if((a=this.store.globalTriggers[e.id])==null||a.forEach((y,v)=>{var x;let b=!1;(x=y.conditions)!=null&&x.length?y.conditionType==="and"?b=y.conditions.every(m=>this.judgeCondition(this.store.pens[m.source],m.key,m)):y.conditionType==="or"&&(b=y.conditions.some(m=>this.judgeCondition(this.store.pens[m.source],m.key,m))):b=!0,b&&g.push(v)}),(h=this.store.globalTriggers[e.id])==null||h.forEach((y,v)=>{var b;g.includes(v)&&((b=y.actions)==null||b.forEach(x=>{if(x.timeout){let m=setTimeout(()=>{this.events[x.action]&&(this.events[x.action](e,x),clearTimeout(m),m=null)},x.timeout)}else this.events[x.action](e,x)}))}),(l=e.triggers)!=null&&l.length){for(let y of e.triggers)if((u=y.status)!=null&&u.length)for(let v of y.status){let b=!1;if((d=v.conditions)!=null&&d.length?v.conditionType==="and"?b=v.conditions.every(x=>this.judgeCondition(e,x.key,x)):v.conditionType==="or"&&(b=v.conditions.some(x=>this.judgeCondition(e,x.key,x))):b=!0,b){(f=v.actions)==null||f.forEach(x=>{if(x.timeout){let m=setTimeout(()=>{this.events[x.action]&&(this.events[x.action](e,x),clearTimeout(m),m=null)},x.timeout)}else this.events[x.action](e,x)});break}}}}this.doEvent(this.store.pens[e.parentId],t)});D(this,"doDataEvent",e=>{var s,r,o;if(!((s=this.store.data.dataEvents)!=null&&s.length))return;const t=e.reduce((n,{dataId:c,id:a,value:h})=>(n[a||c]=h,n),{});let i=[];(r=this.store.data.dataEvents)==null||r.forEach((n,c)=>{let a=!1;n.conditions&&n.conditions.length?n.conditionType==="and"?a=n.conditions.every(h=>this.dataJudegeCondition(t,h.key,h)):n.conditionType==="or"&&(a=n.conditions.some(h=>this.dataJudegeCondition(t,h.key,h))):a=!0,a&&i.push(c)}),(o=this.store.data.dataEvents)==null||o.forEach((n,c)=>{var a;i.includes(c)&&((a=n.actions)==null||a.forEach(h=>{this.events[h.action](t,h)}))})});D(this,"renderPenRaw",renderPenRaw$1);D(this,"setElemPosition",setElemPosition);D(this,"setLifeCycleFunc",setLifeCycleFunc);this.store=useStore(s8()),this.setOptions(t),this.setDatabyOptions(t),this.init(e),this.register(commonPens()),this.registerCanvasDraw({cube}),this.registerAnchors(commonAnchors()),globalThis.meta2d=this,this.initEventFns(),this.store.emitter.on("*",this.onEvent)}get beforeAddPen(){return this.canvas.beforeAddPen}set beforeAddPen(e){this.canvas.beforeAddPen=e}get beforeAddPens(){return this.canvas.beforeAddPens}set beforeAddPens(e){this.canvas.beforeAddPens=e}get beforeAddAnchor(){return this.canvas.beforeAddAnchor}set beforeAddAnchor(e){this.canvas.beforeAddAnchor=e}get beforeRemovePens(){return this.canvas.beforeRemovePens}set beforeRemovePens(e){this.canvas.beforeRemovePens=e}get beforeRemoveAnchor(){return this.canvas.beforeRemoveAnchor}set beforeRemoveAnchor(e){this.canvas.beforeRemoveAnchor=e}setOptions(e={}){var t,i;(e.grid!==void 0||e.gridColor!==void 0||e.gridSize!==void 0)&&this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),(e.rule!==void 0||e.ruleColor!==void 0||e.ruleOptions!==void 0)&&(this.store.patchFlagsTop=!0,e.ruleOptions&&(t=this.store.options)!=null&&t.ruleOptions&&(Object.assign(this.store.options.ruleOptions,e.ruleOptions),e.ruleOptions=this.store.options.ruleOptions)),e.background!==void 0&&this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),e.resizeMode!==void 0&&(e.resizeMode||(this.canvas.hotkeyType=HotkeyType.None)),(e.width!==void 0||e.height!==void 0)&&(this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),this.canvas&&this.canvas.canvasTemplate.canvas.style.backgroundImage&&(this.canvas.canvasTemplate.canvas.style.backgroundImage="")),this.store.options=Object.assign(this.store.options,e),this.canvas&&e.scroll!==void 0&&(e.scroll?(!this.canvas.scroll&&(this.canvas.scroll=new Scroll(this.canvas)),this.canvas.scroll.show()):this.canvas.scroll&&this.canvas.scroll.hide()),(i=this.canvas)==null||i.initGlobalStyle()}getOptions(){return this.store.options}registerTheme(e,t){if(!Array.isArray(t))return;const i=/^\s*\S+\s*:\s*\S+\s*$/;if(!t.every(n=>i.test(n)))return;const r={},o=[];for(let n=0;n<t.length;n++){const a=t[n].split(":"),h=a[0].trim(),l=a[1].trim();o.push([h,l].join(":")),r[h]=l}le5leTheme.addTheme(e,o),this.store.theme[e]=r}setTheme(e){this.store.data.theme=e,this.setBackgroundColor(this.store.theme[e].background),this.canvas.parentElement.style.background=this.store.theme[e].parentBackground,this.store.data.color=this.store.theme[e].color,this.setOptions({ruleColor:this.store.theme[e].ruleColor,ruleOptions:this.store.theme[e].ruleOptions}),le5leTheme.updateCssRule(this.store.id,e),this.canvas.initGlobalStyle();for(let t=0;t<this.store.data.pens.length;t++){const i=this.store.data.pens[t];i.setTheme&&i.setTheme(i,this.store.styles)}this.render()}setDatabyOptions(e={}){const{color:t,activeColor:i,activeBackground:s,grid:r,gridColor:o,gridSize:n,fromArrow:c,toArrow:a,rule:h,ruleColor:l,textColor:u,x:d=0,y:f=0}=e;this.setRule({rule:h,ruleColor:l}),this.setGrid({grid:r,gridColor:o,gridSize:n}),this.store.data=Object.assign(this.store.data,{textColor:u,color:t,activeColor:i,activeBackground:s,fromArrow:c,toArrow:a,x:d,y:f})}init(e){typeof e=="string"?this.canvas=new Canvas(this,document.getElementById(e),this.store):this.canvas=new Canvas(this,e,this.store),this.canvas.initGlobalStyle(),this.resize(),this.canvas.listen(),le5leTheme.createThemeSheet(this.store.data.theme,this.store.id)}initEventFns(){this.events[EventAction.Link]=(e,t)=>{var i;if(window&&t.value&&typeof t.value=="string"){let s=t.value;if(s.includes("${")){let r=(i=s.match(/\$\{([^}]+)\}/g))==null?void 0:i.map(o=>o.slice(2,-1));r&&(r==null||r.forEach(o=>{s=s.replace(`\${${o}}`,e[o])}))}window.open(s,t.params??"_blank");return}console.warn("[meta2d] Link param is not a string")},this.events[EventAction.SetProps]=(e,t)=>{var s,r,o;const i=t.value;if(i&&typeof i=="object"){const n=t.params?this.find(t.params):this.find(e.id),c={};for(let a in i)if((s=i[a])!=null&&s.id)c[a]=(r=this.store.pens[i[a].id])==null?void 0:r[i[a].key];else if(typeof i[a]=="string"&&i[a].includes("${")){let h=i[a],l=(o=h.match(/\$\{([^}]+)\}/g))==null?void 0:o.map(u=>u.slice(2,-1));l&&l.forEach(u=>{h=h.replace(`\${${u}}`,e[u]||this.getDynamicParam(u))}),c[a]=h}else c[a]=i[a];n.forEach(a=>{c.hasOwnProperty("visible")&&a.visible!==c.visible&&this.setVisible(a,c.visible),this.setValue({id:a.id,...c},{render:!1,doEvent:!1})}),this.render();return}console.warn("[meta2d] SetProps value is not an object")},this.events[EventAction.StartAnimate]=(e,t)=>{let i=e;if(t.value&&(i=this.findOne(t.value)),!(this.store.animates.has(i)&&!i.calculative.pause&&i.animateName===t.params)){if(t.targetType&&t.params){this.startAnimate(t.value||[e],t.params);return}if(!t.value||typeof t.value=="string"){this.startAnimate(t.value||[e]);return}console.warn("[meta2d] StartAnimate value is not a string")}},this.events[EventAction.PauseAnimate]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.pauseAnimate(t.value||[e]);return}console.warn("[meta2d] PauseAnimate value is not a string")},this.events[EventAction.StopAnimate]=(e,t)=>{if(!t.value||typeof t.value=="string"){if(t.value){let i=this.findOne(t.value);if(!this.store.animates.has(i))return}else if(!this.store.animates.has(e))return;this.stopAnimate(t.value||[e]);return}console.warn("[meta2d] StopAnimate event value is not a string")},this.events[EventAction.StartVideo]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.startVideo(t.value||[e]);return}console.warn("[meta2d] StartVideo value is not a string")},this.events[EventAction.PauseVideo]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.pauseVideo(t.value||[e]);return}console.warn("[meta2d] PauseVideo value is not a string")},this.events[EventAction.StopVideo]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.stopVideo(t.value||[e]);return}console.warn("[meta2d] StopVideo event value is not a string")},this.events[EventAction.JS]=(e,t,i)=>{var s;if(t.value&&!t.fn)try{if(typeof t.value!="string")throw new Error("[meta2d] Function value must be string");const r=t.value;t.fn=new Function("pen","params","context",r)}catch(r){console.error("[meta2d]: Error on make a function:",r)}(s=t.fn)==null||s.call(t,e,i||t.params,{meta2d:this,eventName:t.name})},this.events[EventAction.GlobalFn]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] GlobalFn value must be a string");return}globalThis[t.value]&&globalThis[t.value](e,t.params)},this.events[EventAction.Emit]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] Emit value must be a string");return}this.store.emitter.emit(t.value,{pen:e,params:t.params,eventName:t.name})},this.events[EventAction.SendPropData]=(e,t)=>{const i=deepClone(t.value);if(i&&typeof i=="object"){const s=t.params?this.findOne(t.params):e;for(let r in i)(i[r]===void 0||i[r]==="")&&(i[r]=s[r]);i.id=s.id,this.doSendDataEvent(i,t.extend);return}console.warn("[meta2d] SendPropData value is not an object")},this.events[EventAction.SendVarData]=(e,t)=>{const i=deepClone(t.value);if(i&&typeof i=="object"){const s=t.params?this.findOne(t.params):e;let r=[];for(let o in i){let n={dataId:o,value:i[o]};if(!n.value){let c=s.form.find(a=>a.dataIds&&a.dataIds.dataId===n.dataId);c&&(n.value=s[c.key])}r.push(n)}this.doSendDataEvent(r,t.extend);return}console.warn("[meta2d] SendVarData value is not an object")},this.events[EventAction.Navigator]=(e,t)=>{t.value&&typeof t.value=="string"&&this.navigatorTo(t.value)},this.events[EventAction.Dialog]=(e,t)=>{var i;if(t.params&&typeof t.params=="string"){let s=t.params;if(t.params.includes("${")){let o=(i=t.params.match(/\$\{([^}]+)\}/g))==null?void 0:i.map(n=>n.slice(2,-1));o&&(o==null||o.forEach(n=>{s=s.replace(`\${${n}}`,e[n])}))}Object.keys(t.extend).forEach(o=>{["x","y","width","height"].includes(o)||(s.indexOf("?")!==-1?s+=`&${o}=${t.extend[o]}`:s+=`?${o}=${t.extend[o]}`)});let r=this.getEventData(t.list,e);Object.keys(r).length&&(r=null),this.canvas.dialog.show(t.value,s,t.extend,r)}},this.events[EventAction.SendData]=(e,t)=>{var s,r,o,n;if((s=t.data)!=null&&s.length){const c=this.getSendData(t.data);e.formId&&e.formData&&Object.assign(c,e.formData),this.sendDataToNetWork(c,e,t);return}if((r=t.list)!=null&&r.length){if(t.network&&t.network.protocol==="ADIIOT"){const a=getSendData(this,e,t);a.length&&sendJetLinksData(this,a);return}const c=this.getEventData(t.list,e);e.deviceId&&(c.deviceId=e.deviceId),e.formId&&e.formData&&Object.assign(c,e.formData),this.sendDataToNetWork(c,e,t);return}const i=deepClone(t.value);if(i&&typeof i=="object"&&t.targetType==="id"){const c=t.params?this.findOne(t.params):e;for(let a in i)if(i[a]===void 0||i[a]==="")i[a]=c[a];else if(typeof i[a]=="string"&&((o=i[a])==null?void 0:o.indexOf("${"))>-1){let h=(n=i[a].match(/\$\{([^}]+)\}/g))==null?void 0:n.map(l=>l.slice(2,-1));h!=null&&h.length&&(i[a]=c[h[0]]??this.getDynamicParam(h[0]))}c.deviceId&&(i.deviceId=c.deviceId),this.sendDataToNetWork(i,e,t);return}},this.events[EventAction.PostMessage]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] Emit value must be a string");return}const i=t.params?this.findOne(t.params):e;if(i.name!=="iframe"||!i.iframe){console.warn("");return}let s=queryURLParams(i.iframe.split("?")[1]);const r=this.getEventData(t.list,i);i.calculative.singleton.div.children[0].contentWindow.postMessage(JSON.stringify({name:t.value,id:s.id,data:r}),"*")},this.events[EventAction.PostMessageToParent]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] Emit value must be a string");return}const i=this.getEventData(t.list,e);window.parent.postMessage(JSON.stringify({name:t.value,data:i}),"*")},this.events[EventAction.Message]=(e,t)=>{this.message({theme:t.params,content:t.value,...t.extend})}}getSendData(e){const t={};return e.forEach(i=>{var s;if(i.prop)if(i.id&&i.id!==""){const r=this.findOne(i.id);t[i.prop]=r[i.key]}else if(typeof i.value=="string"&&i.value.includes("${")){let r=i.value,o=(s=r.match(/\$\{([^}]+)\}/g))==null?void 0:s.map(n=>n.slice(2,-1));o&&o.forEach(n=>{r=r.replace(`\${${n}}`,this.getDynamicParam(n))}),t[i.prop]=r}else t[i.prop]=this.convertType(i.value,i.type)}),t}convertType(e,t){if(typeof e=="string"){if(["switch","bool","boolean"].includes(t)){if(e==="false")return!1;if(e==="true")return!0}else if(["integer","number","int","enum","double","float"].includes(t)&&!isNaN(Number(e)))return Number(e)}return e}getEventData(e,t){const i={};return e!=null&&e.length&&e.forEach(s=>{var o,n;const r=s.params?this.findOne(s.params):t;for(let c in s.value)if(s.value[c]===void 0||s.value[c]==="")i[c]=r[c];else if(typeof s.value[c]=="string"&&((o=s.value[c])==null?void 0:o.indexOf("${"))>-1){let a=(n=s.value[c].match(/\$\{([^}]+)\}/g))==null?void 0:n.map(h=>h.slice(2,-1));a!=null&&a.length&&(i[c]=r[a[0]]??this.getDynamicParam(a[0]))}else i[c]=s.value[c]}),Object.keys(i).length?i:{}}message(e){new Message(this.canvas.parentElement,e).init()}closeAll(){for(let e in messageList)messageList[e].close()}async navigatorTo(e){var s;if(!e)return;if((s=queryURLParams())==null?void 0:s.id){const r=new URL(window.location);r.searchParams.set("id",e),history.pushState({},"",r)}const i=await getMeta2dData(this.store,e);i&&(this.open(i),this.lock(1),this.fitView(!0,10))}doSendDataEvent(e,t){let i=JSON.stringify(e);this.mqttClient&&this.mqttClient.connected&&(t?t.split(",").forEach(s=>{this.mqttClient.publish(s,i)}):this.store.data.mqttTopics&&this.store.data.mqttTopics.split(",").forEach(s=>{this.mqttClient.publish(s,i)})),this.websocket&&this.websocket.readyState===1&&this.websocket.send(i),(this.store.data.https||this.store.data.http)&&this.sendDatabyHttp(i),this.store.emitter.emit("sendData",i)}async sendDataToNetWork(e,t,i){var r,o,n,c,a,h;const s=deepClone(i.network);if(s.data&&(Object.assign(s,s.data),delete s.data),s.protocol==="iot"){this.iotMqttClient&&this.iotMqttClient.publish(`le5le-iot/property/set/${(r=this.store.data.iot)==null?void 0:r.token}`,JSON.stringify(e));return}if(s.url){if(s.protocol==="http"){if(typeof s.headers=="object"){for(let f in s.headers)if(typeof s.headers[f]=="string"){let g=(o=s.headers[f].match(/\$\{([^}]+)\}/g))==null?void 0:o.map(y=>y.slice(2,-1));g&&(s.headers[f]=s.headers[f].replace(`\${${g[0]}}`,this.getDynamicParam(g[0])))}}let l,u=s.url;if(s.method==="GET"&&(l="?"+Object.keys(e).map(f=>f+"="+e[f]).join("&")),s.method==="POST"&&u.indexOf("${")>-1){let f=(n=u.match(/\$\{([^}]+)\}/g))==null?void 0:n.map(g=>g.slice(2,-1));f&&f.forEach(g=>{u=u.replace(`\${${g}}`,getter(t,g)||this.getDynamicParam(g))})}const d=await fetch(u+(l||""),{headers:s.headers||{},method:s.method,body:s.method==="POST"?JSON.stringify(e):void 0});if(d.ok){if(i.callback){const f=await d.text();if(!i.fn)try{if(typeof i.callback!="string")throw new Error("[meta2d] Function callback must be string");const g=i.callback;i.fn=new Function("pen","data","context",g)}catch(g){console.error("[meta2d]: Error on make a function:",g)}(c=i.fn)==null||c.call(i,t,f,{meta2d:this,e:i})}console.info("http")}}else if(s.protocol==="mqtt"){const l=(a=this.mqttClients)==null?void 0:a.filter(u=>u.options.href===s.url);if(l&&l.length)l[0].connected&&s.topics.split(",").forEach(u=>{l[0].publish(u,JSON.stringify(e))});else{let u=mqtt_minExports.connect(s.url,s.options);u.on("connect",()=>{console.info("mqtt"),s.topics.split(",").forEach(d=>{u.publish(d,JSON.stringify(e)),setTimeout(()=>{u==null||u.end()},1e3)})})}}else if(s.protocol==="websocket"){const l=(h=this.websockets)==null?void 0:h.filter(u=>u.url===s.url);if(l&&l.length)l[0].readyState===1&&l[0].send(JSON.stringify(e));else{let u=new WebSocket(s.url,s.protocols||void 0);u.onopen=function(){console.info("websocket"),u.send(JSON.stringify(e)),setTimeout(()=>{u.close()},100)}}}}}resize(e,t){this.canvas.resize(e,t),this.render(),this.store.emitter.emit("resize",{width:e,height:t}),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}async addPen(e,t,i=!0,s=!1){return await this.canvas.addPen(e,t,i,s)}async addPens(e,t,i=!1){return await this.canvas.addPens(e,t,i)}render(e){var t;(t=this.canvas)==null||t.render(e)}async setBackgroundImage(e,t){var n,c,a,h;let i=this;async function s(l){return new Promise(u=>{const d=new Image;d.src=l,i.store.options.cdn&&!(l.startsWith("http")||l.startsWith("//")||l.startsWith("data:image"))&&(d.src=i.store.options.cdn+l),d.crossOrigin="anonymous",d.onload=()=>{u(d)}})}this.store.data.bkImage=e;const r=(t==null?void 0:t.width)||((n=this.store.data)==null?void 0:n.width)||((c=this.store.options)==null?void 0:c.width),o=(t==null?void 0:t.height)||((a=this.store.data)==null?void 0:a.height)||((h=this.store.options)==null?void 0:h.height);if(r&&o?(this.canvas.canvasTemplate.canvas.style.backgroundImage=null,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)):this.canvas.canvasTemplate.canvas.style.backgroundImage=e?`url('${e}')`:"",e){const l=await s(e);this.store.bkImg=l,r&&o&&this.canvas&&(this.canvas.canvasTemplate.init(),this.render())}else this.store.bkImg=null}setBackgroundColor(e=this.store.data.background){this.store.data.background=e,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setGrid({grid:e=this.store.data.grid,gridColor:t=this.store.data.gridColor,gridSize:i=this.store.data.gridSize,gridRotate:s=this.store.data.gridRotate}={}){this.store.data.grid=e,this.store.data.gridColor=t,this.store.data.gridSize=i<0?0:i,this.store.data.gridRotate=s,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setRule({rule:e=this.store.data.rule,ruleColor:t=this.store.data.ruleColor}={}){this.store.data.rule=e,this.store.data.ruleColor=t,this.store.patchFlagsTop=!0}open(e,t=!0){if(this.clear(!1,e==null?void 0:e.template),this.canvas.autoPolylineFlag=!0,e){e.theme&&this.setTheme(e.theme),this.setBackgroundImage(e.bkImage,e),Object.assign(this.store.data,e),this.store.data.pens=[];for(const i of e.pens)i.id||(i.id=s8()),!i.calculative&&(i.calculative={canvas:this.canvas}),this.store.pens[i.id]=i;for(const i of e.pens)this.canvas.makePen(i)}if(this.canvas.patchFlagsLines.forEach(i=>{i.type&&this.canvas.initLineRect(i)}),this.store.data.template||(this.store.data.template=s8()),t||(this.canvas.opening=!0),this.doInitJS(),this.initBindDatas(),this.initBinds(),this.doInitFn(),this.loadLineAnimateDraws(),this.initMessageEvents(),this.initGlobalTriggers(),this.startAnimate(),this.startVideo(),this.listenSocket(),this.connectSocket(),this.connectNetwork(),this.startDataMock(),this.canvas.initGlobalStyle(),this.render(),setTimeout(()=>{const i=this.store.data.pens.find(s=>s.autofocus);i&&this.focus(i.id)},100),this.store.data.iconUrls)for(const i of this.store.data.iconUrls)loadCss(i,()=>{this.render()});this.canvas.autoPolylineFlag=!1,this.store.emitter.emit("opened"),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}cacheData(e){if(e&&this.store.options.cacheLength){let t=this.store.cacheDatas.findIndex(i=>i.data&&i.data._id===e);if(t===-1)this.store.cacheDatas.push({data:deepClone(this.store.data,!0)}),this.store.cacheDatas.length>this.store.options.cacheLength&&this.store.cacheDatas.shift();else{let i=this.store.cacheDatas.splice(t,1)[0];this.store.cacheDatas.push(i)}}}loadCacheData(e){let t=this.store.cacheDatas.findIndex(i=>i.data&&i.data._id===e);t!==-1&&(this.store.data=this.store.cacheDatas[t].data,this.setBackgroundImage(this.store.data.bkImage),this.store.pens={},this.store.data.pens.forEach(i=>{i.calculative.canvas=this.canvas,this.store.pens[i.id]=i,globalStore.path2dDraws[i.name]&&this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),i.type&&this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),i.image&&(i.calculative.imageDrawed=!1,this.canvas.loadImage(i))}),this.render())}loadLineAnimateDraws(){globalStore.lineAnimateDraws={},Object.entries(this.store.data.lineAnimateDraws).forEach(([key,drawFunc])=>{globalStore.lineAnimateDraws[key]=eval(drawFunc)})}statistics(){const e=this.store.data.pens.length,t=this.store.data.pens.filter(n=>n.image).length,i=this.store.data.pens.filter(n=>n.image&&n.calculative.inView).length,s=this.store.data.pens.filter(n=>n.name.endsWith("Dom")||isDomShapes.includes(n.name)||this.store.options.domShapes.includes(n.name)||n.externElement).length,r=this.store.animates.size;let o=0;return Object.keys(this.store.bind).forEach(n=>{o+=this.store.bind[n].length}),Object.keys(this.store.bindDatas).forEach(n=>{o+=this.store.bindDatas[n].length}),{:e,:t,:i,dom:s,:r,:o}}initBindDatas(){this.store.bindDatas={},this.store.data.pens.forEach(e=>{var t;(t=e.form)==null||t.forEach(i=>{let s;i.dataIds&&(Array.isArray(i.dataIds)?s=i.dataIds:s=[i.dataIds]),s==null||s.forEach(r=>{this.store.bindDatas[r.dataId]||(this.store.bindDatas[r.dataId]=[]),this.store.bindDatas[r.dataId].push({id:e.id,formItem:i})})})})}initBinds(){this.jetLinksList=[],this.store.bind={};const e=[],t=[];this.store.data.pens.forEach(i=>{var s,r;(s=i.realTimes)==null||s.forEach(o=>{if(o.bind&&o.bind.id){let n=o.productId||i.productId,c=o.deviceId||i.deviceId,a=o.propertyId,h=!1;if(n&&n.indexOf("${")>-1){let l=n.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));l!=null&&l.length&&(n=this.getDynamicParam(l[0])||n),h=!0}if(c&&c.indexOf("${")>-1){let l=c.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));l!=null&&l.length&&(c=this.getDynamicParam(l[0])||c),h=!0}if(a&&a.indexOf("${")>-1){let l=a.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));l!=null&&l.length&&(a=this.getDynamicParam(l[0])||a),h=!0}if(h&&o.bind&&(o.bind.id=n+"#"+c+"#"+a),this.store.bind[o.bind.id]||(this.store.bind[o.bind.id]=[]),this.store.bind[o.bind.id].push({id:i.id,key:o.key}),n&&c&&a){const l=this.jetLinksList.findIndex(u=>u.topic.startsWith(`/${n}/${c}`));l>-1?this.jetLinksList[l].properties.includes(o.propertyId)||this.jetLinksList[l].properties.push(o.propertyId):this.jetLinksList.push({topic:`/${n}/${c}`,deviceId:c,properties:[o.propertyId]})}if(o.bind.class==="iot"){let l=o.bind.id.split("#"),u=e.findIndex(f=>f.deviceId===l[0]);u>-1?e[u].properties.includes(l[1])||e[u].properties.push(l[1]):e.push({deviceId:l[0],properties:[l[1]],token:o.bind.token}),t.findIndex(f=>f.key===o.bind.id)===-1&&t.push({key:o.bind.id,label:o.bind.label})}else if(o.bind.class==="sql"){let l=o.bind.id.split("#");const u=this.store.data.sqls.find(d=>d.bindId===l[0]);if(u){u.keys||(u.keys=[]),l.shift();const d=l.join("#");u.keys.includes(d)||u.keys.push(d)}}}}),(r=i.events)==null||r.forEach(o=>{var c;const n=(c=o.actions)==null?void 0:c.filter(a=>a.action===EventAction.SendData);n==null||n.forEach(a=>{var h;(h=a.data)==null||h.forEach(l=>{if(l.class==="iot"){let u=l.prop.split("#"),d=e.findIndex(f=>f.deviceId===u[0]);d>-1?e[d].properties.includes(u[1])||e[d].properties.push(u[1]):e.push({deviceId:u[0],properties:[u[1]],token:l.token})}})})})}),e.length&&(this.store.data.iot||(this.store.data.iot={}),this.store.data.iot.devices=e),t.length&&(this.store.data.iot.list=t)}connectSocket(){this.connectWebsocket(),this.connectMqtt(),this.connectHttp()}doInitJS(){const e=this.store.data.initJs;if(e&&e.trim())try{new Function("context",e)({meta2d:this})}catch(t){console.warn("initJs error",t)}}doInitFn(){let e=queryURLParams(),t=[];for(let i in e)e.hasOwnProperty(i)&&i.startsWith("bind-")&&t.push({id:i.replace("bind-",""),dataId:i.replace("bind-",""),value:e[i]});t.length&&this.setDatas(t,{history:!1})}drawLine(e){e&&lockedError(this.store),this.canvas.drawingLineName=e}alignPenToGrid(e){this.canvas.alignPenToGrid(e)}drawingPencil(){this.canvas.drawingPencil()}stopPencil(){this.canvas.stopPencil()}lock(e){this.store.data.locked=e,this.finishDrawLine(!0),this.canvas.drawingLineName="",this.stopPencil(),this.store.data.pens.forEach(t=>{var i;t.externElement===!0&&(i=t.calculative.singleton)!=null&&i.div&&setElemPosition(t,t.calculative.singleton.div)}),e>0&&this.initMessageEvents()}async finishDrawLine(e){await this.canvas.finishDrawline(e)}async finishPencil(){await this.canvas.finishPencil()}updateLineType(e,t){if(!e||e.name!="line"||!t||!this.canvas[t])return;e.lineName=t;const i=getFromAnchor(e),s=getToAnchor(e);i.prev=void 0,i.next=void 0,s.prev=void 0,s.next=void 0,e.calculative.worldAnchors=[i,s],e.calculative.activeAnchor=i,this.canvas[t](this.store,e,s),e.lineName==="curve"&&(i.prev={penId:i.penId,x:i.x-50,y:i.y},i.next={penId:i.penId,x:i.x+50,y:i.y},s.prev={penId:s.penId,x:s.x-50,y:s.y},s.next={penId:s.penId,x:s.x+50,y:s.y}),e.calculative.activeAnchor=void 0,this.canvas.initLineRect(e),this.render()}addDrawLineFn(e,t){this.canvas[e]=t,this.canvas.drawLineFns.push(e)}removeDrawLineFn(e){const t=this.canvas.drawLineFns.indexOf(e);t>-1&&this.canvas.drawLineFns.splice(t,1)}showMagnifier(){this.canvas.showMagnifier()}hideMagnifier(){this.canvas.hideMagnifier()}toggleMagnifier(){this.canvas.toggleMagnifier()}clear(e=!0,t){var i;for(const s of this.store.data.pens)(i=s.onDestroy)==null||i.call(s,s);clearStore(this.store,t),this.hideInput(),this.canvas.tooltip.hide(),this.map&&this.map.isShow&&(this.map.show(),this.map.setView()),this.canvas.clearCanvas(),sessionStorage.removeItem("page"),this.store.clipboard=void 0,this.store.sameTemplate||(this.canvas.canvasTemplate.bgPatchFlags=!0),this.store.patchFlagsBackground=!0,this.store.patchFlagsTop=!0,this.setBackgroundImage(void 0),e&&this.render()}emit(e,t){this.store.emitter.emit(e,t)}on(e,t){return this.store.emitter.on(e,t),this}off(e,t){return this.store.emitter.off(e,t),this}updateLineAnimateDraws(e,t){t&&(delete this.store.data.lineAnimateDraws[e],delete globalStore.lineAnimateDraws[e],t!==-1&&this.registerLineAnimateDraws(t.name||e,t.code))}registerMoveDock(e){this.canvas.customMoveDock=e}registerResizeDock(e){this.canvas.customResizeDock=e}find(e){return this.canvas.find(e)}findOne(e){return this.canvas.findOne(e)}getPenRect(e){return this.canvas.getPenRect(e)}setPenRect(e,t,i=!0){this.canvas.setPenRect(e,t,i)}startAnimate(e,t){this.stopAnimate(e);let i;e?typeof e=="string"?i=this.find(e):i=e:i=this.store.data.pens.filter(s=>(s.type||s.frames)&&s.autoPlay||s.animations&&s.animations.length&&s.animations.findIndex(r=>r.autoPlay)!==-1),i.length&&(i.forEach(s=>{var r,o;if(s.calculative.pause){const n=Date.now()-s.calculative.pause;s.calculative.pause=void 0,s.calculative.frameStart+=n,s.calculative.frameEnd+=n}else{let n=-1;if(t!==void 0&&s.animations){if(typeof t=="string"){if(n=s.animations.findIndex(c=>c.name===t),n===-1)return}else if(typeof t=="number")if(s.animations.length>t)n=t;else return}else t===void 0&&(n=(r=s.animations)==null?void 0:r.findIndex(c=>c.autoPlay),n===-1&&((o=s.animations)!=null&&o.length)&&(n=0));if(n!==-1&&n!==void 0){const c=deepClone(s.animations[n]);c.animateName=c.name,delete c.name,c.currentAnimation=n,!s.type&&c.frames&&(c.showDuration=this.calcAnimateDuration(c)),this.setValue({id:s.id,...c},{doEvent:!1,history:!1})}this.store.animates.add(s),s.type||this.store.animateMap.set(s,s.calculative.canvas.getFrameProps(s))}}),this.initImageCanvas(i),this.canvas.animate())}pauseAnimate(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:this.store.animates.forEach(i=>{t.push(i)}),t.forEach(i=>{i.calculative.pause||(i.calculative.pause=Date.now())})}stopAnimate(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:this.store.animates.forEach(i=>{t.push(i)}),t.forEach(i=>{i.currentAnimation=void 0,i.calculative.pause=void 0,i.calculative.start=void 0,i.calculative.cycleStart=void 0,i.calculative.duration=void 0,i.calculative.animatePos=0,this.store.animates.delete(i),this.canvas.restoreNodeAnimate(i),this.canvas.updateLines(i),this.store.animateMap.delete(i)}),this.initImageCanvas(t),setTimeout(()=>{var i;(i=this.canvas)==null||i.calcActiveRect(),this.render()},20)}startVideo(e){let t;e?typeof e=="string"?t=this.find(e):t=e:t=this.store.data.pens.filter(i=>(i.video||i.audio)&&i.autoPlay),t.forEach(i=>{var s,r;(s=i.calculative.media)==null||s.play(),(r=i.onStartVideo)==null||r.call(i,i)})}pauseVideo(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:t=this.store.data.pens.filter(i=>(i.video||i.audio)&&i.autoPlay),t.forEach(i=>{var s,r;(s=i.calculative.media)==null||s.pause(),(r=i.onPauseVideo)==null||r.call(i,i)})}stopVideo(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:t=this.store.data.pens.filter(i=>(i.video||i.audio)&&i.autoPlay),t.forEach(i=>{var s;i.calculative.media&&(i.calculative.media.currentTime=0,i.calculative.media.pause()),(s=i.onStopVideo)==null||s.call(i,i)})}calcAnimateDuration(e){return e.frames.reduce((t,i)=>t+i.duration,0)}combine(e=this.store.active,t,i=!0){if(!e||!e.length)return;const s=deepClone(e);if(e.length===1&&e[0].type){e[0].type=PenType.Node,this.canvas.active(e),this.pushHistory({type:EditType.Update,initPens:s,pens:deepClone(e,!0)}),this.render();return}const r=getRect$1(e);let o={id:s8(),name:"combine",...r,children:[],showChild:t};this.canvas.makePen(o);const n=deepClone(o);let c=1/0;return e.forEach(a=>{const h=this.store.data.pens.findIndex(u=>u.id===a.id);if(h<c&&(c=h),a===o||a.parentId===o.id||a.id===o.id)return;o.children.push(a.id),a.parentId=o.id;const l=calcRelativeRect(a.calculative.worldRect,r);Object.assign(a,l),a.locked=a.lockedOnCombine??LockState.None,a.locked=a.interaction||isInteraction.includes(a.name)?0:a.locked}),this.store.data.pens.splice(c,0,o),this.store.data.pens.pop(),i&&this.canvas.active([o]),this.pushHistory({type:EditType.Add,pens:[n],step:3}),this.pushHistory({type:EditType.Update,initPens:[n],pens:[o],step:3}),this.pushHistory({type:EditType.Update,initPens:s,pens:e,step:3}),t!=null&&(e.forEach(a=>{calcInView(a,!0)}),this.initImageCanvas([o])),this.store.emitter.emit("combine",[o]),this.render(),o}uncombine(e){if(!e&&this.store.active&&(e=this.store.active[0]),!e||!e.children)return;const t=e.children.map(r=>this.store.pens[r]);let i=deepClone(t);t.forEach(r=>{r.parentId=void 0,r.x=r.calculative.worldRect.x,r.y=r.calculative.worldRect.y,r.width=r.calculative.worldRect.width,r.height=r.calculative.worldRect.height,r.locked=LockState.None,r.calculative.active=void 0,r.calculative.hover=!1,this.setVisible(r,!0)});const s=this.isCombine(e)?3:2;this.pushHistory({type:EditType.Update,initPens:i,pens:t,step:s}),i=[deepClone(e)],e.children=void 0,this.pushHistory({type:EditType.Update,initPens:i,pens:[e],step:s}),this.isCombine(e)&&(this.delete([e]),this.store.histories[this.store.histories.length-1].step=s),this.inactive()}clearCombine(e){if(!e&&this.store.active&&(e=this.store.active[0]),!e||!e.children)return;const t=getAllChildren(e,this.store);t.forEach(s=>{s.parentId=void 0,s.x=s.calculative.worldRect.x,s.y=s.calculative.worldRect.y,s.width=s.calculative.worldRect.width,s.height=s.calculative.worldRect.height,s.locked=LockState.None,s.calculative.active=void 0,s.calculative.hover=!1,s.showChild!==void 0&&this.setVisible(s,!0),s.children=void 0});const i=[];t.forEach((s,r)=>{s.name==="combine"&&(s.children=void 0,i.push(s))}),this.delete(i,!0,!1),e.children=void 0,this.isCombine(e)&&this.delete([e],!0,!1),this.inactive()}appendChild(e=this.store.active){if(!e||e.length<2)return;const t=e.findIndex(i=>i.name==="combine"&&i.showChild!==void 0);if(t!==-1){let i=e[t];const s=getRect$1(e);Object.assign(i,s),Object.assign(i.calculative.worldRect,s),calcWorldAnchors(i),i.children.forEach(r=>{const o=this.store.pens[r],n=calcRelativeRect(o.calculative.worldRect,s);Object.assign(o,n)}),e.forEach(r=>{if(r.id!==i.id){i.children.push(r.id),r.parentId=i.id;const o=calcRelativeRect(r.calculative.worldRect,s);Object.assign(r,o),r.locked=r.lockedOnCombine??LockState.DisableMove,r.locked=r.interaction||isInteraction.includes(r.name)?0:r.locked,calcInView(r,!0)}}),this.initImageCanvas(e),this.render()}else console.warn("Invalid operation!")}updateRectbyChild(e,t,i){if(calcRightBottom(e),calcCenter(e),t.calculative.worldRect=e,rectInRect(e,i.calculative.worldRect,!0)){const s=calcRelativeRect(e,i.calculative.worldRect);Object.assign(t,s)}else{let s=Math.min(e.x,i.calculative.worldRect.x),r=Math.min(e.y,i.calculative.worldRect.y),o=Math.max(e.ex,i.calculative.worldRect.ex),n=Math.max(e.ey,i.calculative.worldRect.ey);i.calculative.worldRect={x:s,y:r,width:o-s,height:n-r,ex:o,ey:n},i.parentId||Object.assign(i,i.calculative.worldRect),calcCenter(i.calculative.worldRect),i.children.forEach(c=>{const a=this.store.pens[c],h=calcRelativeRect(a.calculative.worldRect,i.calculative.worldRect);Object.assign(a,h)}),i.parentId&&this.updateRectbyChild(i.calculative.worldRect,i,this.store.pens[i.parentId])}this.canvas.updatePenRect(i),this.render()}isCombine(e){return!!(e.name==="combine"||e.children&&e.children.length>0)}active(e,t=!0){this.canvas.active(e,t)}inactive(){this.canvas.inactive()}activeAll(){this.canvas.active(this.store.data.pens.filter(e=>!e.parentId&&e.locked!==LockState.Disable)),this.render()}focus(e){const t=this.findOne(e);t&&(this.store.hover=t,this.store.hover.calculative.hover=!0,this.showInput(t))}delete(e,t=!1,i=!0){this.canvas.delete(e,t,i)}scale(e,t={x:0,y:0}){this.canvas.scale(e,t)}translate(e,t){this.canvas.translate(e,t)}translatePens(e,t,i){this.canvas.translatePens(e,t,i)}getParent(e,t){return getParent(e,t)}getAllChildren(e){return getAllChildren(e,this.store)}getAllFollowers(e){return getAllFollowers(e,this.store)}data(){const e=deepClone(this.store.data),{pens:t,paths:i}=this.store.data;e.version=pkg.version,e.paths={};for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&t.find(r=>r.pathId===s)&&(e.paths[s]=i[s]);return e.dataPoints=[...Object.keys(this.store.bind),...Object.keys(this.store.bindDatas)],Object.entries(globalStore.lineAnimateDraws).forEach(([s,r])=>{e.lineAnimateDraws[s]=r.toString()}),e}copy(e){this.canvas.copy(e)}cut(e){this.canvas.cut(e)}paste(){this.canvas.paste()}undo(){this.canvas.undo()}redo(){this.canvas.redo()}listenSocket(){try{let e;const t=this.store.data.socketCbJs;if(t&&(e=new Function("e","context",t)),!e)return this.socketFn=null,!1;this.socketFn=e}catch(e){return console.error("Create the function for socket:",e),!1}return!0}connectWebsocket(e){this.closeWebsocket(),e&&(this.store.data.websocket=e),this.store.data.websocket&&(this.websocket=new WebSocket(this.store.data.websocket,this.store.data.websocketProtocols||void 0),this.websocket.onmessage=t=>{this.socketCallback(t.data,{type:"websocket",url:this.store.data.websocket})},this.websocket.onerror=t=>{this.store.emitter.emit("error",{type:"websocket",error:t})},this.websocket.onclose=()=>{if(this.store.options.reconnetTimes&&(this.websocketTimes++,this.websocketTimes>=this.store.options.reconnetTimes)){this.websocketTimes=0,this.closeWebsocket();return}console.info("Canvas websocket closed and reconneting..."),this.connectWebsocket()})}closeWebsocket(){this.websocket&&(this.websocket.onclose=void 0,this.websocket.close(),this.websocket=void 0)}connectMqtt(e){if(this.closeMqtt(),e&&(this.store.data.mqtt=e.mqtt,this.store.data.mqttTopics=e.mqttTopics,this.store.data.mqttOptions=e.mqttOptions),this.store.data.mqtt){this.store.data.mqttOptions.clientId&&!this.store.data.mqttOptions.customClientId&&(this.store.data.mqttOptions.clientId=s8());const t={...this.store.data.mqttOptions};t.username||delete t.username,t.password||delete t.password;const{username:i,password:s}=t;i&&s||!i&&!s?(this.mqttClient=mqtt_minExports.connect(this.store.data.mqtt,t),this.mqttClient.on("message",(r,o)=>{this.socketCallback(o.toString(),{topic:r,type:"mqtt",url:this.store.data.mqtt})}),this.mqttClient.on("error",r=>{this.store.emitter.emit("error",{type:"mqtt",error:r})}),this.mqttClient.on("close",()=>{this.store.options.reconnetTimes&&(this.mqttTimes++,this.mqttTimes>=this.store.options.reconnetTimes&&(this.mqttTimes=0,this.closeMqtt()))}),this.store.data.mqttTopics&&this.mqttClient.subscribe(this.store.data.mqttTopics.split(","))):console.warn("")}}closeMqtt(){var e;(e=this.mqttClient)==null||e.end()}connectHttp(){this.closeHttp();const{https:e}=this.store.data;if(e)this.store.data.cancelFirstConnect||e.forEach(async t=>{this.oldRequestHttp(t)}),e.forEach((t,i)=>{t.http&&t.httpTimeInterval!==0&&(t.times=0,this.httpTimerList[i]=setInterval(async()=>{this.oldRequestHttp(t),this.store.options.reconnetTimes&&t.times>=this.store.options.reconnetTimes&&(t.times=0,clearInterval(this.httpTimerList[i]),this.httpTimerList[i]=void 0)},t.httpTimeInterval||1e3))});else{const{http:t,httpTimeInterval:i,httpHeaders:s}=this.store.data;t&&(this.httpTimer=setInterval(async()=>{const r=await fetch(t,{headers:s});if(r.ok){const o=await r.text();this.socketCallback(o,{type:"http",url:t})}},i||1e3))}}async oldRequestHttp(e){let t=deepClone(e);if(t.http){const i=await fetch(t.http,{headers:t.httpHeaders,method:t.method||"GET",body:t.method==="POST"?JSON.stringify(t.body):void 0});if(i.ok){const s=await i.text();this.socketCallback(s,{type:"http",url:t.http})}else e.times++,this.store.emitter.emit("error",{type:"http",error:i})}}async sendDatabyHttp(e){const{https:t}=this.store.data;if(t)t.forEach(async i=>{i.http&&(await fetch(i.http,{method:"post",body:e,headers:i.httpHeaders})).ok&&console.info("http")});else{const{http:i,httpHeaders:s}=this.store.data;i&&(await fetch(i,{method:"post",body:e,headers:s})).ok&&console.info("http")}}closeHttp(){clearInterval(this.httpTimer),this.httpTimer=void 0,this.httpTimerList&&this.httpTimerList.forEach(e=>{clearInterval(e),e=void 0})}connectNetwork(){this.closeNetwork();const{networks:e}=this.store.data,t=[];if(e){let i=0,s=0,r=0,o=0;this.mqttClients=[],this.websockets=[],this.eventSources=[],e.forEach(async n=>{n.protocol==="mqtt"?(n.index=i,this.connectNetMqtt(n),i+=1):n.protocol==="websocket"?(n.index=r,this.connectNetWebSocket(n),r+=1):n.protocol==="http"?(n.index=s,t.push({url:n.url,interval:n.interval,headers:n.headers||void 0,method:n.method,body:n.body}),s+=1):n.protocol==="ADIIOT"?connectJetLinks(this,n):n.protocol==="SSE"&&(n.index=o,this.connectSSE(n),o+=1)})}this.onNetworkConnect(t),this.connectIot(),this.connectSqls()}reconnectNetwork(e){var i,s;const t=this.store.data.networks[e];if(t.protocol==="mqtt")this.mqttClients&&((i=this.mqttClients[t.index])==null||i.end()),this.connectNetMqtt(t);else if(t.protocol==="websocket")this.websockets&&this.websockets[t.index]&&(this.websockets[t.index].onclose=void 0,this.websockets[t.index].close(),this.websockets[t.index]=void 0),this.connectNetWebSocket(t);else if(t.protocol==="http"){this.updateTimerList&&(clearInterval(this.updateTimerList[t.index]),this.updateTimerList[t.index]=void 0);const r=deepClone(t);this.store.data.cancelFirstConnect||this.requestHttp(r),this.updateTimerList[t.index]=setInterval(async()=>{this.requestHttp(r)},r.interval||1e3)}else t.protocol==="SSE"&&(this.eventSources&&((s=this.eventSources[t.index])==null||s.close(),this.eventSources[t.index]=void 0),this.connectSSE(t))}async connectIot(){var s;const{iot:e}=this.store.data;if(!(e&&((s=e==null?void 0:e.devices)!=null&&s.length)))return;const t=globalThis.iotUrl||await this.getMqttUrl();if(!t){console.warn("iot Request address error");return}const i=await this.getIotToken(e.devices,e.protocol==="websocket"?1:void 0);e.token=i,this.iotMqttClient=mqtt_minExports.connect(t),this.iotMqttClient.on("message",(r,o)=>{this.socketCallback(o.toString(),{topic:`le5le-iot/properties/${i}`,type:"iot",url:t,method:"mqtt"})}),this.iotMqttClient.on("error",r=>{this.store.emitter.emit("error",{type:"mqtt",error:r})}),this.iotMqttClient.subscribe(`le5le-iot/properties/${i}`),this.iotTimer=setInterval(()=>{this.iotMqttClient&&this.iotMqttClient.publish("le5le-iot/subscribe/ping",i)},3e5)}connectSqls(){const{sqls:e}=this.store.data;if(e&&e.length){let t=0;e.forEach(async i=>{await this.doSqlCode(i),i.interval&&(i.index=t,this.sqlTimerList[t]=setInterval(async()=>{await this.doSqlCode(i)},i.interval),t+=1)})}}connectSSE(e){this.eventSources[e.index]=new EventSource(e.url,{withCredentials:e.withCredentials}),this.eventSources[e.index].onmessage=t=>{this.socketCallback(t.data,{type:"SSE",url:e.url,name:e.name})},this.eventSources[e.index].onerror=t=>{this.store.emitter.emit("error",{type:"SSE",error:t})}}closeSSE(){this.eventSources&&this.eventSources.forEach(e=>{e&&(e.close(),e=void 0)})}connectNetMqtt(e){var s,r,o,n;e.options.clientId&&!e.options.customClientId&&(e.options.clientId=s8());let t=e.url;if(t.indexOf("${")>-1){let c=(s=t.match(/\$\{([^}]+)\}/g))==null?void 0:s.map(a=>a.slice(2,-1));c&&c.forEach(a=>{t=t.replace(`\${${a}}`,this.getDynamicParam(a))})}e.times=0;let i=deepClone(e.options);if(i!=null&&i.username&&i.username.includes("${")){let c=(r=i.username.match(/\$\{([^}]+)\}/g))==null?void 0:r.map(a=>a.slice(2,-1));c&&c.forEach(a=>{i.username=i.username.replace(`\${${a}}`,this.getDynamicParam(a))})}if(i!=null&&i.password&&i.password.includes("${")){let c=(o=i.password.match(/\$\{([^}]+)\}/g))==null?void 0:o.map(a=>a.slice(2,-1));c&&c.forEach(a=>{i.password=i.password.replace(`\${${a}}`,this.getDynamicParam(a))})}if(this.mqttClients[e.index]=mqtt_minExports.connect(t,i),this.mqttClients[e.index].on("message",(c,a)=>{this.socketCallback(a.toString(),{topic:c,type:"mqtt",url:e.url,name:e.name})}),this.mqttClients[e.index].on("error",c=>{this.store.emitter.emit("error",{type:"mqtt",error:c})}),this.mqttClients[e.index].on("close",()=>{var c;this.store.options.reconnetTimes&&(e.times++,e.times>=this.store.options.reconnetTimes&&(e.times=0,this.mqttClients&&((c=this.mqttClients[e.index])==null||c.end())))}),e.topics){let c=e.topics;if(c.indexOf("${")>-1){let a=(n=c.match(/\$\{([^}]+)\}/g))==null?void 0:n.map(h=>h.slice(2,-1));a&&a.forEach(h=>{c=c.replace(`\${${h}}`,this.getDynamicParam(h))})}this.mqttClients[e.index].subscribe(c.split(","))}}connectNetWebSocket(e){var i,s;this.websockets[e.index]&&(this.websockets[e.index].onclose=void 0,(i=this.websockets[e.index])==null||i.close(),this.websockets[e.index]=void 0);let t=e.url;if(t.indexOf("${")>-1){let r=(s=t.match(/\$\{([^}]+)\}/g))==null?void 0:s.map(o=>o.slice(2,-1));r&&r.forEach(o=>{t=t.replace(`\${${o}}`,this.getDynamicParam(o))})}this.websockets[e.index]=new WebSocket(t,e.protocols||void 0),this.websockets[e.index].onmessage=r=>{this.socketCallback(r.data,{type:"websocket",url:e.url,name:e.name})},this.websockets[e.index].onerror=r=>{this.store.emitter.emit("error",{type:"websocket",error:r})},this.websockets[e.index].onclose=()=>{var r;if(this.store.options.reconnetTimes&&(e.times++,e.times>=this.store.options.reconnetTimes)){e.times=0,this.websockets[e.index].onclose=void 0,(r=this.websockets[e.index])==null||r.close(),this.websockets[e.index]=void 0;return}setTimeout(()=>{console.info("Canvas websocket closed and reconneting..."),this.connectNetWebSocket(e)},2e3)}}async getMqttUrl(){const e=await fetch("/api/iot/app/mqtt",{method:"GET",headers:{Authorization:`Bearer ${getToken()}`}});if(e.ok){const t=await e.text();let i=JSON.parse(t);return i.wssPort||i.wsPort?`${location.protocol==="https:"?"wss":"ws"}://${i.host}:${location.protocol==="https:"?i.wssPort:i.wsPort}${i.path}`:void 0}}async getIotToken(e,t){const i=await fetch("/api/iot/subscribe/properties",{method:"POST",headers:{Authorization:`Bearer ${getToken()}`},body:JSON.stringify({devices:e,type:t})});if(i.ok){const s=await i.text();return JSON.parse(s).token}}async doSqlCode(e){var r;const t=e.method||"get";let i=e.sql;t==="list"&&(i+=` LIMIT ${e.pageSize||20}`+(e.current>1?" OFFSET "+(e.current-1)*e.pageSize:""));const s=await fetch(`/api/iot/data/sql/${t}`,{method:"POST",headers:{Authorization:`Bearer ${getCookie("token")||localStorage.getItem("token")||new URLSearchParams(location.search).get("token")||""}`},body:JSON.stringify({dbid:e.dbid,sql:i})});if(s.ok){let o=await s.text();if(o){const n=[];o=JSON.parse(o),(r=e.keys)==null||r.forEach(c=>{n.push({id:e.bindId+"#"+c,value:getter(o,c.split("#").join("."))})}),n.push({id:e.bindId,value:o}),this.socketCallback(JSON.stringify(n),{type:"sql",url:`/api/iot/data/sql/${t}`,method:t})}}}randomString(e){e=e||32;let t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",i=t.length,s="";for(let r=0;r<e;r++)s+=t.charAt(Math.floor(Math.random()*i));return s}mockValue(e){let t;if(e.enableMock&&e.mock!==void 0)if(e.type==="float")if(e.mock&&e.mock.indexOf(",")!==-1){let i=e.mock.split(","),s=Math.floor(Math.random()*i.length);t=parseFloat(i[s])}else if(e.mock&&e.mock.indexOf("-")!==-1){let i,s,r,o=e.mock.split("-");if(e.mock.charAt(0)==="-"?o.length===4?(i=-parseFloat(o[3]),s=-parseFloat(o[1]),r=o[3]):(i=parseFloat(o[2]),s=-parseFloat(o[1]),r=o[2]):(i=parseFloat(o[1]),s=parseFloat(o[0]),r=o[1]),(r+"").indexOf(".")!==-1){let n=(r+"").split(".")[1].length;t=(Math.random()*(i-s)+s).toFixed(n)}else t=Math.random()*(i-s)+s}else t=parseFloat(e.mock);else if(e.type==="integer")if(e.mock&&e.mock.indexOf(",")!==-1){let i=e.mock.split(","),s=Math.floor(Math.random()*i.length);t=parseInt(i[s])}else if(e.mock&&e.mock.indexOf("-")!==-1){let i,s,r=e.mock.split("-");e.mock.charAt(0)==="-"?r.length===4?(i=-parseFloat(r[3]),s=-parseFloat(r[1])):(i=parseFloat(r[2]),s=-parseFloat(r[1])):(i=parseInt(r[1]),s=parseInt(r[0])),t=parseInt(Math.random()*(i-s)+s+"")}else t=parseInt(e.mock);else if(e.type==="bool")typeof e.mock=="boolean"?t=e.mock:e.mock==="true"?t=!0:e.mock==="false"?t=!1:t=Math.random()<.5;else if(e.type==="object"||e.type==="array")e.mock;else if(e.mock&&e.mock.indexOf(",")!==-1){let i=e.mock.split(","),s=Math.floor(Math.random()*i.length);t=i[s]}else if(e.mock&&e.mock.startsWith("[")&&e.mock.endsWith("]")){let i=parseInt(e.mock.substring(1,e.mock.length-1));t=this.randomString(i)}else t=e.mock;return t}dataMock(){var t,i;let e=[];(i=(t=this.store.data.dataset)==null?void 0:t.devices)==null||i.forEach(s=>{let r=this.mockValue(s);r!==void 0&&e.push({id:s.id,value:r})}),e.length&&this.setDatas(e,{render:!0,doEvent:!0,history:!1})}startDataMock(){this.store.data.enableMock&&(this.stopDataMock(),this.initBinds(),this.updateTimer=setInterval(()=>{this.store.data.pens.forEach(t=>{this.penMock(t)}),this.dataMock(),this.render()},this.store.data.networkInterval||1e3))}stopDataMock(){clearInterval(this.updateTimer),this.updateTimer=void 0}penMock(e){var t;if(e.realTimes){let i={};if(e.realTimes.forEach(s=>{let r=this.mockValue(s);r!==void 0&&(i[s.key]=r)}),Object.keys(i).length){let s=e.onBeforeValue?e.onBeforeValue(e,i):i;this.canvas.updateValue(e,s),(t=e.onValue)==null||t.call(e,e),this.store.emitter.emit("valueUpdate",e)}}}penNetwork(e){const t={url:e.apiUrl,method:e.apiMethod,headers:e.apiHeaders,body:e.apiBody};this.requestHttp(t),e.apiEnable?(this.store.pensNetwork||(this.store.pensNetwork={}),this.store.pensNetwork[e.id]=t):delete this.store.pensNetwork[e.id]}getDynamicParam(e){return queryURLParams()[e]||localStorage[e]||getCookie(e)||globalThis[e]||""}onNetworkConnect(e){if(e&&e.length){if(this.store.pensNetwork)for(let t in this.store.pensNetwork)e.push(this.store.pensNetwork[t]);this.store.data.cancelFirstConnect||e.forEach(async t=>{this.requestHttp(t)}),e.forEach((t,i)=>{t.times=0,t.interval!==0&&(this.updateTimerList[i]=setInterval(async()=>{this.requestHttp(t),this.store.options.reconnetTimes&&t.times>=this.store.options.reconnetTimes&&(t.times=0,clearInterval(this.updateTimerList[i]),this.updateTimerList[i]=void 0)},t.interval||1e3))})}}async requestHttp(e){var i,s,r;let t=deepClone(e);if(t.url){if(t.url.indexOf("${")>-1){let n=(i=t.url.match(/\$\{([^}]+)\}/g))==null?void 0:i.map(c=>c.slice(2,-1));n&&n.forEach(c=>{t.url=t.url.replace(`\${${c}}`,this.getDynamicParam(c))})}if(typeof t.headers=="object"){for(let n in t.headers)if(typeof t.headers[n]=="string"){let c=(s=t.headers[n].match(/\$\{([^}]+)\}/g))==null?void 0:s.map(a=>a.slice(2,-1));c&&(t.headers[n]=t.headers[n].replace(`\${${c[0]}}`,this.getDynamicParam(c[0])))}}if(typeof t.body=="object"){for(let n in t.body)if(typeof t.body[n]=="string"){let c=(r=t.body[n].match(/\$\{([^}]+)\}/g))==null?void 0:r.map(a=>a.slice(2,-1));c&&(t.body[n]=t.body[n].replace(`\${${c[0]}}`,this.getDynamicParam(c[0])))}}const o=await fetch(t.url,{headers:t.headers,method:t.method,body:t.method==="GET"?void 0:JSON.stringify(t.body)});if(o.ok){const n=await o.text();this.socketCallback(n,{type:"http",url:t.url,name:t.name})}else e.times++,this.store.emitter.emit("error",{type:"http",error:o})}}closeNetwork(){this.mqttClients&&this.mqttClients.forEach(e=>{e.end()}),this.websockets&&this.websockets.forEach(e=>{e&&(e.onclose=void 0,e.close(),e=void 0)}),this.mqttClients=void 0,this.websockets=void 0,this.updateTimerList&&this.updateTimerList.forEach(e=>{clearInterval(e),e=void 0}),this.sqlTimerList&&this.sqlTimerList.forEach(e=>{clearInterval(e),e=void 0}),this.iotMqttClient&&(this.iotMqttClient.end(),this.iotMqttClient=void 0),clearInterval(this.iotTimer),this.iotTimer=void 0,closeJetLinks(this),this.closeSSE()}socketCallback(e,t){this.store.emitter.emit("socket",{message:e,context:t});let i=e;if(this.socketFn&&(i=this.socketFn(e,{meta2d:this,type:t.type,topic:t.topic,url:t.url,method:t.method}),!i))return;i===!0&&(i=e);let s;if(i.constructor===Object||i.constructor===Array)s=i;else if(typeof i=="string")try{s=JSON.parse(i)}catch(r){console.warn("Invalid socket data:",s,r)}else return;s&&(Array.isArray(s)||(s=[s]),s.length&&(s[0].dataId?this.setDatas(s):s.forEach(r=>{this.setValue(r)})))}setDatas(e,{render:t=!0,doEvent:i=!0,history:s}={}){const r=new Map;e.forEach(c=>{var a,h;(a=this.store.bindDatas[c.dataId])==null||a.forEach(l=>{const u=this.store.pens[l.id];if(!u)return;let d=r.get(u);if(!u.noOnBinds&&typeof u.onBinds=="function"){if(d)return;r.set(u,u.onBinds(u,e,l.formItem));return}d?d[l.formItem.key]=c.value:(d={id:l.id,[l.formItem.key]:c.value},r.set(u,d))}),(h=this.store.bind[c.id||c.dataId])==null||h.forEach(l=>{const u=this.store.pens[l.id];if(!u)return;let d=r.get(u);d?d[l.key]=c.value:(d={id:l.id,[l.key]:c.value},r.set(u,d))})}),this.store.data.locked&&this.doDataEvent(e);let o,n;s&&(o=[]),r.forEach((c,a)=>{this.setValue(c,{render:!1,doEvent:i,history:!1}),s&&(o.push(deepClone(a,!0)),n.push(a))}),t&&this.render(),s&&this.pushHistory({type:EditType.Update,initPens:o,pens:n})}setValue(e,{render:t=!0,doEvent:i=!0,history:s}={}){let r=[];if(!e)return;if(e.id){if(e.id===this.store.data.id){this.setDatabyOptions(e),e.bkImage&&this.setBackgroundImage(e.bkImage),e.background&&this.setBackgroundColor(e.background),this.render();return}const n=this.store.pens[e.id];if(n)r=[n];else{let c=this.store.bind[e.id];if(c&&c.length){r=[],this.setDatas([e],{render:t,doEvent:i,history:s});return}}}else if(e.dataId){r=[],this.setDatas([e],{render:t,doEvent:i,history:s});return}else if(e.tag)r=this.find(e.tag);else{let n=[];for(let c in e)n.push({dataId:c,id:c,value:e[c]});n.length&&this.setDatas(n,{render:t,doEvent:i,history:s});return}s=s&&!this.store.data.locked;let o;if(s&&(o=deepClone(r)),r.forEach(n=>{var a;const c=n.onBeforeValue?n.onBeforeValue(n,e):e;e.frames&&(this.stopAnimate([n]),e.showDuration||(e.showDuration=e.frames.reduce((h,l)=>h+l.duration,0))),setChildValue(n,c),this.canvas.updateValue(n,c),(a=n.onValue)==null||a.call(n,n)}),!this.store.data.locked&&this.store.active.length&&!this.canvas.movingPens&&this.canvas.calcActiveRect(),s){let n=deepClone(r);this.pushHistory({type:EditType.Update,initPens:o,pens:n})}i&&r.forEach(n=>{this.store.emitter.emit("valueUpdate",n)}),t&&this.render()}_setValue(e,t=!1){this.setValue(e,{history:t,render:!1,doEvent:!1})}pushHistory(e){this.canvas.pushHistory(e)}showInput(e,t){this.canvas.showInput(e,t)}hideInput(){this.canvas.hideInput()}clearDropdownList(){this.canvas.clearDropdownList()}clearRuleLines(){this.canvas.clearRuleLines()}doMessageEvent(e,t){this.store.messageEvents[e]&&this.store.messageEvents[e].forEach(i=>{let s=!1;i.event.conditions&&i.event.conditions.length?i.event.conditionType==="and"?s=i.event.conditions.every(r=>this.judgeCondition(i.pen,r.key,r)):i.event.conditionType==="or"&&(s=i.event.conditions.some(r=>this.judgeCondition(i.pen,r.key,r))):s=!0,s&&i.event.actions.forEach(r=>{this.events[r.action](i.pen,r,t)})})}initGlobalTriggers(){var e;this.store.globalTriggers={},(e=this.store.data.triggers)==null||e.forEach(t=>{t.conditions.forEach(i=>{i.source&&(this.store.globalTriggers[i.source]||(this.store.globalTriggers[i.source]=[]),this.store.globalTriggers[i.source].includes(t)||this.store.globalTriggers[i.source].push(t))})})}initMessageEvents(){this.store.messageEvents={},this.store.data.pens.forEach(e=>{var t;(t=e.events)==null||t.forEach(i=>{i.name==="message"&&i.message&&(this.store.messageEvents[i.message]||(this.store.messageEvents[i.message]=[]),this.store.messageEvents[i.message].push({pen:e,event:i}))})})}dataJudegeCondition(e,t,i){const{type:s,target:r,fnJs:o,fn:n,operator:c,valueType:a}=i;let h=!1;if(s==="fn"){if(n)h=n(e,{meta2d:this});else if(o){try{i.fn=new Function("data","context",o)}catch(l){console.error("Error: make function:",l)}i.fn&&(h=i.fn(e,{meta2d:this}))}}else{let l=i.value;a==="prop"&&(l=e[i.value]);let u=e[t];switch(c){case">":h=u>+l;break;case">=":h=u>=+l;break;case"<":h=u<+l;break;case"<=":h=u<=+l;break;case"=":case"==":h=u==l;break;case"!=":h=u!=l;break;case"[)":h=valueInRange(+u,l);break;case"![)":h=!valueInRange(+u,l);break;case"[]":h=valueInArray(u,l);break;case"![]":h=!valueInArray(u,l);break}}return h}judgeCondition(e,t,i){const{type:s,target:r,fnJs:o,fn:n,operator:c,valueType:a}=i;let h=!1;if(s==="fn"){if(n)h=n(e,{meta2d:this});else if(o){try{i.fn=new Function("pen","context",o)}catch(l){console.error("Error: make function:",l)}i.fn&&(h=i.fn(e,{meta2d:this}))}}else{let l=i.value;a==="prop"&&(l=this.store.pens[r][i.value]);let u=getter(e,t);switch(["x","y","width","height"].includes(t)&&(u=this.getPenRect(e)[t]),c){case">":h=u>+l;break;case">=":h=u>=+l;break;case"<":h=u<+l;break;case"<=":h=u<=+l;break;case"=":case"==":h=u==l;break;case"!=":h=u!=l;break;case"[)":h=valueInRange(+u,l);break;case"![)":h=!valueInRange(+u,l);break;case"[]":h=valueInArray(u,l);break;case"![]":h=!valueInArray(u,l);break}}return h}pushChildren(e,t){const i=[deepClone(e,!0)],s=[];e.children||(e.children=[]);const r=[];t.forEach(n=>{let c=deepClone(n,!0);if((!n.id||!this.store.pens[n.id])&&(this.canvas.makePen(n),c=null),n.parentId){const h=this.store.pens[n.parentId],l=h.children.findIndex(u=>u===n.id);i.push(deepClone(h,!0)),h.children.splice(l,1),r.push(deepClone(h,!0))}e.children.push(n.id),n.parentId=e.id;const a=calcRelativeRect(n.calculative.worldRect,e.calculative.worldRect);Object.assign(n,a),n.locked=n.lockedOnCombine??LockState.DisableMove,n.locked=n.interaction||isInteraction.includes(n.name)?0:n.locked,c?(i.push(c),r.push(deepClone(n,!0))):s.push(deepClone(n,!0))}),r.push(deepClone(e,!0));let o=1;s.length&&(o=2,this.pushHistory({type:EditType.Add,pens:s,step:o})),this.pushHistory({type:EditType.Update,initPens:i,pens:r,step:o})}toPng(e,t,i=!1,s){return this.canvas.toPng(e,t,i,s)}activeToPng(e,t){return this.canvas.activeToPng(e,t)}pensToPng(e=this.store.active,t,i){return this.canvas.pensToPng(e,t,i)}downloadPng(e,t,i){var s;for(const r of this.store.data.pens)(r.calculative.img||["iframe"].includes(r.name))&&((s=r.onRenderPenRaw)==null||s.call(r,r));setTimeout(()=>{const r=document.createElement("a");r.setAttribute("download",(e||this.store.data.name||"le5le.meta2d")+".png"),r.setAttribute("href",this.toPng(t,void 0,!0,i));const o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),r.dispatchEvent(o)},1e3)}downloadSvg(){if(!window.C2S)throw console.error("canvas2svg.js","https://assets.le5lecdn.com/2d/canvas2svg.js"),new Error("canvas2svg.js");let e=!1;const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;t&&i&&!this.store.data.component&&(e=!0);const s=this.getRect();e&&(s.x=this.store.data.origin.x,s.y=this.store.data.origin.y,s.width=t*this.store.data.scale,s.height=i*this.store.data.scale),s.x-=10,s.y-=10;const r=new window.C2S(s.width+20,s.height+20);r.textBaseline="middle",r.strokeStyle=this.store.styles.color;const o=this.store.data.background||this.store.styles.background;o&&e&&(r.save(),r.fillStyle=o,r.fillRect(0,0,s.width,s.height),r.restore()),this.store.bkImg&&e&&r.drawImage(this.store.bkImg,0,0,s.width,s.height),o&&!e&&(r.save(),r.fillStyle=o,r.fillRect(0,0,s.width+20,s.height+20),r.restore());for(const d of this.store.data.pens)d.visible==!1||!isShowChild(d,this.store)||d.name==="combine"&&!d.draw||renderPenRaw$1(r,d,s,!0);let n=r.getSerializedSvg();this.store.data.background?(n=n.replace("{{bk}}",""),n=n.replace("{{bkRect}}",`<rect x="0" y="0" width="100%" height="100%" fill="${this.store.data.background}"></rect>`)):(n=n.replace("{{bk}}",""),n=n.replace("{{bkRect}}","")),n=n.replace(/--le5le--/g,"&#x");const c=window.URL,a=new Blob([n]),h=c.createObjectURL(a),l=document.createElement("a");l.setAttribute("download",`${this.store.data.name||"le5le.meta2d"}.svg`),l.setAttribute("href",h);const u=document.createEvent("MouseEvents");u.initEvent("click",!0,!0),l.dispatchEvent(u)}getRect(e=this.store.data.pens){return getRect$1(e)}hiddenTemplate(){this.canvas.canvasTemplate.hidden()}showTemplate(){this.canvas.canvasTemplate.show()}lockTemplate(e){this.store.data.pens.forEach(t=>{t.canvasLayer===CanvasLayer.CanvasTemplate&&(t.locked=e)})}fitView(e=!0,t=10){var l,u;if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:r}=i;this.resize(s,r);const o=formatPadding(t),n=this.getRect(),c=(s-o[1]-o[3])/n.width,a=(r-o[0]-o[2])/n.height;let h=c;e?h=c>a?a:c:h=c>a?c:a,(l=this.store.data.fits)!=null&&l.length&&(this.canvas.opening=!0),this.scale(h*this.store.data.scale),this.centerView(),(u=this.store.data.fits)!=null&&u.length&&this.fillView()}fillView(){var s,r;const e=this.getRect(),t=this.canvas.width-e.width,i=this.canvas.height-e.height;if(Math.abs(t)>10){(s=this.store.data.fits)==null||s.forEach(n=>{let c=[];n.children.forEach(h=>{this.store.pens[h]&&(this.store.pens[h].locked=LockState.None,c.push(this.store.pens[h]))});let a=t/2;if(n.left&&n.right){let h=n.leftValue,l=n.rightValue;h?h=Math.abs(h)<1?h*this.canvas.width:h:h=0,l?l=Math.abs(l)<1?l*this.canvas.width:l:l=0;let u=(this.canvas.width-h-l)/(e.width-h-l);c.forEach(d=>{var f,g;d.image&&d.imageRatio&&d.calculative.worldRect.width/this.canvas.width>.1&&(d.imageRatio=!1),d.calculative.worldRect.x=e.x-t/2+h+(d.calculative.worldRect.x-e.x)*u,d.calculative.worldRect.width*=u,d.calculative.worldRect.ex=d.calculative.worldRect.x+d.calculative.worldRect.width,d.calculative.width=d.calculative.worldRect.width,d.calculative.x=d.calculative.worldRect.x,d.width=d.calculative.worldRect.width,d.x=d.calculative.worldRect.x,this.canvas.updatePenRect(d,{worldRectIsReady:!1}),d.externElement&&((f=d.onResize)==null||f.call(d,d)),(g=d.children)!=null&&g.length&&getAllChildren(d,this.store).forEach(v=>{var b;v.externElement&&((b=v.onResize)==null||b.call(v,v))})})}else n.left?(a=-a,n.leftValue&&(a+=Math.abs(n.leftValue)<1?n.leftValue*this.canvas.width:n.leftValue),this.translatePens(c,a,0)):n.right&&(n.rightValue&&(a=a-(Math.abs(n.rightValue)<1?n.rightValue*this.canvas.width:n.rightValue)),this.translatePens(c,a,0))});const o=this.store.data.pens.filter(n=>n.name==="iframe");o==null||o.forEach(n=>{var a,h;const c=n.calculative.worldRect;if(c.width/this.store.data.scale>e.width*.8){let l=c.width;n.calculative.worldRect.x=c.x-t/2,n.calculative.worldRect.width=c.width+t,n.calculative.worldRect.ex=c.ex+t,n.operationalRect.x=n.operationalRect.x*l/n.calculative.worldRect.width,n.operationalRect.width=(n.calculative.worldRect.width-(1-n.operationalRect.width)*l)/n.calculative.worldRect.width,(a=n.onBeforeValue)==null||a.call(n,n,{operationalRect:n.operationalRect}),(h=n.onResize)==null||h.call(n,n)}})}if(Math.abs(i)>10){(r=this.store.data.fits)==null||r.forEach(n=>{let c=[];n.children.forEach(h=>{this.store.pens[h]&&(this.store.pens[h].locked=LockState.None,c.push(this.store.pens[h]))});let a=i/2;if(n.top&&n.bottom){let h=n.topValue,l=n.bottomValue;h?h=Math.abs(h)<1?h*this.canvas.height:h:h=0,l?l=Math.abs(l)<1?l*this.canvas.height:l:l=0;let u=(this.canvas.height-h-l)/e.height;c.forEach(d=>{var f,g;d.image&&d.imageRatio&&d.calculative.worldRect.height/this.canvas.height>.1&&(d.imageRatio=!1),d.calculative.worldRect.y=e.y-i/2+h+(d.calculative.worldRect.y-e.y)*u,d.calculative.worldRect.height*=u,d.calculative.worldRect.ey=d.calculative.worldRect.y+d.calculative.worldRect.height,d.calculative.height=d.calculative.worldRect.height,d.calculative.y=d.calculative.worldRect.y,d.height=d.calculative.worldRect.height,d.y=d.calculative.worldRect.y,this.canvas.updatePenRect(d,{worldRectIsReady:!1}),d.externElement&&((f=d.onResize)==null||f.call(d,d)),(g=d.children)!=null&&g.length&&getAllChildren(d,this.store).forEach(v=>{var b;v.externElement&&((b=v.onResize)==null||b.call(v,v))})})}else n.top?(a=-a,n.topValue&&(a+=Math.abs(n.topValue)<1?n.topValue*this.canvas.height:n.topValue),this.translatePens(c,0,a)):n.bottom&&(n.bottomValue&&(a=a-(Math.abs(n.bottomValue)<1?n.bottomValue*this.canvas.height:n.bottomValue)),this.translatePens(c,0,a))});const o=this.store.data.pens.filter(n=>n.name==="iframe");o==null||o.forEach(n=>{var a,h;const c=n.calculative.worldRect;if(c.height/this.store.data.scale>e.height*.8){let l=c.height;n.calculative.worldRect.y=c.y-i/2,n.calculative.worldRect.height=c.height+i,n.calculative.worldRect.ey=c.ey+i,n.operationalRect.y=n.operationalRect.y*l/n.calculative.worldRect.width,n.operationalRect.height=(n.calculative.worldRect.height-(1-n.operationalRect.height)*l)/n.calculative.worldRect.height,(a=n.onBeforeValue)==null||a.call(n,n,{operationalRect:n.operationalRect}),(h=n.onResize)==null||h.call(n,n)}})}this.canvas.canvasTemplate.fit=!0,this.canvas.canvasTemplate.init(),this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render(!0)}trimPens(){let e=this.store.data.pens.filter(t=>t.name==="line"&&t.anchors.length<2);this.delete(e)}fitTemplateView(e=!0,t=10){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:r}=i,o=formatPadding(t),n=this.getRect(),c=(s-o[1]-o[3])/n.width,a=(r-o[0]-o[2])/n.height;let h=c;e?h=c>a?a:c:h=c>a?c:a,this.canvas.templateScale(h*this.store.data.scale);let l=this.getRect(),u=this.store.data.pens.filter(d=>!d.parentId);this.canvas.templateTranslatePens(u,-l.x,-l.y),this.store.data.pens.forEach(d=>{d.type?this.canvas.initLineRect(d):this.canvas.updateLines(d)}),this.centerView()}fitSizeView(e=!0,t=10){var u,d;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:r}=i;this.resize(s,r);const o=formatPadding(t),n=(this.store.data.width||this.store.options.width)*this.store.data.scale,c=(this.store.data.height||this.store.options.height)*this.store.data.scale,a=(s-o[1]-o[3])/n,h=(r-o[0]-o[2])/c;let l=a;e==="width"?l=a:e==="height"?l=h:e?l=a>h?h:a:l=a>h?a:h,(u=this.store.data.fits)!=null&&u.length&&(this.canvas.opening=!0),this.scale(l*this.store.data.scale),this.centerSizeView(),(d=this.store.data.fits)!=null&&d.length&&this.fillView()}centerSizeView(){const e=this.getViewCenter(),t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height,s={x:0,y:0,width:t,height:i};calcCenter(s);const{center:r}=s,{scale:o,origin:n,x:c,y:a}=this.store.data;this.translate((e.x-n.x)/o-r.x-c/o,(e.y-n.y)/o-r.y-a/o);const{canvas:h}=this.canvas,l=(h.scrollWidth-h.offsetWidth)/2,u=(h.scrollHeight-h.offsetHeight)/2;h.scrollTo(l,u)}scrollView(e=10,t=!1){if(!this.hasView()||!this.canvas.scroll)return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:r}=i;this.resize(s,r);const o=formatPadding(e),n=this.getRect(),c=(s-o[1]-o[3])/n.width;this.scale(c*this.store.data.scale),this.topView(o[0]),t&&this.canvas.scroll.changeMode()}screenView(e=10,t=!0){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:r}=i;this.resize(s,r);const o=formatPadding(e),n=this.getRect();let c=(s-o[1]-o[3])/n.width;t||(c=(r-o[0]-o[2])/n.height),this.scale(c*this.store.data.scale),this.topView(o[0])}topView(e=10){if(!this.hasView())return;const t=this.getRect(),i=this.getViewCenter(),s=this.getPenRect(t);calcCenter(s);const{center:r}=s,{scale:o,origin:n,x:c,y:a}=this.store.data;this.translate((i.x-n.x)/o-r.x-c/o,(e-n.y)/o-s.y-a/o);const{canvas:h}=this.canvas,l=(h.scrollWidth-h.offsetWidth)/2,u=(h.scrollHeight-h.offsetHeight)/2;h.scrollTo(l,u)}centerView(){if(!this.hasView())return;const e=this.getRect(),t=this.getViewCenter(),i=this.getPenRect(e);calcCenter(i);const{center:s}=i,{scale:r,origin:o,x:n,y:c}=this.store.data;this.translate((t.x-o.x)/r-s.x-n/r,(t.y-o.y)/r-s.y-c/r);const{canvas:a}=this.canvas,h=(a.scrollWidth-a.offsetWidth)/2,l=(a.scrollHeight-a.offsetHeight)/2;a.scrollTo(h,l)}hasView(){return!!this.store.data.pens.filter(e=>!e.isRuleLine).length}getViewCenter(){const{width:e,height:t}=this.canvas;return{x:e/2,y:t/2}}beSameByFirst(e=this.store.data.pens,t){const i=deepClone(e),s=e[0],{width:r,height:o}=this.getPenRect(s);for(let n=1;n<e.length;n++){const c=e[n];t==="width"?this.setValue({id:c.id,width:r},{render:!1,doEvent:!1}):t==="height"?this.setValue({id:c.id,height:o},{render:!1,doEvent:!1}):this.setValue({id:c.id,width:r,height:o},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:e})}beSameByLast(e=this.store.data.pens,t){const i=deepClone(e),s=e[e.length-1],{width:r,height:o}=this.getPenRect(s);for(let n=0;n<e.length-1;n++){const c=e[n];t==="width"?this.setValue({id:c.id,width:r},{render:!1,doEvent:!1}):t==="height"?this.setValue({id:c.id,height:o},{render:!1,doEvent:!1}):this.setValue({id:c.id,width:r,height:o},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:e})}formatPainterByFirst(e=this.store.data.pens){const t=deepClone(e),i=e[0],s={};formatAttrs.forEach(r=>{s[r]=i[r]});for(let r=1;r<e.length;r++){const o=e[r];this.setValue({id:o.id,...s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}formatPainterByLast(e=this.store.data.pens){const t=deepClone(e),i=e[e.length-1],s={};formatAttrs.forEach(r=>{s[r]=i[r]});for(let r=0;r<e.length-1;r++){const o=e[r];this.setValue({id:o.id,...s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}setFormatPainter(){const e=this.store.active,t={};if(e.length>0){const i=e[0];formatAttrs.forEach(s=>{t[s]=i[s]!==void 0?i[s]:this.store.options.defaultFormat[s]||this.store.data[s]||this.store.options[s]})}else formatAttrs.forEach(i=>{this.store.options.defaultFormat[i]||this.store.data[i]||this.store.options[i]});localStorage.setItem("meta2d-formatPainter",JSON.stringify(t))}formatPainter(){const e=this.store.active,t=deepClone(e),i=JSON.parse(localStorage.getItem("meta2d-formatPainter"));for(let s=0;s<e.length;s++){const r=e[s];this.setValue({id:r.id,...i},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}clearFormatPainter(){const e=this.store.active,t=deepClone(e);formatAttrs.forEach(i=>{for(let s=0;s<e.length;s++){const r=e[s],{fontSize:o,lineHeight:n}=this.store.options;i==="lineWidth"?(r.lineWidth=1,r.calculative.lineWidth=1):i==="fontSize"?(r.fontSize=o,r.calculative.fontSize=o):i==="lineHeight"?(r.lineHeight=n,r.calculative.lineHeight=n):(delete r[i],delete r.calculative[i])}}),this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}alignNodes(e,t=this.store.data.pens,i){!i&&(i=this.getPenRect(this.getRect(t)));const s=deepClone(t);for(const r of t)this.alignPen(e,r,i);this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:s,pens:t})}alignNodesV(e,t=this.store.data.pens,i=!1){const s=this.store.data.width||this.store.options.width,r=this.store.data.height||this.store.options.height;let o={x:0,y:0,width:s,height:r};const n=deepClone(t);if(i){const c=this.store.data.scale,a=this.getRect(t),h=(a.x-this.store.data.origin.x)/c,l=(a.y-this.store.data.origin.y)/c,u=a.width/c,d=a.height/c;let f=0,g=0;switch(e){case"left":f=-h;break;case"right":f=s-(h+u);break;case"top":g=-l;break;case"bottom":g=r-(l+d);break;case"center":f=s/2-(h+u/2);break;case"middle":g=r/2-(l+d/2);break}this.translatePens(t,f*c,g*c)}else for(const c of t)this.alignPen(e,c,o);this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:n,pens:t})}alignNodesByFirst(e,t=this.store.data.pens){const i=deepClone(t),s=t[0],r=this.getPenRect(s);for(let o=1;o<t.length;o++){const n=t[o];this.alignPen(e,n,r)}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:t})}alignNodesByLast(e,t=this.store.data.pens){const i=deepClone(t),s=t[t.length-1],r=this.getPenRect(s);for(let o=0;o<t.length-1;o++){const n=t[o];this.alignPen(e,n,r)}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:t})}alignPen(e,t,i){const s=this.getPenRect(t);switch(e){case"left":s.x=i.x;break;case"right":s.x=i.x+i.width-s.width;break;case"top":s.y=i.y;break;case"bottom":s.y=i.y+i.height-s.height;break;case"center":s.x=i.x+i.width/2-s.width/2;break;case"middle":s.y=i.y+i.height/2-s.height/2;break}this.setValue({id:t.id,...s},{render:!1,doEvent:!1})}spaceBetweenByDirection(e,t=this.store.data.pens,i){if(!i){let a=1/0,h=-1/0,l=e==="width"?"x":"y";t.forEach(u=>{a=Math.min(a,u.calculative.worldRect[l]),h=Math.max(h,u.calculative.worldRect["e"+l])}),i=(h-a)/this.store.data.scale}if(t=t.filter(a=>!a.parentId),t.length<=2)return;const s=deepClone(t),r=t.reduce((a,h)=>{const l=this.getPenRect(h);return a+l[e]},0),o=(i-r)/(t.length-1);t=t.sort((a,h)=>e==="width"?a.x-h.x:a.y-h.y);const n=this.getPenRect(t[0]);let c=e==="width"?n.x:n.y;for(const a of t){const h=this.getPenRect(a);e==="width"?h.x=c:h.y=c,c+=h[e]+o,this.setValue({id:a.id,...h},{render:!1,doEvent:!1})}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:s,pens:t})}spaceBetween(e,t){this.spaceBetweenByDirection("width",e,t)}spaceBetweenColumn(e,t){this.spaceBetweenByDirection("height",e,t)}layout(e=this.store.data.pens,t,i=30){const s=this.getPenRect(getRect$1(e));!t&&(t=s.width),e=e.filter(a=>!a.type&&!a.parentId);const r=deepClone(e);let o=0;e.forEach(a=>{const h=this.getPenRect(a);h.height>o&&(o=h.height)});let n=s.x,c=s.y;e.forEach((a,h)=>{const l=this.getPenRect(a);if(l.x=n,l.y=c+o/2-l.height/2,this.setValue({id:a.id,...l},{render:!1,doEvent:!1}),h===e.length-1)return;const u=n+l.width-s.x,d=this.getPenRect(e[h+1]);Math.round(t-u)>=Math.round(d.width+i)?n+=l.width+i:(n=s.x,c+=o+i)}),this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:EditType.Update,initPens:r,pens:e})}gotoView(e){const t=this.getViewCenter(),i=t.x-e.calculative.worldRect.x-e.calculative.worldRect.width/2,s=t.y-e.calculative.worldRect.y-e.calculative.worldRect.height/2;this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.translate(i-this.store.data.x,s-this.store.data.y),this.store.data.x=i,this.store.data.y=s;for(const r of this.store.data.pens)calcInView(r);this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render()}showMap(){this.map||(this.map=new ViewMap(this.canvas)),this.map.show()}hideMap(){this.map.hide()}onSizeUpdate(){this.mapTimer&&(clearTimeout(this.mapTimer),this.mapTimer=void 0),this.mapTimer=setTimeout(()=>{this.map&&this.map.isShow&&this.map.show(),this.canvas&&this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.resize()},500)}toggleAnchorMode(){this.canvas.toggleAnchorMode()}addAnchorHand(){this.canvas.addAnchorHand()}removeAnchorHand(){this.canvas.removeAnchorHand()}toggleAnchorHand(){this.canvas.toggleAnchorHand()}top(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens,s=[...getAllChildren(t,this.store),t].map(o=>o.id);i.filter(o=>s.includes(o.id)).forEach(o=>{const n=i.findIndex(c=>c.id===o.id);n>-1&&(i.push(i[n]),i.splice(n,1),this.initTemplateCanvas([o]),this.initImageCanvas([o])),this.specificLayerMove(o,"top")})}this.store.emitter.emit("layer",{type:"top",pens:e})}initImageCanvas(e){this.canvas&&this.canvas.initImageCanvas(e)}initTemplateCanvas(e){this.canvas&&this.canvas.initTemplateCanvas(e)}bottom(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens,s=[...getAllChildren(t,this.store),t].map(o=>o.id),r=i.filter(o=>s.includes(o.id));for(let o=r.length-1;o>=0;o--){const n=r[o],c=i.findIndex(a=>a.id===n.id);c>-1&&(i.unshift(i[c]),i.splice(c+1,1),this.initTemplateCanvas([n]),this.initImageCanvas([n])),this.specificLayerMove(n,"bottom")}}this.store.emitter.emit("layer",{type:"bottom",pens:e})}upByArea(e){if(this.store.data.pens.findIndex(c=>c.id===e.id)===-1){console.warn("upByArea: pen not in canvas");return}const i=[e,...getAllChildren(e,this.store)];let s=i.map(c=>this.store.data.pens.findIndex(a=>a.id===c.id));s.includes(-1)&&(console.warn("upByArea: pen children not in canvas"),s=s.filter(c=>c!==-1));const r=Math.min(...s),o=e.calculative.worldRect,n=this.store.data.pens.findIndex((c,a)=>{if(a<=r||c.id===e.id||isAncestor(c,e))return!1;const h=c.calculative.worldRect;return rectInRect(o,h)});if(n===-1){this.up(e);return}this.store.data.pens.splice(n+1,0,...i);for(const c of i){const a=this.store.data.pens.findIndex(h=>h.id===c.id);a>-1&&this.store.data.pens.splice(a,1)}this.initImageCanvas([e])}specificLayerMove(e,t){var i;if(e.image&&e.name!=="gif"){let s=CanvasLayer.CanvasImageBottom;t==="top"?s=CanvasLayer.CanvasImage:(t==="up"||t==="down")&&(s=CanvasLayer.CanvasMain),this.setValue({id:e.id,canvasLayer:s},{render:!1,doEvent:!1,history:!1})}else if(e.externElement||e.name==="gif"){let s=0;t==="top"?(e.calculative.canvas.maxZindex+=1,s=e.calculative.canvas.maxZindex):t==="up"?s=e.calculative.zIndex===void 0?6:e.calculative.zIndex+1:t==="down"&&(s=e.calculative.zIndex===void 0?3:e.calculative.zIndex-1,s<0&&(s=0)),this.setValue({id:e.id,zIndex:s},{render:!1,doEvent:!1,history:!1}),(i=e.calculative.singleton)!=null&&i.div&&setElemPosition(e,e.calculative.singleton.div)}}up(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens;if(t.children&&t.children.length){const s=[...getAllChildren(t,this.store),t],r=[];for(let c=0;c<i.length;c++){const a=i[c];s.findIndex(h=>h.id===a.id)!==-1&&(a.temIndex=c,r.push(a))}let o=-1,n=0;r.forEach(c=>{c.temIndex-=n,i.splice(c.temIndex,1),n+=1,o=c.temIndex,delete c.temIndex,this.specificLayerMove(c,"up")}),i.splice(o+1,0,...r),this.initTemplateCanvas(r),this.initImageCanvas(r)}else{const s=i.findIndex(r=>r.id===t.id);s>-1&&s!==i.length-1&&(i.splice(s+2,0,i[s]),i.splice(s,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"up")}}this.store.emitter.emit("layer",{type:"up",pens:e})}down(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens;if(t.children&&t.children.length){const s=[...getAllChildren(t,this.store),t],r=[];for(let c=0;c<i.length;c++){const a=i[c];s.findIndex(h=>h.id===a.id)!==-1&&(a.temIndex=c,r.push(a))}let o=-1,n=0;r.forEach((c,a)=>{c.temIndex-=n,i.splice(c.temIndex,1),n+=1,a===0&&(o=c.temIndex),delete c.temIndex,this.specificLayerMove(c,"down")}),i.splice(o-1,0,...r),this.initTemplateCanvas(r),this.initImageCanvas(r)}else{const s=i.findIndex(r=>r.id===t.id);s>-1&&s!==0&&(i.splice(s-1,0,i[s]),i.splice(s+1,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"down")}}this.store.emitter.emit("layer",{type:"down",pens:e})}setLayer(e,t,i=this.store.data.pens){const s=i.findIndex(r=>r.id===e.id);s>-1&&(s>t?(i.splice(t,0,i[s]),i.splice(s+1,1)):s<t&&(i.splice(t,0,i[s]),i.splice(s,1)))}changePenId(e,t){this.canvas.changePenId(e,t)}getLines(e,t="all"){var s;if(e.type===PenType.Line)return[];const i=[];return(s=e.connectedLines)==null||s.forEach(({lineId:r})=>{const o=this.store.pens[r];if(!o){console.warn(e,"node contain a error connectedLine");return}if(!i.find(n=>n.id===o.id))switch(t){case"all":i.push(o);break;case"in":getToAnchor(o).connectTo===e.id&&i.push(o);break;case"out":getFromAnchor(o).connectTo===e.id&&i.push(o);break}}),i}nextNode(e){if(e.type===PenType.Line){const t=this.store.pens[getToAnchor(e).connectTo];return t?[t]:[]}else{const t=this.getLines(e,"out"),i=[];return t.forEach(s=>{const r=this.nextNode(s);for(const o of r)!i.find(c=>c.id===o.id)&&i.push(o)}),i}}previousNode(e){if(e.type===PenType.Line){const t=this.store.pens[getFromAnchor(e).connectTo];return t?[t]:[]}else{const t=this.getLines(e,"in"),i=[];return t.forEach(s=>{const r=this.previousNode(s);for(const o of r)!i.find(c=>c.id===o.id)&&i.push(o)}),i}}getNext(e){var i;if(e.type===PenType.Line){console.warn("");return}const t=[];return(i=e.connectedLines)==null||i.forEach(({lineId:s,anchor:r})=>{var c,a;const o=(c=e.anchors)==null?void 0:c.filter(h=>h.id===r)[0],n=this.findOne(s);if(n.anchors[0].connectTo==e.id){const h=n.anchors[n.anchors.length-1].connectTo;if(h){const l=this.findOne(h),u=(a=l.connectedLines)==null?void 0:a.filter(f=>f.lineId===n.id)[0],d=l.anchors.filter(f=>f.id===u.anchor)[0];t.push({from:e,fromAnchor:o,line:n,to:l,toAnchor:d})}}}),t}addAnchor(e,t,i){if(!e)return;if(e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),e.type===PenType.Line&&(i<0&&(i=e.anchors.length+1+i),i>e.anchors.length&&(i=e.anchors.length),i<0&&(i=0),i==0&&e.anchors[0].connectTo||i==e.anchors.length&&e.anchors[i-1].connectTo)){console.warn("");return}let s=null,r=null;t.x<=1&&t.x>=0&&t.y<=1&&t.y>=0?(r={id:t.id||s8(),penId:e.id,x:e.calculative.worldRect.x+e.calculative.worldRect.width*t.x,y:e.calculative.worldRect.y+e.calculative.worldRect.height*t.y},e.calculative.worldRect&&e.rotate%360&&rotatePoint(r,e.rotate,e.calculative.worldRect.center),s={id:r.id,penId:e.id,x:t.x,y:t.y}):(r={id:t.id||s8(),penId:e.id,x:t.x,y:t.y},e.calculative.worldRect&&(e.rotate%360&&rotatePoint(t,-e.rotate,e.calculative.worldRect.center),s={id:r.id,penId:e.id,x:(t.x-e.calculative.worldRect.x)/e.calculative.worldRect.width,y:(t.y-e.calculative.worldRect.y)/e.calculative.worldRect.height})),e.type===PenType.Line?(e.calculative.worldAnchors.splice(i,0,r),e.anchors.splice(i,0,s),this.canvas.updateLines(e),this.canvas.initLineRect(e),this.render()):(e.calculative.worldAnchors.push(r),e.anchors.push(s))}connectLine(e,t,i,s,r=!0){if(!i){const a=t.calculative.worldRect;i=nearestAnchor(e,{x:a.x+a.width/2,y:a.y+a.height/2})}if(!s){const a=e.calculative.worldRect;s=nearestAnchor(t,{x:a.x+a.width/2,y:a.y+a.height/2})}const o=Math.abs(i.x-s.x),c={height:Math.abs(i.y-s.y),lineName:"line",lineWidth:1,name:"line",type:1,width:o,x:Math.min(i.x,s.x),y:Math.min(i.y,s.y),anchors:[{x:i.x>s.x?1:0,y:i.y>s.y?1:0,id:s8()},{x:i.x>s.x?0:1,y:i.x>s.x?0:1,id:s8()}]};return this.addPens([c]),connectLine(e,i,c,c.calculative.worldAnchors[0]),connectLine(t,s,c,c.calculative.worldAnchors[1]),c.calculative.active=!1,this.canvas.updateLines(c),this.canvas.updateLines(e),this.canvas.updateLines(t),this.canvas.initLineRect(c),r&&this.render(),c}toComponent(e=this.store.data.pens,t,i){if(e.length===1){const h=deepClone(e[0]);return h.type=PenType.Node,h.id=void 0,[h]}const s=deepClone(e,!0),r=getRect$1(s);let o={id:s8(),name:"combine",...r,children:[],showChild:t};i&&(o.anchors=[{id:"0",penId:o.id,x:.5,y:0},{id:"1",penId:o.id,x:1,y:.5},{id:"2",penId:o.id,x:.5,y:1},{id:"3",penId:o.id,x:0,y:.5}]);const n=s.filter(h=>!h.parentId),c=s.find(h=>h.width===r.width&&h.height===r.height),a=c&&t===void 0;return n.length===1?o=n[0]:a&&(c.children||(c.children=[]),o=c),s.forEach(h=>{if(h===o||h.parentId===o.id||h.parentId)return;o.children.push(h.id),h.parentId=o.id;const l=calcRelativeRect(h.calculative.worldRect,r);Object.assign(h,l),h.locked=h.lockedOnCombine??LockState.DisableMove}),a||n.length===1?deepClone(s):deepClone([o,...s])}installPenPlugins(e,t){if(!e.tag&&!e.name&&!e.id)return;let i;e.id?i="id":e.tag?i="tag":e.name&&(i="name"),t.forEach(s=>{let r=s.plugin,o=s.options;if(r&&validationPlugin(r)&&i)if(r.install(e,o),!this.penPluginMap.has(r))this.penPluginMap.set(r,[{[i]:e[i],option:o}]);else{let n=this.penPluginMap.get(r).find(c=>c[i]===e[i]);n?n.option=o:this.penPluginMap.get(r).push({[i]:e[i],option:o})}})}uninstallPenPlugins(e,t){let i;e.id?i="id":e.tag?i="tag":e.name&&(i="name"),i&&t.forEach(s=>{let r=s.plugin;r.uninstall(e,s.options);let o=this.penPluginMap.get(r),n=o.findIndex(c=>c[i]===e[i]);n!==-1&&(o.splice(n,1),o.length===0&&this.penPluginMap.delete(r))})}setVisible(e,t,i=!0){if(this.onSizeUpdate(),this.setValue({id:e.id,visible:t},{render:!1,doEvent:!1}),e.children)for(const r of e.children){const o=this.store.pens[r];o&&this.setVisible(o,t,!1)}let s=getAllChildren(e,this.store);s.push(e),this.initImageCanvas(s),i&&this.render()}clearHover(){this.canvas.clearHover()}closeSocket(){this.closeWebsocket(),this.closeMqtt(),this.closeHttp()}destroy(e){if(this.clear(!1),this.stopDataMock(),this.closeSocket(),this.closeNetwork(),this.closeAll(),le5leTheme.destroyThemeSheet(this.store.id),this.store.emitter.all.clear(),this.canvas.destroy(),this.canvas=void 0,globalStore[this.store.id]=void 0,!e){for(const t in globalStore)delete globalStore[t];globalStore.path2dDraws={},globalStore.canvasDraws={},globalStore.anchors={},globalStore.htmlElements={}}}}function getAssetPath(e){const t=e.startsWith("/")?e.slice(1):e;return t.startsWith("thingtwin/")?"/"+t:`/thingtwin/${t}`}function preloadImage(e){return new Promise((t,i)=>{const s=new Image;s.onload=()=>t(),s.onerror=()=>i(new Error(`Failed to load image: ${e}`)),s.src=e})}function registerGraphics(){registerDeviceIcons(),registerBasicShapes(),registerFlowShapes(),registerActivityShapes(),registerSequenceShapes(),registerFaultTreeShapes(),registerMindShapes()}function registerDeviceIcons(){register({name:"l-device-valve",icon:"l-device-valve",data:{name:"image",text:"",width:40,height:40,image:getAssetPath("/devices/valve.svg")}}),register({name:"l-device-flowmeter",icon:"l-device-flowmeter",data:{name:"image",text:"",width:60,height:60,image:getAssetPath("/devices/flowmeter.svg")}}),register({name:"l-device-separator",icon:getAssetPath("/devices/separator.svg"),data:{name:"image",text:"",width:100,height:40,image:getAssetPath("/devices/separator.svg")}}),register({name:"l-device-pump",icon:getAssetPath("/devices/pump.svg"),data:{name:"image",text:"",width:40,height:80,image:getAssetPath("/devices/pump.svg")}}),register({name:"l-device-tank",icon:getAssetPath("/devices/tank.svg"),data:{name:"image",text:"",width:60,height:100,image:getAssetPath("/devices/tank.svg")}}),register({name:"l-device-tank2",icon:getAssetPath("/devices/tank2.svg"),data:{name:"image",text:"",width:60,height:100,image:getAssetPath("/devices/tank2.svg")}}),register({name:"l-device-gauge",icon:getAssetPath("/devices/gauge.svg"),data:{name:"image",text:"",width:60,height:60,image:getAssetPath("/devices/gauge.svg")}}),register({name:"l-device-filter",icon:getAssetPath("/devices/filter.svg"),data:{name:"image",text:"",width:120,height:40,image:getAssetPath("/devices/filter.svg")}}),register({name:"l-device-pump2",icon:getAssetPath("/devices/pump2.svg"),data:{name:"image",text:"",width:80,height:40,image:getAssetPath("/devices/pump2.svg")}}),register({name:"l-device-pool",icon:getAssetPath("/devices/pool.svg"),data:{name:"image",text:"",width:120,height:120,image:getAssetPath("/devices/pool.svg")}}),register({name:"l-device-drain",icon:getAssetPath("/devices/drain.svg"),data:{name:"image",text:"",width:80,height:40,image:getAssetPath("/devices/drain.svg")}}),register({name:"l-device-sludge",icon:getAssetPath("/devices/sludge.svg"),data:{name:"image",text:"",width:120,height:120,image:getAssetPath("/devices/sludge.svg")}}),register({name:"l-device-sludge-pump",icon:"/devices/sludge-pump.svg",data:{name:"image",text:"",width:40,height:100,image:"/devices/sludge-pump.svg"}}),register({name:"l-device-settling",icon:"/devices/settling.svg",data:{name:"image",text:"",width:150,height:150,image:"/devices/settling.svg"}})}function registerBasicShapes(){register({name:"l-rect",icon:"/shapes/rect.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="rectangle",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-rectangle",icon:"/shapes/rectangle.svg",create(e){const t=e;return t.width=200,t.height=50,t.name="rectangle",t.borderRadius=.1,t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-circle",icon:"/shapes/circle.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="circle",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-triangle",icon:"/shapes/triangle.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="triangle",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-diamond",icon:"/shapes/diamond.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="diamond",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-pentagon",icon:"/shapes/pentagon.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="pentagon",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-hexagon",icon:"/shapes/hexagon.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="hexagon",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-pentagram",icon:"/shapes/pentagram.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="pentagram",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-arrow-left",icon:"/shapes/arrow-left.svg",create(e){const t=e;return t.width=120,t.height=60,t.name="leftArrow",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-arrow-right",icon:"/shapes/arrow-right.svg",create(e){const t=e;return t.width=120,t.height=60,t.name="rightArrow",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-twoway-arrow",icon:"/shapes/twoway-arrow.svg",create(e){const t=e;return t.width=150,t.height=60,t.name="twowayArrow",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-cloud",icon:"/shapes/cloud.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="cloud",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-msg",icon:"/shapes/msg.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="message",t.textTop=-.1,t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-file",icon:"/shapes/file.svg",create(e){const t=e;return t.width=80,t.height=100,t.name="file",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-cube",icon:"/shapes/cube.svg",create(e){const t=e;return t.width=100,t.height=100,t.name="cube",t.strokeStyle="rgb(0, 31, 151)",t}}),register({name:"l-people",icon:"/shapes/people.svg",create(e){const t=e;return t.width=70,t.height=100,t.name="people",t.strokeStyle="rgb(0, 31, 151)",t}})}function registerFlowShapes(){register({name:"l-flow-start",icon:"/shapes/flow-start.svg",create(e){return e.width=120,e.height=40,e.name="rectangle",e.text="/",e.borderRadius=.5,e}}),register({name:"l-flow-process",icon:"/shapes/flow-process.svg",create(e){return e.width=120,e.height=40,e.name="rectangle",e.text="",e}}),register({name:"l-flow-decision",icon:"/shapes/flow-decision.svg",create(e){return e.width=120,e.height=60,e.name="diamond",e.text="",e}}),register({name:"l-flow-data",icon:"/shapes/flow-data.svg",create(e){return e.width=120,e.height=50,e.name="flowData",e.text="",e.offsetX=.14,e}}),register({name:"l-flow-ready",icon:"/shapes/flow-ready.svg",create(e){return e.width=120,e.height=50,e.name="hexagon",e.text="",e}}),register({name:"l-flow-subprocess",icon:"/shapes/flow-subprocess.svg",create(e){return e.width=120,e.height=50,e.name="flowSubprocess",e.text="",e}}),register({name:"l-db",icon:"/shapes/db.svg",create(e){return e.width=80,e.height=120,e.name="flowDb",e.text="",e}}),register({name:"l-flow-document",icon:"/shapes/flow-document.svg",create(e){return e.width=120,e.height=100,e.name="flowDocument",e.text="",e}})}function registerActivityShapes(){register({name:"l-activity-start",icon:"/shapes/activity-start.svg",create(e){return e.width=30,e.height=30,e.name="circle",e.background="#555",e.lineWidth=0,e}}),register({name:"l-activity-final",icon:"/shapes/activity-final.svg",create(e){return e.width=30,e.height=30,e.name="activityFinal",e}}),register({name:"l-action",icon:"/shapes/action.svg",create(e){return e.width=120,e.height=50,e.name="rectangle",e.text="",e.borderRadius=.25,e}}),register({name:"l-activity-decision",icon:"/shapes/activity-decision.svg",create(e){return e.width=120,e.height=50,e.name="diamond",e.text="/",e}}),register({name:"l-swimlane-v",icon:"/shapes/swimlane-v.svg",create(e){return e.width=200,e.height=500,e.name="swimlaneV",e.text="",e.textBaseline="top",e.textTop=20,e.lineTop=.08,e}}),register({name:"l-swimlane-h",icon:"/shapes/swimlane-h.svg",create(e){return e.width=500,e.height=200,e.name="swimlaneH",e.text="",e.textWidth=.01,e.textLeft=.04,e.textAlign="left",e.lineLeft=.08,e}}),register({name:"l-fork-v",icon:"/shapes/fork-v.svg",create(e){return e.width=10,e.height=150,e.name="forkV",e.text="/",e.fillStyle="#555",e.strokeStyle="transparent",e}}),register({name:"l-fork-h",icon:"/shapes/fork-h.svg",create(e){return e.width=150,e.height=10,e.name="forkH",e.text="/",e.fillStyle="#555",e.strokeStyle="transparent",e}})}function registerSequenceShapes(){register({name:"l-lifeline",icon:"/shapes/lifeline.svg",create(e){return e.width=150,e.height=400,e.name="lifeline",e.text="",e.textHeight=50,e}}),register({name:"l-focus",icon:"/shapes/focus.svg",create(e){return e.width=12,e.height=200,e.name="sequenceFocus",e.text="",e}}),register({name:"l-simple-class",icon:"/shapes/simple-class.svg",create(e){return e.width=270,e.height=200,e.name="simpleClass",e.text="Topology",e.textHeight=200,e.textAlign="center",e.textBaseline="top",e.textTop=10,e.list=[{text:`- name: string
+ setName(name: string): void`}],e}}),register({name:"l-class",icon:"/shapes/class.svg",create(e){return e.width=270,e.height=200,e.name="interfaceClass",e.text="Topology",e.textHeight=200,e.textAlign="center",e.textBaseline="top",e.textTop=10,e.list=[{text:"- name: string"},{text:"+ setName(name: string): void"}],e}})}function registerFaultTreeShapes(){register({name:"l-and-gate",icon:"/shapes/and-gate.svg",create(e){return e.width=100,e.height=150,e.name="andGate",e}}),register({name:"l-basic-event",icon:"/shapes/basic-event.svg",create(e){return e.width=100,e.height=150,e.name="basicEvent",e}}),register({name:"l-unexpanded-event",icon:"/shapes/unexpanded-event.svg",create(e){return e.width=100,e.height=150,e.name="unexpandedEvent",e}}),register({name:"l-priority-and-gate",icon:"/shapes/priority-and-gate.svg",create(e){return e.width=100,e.height=150,e.name="priorityAndGate",e}}),register({name:"l-forbidden-gate",icon:"/shapes/forbidden-gate.svg",create(e){return e.width=100,e.height=150,e.name="forbiddenGate",e}}),register({name:"l-event",icon:"/shapes/event.svg",create(e){return e.width=100,e.height=150,e.name="event",e}}),register({name:"l-switch-event",icon:"/shapes/switch-event.svg",create(e){return e.width=100,e.height=150,e.name="switchEvent",e}}),register({name:"l-conditional-event",icon:"/shapes/conditional-event.svg",create(e){return e.width=150,e.height=100,e.name="conditionalEvent",e}}),register({name:"l-transfer-symbol",icon:"/shapes/transfer-symbol.svg",create(e){return e.width=100,e.height=150,e.name="transferSymbol",e}}),register({name:"l-or-gate",icon:"/shapes/or-gate.svg",create(e){return e.width=100,e.height=150,e.name="orGate",e}}),register({name:"l-xor-gate",icon:"/shapes/xor-gate.svg",create(e){return e.width=100,e.height=150,e.name="xorGate",e}}),register({name:"l-voting-gate",icon:"/shapes/voting-gate.svg",create(e){return e.width=100,e.height=150,e.name="votingGate",e}})}function registerMindShapes(){register({name:"l-mind-node",icon:"/shapes/mind-node.svg",create(e){return e.width=200,e.height=50,e.name="mindNode",e.text="",e.borderRadius=.5,e}}),register({name:"l-mind-line",icon:"/shapes/mind-line.svg",create(e){return e.width=160,e.height=40,e.name="mindLine",e.text="",e}})}var SelectionMode=(e=>(e[e.File=0]="File",e[e.Pen=1]="Pen",e))(SelectionMode||{});const selections=reactive({mode:0,pen:void 0}),useSelection=()=>({selections,select:t=>{if(!t||t.length!==1){selections.mode=0,selections.pen=void 0;return}selections.mode=1,selections.pen=t[0]}}),_hoisted_1={id:"meta2d"},_sfc_main=defineComponent({__name:"View",setup(e){const{select:t}=useSelection(),i={rule:!0,ruleColor:"rgba(255, 255, 255, 0.2)",grid:!0,gridColor:"rgba(255, 255, 255, 0.08)",gridSize:10,color:"#fff",activeColor:"#40C4FF",hoverColor:"#80D8FF",anchorColor:"#fff",anchorRadius:4,anchorBackground:"#001529",background:"#001529",textColor:"#fff",font:{color:"#fff",fontFamily:'"Roboto", "Helvetica", "Arial", sans-serif'}};onMounted(async()=>{console.log("View component mounted"),window.meta2d=new Meta2d("meta2d",i);try{registerGraphics();const o=["/devices/valve.svg","/devices/flowmeter.svg","/devices/separator.svg","/devices/pump.svg","/devices/tank.svg","/devices/tank2.svg","/devices/gauge.svg","/devices/filter.svg","/devices/pump2.svg","/devices/pool.svg","/devices/drain.svg","/devices/sludge.svg"].map(c=>`/thingtwin${c}`);await Promise.all(o.map(preloadImage)),console.log("All device icons loaded");const n=localStorage.getItem("meta2d");if(n){const c=JSON.parse(n);c.locked=location.pathname==="/preview"?1:0,meta2d.open(c)}meta2d.on("active",s),meta2d.on("inactive",r)}catch(o){console.error("Error during initialization:",o)}});const s=o=>{t(o)},r=()=>{t()};return onUnmounted(()=>{meta2d&&(meta2d.off("active",s),meta2d.off("inactive",r),meta2d.destroy())}),(o,n)=>(openBlock(),createElementBlock("div",_hoisted_1))}}),View_vue_vue_type_style_index_0_scoped_2f205d5a_lang="",View=_export_sfc(_sfc_main,[["__scopeId","data-v-2f205d5a"]]);export{PenType as P,SelectionMode as S,View as V,commonjsGlobal as c,deepClone as d,getDefaultExportFromCjs as g,useSelection as u};
