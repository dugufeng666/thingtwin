var Q=Object.defineProperty;var tt=(e,t,i)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var g=(e,t,i)=>(tt(e,typeof t!="symbol"?t+"":t,i),i);import{B as s8,C as calcCenter,D as getFromAnchor,E as getToAnchor,G as deleteTempAnchor,H as facePen,I as Direction,J as PrevNextType,K as setElemPosition,m as deepClone,L as getParent,N as getRect$1,O as CanvasLayer,Q as ctxFlip,R as ctxRotate,S as setGlobalAlpha,T as drawImage,U as rgba,V as getMeta2dData,W as renderPen,X as HoverType,Y as defaultDrawLineFns,Z as setHover,$ as curve,a0 as mind,a1 as lineSegment,a2 as KeydownType,a3 as LockState,a4 as HotkeyType,a5 as getLinePoints,a6 as globalStore,a7 as getLineLength,a8 as EditType,a9 as calcRelativePoint,aa as pointInRect,P as PenType,ab as MouseRight,ac as connectLine,ad as PointType,ae as getDistance,af as nearestAnchor,ag as setChildrenActive,ah as calcAnchorDock,ai as rectInRect,aj as lineInRect,ak as distance,al as calcChildrenInitRect,am as rectToPoints,an as rotatePoint,ao as getPensLock,ap as getPensDisableRotate,aq as getPensDisableResize,ar as hitPoint,as as getLineR,at as pointInSimpleRect,au as pointInLine,av as pointInPolygon,aw as TwoWay,ax as calcRightBottom,ay as calcInView,az as inheritanceProps,aA as getLineRect,aB as calcPadding,aC as calcTextRect,aD as samePoint,aE as calcPenRect,aF as calcWorldRects,aG as calcWorldAnchors,aH as calcIconRect,aI as themeKeys,aJ as le5leTheme,aK as formatPadding,aL as scalePoint,aM as scalePen,aN as calcRotate,aO as resizeRect,aP as calcResizeDock,aQ as translateRect,aR as calcMoveDock,aS as isDomShapes,aT as disconnectLine,aU as getAnchor,aV as translatePoint,aW as removePenAnchor,aX as addLineAnchor,aY as pushPenAnchor,aZ as translateLine,a_ as rotatePen,a$ as calcTextLines,b0 as getGradientAnimatePath,b1 as setNodeAnimate,b2 as setLineAnimate,b3 as getAllChildren,b4 as getAllFollowers,b5 as getTextColor,b6 as calcTextAutoWidth,b7 as clearLifeCycle,b8 as getRectOfPoints,b9 as isShowChild,ba as renderPenRaw$1,bb as defaultCursors,bc as rotatedCursors,bd as needCalcTextRectProps,be as needSetPenProps,bf as needPatchFlagsPenRectProps,bg as needCalcIconRectProps,bh as line,bi as useStore,bj as getWords,bk as calcTextDrawRect,bl as EventAction,bm as getSendData,bn as sendJetLinksData,bo as queryURLParams,bp as mqtt_minExports,bq as clearStore,br as register$1,bs as registerCanvasDraw,bt as registerAnchors,bu as calcRelativeRect,bv as isInteraction,bw as pkg,bx as connectJetLinks,by as getToken,bz as getCookie,bA as closeJetLinks,bB as setChildValue,bC as valueInArray,bD as valueInRange,bE as formatAttrs,bF as isAncestor,bG as deepSetValue,bH as pSBC,bI as getFont,a as reactive,d as defineComponent,o as onMounted,bJ as registerGraphics,y as onUnmounted,e as openBlock,f as createElementBlock,_ as _export_sfc}from"./index-7210837a.js";function rectangle(e,t){const i=t||new Path2D;e.setTheme||(e.setTheme=setTheme$2);let s=e.calculative.borderRadius||0,a=s;const{x:r,y:o,width:n,height:l,ex:c,ey:h}=e.calculative.worldRect;s<1&&(s=n*s,a=l*a);let d=s<a?s:a;if(n<2*d&&(d=n/2),l<2*d&&(d=l/2),i.moveTo(r+d,o),i.arcTo(c,o,c,h,d),i.arcTo(c,h,r,h,d),i.arcTo(r,h,r,o,d),i.arcTo(r,o,c,o,d),i.closePath(),i instanceof Path2D)return i}function setTheme$2(e,t){if(e.affectByTheme){for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const s=t[i];e.hasOwnProperty(i)&&(e[i]=s),e.calculative.hasOwnProperty(i)&&(e.calculative[i]=s)}e.hoverTextColor=t.textPrimaryColor,e.iconColor=t.buttonBg,e.calculative.iconColor=t.buttonBg,e.hoverBackground=t.formBg,e.activeBackground=t.activeBg,e.color=t.borderColor,e.calculative.color=t.borderColor,e.textColor=t["textColor-9"],e.calculative.textColor=t["textColor-9"]}}const square=rectangle;function circle(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.ellipse(s+r/2,a+o/2,r/2,o/2,0,0,Math.PI*2),i instanceof Path2D)return i}async function fileToBase64(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=a=>{t(a.target.result)},s.onerror=a=>{i(a)},s.readAsDataURL(e)})}async function uploadFile(e,t,i,s){const a=new FormData;if(a.append("file",e),i)for(const o in i)i.hasOwnProperty(o)&&a.append(o,i[o]);return(await(await fetch(t,{method:"POST",headers:s,body:a})).json()).url}function loadCss(e,t,i){var s=document.createElement("link");s.href=e,s.rel="stylesheet",t&&(s.onload=t),i&&(s.onerror=i),document.head.appendChild(s)}function getter(e,t){if(t==null)return e;const i=t.split(".");for(;i.length&&(e=e[i.shift()]););return e}function setter(e,t,i){t!=null&&t.split(".").reduce((s,a,r)=>s[a]=t.split(".").length===++r?i:s[a]||{},e)}function formatTime(e){const t=["天","一","二","三","四","五","六"],i=new Date,s=i.getFullYear(),a=i.getMonth()+1,r=i.getDate(),o=i.getDay(),n=i.getHours(),l=i.getMinutes(),c=i.getSeconds();return new Function("year","month","day","week","hours","minutes","seconds",e?`return ${e}`:"return `${year}:${month}:${day} ${hours}:${minutes}:${seconds} 星期${week}`")(s,a,r,t[o],n,l,c)}function randomId(e){if(e.id=s8(),Array.isArray(e.anchors))for(const t of e.anchors)e.type&&(t.id=s8()),t.penId=e.id,t.prev&&(e.type&&(t.prev.id=s8()),t.prev.penId=e.id),t.next&&(e.type&&(t.next.id=s8()),t.next.penId=e.id)}function rewritePenLifeCycle(){let e=null,t=new Map;return(i,s,a,r=!1)=>{if(t.has(i)&&t.get(i)?e=t.get(i):t.set(i,e=new Map),typeof a!="function")return()=>{console.warn("[rewritePenLifeCycle] warn: not a function ")};let o=new Set,n=new Map;e.has(s)&&e.get(s)?o=e.get(s):(n.set(s,i[s]),e.set(s,o)),r?o.delete(a):o.add(a);let l=n.get(s),c=(...h)=>{l==null||l(...h),o.forEach(d=>{d(...h)})};i[s]=c}}let setLifeCycleFunc=rewritePenLifeCycle();function validationPlugin(e){return!e.name&&!e.install?(console.error("installPenPlugin Error: Validation Failed"),!1):!0}const commandRegex=/^[\t\n\f\r ]*([MLHVZCSQTAmlhvzcsqta])[\t\n\f\r ]*/,flagRegex=/^[01]/,numberRegex=/^[+-]?(([0-9]*\.[0-9]+)|([0-9]+\.)|([0-9]+))([eE][+-]?[0-9]+)?/,commaWsp=/^(([\t\n\f\r ]+,?[\t\n\f\r ]*)|(,[\t\n\f\r ]*))/,grammar={M:[numberRegex,numberRegex],L:[numberRegex,numberRegex],H:[numberRegex],V:[numberRegex],Z:[],C:[numberRegex,numberRegex,numberRegex,numberRegex,numberRegex,numberRegex],S:[numberRegex,numberRegex,numberRegex,numberRegex],Q:[numberRegex,numberRegex,numberRegex,numberRegex],T:[numberRegex,numberRegex],A:[numberRegex,numberRegex,numberRegex,flagRegex,flagRegex,numberRegex,numberRegex]};function parseSvgPath(e){let t=0;const i=[];for(;t<e.length;){const s=e.slice(t).match(commandRegex);if(s!==null){const a=s[1];t+=s[0].length;const r=parseCommands(a,e,t);t=r.cursor,i.push(...r.commands)}else throw new Error("malformed path (first error at "+t+")")}return{commands:i}}function getRect(e){let t=1/0,i=1/0,s=-1/0,a=-1/0;return calcWorldPositions(e),e.commands.forEach(r=>{r.worldPoints.forEach((o,n)=>{n%2===0?(o<t&&(t=o),o>s&&(s=o)):(o<i&&(i=o),o>a&&(a=o))})}),{x:t,y:i,ex:s,ey:a,width:s-t+1,height:a-i+1}}function translatePath(e,t,i){i==null&&(i=t),e.commands.forEach((s,a)=>{if(!(s.relative&&a))switch(s.key){case"A":case"a":s.values[5]+=t,s.values[6]+=i;break;case"V":case"v":s.values[0]+=i;break;default:s.values.forEach((r,o)=>{s.values[o]=r+(o%2===0?t:i)});break}})}function scalePath(e,t,i){i==null&&(i=t),e.commands.forEach(s=>{switch(s.key){case"A":case"a":const a=s.values[0],r=s.values[1],o=Math.PI*s.values[2]/180,n=Math.cos(o),l=Math.sin(o),c=r*r*i*i*n*n+a*a*i*i*l*l,h=2*t*i*n*l*(r*r-a*a),d=a*a*t*t*n*n+r*r*t*t*l*l,f=-(a*a*r*r*t*t*i*i),u=h*h-4*c*d,v=Math.sqrt((c-d)*(c-d)+h*h);s.values[2]=h!==0?Math.atan((d-c-v)/h)*180/Math.PI:c<d?0:90,s.values[0]=-Math.sqrt(2*u*f*(c+d+v))/u,s.values[1]=-Math.sqrt(2*u*f*(c+d-v))/u,s.values[5]*=t,s.values[6]*=i,s.values[4]=t*i>=0?s.values[4]:1-s.values[4];break;case"V":case"v":s.values[0]*=i;break;default:s.values.forEach((y,m)=>{s.values[m]=y*(m%2===0?t:i)});break}})}function pathToString(e){let t="";return e.commands.forEach(i=>{t+=i.key+" ",i.values.forEach(s=>{t+=s+" "})}),t}function parseCommands(e,t,i){const s=grammar[e.toUpperCase()],a=[];for(;i<=t.length;){const r={key:e,values:[]};for(const o of s){const n=t.slice(i).match(o);if(n!==null){r.values.push(+n[0]),i+=n[0].length;const l=t.slice(i).match(commaWsp);l!==null&&(i+=l[0].length)}else{if(r.values.length===0)return{cursor:i,commands:a};throw new Error("malformed path (first error at "+i+")")}}if(r.relative=r.key.toUpperCase()!==r.key,a.push(r),s.length===0)return{cursor:i,commands:a};e==="m"&&(e="l"),e==="M"&&(e="L")}throw new Error("malformed path (first error at "+i+")")}function calcWorldPoints(e,t){const i=[];let s=e.relative&&t?{x:t.worldPoints[t.worldPoints.length-2],y:t.worldPoints[t.worldPoints.length-1]}:{x:0,y:0};for(let a=0;a<e.values.length-1;a+=2)i.push(s.x+e.values[a]),i.push(s.y+e.values[a+1]);e.worldPoints=i}function calcWorldPositions(e){let t,i=0,s=0;e.commands.forEach(a=>{switch(a.key){case"Z":case"z":a.worldPoints=[i,s];break;case"H":a.worldPoints=[a.values[0],t.worldPoints[t.worldPoints.length-1]];break;case"h":a.worldPoints=[a.values[0]+t.worldPoints[t.worldPoints.length-2],t.worldPoints[t.worldPoints.length-1]];break;case"V":a.worldPoints=[t.worldPoints[t.worldPoints.length-2],a.values[0]];break;case"v":a.worldPoints=[t.worldPoints[t.worldPoints.length-2],a.values[0]+t.worldPoints[t.worldPoints.length-1]];break;case"A":a.worldPoints=[t.worldPoints[t.worldPoints.length-2],a.values[0]+t.worldPoints[t.worldPoints.length-1]];break;default:calcWorldPoints(a,t);break}(a.key==="M"||a.key==="m"||a.key==="Z"||a.key==="z")&&(i=a.worldPoints[a.worldPoints.length-2],s=a.worldPoints[a.worldPoints.length-1]),t=a})}function svgPath(e,t){var l;const s=e.calculative.canvas.store.data.paths[e.pathId];if(!s)return new Path2D;const a=parseSvgPath(s);e.calculative.svgRect=getRect(a),calcCenter(e.calculative.svgRect),(e.calculative.svgRect.width!==e.calculative.worldRect.width||e.calculative.svgRect.height!==e.calculative.worldRect.height)&&scalePath(a,e.calculative.worldRect.width/e.calculative.svgRect.width,e.calculative.worldRect.height/e.calculative.svgRect.height);const r=getRect(a);calcCenter(r),translatePath(a,e.calculative.worldRect.x-r.x,e.calculative.worldRect.y-r.y);const o=pathToString(a);if(t){(l=t.svgPath)==null||l.call(t,o);return}return new Path2D(o)}function diamond(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s+r/2,a),i.lineTo(s+r,a+o/2),i.lineTo(s+r/2,a+o),i.lineTo(s,a+o/2),i.lineTo(s+r/2,a),i.closePath(),i instanceof Path2D)return i}function triangle(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s+r/2,a),i.lineTo(s+r,a+o),i.lineTo(s,a+o),i.lineTo(s+r/2,a),i.closePath(),i instanceof Path2D)return i}function triangleAnchors(e){const t=[{x:.5,y:0},{x:.75,y:.5},{x:.5,y:1},{x:.25,y:.5}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function pentagon(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s+r/2,a),i.lineTo(s+r,a+o*2/5),i.lineTo(s+r*4/5,a+o),i.lineTo(s+r/5,a+o),i.lineTo(s,a+o*2/5),i.closePath(),i instanceof Path2D)return i}function pentagonAnchors(e){const t=[{x:.5,y:0},{x:1,y:.4},{x:.8,y:1},{x:.2,y:1},{x:0,y:.4}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function pentagram(e,t){e.onResize||(e.onResize=resize$3);const i=t||new Path2D,{width:s,height:a,center:r}=e.calculative.worldRect,o=s>a?a:s,n=r.x,l=r.y,c=l-o/2,h=l-o/4,d=-(h-l)*Math.sin(Math.PI/180*324)+n,f=(h-l)*Math.cos(Math.PI/180*324)+l;i.moveTo(d,f);for(let u=0;u<5;++u)i.lineTo(-(c-l)*Math.sin(Math.PI/180*72*u)+n,(c-l)*Math.cos(Math.PI/180*72*u)+l),i.lineTo((d-n)*Math.cos(Math.PI/180*72*(u+1))-(f-l)*Math.sin(Math.PI/180*72*(u+1))+n,(d-n)*Math.sin(Math.PI/180*72*(u+1))+(f-l)*Math.cos(Math.PI/180*72*(u+1))+l);if(i.closePath(),i instanceof Path2D)return i}function pentagramAnchors(e){const{width:t,height:i}=e,s=t>i?i:t,a=[];for(let r=0;r<5;++r)a.push({flag:1,id:String(r),penId:e.id,x:.5+s/2*Math.sin(Math.PI/180*72*r)/t,y:-s/2*Math.cos(Math.PI/180*72*r)/i+.5});e.anchors=a}function resize$3(e){const t=e.anchors.filter(i=>i.flag!==1);pentagramAnchors(e),e.anchors=e.anchors.concat(...t)}function hexagon(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s+r/4,a),i.lineTo(s+r*3/4,a),i.lineTo(s+r,a+o/2),i.lineTo(s+r*3/4,a+o),i.lineTo(s+r*1/4,a+o),i.lineTo(s,a+o/2),i.lineTo(s+r/4,a),i.closePath(),i instanceof Path2D)return i}function leftArrow(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s,a+o/2),i.lineTo(s+o/2,a),i.lineTo(s+o/2,a+o/3),i.lineTo(s+r,a+o/3),i.lineTo(s+r,a+o*2/3),i.lineTo(s+o/2,a+o*2/3),i.lineTo(s+o/2,a+o*2/3),i.lineTo(s+o/2,a+o),i.closePath(),i instanceof Path2D)return i}function rightArrow(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s,a+o/3),i.lineTo(s+(r-o/2),a+o/3),i.lineTo(s+(r-o/2),a),i.lineTo(s+r,a+o/2),i.lineTo(s+(r-o/2),a+o),i.lineTo(s+(r-o/2),a+o*2/3),i.lineTo(s,a+o*2/3),i.closePath(),i instanceof Path2D)return i}function twowayArrow(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s,a+o/2),i.lineTo(s+o/2,a),i.lineTo(s+o/2,a+o/3),i.lineTo(s+(r-o/2),a+o/3),i.lineTo(s+(r-o/2),a),i.lineTo(s+r,a+o/2),i.lineTo(s+(r-o/2),a+o),i.lineTo(s+(r-o/2),a+o*2/3),i.lineTo(s+o/2,a+o*2/3),i.lineTo(s+o/2,a+o),i.closePath(),i instanceof Path2D)return i}function message(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o,ey:n}=e.calculative.worldRect;if(i.moveTo(s,a),i.lineTo(s+r,a),i.lineTo(s+r,a+o*3/4),i.lineTo(s+r*8/16,a+o*3/4),i.lineTo(s+r/4,n),i.lineTo(s+r*5/16,a+o*3/4),i.lineTo(s,a+o*3/4),i.closePath(),i instanceof Path2D)return i}function cloud(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s+r/5,a+o*13/16),i.bezierCurveTo(s-r/15,a+o*13/16,s-r/15,a+o*7/16,s+r/5,a+o*7/16),i.bezierCurveTo(s+r/5,a,s+r*4/5,a,s+r*4/5,a+o*7/16),i.bezierCurveTo(s+r*16/15,a+o*7/16,s+r*16/15,a+o*13/16,s+r*4/5,a+o*13/16),i.closePath(),i instanceof Path2D)return i}function file(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ex:o,ey:n}=e.calculative.worldRect,l=r/6;if(i.moveTo(s,a),i.lineTo(o-l,a),i.lineTo(o,a+l),i.lineTo(o,n),i.lineTo(s,n),i.closePath(),i.moveTo(o-l,a),i.lineTo(o-l,a+l),i.lineTo(o,a+l),i.closePath(),i instanceof Path2D)return i}function cube(e,t){const{x:i,y:s,width:a,ex:r,ey:o}=t.calculative.worldRect;let n=a*.25;const l=t.z;l>1?n=l*t.calculative.canvas.store.data.scale:l>0&&(n=a*l);const c={x:i,y:s+n},h={x:r-n,y:s+n},d={x:r-n,y:o};face(e,[c,h,d,{x:i,y:o}],t.backgroundFront||t.background,t.color),face(e,[c,{x:i+n,y:s},{x:r,y:s},h],t.backgroundUp||t.background,t.color),face(e,[h,{x:r,y:s},{x:r,y:o-n},d],t.backgroundRight||t.background,t.color)}function face(e,t,i="",s=""){e.save(),i&&(e.fillStyle=i),s&&(e.strokeStyle=s),e.beginPath();for(let a=0;a<t.length;++a)a?e.lineTo(t[a].x,t[a].y):e.moveTo(t[a].x,t[a].y);e.closePath(),i&&e.fill(),e.stroke(),e.restore()}function people(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ex:o,ey:n}=e.calculative.worldRect,l=r/4,c=s+r/2;if(i.arc(c,a+l,l,0,Math.PI*2),i.moveTo(s,a+l*3),i.lineTo(o,a+l*3),i.moveTo(c,a+l*2),i.lineTo(c,a+l*4),i.moveTo(c,a+l*4),i.lineTo(s,n),i.moveTo(c,a+l*4),i.lineTo(o,n),i.closePath(),i instanceof Path2D)return i}let faceSpace=10;function polyline(e,t,i){var y;if(t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),faceSpace=e.options.polylineSpace||10,t.calculative.worldAnchors.length<2)return;let s=getFromAnchor(t),a=getToAnchor(t);if(!s||!a)return;let r;if((y=t.anchors)!=null&&y.length&&s===t.calculative.activeAnchor?(r=!0,s=a,a=getFromAnchor(t)):(!t.anchors||!t.anchors.length)&&s!==t.calculative.activeAnchor&&(s=t.calculative.activeAnchor),!s||!a)return;s.next=void 0,a.prev=void 0;const o=a.connectTo;deleteTempAnchor(t);const n=[],l=e.pens[s.connectTo],c=e.pens[a.connectTo],h=facePen(s,l),d=facePen(a,c);let f=getFacePoint(s,h,faceSpace);f&&(s=f,n.push(f)),f=getFacePoint(a,d,faceSpace);const u=a;let v;if(f&&(a=f,u.connectTo&&(f.y>u.y&&s.y<u.y||f.y<u.y&&s.y>u.y))){v=f;let m=faceSpace;s.x<f.x&&(m=-m),Math.abs(s.x-f.x)<m&&(m=-m),a={x:f.x+m,y:f.y,id:s8()}}switch(h){case Direction.Up:n.push(...getNextPointsOfUp(s,a,d));break;case Direction.Right:n.push(...getNextPointsOfRight(s,a,d));break;case Direction.Bottom:n.push(...getNextPointsOfBottom(s,a,d));break;case Direction.Left:n.push(...getNextPointsOfLeft(s,a,d));break;default:n.push(...getNextPoints(t,s,a));break}if(n.forEach(m=>{m.id=s8(),m.penId=t.id,t.calculative.worldAnchors.push(m)}),t.calculative.worldAnchors.push(a),v&&t.calculative.worldAnchors.push(v),f&&t.calculative.worldAnchors.push(u),r&&t.calculative.worldAnchors.reverse(),o){const m=t.calculative.worldAnchors.length-2;t.calculative.worldAnchors[m].isTemp=!1,t.calculative.worldAnchors[1].isTemp=!1}}function getFacePoint(e,t,i){const s={x:e.x,y:e.y,id:s8()};switch(t){case Direction.Up:s.y-=i;break;case Direction.Right:s.x+=i;break;case Direction.Bottom:s.y+=i;break;case Direction.Left:s.x-=i;break;default:return}return s}function getNextPointsOfUp(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let a,r;switch(i){case Direction.Up:e.y<t.y?(a=t.x,r=e.y):(a=e.x,r=t.y),s.push({x:a,y:r});break;case Direction.Bottom:if(a=t.x,r=e.y,t.y>e.y)a=e.x+(t.x-e.x)/2,s.push({x:a,y:e.y},{x:a,y:t.y});else{const o=(e.y+t.y)/2;s.push({x:e.x,y:o},{x:t.x,y:o})}break;case Direction.Right:a=t.x,r=e.y,t.x<e.x&&t.y<e.y&&(a=e.x,r=t.y),s.push({x:a,y:r});break;case Direction.Left:a=t.x,r=e.y,t.x>e.x&&t.y<e.y&&(a=e.x,r=t.y),s.push({x:a,y:r});break;default:if(t.y>e.y-faceSpace)a=e.x+(t.x-e.x)/2,s.push({x:a,y:e.y},{x:a,y:t.y});else{const o=(e.y+t.y+faceSpace)/2;s.push({x:e.x,y:o},{x:t.x,y:o})}break}return s}function getNextPointsOfRight(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let a,r;switch(i){case Direction.Up:a=e.x,r=t.y,t.x>e.x&&t.y>e.y&&(a=t.x,r=e.y),s.push({x:a,y:r});break;case Direction.Bottom:a=e.x,r=t.y,t.x>e.x&&t.y<e.y&&(a=t.x,r=e.y),s.push({x:a,y:r});break;case Direction.Left:if(a=t.x,r=e.y,t.x<e.x)r=e.y+(t.y-e.y)/2,s.push({x:e.x,y:r},{x:t.x,y:r});else{const o=(e.x+t.x)/2;s.push({x:o,y:r},{x:o,y:t.y})}break;case Direction.Right:t.x<e.x?s.push({x:e.x,y:t.y}):s.push({x:t.x,y:e.y});break;default:if(a=t.x,r=t.y,t.x<e.x+faceSpace)s.push({x:e.x,y:r});else{const o=(e.x+t.x-faceSpace)/2;s.push({x:o,y:e.y},{x:o,y:r})}break}return s}function getNextPointsOfBottom(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let a,r;switch(i){case Direction.Up:if(a=e.x,r=t.y,t.y<e.y)a=e.x+(t.x-e.x)/2,s.push({x:a,y:e.y},{x:a,y:t.y});else{const o=(e.y+t.y)/2;s.push({x:a,y:o},{x:t.x,y:o})}break;case Direction.Right:a=t.x,r=e.y,t.x<e.x&&t.y>e.y&&(a=e.x,r=t.y),s.push({x:a,y:r});break;case Direction.Bottom:e.y>t.y?(a=t.x,r=e.y):(a=e.x,r=t.y),s.push({x:a,y:r});break;case Direction.Left:a=t.x,r=e.y,t.x>e.x&&t.y>e.y&&(a=e.x,r=t.y),s.push({x:a,y:r});break;default:if(a=e.x,t.y<e.y+faceSpace)a=e.x+(t.x-e.x)/2,s.push({x:a,y:e.y},{x:a,y:t.y});else{const o=(e.y+t.y-faceSpace)/2;s.push({x:a,y:o},{x:t.x,y:o})}break}return s}function getNextPointsOfLeft(e,t,i){if(e.x===t.x||e.y===t.y)return[];const s=[];let a,r;switch(i){case Direction.Up:a=e.x,r=t.y,t.x<e.x&&t.y>e.y&&(a=t.x,r=e.y),s.push({x:a,y:r});break;case Direction.Bottom:a=e.x,r=t.y,t.x<e.x&&t.y<e.y&&(a=t.x,r=e.y),s.push({x:a,y:r});break;case Direction.Right:if(a=e.x,r=t.y,t.x>e.x)a=t.x,r=e.y+(t.y-e.y)/2,s.push({x:e.x,y:r},{x:t.x,y:r});else{const o=(e.x+t.x)/2;s.push({x:o,y:e.y},{x:o,y:t.y})}break;case Direction.Left:t.x>e.x?s.push({x:e.x,y:t.y}):s.push({x:t.x,y:e.y});break;default:if(a=e.x,r=t.y,t.x<e.x-faceSpace){const o=(e.x+t.x+faceSpace)/2;s.push({x:o,y:e.y},{x:o,y:r})}else s.push({x:e.x,y:r});break}return s}function getNextPoints(e,t,i){const s=[];e.calculative.drawlineH==null&&(e.calculative.drawlineH=Math.abs(i.x-t.x)>Math.abs(i.y-t.y));let a=e.calculative.worldAnchors.findIndex(r=>r.id==t.id);if(a>1){let r=e.calculative.worldAnchors[a-1];if(r.x===t.x&&r.y!==t.y)return s.push({x:i.x,y:t.y}),s;if(r.y===t.y&&r.x!==t.x)return s.push({x:t.x,y:i.y}),s}return e.calculative.worldAnchors.length&&(i.isTemp=void 0,e.calculative.drawlineH?(s.push({x:i.x,y:t.y}),Math.abs(i.y-t.y)<faceSpace&&(i.isTemp=!0)):(s.push({x:t.x,y:i.y}),Math.abs(i.x-t.x)<faceSpace&&(i.isTemp=!0))),s}function anchorInHorizontal(e,t,i=!0){var a,r;let s=e.calculative.worldAnchors;i||(s=[],e.calculative.worldAnchors.forEach(o=>{s.unshift(o)}));for(let o=0;o<s.length&&s[o].id!==t.id;o++)if(s[o].y!==t.y||s[o].x===((a=s[o+1])==null?void 0:a.x)&&s[o].y!==((r=s[o+1])==null?void 0:r.y))return!1;return!0}function anchorInVertical(e,t,i=!0){var a,r;let s=e.calculative.worldAnchors;i||(s=[],e.calculative.worldAnchors.forEach(o=>{s.unshift(o)}));for(let o=0;o<s.length&&s[o].id!==t.id;o++)if(s[o].x!==t.x||s[o].y===((a=s[o+1])==null?void 0:a.y)&&s[o].x!==((r=s[o+1])==null?void 0:r.x))return!1;return!0}function translatePolylineAnchor(e,t,i){if(!e.calculative.worldAnchors)return;const s=e.calculative.worldAnchors.findIndex(l=>l.id===t.id),a=getFromAnchor(e),r=getToAnchor(e);let o=e.calculative.worldAnchors[s-1],n=e.calculative.worldAnchors[s+1];if(e.calculative.h==null&&(a.connectTo&&(anchorInHorizontal(e,t,!0)?e.calculative.h=!0:anchorInVertical(e,t,!0)&&(e.calculative.h=!1)),e.calculative.h==null&&r.connectTo&&(anchorInHorizontal(e,t,!1)?e.calculative.h=!0:anchorInVertical(e,t,!1)&&(e.calculative.h=!1)),e.calculative.h==null&&(o?e.calculative.h=o.y===t.y:n&&(e.calculative.h=n.y===t.y))),e.calculative.h){if(t.x=i.x,a.connectTo&&anchorInHorizontal(e,t,!0)){n&&n.y!==t.y&&(n.x=t.x);return}if(r.connectTo&&anchorInHorizontal(e,t,!1)){o&&o.y!==t.y&&(o.x=t.x);return}const l=e.anchors[s];let c;for(let h=s-1;h>-1;h--)if(o=e.anchors[h],c==null&&(c=o.y===l.y),c===!0)if(o.y===l.y)e.calculative.worldAnchors[h].y=i.y;else break;else if(o.x===l.x)e.calculative.worldAnchors[h].x=i.x;else break;c=void 0;for(let h=s+1;h<e.calculative.worldAnchors.length&&(n=e.anchors[h],n);h++)if(c==null&&(c=n.y===l.y),c===!0)if(n.y===l.y)e.calculative.worldAnchors[h].y=i.y;else break;else if(n.x===l.x)e.calculative.worldAnchors[h].x=i.x;else break;t.y=i.y}else{if(t.y=i.y,a.connectTo&&anchorInVertical(e,t,!0)){n&&n.x!==t.x&&(n.y=t.y);return}if(r.connectTo&&anchorInVertical(e,t,!1)){o&&o.x!==t.x&&(o.y=t.y);return}const l=e.anchors[s];let c;for(let h=s-1;h>-1;h--)if(o=e.anchors[h],c==null&&(c=o.x===l.x),c===!0)if(o.x===l.x)e.calculative.worldAnchors[h].x=i.x;else break;else if(o.y===l.y)e.calculative.worldAnchors[h].y=i.y;else break;c=void 0;for(let h=s+1;h<e.calculative.worldAnchors.length&&(n=e.anchors[h],n);h++)if(c==null&&(c=n.x===l.x),c===!0)if(n.x===l.x)e.calculative.worldAnchors[h].x=i.x;else break;else if(n.y===l.y)e.calculative.worldAnchors[h].y=i.y;else break;t.x=i.x}}function simplify(e,t,i,s){const a=[];let r,o,n,l,c,h,d,f,u,v,y,m,w,x;u=e[i],v=e[s],n=u.x,l=u.y,d=v.x-n,f=v.y-l,x=d*d+f*f,r=t;for(let b=i+1;b<s;b++)y=e[b],d!==0||f!==0?(m=((y.x-n)*d+(y.y-l)*f)/x,m>1?(c=y.x-v.x,h=y.y-v.y):m>0?(c=y.x-(n+d*m),h=y.y-(l+f*m)):(c=y.x-n,h=y.y-l)):(c=y.x-n,h=y.y-l),w=c*c+h*h,w>r&&(o=b,r=w);return r>t&&(o-i>1&&a.push(...simplify(e,t,i,o)),a.push({id:e[o].id,penId:e[o].penId,x:e[o].x,y:e[o].y}),s-o>1&&a.push(...simplify(e,t,o,s))),a}function smoothLine(e,t=.8,i=!1){if(e.length<3)return e;let s,a,r,o,n,l,c,h,d,f,u,v,y,m,w;const x=(b,T,p,R)=>(o=Math.sqrt(b*b+T*T),o>0?(v=b/o,m=T/o):(v=1,m=0),n=Math.sqrt(p*p+R*R),n>0?(y=p/n,w=R/n):(y=1,w=0),Math.acos(v*y+m*w));f=[],u=e.length,s=e[0],e[u-1],f.push({...e[0]});for(let b=0;b<u-1;b++){if(a=e[b],r=e[b+1],d=Math.abs(x(a.x-s.x,a.y-s.y,r.x-a.x,r.y-a.y)),o)if(d<t*3.14)if(i&&(o=Math.min(o,n),n=o),l=(v+y)/2,c=(m+w)/2,h=Math.sqrt(l*l+c*c),h===0)f.push({...a});else{l/=h,c/=h;const T={...a};T.prevNextType=PrevNextType.Bilateral,T.prev={penId:T.penId,x:a.x-l*o*.25,y:a.y-c*o*.25},T.next={penId:T.penId,x:a.x+l*n*.25,y:a.y+c*n*.25},f.push(T)}else f.push({...a});s=a}return f.push({...e[e.length-1]}),f}function iframe(e){var i;e.onDestroy||(e.onDestroy=destory$4,e.onMove=move$4,e.onResize=move$4,e.onRotate=move$4,e.onValue=move$4,e.onMouseMove=mouseMove$2,e.onBeforeValue=beforeValue$6,e.onRenderPenRaw=renderPenRaw),e.calculative.singleton||(e.calculative.singleton={});const t=e.calculative.worldRect;if(!e.calculative.singleton.div){const s=document.createElement("div");s.style.position="absolute",s.style.outline="none",s.style.left="-9999px",s.style.top="-9999px",s.style.width=t.width+"px",s.style.height=t.height+"px",document.body.appendChild(s),(i=e.calculative.canvas.externalElements)==null||i.parentElement.appendChild(s),setElemPosition(e,s),e.calculative.singleton.div=s;const a=document.createElement("iframe");a.style.width="100%",a.style.height="100%",a.scrolling=e.scrolling||"no",a.frameBorder="0",a.style.border="none",a.src=e.iframe,e.calculative.iframe=e.iframe,s.appendChild(a),generateAroundDiv(e),a.onload=()=>{a.setAttribute("document.domain","")}}return e.calculative.patchFlags&&setElemPosition(e,e.calculative.singleton.div),e.onRenderPenRaw(e),new Path2D}function destory$4(e){updatePointerEvents(e),e.calculative.singleton&&e.calculative.singleton.div&&(e.calculative.singleton.div.remove(),delete e.calculative.singleton.div)}function move$4(e){e.calculative.singleton.div&&setElemPosition(e,e.calculative.singleton.div)}function beforeValue$6(e,t){if(t.iframe&&e.calculative.singleton.div&&(e.calculative.singleton.div.children[0].src=t.iframe,e.calculative.iframe=t.iframe),t.operationalRect||t["operationalRect.x"]!==void 0||t["operationalRect.y"]!==void 0||t["operationalRect.width"]!==void 0||t["operationalRect.height"]!==void 0){e.operationalRect||(e.operationalRect={});let i=deepClone(t);i.operationalRect||(i.operationalRect={}),i["operationalRect.x"]!==void 0&&(i.operationalRect.x=i["operationalRect.x"]),i["operationalRect.y"]!==void 0&&(i.operationalRect.y=i["operationalRect.y"]),i["operationalRect.width"]!==void 0&&(i.operationalRect.width=i["operationalRect.width"]),i["operationalRect.height"]!==void 0&&(i.operationalRect.height=i["operationalRect.height"]),Object.assign(e.operationalRect,i.operationalRect),e.calculative.singleton.div&&(e.calculative.singleton.div.children.length===1?generateAroundDiv(e):(e.calculative.singleton.div.children[1].style.height=e.operationalRect.y*100+"%",e.calculative.singleton.div.children[1].style.left=e.operationalRect.x*100+"%",e.calculative.singleton.div.children[1].style.width=e.operationalRect.width*100+"%",e.calculative.singleton.div.children[2].style.width=(1-e.operationalRect.x-e.operationalRect.width)*100+"%",e.calculative.singleton.div.children[3].style.height=(1-e.operationalRect.y-e.operationalRect.height)*100+"%",e.calculative.singleton.div.children[3].style.left=e.operationalRect.x*100+"%",e.calculative.singleton.div.children[3].style.width=e.operationalRect.width*100+"%",e.calculative.singleton.div.children[4].style.width=e.operationalRect.x*100+"%"))}if(t.blur!==void 0)for(let i=1;i<5;i++)e.calculative.singleton.div.children[i].style["backdrop-filter"]=`blur(${t.blur||2}px)`;if(t.blurBackground!==void 0)for(let i=1;i<5;i++)e.calculative.singleton.div.children[i].style.backgroundColor=t.blurBackground;return t}function mouseMove$2(e,t){if(!(!e.calculative.canvas.store.data.locked&&!e.locked)&&initOperationalRect(e.operationalRect)&&e.calculative.zIndex<5&&t.x>e.x+e.width*e.operationalRect.x&&t.x<e.x+e.width*(e.operationalRect.x+e.operationalRect.width)&&t.y>e.y+e.height*e.operationalRect.y&&t.y<e.y+e.height*(e.operationalRect.y+e.operationalRect.height)&&e.calculative.singleton.div){let i=e.calculative.singleton.div.parentNode.children;for(let s=0;s<6;s++)i[s].style.pointerEvents="none"}}function initOperationalRect(e){return e?!e.width||!e.height?!1:(e.x===void 0&&(e.x=(1-e.width)/2),e.y===void 0&&(e.y=(1-e.height)/2),!0):!1}function generateAroundDiv(e){if(!initOperationalRect(e.operationalRect))return;const t=e.calculative.singleton.div;if(!t)return;const i=document.createElement("div");i.style.position="absolute",i.style.left=e.operationalRect.x*100+"%",i.style.top="0px",i.style.width=e.operationalRect.width*100+"%",i.style.height=e.operationalRect.y*100+"%",i.style["backdrop-filter"]=`blur(${e.blur||2}px)`,i.style.backgroundColor=e.blurBackground,t.appendChild(i);const s=document.createElement("div");s.style.position="absolute",s.style.right="0px",s.style.top="0px",s.style.width=(1-e.operationalRect.x-e.operationalRect.width)*100+"%",s.style.height="100%",s.style["backdrop-filter"]=`blur(${e.blur||2}px)`,s.style.backgroundColor=e.blurBackground,t.appendChild(s);const a=document.createElement("div");a.style.position="absolute",a.style.left=e.operationalRect.x*100+"%",a.style.bottom="0px",a.style.width=e.operationalRect.width*100+"%",a.style.height=(1-e.operationalRect.y-e.operationalRect.height)*100+"%",a.style["backdrop-filter"]=`blur(${e.blur||2}px)`,a.style.backgroundColor=e.blurBackground,t.appendChild(a);const r=document.createElement("div");r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.width=e.operationalRect.x*100+"%",r.style.height="100%",r.style["backdrop-filter"]=`blur(${e.blur||2}px)`,r.style.backgroundColor=e.blurBackground,t.appendChild(r);let o=()=>{updatePointerEvents(e)};i.onmouseenter=o,a.onmouseenter=o,s.onmouseenter=o,r.onmouseenter=o,t.onmouseleave=o}function updatePointerEvents(e){if(!(!e.calculative.canvas.store.data.locked&&!e.locked)&&e.calculative.zIndex<5){let t=e.calculative.singleton.div.parentNode.children;for(let i=1;i<6;i++)t[i].style.pointerEvents="initial"}}function renderPenRaw(e){if(e.thumbImg&&!e.calculative.img){const t=new Image;t.crossOrigin=e.crossOrigin==="undefined"?void 0:e.crossOrigin||"anonymous",e.calculative.canvas.store.options.cdn&&!(e.thumbImg.startsWith("http")||e.thumbImg.startsWith("//")||e.thumbImg.startsWith("data:image"))?t.src=e.calculative.canvas.store.options.cdn+e.thumbImg:t.src=e.thumbImg,t.onerror=i=>{t.remove(),e.calculative.img=void 0},e.calculative.img=t}}const videos={},mutedIcons=['<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M473.088 125.44L256 256H52.224C23.552 256 0 279.552 0 308.224V716.8c0 28.16 23.04 51.2 51.2 51.2h204.8l217.088 130.56c16.896 10.24 38.912-2.048 38.912-22.016V147.456c0-19.968-21.504-32.256-38.912-22.016zM699.904 320.512c-20.992-18.944-53.248-17.408-72.192 3.584-18.944 20.992-17.408 53.248 3.584 72.192 0.512 0.512 58.368 54.784 58.368 121.344 0 37.888-19.456 74.752-58.368 110.08-20.992 18.944-22.528 51.2-3.584 72.192 10.24 11.264 24.064 16.896 37.888 16.896 12.288 0 24.576-4.608 34.304-13.312 61.44-55.296 92.16-117.76 92.16-185.856 0-112.64-88.576-193.536-92.16-197.12z" fill="" p-id="2434"></path><path d="M853.504 166.4c-20.992-18.944-53.248-16.896-72.192 4.096-18.944 20.992-16.896 53.248 4.096 72.192 1.536 1.024 135.68 122.88 135.68 280.576 0 90.624-45.568 177.152-135.68 257.536-20.992 18.944-23.04 51.2-4.096 72.192 10.24 11.264 24.064 16.896 38.4 16.896 12.288 0 24.576-4.096 34.304-12.8 112.64-100.864 169.984-212.992 169.984-333.824-1.024-202.752-163.84-350.208-170.496-356.864z"></path></svg>','<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" ><path d="M256 768H51.2c-28.16 0-51.2-23.04-51.2-51.2V308.224C0 279.552 23.552 256 52.224 256H256v512zM512 147.456v728.576c0 19.968-21.504 32.256-38.912 22.016L256 768V256l217.088-130.56c17.408-10.24 38.912 2.048 38.912 22.016zM623.104 656.896c-19.968-19.968-19.968-52.224 0-72.192l217.088-217.088c19.968-19.968 52.224-19.968 72.192 0 19.968 19.968 19.968 52.224 0 72.192l-217.088 217.088c-19.456 19.968-52.224 19.968-72.192 0z" fill="" p-id="2582"></path><path d="M623.104 367.104c19.968-19.968 52.224-19.968 72.192 0l217.088 217.088c19.968 19.968 19.968 52.224 0 72.192-19.968 19.968-52.224 19.968-72.192 0l-217.088-217.088c-19.968-19.456-19.968-52.224 0-72.192z"></path></svg>'];function video(e){var t;if(e.onDestroy||(e.onDestroy=destory$3,e.onMove=move$3,e.onResize=move$3,e.onRotate=move$3,e.onClick=click$1,e.onValue=value$3,e.onChangeId=changeId$1),videos[e.id])e.video&&e.calculative.media&&e.video!==e.calculative.video?(console.warn("video 更改, 此处是否执行？"),e.calculative.media.src=e.video,e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop,e.calculative.video=e.video):e.audio&&e.calculative.media&&e.audio!==e.calculative.audio&&(e.calculative.media.src=e.audio,e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop,e.calculative.audio=e.audio);else{const i=document.createElement("div"),s=document.createElement("div");s.style.position="absolute",s.style.outline="none",s.style.left="0",s.style.bottom="0",s.style.width="0",s.style.height="2px",s.style.background="#52c41a",s.style.zIndex="1",e.hideProgress&&(s.style.display="none");const a=document.createElement("div");a.innerHTML=mutedIcons[1],a.style.position="absolute",a.style.right="0",a.style.bottom="0",a.style.width="20px",a.style.height="20px",a.style.fill="hsla(0, 0%, 100%, .8)",a.style.zIndex="1",a.style.display="none",i.appendChild(s),i.appendChild(a),a.onclick=o=>{o.stopPropagation(),e.calculative.media.muted?(a.innerHTML=mutedIcons[0],e.calculative.media.muted=!1):(a.innerHTML=mutedIcons[1],e.calculative.media.muted=!0)},e.calculative.singleton||(e.calculative.singleton={}),e.calculative.singleton.muted=a,i.onmouseenter=o=>{a.style.display="block"},i.onmouseleave=o=>{a.style.display="none"},i.onclick=o=>{o.stopPropagation(),click$1(e)};let r;e.audio?(r=document.createElement("audio"),r.controls=e.controls,r.src=e.audio):(r=document.createElement("video"),r.src=e.video),r.loop=e.playLoop,r.ontimeupdate=()=>{resizeProcessWidth(s,r,e.calculative.worldRect.width)},r.onended=()=>{e.calculative.onended&&e.calculative.onended(e)},e.calculative.media=r,r.style.position="absolute",r.style.outline="none",r.style.left="0",r.style.top="0",r.style.width="100%",r.style.height="100%",i.appendChild(r),videos[e.id]=i,(t=e.calculative.canvas.externalElements)==null||t.parentElement.appendChild(i),setElemPosition(e,i),e.autoPlay&&(r.autoplay=!0,r.muted=!0)}return e.calculative.patchFlags&&setElemPosition(e,videos[e.id]),new Path2D}function destory$3(e){videos[e.id].onclick=null,videos[e.id].remove(),videos[e.id]=void 0}function move$3(e){setElemPosition(e,videos[e.id]);const t=videos[e.id].children[0],i=videos[e.id].children[1];resizeProcessWidth(t,i,e.calculative.worldRect.width)}function click$1(e){e.calculative.media&&(e.calculative.media.muted=!1,e.calculative.singleton.muted.innerHTML=mutedIcons[0],e.calculative.media.paused?e.calculative.media.play():e.calculative.media.pause())}function resizeProcessWidth(e,t,i){e.style.width=t.currentTime/t.duration*i+"px"}function changeId$1(e,t,i){videos[t]&&(videos[i]=videos[t],delete videos[t])}function value$3(e){const t=videos[e.id];if(!t)return;setElemPosition(e,t);const i=e.calculative.media.getAttribute("src");e.video?i!==e.video&&(e.calculative.media.src=e.video):e.audio&&i!==e.audio&&(e.calculative.media.src=e.audio),e.autoPlay&&(e.calculative.media.muted=!0,e.calculative.media.autoplay=!0),e.calculative.media.loop=e.playLoop}function createOffscreen(){try{const e=new OffscreenCanvas(0,0),t=e.getContext("2d");return t&&t.arc?e:document.createElement("canvas")}catch{return document.createElement("canvas")}}class Tooltip{constructor(t,i){g(this,"parentElement");g(this,"store");g(this,"box");g(this,"text");g(this,"arrowUp");g(this,"arrowDown");g(this,"x");g(this,"y");g(this,"currentPen");this.parentElement=t,this.store=i,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.box.className="meta2d-tooltip",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),t.appendChild(this.box),this.box.onmouseleave=()=>{this.hide(),this.store.lastHover=void 0};let s;for(let a=0;a<document.styleSheets.length;a++)document.styleSheets[a].title==="le5le.com/tooltip"&&(s=document.styleSheets[a]);if(!s){let a=document.createElement("style");a.type="text/css",a.title="le5le.com/tooltip",document.head.appendChild(a),a=document.createElement("style"),a.type="text/css",document.head.appendChild(a),s=a.sheet,s.insertRule(".meta2d-tooltip{position:absolute;padding:8px 0;z-index:10;left: -9999px;top: -9999px;}"),s.insertRule(".meta2d-tooltip .text{max-width:320px;min-height:30px;max-height:400px;outline:none;padding:8px 16px;border-radius:4px;background:#777777;color:#ffffff;line-height:1.8;overflow-y:auto;}"),s.insertRule(".meta2d-tooltip .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-5px;left:50%;transform:translateX(-50%)}"),s.insertRule(".meta2d-tooltip .arrow.down{top:initial;bottom: -1px;}")}}static getTitle(t){if(t.titleFnJs&&!t.titleFn)try{t.titleFn=new Function("pen",t.titleFnJs)}catch(i){console.log("titleFnJs",i)}return t.titleFn?t.titleFn(t):String(t.title)}setText(t){const i=this.box.getBoundingClientRect();let s=globalThis.marked;const a=Tooltip.getTitle(t);if(s){this.text.innerHTML=s(a);const r=this.text.getElementsByTagName("A");for(let o=0;o<r.length;++o)r[o].setAttribute("target","_blank")}else this.text.innerHTML=a;return i}updateText(t){var a;if(((a=this.currentPen)==null?void 0:a.id)!==t.id||Tooltip.titleEmpty(t))return;const i=this.setText(t),s=this.box.getBoundingClientRect();this.changePositionByText(i,s)}changePositionByText(t,i){this.x-=(i.width-t.width)/2,this.y-=i.height-t.height,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}static titleEmpty(t){return!t.title&&!t.titleFn&&!t.titleFnJs}show(t,i){if(this.currentPen=t,Tooltip.titleEmpty(t)){let n=getParent(t,!0);n&&this.show(n,i);return}this.setText(t);const s=this.box.getBoundingClientRect(),a=t.calculative.worldRect;let r=t.calculative.canvas.store.data.x+i.x-s.width/2,o=t.calculative.canvas.store.data.y+i.y-s.height;t.type||(r=t.calculative.canvas.store.data.x+a.x-(s.width-a.width)/2,o=t.calculative.canvas.store.data.y+a.ey-s.height-a.height),o>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#777777"):(o+=s.height+a.height+5,this.arrowUp.style.borderBottomColor="#777777",this.arrowDown.style.borderTopColor="transparent"),this.x=r,this.y=o,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.currentPen=null,this.x=-9999,this.box.style.left="-9999px"}translate(t,i){this.x<-1e3||(this.x+=t,this.y+=i,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px")}destroy(){this.box.onmouseleave=null}}class Scroll{constructor(t){g(this,"parent");g(this,"h");g(this,"v");g(this,"isDownH");g(this,"isDownV");g(this,"x");g(this,"y");g(this,"hSize");g(this,"vSize");g(this,"scrollX");g(this,"scrollY");g(this,"lastScrollX");g(this,"lastScrollY");g(this,"rect");g(this,"isShow");g(this,"pageMode");g(this,"onMouseDownH",t=>{t.preventDefault(),t.stopPropagation(),this.isDownH=t.x,this.x=this.parent.store.data.x||0,this.lastScrollX=this.scrollX});g(this,"onMouseDownV",t=>{t.preventDefault(),t.stopPropagation(),this.isDownV=t.y,this.y=this.parent.store.data.y||0,this.lastScrollY=this.scrollY});g(this,"onMouseMove",t=>{if(this.isDownH){const i=t.x-this.isDownH;this.scrollX=this.lastScrollX+i,this.h.style.left=`${this.scrollX}px`,this.parent.store.data.x=this.x-i*this.rect.width/this.parent.parentElement.clientWidth}if(this.isDownV){const i=t.y-this.isDownV;if(this.pageMode&&this.canMouseMove(i))return;this.scrollY=this.lastScrollY+i,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y=this.y-i*this.rect.height/this.parent.parentElement.clientHeight}(this.isDownH||this.isDownV)&&(this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())});g(this,"onMouseUp",t=>{!this.isDownH&&!this.isDownV||(this.isDownH=void 0,this.isDownV=void 0,this.scrollX<20?(this.scrollX=20,this.h.style.left=`${this.scrollX}px`):this.scrollX>this.parent.parentElement.clientWidth-this.hSize-20&&(this.scrollX=this.parent.parentElement.clientWidth-this.hSize-20,this.h.style.left=`${this.scrollX}px`),this.scrollY<20?(this.scrollY=20,this.v.style.top=`${this.scrollY}px`):this.scrollY>this.parent.parentElement.clientHeight-this.vSize-20&&(this.scrollY=this.parent.parentElement.clientHeight-this.vSize-20,this.v.style.top=`${this.scrollY}px`),this.resize())});this.parent=t,this.h=document.createElement("div"),this.v=document.createElement("div"),this.parent.externalElements.appendChild(this.h),this.parent.externalElements.appendChild(this.v),this.h.className="meta2d-scroll h",this.h.onmousedown=this.onMouseDownH,this.v.className="meta2d-scroll v",this.v.onmousedown=this.onMouseDownV,document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp);let i;for(let s=0;s<document.styleSheets.length;s++)document.styleSheets[s].title==="le5le/scroll"&&(i=document.styleSheets[s]);if(!i){let s=document.createElement("style");s.type="text/css",s.title="le5le.com/scroll",document.head.appendChild(s),s=document.createElement("style"),s.type="text/css",document.head.appendChild(s),i=s.sheet,i.insertRule(".meta2d-scroll{position:absolute;width:8px;height:200px;background:#dddddd;border-radius:10px;z-index:20;cursor:default;}"),i.insertRule(".meta2d-scroll:hover{background:#cccccc;cursor:pointer}"),i.insertRule(".meta2d-scroll.v{right:0;top:calc(50% - 100px);}"),i.insertRule(".meta2d-scroll.h{bottom:2px;left:calc(50% - 100px);width:200px;height:8px;}")}this.init()}init(){this.isShow=!0,this.resize(),this.initPos()}canMouseMove(t){const i=this.parent.parent.getRect();return t<0&&i.y+this.parent.store.data.y>=0||t>0&&i.ey-this.parent.height+this.parent.store.data.y<=0}changeMode(){this.pageMode=!0,this.h.style.display="none",this.parent.parent.getRect().height<this.parent.height&&(this.v.style.display="none")}initPos(){this.scrollX=(this.parent.parentElement.clientWidth-this.hSize)/2,this.scrollY=(this.parent.parentElement.clientHeight-this.vSize)/2,this.h.style.left=`${this.scrollX}px`,this.v.style.top=`${this.scrollY}px`}resize(){this.rect=getRect$1(this.parent.store.data.pens),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.parent.store.data.x>0?this.rect.width+=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x):this.rect.width-=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x),this.parent.store.data.y>0?this.rect.height+=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y):this.rect.height-=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.hSize=1e3*this.parent.parentElement.clientWidth/this.rect.width/3,this.vSize=1e3*this.parent.parentElement.clientHeight/this.rect.height/3,this.h.style.width=this.hSize+"px",this.v.style.height=this.vSize+"px"}show(){this.isShow=!0,this.h.style.display="block",this.v.style.display="block",document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}hide(){this.isShow=!1,this.h.style.display="none",this.v.style.display="none",this.destroy()}translate(t,i){t&&(this.scrollX-=t*this.parent.parentElement.clientWidth/this.rect.width,this.h.style.left=`${this.scrollX}px`),i&&(this.scrollY-=i*this.parent.parentElement.clientHeight/this.rect.height,this.v.style.top=`${this.scrollY}px`)}wheel(t){let i=10;t&&(i=-10),!(this.pageMode&&this.canMouseMove(i))&&(this.scrollY+=i,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y-=i*this.rect.height/this.parent.parentElement.clientHeight,this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())}destroy(){document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}}class CanvasImage{constructor(t,i,s){g(this,"parentElement");g(this,"store");g(this,"isBottom");g(this,"canvas",document.createElement("canvas"));g(this,"otherOffsreen",createOffscreen());g(this,"offscreen",createOffscreen());g(this,"animateOffsScreen",createOffscreen());g(this,"fitOffscreen",createOffscreen());g(this,"fitFlag",!1);g(this,"currentFit");g(this,"activeFit");this.parentElement=t,this.store=i,this.isBottom=s,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(t,i){this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.otherOffsreen.width=t,this.otherOffsreen.height=i,this.offscreen.width=t,this.offscreen.height=i,this.animateOffsScreen.width=t,this.animateOffsScreen.height=i,this.fitOffscreen.width=t,this.fitOffscreen.height=i,this.otherOffsreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.otherOffsreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.animateOffsScreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.animateOffsScreen.getContext("2d").textBaseline="middle",this.fitOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.fitOffscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.store.data.pens)this.hasImage(t)&&(t.calculative.imageDrawed=!1);this.isBottom?this.store.patchFlagsBackground=!0:this.store.patchFlagsTop=!0}clear(){this.otherOffsreen.getContext("2d").clearRect(0,0,this.otherOffsreen.width,this.otherOffsreen.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}hasImage(t){return t.calculative.hasImage=t.calculative&&t.calculative.inView&&(this.isBottom&&t.canvasLayer===CanvasLayer.CanvasImageBottom||!this.isBottom&&t.canvasLayer===CanvasLayer.CanvasImage)&&t.image&&t.calculative.img&&t.name!=="gif",t.calculative.hasImage}render(){var o;let t=!1,i=!1;for(const n of this.store.data.pens)this.hasImage(n)&&(this.store.animates.has(n)?i=!0:n.calculative.imageDrawed||(t=!0),n.parentId&&this.store.animates.has(getParent(n,!0))&&(i=!0));const s=this.store.patchFlagsBackground,a=this.store.patchFlagsTop;if(a&&!this.isBottom){const n=this.otherOffsreen.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderRule(n)}if(this.store.patchFlagsLast&&this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),t){const n=this.offscreen.getContext("2d");n.save(),n.clearRect(0,0,this.canvas.width,this.canvas.height),n.translate(this.store.data.x,this.store.data.y);for(const l of this.store.data.pens)!l.calculative.hasImage||this.store.animates.has(l)||this.store.animates.has(getParent(l,!0))||l.canvasLayer!==CanvasLayer.CanvasTemplate&&(l.name==="combine"&&!l.draw||(l.calculative.imageDrawed=!0,n.save(),ctxFlip(n,l),l.calculative.rotate&&ctxRotate(n,l),setGlobalAlpha(n,l),drawImage(n,l),n.restore()));n.restore()}if(i){const n=this.animateOffsScreen.getContext("2d");n.save(),n.clearRect(0,0,this.canvas.width,this.canvas.height),n.translate(this.store.data.x,this.store.data.y);for(const l of this.store.animates)l.calculative.hasImage&&l.canvasLayer!==CanvasLayer.CanvasTemplate&&(l.visible===!1||l.calculative.visible===!1||(l.calculative.imageDrawed=!0,n.save(),ctxFlip(n,l),l.calculative.rotate&&ctxRotate(n,l),setGlobalAlpha(n,l),drawImage(n,l),n.restore()));for(const l of this.store.data.pens)!l.calculative.hasImage||!l.parentId||l.canvasLayer!==CanvasLayer.CanvasTemplate&&(l.visible===!1||l.calculative.visible===!1||this.store.animates.has(getParent(l,!0))&&(l.calculative.imageDrawed=!0,n.save(),ctxFlip(n,l),l.calculative.rotate&&ctxRotate(n,l),setGlobalAlpha(n,l),drawImage(n,l),n.restore()));n.restore()}if(!this.isBottom&&!this.store.data.locked&&this.fitFlag){const n=(this.store.data.width||this.store.options.width)*this.store.data.scale,l=(this.store.data.height||this.store.options.height)*this.store.data.scale,c=this.store.data.origin.x+this.store.data.x||this.store.options.x||0,h=this.store.data.origin.y+this.store.data.y||this.store.options.y||0,d=this.fitOffscreen.getContext("2d");d.save(),d.clearRect(0,0,this.canvas.width,this.canvas.height),d.fillStyle="#ffffff66",d.strokeStyle=this.store.styles.activeColor,(o=this.store.data.fits)==null||o.forEach((f,u)=>{d.fillRect(c+n*f.x,h+l*f.y,n*f.width,l*f.height),f.active&&d.strokeRect(c+n*f.x,h+l*f.y,n*f.width,l*f.height)}),d.restore()}if(t||i||s&&this.isBottom||a&&!this.isBottom){const n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height),this.isBottom&&(this.store.patchFlagsBackground=!1),n.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),n.drawImage(this.animateOffsScreen,0,0,this.canvas.width,this.canvas.height),this.isBottom||(n.drawImage(this.otherOffsreen,0,0,this.canvas.width,this.canvas.height),this.store.patchFlagsTop=!1,!this.store.data.locked&&this.fitFlag&&n.drawImage(this.fitOffscreen,0,0,this.canvas.width,this.canvas.height))}}renderRule(t){var b,T,p,R,k,I,P,A;const{data:i,options:s}=this.store,{rule:a,ruleColor:r,scale:o,origin:n}=i;if(!(a??s.rule))return;const l=o*10;t.save();const c=r||s.ruleColor||"#ccc";t.strokeStyle=rgba(c,.7);const h=n.x+i.x,d=n.y+i.y,{width:f,height:u}=this.canvas;let v=((b=s.ruleOptions)==null?void 0:b.height)||20;(T=s.ruleOptions)!=null&&T.background&&(t.beginPath(),t.fillStyle=(p=s.ruleOptions)==null?void 0:p.background,t.rect(0,0,f,v),t.fill(),t.rect(0,0,v,u),t.fill()),(R=s.ruleOptions)!=null&&R.underline&&(t.beginPath(),t.fillStyle=rgba(c,.7),t.moveTo(0,v),t.lineTo(f,v),t.stroke(),t.moveTo(v,0),t.lineTo(v,u),t.stroke());let y=v/4;((k=s.ruleOptions)==null?void 0:k.baseline)==="bottom"&&(y=v*3/4),t.beginPath(),t.lineWidth=v/2,t.lineDashOffset=-h%l,t.setLineDash([1,l-1]),t.moveTo(0,y),t.lineTo(f,y),t.stroke(),t.beginPath(),t.lineDashOffset=-d%l,t.moveTo(y,0),t.lineTo(y,u),t.stroke(),t.strokeStyle=c,t.beginPath(),t.lineWidth=v,t.lineDashOffset=-h%(l*10),t.setLineDash([1,l*10-1]),t.moveTo(0,v/2),t.lineTo(f,v/2),t.stroke(),t.beginPath(),t.lineDashOffset=-d%(l*10),t.moveTo(v/2,0),t.lineTo(v/2,u),t.stroke(),t.beginPath(),t.fillStyle=((I=s.ruleOptions)==null?void 0:I.textColor)||t.strokeStyle;let m=0-Math.floor(h/l/10)*100,w=((P=s.ruleOptions)==null?void 0:P.textTop)||16,x=((A=s.ruleOptions)==null?void 0:A.textLeft)||4;h<0&&(m-=100);for(let L=h%(l*10);L<f;L+=10*l,m+=100)l<3&&m%500||t.fillText(m.toString(),L+x,w);m=0-Math.floor(d/l/10)*100,d<0&&(m-=100);for(let L=d%(l*10);L<u;L+=10*l,m+=100)l<3&&m%500||(t.save(),t.beginPath(),t.translate(w,L-x),t.rotate(270*Math.PI/180),t.fillText(m.toString(),0,0),t.restore());t.restore()}}class MagnifierCanvas{constructor(t,i,s){g(this,"parentCanvas");g(this,"parentElement");g(this,"store");g(this,"canvas",document.createElement("canvas"));g(this,"magnifierScreen",createOffscreen());g(this,"offscreen",createOffscreen());g(this,"domOffscreen",createOffscreen());g(this,"magnifierSize",300);g(this,"magnifier");this.parentCanvas=t,this.parentElement=i,this.store=s,i.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none"}resize(t,i){this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.offscreen.width=t,this.offscreen.height=i,this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.domOffscreen.width=t,this.domOffscreen.height=i,this.domOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.domOffscreen.getContext("2d").textBaseline="middle",this.magnifierScreen.width=this.magnifierSize+5,this.magnifierScreen.height=this.magnifierSize+5}renderMagnifier(){if(!this.magnifier)return;const t=this.magnifierSize/2,i=this.magnifierSize+5,s=this.magnifierScreen.getContext("2d");s.clearRect(0,0,i,i),s.lineWidth=5,s.save(),s.translate(2.5,2.5),s.save(),s.arc(t,t,t,0,Math.PI*2,!1),s.clip(),s.translate(-t,-t),s.scale(2,2);const a={x:(this.parentCanvas.mousePos.x+this.store.data.x)*this.store.dpiRatio,y:(this.parentCanvas.mousePos.y+this.store.data.y)*this.store.dpiRatio};[this.parentCanvas.canvasTemplate.bgOffscreen,this.parentCanvas.canvasTemplate.offscreen,this.parentCanvas.canvasImageBottom.offscreen,this.parentCanvas.canvasImageBottom.animateOffsScreen,this.parentCanvas.offscreen,this.parentCanvas.canvasImage.offscreen,this.parentCanvas.canvasImage.animateOffsScreen,this.domOffscreen].forEach(l=>{s.drawImage(l,a.x-t,a.y-t,this.magnifierSize,this.magnifierSize,0,0,this.magnifierSize,this.magnifierSize)}),s.restore(),s.beginPath();const o=s.createRadialGradient(t,t,t-5,t,t,t);o.addColorStop(0,"rgba(0,0,0,0.2)"),o.addColorStop(.8,"rgb(200,200,200)"),o.addColorStop(.9,"rgb(200,200,200)"),o.addColorStop(1,"rgba(200,200,200,0.9)"),s.strokeStyle=o,s.arc(t,t,t,0,Math.PI*2,!1),s.stroke(),s.restore(),this.offscreen.getContext("2d").drawImage(this.magnifierScreen,0,0,this.magnifierSize+5,this.magnifierSize+5,(a.x-t-2.5)/this.store.dpiRatio,(a.y-t-2.5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio)}updateDomOffscreen(){const t=this.domOffscreen.getContext("2d");t.clearRect(0,0,this.domOffscreen.width,this.domOffscreen.height);for(const i of this.store.data.pens)if((i.externElement||i.name==="gif")&&i.calculative.img){t.save(),t.translate(this.store.data.x,this.store.data.y);const{x:s,y:a,width:r,height:o}=i.calculative.worldRect;t.drawImage(i.calculative.img,s,a,r,o),t.restore()}}render(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.renderMagnifier();const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height)}}function lockedError(e){if(e.data.locked)throw new Error("canvas is locked")}class Dialog{constructor(t,i){g(this,"parentElement");g(this,"box");g(this,"iframe");g(this,"dialog");g(this,"close");g(this,"title");g(this,"body");g(this,"x");g(this,"y");g(this,"url");g(this,"meta2dDiv");g(this,"dialogMeta2d");g(this,"store");this.parentElement=t,this.store=i,this.box=document.createElement("div"),this.dialog=document.createElement("div");let s=document.createElement("div");this.title=document.createElement("div"),this.close=document.createElement("span"),this.close.innerHTML=`
      <svg fill="none" viewBox="0 0 16 16" width="1em" height="1em">
      <path
        fill="currentColor"
        d="M8 8.92L11.08 12l.92-.92L8.92 8 12 4.92 11.08 4 8 7.08 4.92 4 4 4.92 7.08 8 4 11.08l.92.92L8 8.92z"
        fill-opacity="0.9"
      ></path>
    </svg>`,this.body=document.createElement("div"),this.iframe=document.createElement("iframe"),this.iframe.setAttribute("frameborder","0"),this.meta2dDiv=document.createElement("div"),this.box.className="meta2d-dialog_mask",this.dialog.className="meta2d-dialog",this.body.className="meta2d-dialog_body",s.className="meta2d-dialog_header",this.title.className="meta2d-dialog-content",this.close.className="meta2d-dialog-close",this.meta2dDiv.className="meta2d-dialog-meta2d",s.appendChild(this.title),s.appendChild(this.close),this.body.appendChild(this.iframe),this.body.appendChild(this.meta2dDiv),this.dialog.appendChild(s),this.dialog.appendChild(this.body),this.box.appendChild(this.dialog),t.appendChild(this.box),this.dialog.onclick=r=>{r.stopPropagation()},this.box.onclick=()=>{this.hide()},this.close.onclick=()=>{this.hide()};let a;for(let r=0;r<document.styleSheets.length;r++)document.styleSheets[r].title==="le5le.com/dialog"&&(a=document.styleSheets[r]);if(!a){let r=document.createElement("style");r.type="text/css",r.title="le5le.com/dialog",document.head.appendChild(r),r=document.createElement("style"),r.type="text/css",document.head.appendChild(r),a=r.sheet,a.insertRule(`.meta2d-dialog_mask {
        display: none;
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: #0000006f;
        z-index: 9999;`),a.insertRule(`.meta2d-dialog_mask .meta2d-dialog {
            position: absolute;
            top: 15vh;
            left: 10%;
            width: 80%;
            height:420px;
            padding: 16px 20px;
            border-radius: 9px;
            background-color: #1e2430;
            z-index: 19999;
            overflow: auto;
        }`),a.insertRule(`.meta2d-dialog_header {
            display: flex;
            position: relative;
            z-index: 999;
        }`),a.insertRule(`.meta2d-dialog-content {
            width: calc(100% - 20px);
            font-weight: 600;
            font-size: 14px;
            color: #bdc7db;
            padding-bottom:8px;
        }`),a.insertRule(`.meta2d-dialog-close {
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            color: #617b91;
            position: absolute;
            right:20px;
            top:2px;
        }`),a.insertRule(`.meta2d-dialog-close svg{
            width: 18px;
            height: 18px;
        }`),a.insertRule(`.meta2d-dialog-close :hover{
            cursor: pointer;
        }`),a.insertRule(`.meta2d-dialog_body{
          width: 100%;
          height: 100%;
        } `),a.insertRule(`.meta2d-dialog_body iframe{
            width: 100%;
            height: 100%;
        }`),a.insertRule(`.meta2d-dialog_body .meta2d-dialog-meta2d{
          width: 100%;
          height: 100%;
          display: none;
      }`)}}async show(t,i,s,a){if(!i)return;const r=this.isUrl(i);if(r?(this.meta2dDiv.style.display="none",this.iframe.style.display="block"):(this.iframe.style.display="none",this.meta2dDiv.style.display="block"),r&&i!==this.url&&(this.iframe.setAttribute("src",i),this.url=i),t&&(this.title.innerText=t),t?(this.dialog.style.padding="16px 20px",this.title.style.display="block",this.body.style.height="calc(100% - 26px)",this.close.style.top="2px",this.close.style.right="2px",this.body.style.background="#1e2430"):(this.dialog.style.padding="0px",this.title.style.display="none",this.body.style.height="100%",this.body.style.overflow="hidden",this.close.style.top="18px",this.close.style.right="20px",this.body.style.background="transparent"),s&&(this.dialog.style.width=s.width?s.width+"px":"80%",this.dialog.style.height=s.height?s.height+"px":"420px",this.dialog.style.top=s.y?s.y+"px":s.height?`calc( 50% - ${s.height/2}px )`:"15vh",this.dialog.style.left=s.x?s.x+"px":`calc( 50% - ${s.width?s.width/2+"px":"40%"} )`),r&&a){let o=0;const n=setInterval(()=>{this.iframe.contentWindow.meta2d&&(clearInterval(n),setTimeout(()=>{this.iframe.contentWindow.postMessage(JSON.stringify({name:"dialog",data:a}),"*")},100)),o++,o>50&&clearInterval(n)},300)}if((!this.dialogMeta2d||r)&&(this.box.style.display="block"),!r){this.meta2dDiv.style.display="block",this.dialogMeta2d||(globalThis.mainMeta2d=globalThis.meta2d,this.dialogMeta2d=new Meta2d(this.meta2dDiv),globalThis.meta2d=globalThis.mainMeta2d);const o=await getMeta2dData(this.store,i);o&&(this.box.style.display="block",this.dialogMeta2d.clear(!0),this.dialogMeta2d.open(o,!1),this.dialogMeta2d.lock(1),this.dialogMeta2d.resize(),this.dialogMeta2d.fitView(!0,0),this.dialogMeta2d.render(!0))}}hide(){this.box.style.display="none"}isUrl(t){return!!(t.startsWith("http")||t.includes("?")||t.includes("/"))}destroy(){var t;this.dialog.onclick=void 0,this.box.onclick=void 0,this.close.onclick=void 0,(t=this.dialogMeta2d)==null||t.destroy(!0)}}class Title{constructor(t){g(this,"parentElement");g(this,"box");g(this,"currentAnchor");this.parentElement=t,this.box=document.createElement("div"),this.box.className="meta2d-title",t.appendChild(this.box);let i;for(let s=0;s<document.styleSheets.length;s++)document.styleSheets[s].title==="le5le.com/title"&&(i=document.styleSheets[s]);if(!i){let s=document.createElement("style");s.type="text/css",s.title="le5le.com/title",document.head.appendChild(s),s=document.createElement("style"),s.type="text/css",document.head.appendChild(s),i=s.sheet,i.insertRule(".meta2d-title{position:absolute;padding:0;z-index:10;left: -9999px;top: -9999px;background:#fff;color:#000; cursor: crosshair;border: 1px solid black;}")}}static getTitle(t){}setText(t){this.box.innerText=t.title}updateText(t){var i;((i=this.currentAnchor)==null?void 0:i.id)===t.id&&(Title.titleEmpty(t)||(this.setText(t),this.changePositionByAnchor(t)))}changePositionByAnchor(t){this.box.style.left=t.x+10+"px",this.box.style.top=t.y+10+"px"}static titleEmpty(t){return!t.title}show(t,i){if(Title.titleEmpty(t))return;this.currentAnchor=t,this.setText(t);let s={x:i.calculative.canvas.store.data.x+t.x,y:i.calculative.canvas.store.data.y+t.y};this.changePositionByAnchor(s)}hide(){this.box.style.left="-9999px",this.box.innerText="",this.currentAnchor=null}destroy(){this.box.onmouseleave=null}}class CanvasTemplate{constructor(t,i){g(this,"parentElement");g(this,"store");g(this,"canvas",document.createElement("canvas"));g(this,"offscreen",createOffscreen());g(this,"bgOffscreen",createOffscreen());g(this,"patchFlags");g(this,"bgPatchFlags");g(this,"fit");this.parentElement=t,this.store=i,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(t,i){this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.bgOffscreen.width=t,this.bgOffscreen.height=i,this.offscreen.width=t,this.offscreen.height=i,this.bgOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.bgOffscreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.patchFlags=!0,this.bgPatchFlags=!0}hidden(){this.canvas.style.display="none"}show(){this.canvas.style.display="block"}clear(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.bgPatchFlags=!0,this.patchFlags=!0}render(){if(this.bgPatchFlags){const t=this.bgOffscreen.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.store.data.width||this.store.options.width,s=this.store.data.height||this.store.options.height,a=this.store.data.x||this.store.options.x||0,r=this.store.data.y||this.store.options.y||0,o=this.store.data.background||this.store.styles.background;o&&(t.save(),t.fillStyle=o,t.globalAlpha=this.store.data.globalAlpha??this.store.options.globalAlpha,i&&s&&!this.fit?(t.shadowOffsetX=this.store.options.shadowOffsetX,t.shadowOffsetY=this.store.options.shadowOffsetY,t.shadowBlur=this.store.options.shadowBlur,t.shadowColor=this.store.options.shadowColor,t.fillRect(this.store.data.origin.x+a,this.store.data.origin.y+r,i*this.store.data.scale,s*this.store.data.scale)):t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore()),i&&s&&this.store.bkImg&&(t.save(),this.fit?t.drawImage(this.store.bkImg,0,0,this.canvas.offsetWidth,this.canvas.offsetHeight):t.drawImage(this.store.bkImg,this.store.data.origin.x+a,this.store.data.origin.y+r,i*this.store.data.scale,s*this.store.data.scale),t.restore()),this.renderGrid(t)}if(this.patchFlags){const t=this.offscreen.getContext("2d");t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.translate(this.store.data.x,this.store.data.y);for(const i of this.store.data.pens)if(isFinite(i.x)&&i.canvasLayer===CanvasLayer.CanvasTemplate&&i.calculative.inView){if(i.name==="combine"&&!i.draw)continue;renderPen(t,i),i.image&&i.name!=="gif"&&i.calculative.img&&(t.save(),ctxFlip(t,i),i.calculative.rotate&&ctxRotate(t,i),setGlobalAlpha(t,i),drawImage(t,i),t.restore())}t.restore()}if(this.patchFlags||this.bgPatchFlags){const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.bgOffscreen,0,0,this.canvas.width,this.canvas.height),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),this.patchFlags=!1,this.bgPatchFlags=!1}}renderGrid(t){const{data:i,options:s}=this.store,{grid:a,gridRotate:r,gridColor:o,gridSize:n,scale:l,origin:c}=i;if(!(a??s.grid))return;t.save();const h=(i.width||s.width)*l,d=(i.height||s.height)*l,f=(i.x||s.x||0)+c.x,u=(i.y||s.y||0)+c.y;r&&(t.translate(h/2,d/2),t.rotate(r*Math.PI/180),t.translate(-h/2,-d/2)),t.lineWidth=1,t.strokeStyle=o||s.gridColor,t.beginPath();let v=(n||s.gridSize)*l;if(v=v<0?0:v,!h||!d){const y=this.store.dpiRatio,m=this.canvas.width/y,w=this.canvas.height/y,x=f/v,b=u/v,T=v*10,p=f-Math.ceil(x)*v,R=u-Math.ceil(b)*v,k=m+p+T,I=w+R+T;for(let P=p;P<=k;P+=v)t.moveTo(P,R),t.lineTo(P,w+R+T);for(let P=R;P<=I;P+=v)t.moveTo(p,P),t.lineTo(m+p+T,P)}else{const y=h+f,m=d+u;for(let w=f;w<=y;w+=v)t.moveTo(w,u),t.lineTo(w,d+u);for(let w=u;w<=m;w+=v)t.moveTo(f,w),t.lineTo(h+f,w)}t.stroke(),t.restore()}}const status$1={success:{},info:{icon:'<svg fill="none" viewBox="0 0 24 24"><path fill="#0052d9" d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{},error:{}};class Popconfirm{constructor(t,i){g(this,"parentElement");g(this,"store");g(this,"box");g(this,"text");g(this,"arrowUp");g(this,"arrowDown");g(this,"icon");g(this,"confirm");g(this,"cancel");g(this,"x");g(this,"y");this.parentElement=t,this.store=i,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.icon=document.createElement("div"),this.confirm=document.createElement("button"),this.cancel=document.createElement("button"),this.box.className="meta2d-popconfirm",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.icon.className="icon",this.confirm.className="confirm",this.cancel.className="cancel",this.confirm.innerHTML="确定",this.cancel.innerHTML="取消",this.icon.innerHTML=status$1.info.icon,this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),this.box.appendChild(this.confirm),this.box.appendChild(this.cancel),this.box.appendChild(this.icon),t.appendChild(this.box);let s;for(let a=0;a<document.styleSheets.length;a++)document.styleSheets[a].title==="le5le.com/popconfirm"&&(s=document.styleSheets[a]);if(!s){let a=document.createElement("style");a.type="text/css",a.title="le5le.com/popconfirm",document.head.appendChild(a),a=document.createElement("style"),a.type="text/css",document.head.appendChild(a),s=a.sheet,s.insertRule(".meta2d-popconfirm{position:absolute;z-index:999;left: -9999px;top: -9999px;padding:16px;max-width:400px;background:#fff;border-radius:6px;box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);}"),s.insertRule(".meta2d-popconfirm .text{outline:none;padding:0px 0px 40px 28px;border-radius:4px;color:rgba(0, 0, 0, 0.9);overflow-y:auto;line-height:22px;font-size:13px;}"),s.insertRule(".meta2d-popconfirm .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-18px;left:50%;transform:translateX(-50%)}"),s.insertRule(".meta2d-popconfirm .arrow.down{top:initial;bottom: -18px;}"),s.insertRule(".meta2d-popconfirm .icon{position:absolute;width:22px;height:22px;left:16px;top:16px;}"),s.insertRule(".meta2d-popconfirm .confirm{position:absolute;right:16px;bottom:16px;width:40px;height:24px;text-align:center;background:#4582e6;color:#fff;border-radius:3px;border-color:transparent}"),s.insertRule(".meta2d-popconfirm .confirm:hover{background:#003cab;}"),s.insertRule(".meta2d-popconfirm .cancel{position:absolute;right:64px;bottom:16px;width:40px;height:24px;text-align:center;background:#dcdcdc;color:rgba(0, 0, 0, 0.9);border-radius:3px;border-color:transparent}"),s.insertRule(".meta2d-popconfirm .cancel:hover{background:#a6a6a6;}")}}show(t,i){if(!t)return;const s=this.box.getBoundingClientRect(),a=t.calculative.worldRect;let r=t.calculative.canvas.store.data.x+i.x-s.width/2,o=t.calculative.canvas.store.data.y+i.y-s.height-20;t.type||(r=t.calculative.canvas.store.data.x+a.x-(s.width-a.width)/2,o=t.calculative.canvas.store.data.y+a.ey-s.height-a.height),o>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#fff",o-=10):(o+=s.height+a.height+5,o+=10,this.arrowUp.style.borderBottomColor="#fff",this.arrowDown.style.borderTopColor="transparent"),this.x=r,this.y=o,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.x=-9999,this.box.style.left="-9999px"}showModal(t,i,s){return new Promise(a=>{this.text.innerHTML=s||"确认执行操作吗？",this.show(t,i),this.confirm.onclick=()=>{a(!0),this.hide()},this.cancel.onclick=()=>{a(!1),this.hide()}})}destroy(){this.box=null}}const movingSuffix="-moving";class Canvas{constructor(t,i,s){g(this,"parent");g(this,"parentElement");g(this,"store");g(this,"canvas",document.createElement("canvas"));g(this,"offscreen",createOffscreen());g(this,"width");g(this,"height");g(this,"externalElements",document.createElement("div"));g(this,"clientRect");g(this,"canvasRect");g(this,"activeRect");g(this,"initActiveRect");g(this,"dragRect");g(this,"lastRotate",0);g(this,"sizeCPs");g(this,"activeInitPos");g(this,"hoverType",HoverType.None);g(this,"resizeIndex",0);g(this,"mouseDown");g(this,"hotkeyType");g(this,"mouseRight");g(this,"addCaches");g(this,"touchCenter");g(this,"initTouchDis");g(this,"initScale");g(this,"touchScaling");g(this,"touchMoving");g(this,"startTouches");g(this,"lastOffsetX",0);g(this,"lastOffsetY",0);g(this,"drawingLineName");g(this,"drawLineFns",[...defaultDrawLineFns]);g(this,"drawingLine");g(this,"pencil");g(this,"pencilLine");g(this,"movingPens");g(this,"patchFlagsLines",new Set);g(this,"dock");g(this,"prevAnchor");g(this,"nextAnchor");g(this,"lastMouseTime",0);g(this,"hoverTimer",0);g(this,"fitTimer",0);g(this,"willInactivePen");g(this,"patchFlags",!1);g(this,"lastRender",0);g(this,"touchStart",0);g(this,"touchStartTimer");g(this,"timer");g(this,"lastAnimateRender",0);g(this,"animateRendering",!1);g(this,"renderTimer");g(this,"initPens");g(this,"pointSize",8);g(this,"pasteOffset",!0);g(this,"opening",!1);g(this,"maxZindex",5);g(this,"canMoveLine",!1);g(this,"randomIdObj");g(this,"keyOptions");g(this,"beforeAddPen");g(this,"beforeAddPens");g(this,"beforeAddAnchor");g(this,"beforeRemovePens");g(this,"beforeRemoveAnchor");g(this,"customResizeDock");g(this,"customMoveDock");g(this,"inputParent",document.createElement("div"));g(this,"inputDiv",document.createElement("div"));g(this,"dropdown",document.createElement("ul"));g(this,"tooltip");g(this,"popconfirm");g(this,"title");g(this,"mousePos",{x:0,y:0});g(this,"scroll");g(this,"movingAnchor");g(this,"canvasTemplate");g(this,"canvasImage");g(this,"canvasImageBottom");g(this,"magnifierCanvas");g(this,"dialog");g(this,"autoPolylineFlag",!1);g(this,"stopPropagation",t=>{t.stopPropagation()});g(this,"curve",curve);g(this,"polyline",polyline);g(this,"mind",mind);g(this,"line",lineSegment);g(this,"onCopy",t=>{this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements||this.copy()});g(this,"onCut",t=>{this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements||this.cut()});g(this,"onPaste",async t=>{if(this.store.data.locked||this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements)return;let i;if(navigator.clipboard&&t.clipboardData){const s=t.clipboardData.items;if(s){for(let a=0;a<s.length;a++)if(s[a].type.indexOf("image")!==-1&&s[a].getAsFile()){i=!0;break}}}if(i){const s=t.clipboardData.items;if(s){for(let a=0;a<s.length;a++)if(s[a].type.indexOf("image")!==-1&&s[a].getAsFile()){const{x:r,y:o}=this.mousePos,n=s[a].getAsFile();let l=s[a].type.slice(6)==="gif"?"gif":"image";if(n!==null){const c=l==="gif",h=await this.fileToPen(n,c);h.height=h.height/h.width*100,h.width=100,h.x=r-50/2,h.y=o-h.height/h.width*50,h.externElement=c,this.addPens([h]),this.active([h]),this.copy([h])}}}}else this.paste()});g(this,"onMessage",t=>{if(typeof t.data!="string"||!t.data||t.data.startsWith("setImmediate")||t.data.startsWith("webpackHotUpdate"))return;let i=JSON.parse(t.data);typeof i=="object"?this.parent.doMessageEvent(i.name,JSON.stringify(i.data)):this.parent.doMessageEvent(i)});g(this,"onwheel",t=>{if(this.inputDiv.contentEditable==="true"||this.drawingLine||this.pencil)return;if(this.store.hover&&this.store.hover.onWheel){this.store.hover.onWheel(this.store.hover,t);return}if(this.store.data.disableScale||this.store.options.disableScale||(t.preventDefault(),t.stopPropagation(),this.mouseDown&&(this.hoverType===HoverType.Node||this.hoverType===HoverType.Line))||this.store.data.locked===LockState.Disable||this.store.data.locked===LockState.DisableScale||this.store.data.locked===LockState.DisableMoveScale)return;if(!t.ctrlKey&&Math.abs(t.wheelDelta)<100&&t.deltaY.toString().indexOf(".")===-1){if(this.store.options.scroll&&!t.metaKey&&this.scroll){this.scroll.wheel(t.deltaY<0);return}const r=this.store.data.scale||1;this.translate(-t.deltaX/r,-t.deltaY/r);return}if(Math.abs(t.wheelDelta)>100&&this.store.options.scroll&&this.scroll&&!this.store.options.scrollButScale&&!(t.ctrlKey||t.metaKey)){this.scroll.wheel(t.deltaY<0);return}if(this.store.options.disableTouchPadScale)return;let i=.015;if(this.store.options.scaleOff)i=this.store.options.scaleOff,t.deltaY>0&&(i=-this.store.options.scaleOff);else if(/mac os /i.test(navigator.userAgent))t.ctrlKey?t.deltaY>0&&(i*=-1):i*=t.wheelDeltaY/240;else{let o=.2;t.deltaY.toString().indexOf(".")!==-1&&(o=.01),t.deltaY>0?i=-o:i=o}let{offsetX:s,offsetY:a}=t;this.scale(this.store.data.scale+i,{x:s,y:a}),this.externalElements.focus()});g(this,"onkeydown",t=>{var r,o,n;if(this.store.data.locked>=LockState.DisableEdit&&t.target.tagName!=="INPUT"&&t.target.tagName!=="TEXTAREA"&&!t.target.dataset.meta2dIgnore&&this.store.active.forEach(l=>{var c;(c=l.onKeyDown)==null||c.call(l,l,t.key)}),this.store.data.locked>=LockState.DisableEdit||t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"||t.target.dataset.meta2dIgnore||this.store.options.unavailableKeys.includes(t.key))return;this.keyOptions||(this.keyOptions={}),this.keyOptions.altKey=t.altKey,this.keyOptions.shiftKey=t.shiftKey,this.keyOptions.ctrlKey=t.ctrlKey,this.keyOptions.metaKey=t.metaKey,this.keyOptions.F=!1,(t.key==="F"||t.key==="f")&&(this.keyOptions.F=!0);let i=10,s=10,a=null;if(this.store.options.strictScope){const l=this.store.data.width||this.store.options.width,c=this.store.data.height||this.store.options.height;l&&c&&(a={x:this.store.data.origin.x,y:this.store.data.origin.y,width:l*this.store.data.scale,height:c*this.store.data.scale})}switch(t.key){case" ":this.hotkeyType=HotkeyType.Translate;break;case"Control":this.drawingLine?this.drawingLine.calculative.drawlineH=!this.drawingLine.calculative.drawlineH:this.hotkeyType||(this.patchFlags=!0,this.hotkeyType=HotkeyType.Select);break;case"Meta":break;case"Shift":this.store.active.length===1&&this.store.active[0].type&&this.store.activeAnchor?this.toggleAnchorHand():this.hotkeyType||(this.patchFlags=!0,this.store.options.resizeMode||(this.hotkeyType=HotkeyType.Resize));break;case"Alt":if(!t.ctrlKey&&!t.shiftKey&&this.drawingLine){const l=getToAnchor(this.drawingLine);l!==this.drawingLine.calculative.activeAnchor?(deleteTempAnchor(this.drawingLine),this.drawingLine.calculative.worldAnchors.push(l)):this.drawingLine.calculative.worldAnchors.push({x:l.x,y:l.y});const c=this.drawLineFns.indexOf(this.drawingLineName);this.drawingLineName=this.drawLineFns[(c+1)%this.drawLineFns.length],this.drawingLine.lineName=this.drawingLineName,this.drawline(),this.patchFlags=!0}t.preventDefault();break;case"a":case"A":t.ctrlKey||t.metaKey?(this.active(this.store.data.pens.filter(l=>!l.parentId&&l.locked!==LockState.Disable)),t.preventDefault()):this.toggleAnchorMode();break;case"Delete":case"Backspace":if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){this.deleteFit();break}!this.store.data.locked&&this.delete();break;case"ArrowLeft":if(this.movingAnchor){this.translateAnchor(-1,0);break}if(i=-1,t.shiftKey&&(i=-5),(t.ctrlKey||t.metaKey)&&(i=-10),i=i*this.store.data.scale,this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+i,y:this.store.activeAnchor.y},{});break}a&&this.activeRect.x+i<a.x&&(i=a.x-this.activeRect.x),this.translatePens(this.store.active,i,0);break;case"ArrowUp":if(this.movingAnchor){this.translateAnchor(0,-1);break}if(s=-1,t.shiftKey&&(s=-5),(t.ctrlKey||t.metaKey)&&(s=-10),s=s*this.store.data.scale,a&&this.activeRect.y+s<a.y&&(s=a.y-this.activeRect.y),this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+s},{});break}this.translatePens(this.store.active,0,s);break;case"ArrowRight":if(this.movingAnchor){this.translateAnchor(1,0);break}if(i=1,t.shiftKey&&(i=5),(t.ctrlKey||t.metaKey)&&(i=10),i=i*this.store.data.scale,this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+i,y:this.store.activeAnchor.y},{});break}a&&this.activeRect.x+this.activeRect.width+i>a.x+a.width&&(i=a.x+a.width-(this.activeRect.x+this.activeRect.width)),this.translatePens(this.store.active,i,0);break;case"ArrowDown":if(this.movingAnchor){this.translateAnchor(0,1);break}if(s=1,t.shiftKey&&(s=5),(t.ctrlKey||t.metaKey)&&(s=10),s=s*this.store.data.scale,a&&this.activeRect.y+this.activeRect.height+s>a.y+a.height&&(s=a.y+a.height-(this.activeRect.y+this.activeRect.height)),this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+s},{});break}this.translatePens(this.store.active,0,s);break;case"d":case"D":(r=this.store.active[0])!=null&&r.locked||this.removeAnchorHand();break;case"h":case"H":(o=this.store.active[0])!=null&&o.locked||this.addAnchorHand();break;case"m":case"M":this.toggleMagnifier();break;case"g":case"G":if(t.ctrlKey||t.metaKey){t.shiftKey?this.parent.uncombine():this.store.active.length>1&&this.parent.combine(this.store.active),t.preventDefault();break}this.hoverType===HoverType.NodeAnchor&&(this.movingAnchor=this.store.hoverAnchor,this.externalElements.style.cursor="move");break;case"s":case"S":!this.store.data.locked&&this.hoverType===HoverType.LineAnchor&&this.store.hover===this.store.active[0]&&this.splitLine(this.store.active[0],this.store.hoverAnchor),(t.ctrlKey||t.metaKey)&&this.store.emitter.emit("save",{event:t});break;case"c":case"C":(t.ctrlKey||t.metaKey)&&this.store.options.disableClipboard&&this.copy();break;case"x":case"X":(t.ctrlKey||t.metaKey)&&this.store.options.disableClipboard&&this.cut();break;case"√":case"v":case"V":!t.ctrlKey&&!t.metaKey&&(this.pencil&&this.stopPencil(),this.drawingLineName?(this.finishDrawline(),this.drawingLineName=""):this.drawingLineName=this.store.options.drawingLineName),!this.store.data.locked&&(t.ctrlKey||t.metaKey)&&(this.store.options.disableClipboard||!this.store.options.disableClipboard&&t.altKey)&&this.paste();break;case"b":case"B":this.drawingLineName&&(this.finishDrawline(),this.drawingLineName=""),this.pencil?this.stopPencil():this.drawingPencil();break;case"y":case"Y":(t.ctrlKey||t.metaKey)&&this.redo();break;case"z":case"Z":t.ctrlKey||t.metaKey?this.undo():t.shiftKey&&this.redo();break;case"Enter":this.drawingLineName&&(this.finishDrawline(!0),this.store.active[0].anchors[0].connectTo?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName),this.store.active&&(this.store.active.forEach(l=>{l.type?(l.close=!l.close,l.close&&getLinePoints(l),this.store.path2dMap.set(l,globalStore.path2dDraws.line(l)),getLineLength(l)):l.calculative.focus=!0}),this.render());break;case"Escape":this.drawingLineName&&this.finishDrawline(),this.drawingLineName=void 0,this.stopPencil(),this.store.active&&this.store.active.forEach(l=>{l.type||(l.calculative.focus=!1)}),this.movingPens&&(this.getAllByPens(this.movingPens).forEach(l=>{this.store.pens[l.id]=void 0}),this.movingPens=void 0,this.mouseDown=void 0,this.clearDock(),(n=this.store.active)==null||n.forEach(l=>{this.updateLines(l)}),this.calcActiveRect(),this.patchFlags=!0),this.hotkeyType=HotkeyType.None,this.movingAnchor=void 0,this.magnifierCanvas.magnifier&&(this.magnifierCanvas.magnifier=!1,this.patchFlags=!0);break;case"E":case"e":this.store.options.disableAnchor=!this.store.options.disableAnchor,this.store.emitter.emit("disableAnchor",this.store.options.disableAnchor);break;case"=":(t.ctrlKey||t.metaKey)&&(this.scale(this.store.data.scale+.1),t.preventDefault(),t.stopPropagation());break;case"-":(t.ctrlKey||t.metaKey)&&(this.scale(this.store.data.scale-.1),t.preventDefault(),t.stopPropagation());break;case"l":case"L":this.canMoveLine=!0;break;case"[":this.parent.down();break;case"]":this.parent.up();break;case"{":this.parent.bottom();break;case"}":this.parent.top();break;case"F":case"f":!this.store.data.locked&&(t.ctrlKey||t.metaKey)&&!this.store.options.disableClipboard&&this.paste(),this.setFollowers();break}this.render(!1)});g(this,"onkeyup",t=>{switch(t.key){case"l":case"L":this.canMoveLine=!1;break}this.hotkeyType&&this.render(),this.hotkeyType<HotkeyType.AddAnchor&&(this.hotkeyType=HotkeyType.None)});g(this,"ondrop",async t=>{if(this.store.data.locked){console.warn("canvas is locked, can not drop");return}t.preventDefault(),t.stopPropagation();const i=t.dataTransfer.getData("Meta2d")||t.dataTransfer.getData("Text");let s=null;try{i&&(s=JSON.parse(i))}catch{}if(!s){const{files:a}=t.dataTransfer;if(a.length&&a[0].type.match("image.*")&&!(this.addCaches&&this.addCaches.length)){const r=a[0].type==="image/gif";s=await this.fileToPen(a[0],r)}else if(this.addCaches&&this.addCaches.length)s=this.addCaches,this.addCaches=[];else{this.store.emitter.emit("drop",void 0);return}}if(s=Array.isArray(s)?s:[s],s[0]&&s[0].draggable!==!1){const a={x:t.offsetX,y:t.offsetY};this.calibrateMouse(a),this.dropPens(s,a),this.addCaches=[],this.getContainerHover(a),this.mousePos.x=a.x,this.mousePos.y=a.y,this.store.emitter.emit("mouseup",{x:a.x,y:a.y,pen:this.store.hoverContainer})}this.store.emitter.emit("drop",s||i)});g(this,"ontouchstart",t=>{this.store.data.locked!==LockState.Disable&&(this.touchStartTimer&&clearTimeout(this.touchStartTimer),this.touchStartTimer=setTimeout(()=>{this.touchStart=performance.now();const i=t.touches[0].pageX-this.clientRect.x,s=t.touches[0].pageY-this.clientRect.y,a={x:i,y:s};if(this.calibrateMouse(a),this.getHover(a),this.onMouseDown({x:i,y:s,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY,pageX:t.touches[0].pageX,pageY:t.touches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1}),t.touches.length===2){this.initTouchDis=Math.hypot(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY),this.initScale=this.store.data.scale,this.startTouches=t.touches,this.touchCenter={x:t.touches[0].pageX+(t.touches[1].pageX-t.touches[0].pageX)/2-this.clientRect.x,y:t.touches[0].pageY+(t.touches[1].pageY-t.touches[0].pageY)/2-this.clientRect.y};return}else t.touches.length===3&&(this.store.emitter.emit("contextmenu",{e:{x:i,y:s,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY,pageX:t.touches[0].pageX,pageY:t.touches[0].pageY},clientRect:this.clientRect}),t.preventDefault(),t.stopPropagation());this.touchStartTimer=void 0},50))});g(this,"ontouchmove",t=>{var n;if(this.store.data.locked===LockState.Disable)return;t.stopPropagation(),t.preventDefault();const i=performance.now();if(i-this.touchStart<50)return;this.touchStart=i;const s=t.touches,a=s.length,r=t.touches[0].pageX-this.clientRect.x,o=t.touches[0].pageY-this.clientRect.y;if(a===1)this.onMouseMove({x:r,y:o,clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,pageX:t.changedTouches[0].pageX,pageY:t.changedTouches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1});else if(a===2&&((n=this.startTouches)==null?void 0:n.length)===2){if(!this.touchMoving&&!this.touchScaling){const l=this.startTouches[0].pageX-s[0].pageX,c=this.startTouches[1].pageX-s[1].pageX,h=this.startTouches[0].pageY-s[0].pageY,d=this.startTouches[1].pageY-s[1].pageY;(l>=0&&c<0||l<=0&&c>0)&&(h>=0&&d<0||h<=0&&d>0)?this.touchScaling=!0:this.touchMoving=!0}if(this.touchScaling){if(this.store.data.disableScale||this.store.options.disableScale)return;const l=Math.hypot(s[0].pageX-s[1].pageX,s[0].pageY-s[1].pageY)/this.initTouchDis;this.scale(this.initScale*l,deepClone(this.touchCenter))}if(this.touchMoving){if(this.store.data.locked>=LockState.DisableMove&&this.store.data.locked!==LockState.DisableScale||this.store.data.disableScale||this.store.options.disableScale)return;if(this.lastOffsetX){const{scale:l}=this.store.data;this.translate((r-this.lastOffsetX)/l,(o-this.lastOffsetY)/l)}this.lastOffsetX=r,this.lastOffsetY=o}}});g(this,"ontouchend",t=>{if(this.store.data.locked===LockState.Disable)return;this.touchCenter=void 0,this.touchScaling=void 0,this.touchMoving=void 0,this.startTouches=void 0,this.lastOffsetX=0,this.lastOffsetY=0;const i=t.changedTouches[0].pageX-this.clientRect.x,s=t.changedTouches[0].pageY-this.clientRect.y;this.onMouseUp({x:i,y:s,clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,pageX:t.changedTouches[0].pageX,pageY:t.changedTouches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1}),setTimeout(()=>{this.render()},20)});g(this,"onGesturestart",t=>{t.preventDefault()});g(this,"onMouseDown",t=>{var i,s,a,r,o;if(t.buttons===2&&!this.drawingLine&&(this.mouseRight=MouseRight.Down),this.hideInput(),this.popconfirm.hide(),this.store.data.locked===LockState.Disable||t.buttons!==1&&t.buttons!==2){this.hoverType=HoverType.None;return}if(!this.magnifierCanvas.magnifier){if(this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.mouseDown=t,this.lastMouseTime=performance.now(),this.canvasImage.fitFlag){this.canvasImage.currentFit||this.calcuActiveFit();return}if(this.hotkeyType===HotkeyType.AddAnchor){this.setAnchor(this.store.pointAt);return}if(!this.store.options.autoAnchor&&!this.drawingLine&&t.shiftKey&&t.ctrlKey&&t.altKey){this.setAnchor(this.store.pointAt),this.drawingLineName=this.store.options.drawingLineName;const n=this.store.activeAnchor;if(!n)return;const l={id:s8(),x:n.x,y:n.y};this.drawingLine=this.createDrawingLine(l);let c=getFromAnchor(this.drawingLine);this.drawingLine.calculative.activeAnchor=c,connectLine(this.store.hover,n,this.drawingLine,l),this.drawline();return}if(!(this.hotkeyType===HotkeyType.Translate||this.mouseRight===MouseRight.Down&&!this.store.options.mouseRightActive)){if(this.drawingLine){if(this.store.hoverAnchor){const l=getToAnchor(this.drawingLine);this.store.hoverAnchor.type===PointType.Line?getDistance(l,this.store.hoverAnchor,this.store):(l.x=this.store.hoverAnchor.x,l.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,l),this.drawline(),this.finishDrawline(!0);return}if(!this.store.options.autoAnchor&&t.shiftKey&&t.altKey&&t.ctrlKey){this.setAnchor(this.store.pointAt);const l=getToAnchor(this.drawingLine),c=this.store.activeAnchor;if(!c)return;l.x=c.x,l.y=c.y,connectLine(this.store.hover,c,this.drawingLine,l),this.drawline(),this.finishDrawline(!0);return}if(t.buttons===2||this.drawingLineName==="mind"&&((i=this.drawingLine)==null?void 0:i.calculative.worldAnchors.length)>1||this.store.options.drawingLineLength&&((s=this.drawingLine)==null?void 0:s.calculative.worldAnchors.length)>this.store.options.drawingLineLength){this.finishDrawline(!0),(a=this.store.active[0])!=null&&a.anchors[0].connectTo||this.store.active.length==0?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName;return}if(this.store.options.autoAnchor&&this.hoverType===HoverType.Node){const l=getToAnchor(this.drawingLine),c=nearestAnchor(this.store.hover,t);l.x=c.x,l.y=c.y,this.drawingLine.autoTo=!0,connectLine(this.store.hover,c,this.drawingLine,l),this.drawline(),this.finishDrawline(!0);return}const n=getToAnchor(this.drawingLine);n.isTemp?(this.drawingLine.calculative.activeAnchor=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2],n.isTemp=void 0):(this.drawingLine.calculative.activeAnchor=n,this.drawingLine.calculative.worldAnchors.push({x:n.x,y:n.y,penId:n.penId})),this.drawingLine.calculative.drawlineH=void 0,this.drawingLineName!=="polyline"&&this.drawline()}if(this.drawingLineName){if(this.hoverType===HoverType.Node)if(this.store.options.autoAnchor){this.inactive(!0);const n=nearestAnchor(this.store.hover,t);this.store.hoverAnchor=n;const l={id:s8(),x:n.x,y:n.y};this.drawingLine=this.createDrawingLine(l),this.drawingLine.autoFrom=!0,connectLine(this.store.hover,n,this.drawingLine,l)}else this.inactive(),this.hoverType=HoverType.None;else if(this.hoverType===HoverType.NodeAnchor){this.drawingLineName=this.store.options.drawingLineName;const n={id:s8(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};this.drawingLine=this.createDrawingLine(n),this.drawingLine.calculative.activeAnchor=n,connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,n)}else if(!this.drawingLine&&this.drawingLineName!=="curve"){this.inactive(!0);const n={id:s8(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(n),this.drawingLine.calculative.activeAnchor=n}}else if(this.pencil){this.inactive(!0);const n=s8(),l={x:t.x,y:t.y,id:s8(),penId:n};this.pencilLine=this.getInitPencilLine(l)}else{switch(this.hoverType){case HoverType.None:(this.store.data.rule||this.store.options.rule)&&!this.store.options.disableRuleLine&&this.addRuleLine(t),this.store.options.resizeMode&&(this.hotkeyType=HotkeyType.None),this.inactive();break;case HoverType.Node:case HoverType.Line:if(this.store.hover){if((r=this.store.active)!=null&&r.length&&this.store.active.length===1&&this.store.hover.id===this.store.active[0].id){this.calcActiveRect();break}const n=getParent(this.store.hover,!0);let l=n||this.store.hover;n&&(n.container||(o=this.store.options.containerShapes)!=null&&o.includes(n.name))&&(l=this.store.hover),t.ctrlKey&&!t.shiftKey?(l.calculative.active?this.willInactivePen=l:this.store.active.length>0&&(l.calculative.active=!0,setChildrenActive(l),this.store.active.push(l),this.store.emitter.emit("active",this.store.active)),this.patchFlags=!0):t.ctrlKey&&t.shiftKey&&this.store.hover.parentId?this.active([this.store.hover]):(!(this.activeRect&&pointInRect({x:t.x,y:t.y},this.activeRect))||this.store.active.length==1)&&(l.calculative.active||(this.active([l]),this.store.options.resizeMode&&(this.hotkeyType=HotkeyType.Resize))),this.calcActiveRect()}break;case HoverType.LineAnchor:this.store.activeAnchor=this.store.hoverAnchor,this.store.hover.calculative.activeAnchor=this.store.hoverAnchor,this.active([this.store.hover]);break;case HoverType.LineAnchorPrev:case HoverType.LineAnchorNext:this.store.activeAnchor&&(this.prevAnchor={...this.store.activeAnchor.prev},this.nextAnchor={...this.store.activeAnchor.next});break;case HoverType.Resize:this.activeInitPos=[],this.store.active.forEach(n=>{this.activeInitPos.push({x:(n.calculative.worldRect.x-this.activeRect.x)/this.activeRect.width,y:(n.calculative.worldRect.y-this.activeRect.y)/this.activeRect.height})});break}this.store.hover&&(this.store.hover.calculative.mouseDown=!0),this.store.emitter.emit("mousedown",{x:t.x,y:t.y,pen:this.store.hover})}this.render()}}});g(this,"onMouseMove",t=>{var s,a,r,o,n,l,c,h;if(this.store.data.locked===LockState.Disable){this.hoverType=HoverType.None;return}if(this.mouseDown&&!this.mouseDown.restore&&t.buttons!==1&&t.buttons!==2){this.onMouseUp(t);return}if(this.lastMouseTime){if(performance.now()-this.lastMouseTime<50){this.lastMouseTime=0;return}this.lastMouseTime=0}if(this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.magnifierCanvas.magnifier){this.render();return}if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){const d=performance.now();d-this.fitTimer>100&&(this.mouseDown?this.updateFit(t):this.inFitBorder(this.mousePos),this.fitTimer=d);return}if(this.mouseDown&&!this.store.options.disableTranslate&&!this.store.data.disableTranslate){if(this.mouseRight===MouseRight.Down&&(this.mouseRight=MouseRight.Translate),this.store.data.locked===LockState.DisableEdit||this.store.data.locked===LockState.DisableScale||this.hotkeyType===HotkeyType.Translate||this.mouseRight===MouseRight.Translate){const{scale:d}=this.store.data;let f=(t.x-this.mouseDown.x)/d,u=(t.y-this.mouseDown.y)/d;t.shiftKey&&!t.ctrlKey&&(u=0),t.ctrlKey&&(f=0),this.translate(f,u);return}if(this.store.data.locked)return;if(!this.drawingLine&&!this.pencil){if(!this.drawingLineName&&!this.movingAnchor){if(this.hoverType===HoverType.NodeAnchor){if(!this.store.hoverAnchor)return;this.drawingLineName=this.store.options.drawingLineName;const d={id:s8(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};this.drawingLine=this.createDrawingLine(d),this.drawingLine.calculative.activeAnchor=d,connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,d),this.drawline();return}}else if(this.drawingLineName&&this.hoverType===HoverType.None){const d={id:s8(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(d),this.drawingLine.calculative.activeAnchor=d,this.drawline();return}if(t.buttons===1&&(t.ctrlKey||!this.hoverType&&!this.hotkeyType)&&!(t.ctrlKey&&(this.store.activeAnchor||(s=this.store.active)!=null&&s.length))){this.dragRect={x:Math.min(this.mouseDown.x,t.x),y:Math.min(this.mouseDown.y,t.y),ex:Math.max(this.mouseDown.x,t.x),ey:Math.max(this.mouseDown.y,t.y),width:Math.abs(t.x-this.mouseDown.x),height:Math.abs(t.y-this.mouseDown.y)},this.render();return}if(this.movingAnchor){const d=t.x-this.movingAnchor.x,f=t.y-this.movingAnchor.y;this.translateAnchor(d,f),this.render();return}else if(!((a=this.store.active[0])!=null&&a.locked)){const d={x:t.x,y:t.y};if(this.hoverType===HoverType.LineAnchor){(this.dockInAnchor(t)||((r=this.store.active[0])==null?void 0:r.lineName)==="line")&&!this.store.options.disableDock&&!this.store.options.disableLineDock&&(this.clearDock(),this.dock=calcAnchorDock(this.store,d,this.store.activeAnchor),(o=this.dock)!=null&&o.xDock&&(d.x+=this.dock.xDock.step),(n=this.dock)!=null&&n.yDock&&(d.y+=this.dock.yDock.step)),this.moveLineAnchor(d,t);return}if(this.hoverType===HoverType.LineAnchorPrev){this.moveLineAnchorPrev(t);return}if(this.hoverType===HoverType.LineAnchorNext){this.moveLineAnchorNext(t);return}}if(this.hoverType===HoverType.Rotate){this.rotatePens({x:t.x,y:t.y});return}if(this.hoverType===HoverType.Resize){this.resizePens(t);return}if(this.hoverType===HoverType.Node||this.hoverType===HoverType.Line){const d=t.x-this.mouseDown.x,f=t.y-this.mouseDown.y,u=20;if(t.ctrlKey&&!t.shiftKey&&(Math.abs(d)>=u||Math.abs(f)>=u)&&(this.willInactivePen=void 0),this.store.active.length===1){const v=this.store.active[0];if((v.locked===void 0||v.locked<LockState.DisableMove)&&((l=v==null?void 0:v.onMouseMove)==null||l.call(v,v,this.mousePos)),v.calculative.focus)return}this.movePens(t),this.getContainerHover(t);return}}else if(this.pencil){const{x:d,y:f}=t,u={x:d,y:f};u.id=s8(),u.penId=this.pencilLine.id,this.pencilLine.calculative.worldAnchors.push(u),this.store.path2dMap.set(this.pencilLine,globalStore.path2dDraws[this.pencilLine.name](this.pencilLine)),this.patchFlags=!0}}if(this.drawingLine){const{x:d,y:f}=t,u={x:d,y:f};if(u.id=s8(),u.penId=this.drawingLine.id,!this.store.options.disableDock&&!this.store.options.disableLineDock&&(this.clearDock(),this.dock=calcAnchorDock(this.store,u),(c=this.dock)!=null&&c.xDock&&(u.x+=this.dock.xDock.step),(h=this.dock)!=null&&h.yDock&&(u.y+=this.dock.yDock.step)),this.mouseDown&&this.drawingLineName==="curve"&&!this.drawingLine.calculative.worldAnchors[0].connectTo)this.drawline(u);else{let v;if(this.drawingLine.calculative.worldAnchors.length>1&&(v=getToAnchor(this.drawingLine)),v?(v.prev=void 0,v.next=void 0,v.id||(v.id=s8()),v.x=u.x,v.y=u.y,v.connectTo=void 0):(v={...u},this.drawingLine.calculative.worldAnchors.push(v)),(this.hoverType===HoverType.NodeAnchor||this.hoverType===HoverType.LineAnchor)&&(this.store.hoverAnchor.type!==PointType.Line&&(v.x=this.store.hoverAnchor.x,v.y=this.store.hoverAnchor.y),v.connectTo=this.store.hoverAnchor.penId,this.drawingLineName==="polyline"&&(v.isTemp=!1)),this.drawingLineName==="line"){if(t.ctrlKey&&!t.shiftKey)v.x=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].x;else if(t.shiftKey&&!t.ctrlKey)v.y=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].y;else if(t.shiftKey&&t.ctrlKey){let y=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2];this.getSpecialAngle(v,y)}}this.drawline()}}globalThis.debug&&console.time("hover");const i=performance.now();i-this.hoverTimer>50&&(this.hoverTimer=i,this.getHover(t)),globalThis.debug&&console.timeEnd("hover"),this.hotkeyType===HotkeyType.AddAnchor&&(this.patchFlags=!0),this.render(!1)});g(this,"onMouseUp",t=>{if(this.store.data.locked===LockState.Disable){this.hoverType=HoverType.None;return}if(this.mouseDown){if(this.mouseRight===MouseRight.Down&&(this.store.hover&&this.store.hover.onContextmenu?this.store.hover.onContextmenu(this.store.hover,t):this.store.emitter.emit("contextmenu",{e:t,clientRect:this.clientRect,pen:this.store.hover})),this.mouseRight=MouseRight.None,this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.pencil&&this.finishPencil(),this.drawingLine){if(this.store.hoverAnchor){const i=getToAnchor(this.drawingLine);this.store.hoverAnchor.type===PointType.Line?getDistance(i,this.store.hoverAnchor,this.store):(i.x=this.store.hoverAnchor.x,i.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,this.drawingLine,i),this.drawline(),this.finishDrawline(!0);return}if(this.store.options.autoAnchor&&this.hoverType===HoverType.Node){const i=getToAnchor(this.drawingLine),s=nearestAnchor(this.store.hover,t);i.x=s.x,i.y=s.y,this.drawingLine.autoTo=!0,connectLine(this.store.hover,s,this.drawingLine,i),this.drawline(),this.finishDrawline(!0);return}}if(this.hoverType===HoverType.LineAnchor&&this.store.hover&&this.store.active[0]&&this.store.active[0].name==="line"&&this.store.active[0]!==this.store.hover){const i=this.store.active[0],s=getFromAnchor(i),a=getToAnchor(i);if(this.store.hoverAnchor){const r=this.store.hover,o=getFromAnchor(r)===this.store.hoverAnchor,n=getToAnchor(r)===this.store.hoverAnchor,l=s===this.store.activeAnchor,c=a===this.store.activeAnchor;if((t.ctrlKey||t.altKey)&&r.type===PenType.Line&&(o||n)&&(l||c)){const h=r.calculative.worldAnchors.map(d=>({...d,penId:i.id}));o?h.shift():n&&h.pop(),(o&&l||n&&c)&&h.reverse(),l?(i.calculative.worldAnchors[0].connectTo=void 0,i.calculative.worldAnchors.unshift(...h)):c&&(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].connectTo=void 0,i.calculative.worldAnchors.push(...h)),this.delete([r]),this.render()}else this.store.activeAnchor&&(this.store.hoverAnchor.type===PointType.Line?getDistance(this.store.activeAnchor,this.store.hoverAnchor,this.store):(this.store.activeAnchor.x=this.store.hoverAnchor.x,this.store.activeAnchor.y=this.store.hoverAnchor.y),connectLine(this.store.hover,this.store.hoverAnchor,i,this.store.activeAnchor));this[i.lineName]&&i.lineName!=="polyline"&&this[i.lineName](this.store,i),this.store.path2dMap.set(i,globalStore.path2dDraws.line(i)),this.initLineRect(i)}else s===this.store.activeAnchor&&i.autoFrom?this.calcAutoAnchor(i,s,this.store.hover):a===this.store.activeAnchor&&i.autoTo&&this.calcAutoAnchor(i,a,this.store.hover)}if(this.addCaches&&this.addCaches.length){if(!this.store.data.locked){if(this.dragRect&&this.addCaches.length===1){const i=this.addCaches[0];i.width=this.dragRect.width/this.store.data.scale,i.height=this.dragRect.height/this.store.data.scale,t.x=(this.dragRect.x+this.dragRect.ex)/2,t.y=(this.dragRect.y+this.dragRect.ey)/2}this.dropPens(this.addCaches,t)}this.addCaches=void 0}if(this.hoverType===HoverType.Rotate&&(this.getSizeCPs(),this.store.active.forEach(i=>{i.rotate=i.calculative.rotate})),this.patchFlagsLines.forEach(i=>{i.type&&this.initLineRect(i)}),this.patchFlagsLines.clear(),this.dragRect)if(this.canvasImage.fitFlag)this.makeFit();else{const i=this.store.data.pens.filter(s=>{if(s.visible===!1||s.locked>=LockState.DisableMove||s.parentId||s.isRuleLine)return!1;if(rectInRect(s.calculative.worldRect,this.dragRect,t.ctrlKey||this.store.options.dragAllIn))return s.type===PenType.Line&&!this.store.options.dragAllIn?lineInRect(s,this.dragRect):!0});this.active(i)}if(t.button!==2&&(distance(this.mouseDown,t)<2&&(this.store.hover&&this.store.hover.input&&(this.store.hover.onShowInput?this.store.hover.onShowInput(this.store.hover,t):this.showInput(this.store.hover)),this.store.emitter.emit("click",{x:t.x,y:t.y,pen:this.store.hover})),this.store.hover&&(this.store.hover.calculative.mouseDown=!1),this.store.hover!=this.store.hoverContainer&&this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hover}),this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hoverContainer})),this.willInactivePen){this.willInactivePen.calculative.active=void 0,setChildrenActive(this.willInactivePen,!1);const i=this.store.active.findIndex(s=>s===this.willInactivePen);i>=0&&this.store.active.splice(i,1),this.calcActiveRect(),this.willInactivePen=void 0,this.store.emitter.emit("inactive",[this.willInactivePen]),this.render()}this.movingPens&&(t.altKey&&!t.shiftKey?this.copyMovedPens():this.movedActivePens(t.ctrlKey&&t.shiftKey),this.getAllByPens(this.movingPens).forEach(i=>{this.store.pens[i.id]=void 0}),this.movingPens=void 0),this.store.active&&this.store.active[0]&&(this.store.active[0].calculative.h=void 0),this.mouseDown=void 0,this.lastOffsetX=0,this.lastOffsetY=0,this.clearDock(),this.dragRect=void 0,this.initActiveRect=void 0,this.render()}});g(this,"clearDock",()=>{var r,o,n,l;const t=(o=(r=this.dock)==null?void 0:r.xDock)==null?void 0:o.penId,i=(l=(n=this.dock)==null?void 0:n.yDock)==null?void 0:l.penId,s=this.store.pens[t];s&&(s.calculative.isDock=!1);const a=this.store.pens[i];a&&(a.calculative.isDock=!1),this.dock=void 0});g(this,"onResize",()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.resize(),this.timer=void 0},100)});g(this,"onScroll",()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.clientRect=this.canvas.getBoundingClientRect(),this.timer=void 0},100)});g(this,"calibrateMouse",t=>(t.x-=this.store.data.x,t.y-=this.store.data.y,t));g(this,"getContainerHover",t=>{var s;if(this.dragRect)return;this.store.hoverContainer=void 0;const i=this.store.data.pens.filter(a=>{var r;return a.container||((r=this.store.options.containerShapes)==null?void 0:r.includes(a.name))});if(i.length)for(let a=i.length-1;a>=0;--a){const r=i[a];if(!(r.visible==!1||r.calculative.inView==!1||r.locked===LockState.Disable)){if(pointInRect(t,r.calculative.worldRect))this.store.hoverContainer=r,(s=r==null?void 0:r.onMouseMove)==null||s.call(r,r,t),this.store.lastHoverContainer!==this.store.hoverContainer&&(this.patchFlags=!0,this.store.lastHoverContainer&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.hoverContainer&&(this.store.hoverContainer.calculative.containerHover=!0,this.store.emitter.emit("enter",this.store.hoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer);else if(r===this.store.hoverContainer&&(this.store.hoverContainer=void 0,this.store.lastHoverContainer!==this.store.hoverContainer)){this.patchFlags=!0;const o=this.store.lastHoverContainer.calculative.canvas.store.pens[this.store.lastHoverContainer.id+movingSuffix];this.store.lastHoverContainer&&!o&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer}}}});g(this,"getHover",t=>{var a,r;if(this.dragRect||this.canvasImage.fitFlag)return;let i=HoverType.None;this.store.hover=void 0,this.store.hoverAnchor=void 0,this.title.hide(),this.store.pointAt=void 0,this.store.pointAtIndex=void 0;const s=this.store.active.length===1&&this.store.active[0].type;if(!this.drawingLineName&&this.hotkeyType!==HotkeyType.AddAnchor&&this.activeRect&&!s&&!this.store.data.locked){const o=getPensLock(this.store.active),n=getPensDisableRotate(this.store.active)||this.store.options.disableRotate,l=getPensDisableResize(this.store.active)||this.store.options.disableSize;if(!o&&!n){const c={x:this.activeRect.center.x,y:this.activeRect.y-30};this.activeRect.rotate&&rotatePoint(c,this.activeRect.rotate,this.activeRect.pivot||this.activeRect.center),!this.hotkeyType&&hitPoint(t,c,this.pointSize)&&(i=HoverType.Rotate,this.externalElements.style.cursor=`url("${this.store.options.rotateCursor}"), auto`)}if(!o&&!l)for(let c=0;c<8;c++){const h=c<4;if((this.hotkeyType===HotkeyType.Resize||h&&!this.hotkeyType)&&hitPoint(t,this.sizeCPs[c],this.pointSize)){let f=h?defaultCursors:rotatedCursors,u=0;Math.abs(this.activeRect.rotate%90-45)<25?(f=h?rotatedCursors:defaultCursors,u=Math.round((this.activeRect.rotate-45)/90)+(h?0:1)):u=Math.round(this.activeRect.rotate/90),i=HoverType.Resize,this.resizeIndex=c,this.externalElements.style.cursor=f[(c+u)%4];break}}}i===HoverType.None&&(i=this.inPens(t,this.store.data.pens)),!i&&!s&&pointInRect(t,this.activeRect)&&(i=HoverType.Node,this.externalElements.style.cursor="move"),this.hoverType=i,i===HoverType.None&&(this.drawingLineName||this.pencil?this.externalElements.style.cursor="crosshair":this.mouseDown||(this.externalElements.style.cursor="default"),this.store.hover=void 0),this.store.lastHover!==this.store.hover&&(this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1,setHover(getParent(this.store.lastHover,!0)||this.store.lastHover,!1),this.store.emitter.emit("leave",this.store.lastHover),this.tooltip.hide()),this.store.hover&&(this.store.hover.calculative.hover=!0,setHover(getParent(this.store.hover,!0)||this.store.hover),this.store.emitter.emit("enter",this.store.hover),this.tooltip.show(this.store.hover,t)),this.store.lastHover=this.store.hover),(r=(a=this.store.hover)==null?void 0:a.onMouseMove)==null||r.call(a,this.store.hover,this.mousePos)});g(this,"inPens",(t,i)=>{var a;let s=HoverType.None;t:for(let r=i.length-1;r>=0;--r){const o=i[r];if(o.visible==!1||o.calculative.inView==!1||o.locked===LockState.Disable)continue;const n=getLineR(o);if(!(!o.calculative.active&&!pointInSimpleRect(t,o.calculative.worldRect,n)&&!pointInRect(t,o.calculative.worldRect))){if(!this.store.data.locked&&this.hotkeyType!==HotkeyType.Resize&&o.calculative.worldAnchors){for(const l of o.calculative.worldAnchors)if(s=this.inAnchor(t,o,l),s){let c=deepClone(l);Object.assign(c,t),this.title.show(c,o);break t}}if(o.type){if(o.isRuleLine){let c=((a=this.store.options.ruleOptions)==null?void 0:a.height)||20;if(t.x+this.store.data.x>c&&t.y+this.store.data.y>c)break}const l=pointInLine(t,o);if(l){!this.store.data.locked&&!o.locked?this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move":this.externalElements.style.cursor=this.store.options.hoverCursor,o.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=o,this.store.pointAt=l.point,this.store.pointAtIndex=l.i,this.initTemplateCanvas([this.store.hover]),s=HoverType.Line;break}}else{if(o.children){const c=[];if(o.children.forEach(h=>{this.store.pens[h]&&c.push(this.store.pens[h])}),s=this.inPens(t,c),s)break}let l=!1;if(o.name==="line"?l=pointInSimpleRect(t,o.calculative.worldRect,o.lineWidth):l=pointInRect(t,o.calculative.worldRect),l){if(o.type===PenType.Node&&o.name==="line"&&!pointInPolygon(t,o.calculative.worldAnchors))continue;if(!this.store.data.locked&&!o.locked?this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move":this.externalElements.style.cursor=this.store.options.hoverCursor,o.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=o,this.initTemplateCanvas([this.store.hover]),s=HoverType.Node,this.store.pointAt=t,!t.ctrlKey){let{x:c,y:h,ex:d,ey:f,rotate:u,center:v}=this.store.hover.calculative.worldRect;if(u){const y=[{x:c,y:h},{x:d,y:h},{x:d,y:f},{x:c,y:f}];y.forEach(w=>{rotatePoint(w,u,v)});let m=y[y.length-1];for(const w of y){if(m.y>t.y!=w.y>t.y){const x=w.x+(t.y-w.y)*(m.x-w.x)/(m.y-w.y);Math.abs(x-this.store.pointAt.x)<10&&(this.store.pointAt.x=x)}m=w}}else this.store.pointAt.x-10<c?this.store.pointAt.x=c:this.store.pointAt.x+10>d&&(this.store.pointAt.x=d),this.store.pointAt.y-10<h?this.store.pointAt.y=h:this.store.pointAt.y+10>f&&(this.store.pointAt.y=f)}break}}}}return s});g(this,"dockInAnchor",t=>{var i,s;this.store.hover=void 0;for(let a=this.store.data.pens.length-1;a>=0;--a){const r=this.store.data.pens[a];if(r.visible==!1||r.locked===LockState.Disable||r===this.store.active[0])continue;let o=getLineR(r);if(o+=2*this.store.options.anchorRadius,!!pointInSimpleRect(t,r.calculative.worldRect,o)&&(this.store.hover=r,this.hotkeyType!==HotkeyType.Resize&&r.calculative.worldAnchors))for(const n of r.calculative.worldAnchors){if(n.twoWay===TwoWay.In){const l=getToAnchor(this.store.active[0]);if(this.store.activeAnchor.id!==l.id)continue}if(n.twoWay===TwoWay.Out){const l=getFromAnchor(this.store.active[0]);if(this.store.activeAnchor.id!==l.id)continue}if(!(n.twoWay===TwoWay.DisableConnected||n.twoWay===TwoWay.Disable||((i=this.store.activeAnchor)==null?void 0:i.twoWay)===TwoWay.DisableConnectTo||((s=this.store.activeAnchor)==null?void 0:s.twoWay)===TwoWay.Disable)&&(this.title.hide(),this.inAnchor(t,r,n))){let l=deepClone(n);return Object.assign(l,t),this.title.show(l,r),!0}}}});g(this,"imageTimer");g(this,"templateImageTimer");g(this,"render",t=>{if(t&&(this.opening=!1),this.opening)return;let i;if(t==null||t===!0||t===1/0?(i=performance.now(),this.patchFlags=!0):t>1?i=t:i=performance.now(),!this.patchFlags)return;if(i-this.lastRender<this.store.options.interval){this.renderTimer&&cancelAnimationFrame(this.renderTimer),this.renderTimer=requestAnimationFrame(this.render);return}this.renderTimer=void 0,this.lastRender=i;const s=this.offscreen.getContext("2d");s.clearRect(0,0,this.offscreen.width,this.offscreen.height),s.save(),s.translate(this.store.data.x,this.store.data.y),globalThis.debugRender&&console.time("renderPens"),this.renderPens(),globalThis.debugRender&&console.timeEnd("renderPens"),this.renderBorder(),this.renderHoverPoint(),s.restore(),this.magnifierCanvas.magnifier&&this.magnifierCanvas.render();const a=this.canvas.getContext("2d");a.clearRect(0,0,this.canvas.width,this.canvas.height),a.drawImage(this.offscreen,0,0,this.width,this.height),this.canvasTemplate.render(),this.canvasImageBottom.render(),this.canvasImage.render(),this.patchFlags=!1});g(this,"renderPens",()=>{const t=this.offscreen.getContext("2d");t.strokeStyle=this.store.styles.color;for(const i of this.store.data.pens)isFinite(i.x)&&i.canvasLayer!==CanvasLayer.CanvasTemplate&&(i.name==="combine"&&!i.draw||i.calculative.inView&&(i.canvasLayer===CanvasLayer.CanvasMain&&i.name!=="gif"&&i.image&&i.calculative.img&&(t.save(),ctxFlip(t,i),i.calculative.rotate&&ctxRotate(t,i),setGlobalAlpha(t,i),drawImage(t,i),t.restore()),renderPen(t,i)));this.drawingLine&&renderPen(t,this.drawingLine),this.pencilLine&&renderPen(t,this.pencilLine),this.movingPens&&this.movingPens.forEach(i=>{this.renderPenContainChild(t,i)})});g(this,"renderPenContainChild",(t,i)=>{var s;i.calculative.inView&&(i.name==="combine"&&!i.draw||renderPen(t,i)),(s=i.children)==null||s.forEach(a=>{const r=this.store.pens[a];r&&this.renderPenContainChild(t,r)})});g(this,"renderBorder",()=>{if(!this.store.data.locked&&this.activeRect&&!(this.store.active.length===1&&this.store.active[0].type)&&!this.movingPens){const t=this.offscreen.getContext("2d");t.save(),t.translate(.5,.5);const i=this.activeRect.pivot||this.activeRect.center;if(this.activeRect.rotate&&(t.translate(i.x,i.y),t.rotate(this.activeRect.rotate*Math.PI/180),t.translate(-i.x,-i.y)),t.strokeStyle=this.store.styles.activeColor,t.globalAlpha=this.store.options.activeGlobalAlpha===void 0?.3:this.store.options.activeGlobalAlpha,t.beginPath(),t.lineWidth=this.store.options.activeLineWidth||1,t.setLineDash(this.store.options.activeLineDash||[]),t.strokeRect(this.activeRect.x,this.activeRect.y,this.activeRect.width,this.activeRect.height),t.setLineDash([]),t.lineWidth=1,t.globalAlpha=1,getPensLock(this.store.active)||getPensDisableRotate(this.store.active)||this.store.options.disableRotate){t.restore();return}t.beginPath(),t.moveTo(this.activeRect.center.x,this.activeRect.y),t.lineTo(this.activeRect.center.x,this.activeRect.y-30),t.stroke(),t.beginPath(),t.strokeStyle=this.store.styles.activeColor,t.fillStyle="#ffffff",t.arc(this.activeRect.center.x,this.activeRect.y-30,5,0,Math.PI*2),t.fill(),t.stroke(),t.restore()}});g(this,"renderHoverPoint",()=>{if(this.store.data.locked)return;const t=this.offscreen.getContext("2d");if(t.save(),t.translate(.5,.5),!this.store.options.disableAnchor&&this.store.hover&&!this.store.hover.disableAnchor&&(this.hotkeyType!==HotkeyType.Resize||this.store.active.length!==1||this.store.active[0]!==this.store.hover)){const i=[...this.store.hover.calculative.worldAnchors];this.store.pointAt&&this.hotkeyType===HotkeyType.AddAnchor&&i.push(this.store.pointAt),i&&(t.strokeStyle=this.store.hover.anchorColor||this.store.styles.anchorColor,t.fillStyle=this.store.hover.anchorBackground||this.store.options.anchorBackground,i.forEach(s=>{if(s.hidden&&s.locked>LockState.DisableEdit)return;if(s===this.store.hoverAnchor){t.save();const r=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;t.strokeStyle=r,t.fillStyle=r}t.beginPath();let a=s.radius||this.store.hover.anchorRadius||this.store.options.anchorRadius;if(this.store.hover.type&&!s.radius&&!this.store.hover.anchorRadius&&(a=3,this.store.hover.calculative.lineWidth>3&&(a=this.store.hover.calculative.lineWidth)),s.type===PointType.Line){let r=this.store.pens[s.penId].rotate||0;this.store.pens[s.penId].calculative.flipX&&(r*=-1),this.store.pens[s.penId].calculative.flipY&&(r*=-1);let o=s.rotate+r;this.store.pens[s.penId].calculative.flipX&&(o*=-1),this.store.pens[s.penId].calculative.flipY&&(o*=-1),t.save(),t.translate(s.x,s.y),t.rotate(o*Math.PI/180),t.translate(-s.x,-s.y),t.rect(s.x-s.length*this.store.data.scale/2,s.y-a,s.length*this.store.data.scale,a*2),t.restore()}else t.arc(s.x,s.y,a,0,Math.PI*2);if(this.store.hover.type&&this.store.hoverAnchor===s?(t.save(),t.strokeStyle=this.store.hover.activeColor||this.store.styles.activeColor,t.fillStyle=t.strokeStyle):(s.color||s.background)&&(t.save(),t.strokeStyle=s.color,t.fillStyle=s.background),t.fill(),t.stroke(),s===this.store.hoverAnchor&&t.restore(),(this.store.hover.type&&this.store.hoverAnchor===s||s.color||s.background)&&t.restore(),!this.store.hover.parentId&&this.store.hover.children&&this.store.hover.children.length>0&&s===this.store.hoverAnchor){t.save(),t.beginPath(),t.lineWidth=3;const r=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;globalThis.pSBC&&(t.strokeStyle=globalThis.pSBC(.5,r)),t.arc(s.x,s.y,a+1.5,0,Math.PI*2),t.stroke(),t.restore()}}))}this.hotkeyType!==HotkeyType.AddAnchor&&!this.movingPens&&this.activeRect&&!(this.store.active.length===1&&this.store.active[0].type)&&!getPensLock(this.store.active)&&!getPensDisableResize(this.store.active)&&!this.store.options.disableSize&&(t.strokeStyle=this.store.styles.activeColor,t.fillStyle="#ffffff",this.sizeCPs.forEach((i,s)=>{this.activeRect.rotate&&(t.save(),t.translate(i.x,i.y),t.rotate(this.activeRect.rotate*Math.PI/180),t.translate(-i.x,-i.y)),(s<4||this.hotkeyType===HotkeyType.Resize)&&(t.beginPath(),t.fillRect(i.x-4.5,i.y-4.5,8,8),t.strokeRect(i.x-5.5,i.y-5.5,10,10)),this.activeRect.rotate&&t.restore()})),!this.store.data.locked&&this.dragRect&&(t.save(),t.fillStyle=rgba(this.store.options.dragColor,.2),t.strokeStyle=this.store.options.dragColor,t.beginPath(),t.strokeRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),t.fillRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),t.restore()),this.dock&&(t.strokeStyle=this.store.options.dockColor,this.dock.xDock&&(t.beginPath(),t.moveTo(this.dock.xDock.x,this.dock.xDock.y),t.lineTo(this.dock.xDock.x,this.dock.xDock.prev.y),t.stroke()),this.dock.yDock&&(t.beginPath(),t.moveTo(this.dock.yDock.x,this.dock.yDock.y),t.lineTo(this.dock.yDock.prev.x,this.dock.yDock.y),t.stroke())),t.restore()});g(this,"transTimeout");g(this,"pastePen",(t,i)=>{const s=t.id;if(randomId(t),t.parentId=i,t.type===PenType.Line?this.changeNodeConnectedLine(s,t,this.store.clipboard.pens):this.changeLineAnchors(s,t,this.store.clipboard.pens),!t.parentId){const r=this.getPenRect(t,this.store.clipboard.origin,this.store.clipboard.scale),o=this.getPenRect(this.store.clipboard.initRect,this.store.clipboard.origin,this.store.clipboard.scale),{origin:n,scale:l}=this.store.data;t.x=n.x+r.x*l,t.y=n.y+r.y*l,t.width=r.width*l,t.height=r.height*l,o.x=n.x+o.x*l,o.y=n.y+o.y*l,calcCenter(o),this.store.clipboard.pos&&(t.x-=o.center.x-this.store.clipboard.pos.x,t.y-=o.center.y-this.store.clipboard.pos.y),this.keyOptions&&this.keyOptions.altKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey)?(t.x=-this.store.data.x+this.width/2-t.width/2,t.y=-this.store.data.y+this.height/2-t.height/2):this.keyOptions&&this.keyOptions.shiftKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey||this.keyOptions.F)||(t.x+=this.store.clipboard.offset*this.store.data.scale,t.y+=this.store.clipboard.offset*this.store.data.scale)}this.makePen(t);const a=[];if(Array.isArray(t.children))for(const r of t.children){const o=this.store.clipboard.pens.find(n=>n.id===r);o&&a.push(this.pastePen(o,t.id).id)}return t.children=a,calcInView(t,!0),t});g(this,"ondblclick",t=>{var i,s,a;if(this.store.hover&&(!this.store.data.locked||this.store.hover.dbInput)&&!this.store.options.disableInput)if(this.store.hover.onShowInput)this.store.hover.onShowInput(this.store.hover,t);else if(this.store.hover&&this.store.hover.parentId)if(((i=this.store.active)==null?void 0:i.length)===1&&this.store.active[0].id===this.store.hover.id)this.showInput(this.store.hover);else{if(this.store.pens[this.store.hover.parentId].children.forEach(r=>{this.store.pens[r].calculative.active=!1,this.store.pens[r].calculative.hover=!1}),this.store.hover.parentId){let r=this.store.hover.id;const o=this.calibrateMouse({x:t.offsetX,y:t.offsetY});let n=1/0;(a=(s=this.store.pens[this.store.hover.parentId])==null?void 0:s.children)==null||a.forEach(l=>{const c=this.store.pens[l];if(pointInRect(o,c.calculative.worldRect)){const h=Math.sqrt((o.x-c.calculative.worldRect.center.x)**2+(o.y-c.calculative.worldRect.center.y)**2);h<n&&(n=h,r=l)}}),this.store.hover=this.store.pens[r],this.store.pens[r].calculative.hover=!0}this.active([this.store.hover])}else this.showInput(this.store.hover);this.store.emitter.emit("dblclick",{x:t.x,y:t.y,pen:this.store.hover})});g(this,"showInput",(t,i,s="transparent")=>{if(!window||!this.store.hover||this.store.hover.locked||this.store.hover.externElement||this.store.hover.disableInput||this.store.hover.disabled)return;if(this.inputDiv.dataset.penId===t.id){this.inputDiv.dataset.isInput="true",this.inputDiv.contentEditable="true",this.inputDiv.focus();const h=window.getSelection();h.selectAllChildren(this.inputDiv),h.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,this.inputDiv.scrollLeft=this.inputDiv.scrollWidth;return}!i&&!t.dbInput?this.setInputStyle(t):(this.inputDiv.style.width="100%",this.inputDiv.style.height="100%");const a=i||t.calculative.worldTextRect,n=`${(t.calculative.tempText===void 0?t.text+""||"":t.calculative.tempText).replace(/\x20/g,"&nbsp;").split(/[\s\n]/).join("</div><div>")}</div>`.replace("</div>","").replace(/\<div\>\<\/div\>/g,"<div><br></div>");this.inputDiv.innerHTML=n,this.inputParent.style.left=a.x+this.store.data.x-(t.calculative.textLeft||0)+"px",this.inputParent.style.top=a.y+this.store.data.y-(t.calculative.textTop||0)+"px";let l=a.width;this.inputParent.style.width=(l<0?12:l)+"px",this.inputParent.style.height=a.height+(t.textTop||0)+"px",this.inputParent.style.zIndex="9999",this.inputParent.style.background=s,t.rotate%360?this.inputParent.style.transform=`rotate(${t.rotate}deg)`:this.inputParent.style.transform=null,this.inputParent.style.display="flex",this.inputDiv.dataset.penId=t.id,this.inputDiv.contentEditable=t.disableInput==null?"true":t.disableInput.toString(),t.dropdownList&&this.dropdown.style.display!=="block"&&(this.dropdown.style.background=t.dropdownBackground||this.store.styles.popContentBg||"#fff",this.dropdown.style.color=t.dropdownColor||"#bdc7db",this.dropdown.style.width=this.inputParent.style.width,this.dropdown.style.fontSize=(t.fontSize||12)+"px",this.setDropdownList(),this.externalElements.style.zIndex="9999"),this.inputDiv.contentEditable="true",this.inputDiv.focus();const c=window.getSelection();c.selectAllChildren(this.inputDiv),c.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,this.inputDiv.scrollLeft=this.inputDiv.scrollWidth,t.calculative.text=void 0,this.initTemplateCanvas([t]),this.render()});g(this,"setInputStyle",t=>{t.text||(t.text="");let i;for(let l=0;l<document.styleSheets.length;l++)document.styleSheets[l].title==="le5le.com"&&(i=document.styleSheets[l]);let s="overflow: scroll;",a="",r=1;const{scale:o}=this.store.data;if(t.fontSize<12&&(r=12/t.fontSize),t.textAlign?s+=`text-align: ${t.textAlign};`:s+="text-align: center;",t.textAlign&&t.whiteSpace==="pre-line"&&(s+=`align-items: ${{left:"start",center:"center",right:"end"}[t.textAlign]};`),t.textBaseline?s+=`justify-content: ${{top:"start",middle:"center",bottom:"end"}[t.textBaseline]};`:s+="justify-content: center;",t.fontFamily&&(s+=`font-family: ${t.fontFamily};`),t.fontSize&&(t.fontSize*o<12?(s+=`font-size:${t.fontSize}px;`,s+=`zoom:${t.fontSize/12*o};`):s+=`font-size:${t.fontSize*o}px;`),s+=`color:${getTextColor(t,this.store)};`,t.fontStyle&&(s+=`font-style: ${t.fontStyle};`),t.fontWeight&&(s+=`font-weight: ${t.fontWeight};`),t.textLeft&&(s+=`margin-left:${o>1?t.textLeft*r:t.textLeft*r/o}px;`),t.textTop&&(s+=`margin-top:${o>1?t.textTop*r:t.textTop*r/o}px;`),t.lineHeight&&(s+=`line-height:${o>1?t.fontSize*t.lineHeight*o:t.fontSize*t.lineHeight*r}px;`),t.textHeight)s+=`height:${o>1?t.textHeight*r*o:t.textHeight*r}px;`;else{let l=t.calculative.worldRect.height/o;l<0&&(l=0);let c=t.fontSize*o<12?l*r:l*o*r;c<t.fontSize*t.lineHeight*o&&(c=t.fontSize*t.lineHeight*o,s+=`top:-${c/2}px;`),s+=`height:${c}px;`}let n=null;if(t.textWidth)n=t.textWidth<1&&t.textWidth>-1?t.textWidth*t.calculative.worldRect.width:t.textWidth,t.whiteSpace!=="pre-line"&&(n<t.fontSize?s+=`width:${t.fontSize*1.2*r}px;`:s+=`width:${o>1?n*r*o:n*r}px;`);else if(t.whiteSpace===void 0||t.whiteSpace==="break-all"){let l=(t.calculative.worldTextRect.width||12)/o;l<0&&(l=0),s+=`width:${t.fontSize*o<12?l*r:l*o}px;`}if(t.whiteSpace&&(t.whiteSpace==="pre-line"?s+="white-space:pre;":(s+=`white-space:${t.whiteSpace};`,t.whiteSpace==="nowrap"&&(a+="display:contents;"))),t.whiteSpace!=="nowrap"){let l=t.fontSize*1.2*t.text.length,c=(n||t.calculative.worldRect.width/o)*Math.floor(t.calculative.worldRect.height/o/(t.lineHeight*t.fontSize));l>c&&(s+="justify-content: start;")}i.deleteRule(0),i.deleteRule(0),i.insertRule(`.meta2d-input
      .input-div{
        resize:none;border:none;outline:none;background:transparent;position:absolute;flex-grow:1;height:100%;width: 100%;position:absolute;left:0;top:0;display:flex;flex-direction: column;cursor: text;${s}}`),i.insertRule(`.input-div div{${a}}`)});g(this,"hideInput",()=>{if(this.externalElements.style.zIndex="5",this.inputParent.style.display==="flex"){this.inputParent.style.display="none";const t=this.store.pens[this.inputDiv.dataset.penId];if(!t)return;if(t.calculative.text=t.text,this.inputDiv.dataset.value=this.inputDiv.innerHTML.replace(/\<div\>/g,`
`).replace(/\<\/div\>/g,"").replace(/\<br\>/g,"").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,""),this.inputDiv.dataset.value=this.convertSpecialCharacter(this.inputDiv.dataset.value),t.onInput)t.onInput(t,this.inputDiv.dataset.value);else if(t.text!==this.inputDiv.dataset.value){const i=[deepClone(t,!0)];t.text=this.inputDiv.dataset.value,t.calculative.text=t.text,this.inputDiv.dataset.penId=void 0,t.text&&t.textAutoAdjust&&!t.parentId&&calcTextAutoWidth(t),calcTextRect(t),this.patchFlags=!0,this.pushHistory({type:EditType.Update,pens:[deepClone(t,!0)],initPens:i}),this.store.emitter.emit("change",t),this.store.emitter.emit("valueUpdate",t)}else t.text===this.inputDiv.dataset.value&&t.calculative.textLines.length==0&&calcTextRect(t);this.initTemplateCanvas([t])}this.inputDiv.dataset.penId=void 0,this.dropdown.style.display="none",this.inputDiv.dataset.isInput="false",this.inputDiv.contentEditable="false",this.render()});g(this,"setDropdownList",t=>{this.clearDropdownList();const i=this.store.pens[this.inputDiv.dataset.penId];if(!this.store.data.locked&&!["tablePlus"].includes(i.name))return;if(this.dropdown.style.display="block",!i||!i.dropdownList){this.dropdown.style.display="none";return}if(!i.dropdownList.length){const r=document.createElement("div");r.innerText="None",r.style.padding="5px 12px",r.style.color="#ddd",this.dropdown.appendChild(r);return}const s=this.inputDiv.innerHTML.replace(/\<div\>/g,`
`).replace(/\<\/div\>/g,"").replace(/\<br\>/g,"");let a=0;for(const r of i.dropdownList){const o=typeof r=="string"?r:r.text;t&&s?o.includes(s)&&this.dropdownAppendOption(o,a):this.dropdownAppendOption(o,a),++a}if(!this.dropdown.hasChildNodes()){const r=document.createElement("div");r.innerText="None",r.style.padding="5px 12px",r.style.color="#ddd",this.dropdown.appendChild(r)}});g(this,"selectDropdown",t=>{const i=t.target,s=this.store.pens[this.inputDiv.dataset.penId];if(!i||!s||!s.dropdownList)return;const a=+i.dataset.i,r=s.dropdownList[a];if(!r)return;const o=[deepClone(s,!0)];typeof r=="object"?(this.updateValue(s,{...r}),s.calculative.text=void 0,this.calcActiveRect()):s.text=r+"",this.inputDiv.innerText=s.text,this.hideInput(),this.pushHistory({type:EditType.Update,pens:[deepClone(s,!0)],initPens:o}),this.render(),this.store.emitter.emit("change",s),this.store.emitter.emit("valueUpdate",s)});g(this,"inFitBorder",t=>{let i;const s=this.store.data.width||this.store.options.width,a=this.store.data.height||this.store.options.height;let r={x:(t.x-this.store.data.origin.x)/this.store.data.scale,y:(t.y-this.store.data.origin.y)/this.store.data.scale};const o=this.canvasImage.activeFit;this.externalElements.style.cursor="default",r.y>a*o.y-10&&r.y<a*o.y+10&&(i="top",this.externalElements.style.cursor="row-resize"),r.y>a*(o.y+o.height)-10&&r.y<a*(o.y+o.height)+10&&(i="bottom",this.externalElements.style.cursor="row-resize"),r.x>s*o.x-10&&r.x<s*o.x&&(i="left",this.externalElements.style.cursor="col-resize"),r.x>s*(o.x+o.width)-10&&r.x<s*(o.x+o.width)+10&&(i="right",this.externalElements.style.cursor="col-resize"),this.canvasImage.currentFit=i});this.parent=t,this.parentElement=i,this.store=s,this.canvasTemplate=new CanvasTemplate(i,s),this.canvasTemplate.canvas.style.zIndex="1",this.canvasImageBottom=new CanvasImage(i,s,!0),this.canvasImageBottom.canvas.style.zIndex="2",i.appendChild(this.canvas),this.canvas.style.position="absolute",this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.zIndex="3",this.canvasImage=new CanvasImage(i,s),this.canvasImage.canvas.style.zIndex="4",this.magnifierCanvas=new MagnifierCanvas(this,i,s),this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.position="absolute",this.externalElements.style.left="0",this.externalElements.style.top="0",this.externalElements.style.outline="none",this.externalElements.style.background="transparent",this.externalElements.style.zIndex="5",i.style.position="relative",i.appendChild(this.externalElements),this.createInput(),this.tooltip=new Tooltip(i,s),this.tooltip.box.onmouseleave=a=>{this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1);let r=this.store.data.pens.find(o=>o.calculative.hover===!0);setHover(r,!1)},this.popconfirm=new Popconfirm(i,s),this.dialog=new Dialog(i,s),this.title=new Title(i),this.store.options.scroll&&(this.scroll=new Scroll(this)),this.store.dpiRatio=globalThis.devicePixelRatio||1,this.store.dpiRatio<1?this.store.dpiRatio=1:this.store.dpiRatio>1&&this.store.dpiRatio<1.5&&(this.store.dpiRatio=1.5),this.clientRect=this.externalElements.getBoundingClientRect(),this.listen(),window==null||window.addEventListener("resize",this.onResize),window==null||window.addEventListener("scroll",this.onScroll),window==null||window.addEventListener("message",this.onMessage)}listen(){switch(this.externalElements.addEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=t=>t.preventDefault(),this.externalElements.ondrop=this.ondrop,this.externalElements.oncontextmenu=t=>t.preventDefault(),this.store.options.interval=50,this.externalElements.ontouchstart=this.ontouchstart,this.externalElements.ontouchmove=this.ontouchmove,this.externalElements.ontouchend=this.ontouchend,this.externalElements.onmousedown=t=>{this.onMouseDown({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons})},this.externalElements.onmousemove=t=>{t.target===this.externalElements&&this.onMouseMove({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons})},this.externalElements.onmouseup=t=>{this.onMouseUp({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons,button:t.button})},this.externalElements.onmouseleave=t=>{this.store.data.pens.forEach(i=>{i.calculative.hover&&(i.calculative.hover=!1)}),this.store.hover&&(this.store.hover.calculative.hover=!1,this.store.hover=void 0),this.render(),t.toElement!==this.tooltip.box&&t.toElement!==this.tooltip.arrowUp&&t.toElement!==this.tooltip.arrowDown&&(this.tooltip.hide(),this.store.lastHover=void 0)},this.externalElements.ondblclick=this.ondblclick,this.externalElements.tabIndex=0,this.externalElements.onblur=()=>{this.mouseDown=void 0},this.externalElements.onwheel=this.onwheel,document.addEventListener("copy",this.onCopy),document.addEventListener("cut",this.onCut),document.addEventListener("paste",this.onPaste),this.store.options.keydown){case KeydownType.Document:document.addEventListener("keydown",this.onkeydown),document.addEventListener("keyup",this.onkeyup);break;case KeydownType.Canvas:this.externalElements.addEventListener("keydown",this.onkeydown),this.externalElements.addEventListener("keyup",this.onkeyup);break}}splitLine(t,i){const s=t.calculative.worldAnchors,a=s.findIndex(h=>h===i);if([-1,0,s.length-1].includes(a))return;const r=deepClone(t,!0),o=deepClone(t,!0),n=s8();o.id=n,o.calculative.canvas=this,o.calculative.active=!1,o.calculative.hover=!1;const l=deepClone(s.slice(0,a+1)),c=deepClone(s.slice(a)).map(h=>(h.penId=n,h));t.calculative.worldAnchors=l,o.calculative.worldAnchors=c,this.initLineRect(t),this.initLineRect(o),this.store.data.pens.push(o),this.store.pens[n]=o,this.pushHistory({type:EditType.Add,pens:[deepClone(o,!0)],step:2}),this.pushHistory({type:EditType.Update,initPens:[r],pens:[deepClone(t,!0)],step:2})}translateAnchor(t,i){this.movingAnchor.x+=t,this.movingAnchor.y+=i;const s=this.movingAnchor.penId;if(s){const a=this.store.pens[s],r=a.calculative.worldRect;this.movingAnchor.x<r.x?this.movingAnchor.x=r.x:this.movingAnchor.x>r.ex&&(this.movingAnchor.x=r.ex),this.movingAnchor.y<r.y?this.movingAnchor.y=r.y:this.movingAnchor.y>r.ey&&(this.movingAnchor.y=r.ey);const o=calcRelativePoint(this.movingAnchor,r),n=a.anchors.findIndex(l=>l.id===this.movingAnchor.id);a.anchors[n]=o,this.patchFlags=!0}}async fileToPen(t,i){let s="";return this.store.options.uploadFn?s=await this.store.options.uploadFn(t):this.store.options.uploadUrl?s=await uploadFile(t,this.store.options.uploadUrl,this.store.options.uploadParams,this.store.options.uploadHeaders):s=await fileToBase64(t),new Promise((a,r)=>{const o=new Image;o.onload=()=>{globalStore.htmlElements[s]=o,a({width:o.width,height:o.height,name:i?"gif":"image",image:s})},o.onerror=n=>{r(n)},o.crossOrigin="anonymous",o.src=s})}async dropPens(t,i){var l,c,h,d;this.randomIdObj={};for(const f of t)!f.parentId&&this.randomCombineId(f,t);if(Object.keys(this.randomIdObj).length!==0){const f=Object.keys(this.randomIdObj).join("|"),u=new RegExp(`(${f})`,"g");for(const v of t){if(v.type?(v.anchors[0].connectTo=this.randomIdObj[v.anchors[0].connectTo],v.anchors[v.anchors.length-1].connectTo=this.randomIdObj[v.anchors[v.anchors.length-1].connectTo]):(l=v.connectedLines)==null||l.forEach(y=>{y.lineAnchor=this.randomIdObj[y.lineAnchor],y.lineId=this.randomIdObj[y.lineId]}),(c=v.animations)!=null&&c.length){const y=JSON.stringify(v.animations).replace(u,m=>this.randomIdObj[m]);v.animations=JSON.parse(y)}if((h=v.triggers)!=null&&h.length){const y=JSON.stringify(v.triggers).replace(u,m=>this.randomIdObj[m]);v.triggers=JSON.parse(y)}if((d=v.events)!=null&&d.length){const y=JSON.stringify(v.events).replace(u,m=>this.randomIdObj[m]);v.events=JSON.parse(y)}}}for(const f of t)f.id||(f.id=s8()),!f.calculative&&(f.calculative={canvas:this}),this.store.pens[f.id]=f;let s=0,a=0,r=0;for(const f of t)f.parentId||(f.width*=this.store.data.scale,f.height*=this.store.data.scale,f.x=i.x-f.width/2+r,f.y=i.y-f.height/2+a,f.tags&&f.tags.includes("meta3d")&&(f.x=this.store.data.origin.x,f.y=this.store.data.origin.y),f.dataset&&(s%2===0?r=f.width-40*this.store.data.scale:r=0,s++,s%2===0&&(a+=f.height+10*this.store.data.scale)));const o=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height;if(o&&n){let f={x:this.store.data.origin.x,y:this.store.data.origin.y,width:o*this.store.data.scale,height:n*this.store.data.scale},u=!0;for(const v of t)if(!v.parentId){let y=[{x:v.x,y:v.y},{x:v.x+v.width,y:v.y},{x:v.x,y:v.y+v.height},{x:v.x+v.width,y:v.y+v.height},{x:v.x+v.width/2,y:v.y+v.height/2}];if(v.x===f.x&&v.y===f.y&&v.width===f.width&&v.height===f.height||y.some(m=>pointInRect(m,f))){u=!1,this.store.options.strictScope&&(v.x<f.x&&(v.x=f.x),v.y<f.y&&(v.y=f.y),v.x+v.width>f.x+f.width&&(v.x=f.x+f.width-v.width),v.y+v.height>f.y+f.height&&(v.y=f.y+f.height-v.height));break}}if(u){console.info("画笔在大屏范围外");return}}await this.addPens(t,!0),this.active(t.filter(f=>!f.parentId)),this.render(),this.externalElements.focus()}randomCombineId(t,i,s){let a=null;t.type?t.anchors[0].connectTo||t.anchors[t.anchors.length-1].connectTo?a=[t.id,t.anchors[0].id,t.anchors[t.anchors.length-1].id]:a=[t.id]:i.length>1&&(a=[t.id]),randomId(t),i.length>1&&(a.length===1?this.randomIdObj[a[0]]=t.id:(this.randomIdObj[a[0]]=t.id,this.randomIdObj[a[1]]=t.anchors[0].id,this.randomIdObj[a[2]]=t.anchors[t.anchors.length-1].id)),t.parentId=s;const r=[];if(Array.isArray(t.children))for(const o of t.children){const n=i.find(l=>l.id===o);n&&r.push(this.randomCombineId(n,i,t.id).id)}return t.children=r,t}async addPens(t,i,s){if(this.beforeAddPens&&await this.beforeAddPens(t)!=!0)return[];const a=[];for(const r of t)this.beforeAddPen&&this.beforeAddPen(r)!=!0||(s&&(r.x=r.x*this.store.data.scale+this.store.data.origin.x,r.y=r.y*this.store.data.scale+this.store.data.origin.y,r.width=r.width*this.store.data.scale,r.height=r.height*this.store.data.scale),this.makePen(r),a.push(r));return this.render(),this.store.emitter.emit("add",a),i&&this.pushHistory({type:EditType.Add,pens:deepClone(a,!0)}),a}getInitPencilLine(t){const{data:i,options:s}=this.store,a=i.scale,r=i.lineWidth||1;return{id:t.penId,name:"line",x:t.x,y:t.y,type:PenType.Line,calculative:{canvas:this,pencil:!0,active:!0,worldAnchors:[t],lineWidth:r*a},fromArrow:i.fromArrow||s.fromArrow,toArrow:i.toArrow||s.toArrow,lineWidth:r}}createDrawingLine(t){this.inactive();const{data:i,options:s}=this.store,a=i.scale,r=i.lineWidth||1;return t.penId=s8(),{id:t.penId,name:"line",lineName:this.drawingLineName,x:t.x,y:t.y,type:PenType.Line,calculative:{canvas:this,active:!0,worldAnchors:[t],lineWidth:r*a},fromArrow:i.fromArrow||s.fromArrow,toArrow:i.toArrow||s.toArrow,lineWidth:r}}addRuleLine(t){const{x:i,y:s,scale:a,origin:r}=this.store.data,o=t.x+i,n=t.y+s;let l=t.x,c=t.y,h=0,d=0,f=0,u=0;if(o<=n&&o<20)l=-i,h=this.width,f=1,t.ctrlKey||(c=Math.round((c-r.y)/(a*10))*(a*10)+r.y);else if(n<o&&n<20)c=-s,d=this.height,u=1,t.ctrlKey||(l=Math.round((l-r.x)/(a*10))*(a*10)+r.x);else return;this.addPen({isRuleLine:!0,type:PenType.Line,name:"line",lineName:"line",x:l,y:c,width:h,height:d,color:this.store.options.ruleLineColor,anchors:[{x:0,y:0},{x:f,y:u}]})}clearRuleLines(){this.delete(this.ruleLines)}get ruleLines(){return this.store.data.pens.filter(t=>t.isRuleLine)}alignPenToGrid(t){var s;if(this.store.options.autoAlignGrid&&this.store.data.grid&&!t.type){const a=this.store.data.gridSize||this.store.options.gridSize,{origin:r,scale:o}=this.store.data,{x:n,y:l}=t,c={x:n,y:l},h=this.getPenRect(t),d=parseInt((h.x/a).toFixed()),f=parseInt((h.y/a).toFixed()),u=d*a,v=f*a;c.x=r.x+u*o,c.y=r.y+v*o,Object.assign(t,c),(s=t.onMove)==null||s.call(t,t),this.updatePenRect(t),this.calcActiveRect(),this.getSizeCPs()}}movedActivePens(t){let i=this.getAllFollowersByPens(this.store.active,!1);const s=deepClone(i,!0),a=this.store.data.gridSize||this.store.options.gridSize,{origin:r,scale:o}=this.store.data,n=this.store.options.autoAlignGrid&&(this.store.data.grid||this.store.options.grid);if(i.forEach(f=>{var w;const u=this.movingPens.findIndex(x=>x.id===f.id+movingSuffix);if(u<0)return;const{x:v,y}=this.movingPens[u],m={x:v,y};if(n&&!this.movingPens[u].type){const x=this.getPenRect(this.movingPens[u]),b=parseInt((x.x/a).toFixed()),T=parseInt((x.y/a).toFixed()),p=b*a,R=T*a;m.x=r.x+p*o,m.y=r.y+R*o}Object.assign(f,m),(w=f.onMove)==null||w.call(f,f),this.updatePenRect(f),this.updateLines(f),this.store.emitter.emit("updateLines",f),this.patchFlagsLines.forEach(x=>{x.type&&this.initLineRect(x)}),this.patchFlagsLines.clear(),f.calculative.x=f.x,f.calculative.y=f.y,f.calculative.initRect&&(f.calculative.initRect.x=f.calculative.x,f.calculative.initRect.y=f.calculative.y,f.calculative.initRect.ex=f.calculative.x+f.calculative.width,f.calculative.initRect.ey=f.calculative.y+f.calculative.height),calcChildrenInitRect(f),f.parentId&&this.parent.updateRectbyChild(f.calculative.worldRect,f,this.store.pens[f.parentId])}),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),!this.dock)return;const{xDock:l,yDock:c}=this.dock;let h;l&&(h=this.store.pens[l.penId]),!h&&c&&(h=this.store.pens[c.penId]);const d=deepClone(this.store.active,!0);if(t&&this.store.active.length===1&&(h==null?void 0:h.type)===1&&(l!=null&&l.anchorId||c!=null&&c.anchorId)){const f=getFromAnchor(h),u=getToAnchor(h);if(l!=null&&l.anchorId){const v=this.store.pens[this.store.active[0].id+movingSuffix].calculative.worldAnchors.find(y=>y.id===l.anchorId);v.x===f.x&&v.y===f.y?(s.push(deepClone(h,!0)),connectLine(this.store.active[0],v,h,f),d.push(deepClone(h,!0))):v.x===u.x&&v.y===u.y&&(s.push(deepClone(h,!0)),connectLine(this.store.active[0],v,h,u),d.push(deepClone(h,!0)))}else if(c!=null&&c.anchorId){const v=this.store.pens[this.store.active[0].id+movingSuffix].calculative.worldAnchors.find(y=>y.id===c.anchorId);v.x===f.x&&v.y===f.y?(s.push(deepClone(h,!0)),connectLine(this.store.active[0],v,h,f),d.push(deepClone(h,!0))):v.x===u.x&&v.y===u.y&&(s.push(deepClone(h,!0)),connectLine(this.store.active[0],v,h,u),d.push(deepClone(h,!0)))}}n&&(this.calcActiveRect(),this.getSizeCPs()),this.pushHistory({type:EditType.Update,pens:d,initPens:s}),this.store.emitter.emit("translatePens",d)}copyMovedPens(){this.copy(this.store.active.map((t,i)=>{const{x:s,y:a}=this.movingPens[i];return this.updateLines(t),{...t,x:s,y:a}})),this.pasteOffset=!1,this.paste()}initImageCanvas(t){t.some(i=>this.hasImage(i,!1))&&this.canvasImage.init(),t.some(i=>this.hasImage(i,!0))&&this.canvasImageBottom.init()}initTemplateCanvas(t){t.some(i=>i.canvasLayer===CanvasLayer.CanvasTemplate)&&this.canvasTemplate.init()}hasImage(t,i){var s;return t.image&&t.name!=="gif"?i?t.canvasLayer===CanvasLayer.CanvasImageBottom:t.canvasLayer===CanvasLayer.CanvasImage:(s=t.children)==null?void 0:s.some(a=>{const r=this.store.pens[a];return r&&this.hasImage(r,i)})}inactive(t){this.store.active.length&&(this.initTemplateCanvas(this.store.active),this.store.active.forEach(i=>{i.calculative.active=void 0,i.calculative.activeAnchor=void 0,i.calculative.hover=!1,setChildrenActive(i,!1)}),!t&&this.store.emitter.emit("inactive",this.store.active),this.store.active=[],this.activeRect=void 0,this.sizeCPs=void 0,this.store.activeAnchor=void 0,this.patchFlags=!0)}active(t,i=!0){if(this.store.active){i&&this.store.emitter.emit("inactive",this.store.active);for(const s of this.store.active)s.calculative.active=void 0,s.calculative.hover=!1,setChildrenActive(s,!1)}this.store.active=[],t.forEach(s=>{s.calculative.active=!0,setChildrenActive(s)}),this.store.active.push(...t),this.activeRect=void 0,this.calcActiveRect(),this.initTemplateCanvas(t),this.patchFlags=!0,i&&this.store.emitter.emit("active",this.store.active)}getSizeCPs(){this.sizeCPs=rectToPoints(this.activeRect);const t=[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],{x:i,y:s,width:a,height:r,rotate:o,center:n}=this.activeRect;t.forEach(l=>{const c={x:l.x*a+i,y:l.y*r+s};rotatePoint(c,o,n),this.sizeCPs.push(c)})}getSpecialAngle(t,i){let s=0;t.x-i.x!==0?(s=Math.atan((i.y-t.y)/(t.x-i.x))*180/Math.PI,t.x<i.x&&(s>0?s-=180:s+=180)):i.y>t.y?s=90:i.y<t.y&&(s=-90),s=Math.round(s/15)*15;let a=Math.sqrt((i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y));t.x=i.x+Math.cos(s/180*Math.PI)*a,t.y=i.y-Math.sin(s/180*Math.PI)*a}clearHover(){this.hoverType=HoverType.None,this.store.hover=null,this.store.hoverAnchor=null}inAnchor(t,i,s){var a;if(this.store.hoverAnchor=void 0,this.movingAnchor=void 0,!s||s.locked>LockState.DisableEdit)return HoverType.None;if(!(i.type&&i.calculative.active)&&this.store.options.disableAnchor||i.disableAnchor)return HoverType.None;if((this.mouseDown||this.drawingLine)&&i.name==="line"&&s.connectTo){const r=this.findOne(s.connectTo);if(r!=null&&r.calculative&&!(r!=null&&r.calculative.active)){i=r;const o=r.calculative.worldAnchors.find(n=>n.id===s.anchorId);o&&(s=o)}}if(s.twoWay===TwoWay.Disable&&i.name!=="line")return HoverType.None;if(i.name==="line"&&s.connectTo){let r=(a=this.findOne(s.connectTo))==null?void 0:a.anchors.find(o=>o.id===s.anchorId);if(r&&r.twoWay)return HoverType.None}if(this.drawingLine){if(s.twoWay===TwoWay.Out)return HoverType.None}else if(!(this.mouseDown&&this.hoverType===HoverType.LineAnchor)){if(s.twoWay===TwoWay.In)return HoverType.None}if(hitPoint(t,s,this.pointSize,s.penId?this.store.pens[s.penId]:void 0))return s!==this.store.hoverAnchor&&(this.patchFlags=!0),this.store.hoverAnchor=s,this.store.hover=i,i.type?s.connectTo&&!i.calculative.active&&(this.store.hover=this.store.pens[s.connectTo],this.store.hover)?(this.store.hoverAnchor=this.store.hover.calculative.worldAnchors.find(r=>r.id===s.anchorId),this.store.hoverAnchor?(this.externalElements.style.cursor="crosshair",HoverType.NodeAnchor):HoverType.None):(this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="pointer",HoverType.LineAnchor):(this.hotkeyType===HotkeyType.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="crosshair",HoverType.NodeAnchor);if(!this.mouseDown&&i.type){if(i.calculative.active&&s.prev&&hitPoint(t,s.prev,this.pointSize))return this.store.hoverAnchor=s,this.store.hover=i,this.externalElements.style.cursor="pointer",HoverType.LineAnchorPrev;if(i.calculative.active&&s.next&&hitPoint(t,s.next,this.pointSize))return this.store.hoverAnchor=s,this.store.hover=i,this.externalElements.style.cursor="pointer",HoverType.LineAnchorNext}return HoverType.None}resize(t,i){t=t||this.parentElement.clientWidth,i=i||this.parentElement.clientHeight,this.width=t,this.height=i,this.canvasRect={x:0,y:0,width:t,height:i},calcRightBottom(this.canvasRect),this.canvas.style.width=t+"px",this.canvas.style.height=i+"px",this.externalElements.style.width=t+"px",this.externalElements.style.height=i+"px",this.canvasTemplate.resize(t,i),this.canvasImage.resize(t,i),this.canvasImageBottom.resize(t,i),this.magnifierCanvas.resize(t,i),t=t*this.store.dpiRatio|0,i=i*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=i,this.offscreen.width=t,this.offscreen.height=i,this.clientRect=this.externalElements.getBoundingClientRect(),this.canvas.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle";for(const s of this.store.data.pens)s.isRuleLine&&(s.width?s.height||(s.width=this.width):s.height=this.height,this.updatePenRect(s)),calcInView(s);this.render()}clearCanvas(){this.activeRect=void 0,this.sizeCPs=void 0,this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.offscreen.width,this.offscreen.height),this.store.data.template||this.canvasTemplate.clear(),this.canvasImage.clear(),this.canvasImageBottom.clear()}async addPen(t,i,s,a){if(!(this.beforeAddPens&&await this.beforeAddPens([t])!=!0)&&!(this.beforeAddPen&&this.beforeAddPen(t)!=!0))return a&&(t.x=t.x*this.store.data.scale+this.store.data.origin.x,t.y=t.y*this.store.data.scale+this.store.data.origin.y,t.width=t.width*this.store.data.scale,t.height=t.height*this.store.data.scale),this.makePen(t),this.active([t]),this.render(),s&&this.store.emitter.emit("add",[t]),i&&this.pushHistory({type:EditType.Add,pens:[t]}),t}pushHistory(t){var a;if(this.store.data.locked)return;const{origin:i,scale:s}=this.store.data;t.origin=deepClone(i),t.scale=s,t.type!==EditType.Update&&t.pens&&t.pens.forEach(r=>{r.calculative&&(r.calculative.layer=this.store.data.pens.findIndex(o=>o.id===r.id))}),this.store.historyIndex<this.store.histories.length-1&&this.store.histories.splice(this.store.historyIndex+1,this.store.histories.length-this.store.historyIndex-1),(a=t.pens)==null||a.forEach(r=>{let o;if(t.initPens)for(const n of t.initPens)n.id===r.id&&(o=n);if(o)for(const n in r)o[n]==null&&(o[n]=void 0)}),this.store.histories.push(t),this.store.historyIndex=this.store.histories.length-1,this.store.emitter.emit("update",{previous:t.initPens,current:t.pens})}undo(){if(this.store.data.locked||this.store.historyIndex==null||this.store.historyIndex<0)return;const t=this.store.histories[this.store.historyIndex--];this.doEditAction(t,!0);let i=t.step;for(;i>1;){const s=this.store.histories[this.store.historyIndex--];this.doEditAction(s,!0),i--}(t.type==EditType.Add||t.type==EditType.Delete||t.type==EditType.Update)&&this.activeHistory()}redo(){if(this.store.data.locked||this.store.historyIndex==null||this.store.historyIndex>this.store.histories.length-2)return;const t=this.store.histories[++this.store.historyIndex];this.doEditAction(t,!1);let i=t.step;for(;i>1;){const s=this.store.histories[++this.store.historyIndex];this.doEditAction(s,!1),i--}(t.type==EditType.Add||t.type==EditType.Delete||t.type==EditType.Update)&&this.activeHistory()}activeHistory(){let t=this.store.histories[this.store.historyIndex+1];const i=[];if(t&&t.type===EditType.Update){t.pens.forEach(a=>{i.push(this.store.pens[a.id])}),this.active(i);return}let s=this.store.histories[this.store.historyIndex];s&&(s.type===EditType.Add||s.type===EditType.Delete)&&(s.pens.forEach(a=>{i.push(this.store.pens[a.id])}),this.active(i))}doEditAction(t,i){switch(this.inactive(),this.store.hoverAnchor=void 0,this.store.hover=void 0,t.type){case EditType.Add:t.pens.forEach(r=>{var l;const o=deepClone(r,!0),n=this.store.data.pens.findIndex(c=>c.id===o.id);n>-1&&((l=o.onDestroy)==null||l.call(o,this.store.pens[o.id]),this.store.data.pens.splice(n,1),this.store.pens[o.id]=void 0,o.calculative||(o.calculative={}),o.calculative.canvas=this,this.store.animates.delete(o),this.store.animateMap.delete(o))}),t.type=EditType.Delete;break;case EditType.Update:const s=i?t.initPens:t.pens,a=i?t.pens:t.initPens;s.forEach(r=>{const o=deepClone(r,!0),n=this.store.data.pens.findIndex(l=>l.id===o.id);if(n>-1){if(o.calculative=this.store.data.pens[n].calculative,this.store.data.pens[n].type&&this.store.data.pens[n].lastConnected){for(let c in this.store.data.pens[n].lastConnected)if(this.store.pens[c]){let h=deepClone(this.store.data.pens[n].lastConnected[c]);this.store.pens[c].connectedLines=h,o.anchors.forEach(d=>{h.forEach(f=>{d.id===f.lineAnchor&&(d.connectTo=c)})})}}this.store.data.pens[n]=o,this.store.pens[o.id]=o;for(const c in o)(typeof o[c]!="object"||c==="lineDash")&&(o.calculative[c]=o[c]);o.calculative.image=void 0;const l=this.getPenRect(o,t.origin,t.scale);if(this.setPenRect(o,l,!1),this.updateLines(o,!0),o.calculative.canvas.parent.isCombine(o)){let c=a.find(h=>h.id===o.id);inheritanceProps.forEach(h=>{o[h]!==c[h]&&this.parent.setValue({id:o.id,[h]:o[h]},{render:!0,doEvent:!1})})}}});break;case EditType.Delete:t.pens.reverse().forEach(r=>{var n,l;const o=deepClone(r,!0);if(o.calculative||(o.calculative={}),this.store.data.pens.splice(((n=o.calculative)==null?void 0:n.layer)!==-1?(l=o.calculative)==null?void 0:l.layer:this.store.data.pens.length,0,o),this.store.pens[o.id]=o,o.type&&o.lastConnected)for(let c in o.lastConnected)this.store.pens[c]&&(this.store.pens[c].connectedLines=o.lastConnected[c]);o.calculative.canvas=this}),t.pens.reverse().forEach(r=>{const o=this.store.pens[r.id],n=this.getPenRect(o,t.origin,t.scale);this.setPenRect(o,n,!1),o.calculative.image=void 0,o.calculative.backgroundImage=void 0,o.calculative.strokeImage=void 0,this.loadImage(o)}),t.type=EditType.Add;break;case EditType.Replace:{const r=i?t.initPens:t.pens;(i?t.pens:t.initPens).forEach(n=>{var h;const l=deepClone(n,!0);if(this.store.data.pens.findIndex(d=>d.id===l.id)>-1){(h=l.onDestroy)==null||h.call(l,this.store.data.pens.find(f=>f.id===l.id));const d=this.store.data.pens.findIndex(f=>f.id===l.id);this.store.data.pens.splice(d,1),this.store.pens[l.id]=void 0,l.calculative||(l.calculative={}),l.calculative.canvas=this,this.store.animates.delete(l),this.store.animateMap.delete(l)}}),r.reverse().forEach(n=>{var c,h;const l=deepClone(n,!0);if(l.calculative||(l.calculative={}),this.store.data.pens.splice(((c=l.calculative)==null?void 0:c.layer)!==-1?(h=l.calculative)==null?void 0:h.layer:this.store.data.pens.length,0,l),this.store.pens[l.id]=l,l.type&&l.lastConnected)for(let d in l.lastConnected)this.store.pens[d]&&(this.store.pens[d].connectedLines=l.lastConnected[d]);l.calculative.canvas=this}),r.reverse().forEach(n=>{const l=this.store.data.pens.find(h=>h.id===n.id),c=this.getPenRect(l,t.origin,t.scale);this.setPenRect(l,c,!1),l.calculative.image=void 0,l.calculative.backgroundImage=void 0,l.calculative.strokeImage=void 0,this.loadImage(l)}),t.type=EditType.Replace;break}}if(t.type===EditType.Update){let s=[...t.pens,...t.initPens];this.initImageCanvas(s),this.initTemplateCanvas(s)}else this.initImageCanvas(t.pens),this.initTemplateCanvas(t.pens);this.parent.onSizeUpdate(),this.render(),this.store.emitter.emit(i?"undo":"redo",t)}makePen(t){var a;if(t.id||(t.id=s8()),Math.abs(this.store.lastScale-this.store.data.scale)<1e-4&&this.store.sameTemplate&&this.store.templatePens[t.id]&&t.canvasLayer===CanvasLayer.CanvasTemplate){t=this.store.templatePens[t.id],this.store.data.pens.push(t),this.updatePenRect(t);return}if(t.copyIndex?(this.store.data.pens.splice(t.copyIndex+1,0,t),delete t.copyIndex):this.store.data.pens.push(t),this.store.pens[t.id]=t,t.path){!t.pathId&&(t.pathId=s8());const r=this.store.data.paths;!r[t.pathId]&&(r[t.pathId]=t.path),t.path=void 0}t.lineWidth==null&&(t.lineWidth=1);const{fontSize:i,lineHeight:s}=this.store.options;t.fontSize?t.fontSize<0&&(t.fontSize=0):t.fontSize=i>=0?i:12,t.lineHeight||(t.lineHeight=s),t.image&&t.name!=="gif"&&t.canvasLayer===void 0&&(t.isBottom?t.canvasLayer=CanvasLayer.CanvasImageBottom:t.canvasLayer=CanvasLayer.CanvasImage,delete t.isBottom),t.template&&(t.canvasLayer=CanvasLayer.CanvasTemplate),t.calculative={canvas:this,singleton:(a=t.calculative)==null?void 0:a.singleton},(t.video||t.audio)&&(t.calculative.onended=r=>{this.nextAnimate(r)});for(const r in t)(typeof t[r]!="object"||r==="lineDash")&&(t.calculative[r]=t[r]);if(t.calculative.image=void 0,t.calculative.backgroundImage=void 0,t.calculative.strokeImage=void 0,!t.anchors&&globalStore.anchors[t.name]&&(t.anchors||(t.anchors=[]),globalStore.anchors[t.name](t)),!t.anchors){const r=deepClone(this.store.options.defaultAnchors);r.forEach((o,n)=>{o.id=`${n}`,o.penId=t.id}),t.anchors=r}this.updatePenRect(t),!t.anchors&&t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(r=>calcRelativePoint(r,t.calculative.worldRect))),!t.rotate&&(t.rotate=0),this.loadImage(t),this.parent.penNetwork(t)}drawline(t){var i;this.drawingLine&&((i=this[this.drawingLineName])==null||i.call(this,this.store,this.drawingLine,t),this.store.path2dMap.set(this.drawingLine,globalStore.path2dDraws.line(this.drawingLine)),this.patchFlags=!0)}initLineRect(t){var r;if(!t)return;if(!((r=t.calculative.worldAnchors)!=null&&r.length)){this._del([t]);return}if(!isFinite(t.x)||!isFinite(t.x)||t.x==null||t.y==null)return;const i=getLineRect(t);t.parentId||Object.assign(t,i);const{fontSize:s,lineHeight:a}=this.store.options;t.fontSize||(t.fontSize=s>=0?s:12,t.calculative.fontSize=t.fontSize*this.store.data.scale),t.lineHeight||(t.lineHeight=a,t.calculative.lineHeight=t.lineHeight),calcCenter(i),t.calculative.worldRect=i,calcPadding(t,i),calcTextRect(t),calcInView(t),t.calculative&&(t.calculative.gradientAnimatePath=void 0),this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)),t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(o=>calcRelativePoint(o,t.calculative.worldRect)))}drawingPencil(){lockedError(this.store),this.pencil=!0,this.externalElements.style.cursor="crosshair"}stopPencil(){this.pencil=!1,this.pencilLine=void 0,this.externalElements.style.cursor="default"}async finishDrawline(t){if(!this.drawingLine)return;const i=getFromAnchor(this.drawingLine);let s=getToAnchor(this.drawingLine);if(s.isTemp&&(this.drawingLine.calculative.worldAnchors.pop(),s=getToAnchor(this.drawingLine)),!t&&(!s.connectTo&&this.drawingLine.calculative.worldAnchors.pop(),getFromAnchor(this.drawingLine)===this.drawingLine.calculative.activeAnchor)){this.drawingLine=void 0,this.render();return}if(!i.connectTo||!s.connectTo){if(this.store.options.disableEmptyLine){i.connectTo&&(this.store.pens[i.connectTo].connectedLines=this.store.pens[i.connectTo].connectedLines.filter(o=>o.lineId!==this.drawingLine.id)),this.drawingLine=void 0,this.render();return}}else if(this.store.options.disableRepeatLine&&this.store.data.pens.find(n=>{if(n.type){const l=getFromAnchor(n),c=getToAnchor(n);return samePoint(l,i)&&samePoint(c,s)}})){this.drawingLine=void 0,this.render();return}const a=getLineRect(this.drawingLine);Object.assign(this.drawingLine,a),this.drawingLine.calculative.worldRect=a,this.drawingLine.calculative.activeAnchor=getToAnchor(this.drawingLine),this.store.activeAnchor=this.drawingLine.calculative.activeAnchor,(!this.beforeAddPens||await this.beforeAddPens([this.drawingLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.drawingLine))&&(this.initLineRect(this.drawingLine),this.store.data.pens.push(this.drawingLine),this.store.pens[this.drawingLine.id]=this.drawingLine,this.store.emitter.emit("add",[this.drawingLine]),this.active([this.drawingLine]),this.pushHistory({type:EditType.Add,pens:deepClone([this.drawingLine],!0)})),this.store.path2dMap.set(this.drawingLine,globalStore.path2dDraws[this.drawingLine.name](this.drawingLine)),this.drawingLine=void 0,this.drawingLineName=void 0,this.render()}async finishPencil(){if(this.pencilLine){const t=simplify(this.pencilLine.calculative.worldAnchors,10,0,this.pencilLine.calculative.worldAnchors.length-1);let i=getFromAnchor(this.pencilLine);t.unshift({id:i.id,penId:i.penId,x:i.x,y:i.y}),i=getToAnchor(this.pencilLine),t.push({id:i.id,penId:i.penId,x:i.x,y:i.y}),this.pencilLine.calculative.worldAnchors=smoothLine(t),this.pencilLine.calculative.worldAnchors.length>1&&(this.pencilLine.calculative.pencil=!1,this.store.path2dMap.set(this.pencilLine,globalStore.path2dDraws[this.pencilLine.name](this.pencilLine)),(!this.beforeAddPens||await this.beforeAddPens([this.pencilLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.pencilLine))&&(this.initLineRect(this.pencilLine),this.store.data.pens.push(this.pencilLine),this.store.pens[this.pencilLine.id]=this.pencilLine,this.store.emitter.emit("add",[this.pencilLine]),this.active([this.pencilLine]),this.pushHistory({type:EditType.Add,pens:deepClone([this.pencilLine],!0)}))),this.pencilLine=void 0,this.render()}}firefoxLoadSvg(t){const i=new Image,s=new XMLHttpRequest;s.open("GET",t.image,!0),s.onload=()=>{const o=new DOMParser().parseFromString(s.responseText,"text/xml").getElementsByTagName("svg")[0],{width:n,height:l}=t.calculative.worldRect;o.setAttribute("width",`${n}px`),o.setAttribute("height",`${l}px`);const h="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(new XMLSerializer().serializeToString(o))));i.src=h,i.onload=()=>{t.calculative.img=i,t.calculative.imgNaturalWidth=i.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=i.naturalHeight||t.iconHeight,globalStore.htmlElements[t.image]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}},s.send()}loadImage(t){if(t.image!==t.calculative.image||!t.calculative.img){if(t.calculative.img=void 0,t.image)if(globalStore.htmlElements[t.image]){const i=globalStore.htmlElements[t.image];t.calculative.img=i,t.calculative.imgNaturalWidth=i.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=i.naturalHeight||t.iconHeight,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}else if(navigator.userAgent.includes("Firefox")&&t.image.endsWith(".svg"))this.firefoxLoadSvg(t);else{const i=new Image;i.crossOrigin=t.crossOrigin==="undefined"?void 0:t.crossOrigin||"anonymous",i.src=t.image,this.store.options.cdn&&!(t.image.startsWith("http")||t.image.startsWith("//")||t.image.startsWith("data:image"))&&(i.src=this.store.options.cdn+t.image),i.onload=()=>{t.calculative.img=i,t.calculative.imgNaturalWidth=i.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=i.naturalHeight||t.iconHeight,globalStore.htmlElements[t.image]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}}t.calculative.image=t.image}if(t.backgroundImage!==t.calculative.backgroundImage){if(t.calculative.backgroundImg=void 0,t.backgroundImage)if(globalStore.htmlElements[t.backgroundImage]){const i=globalStore.htmlElements[t.backgroundImage];t.calculative.backgroundImg=i}else{const i=new Image;i.crossOrigin="anonymous",i.src=t.backgroundImage,this.store.options.cdn&&!(t.backgroundImage.startsWith("http")||t.backgroundImage.startsWith("//")||t.backgroundImage.startsWith("data:image"))&&(i.src=this.store.options.cdn+t.backgroundImage),i.onload=()=>{t.calculative.backgroundImg=i,globalStore.htmlElements[t.backgroundImage]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&this.templateImageLoaded()}}t.calculative.backgroundImage=t.backgroundImage}if(t.strokeImage!==t.calculative.strokeImage){if(t.calculative.strokeImg=void 0,t.strokeImage)if(globalStore.htmlElements[t.strokeImage]){const i=globalStore.htmlElements[t.strokeImage];t.calculative.strokeImg=i}else{const i=new Image;i.crossOrigin="anonymous",i.src=t.strokeImage,this.store.options.cdn&&!(t.strokeImage.startsWith("http")||t.strokeImage.startsWith("//")||t.strokeImage.startsWith("data:image"))&&(i.src=this.store.options.cdn+t.strokeImage),i.onload=()=>{t.calculative.strokeImg=i,globalStore.htmlElements[t.strokeImage]=i,this.imageLoaded(),t.canvasLayer===CanvasLayer.CanvasTemplate&&t.name!=="gif"&&this.templateImageLoaded()}}t.calculative.strokeImage=t.strokeImage}}imageLoaded(){this.imageTimer&&clearTimeout(this.imageTimer),this.imageTimer=setTimeout(()=>{this.canvasImage.init(),this.canvasImageBottom.init(),this.render()},100)}templateImageLoaded(){this.templateImageTimer&&clearTimeout(this.templateImageTimer),this.templateImageTimer=setTimeout(()=>{this.canvasTemplate.init(),this.render()},100)}setCalculativeByScale(t){const i=this.store.data.scale;t.calculative.lineWidth=t.lineWidth*i,t.calculative.fontSize=t.fontSize*i,t.fontSize<1&&t.fontSize>0&&(t.calculative.fontSize=t.fontSize*t.calculative.worldRect.height),t.calculative.iconSize=t.iconSize*i,t.calculative.iconWidth=t.iconWidth*i,t.calculative.iconHeight=t.iconHeight*i,t.calculative.iconLeft=t.iconLeft<1&&t.iconLeft>-1?t.iconLeft:t.iconLeft*i,t.calculative.iconTop=t.iconTop<1&&t.iconTop>-1?t.iconTop:t.iconTop*i,t.calculative.textWidth=t.textWidth<1&&t.textWidth>-1?t.textWidth:t.textWidth*i,t.calculative.textHeight=t.textHeight<1&&t.textHeight>-1?t.textHeight:t.textHeight*i,t.calculative.textLeft=t.textLeft<1&&t.textLeft>-1?t.textLeft*t.calculative.worldRect.width:t.textLeft*i,t.calculative.textTop=t.textTop<1&&t.textTop>-1?t.textTop*t.calculative.worldRect.height:t.textTop*i,t.type===PenType.Line&&t.borderWidth&&(t.calculative.borderWidth=t.borderWidth*i)}updatePenRect(t,{worldRectIsReady:i,playingAnimate:s}={}){i?calcPenRect(t):calcWorldRects(t),s||this.setCalculativeByScale(t),calcWorldAnchors(t),calcIconRect(this.store.pens,t),calcTextRect(t),calcInView(t),globalStore.path2dDraws[t.name]&&this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)),t.calculative.patchFlags=!0,this.patchFlags=!0,t.children&&t.children.forEach(a=>{const r=this.store.pens[a];r&&this.updatePenRect(r,{worldRectIsReady:!1})}),t.type&&this.initLineRect(t),t.calculative.gradientTimer&&clearTimeout(t.calculative.gradientTimer),t.calculative.gradientTimer=setTimeout(()=>{t.calculative.lineGradient&&(t.calculative.lineGradient=null),t.calculative.gradient&&(t.calculative.gradient=null),t.calculative.radialGradient&&(t.calculative.radialGradient=null),this.patchFlags=!0,t.calculative.gradientTimer=void 0},50)}initGlobalStyle(){const t={},i={},s={};themeKeys.forEach(r=>{var o;if(this.store.options[r]!==void 0&&(t[r]=this.store.options[r]),this.store.data[r]!==void 0&&(i[r]=this.store.data[r]),this.store.data.theme){const n=(o=this.store.theme[this.store.data.theme])==null?void 0:o[r];n!==void 0&&(s[r]=n)}}),this.store.styles={};const a=le5leTheme.getThemeObj(this.store.data.theme);Object.assign(this.store.styles,t,i,s,a)}translate(t=0,i=0){if(this.store.data.x+=t*this.store.data.scale,this.store.data.y+=i*this.store.data.scale,this.store.data.x=Math.round(this.store.data.x),this.store.data.y=Math.round(this.store.data.y),this.store.options.padding){let s=formatPadding(this.store.options.padding);const a=this.store.data.width||this.store.options.width,r=this.store.data.height||this.store.options.height;this.width<(a+s[1]+s[3])*this.store.data.scale&&(this.store.data.x+this.store.data.origin.x>s[3]*this.store.data.scale&&(this.store.data.x=s[3]*this.store.data.scale-this.store.data.origin.x),this.store.data.x+this.store.data.origin.x+a*this.store.data.scale<this.width-s[1]*this.store.data.scale&&(this.store.data.x=this.width-s[1]*this.store.data.scale-(this.store.data.origin.x+a*this.store.data.scale))),this.height<(r+s[0]+s[2])*this.store.data.scale&&(this.store.data.y+this.store.data.origin.y>s[0]*this.store.data.scale&&(this.store.data.y=s[0]*this.store.data.scale-this.store.data.origin.y),this.store.data.y+this.store.data.origin.y+r*this.store.data.scale<this.height-s[2]*this.store.data.scale&&(this.store.data.y=this.height-s[2]*this.store.data.scale-(this.store.data.origin.y+r*this.store.data.scale)))}this.store.data.asyncTranslate?(clearTimeout(this.transTimeout),this.transTimeout=setTimeout(()=>{this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()},300)):(this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()),this.store.emitter.emit("translate",{x:this.store.data.x,y:this.store.data.y}),this.tooltip.translate(t,i),this.scroll&&this.scroll.isShow&&this.scroll.translate(t,i),this.onMovePens()}onMovePens(){var i;const t=this.parent.map;t&&t.isShow&&t.setView();for(const s of this.store.data.pens)calcInView(s),(i=s.onMove)==null||i.call(s,s),s.isRuleLine&&(s.width?s.height||(s.x=-this.store.data.x):s.y=-this.store.data.y,this.updatePenRect(s))}scale(t,i={x:0,y:0}){var n;const s=this.store.data.minScale||this.store.options.minScale,a=this.store.data.maxScale||this.store.options.maxScale;if(!(t>=s&&t<=a))return;this.calibrateMouse(i);const r=t/this.store.data.scale;this.store.data.scale=t,this.store.data.center=i,(n=this.store.clipboard)!=null&&n.pos&&scalePoint(this.store.clipboard.pos,r,i),scalePoint(this.store.data.origin,r,i),this.store.data.pens.forEach(l=>{if(!l.parentId){if(scalePen(l,r,i),l.onScale&&l.onScale(l),l.isRuleLine){const c=1/r,h=l.calculative.worldRect.center;l.width?l.height||scalePen(l,c,h):scalePen(l,c,h)}this.updatePenRect(l,{worldRectIsReady:!0}),this.execPenResize(l)}}),this.onMovePens(),this.calcActiveRect(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init();const o=this.parent.map;o&&o.isShow&&o.setView(),this.render(),this.store.emitter.emit("scale",this.store.data.scale)}templateScale(t,i={x:0,y:0}){const{minScale:s,maxScale:a}=this.store.options;if(!(t>=s&&t<=a))return;const r=t/this.store.data.scale;this.store.data.scale=t,this.store.data.center={x:0,y:0},this.store.data.origin={x:0,y:0},this.store.data.pens.forEach(o=>{if(!o.parentId){if(scalePen(o,r,i),o.onScale&&o.onScale(o),o.isRuleLine){const n=r>1?1:1/r/r,l=o.calculative.worldRect.center;o.width?o.height||scalePen(o,n,l):scalePen(o,n,l)}this.execPenResize(o)}}),this.calcActiveRect()}rotatePens(t){this.initPens||(this.initPens=deepClone(this.getAllByPens(this.store.active))),this.activeRect.rotate=calcRotate(t,this.activeRect.center),this.activeRect.rotate%90<10&&(this.activeRect.rotate-=this.activeRect.rotate%90),this.activeRect.rotate%90>80&&(this.activeRect.rotate+=90-this.activeRect.rotate%90),this.store.active.length===1&&(this.lastRotate=this.store.active[0].rotate||0);const i=this.activeRect.rotate-this.lastRotate;for(const s of this.store.active){if(s.parentId)return;this.rotatePen(s,i,this.activeRect),s.onRotate&&s.onRotate(s),this.updateLines(s)}this.lastRotate=this.activeRect.rotate,this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("rotatePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.getAllByPens(this.store.active)),initPens:this.initPens}),this.initPens=void 0},200)}resizePens(t){if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),!this.initActiveRect){this.initActiveRect=deepClone(this.activeRect);return}const i={x:this.mouseDown.x,y:this.mouseDown.y},s={x:t.x,y:t.y};let a=s.x-i.x,r=s.y-i.y;const o=deepClone(this.initActiveRect);if(resizeRect(o,a,r,this.resizeIndex),calcCenter(o),!this.store.options.disableDock){this.clearDock();const u=this.customResizeDock||calcResizeDock;this.dock=u(this.store,o,this.store.active,this.resizeIndex);const{xDock:v,yDock:y}=this.dock;if(v){a+=v.step;const m=this.store.pens[v.penId];m.calculative.isDock=!0}if(y){r+=y.step;const m=this.store.pens[y.penId];m.calculative.isDock=!0}}const n=this.activeRect.width,l=this.activeRect.height;let c=a-this.lastOffsetX,h=r-this.lastOffsetY;if(this.lastOffsetX=a,this.lastOffsetY=r,(t.ctrlKey||this.initPens.length===1&&this.initPens[0].ratio)&&(h=([1,3].includes(this.resizeIndex)?-1:1)*(c*l)/n),this.activeRect.ratio=this.initPens[0].ratio,resizeRect(this.activeRect,c,h,this.resizeIndex),this.store.options.strictScope){const u=this.store.data.width||this.store.options.width,v=this.store.data.height||this.store.options.height;if(u&&v){let y={x:this.store.data.origin.x,y:this.store.data.origin.y,width:u*this.store.data.scale,height:v*this.store.data.scale};this.activeRect.x<y.x&&(this.activeRect.width=this.activeRect.width-(y.x-this.activeRect.x),this.activeRect.x=y.x),this.activeRect.y<y.y&&(this.activeRect.height=this.activeRect.height-(y.y-this.activeRect.y),this.activeRect.y=y.y),this.activeRect.x+this.activeRect.width>y.x+y.width&&(this.activeRect.width=this.activeRect.width-(this.activeRect.x+this.activeRect.width-(y.x+y.width)),this.activeRect.x=y.x+y.width-this.activeRect.width,this.activeRect.ex=this.activeRect.x+this.activeRect.width),this.activeRect.y+this.activeRect.height>y.y+y.height&&(this.activeRect.height=this.activeRect.height-(this.activeRect.y+this.activeRect.height-(y.y+y.height)),this.activeRect.y=y.y+y.height-this.activeRect.height,this.activeRect.ey=this.activeRect.y+this.activeRect.height)}}calcCenter(this.activeRect);const d=this.activeRect.width/n,f=this.activeRect.height/l;this.store.active.forEach((u,v)=>{u.calculative.worldRect.x=this.activeInitPos[v].x*this.activeRect.width+this.activeRect.x,u.calculative.worldRect.y=this.activeInitPos[v].y*this.activeRect.height+this.activeRect.y,u.calculative.worldRect.width*=d,u.calculative.iconWidth&&(u.calculative.iconWidth*=d),u.calculative.worldRect.height*=f,u.calculative.iconHeight&&(u.calculative.iconHeight*=f),calcRightBottom(u.calculative.worldRect),calcCenter(u.calculative.worldRect),this.updatePenRect(u,{worldRectIsReady:!0}),this.execPenResize(u),this.updateLines(u)}),this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("resizePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}movePens(t){var n,l;if(!this.activeRect||this.store.data.locked)return;if(!this.initActiveRect){this.initActiveRect=deepClone(this.activeRect);return}if(!this.store.options.moveConnectedLine&&!this.canMoveLine&&this.store.active.length===1&&((n=this.store.active[0].anchors[0])!=null&&n.connectTo||(l=this.store.active[0].anchors[this.store.active[0].anchors.length-1])!=null&&l.connectTo)||(this.movingPens||(this.initMovingPens(),this.store.active.forEach(c=>{setHover(c,!1)}),this.store.hover=void 0),!this.mouseDown))return;let i=t.x-this.mouseDown.x,s=t.y-this.mouseDown.y;t.shiftKey&&!t.ctrlKey&&(s=0),t.ctrlKey&&(i=0);const a=deepClone(this.initActiveRect);translateRect(a,i,s);let r=!1;if(this.store.options.strictScope){const c=this.store.data.width||this.store.options.width,h=this.store.data.height||this.store.options.height;if(c&&h){let d={x:this.store.data.origin.x,y:this.store.data.origin.y,width:c*this.store.data.scale,height:h*this.store.data.scale};a.x<d.x&&(a.x=d.x,r=!0),a.y<d.y&&(a.y=d.y,r=!0),a.x+a.width>d.x+d.width&&(a.x=d.x+d.width-a.width,r=!0),a.y+a.height>d.y+d.height&&(a.y=d.y+d.height-a.height,r=!0)}}const o={x:a.x-this.activeRect.x,y:a.y-this.activeRect.y};if(!this.store.options.disableDock&&!r){this.clearDock();const c=this.customMoveDock||calcMoveDock;this.dock=c(this.store,a,this.movingPens,o);const{xDock:h,yDock:d}=this.dock;let f;h&&(o.x+=h.step,f=this.store.pens[h.penId],f.calculative.isDock=!0),d&&(o.y+=d.step,f=this.store.pens[d.penId],f.calculative.isDock=!0)}this.translatePens(this.movingPens,o.x,o.y,!0)}changeIdsByMoving(t,i){t.id+=movingSuffix,t.parentId&&i.find(s=>s.id===t.parentId)&&(t.parentId+=movingSuffix),t.children&&(t.children=t.children.map(s=>s+movingSuffix)),t.connectedLines&&(t.connectedLines=t.connectedLines.map(s=>(i.find(a=>a.id===s.lineId)&&(s.lineId+=movingSuffix),s))),t.type&&t.calculative.worldAnchors&&(t.calculative.worldAnchors=t.calculative.worldAnchors.map(s=>(s.connectTo&&i.find(a=>a.id===s.connectTo)&&(s.connectTo+=movingSuffix),s)))}initMovingPens(){var s,a;if(!this.store.options.moveConnectedLine&&!this.canMoveLine)for(let r=0;r<this.store.active.length;r++){const o=this.store.active[r];((s=o.anchors[0])!=null&&s.connectTo||(a=o.anchors[o.anchors.length-1])!=null&&a.connectTo)&&(this.store.active.splice(r,1),o.calculative.active=void 0,--r)}this.movingPens=deepClone(this.store.active,!0),this.movingPens=this.getAllFollowersByPens(this.movingPens);const t=this.getAllByPens(this.movingPens),i=deepClone(t,!0);t.forEach(r=>{this.changeIdsByMoving(r,i),this.store.pens[r.id]=r,r.calculative.canvas=this;const o={globalAlpha:.5};r.lineWidth===0&&(o.lineWidth=1),(r.name.endsWith("Dom")||isDomShapes.includes(r.name)||this.store.options.domShapes.includes(r.name)||r.image)&&(o.name="rectangle",o.onDestroy=void 0),this.updateValue(r,o),r.calculative.image=void 0})}moveLineAnchor(t,i){var n,l,c,h,d;if(!this.activeRect||this.store.data.locked)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),(n=this.store.activeAnchor)!=null&&n.connectTo){const f=this.store.pens[this.store.activeAnchor.connectTo];disconnectLine(f,getAnchor(f,this.store.activeAnchor.anchorId),this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor)}let s=(l=this.store.activeAnchor)==null?void 0:l.id,a=(h=(c=this.store.pens[this.store.activeAnchor.penId])==null?void 0:c.connectedLines)==null?void 0:h.filter(f=>f.anchor===s);a&&a.length>0&&a.forEach(f=>{const u=this.store.pens[f.lineId];disconnectLine(this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor,u,getAnchor(u,f.lineAnchor))});const r=this.store.active[0];getFromAnchor(r);const o=getToAnchor(r);if(r.lineName==="polyline"&&!i.shiftKey)translatePolylineAnchor(r,this.store.activeAnchor,t);else{let f=0,u=0;if(r.lineName==="line"){let v=r.calculative.worldAnchors.findIndex(m=>m.id===this.store.activeAnchor.id);v===0&&(v=2);let y=r.calculative.worldAnchors[v-1];if(i.ctrlKey&&i.shiftKey){let m=deepClone(t);this.getSpecialAngle(m,y),f=m.x-this.store.activeAnchor.x,u=m.y-this.store.activeAnchor.y}else if(!i.ctrlKey&&i.shiftKey){let m={x:t.x,y:y.y};f=m.x-this.store.activeAnchor.x,u=m.y-this.store.activeAnchor.y}else if(i.ctrlKey&&!i.shiftKey){let m={x:y.x,y:t.y};f=m.x-this.store.activeAnchor.x,u=m.y-this.store.activeAnchor.y}else f=t.x-this.store.activeAnchor.x,u=t.y-this.store.activeAnchor.y}else!i.ctrlKey&&i.shiftKey?(f=t.x-this.store.activeAnchor.x,u=0):i.ctrlKey&&!i.shiftKey?(f=0,u=t.y-this.store.activeAnchor.y):(f=t.x-this.store.activeAnchor.x,u=t.y-this.store.activeAnchor.y);translatePoint(this.store.activeAnchor,f,u),this.store.hover&&this.store.hoverAnchor&&this.store.hoverAnchor.penId!==this.store.activeAnchor.penId&&(this.store.hoverAnchor.type===PointType.Line?(f=t.x-this.store.activeAnchor.x,u=t.y-this.store.activeAnchor.y,getDistance(this.store.activeAnchor,this.store.hoverAnchor,this.store)):(f=this.store.hoverAnchor.x-this.store.activeAnchor.x,u=this.store.hoverAnchor.y-this.store.activeAnchor.y),translatePoint(this.store.activeAnchor,f,u),o.prev=void 0,r.lineName!=="polyline"&&((d=this[r.lineName])==null||d.call(this,this.store,r)))}this.patchFlagsLines.add(r),this.store.path2dMap.set(r,globalStore.path2dDraws[r.name](r)),this.render(),this.store.active[0].calculative&&(this.store.active[0].calculative.gradientAnimatePath=void 0),this.store.emitter.emit("moveLineAnchor",{pen:this.store.active[0],anchor:this.store.activeAnchor}),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},500)}moveLineAnchorPrev(t){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),this.store.activeAnchor.prev.x=t.x,this.store.activeAnchor.prev.y=t.y,this.store.activeAnchor.next){if(!this.store.activeAnchor.prevNextType)this.store.activeAnchor.next.x=t.x,this.store.activeAnchor.next.y=t.y,rotatePoint(this.store.activeAnchor.next,180,this.store.activeAnchor);else if(this.store.activeAnchor.prevNextType===PrevNextType.Bilateral&&this.prevAnchor){const s=calcRotate(t,this.store.activeAnchor),a=calcRotate(this.prevAnchor,this.store.activeAnchor);this.store.activeAnchor.next.x=this.nextAnchor.x,this.store.activeAnchor.next.y=this.nextAnchor.y,rotatePoint(this.store.activeAnchor.next,s-a,this.store.activeAnchor)}}const i=this.store.active[0];this.patchFlagsLines.add(i),this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}moveLineAnchorNext(t){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=deepClone(this.store.active,!0)),this.store.activeAnchor.next.x=t.x,this.store.activeAnchor.next.y=t.y,this.store.activeAnchor.prev){if(!this.store.activeAnchor.prevNextType)this.store.activeAnchor.prev.x=t.x,this.store.activeAnchor.prev.y=t.y,rotatePoint(this.store.activeAnchor.prev,180,this.store.activeAnchor);else if(this.store.activeAnchor.prevNextType===PrevNextType.Bilateral&&this.nextAnchor){const s=calcRotate(t,this.store.activeAnchor),a=calcRotate(this.nextAnchor,this.store.activeAnchor);this.store.activeAnchor.prev.x=this.prevAnchor.x,this.store.activeAnchor.prev.y=this.prevAnchor.y,rotatePoint(this.store.activeAnchor.prev,s-a,this.store.activeAnchor)}}const i=this.store.active[0];this.patchFlagsLines.add(i),this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:EditType.Update,pens:deepClone(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}async setAnchor(t){var a;const i=[deepClone(this.store.hover,!0)],s=this.store.hover;if(this.store.hoverAnchor){if(this.beforeRemoveAnchor&&!await this.beforeRemoveAnchor(s,this.store.hoverAnchor))return;s.type===PenType.Line&&((a=s.calculative.worldAnchors)==null?void 0:a.length)<=2?this.delete([s]):(removePenAnchor(s,this.store.hoverAnchor),s.type===PenType.Line&&this.initLineRect(s)),this.store.hoverAnchor=void 0,this.store.activeAnchor=void 0,this.externalElements.style.cursor="default"}else if(s){if(this.beforeAddAnchor&&!await this.beforeAddAnchor(s,this.store.pointAt))return;if(s.type===PenType.Line){this.store.activeAnchor=addLineAnchor(s,this.store.pointAt,this.store.pointAtIndex),this.initLineRect(s);const r={x:t.x,y:t.y};this.getHover(r)}else{const r={id:s8(),x:t.x,y:t.y};this.store.activeAnchor=pushPenAnchor(s,r)}}this.hotkeyType=HotkeyType.None,this.render(),s&&this.pushHistory({type:EditType.Update,pens:[deepClone(s,!0)],initPens:i})}checkDisconnect(t,i){if(t.id.indexOf(movingSuffix)>0){const s=t.id;t=this.store.pens[s.replace(movingSuffix,"")]}t.anchors.forEach(s=>{if(s.connectTo&&!i.find(a=>a.id===s.connectTo||a.id===s.connectTo+movingSuffix)){const a=this.store.pens[s.connectTo];if(!a||a.type)return;disconnectLine(a,getAnchor(a,s.anchorId),t,s)}})}translatePens(t=this.store.active,i,s,a){if(!t||!t.length||t.some(l=>{if(l.locked>=LockState.DisableMove)return!0}))return;const o=!a&&deepClone(t,!0);this.activeRect&&translateRect(this.activeRect,i,s);const n=this.getAllByPens(t);t.forEach(l=>{var c,h;if(!(l.locked>=LockState.DisableMove)){if(l.type===PenType.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine||l.isRuleLine)return;translateLine(l,i,s),this.checkDisconnect(l,n),this.store.path2dMap.set(l,globalStore.path2dDraws[l.name](l)),a||(this.initLineRect(l),(c=l.connectedLines)==null||c.forEach(d=>{const f=this.store.pens[d.lineId];this.initLineRect(f)}))}else translateRect(l.calculative.worldRect,i,s),this.updatePenRect(l,{worldRectIsReady:!0}),l.calculative.x=l.x,l.calculative.y=l.y,l.calculative.initRect&&(l.calculative.initRect.x=l.calculative.x,l.calculative.initRect.y=l.calculative.y,l.calculative.initRect.ex=l.calculative.x+l.calculative.width,l.calculative.initRect.ey=l.calculative.y+l.calculative.height);this.updateLines(l),(h=l.onMove)==null||h.call(l,l)}}),this.activeRect&&this.getSizeCPs(),this.render(),this.tooltip.translate(i,s),a||(this.pushHistory({type:EditType.Update,pens:deepClone(t,!0),initPens:o}),this.initImageCanvas(t),this.initTemplateCanvas(t),this.store.emitter.emit("translatePens",t)),this.store.emitter.emit("translatingPens",t)}templateTranslatePens(t=this.store.active,i,s){if(!t||!t.length)return;const a=this.getAllByPens(t);t.forEach(r=>{var o;if(r.type===PenType.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)return;translateLine(r,i,s),this.checkDisconnect(r,a),this.store.path2dMap.set(r,globalStore.path2dDraws[r.name](r))}else translateRect(r.calculative.worldRect,i,s),this.updatePenRect(r,{worldRectIsReady:!0}),r.calculative.x=r.x,r.calculative.y=r.y,r.calculative.initRect&&(r.calculative.initRect.x=r.calculative.x,r.calculative.initRect.y=r.calculative.y,r.calculative.initRect.ex=r.calculative.x+r.calculative.width,r.calculative.initRect.ey=r.calculative.y+r.calculative.height);(o=r.onMove)==null||o.call(r,r)})}calcAutoAnchor(t,i,s,a){const r=getFromAnchor(t),o=getToAnchor(t),n=nearestAnchor(s,i===r?o:r);n&&(i.x=n.x,i.y=n.y,i.prev=void 0,i.next=void 0,a?a.anchor=n.id:connectLine(s,n,t,i),this[t.lineName]&&this[t.lineName](this.store,t),this.store.path2dMap.set(t,globalStore.path2dDraws.line(t)),this.initLineRect(t))}restoreNodeAnimate(t){var i,s;if(t.calculative.initRect){if(t.keepAnimateState)for(const a in t)t.calculative[a]!==void 0&&a!=="x"&&a!=="y"&&a!=="width"&&a!=="height"&&a!=="initRect"&&(typeof t[a]!="object"||a==="lineDash")&&(a==="fontSize"||a==="lineWidth"?t[a]=t.calculative[a]/t.calculative.canvas.store.data.scale:t[a]=t.calculative[a]);else{const a=t.calculative.initRect.rotate-t.calculative.rotate;for(const o in t)o!=="x"&&o!=="y"&&o!=="width"&&o!=="height"&&o!=="initRect"&&o!=="rotate"&&(typeof t[o]!="object"||o==="lineDash")&&(t.calculative[o]=t[o]);(i=t.children)!=null&&i.length?a&&rotatePen(t,a,t.calculative.worldRect):t.calculative.rotate=t.rotate;const r=deepClone(this.store.animateMap.get(t));r&&(r.id=t.id,this.parent.setValue(r,{doEvent:!1,render:!0,history:!1})),t.calculative.worldRect=t.calculative.initRect}this.updatePenRect(t,{worldRectIsReady:!0}),this.updateLines(t),t.image&&t.name!=="gif"&&(this.canvasImage.init(),this.canvasImageBottom.init()),t.calculative.text!==t.text&&(t.calculative.text=t.text,calcTextLines(t)),(s=this.store.active)!=null&&s.length&&this.calcActiveRect(),t.calculative.initRect=void 0}}updateLines(t,i){var s;(s=t.children)==null||s.forEach(a=>{const r=this.store.pens[a];r&&this.updateLines(r,i)}),t.connectedLines&&t.connectedLines.forEach((a,r)=>{const o=this.store.pens[a.lineId];if(!o||o.calculative.active)return;const n=getAnchor(o,a.lineAnchor);if(!n)return;if(!n.connectTo){t.connectedLines.splice(r,1);return}if(o.autoFrom){const f=getFromAnchor(o);f.id===n.id&&this.calcAutoAnchor(o,f,t,a)}if(o.autoTo){const f=getToAnchor(o);f.id===n.id&&this.calcAutoAnchor(o,f,t,a)}const l=getAnchor(t,a.anchor);if(!l)return;let c=t.rotate;t.flipX&&(c*=-1),t.flipY&&(c*=-1);let h=n.distance*this.store.data.scale*Math.cos((c+l.rotate)/180*Math.PI)||0,d=n.distance*this.store.data.scale*Math.sin((c+l.rotate)/180*Math.PI)||0;if(t.flipX&&(h=-h),t.flipY&&(d=-d),translatePoint(n,l.x-n.x+h,l.y-n.y+d),this.store.options.autoPolyline&&!this.autoPolylineFlag&&o.autoPolyline!==!1&&o.lineName==="polyline"){let f=getFromAnchor(o),u=getToAnchor(o),v=!1;f.id===n.id?(f=n,v=!0):u.id===n.id&&(u=n,v=!0),v&&(o.calculative.worldAnchors=[f,u],o.calculative.activeAnchor=f,this.polyline(this.store,o,u),this.initLineRect(o))}this.store.path2dMap.set(o,globalStore.path2dDraws[o.name](o)),this.patchFlagsLines.add(o),o.calculative.gradientSmooth&&(o.calculative.gradientAnimatePath=getGradientAnimatePath(o)),i&&getLineLength(o)})}calcActiveRect(){const t=this.store.active.filter(i=>(!i.locked||i.locked<LockState.DisableMove)&&i.visible!=!1);if(t.length)t.length===1?(this.activeRect=deepClone(t[0].calculative.worldRect),this.activeRect.rotate=t[0].calculative.rotate||0,calcCenter(this.activeRect)):(this.activeRect=getRect$1(t),this.activeRect.rotate=0);else return;this.lastRotate=0,this.getSizeCPs()}rotatePen(t,i,s){t.type?(t.calculative.worldAnchors.forEach(a=>{rotatePoint(a,i,s.center)}),this.initLineRect(t),calcPenRect(t)):(t.calculative.rotate?t.calculative.rotate+=i:t.calculative.rotate=i,rotatePoint(t.calculative.worldRect.center,i,s.center),t.parentId?(t.calculative.worldRect.x=t.calculative.worldRect.center.x-t.calculative.worldRect.width/2,t.calculative.worldRect.y=t.calculative.worldRect.center.y-t.calculative.worldRect.height/2,t.x=(t.calculative.worldRect.x-s.x)/s.width,t.y=(t.calculative.worldRect.y-s.y)/s.height):(t.x=t.calculative.worldRect.center.x-t.width/2,t.y=t.calculative.worldRect.center.y-t.height/2),t.rotate=t.calculative.rotate,this.updatePenRect(t),t.children&&t.children.forEach(a=>{const r=this.store.pens[a];this.rotatePen(r,i,t.calculative.worldRect)}))}nextAnimate(t){if(!t)return;this.store.emitter.emit("animateEnd",t);let i;t.nextAnimate&&(i=this.store.data.pens.filter(s=>s.id===t.nextAnimate||s.tags&&s.tags.indexOf(t.nextAnimate)>-1)),i&&(i.forEach(s=>{var a,r,o,n,l;if(s.calculative.pause){const c=Date.now()-s.calculative.pause;s.calculative.pause=void 0,s.calculative.frameStart+=c,s.calculative.frameEnd+=c}else if(s.name==="video")s.calculative.media.currentTime=0,(a=s.calculative.media)==null||a.play(),(r=s.onStartVideo)==null||r.call(s,s);else if(s.type||(o=s.frames)!=null&&o.length||s.animations&&s.animations.length){if(s.type){if((l=s.animations)!=null&&l.length){const c=deepClone(s.animations[0]);delete c.name,c.currentAnimation=0,this.parent.setValue({id:s.id,...c},{doEvent:!1,history:!1})}}else{if(!s.frames&&s.animations&&s.animations.length){let c=(n=s.animations)==null?void 0:n.findIndex(f=>f.autoPlay),h=c===-1?0:c;const d=deepClone(s.animations[h]);delete d.name,d.currentAnimation=h,!s.type&&d.frames&&(d.showDuration=this.parent.calcAnimateDuration(d)),this.parent.setValue({id:s.id,...d},{doEvent:!1,history:!1})}this.store.animateMap.set(s,this.getFrameProps(s))}this.store.animates.add(s)}}),this.animate())}getFrameProps(t){let i={};return t.frames&&t.frames.forEach(s=>{for(let a in s)!["duration","x","y","width","height","rotate"].includes(a)&&!i[a]&&(i[a]=t[a])}),i}animate(){this.animateRendering||requestAnimationFrame(()=>{const t=Date.now();if(t-this.lastAnimateRender<this.store.options.animateInterval){this.store.animates.size>0&&this.animate();return}this.lastAnimateRender=t,this.animateRendering=!0;const i=[];let s=!1;for(const a of this.store.animates)if(!a.calculative.pause){if(a.calculative.active&&!a.type&&!this.movingPens&&(s=!0),!a.type)setNodeAnimate(a,t)?a.calculative.patchFlags&&(calcCenter(a.calculative.worldRect),this.updatePenRect(a,{worldRectIsReady:!0,playingAnimate:!0})):(requestAnimationFrame(()=>{this.restoreNodeAnimate(a)}),i.push(a),this.nextAnimate(a)),this.updateLines(a,!0);else if(!setLineAnimate(a,t)){if(a.keepAnimateState){for(const r in a)a.calculative[r]!==void 0&&r!=="length"&&(typeof a[r]!="object"||r==="lineDash")&&(r==="lineWidth"?a[r]=a.calculative[r]/a.calculative.canvas.store.data.scale:a[r]=a.calculative[r]);calcPenRect(a)}else for(const r in a)(typeof a[r]!="object"||r==="lineDash")&&(r==="lineWidth"?a.calculative[r]=a[r]*a.calculative.canvas.store.data.scale:a.calculative[r]=a[r]);i.push(a),this.nextAnimate(a)}this.patchFlags=!0}s&&this.calcActiveRect(),i.forEach(a=>{this.store.animates.delete(a)}),this.render(!1),this.animateRendering=!1,this.animate()})}get clipboardName(){return"meta2d-clipboard"}async copy(t,i=!0){const s=s8(),{origin:a,scale:r}=this.store.data;this.store.clipboard=void 0,localStorage.removeItem(this.clipboardName),sessionStorage.setItem("page",s);let o=this.getAllByPens(deepClone(t||this.store.active,!0));o.forEach(l=>{l.copyIndex=this.store.data.pens.findIndex(c=>c.id===l.id),l.pathId&&(l.path=this.store.data.paths[l.pathId])}),o.sort((l,c)=>l.copyIndex-c.copyIndex);const n={meta2d:!0,pens:o,origin:deepClone(a),scale:r,page:s,initRect:deepClone(this.activeRect),offset:10,mousePos:deepClone(this.mousePos)};if(navigator.clipboard&&!this.store.options.disableClipboard&&!navigator.userAgent.includes("Firefox"))try{await navigator.clipboard.writeText(JSON.stringify(n))}catch{localStorage.setItem(this.clipboardName,JSON.stringify(n))}else localStorage.setItem(this.clipboardName,JSON.stringify(n));i&&this.store.emitter.emit("copy",n.pens)}cut(t){this.copy(t,!1),this.delete(t),this.store.emitter.emit("cut",t)}async paste(){var l,c;let t,i;if(navigator.clipboard&&!this.store.options.disableClipboard&&!navigator.userAgent.includes("Firefox"))try{t=await((l=navigator.clipboard)==null?void 0:l.readText())}catch{t=localStorage.getItem(this.clipboardName)}else t=localStorage.getItem(this.clipboardName);if(t){try{i=JSON.parse(t)}catch(h){console.warn("剪切板数据不是json",h.message);return}if(!i||!i.meta2d)return}else return;if(this.beforeAddPens&&await this.beforeAddPens(i.pens)!=!0)return;let s,a;this.store.clipboard&&(s=this.store.clipboard.offset+10,a=this.store.clipboard.pos),this.store.clipboard=deepClone(i);const r=sessionStorage.getItem("page"),o=this.store.data.scale;if(this.store.clipboard.mousePos&&(Math.abs(this.store.clipboard.mousePos.x-this.mousePos.x)>100*o||Math.abs(this.store.clipboard.mousePos.y-this.mousePos.y)>100*o)){let h=-this.store.clipboard.initRect.width/this.store.clipboard.scale/10/o,d=-this.store.clipboard.initRect.height/this.store.clipboard.scale/10/o,f=(o-this.store.clipboard.scale)*this.store.clipboard.initRect.width/2+h,u=(o-this.store.clipboard.scale)*this.store.clipboard.initRect.height/2+d;this.store.clipboard.pens.length>1&&(f=(o-1)*this.store.clipboard.initRect.width/this.store.clipboard.scale/2,u=(o-1)*this.store.clipboard.initRect.height/this.store.clipboard.scale/2),this.store.clipboard.pos={x:this.mousePos.x-f,y:this.mousePos.y-u},this.store.clipboard.offset=0}else r!==i.page?(this.store.clipboard.pos={x:this.mousePos.x,y:this.mousePos.y},this.store.clipboard.offset=0):this.pasteOffset?(s&&(this.store.clipboard.offset=s),a&&(this.store.clipboard.pos=a)):(this.store.clipboard.offset=0,this.pasteOffset=!0);(c=this.keyOptions)!=null&&c.F||this.store.clipboard.pens.forEach(h=>{delete h.copyIndex});const n=this.store.clipboard.pens.filter(h=>!h.parentId);for(const h of n)this.pastePen(h,void 0);sessionStorage.setItem("page",i.page),this.active(n),this.pushHistory({type:EditType.Add,pens:this.store.clipboard.pens}),this.render(),this.store.emitter.emit("add",this.store.clipboard.pens),this.store.emitter.emit("paste",this.store.clipboard.pens)}getAllByPens(t){const i=[];for(const s of t)i.push(...deepClone(getAllChildren(s,this.store),!0));return i.concat(t)}getAllFollowersByPens(t,i=!0){const s=t;for(const a of t){let r=getAllFollowers(a,this.store);i&&(r=deepClone(r,!0));for(const o of r)s.find(n=>n.id===o.id)||s.push(o)}return s}setFollowers(t=this.store.active){if(t)if(t.length<2)t[0].followers=[];else{let i=t.map(a=>a.id);i.pop();const s=t[t.length-1];s.followers?i.forEach(a=>{s.followers.includes(a)||s.followers.push(a)}):s.followers=i}}changeLineAnchors(t,i,s){if(Array.isArray(i.connectedLines))for(let a=0;a<i.connectedLines.length;a++){const{lineId:r}=i.connectedLines[a],o=s.find(n=>n.id===r);if(o){const n=o.anchors[0],l=o.anchors[o.anchors.length-1];n.connectTo===t&&(n.connectTo=i.id),l.connectTo===t&&(l.connectTo=i.id)}else i.connectedLines.splice(a,1),a--}}changeNodeConnectedLine(t,i,s){var n;const a=i.anchors[0],r=i.anchors[i.anchors.length-1],o=[a,r];for(const l of o){const c=l.connectTo;if(c){const h=s.find(d=>d.id===c);h?(n=h.connectedLines)==null||n.forEach(d=>{d.lineId===t&&(d.lineId=i.id,d.lineAnchor=l.id)}):(l.connectTo=void 0,l.prev&&(l.prev.connectTo=void 0),l.next&&(l.next.connectTo=void 0))}}}async delete(t=this.store.active,i=!1,s=!0){if(!t||!t.length||this.beforeRemovePens&&await this.beforeRemovePens(t)!=!0||(i||(t=t.filter(r=>!r.locked)),!t||!t.length))return;const a=[];if(this._del(t,a,i),this.initImageCanvas(a),this.initTemplateCanvas(a),this.inactive(),this.clearHover(),this.render(),s){if(a.length===0)return;this.pushHistory({type:EditType.Delete,pens:a})}this.store.emitter.emit("delete",t)}_del(t,i,s){t&&t.forEach(a=>{if(a.type&&(a.lastConnected={}),a.parentId)if(this.getLockedParent(a)){console.warn("父节点锁定");return}else{const o=getParent(a),n=o.children.indexOf(a.id);o.children.splice(n,1),i&&this.getDelPens(a,i),this.delForce(a)}else{if(!s&&a.locked)return;i&&this.getDelPens(a,i),this.delForce(a)}})}getDelPens(t,i){if(!t)return;if(this.store.data.pens.findIndex(a=>a.id===t.id)>-1){const a=this.store.pens[t.id];a&&a.calculative&&(a.calculative.active=void 0),i.push(a)}t.children&&t.children.forEach(a=>{this.getDelPens(this.store.pens[a],i)})}getLockedParent(t){if(!t.parentId)return!1;const i=getParent(t);if(i.locked)return i;this.getLockedParent(i)}delForce(t){var s;if(!t)return;const i=this.store.data.pens.findIndex(a=>a.id===t.id);i>-1&&(this.delConnectedLines(this.store.data.pens[i]),this.store.data.pens.splice(i,1),this.store.pens[t.id]=void 0,delete this.store.pens[t.id],t.pathId&&delete this.store.data.paths[t.pathId]),this.store.animates.delete(t),this.store.animateMap.delete(t),t.children&&t.children.forEach(a=>{this.delForce(this.store.pens[a])}),(s=t.onDestroy)==null||s.call(t,t)}delConnectedLines(t){var i;if(t.connectedLines)for(let s=0;s<t.connectedLines.length;s++){const{lineId:a,lineAnchor:r}=t.connectedLines[s],o=this.store.pens[a];if(o){let n=o.anchors.find(l=>l.id===r);(n==null?void 0:n.connectTo)===t.id&&(n.connectTo=void 0,n.anchorId=void 0,n.prev&&(n.prev.connectTo=void 0),n.next&&(n.next.connectTo=void 0)),n=getAnchor(o,r),n&&(n.connectTo=void 0,n.anchorId=void 0,n.prev&&(n.prev.connectTo=void 0),n.next&&(n.next.connectTo=void 0))}}t.type&&((i=t.calculative.worldAnchors)==null||i.forEach((s,a)=>{var o;if(!s.connectTo)return;const r=this.store.pens[s.connectTo];r&&((o=r.calculative.worldAnchors)==null||o.forEach(n=>{disconnectLine(r,n,t,s)}))}))}convertSpecialCharacter(t){var i={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return t.replace(/&(lt|gt|nbsp|amp|quot);/gi,function(s,a){return i[a]})}createInput(){this.inputParent.classList.add("meta2d-input"),this.inputDiv.classList.add("input-div"),this.inputParent.appendChild(this.inputDiv),this.dropdown.onmouseleave=()=>{this.store.hover=null},this.inputParent.appendChild(this.dropdown),this.externalElements.appendChild(this.inputParent),this.inputParent.onmousedown=this.stopPropagation,this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.contentEditable="false",this.dropdown.onmousedown=this.stopPropagation;let t;for(let i=0;i<document.styleSheets.length;i++)document.styleSheets[i].title==="le5le.com"&&(t=document.styleSheets[i]);if(!t){const i=document.createElement("style");i.title="le5le.com",document.head.appendChild(i),t=i.sheet,t.insertRule(".meta2d-input{display:none;position:absolute;outline:none;align-items: center;}"),t.insertRule(".meta2d-input textarea{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;left:0;top:0}"),t.insertRule(".meta2d-input .right{width:10px;height:10px;flex-shrink:0;border-top: 1px solid;border-right: 1px solid;margin-right: 5px;transition: all .3s cubic-bezier(.645,.045,.355,1);position:absolute;right:1px;}"),t.insertRule(".meta2d-input ul{position:absolute;top:100%;margin-top:4px; width:calc(100% + 10px);min-height:30px;border-radius: 2px;box-shadow: 0 2px 8px #00000026;list-style-type: none;background-color: #fff;padding: 4px 0;max-height: 105px;overflow-y: auto;}"),t.insertRule(".meta2d-input ul li{padding: 5px 12px;line-height: 22px;white-space: nowrap;cursor: pointer;}"),t.insertRule(".meta2d-input ul li:hover{background: #eeeeee;}"),t.insertRule(".input-div::-webkit-scrollbar {display:none}"),t.insertRule(".input-div{scrollbar-width: none;}"),t.insertRule(".meta2d-input .input-div{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;width: 100%;left:0;top:0;display:flex;text-align: center;justify-content: center;flex-direction: column;}"),t.insertRule(".input-div div{}")}this.inputDiv.onfocus=i=>{if(navigator.userAgent.includes("Firefox")){if(!i.target.innerText){let s=this.inputDiv.offsetWidth/2;window.getComputedStyle(this.inputDiv,null).textAlign!=="center"&&(s=0),this.inputDiv.innerHTML=`<br style="margin-left:${s}px;margin-top:4px;" />`}}else if(i.target.innerText)this.inputDiv.style.paddingTop="";else{let s=window.getComputedStyle(this.inputDiv,null);s.justifyContent==="center"&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(s.lineHeight)/2}px`)}},this.inputDiv.onblur=()=>{setTimeout(()=>{this.hideInput()},300)},this.inputDiv.oninput=i=>{const s=this.store.pens[this.inputDiv.dataset.penId];if(s&&s.inputType==="number"){const a=i.target.innerText,r=a.replace(/[^0-9]/g,"");a!==r&&(i.preventDefault(),i.target.innerText=r)}if(navigator.userAgent.includes("Firefox")){if(!i.target.innerText.trim()){let a=this.inputDiv.offsetWidth/2;window.getComputedStyle(this.inputDiv,null).textAlign!=="center"&&(a=0),this.inputDiv.innerHTML=`<br style="margin-left:${a}px;margin-top:4px;" />`}}else if(i.target.innerText)this.inputDiv.style.paddingTop="";else{let a=window.getComputedStyle(this.inputDiv,null);a.justifyContent==="center"&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(a.lineHeight)/2}px`)}this.store.emitter.emit("input",s)},this.inputDiv.onclick=i=>{i.stopPropagation();const s=this.store.pens[this.inputDiv.dataset.penId];this.dropdown.style.display==="block"?this.dropdown.style.display="none":s!=null&&s.dropdownList&&this.store.data.locked&&(this.dropdown.style.display="block"),this.store.emitter.emit("clickInput",s)},this.inputDiv.onkeyup=i=>{this.setDropdownList(!0);const s=this.store.pens[this.inputDiv.dataset.penId];this.store.emitter.emit("input",{pen:s,text:i.key}),i.stopPropagation()},this.inputDiv.onkeydown=i=>{i.stopPropagation()},this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.onwheel=i=>{i.stopPropagation()},this.inputDiv.onpaste=i=>{i.preventDefault();let s="";i.clipboardData&&i.clipboardData.getData&&(s=i.clipboardData.getData("text/plain")),document.execCommand("insertHTML",!1,s)}}clearDropdownList(){if(this.dropdown.hasChildNodes())for(let t=0;t<this.dropdown.childNodes.length;t++)this.dropdown.childNodes[t].remove(),--t}dropdownAppendOption(t,i){const s=document.createElement("li");s.onwheel=this.stopPropagation,s.innerText=t,s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.title=t,s.style.zoom=this.store.data.scale,s.onmousedown=this.stopPropagation,s.dataset.i=i+"",s.onclick=this.selectDropdown;const a=this.store.pens[this.inputDiv.dataset.penId];s.onmouseenter=()=>{s.style.background=a.dropdownHoverBackground||this.store.styles.activeBg||"#eee",s.style.color=a.dropdownHoverColor||"#bdc7db"},s.onmouseleave=()=>{s.style.background=a.dropdownBackground||this.store.styles.popContentBg||"#fff",s.style.color=a.dropdownColor||"#bdc7db"},this.dropdown.appendChild(s)}find(t){return this.store.data.pens.filter(i=>i.id==t||i.tags&&i.tags.indexOf(t)>-1)}findOne(t){return this.store.data.pens.find(i=>i.id==t||i.tags&&i.tags.indexOf(t)>-1)}changePenId(t,i){var a,r,o,n,l,c,h;if(t===i)return;const s=this.store.pens[t];if(s&&!this.store.pens[i]){if(s.id=i,this.store.pens[i]=this.store.pens[t],(a=s.onChangeId)==null||a.call(s,s,t,i),delete this.store.pens[t],s.parentId){const d=this.store.pens[s.parentId],f=(r=d.children)==null?void 0:r.findIndex(u=>u===t);f!==-1&&((o=d.children)==null||o.splice(f,1,i))}(n=s.children)==null||n.forEach(d=>{const f=this.store.pens[d];f.parentId=i}),s.formId&&s.followers.forEach(d=>{const f=this.store.pens[d];f.formId=i}),s.type===PenType.Line?this.changeNodeConnectedLine(t,s,this.store.data.pens):(this.changeLineAnchors(t,s,this.store.data.pens),(l=s.connectedLines)==null||l.forEach(({lineId:d})=>{const f=this.store.pens[d];calcWorldAnchors(f)})),(c=s.anchors)==null||c.forEach(d=>d.penId=i),(h=s.calculative.worldAnchors)==null||h.forEach(d=>d.penId=i)}}updateValue(t,i){var v,y;const s=this.getPenRect(t),a=t.name;Object.assign(t,i);const r=a!==t.name;i.newId&&this.changePenId(t.id,i.newId);let o=!1,n=!1,l=!1,c=!1,h=!1,d=!1,f,u=!1;for(const m in i)m.indexOf(".")===-1?(m==="rotate"?t.disableRotate?t.rotate=t.calculative.rotate||0:f=t.calculative.rotate||0:m==="canvasLayer"||m==="isBottom"||m==="showChild"?d=!0:m==="image"&&(u=!0),(typeof t[m]!="object"||m==="lineDash")&&(!t.disableRotate||m!=="rotate")&&(t.calculative[m]=i[m]),needCalcTextRectProps.includes(m)&&(n=!0),["name","borderRadius","lineSmooth","close"].includes(m)&&(o=!0),needSetPenProps.includes(m)&&(h=!0),needPatchFlagsPenRectProps.includes(m)&&(l=!0),needCalcIconRectProps.includes(m)&&(c=!0),t.image&&t.name!=="gif"&&["globalAlpha","flipY","flipX","x","y","width","height","iconWidth","iconHeight","imageRatio","iconLeft","iconTop","iconAlign","rotate","visible"].includes(m)&&(u=!0)):(delete t[m],setter(t,m,i[m])),m.split(".")[0]==="anchors"&&calcWorldAnchors(t);if(this.setCalculativeByScale(t),r&&((v=t.onDestroy)==null||v.call(t,t),clearLifeCycle(t)),h){const m={x:i.x??s.x,y:i.y??s.y,width:i.width??s.width,height:i.height??s.height};this.setPenRect(t,m,!1),this.updateLines(t,!0),this.store.active&&this.store.active.length&&t.id===this.store.active[0].id&&this.calcActiveRect()}else l?this.updatePenRect(t):(n&&calcTextRect(t),c&&calcIconRect(this.store.pens,t),o&&globalStore.path2dDraws[t.name]&&this.store.path2dMap.set(t,globalStore.path2dDraws[t.name](t)));if(f!==void 0){const m=t.calculative.rotate;t.calculative.rotate=f,this.rotatePen(t,m-f,t.calculative.worldRect)}(i.image||i.backgroundImage||i.strokeImage)&&(t.calculative.image=void 0,t.calculative.backgroundImage=void 0,t.calculative.strokeImage=void 0,this.loadImage(t)),i.lineGradientColors&&(t.calculative.lineGradient=void 0,t.calculative.gradientColorStop=void 0),i.gradientColors&&(t.calculative.gradient=void 0,t.calculative.radialGradient=void 0),i.gradientRadius&&(t.calculative.gradient=void 0,t.calculative.radialGradient=void 0),i.animateLineWidth&&(t.calculative.gradientAnimatePath=void 0),i.gradientSmooth&&(t.calculative.gradientAnimatePath=void 0),d?(this.canvasImage.init(),this.canvasImageBottom.init()):u&&(t.canvasLayer===void 0&&(t.canvasLayer=CanvasLayer.CanvasImageBottom,t.calculative.canvasLayer=CanvasLayer.CanvasImageBottom),t.canvasLayer===CanvasLayer.CanvasImageBottom?this.canvasImageBottom.init():t.canvasLayer===CanvasLayer.CanvasImage&&this.canvasImage.init()),(i.canvasLayer!==void 0||t.canvasLayer===CanvasLayer.CanvasTemplate)&&this.initTemplateCanvas([t]),i.zIndex!==void 0&&(y=t.calculative.singleton)!=null&&y.div&&setElemPosition(t,t.calculative.singleton.div)}execPenResize(t){var i,s;(i=t.onResize)==null||i.call(t,t),(s=t.children)==null||s.forEach(a=>{const r=this.store.pens[a];r&&this.execPenResize(r)})}setPenRect(t,i,s=!0){if(t.parentId)Object.assign(t,i);else{const{origin:a,scale:r}=this.store.data;t.x=a.x+i.x*r,t.y=a.y+i.y*r,t.width=i.width*r,t.height=i.height*r}this.updatePenRect(t),this.execPenResize(t),s&&this.render()}getPenRect(t,i=this.store.data.origin,s=this.store.data.scale){if(t)return t.parentId?{x:t.x,y:t.y,width:t.width,height:t.height}:{x:(t.x-i.x)/s,y:(t.y-i.y)/s,width:t.width/s,height:t.height/s}}toPng(t=2,i,s=!1,a){const r=getRect$1(this.store.data.pens),o=this.store.data.scale;if(!isFinite(r.width))throw new Error("can not to png, because width is not finite");const n=deepClone(r),l=this.store.data,c=s&&this.store.bkImg;let h=!1,d=!1;if(c){if(r.x+=l.x,r.y+=l.y,calcRightBottom(r),rectInRect(r,this.canvasRect,!0))Object.assign(r,this.canvasRect);else{const p=getRectOfPoints([...rectToPoints(r),...rectToPoints(this.canvasRect)]);Object.assign(r,p)}h=r.x===0,d=r.y===0}const f=this.store.data.width||this.store.options.width,u=this.store.data.height||this.store.options.height;let v=!1;f&&u&&!this.store.data.component&&(v=!0),v&&(r.x=this.store.data.origin.x,r.y=this.store.data.origin.y,r.width=f*this.store.data.scale,r.height=u*this.store.data.scale);const y=deepClone(r),m=formatPadding(t);r.x-=m[3]*o,r.y-=m[0]*o,r.width+=(m[3]+m[1])*o,r.height+=(m[0]+m[2])*o;const w=(a||1920)/r.width;r.width*=w,r.height*=w,calcRightBottom(r);const x=document.createElement("canvas");if(x.width=r.width,x.height=r.height,x.width>32767||x.height>32767||!navigator.userAgent.includes("Firefox")&&x.height*x.width>268435456||navigator.userAgent.includes("Firefox")&&x.height*x.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const b=x.getContext("2d");b.textBaseline="middle",b.scale(w,w);const T=this.store.data.background||this.store.styles.background;if(T&&v&&(b.save(),b.fillStyle=T,b.fillRect(0,0,y.width+(m[1]+m[3])*o,y.height+(m[0]+m[2])*o),b.restore()),c)if(v)b.drawImage(this.store.bkImg,m[3]*o||0,m[0]*o||0,y.width,y.height);else{const p=r.x<0?-r.x:0,R=r.y<0?-r.y:0;b.drawImage(this.store.bkImg,p,R,this.canvasRect.width,this.canvasRect.height)}if(T&&!v)if(c){const p=r.x<0?-r.x:0,R=r.y<0?-r.y:0;b.save(),b.fillStyle=T,b.fillRect(p,R,this.canvasRect.width,this.canvasRect.height),b.restore()}else b.save(),b.fillStyle=T,b.fillRect(0,0,n.width+(m[3]+m[1])*o,n.height+(m[0]+m[2])*o),b.restore();c?v?b.translate(-r.x,-r.y):b.translate((h?l.x:-n.x)+m[3]*o||0,(d?l.y:-n.y)+m[0]*o||0):b.translate(-r.x,-r.y);for(const p of this.store.data.pens){if(!isShowChild(p,this.store)||p.visible==!1||p.name==="combine"&&!p.draw)continue;const{active:R}=p.calculative;p.calculative.active=!1,p.calculative.img?renderPenRaw$1(b,p):renderPen(b,p,!0),p.calculative.active=R}if(i){x.toBlob(i);return}return x.toDataURL()}activeToPng(t=2,i){return this.pensToPng(this.store.active,t,i)}pensToPng(t=this.store.active,i=2,s){if(t.length===0)return;const a=this.getAllByPens(t);let r=a.map(u=>u.id);const o=getRect$1(a);if(!isFinite(o.width))throw new Error("can not to png, because width is not finite");const n=deepClone(o),l=formatPadding(i);o.x-=l[3],o.y-=l[0],o.width+=l[3]+l[1],o.height+=l[0]+l[2],calcRightBottom(o);const c=(s||o.width)/o.width;o.width*=c,o.height*=c;const h=document.createElement("canvas");if(h.width=o.width,h.height=o.height,h.width>32767||h.height>32767||!navigator.userAgent.includes("Firefox")&&h.height*h.width>268435456||navigator.userAgent.includes("Firefox")&&h.height*h.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const d=h.getContext("2d");d.textBaseline="middle",d.scale(c,c);const f=this.store.data.background||this.store.styles.background;f&&(d.save(),d.fillStyle=f,d.fillRect(0,0,n.width+(l[3]+l[1]),n.height+(l[0]+l[2])),d.restore()),d.translate(-n.x+l[3],-n.y+l[0]);for(const u of this.store.data.pens)if(r.includes(u.id)){if(!isShowChild(u,this.store)||u.visible==!1||u.name==="combine"&&!u.draw)continue;const{active:v}=u.calculative;u.calculative.active=!1,u.calculative.img?renderPenRaw$1(d,u):renderPen(d,u),u.calculative.active=v}return h.toDataURL()}toggleAnchorMode(){var t;if(this.hotkeyType)this.hotkeyType===HotkeyType.AddAnchor&&(this.hotkeyType=HotkeyType.None,this.store.hoverAnchor?this.externalElements.style.cursor="vertical-text":this.store.hover&&(this.externalElements.style.cursor="move"));else{if(this.store.options.disableAnchor||(t=this.store.hover)!=null&&t.disableAnchor)return;this.hotkeyType=HotkeyType.AddAnchor,this.store.hover&&(this.externalElements.style.cursor="pointer")}this.patchFlags=!0}addAnchorHand(){if(this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){const t=[deepClone(this.store.active[0],!0)];this.store.activeAnchor.prev?this.store.activeAnchor.next||(this.store.activeAnchor.next={...this.store.activeAnchor.prev},rotatePoint(this.store.activeAnchor.next,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.next||(this.store.activeAnchor.next={penId:this.store.activeAnchor.penId,x:this.store.activeAnchor.x+50,y:this.store.activeAnchor.y}),this.store.activeAnchor.prev={...this.store.activeAnchor.next},rotatePoint(this.store.activeAnchor.prev,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:EditType.Update,pens:[deepClone(this.store.active[0],!0)],initPens:t})}}removeAnchorHand(){if(this.store.activeAnchor&&this.store.active&&this.store.active.length===1&&this.store.active[0].type){const t=[deepClone(this.store.active[0],!0)];this.hoverType===HoverType.LineAnchorPrev?(this.store.activeAnchor.prev=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):this.hoverType===HoverType.LineAnchorNext?(this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.prev=void 0,this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:EditType.Update,pens:[deepClone(this.store.active[0])],initPens:t})}}toggleAnchorHand(){this.store.active.length===1&&this.store.active[0].type&&this.store.activeAnchor&&(this.store.activeAnchor.prevNextType||(this.store.activeAnchor.prevNextType=PrevNextType.Mirror),this.store.activeAnchor.prevNextType=(this.store.activeAnchor.prevNextType+1)%3)}gotoView(t,i){let s=getRect$1(this.store.data.pens);if(!isFinite(s.width))throw new Error("can not move view, because width is not finite");const a=this.store.data.width||this.store.options.width,r=this.store.data.height||this.store.options.height;a&&r&&(s={x:this.store.data.origin.x,y:this.store.data.origin.y,width:a*this.store.data.scale,height:r*this.store.data.scale}),this.store.data.x=this.canvas.clientWidth/2-t*s.width-s.x,this.store.data.y=this.canvas.clientHeight/2-i*s.height-s.y,this.onMovePens(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()}showMagnifier(){this.magnifierCanvas.canvas.style.zIndex="100",this.externalElements.style.zIndex="101",this.magnifierCanvas.magnifier=!0,this.magnifierCanvas.updateDomOffscreen(),this.externalElements.style.cursor="default",this.render()}hideMagnifier(){this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.zIndex="5",this.magnifierCanvas.magnifier=!1,this.externalElements.style.cursor="default",this.magnifierCanvas.render(),this.render()}showFit(){this.store.data.locked=0,this.canvasImage.fitFlag=!0,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach(t=>t.active=!1),this.canvasImage.init(),this.canvasImage.render()}hideFit(){this.canvasImage.fitFlag=!1,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.canvasImage.init(),this.canvasImage.render()}makeFit(){if(this.dragRect.width<100&&this.dragRect.height<100)return;const t=this.store.data.pens.filter(c=>{if(c.parentId||c.isRuleLine)return!1;if(rectInRect(c.calculative.worldRect,this.dragRect,!0))return c.type===PenType.Line&&!this.store.options.dragAllIn?lineInRect(c,this.dragRect):!0});if(!t.length)return;const i=this.parent.getRect(t),s=this.store.data.scale,a=this.store.data.width||this.store.options.width,r=this.store.data.height||this.store.options.height;let o=(Math.floor(i.x)-this.store.data.origin.x)/s/a,n=(Math.floor(i.y)-this.store.data.origin.y)/s/r,l={x:o,y:n,width:(Math.ceil(i.width)+1)/s/a,height:(Math.ceil(i.height)+1)/s/r,children:t.map(c=>c.id),id:s8(),active:!0};l.x<-.1&&(l.x=-.1),l.y<-.1&&(l.y=-.1),l.width>.5?(l.left=!0,l.right=!0,l.leftValue=(l.x-0)*s*a,l.rightValue=(1-(l.x+l.width))*s*a):l.x<.5?(l.left=!0,l.leftValue=(l.x-0)*s*a):(l.right=!0,l.rightValue=(1-(l.x+l.width))*s*a),l.leftValue<1&&(l.leftValue=0),l.rightValue<1&&(l.rightValue=0),l.height>.5?(l.top=!0,l.bottom=!0,l.topValue=(l.y-0)*s*r,l.bottomValue=(1-(l.y+l.height))*s*r):l.y<.5?(l.top=!0,l.topValue=(l.y-0)*s*r):(l.bottom=!0,l.bottomValue=(1-(l.y+l.height))*s*r),l.topValue<1&&(l.topValue=0),l.bottomValue<1&&(l.bottomValue=0),this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach(c=>{c.active=!1}),this.store.data.fits.push(l),this.canvasImage.activeFit=l,this.store.emitter.emit("fit",l),this.canvasImage.init(),this.canvasImage.render()}updateFit(t){const i=this.store.data.scale,s=this.store.data.width||this.store.options.width,a=this.store.data.height||this.store.options.height;let r=(t.x-this.store.data.origin.x)/i/s,o=(t.y-this.store.data.origin.y)/i/a;if(this.canvasImage.currentFit){const n=this.canvasImage.activeFit;if(this.canvasImage.currentFit==="top"){o<-.1&&(o=-.1);let h=o-n.y;if(n.height-=h,n.height<.01){n.height=.01;return}n.y=o}if(this.canvasImage.currentFit==="bottom"&&(o>1.1&&(o=1.1),n.height=o-n.y,n.height<=.01&&(n.height=.01)),this.canvasImage.currentFit==="left"){r<-.1&&(r=-.1);let h=r-n.x;if(n.width-=h,n.width<.01){n.width=.01;return}n.x=r}this.canvasImage.currentFit==="right"&&(r>1.1&&(r=1.1),n.width=r-n.x,n.width<=.01&&(n.width=.01));let l={x:n.x*s*i+this.store.data.origin.x,y:n.y*a*i+this.store.data.origin.y,width:n.width*s*i,height:n.height*a*i};calcRightBottom(l);const c=this.store.data.pens.filter(h=>{if(h.parentId||h.isRuleLine)return!1;if(rectInRect(h.calculative.worldRect,l,!0))return h.type===PenType.Line&&!this.store.options.dragAllIn?lineInRect(h,l):!0});n.left=void 0,n.leftValue=void 0,n.right=void 0,n.rightValue=void 0,n.top=void 0,n.topValue=void 0,n.bottom=void 0,n.bottomValue=void 0,n.width>.5?(n.left=!0,n.right=!0,n.leftValue=(n.x-0)*i*s,n.rightValue=(1-(n.x+n.width))*i*s):n.x<.5?(n.left=!0,n.leftValue=(n.x-0)*i*s):(n.right=!0,n.rightValue=(1-(n.x+n.width))*i*s),Math.abs(n.leftValue)<1&&(n.leftValue=0),Math.abs(n.rightValue)<1&&(n.rightValue=0),n.height>.5?(n.top=!0,n.bottom=!0,n.topValue=(n.y-0)*i*a,n.bottomValue=(1-(n.y+n.height))*i*a):n.y<.5?(n.top=!0,n.topValue=(n.y-0)*i*a):(n.bottom=!0,n.bottomValue=(1-(n.y+n.height))*i*a),Math.abs(n.topValue)<1&&(n.topValue=0),Math.abs(n.bottomValue)<1&&(n.bottomValue=0),n.children=c.map(h=>h.id),this.store.emitter.emit("fit",n),this.mouseDown.x=t.x,this.mouseDown.y=t.y,this.canvasImage.init(),this.canvasImage.render()}}updateFitRect(t=this.canvasImage.activeFit){const i=this.store.data.width||this.store.options.width,s=this.store.data.height||this.store.options.height;t.left&&(t.leftValue?t.x=Math.abs(t.leftValue)<1?t.leftValue:t.leftValue/i:t.x=0),t.right&&(t.rightValue?t.width=1-(Math.abs(t.rightValue)<1?t.rightValue:t.rightValue/i)-t.x:t.width=1-t.x),t.top&&(t.topValue?t.y=Math.abs(t.topValue)<1?t.topValue:t.topValue/s:t.y=0),t.bottom&&(t.bottomValue?t.height=1-(Math.abs(t.bottomValue)<1?t.bottomValue:t.bottomValue/s)-t.y:t.height=1-t.y),this.canvasImage.init(),this.canvasImage.render()}deleteFit(t=this.canvasImage.activeFit){if(!t)return;const i=this.store.data.fits.findIndex(s=>s.id===t.id);this.store.data.fits.splice(i,1),this.canvasImage.activeFit=void 0,this.canvasImage.init(),this.canvasImage.render(),this.store.emitter.emit("fit",void 0)}calcuActiveFit(){var n;const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;let s=(this.mouseDown.x-this.store.data.origin.x)/this.store.data.scale/t,a=(this.mouseDown.y-this.store.data.origin.y)/this.store.data.scale/i,r=-1,o=-1;(n=this.store.data.fits)==null||n.forEach((l,c)=>{l.ex=null,l.ey=null,pointInRect({x:s,y:a},l)&&(r=c),l.active&&(o=c)}),r!==-1&&r!==o?(this.canvasImage.activeFit=this.store.data.fits[r],this.store.data.fits[r].active=!0,o!==-1&&(this.store.data.fits[o].active=!1),this.store.emitter.emit("fit",this.store.data.fits[r])):r===-1&&o!==-1&&(this.store.data.fits[o].active=!1,this.store.emitter.emit("fit",void 0),this.canvasImage.activeFit=null),this.inactive(),this.canvasImage.init(),this.canvasImage.render()}toggleMagnifier(){this.magnifierCanvas.magnifier=!this.magnifierCanvas.magnifier,this.magnifierCanvas.magnifier&&(this.externalElements.style.cursor="default"),this.render()}destroy(){var t,i,s,a;switch(this.scroll&&this.scroll.destroy(),(t=this.tooltip)==null||t.destroy(),(i=this.dialog)==null||i.destroy(),(s=this.title)==null||s.destroy(),(a=this.popconfirm)==null||a.destroy(),this.externalElements.removeEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=r=>r.preventDefault(),this.externalElements.ondrop=void 0,this.externalElements.ontouchstart=void 0,this.externalElements.ontouchmove=void 0,this.externalElements.ontouchend=void 0,this.externalElements.onmousedown=void 0,this.externalElements.onmousemove=void 0,this.externalElements.onmouseup=void 0,this.externalElements.onmouseleave=void 0,this.externalElements.ondblclick=void 0,this.store.options.keydown){case KeydownType.Document:document.removeEventListener("keydown",this.onkeydown),document.removeEventListener("keyup",this.onkeyup);break;case KeydownType.Canvas:this.externalElements.removeEventListener("keydown",this.onkeydown),this.externalElements.removeEventListener("keyup",this.onkeyup);break}document.removeEventListener("copy",this.onCopy),document.removeEventListener("cut",this.onCut),document.removeEventListener("paste",this.onPaste),window&&window.removeEventListener("message",this.onMessage),window&&window.removeEventListener("resize",this.onResize),window&&window.removeEventListener("scroll",this.onScroll),this.parentElement.innerHTML=""}}function form(e,t){const i=t||new Path2D;e.onDestroy||(e.onDestroy=destory$2,e.onMove=move$2,e.onRotate=move$2,e.onMouseEnter=mouseEnter,e.onMouseLeave=mouseLeave,e.onMouseMove=mouseMove$1,e.onMouseUp=mouseUp,e.onInput=input),e.formId=e.id;let s=e.calculative.borderRadius||0,a=s;const{x:r,y:o,width:n,height:l,ex:c,ey:h}=e.calculative.worldRect;e.calculative.worldTextRect,s<1&&(s=n*s,a=l*a);let d=s<a?s:a;if(n<2*d&&(d=n/2),l<2*d&&(d=l/2),i.moveTo(r+d,o),i.arcTo(c,o,c,h,d),i.arcTo(c,h,r,h,d),i.arcTo(r,h,r,o,d),i.arcTo(r,o,c,o,d),i instanceof Path2D)return i}function input(e,t){e.text=t,e.calculative.text=e.text,e.calculative.canvas.updatePenRect(e)}function destory$2(e){}function move$2(e){}function mouseEnter(e){}function mouseLeave(e){const t=e.calculative.canvas.store.active;t&&t.length&&t.forEach(i=>{if(e.followers){let s=e.followers.findIndex(a=>a===i.id);if(s!==-1){const a=e.calculative.canvas.store.pens[i.id+movingSuffix];a&&a.calculative&&(rectInRect(a.calculative.worldRect,e.calculative.worldRect,!0)||(e.followers.splice(s,1),delete i.formId))}}})}function mouseUp(e){const t=e.calculative.canvas.store.active;t&&t.length&&t.forEach(i=>{const s=e.calculative.canvas.store.pens[i.id+movingSuffix];if(s&&s.calculative){let a=deepClone(e.calculative.worldRect);a.x-=1,a.y-=1,a.width+=2,a.height+=2,rectInRect(s.calculative.worldRect,a,!0)&&(e.followers||(e.followers=[]),e.followers.includes(i.id)||e.followers.push(i.id),i.formId=e.id)}})}function mouseMove$1(e,t){}function updateFormData(e,t){if(e.formId&&e.formKey&&e.formValue){const i=e.calculative.canvas.store.pens[e.formId];i&&(i.formData||(i.formData={}),i.formData[e.formKey]=e[e.formValue])}}function reset(e){const t=e.calculative.canvas.store.pens[e.formId];t.followers.forEach(i=>{const s=e.calculative.canvas.store.pens[i];if(s.formId&&s.formKey&&t.formData[s.formKey]){const a=s[s.formValue];let r="";Array.isArray(a)&&(r=[]),e.calculative.canvas.parent.setValue({id:s.id,[s.formValue]:r},{render:!1,doEvent:!1,history:!1})}}),t.formData={},e.calculative.canvas.parent.render()}const gifsList={};function gif(e){e.onDestroy||(e.onDestroy=destory$1,e.onMove=move$1,e.onResize=resize$2,e.onRotate=move$1,e.onValue=value$2,e.onChangeId=changeId);const t=new Path2D;if(!e.image)return;const s=e.calculative.canvas.store.id+"-"+e.id;if(!gifsList[s]){const a=new Image;a.crossOrigin="anonymous",a.src=e.image,e.calculative.canvas.parent.store.options.cdn&&!(e.image.startsWith("http")||e.image.startsWith("//")||e.image.startsWith("data:image"))&&(a.src=e.calculative.canvas.parent.store.options.cdn+e.image),gifsList[s]=a,a.onload=()=>{var r;gifsList[s]===a&&(e.calculative.img=a,e.calculative.imgNaturalWidth=a.naturalWidth||e.iconWidth,e.calculative.imgNaturalHeight=a.naturalHeight||e.iconHeight,(r=e.calculative.canvas.externalElements)==null||r.parentElement.appendChild(a),setImagePosition(e,a))}}return e.calculative.patchFlags&&gifsList[s]&&setImagePosition(e,gifsList[s]),t}function destory$1(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&(gifsList[i].remove(),gifsList[i]=void 0)}function move$1(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&setImagePosition(e,gifsList[i])}function resize$2(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&setImagePosition(e,gifsList[i])}function value$2(e){const i=e.calculative.canvas.store.id+"-"+e.id;gifsList[i]&&(setImagePosition(e,gifsList[i]),gifsList[i].getAttribute("src")!==e.image&&(gifsList[i].src=e.image))}function changeId(e,t,i){const s=e.calculative.canvas.store.id;gifsList[s+"-"+t]&&(gifsList[s+"-"+i]=gifsList[s+"-"+t],delete gifsList[s+"-"+t])}function setImagePosition(e,t){t.style.objectFit=e.imageRatio?"contain":"fill",setElemPosition(e,t)}function mindNode(e,t){return e.onResize||(e.onResize=resize$1,e.onValue=value$1),rectangle(e,t)}function resize$1(e){const t=e.anchors.filter(i=>i.flag!==1);mindNodeAnchors(e),e.anchors=e.anchors.concat(...t)}function value$1(e){resize$1(e),calcWorldAnchors(e)}function mindNodeAnchors(e){const t=[],{x:i,y:s,width:a,height:r}=e,o=borderRadius(e),n=5;for(let d=0;d<n;d++){if(d===2)continue;let f=i+a*(d+1)/(n+1),u=s;f<i+o?u=getYByCircle(i+o,u+o,f,o,-1):f>i+a-o&&(u=getYByCircle(i+a-o,u+o,f,o,-1)),t.push({id:String(t.length),flag:1,penId:e.id,x:(f-i)/a,y:(u-s)/r})}const l=3;for(let d=0;d<l;d++){let f=s+r*(d+1)/(l+1),u=i+a;f<s+o?u=getXByCircle(u-o,s+o,f,o):f>s+r-o&&(u=getXByCircle(u-o,s+r-o,f,o)),t.push({id:String(t.length),flag:1,penId:e.id,x:(u-i)/a,y:(f-s)/r})}const c=5;for(let d=0;d<c;d++){if(d===2)continue;let f=i+a*(d+1)/(c+1),u=s+r;f<i+o?u=getYByCircle(i+o,u-o,f,o):f>i+a-o&&(u=getYByCircle(i+a-o,u-o,f,o)),t.push({id:String(t.length),flag:1,penId:e.id,x:(f-i)/a,y:(u-s)/r})}const h=3;for(let d=0;d<h;d++){let f=s+r*(d+1)/(h+1),u=i;f<s+o?u=getXByCircle(u+o,s+o,f,o,-1):f>s+r-o&&(u=getXByCircle(u+o,s+r-o,f,o,-1)),t.push({id:String(t.length),flag:1,penId:e.id,x:(u-i)/a,y:(f-s)/r})}e.anchors=t}function borderRadius(e){let t=e.calculative.borderRadius||0,i=e.calculative.borderRadius||0;const{width:s,height:a}=e;e.calculative.borderRadius<1&&(t=s*e.calculative.borderRadius,i=a*e.calculative.borderRadius);let r=t<i?t:i;return s<2*r&&(r=s/2),a<2*r&&(r=a/2),r}function getXByCircle(e,t,i,s,a=1){return a*Math.sqrt(s**2-(i-t)**2)+e}function getYByCircle(e,t,i,s,a=1){return a*Math.sqrt(s**2-(i-e)**2)+t}function mindLine(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.moveTo(s,a+o),i.lineTo(s+r,a+o),i.closePath(),i instanceof Path2D)return i}function mindLineAnchors(e){const t=[{x:0,y:1},{x:1,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:a+"",x:i,y:s,penId:e.id}))}function commonPens(){return{rectangle,square,circle,svgPath,diamond,triangle,pentagon,pentagram,hexagon,leftArrow,rightArrow,twowayArrow,message,cloud,file,people,line,iframe,video,gif,mindNode,mindLine,mindNode2:rectangle,form,combine:rectangle}}function commonAnchors(){return{triangle:triangleAnchors,pentagon:pentagonAnchors,pentagram:pentagramAnchors,mindNode:mindNodeAnchors,mindLine:mindLineAnchors}}class ViewMap{constructor(t){g(this,"parent");g(this,"box");g(this,"boxWidth",320);g(this,"boxHeight",180);g(this,"ratio",this.boxWidth/this.boxHeight);g(this,"padding",5);g(this,"img");g(this,"isShow");g(this,"isDown");g(this,"view");g(this,"timer");g(this,"onMouseDown",t=>{t.preventDefault(),t.stopPropagation(),this.isDown=!0});g(this,"onMouseMove",t=>{if(t.preventDefault(),t.stopPropagation(),this.isDown)try{this.parent.gotoView(t.offsetX/this.box.clientWidth,t.offsetY/this.box.clientHeight)}catch(i){console.warn(i.message),this.isDown=!1}});g(this,"onMouseUp",t=>{t.preventDefault(),t.stopPropagation();try{this.parent.gotoView(t.offsetX/this.box.clientWidth,t.offsetY/this.box.clientHeight)}catch(i){console.warn(i.message)}finally{this.isDown=!1}});g(this,"onWheel",t=>{let i=.015;if(this.parent.store.options.scaleOff)i=this.parent.store.options.scaleOff,t.deltaY>0&&(i=-this.parent.store.options.scaleOff);else if(/mac os /i.test(navigator.userAgent))t.ctrlKey?t.deltaY>0&&(i*=-1):i*=t.wheelDeltaY/240;else{let l=.2;t.deltaY.toString().indexOf(".")!==-1&&(l=.01),t.deltaY>0?i=-l:i=l}let{offsetX:s,offsetY:a}=t;const r=this.parent.store.data.width||this.parent.store.options.width,o=this.parent.store.data.height||this.parent.store.options.height;if(r&&o)s=s/this.boxWidth*r*this.parent.store.data.scale+this.parent.store.data.origin.x+this.parent.store.data.x,a=a/this.boxHeight*o*this.parent.store.data.scale+this.parent.store.data.origin.y+this.parent.store.data.y;else{const n=this.parent.parent.getRect();s=s/this.boxWidth*n.width+n.x+this.parent.store.data.x,a=a/this.boxHeight*n.height+n.y+this.parent.store.data.y}this.parent.scale(this.parent.store.data.scale+i,{x:s,y:a})});var s;this.parent=t,this.box=document.createElement("div"),this.img=new Image,this.view=document.createElement("div"),this.box.appendChild(this.img),this.box.appendChild(this.view),(s=this.parent.externalElements)==null||s.parentElement.appendChild(this.box),this.box.className="meta2d-map",this.box.onmousedown=this.onMouseDown,this.box.onmousemove=this.onMouseMove,this.box.onmouseup=this.onMouseUp,this.box.onwheel=this.onWheel;let i;for(let a=0;a<document.styleSheets.length;a++)document.styleSheets[a].title==="le5le/map"&&(i=document.styleSheets[a]);if(!i){let a=document.createElement("style");a.type="text/css",a.title="le5le.com/map",document.head.appendChild(a),a=document.createElement("style"),a.type="text/css",document.head.appendChild(a),i=a.sheet,i.insertRule(`.meta2d-map{display:flex;width:${this.boxWidth+2*this.padding}px;height:${this.boxHeight+2*this.padding}px;padding:${this.padding}px;background:#f4f4f4;border:1px solid #ffffff;box-shadow: 0px 0px 14px 0px rgba(0,10,38,0.30);border-radius:8px;position:absolute;z-index:9999;right:0;bottom:0;justify-content:center;align-items:center;cursor:default;user-select:none;overflow: hidden;}`),i.insertRule(".meta2d-map img{max-width:100%;max-height:100%;pointer-events: none;}"),i.insertRule(".meta2d-map div{pointer-events: none;border:1px solid #1890ff;position:absolute}")}}show(){this.box.style.display="flex",this.parent.store.data.pens.length?(this.img.style.display="block",this.img.src=this.parent.toPng(0,void 0,!0),this.setView()):this.img.style.display="none",this.isShow=!0}hide(){this.box.style.display="none",this.isShow=!1}setView(){const t=this.parent.store.data;if(t.pens.length){let i=getRect$1(t.pens);const s=this.parent.store.data.width||this.parent.store.options.width,a=this.parent.store.data.height||this.parent.store.options.height;if(s&&a?i={x:this.parent.store.data.origin.x,y:this.parent.store.data.origin.y,width:s*this.parent.store.data.scale,height:a*this.parent.store.data.scale}:(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.parent.store.bkImg&&(this.img.src=this.parent.toPng(0,void 0,!0))},300)),translateRect(i,t.x,t.y),i.width/i.height>this.ratio){const d=i.width/this.ratio;i.y-=(d-i.height)/2,i.height=d,calcRightBottom(i)}else{const d=i.height*this.ratio;i.x-=(d-i.width)/2,i.width=d,calcRightBottom(i)}const o=this.parent.canvasRect;let n=0,l=0;if(i.x<0)n=-i.x/i.width;else if(i.x+i.width>o.width){let d=0;o.width>i.width&&(d=o.width-i.width),n=(-i.x+d)/i.width}if(i.y<0)l=-i.y/i.height;else if(i.y+i.height>o.height){let d=0;o.height>i.height&&(d=o.height-i.height),l=(-i.y+d)/i.height}const c=o.width>i.width?1:o.width/i.width,h=o.height>i.height?1:o.height/i.height;this.view.style.left=this.padding+n*this.boxWidth+"px",this.view.style.width=c*this.boxWidth+"px",this.view.style.top=this.padding+l*this.boxHeight+"px",this.view.style.height=h*this.boxHeight+"px"}}}const status={success:{color:"#2ba471",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM7.5 10.59l3 3 6-6L17.91 9l-7.41 7.41L6.09 12l1.41-1.41z"></path></svg>'},info:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{color:"#e37318",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},error:{color:"#d54941",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},question:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zm-.17-11.11c.43-.53.97-.97 1.4-1.32A2 2 0 0012 7a2 2 0 00-1.89 1.33l-.33.95L7.9 8.6l.34-.94a4 4 0 116.24 4.47 7 7 0 00-1.1 1.01c-.27.34-.37.61-.37.85v1.25h-2V14c0-.87.39-1.57.83-2.11zM11 18.25v-2h2v2h-2z"></path></svg>'}},messageList={};class Message{constructor(t,i){g(this,"parentElement");g(this,"box");g(this,"icon");g(this,"text");g(this,"closeBtn");g(this,"duration");g(this,"content");g(this,"theme");g(this,"placement");g(this,"height");g(this,"id");this.parentElement=t,this.box=document.createElement("div"),this.icon=document.createElement("div"),this.text=document.createElement("div"),this.box.className="meta2d-message",this.icon.className="icon",this.text.className="text",this.icon.innerHTML=status[i.theme||"info"].icon,this.text.innerHTML=i.content,this.box.appendChild(this.icon),this.box.appendChild(this.text),i.closeBtn&&(this.closeBtn=document.createElement("div"),this.closeBtn.className="close",this.closeBtn.innerHTML="x",this.closeBtn.onclick=()=>{this.close()},this.box.appendChild(this.closeBtn)),t.appendChild(this.box);let s;for(let a=0;a<document.styleSheets.length;a++)document.styleSheets[a].title==="le5le.com/message"&&(s=document.styleSheets[a]);if(!s){let a=document.createElement("style");a.type="text/css",a.title="le5le.com/message",document.head.appendChild(a),a=document.createElement("style"),a.type="text/css",document.head.appendChild(a),s=a.sheet,s.insertRule(`.meta2d-message{
           position:absolute;
           z-index:999;
           transform: translateX(-50%); 
           padding:12px 16px;
           max-width:400px;
           background:#fff;
           border-radius:6px;
           box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);
           display:flex;
           animation: fadein .5s;}`),s.insertRule(`
        @keyframes fadein {
          0% {
              transform: translate(-50%, -100%);
          }
          100% {
              transform: translate(-50%,0);
          }
      }`),s.insertRule(".meta2d-message .icon{width:20px;height:20px;}"),s.insertRule(".meta2d-message .text{color:rgba(0, 0, 0, 0.9);font-size:12px;margin-left:8px;line-height:20px;}"),s.insertRule(".meta2d-message .close{width:20px;height:20px;padding-left: 16px; cursor: pointer;}")}this.id=i.id||s8(),this.duration=i.duration??3e3,this.placement=i.placement||"top",this.theme=i.theme||"info",this.height=i.height}init(){messageList[this.id]=this,this.duration&&setTimeout(()=>{this.close()},this.duration);let t=-1;Object.keys(messageList).forEach(i=>{var s;((s=messageList[i])==null?void 0:s.placement)===this.placement&&t++}),this.setPosition(this.placement,t),this.icon.children[0].style.fill=status[this.theme].color}setPosition(t,i=0){switch(t){case"top":this.box.style.top=`${30+i*(this.height||60)}px`,this.box.style.left="50%";break;case"bottom":this.box.style.bottom=`${30+i*(this.height||60)}px`,this.box.style.left="50%";break;case"left":this.box.style.top=`${30+i*(this.height||60)}px`,this.box.style.left="30px";break;case"right":this.box.style.top=`${30+i*(this.height||60)}px`,this.box.style.right="30px";break}}close(){Object.keys(messageList).forEach(t=>{var i;if(((i=messageList[t])==null?void 0:i.placement)===this.placement)switch(this.placement){case"top":case"left":case"right":messageList[t].box.style.top=parseInt(messageList[t].box.style.top)-60+"px";break;case"bottom":messageList[t].box.style.bottom=parseInt(messageList[t].box.style.bottom)-60+"px";break}}),messageList[this.id]=null,delete messageList[this.id],this.box.remove()}}class Meta2d{constructor(e,t={}){g(this,"store");g(this,"canvas");g(this,"websocket");g(this,"mqttClient");g(this,"websockets");g(this,"mqttClients");g(this,"eventSources");g(this,"penPluginMap",new Map);g(this,"socketFn");g(this,"events",{});g(this,"map");g(this,"mapTimer");g(this,"facePen",facePen);g(this,"getWords",getWords);g(this,"calcTextLines",calcTextLines);g(this,"calcTextRect",calcTextRect);g(this,"calcTextDrawRect",calcTextDrawRect);g(this,"jetLinksList",[]);g(this,"jetLinksClient");g(this,"register",register$1);g(this,"registerCanvasDraw",registerCanvasDraw);g(this,"registerAnchors",registerAnchors);g(this,"registerLineAnimateDraws",(name,drawFunc)=>{drawFunc=typeof drawFunc=="string"?drawFunc:drawFunc.toString(),this.store.data.lineAnimateDraws[name]=drawFunc,globalStore.lineAnimateDraws[name]=eval(drawFunc)});g(this,"websocketTimes",0);g(this,"mqttTimes",0);g(this,"httpTimer");g(this,"httpTimerList",[]);g(this,"updateTimer");g(this,"updateTimerList",[]);g(this,"sqlTimerList",[]);g(this,"iotMqttClient");g(this,"iotTimer");g(this,"iotWebsocketClient");g(this,"onEvent",(e,t)=>{switch(e){case"add":t.forEach(i=>{var s;(s=i.onAdd)==null||s.call(i,i)}),this.onSizeUpdate();break;case"enter":t&&t.onMouseEnter&&t.onMouseEnter(t,this.canvas.mousePos),this.store.data.locked&&this.doEvent(t,e);break;case"leave":t&&t.onMouseLeave&&t.onMouseLeave(t,this.canvas.mousePos),this.store.data.locked&&this.doEvent(t,e);break;case"active":case"inactive":this.store.data.locked&&t.forEach(i=>{this.doEvent(i,e)});break;case"click":if(this.store.data.locked&&t.pen&&!t.pen.disabled&&t.pen.switch&&(t.pen.checked=!t.pen.checked,t.pen.calculative.checked=t.pen.checked,t.pen.calculative.gradient=void 0,t.pen.calculative.radialGradient=void 0),t.pen&&t.pen.formId){const i=this.store.pens[t.pen.formId];t.pen.formType==="submit"?this.store.data.locked&&i&&!i.disabled&&this.doEvent(i,"submit"):t.pen.formType==="reset"&&(reset(t.pen),this.store.data.locked&&i&&!i.disabled&&this.doEvent(i,"reset"))}t.pen&&t.pen.onClick&&!t.pen.disabled&&t.pen.onClick(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"contextmenu":t.pen&&t.pen.onContextmenu&&!t.pen.disabled&&t.pen.onContextmenu(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"mousedown":t.pen&&t.pen.onMouseDown&&!t.pen.disabled&&t.pen.onMouseDown(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"mouseup":t.pen&&t.pen.onMouseUp&&!t.pen.disabled&&t.pen.onMouseUp(t.pen,this.canvas.mousePos),this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"dblclick":this.store.data.locked&&t.pen&&!t.pen.disabled&&this.doEvent(t.pen,e);break;case"valueUpdate":t&&updateFormData(t,t.formValue),this.store.data.locked&&this.doEvent(t,e),this.canvas.tooltip.updateText(t);break;case"update":case"delete":case"translatePens":case"rotatePens":case"resizePens":this.onSizeUpdate();break;case"navigator":this.store.data.id||console.warn("请先保存当前图纸"),this.navigatorTo(t.params);break;case"input":this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,e);break;case"change":t.pen&&updateFormData(t.pen),t.pen?this.store.data.locked&&!t.pen.disabled&&this.doEvent(t.pen,e):this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,e);break}this.doMessageEvent(e,t)});g(this,"doEvent",(e,t)=>{var a,r,o,n,l,c,h,d,f,u;if(!e)return;let i=!1,s=[];if((a=e.events)==null||a.forEach((v,y)=>{var m;if(v.actions&&v.actions.length){if(v.name===t){let w=!1;v.conditions&&v.conditions.length?v.conditionType==="and"?w=v.conditions.every(x=>this.judgeCondition(e,x.key,x)):v.conditionType==="or"&&(w=v.conditions.some(x=>this.judgeCondition(e,x.key,x))):w=!0,w&&s.push(y)}}else if(i=!0,this.events[v.action]&&v.name===t){let w=!((m=v.where)!=null&&m.type);if(v.where){const{fn:x,fnJs:b,comparison:T,key:p,value:R}=v.where;if(x)w=x(e,{meta2d:this});else if(b){try{v.where.fn=new Function("pen","context",b)}catch(k){console.error("Error: make function:",k)}v.where.fn&&(w=v.where.fn(e,{meta2d:this}))}else{let k=e[p];switch(["x","y","width","height"].includes(p)&&(k=this.getPenRect(e)[p]),T){case">":w=k>+R;break;case">=":w=k>=+R;break;case"<":w=k<+R;break;case"<=":w=k<=+R;break;case"=":case"==":w=k==R;break;case"!=":w=k!=R;break;case"[)":w=valueInRange(+k,R);break;case"![)":w=!valueInRange(+k,R);break;case"[]":w=valueInArray(k,R);break;case"![]":w=!valueInArray(k,R);break}}}w&&s.push(y)}}),i?(r=e.events)==null||r.forEach((v,y)=>{s.includes(y)&&this.events[v.action](e,v)}):(o=e.events)==null||o.forEach(async(v,y)=>{if(s.includes(y)){if(v.confirm&&!await this.canvas.popconfirm.showModal(e,this.canvas.mousePos,v.confirmTitle))return;v.actions.forEach(m=>{if(m.timeout){let w=setTimeout(()=>{this.events[m.action]&&(this.events[m.action](e,m),clearTimeout(w),w=null)},m.timeout)}else this.events[m.action]&&this.events[m.action](e,m)})}}),t==="valueUpdate"){(n=e.realTimes)==null||n.forEach(y=>{var w,x;let m=[];(w=y.triggers)==null||w.forEach((b,T)=>{var R;let p=!1;(R=b.conditions)!=null&&R.length?b.conditionType==="and"?p=b.conditions.every(k=>this.judgeCondition(e,y.key,k)):b.conditionType==="or"&&(p=b.conditions.some(k=>this.judgeCondition(e,y.key,k))):p=!0,p&&m.push(T)}),(x=y.triggers)==null||x.forEach((b,T)=>{var p;m.includes(T)&&((p=b.actions)==null||p.forEach(R=>{if(R.timeout){let k=setTimeout(()=>{this.events[R.action]&&(this.events[R.action](e,R),clearTimeout(k),k=null)},R.timeout)}else this.events[R.action](e,R)}))})});let v=[];if((l=this.store.globalTriggers[e.id])==null||l.forEach((y,m)=>{var x;let w=!1;(x=y.conditions)!=null&&x.length?y.conditionType==="and"?w=y.conditions.every(b=>this.judgeCondition(this.store.pens[b.source],b.key,b)):y.conditionType==="or"&&(w=y.conditions.some(b=>this.judgeCondition(this.store.pens[b.source],b.key,b))):w=!0,w&&v.push(m)}),(c=this.store.globalTriggers[e.id])==null||c.forEach((y,m)=>{var w;v.includes(m)&&((w=y.actions)==null||w.forEach(x=>{if(x.timeout){let b=setTimeout(()=>{this.events[x.action]&&(this.events[x.action](e,x),clearTimeout(b),b=null)},x.timeout)}else this.events[x.action](e,x)}))}),(h=e.triggers)!=null&&h.length){for(let y of e.triggers)if((d=y.status)!=null&&d.length)for(let m of y.status){let w=!1;if((f=m.conditions)!=null&&f.length?m.conditionType==="and"?w=m.conditions.every(x=>this.judgeCondition(e,x.key,x)):m.conditionType==="or"&&(w=m.conditions.some(x=>this.judgeCondition(e,x.key,x))):w=!0,w){(u=m.actions)==null||u.forEach(x=>{if(x.timeout){let b=setTimeout(()=>{this.events[x.action]&&(this.events[x.action](e,x),clearTimeout(b),b=null)},x.timeout)}else this.events[x.action](e,x)});break}}}}this.doEvent(this.store.pens[e.parentId],t)});g(this,"doDataEvent",e=>{var s,a,r;if(!((s=this.store.data.dataEvents)!=null&&s.length))return;const t=e.reduce((o,{dataId:n,id:l,value:c})=>(o[l||n]=c,o),{});let i=[];(a=this.store.data.dataEvents)==null||a.forEach((o,n)=>{let l=!1;o.conditions&&o.conditions.length?o.conditionType==="and"?l=o.conditions.every(c=>this.dataJudegeCondition(t,c.key,c)):o.conditionType==="or"&&(l=o.conditions.some(c=>this.dataJudegeCondition(t,c.key,c))):l=!0,l&&i.push(n)}),(r=this.store.data.dataEvents)==null||r.forEach((o,n)=>{var l;i.includes(n)&&((l=o.actions)==null||l.forEach(c=>{this.events[c.action](t,c)}))})});g(this,"renderPenRaw",renderPenRaw$1);g(this,"setElemPosition",setElemPosition);g(this,"setLifeCycleFunc",setLifeCycleFunc);this.store=useStore(s8()),this.setOptions(t),this.setDatabyOptions(t),this.init(e),this.register(commonPens()),this.registerCanvasDraw({cube}),this.registerAnchors(commonAnchors()),globalThis.meta2d=this,this.initEventFns(),this.store.emitter.on("*",this.onEvent)}get beforeAddPen(){return this.canvas.beforeAddPen}set beforeAddPen(e){this.canvas.beforeAddPen=e}get beforeAddPens(){return this.canvas.beforeAddPens}set beforeAddPens(e){this.canvas.beforeAddPens=e}get beforeAddAnchor(){return this.canvas.beforeAddAnchor}set beforeAddAnchor(e){this.canvas.beforeAddAnchor=e}get beforeRemovePens(){return this.canvas.beforeRemovePens}set beforeRemovePens(e){this.canvas.beforeRemovePens=e}get beforeRemoveAnchor(){return this.canvas.beforeRemoveAnchor}set beforeRemoveAnchor(e){this.canvas.beforeRemoveAnchor=e}setOptions(e={}){var t,i;(e.grid!==void 0||e.gridColor!==void 0||e.gridSize!==void 0)&&this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),(e.rule!==void 0||e.ruleColor!==void 0||e.ruleOptions!==void 0)&&(this.store.patchFlagsTop=!0,e.ruleOptions&&(t=this.store.options)!=null&&t.ruleOptions&&(Object.assign(this.store.options.ruleOptions,e.ruleOptions),e.ruleOptions=this.store.options.ruleOptions)),e.background!==void 0&&this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),e.resizeMode!==void 0&&(e.resizeMode||(this.canvas.hotkeyType=HotkeyType.None)),(e.width!==void 0||e.height!==void 0)&&(this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),this.canvas&&this.canvas.canvasTemplate.canvas.style.backgroundImage&&(this.canvas.canvasTemplate.canvas.style.backgroundImage="")),this.store.options=Object.assign(this.store.options,e),this.canvas&&e.scroll!==void 0&&(e.scroll?(!this.canvas.scroll&&(this.canvas.scroll=new Scroll(this.canvas)),this.canvas.scroll.show()):this.canvas.scroll&&this.canvas.scroll.hide()),(i=this.canvas)==null||i.initGlobalStyle()}getOptions(){return this.store.options}registerTheme(e,t){if(!Array.isArray(t))return;const i=/^\s*\S+\s*:\s*\S+\s*$/;if(!t.every(o=>i.test(o)))return;const a={},r=[];for(let o=0;o<t.length;o++){const l=t[o].split(":"),c=l[0].trim(),h=l[1].trim();r.push([c,h].join(":")),a[c]=h}le5leTheme.addTheme(e,r),this.store.theme[e]=a}setTheme(e){this.store.data.theme=e,this.setBackgroundColor(this.store.theme[e].background),this.canvas.parentElement.style.background=this.store.theme[e].parentBackground,this.store.data.color=this.store.theme[e].color,this.setOptions({ruleColor:this.store.theme[e].ruleColor,ruleOptions:this.store.theme[e].ruleOptions}),le5leTheme.updateCssRule(this.store.id,e),this.canvas.initGlobalStyle();for(let t=0;t<this.store.data.pens.length;t++){const i=this.store.data.pens[t];i.setTheme&&i.setTheme(i,this.store.styles)}this.render()}setDatabyOptions(e={}){const{color:t,activeColor:i,activeBackground:s,grid:a,gridColor:r,gridSize:o,fromArrow:n,toArrow:l,rule:c,ruleColor:h,textColor:d,x:f=0,y:u=0}=e;this.setRule({rule:c,ruleColor:h}),this.setGrid({grid:a,gridColor:r,gridSize:o}),this.store.data=Object.assign(this.store.data,{textColor:d,color:t,activeColor:i,activeBackground:s,fromArrow:n,toArrow:l,x:f,y:u})}init(e){typeof e=="string"?this.canvas=new Canvas(this,document.getElementById(e),this.store):this.canvas=new Canvas(this,e,this.store),this.canvas.initGlobalStyle(),this.resize(),this.canvas.listen(),le5leTheme.createThemeSheet(this.store.data.theme,this.store.id)}initEventFns(){this.events[EventAction.Link]=(e,t)=>{var i;if(window&&t.value&&typeof t.value=="string"){let s=t.value;if(s.includes("${")){let a=(i=s.match(/\$\{([^}]+)\}/g))==null?void 0:i.map(r=>r.slice(2,-1));a&&(a==null||a.forEach(r=>{s=s.replace(`\${${r}}`,e[r])}))}window.open(s,t.params??"_blank");return}console.warn("[meta2d] Link param is not a string")},this.events[EventAction.SetProps]=(e,t)=>{var s,a,r;const i=t.value;if(i&&typeof i=="object"){const o=t.params?this.find(t.params):this.find(e.id),n={};for(let l in i)if((s=i[l])!=null&&s.id)n[l]=(a=this.store.pens[i[l].id])==null?void 0:a[i[l].key];else if(typeof i[l]=="string"&&i[l].includes("${")){let c=i[l],h=(r=c.match(/\$\{([^}]+)\}/g))==null?void 0:r.map(d=>d.slice(2,-1));h&&h.forEach(d=>{c=c.replace(`\${${d}}`,e[d]||this.getDynamicParam(d))}),n[l]=c}else n[l]=i[l];o.forEach(l=>{n.hasOwnProperty("visible")&&l.visible!==n.visible&&this.setVisible(l,n.visible),this.setValue({id:l.id,...n},{render:!1,doEvent:!1})}),this.render();return}console.warn("[meta2d] SetProps value is not an object")},this.events[EventAction.StartAnimate]=(e,t)=>{let i=e;if(t.value&&(i=this.findOne(t.value)),!(this.store.animates.has(i)&&!i.calculative.pause&&i.animateName===t.params)){if(t.targetType&&t.params){this.startAnimate(t.value||[e],t.params);return}if(!t.value||typeof t.value=="string"){this.startAnimate(t.value||[e]);return}console.warn("[meta2d] StartAnimate value is not a string")}},this.events[EventAction.PauseAnimate]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.pauseAnimate(t.value||[e]);return}console.warn("[meta2d] PauseAnimate value is not a string")},this.events[EventAction.StopAnimate]=(e,t)=>{if(!t.value||typeof t.value=="string"){if(t.value){let i=this.findOne(t.value);if(!this.store.animates.has(i))return}else if(!this.store.animates.has(e))return;this.stopAnimate(t.value||[e]);return}console.warn("[meta2d] StopAnimate event value is not a string")},this.events[EventAction.StartVideo]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.startVideo(t.value||[e]);return}console.warn("[meta2d] StartVideo value is not a string")},this.events[EventAction.PauseVideo]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.pauseVideo(t.value||[e]);return}console.warn("[meta2d] PauseVideo value is not a string")},this.events[EventAction.StopVideo]=(e,t)=>{if(!t.value||typeof t.value=="string"){this.stopVideo(t.value||[e]);return}console.warn("[meta2d] StopVideo event value is not a string")},this.events[EventAction.JS]=(e,t,i)=>{var s;if(t.value&&!t.fn)try{if(typeof t.value!="string")throw new Error("[meta2d] Function value must be string");const a=t.value;t.fn=new Function("pen","params","context",a)}catch(a){console.error("[meta2d]: Error on make a function:",a)}(s=t.fn)==null||s.call(t,e,i||t.params,{meta2d:this,eventName:t.name})},this.events[EventAction.GlobalFn]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] GlobalFn value must be a string");return}globalThis[t.value]&&globalThis[t.value](e,t.params)},this.events[EventAction.Emit]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] Emit value must be a string");return}this.store.emitter.emit(t.value,{pen:e,params:t.params,eventName:t.name})},this.events[EventAction.SendPropData]=(e,t)=>{const i=deepClone(t.value);if(i&&typeof i=="object"){const s=t.params?this.findOne(t.params):e;for(let a in i)(i[a]===void 0||i[a]==="")&&(i[a]=s[a]);i.id=s.id,this.doSendDataEvent(i,t.extend);return}console.warn("[meta2d] SendPropData value is not an object")},this.events[EventAction.SendVarData]=(e,t)=>{const i=deepClone(t.value);if(i&&typeof i=="object"){const s=t.params?this.findOne(t.params):e;let a=[];for(let r in i){let o={dataId:r,value:i[r]};if(!o.value){let n=s.form.find(l=>l.dataIds&&l.dataIds.dataId===o.dataId);n&&(o.value=s[n.key])}a.push(o)}this.doSendDataEvent(a,t.extend);return}console.warn("[meta2d] SendVarData value is not an object")},this.events[EventAction.Navigator]=(e,t)=>{t.value&&typeof t.value=="string"&&this.navigatorTo(t.value)},this.events[EventAction.Dialog]=(e,t)=>{var i;if(t.params&&typeof t.params=="string"){let s=t.params;if(t.params.includes("${")){let r=(i=t.params.match(/\$\{([^}]+)\}/g))==null?void 0:i.map(o=>o.slice(2,-1));r&&(r==null||r.forEach(o=>{s=s.replace(`\${${o}}`,e[o])}))}Object.keys(t.extend).forEach(r=>{["x","y","width","height"].includes(r)||(s.indexOf("?")!==-1?s+=`&${r}=${t.extend[r]}`:s+=`?${r}=${t.extend[r]}`)});let a=this.getEventData(t.list,e);Object.keys(a).length&&(a=null),this.canvas.dialog.show(t.value,s,t.extend,a)}},this.events[EventAction.SendData]=(e,t)=>{var s,a,r,o;if((s=t.data)!=null&&s.length){const n=this.getSendData(t.data);e.formId&&e.formData&&Object.assign(n,e.formData),this.sendDataToNetWork(n,e,t);return}if((a=t.list)!=null&&a.length){if(t.network&&t.network.protocol==="ADIIOT"){const l=getSendData(this,e,t);l.length&&sendJetLinksData(this,l);return}const n=this.getEventData(t.list,e);e.deviceId&&(n.deviceId=e.deviceId),e.formId&&e.formData&&Object.assign(n,e.formData),this.sendDataToNetWork(n,e,t);return}const i=deepClone(t.value);if(i&&typeof i=="object"&&t.targetType==="id"){const n=t.params?this.findOne(t.params):e;for(let l in i)if(i[l]===void 0||i[l]==="")i[l]=n[l];else if(typeof i[l]=="string"&&((r=i[l])==null?void 0:r.indexOf("${"))>-1){let c=(o=i[l].match(/\$\{([^}]+)\}/g))==null?void 0:o.map(h=>h.slice(2,-1));c!=null&&c.length&&(i[l]=n[c[0]]??this.getDynamicParam(c[0]))}n.deviceId&&(i.deviceId=n.deviceId),this.sendDataToNetWork(i,e,t);return}},this.events[EventAction.PostMessage]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] Emit value must be a string");return}const i=t.params?this.findOne(t.params):e;if(i.name!=="iframe"||!i.iframe){console.warn("不是嵌入页面");return}let s=queryURLParams(i.iframe.split("?")[1]);const a=this.getEventData(t.list,i);i.calculative.singleton.div.children[0].contentWindow.postMessage(JSON.stringify({name:t.value,id:s.id,data:a}),"*")},this.events[EventAction.PostMessageToParent]=(e,t)=>{if(typeof t.value!="string"){console.warn("[meta2d] Emit value must be a string");return}const i=this.getEventData(t.list,e);window.parent.postMessage(JSON.stringify({name:t.value,data:i}),"*")},this.events[EventAction.Message]=(e,t)=>{this.message({theme:t.params,content:t.value,...t.extend})}}getSendData(e){const t={};return e.forEach(i=>{var s;if(i.prop)if(i.id&&i.id!=="固定值"){const a=this.findOne(i.id);t[i.prop]=a[i.key]}else if(typeof i.value=="string"&&i.value.includes("${")){let a=i.value,r=(s=a.match(/\$\{([^}]+)\}/g))==null?void 0:s.map(o=>o.slice(2,-1));r&&r.forEach(o=>{a=a.replace(`\${${o}}`,this.getDynamicParam(o))}),t[i.prop]=a}else t[i.prop]=this.convertType(i.value,i.type)}),t}convertType(e,t){if(typeof e=="string"){if(["switch","bool","boolean"].includes(t)){if(e==="false")return!1;if(e==="true")return!0}else if(["integer","number","int","enum","double","float"].includes(t)&&!isNaN(Number(e)))return Number(e)}return e}getEventData(e,t){const i={};return e!=null&&e.length&&e.forEach(s=>{var r,o;const a=s.params?this.findOne(s.params):t;for(let n in s.value)if(s.value[n]===void 0||s.value[n]==="")i[n]=a[n];else if(typeof s.value[n]=="string"&&((r=s.value[n])==null?void 0:r.indexOf("${"))>-1){let l=(o=s.value[n].match(/\$\{([^}]+)\}/g))==null?void 0:o.map(c=>c.slice(2,-1));l!=null&&l.length&&(i[n]=a[l[0]]??this.getDynamicParam(l[0]))}else i[n]=s.value[n]}),Object.keys(i).length?i:{}}message(e){new Message(this.canvas.parentElement,e).init()}closeAll(){for(let e in messageList)messageList[e].close()}async navigatorTo(e){var s;if(!e)return;if((s=queryURLParams())==null?void 0:s.id){const a=new URL(window.location);a.searchParams.set("id",e),history.pushState({},"",a)}const i=await getMeta2dData(this.store,e);i&&(this.open(i),this.lock(1),this.fitView(!0,10))}doSendDataEvent(e,t){let i=JSON.stringify(e);this.mqttClient&&this.mqttClient.connected&&(t?t.split(",").forEach(s=>{this.mqttClient.publish(s,i)}):this.store.data.mqttTopics&&this.store.data.mqttTopics.split(",").forEach(s=>{this.mqttClient.publish(s,i)})),this.websocket&&this.websocket.readyState===1&&this.websocket.send(i),(this.store.data.https||this.store.data.http)&&this.sendDatabyHttp(i),this.store.emitter.emit("sendData",i)}async sendDataToNetWork(e,t,i){var a,r,o,n,l,c;const s=deepClone(i.network);if(s.data&&(Object.assign(s,s.data),delete s.data),s.protocol==="iot"){this.iotMqttClient&&this.iotMqttClient.publish(`le5le-iot/property/set/${(a=this.store.data.iot)==null?void 0:a.token}`,JSON.stringify(e));return}if(s.url){if(s.protocol==="http"){if(typeof s.headers=="object"){for(let u in s.headers)if(typeof s.headers[u]=="string"){let v=(r=s.headers[u].match(/\$\{([^}]+)\}/g))==null?void 0:r.map(y=>y.slice(2,-1));v&&(s.headers[u]=s.headers[u].replace(`\${${v[0]}}`,this.getDynamicParam(v[0])))}}let h,d=s.url;if(s.method==="GET"&&(h="?"+Object.keys(e).map(u=>u+"="+e[u]).join("&")),s.method==="POST"&&d.indexOf("${")>-1){let u=(o=d.match(/\$\{([^}]+)\}/g))==null?void 0:o.map(v=>v.slice(2,-1));u&&u.forEach(v=>{d=d.replace(`\${${v}}`,getter(t,v)||this.getDynamicParam(v))})}const f=await fetch(d+(h||""),{headers:s.headers||{},method:s.method,body:s.method==="POST"?JSON.stringify(e):void 0});if(f.ok){if(i.callback){const u=await f.text();if(!i.fn)try{if(typeof i.callback!="string")throw new Error("[meta2d] Function callback must be string");const v=i.callback;i.fn=new Function("pen","data","context",v)}catch(v){console.error("[meta2d]: Error on make a function:",v)}(n=i.fn)==null||n.call(i,t,u,{meta2d:this,e:i})}console.info("http消息发送成功")}}else if(s.protocol==="mqtt"){const h=(l=this.mqttClients)==null?void 0:l.filter(d=>d.options.href===s.url);if(h&&h.length)h[0].connected&&s.topics.split(",").forEach(d=>{h[0].publish(d,JSON.stringify(e))});else{let d=mqtt_minExports.connect(s.url,s.options);d.on("connect",()=>{console.info("mqtt连接成功"),s.topics.split(",").forEach(f=>{d.publish(f,JSON.stringify(e)),setTimeout(()=>{d==null||d.end()},1e3)})})}}else if(s.protocol==="websocket"){const h=(c=this.websockets)==null?void 0:c.filter(d=>d.url===s.url);if(h&&h.length)h[0].readyState===1&&h[0].send(JSON.stringify(e));else{let d=new WebSocket(s.url,s.protocols||void 0);d.onopen=function(){console.info("websocket连接成功"),d.send(JSON.stringify(e)),setTimeout(()=>{d.close()},100)}}}}}resize(e,t){this.canvas.resize(e,t),this.render(),this.store.emitter.emit("resize",{width:e,height:t}),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}async addPen(e,t,i=!0,s=!1){return await this.canvas.addPen(e,t,i,s)}async addPens(e,t,i=!1){return await this.canvas.addPens(e,t,i)}render(e){var t;(t=this.canvas)==null||t.render(e)}async setBackgroundImage(e,t){var o,n,l,c;let i=this;async function s(h){return new Promise(d=>{const f=new Image;f.src=h,i.store.options.cdn&&!(h.startsWith("http")||h.startsWith("//")||h.startsWith("data:image"))&&(f.src=i.store.options.cdn+h),f.crossOrigin="anonymous",f.onload=()=>{d(f)}})}this.store.data.bkImage=e;const a=(t==null?void 0:t.width)||((o=this.store.data)==null?void 0:o.width)||((n=this.store.options)==null?void 0:n.width),r=(t==null?void 0:t.height)||((l=this.store.data)==null?void 0:l.height)||((c=this.store.options)==null?void 0:c.height);if(a&&r?(this.canvas.canvasTemplate.canvas.style.backgroundImage=null,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)):this.canvas.canvasTemplate.canvas.style.backgroundImage=e?`url('${e}')`:"",e){const h=await s(e);this.store.bkImg=h,a&&r&&this.canvas&&(this.canvas.canvasTemplate.init(),this.render())}else this.store.bkImg=null}setBackgroundColor(e=this.store.data.background){this.store.data.background=e,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setGrid({grid:e=this.store.data.grid,gridColor:t=this.store.data.gridColor,gridSize:i=this.store.data.gridSize,gridRotate:s=this.store.data.gridRotate}={}){this.store.data.grid=e,this.store.data.gridColor=t,this.store.data.gridSize=i<0?0:i,this.store.data.gridRotate=s,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setRule({rule:e=this.store.data.rule,ruleColor:t=this.store.data.ruleColor}={}){this.store.data.rule=e,this.store.data.ruleColor=t,this.store.patchFlagsTop=!0}open(e,t=!0){if(this.clear(!1,e==null?void 0:e.template),this.canvas.autoPolylineFlag=!0,e){e.theme&&this.setTheme(e.theme),this.setBackgroundImage(e.bkImage,e),Object.assign(this.store.data,e),this.store.data.pens=[];for(const i of e.pens)i.id||(i.id=s8()),!i.calculative&&(i.calculative={canvas:this.canvas}),this.store.pens[i.id]=i;for(const i of e.pens)this.canvas.makePen(i)}if(this.canvas.patchFlagsLines.forEach(i=>{i.type&&this.canvas.initLineRect(i)}),this.store.data.template||(this.store.data.template=s8()),t||(this.canvas.opening=!0),this.doInitJS(),this.initBindDatas(),this.initBinds(),this.doInitFn(),this.loadLineAnimateDraws(),this.initMessageEvents(),this.initGlobalTriggers(),this.startAnimate(),this.startVideo(),this.listenSocket(),this.connectSocket(),this.connectNetwork(),this.startDataMock(),this.canvas.initGlobalStyle(),this.render(),setTimeout(()=>{const i=this.store.data.pens.find(s=>s.autofocus);i&&this.focus(i.id)},100),this.store.data.iconUrls)for(const i of this.store.data.iconUrls)loadCss(i,()=>{this.render()});this.canvas.autoPolylineFlag=!1,this.store.emitter.emit("opened"),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}cacheData(e){if(e&&this.store.options.cacheLength){let t=this.store.cacheDatas.findIndex(i=>i.data&&i.data._id===e);if(t===-1)this.store.cacheDatas.push({data:deepClone(this.store.data,!0)}),this.store.cacheDatas.length>this.store.options.cacheLength&&this.store.cacheDatas.shift();else{let i=this.store.cacheDatas.splice(t,1)[0];this.store.cacheDatas.push(i)}}}loadCacheData(e){let t=this.store.cacheDatas.findIndex(i=>i.data&&i.data._id===e);t!==-1&&(this.store.data=this.store.cacheDatas[t].data,this.setBackgroundImage(this.store.data.bkImage),this.store.pens={},this.store.data.pens.forEach(i=>{i.calculative.canvas=this.canvas,this.store.pens[i.id]=i,globalStore.path2dDraws[i.name]&&this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),i.type&&this.store.path2dMap.set(i,globalStore.path2dDraws[i.name](i)),i.image&&(i.calculative.imageDrawed=!1,this.canvas.loadImage(i))}),this.render())}loadLineAnimateDraws(){globalStore.lineAnimateDraws={},Object.entries(this.store.data.lineAnimateDraws).forEach(([key,drawFunc])=>{globalStore.lineAnimateDraws[key]=eval(drawFunc)})}statistics(){const e=this.store.data.pens.length,t=this.store.data.pens.filter(o=>o.image).length,i=this.store.data.pens.filter(o=>o.image&&o.calculative.inView).length,s=this.store.data.pens.filter(o=>o.name.endsWith("Dom")||isDomShapes.includes(o.name)||this.store.options.domShapes.includes(o.name)||o.externElement).length,a=this.store.animates.size;let r=0;return Object.keys(this.store.bind).forEach(o=>{r+=this.store.bind[o].length}),Object.keys(this.store.bindDatas).forEach(o=>{r+=this.store.bindDatas[o].length}),{图元总数量:e,图片图元数量:t,图片图元绘制数量:i,dom图元数量:s,正在执行的动画数量:a,数据点数量:r}}initBindDatas(){this.store.bindDatas={},this.store.data.pens.forEach(e=>{var t;(t=e.form)==null||t.forEach(i=>{let s;i.dataIds&&(Array.isArray(i.dataIds)?s=i.dataIds:s=[i.dataIds]),s==null||s.forEach(a=>{this.store.bindDatas[a.dataId]||(this.store.bindDatas[a.dataId]=[]),this.store.bindDatas[a.dataId].push({id:e.id,formItem:i})})})})}initBinds(){this.jetLinksList=[],this.store.bind={};const e=[],t=[];this.store.data.pens.forEach(i=>{var s,a;(s=i.realTimes)==null||s.forEach(r=>{if(r.bind&&r.bind.id){let o=r.productId||i.productId,n=r.deviceId||i.deviceId,l=r.propertyId,c=!1;if(o&&o.indexOf("${")>-1){let h=o.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));h!=null&&h.length&&(o=this.getDynamicParam(h[0])||o),c=!0}if(n&&n.indexOf("${")>-1){let h=n.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));h!=null&&h.length&&(n=this.getDynamicParam(h[0])||n),c=!0}if(l&&l.indexOf("${")>-1){let h=l.match(new RegExp("(?<=\\$\\{).*?(?=\\})","g"));h!=null&&h.length&&(l=this.getDynamicParam(h[0])||l),c=!0}if(c&&r.bind&&(r.bind.id=o+"#"+n+"#"+l),this.store.bind[r.bind.id]||(this.store.bind[r.bind.id]=[]),this.store.bind[r.bind.id].push({id:i.id,key:r.key}),o&&n&&l){const h=this.jetLinksList.findIndex(d=>d.topic.startsWith(`/${o}/${n}`));h>-1?this.jetLinksList[h].properties.includes(r.propertyId)||this.jetLinksList[h].properties.push(r.propertyId):this.jetLinksList.push({topic:`/${o}/${n}`,deviceId:n,properties:[r.propertyId]})}if(r.bind.class==="iot"){let h=r.bind.id.split("#"),d=e.findIndex(u=>u.deviceId===h[0]);d>-1?e[d].properties.includes(h[1])||e[d].properties.push(h[1]):e.push({deviceId:h[0],properties:[h[1]],token:r.bind.token}),t.findIndex(u=>u.key===r.bind.id)===-1&&t.push({key:r.bind.id,label:r.bind.label})}else if(r.bind.class==="sql"){let h=r.bind.id.split("#");const d=this.store.data.sqls.find(f=>f.bindId===h[0]);if(d){d.keys||(d.keys=[]),h.shift();const f=h.join("#");d.keys.includes(f)||d.keys.push(f)}}}}),(a=i.events)==null||a.forEach(r=>{var n;const o=(n=r.actions)==null?void 0:n.filter(l=>l.action===EventAction.SendData);o==null||o.forEach(l=>{var c;(c=l.data)==null||c.forEach(h=>{if(h.class==="iot"){let d=h.prop.split("#"),f=e.findIndex(u=>u.deviceId===d[0]);f>-1?e[f].properties.includes(d[1])||e[f].properties.push(d[1]):e.push({deviceId:d[0],properties:[d[1]],token:h.token})}})})})}),e.length&&(this.store.data.iot||(this.store.data.iot={}),this.store.data.iot.devices=e),t.length&&(this.store.data.iot.list=t)}connectSocket(){this.connectWebsocket(),this.connectMqtt(),this.connectHttp()}doInitJS(){const e=this.store.data.initJs;if(e&&e.trim())try{new Function("context",e)({meta2d:this})}catch(t){console.warn("initJs error",t)}}doInitFn(){let e=queryURLParams(),t=[];for(let i in e)e.hasOwnProperty(i)&&i.startsWith("bind-")&&t.push({id:i.replace("bind-",""),dataId:i.replace("bind-",""),value:e[i]});t.length&&this.setDatas(t,{history:!1})}drawLine(e){e&&lockedError(this.store),this.canvas.drawingLineName=e}alignPenToGrid(e){this.canvas.alignPenToGrid(e)}drawingPencil(){this.canvas.drawingPencil()}stopPencil(){this.canvas.stopPencil()}lock(e){this.store.data.locked=e,this.finishDrawLine(!0),this.canvas.drawingLineName="",this.stopPencil(),this.store.data.pens.forEach(t=>{var i;t.externElement===!0&&(i=t.calculative.singleton)!=null&&i.div&&setElemPosition(t,t.calculative.singleton.div)}),e>0&&this.initMessageEvents()}async finishDrawLine(e){await this.canvas.finishDrawline(e)}async finishPencil(){await this.canvas.finishPencil()}updateLineType(e,t){if(!e||e.name!="line"||!t||!this.canvas[t])return;e.lineName=t;const i=getFromAnchor(e),s=getToAnchor(e);i.prev=void 0,i.next=void 0,s.prev=void 0,s.next=void 0,e.calculative.worldAnchors=[i,s],e.calculative.activeAnchor=i,this.canvas[t](this.store,e,s),e.lineName==="curve"&&(i.prev={penId:i.penId,x:i.x-50,y:i.y},i.next={penId:i.penId,x:i.x+50,y:i.y},s.prev={penId:s.penId,x:s.x-50,y:s.y},s.next={penId:s.penId,x:s.x+50,y:s.y}),e.calculative.activeAnchor=void 0,this.canvas.initLineRect(e),this.render()}addDrawLineFn(e,t){this.canvas[e]=t,this.canvas.drawLineFns.push(e)}removeDrawLineFn(e){const t=this.canvas.drawLineFns.indexOf(e);t>-1&&this.canvas.drawLineFns.splice(t,1)}showMagnifier(){this.canvas.showMagnifier()}hideMagnifier(){this.canvas.hideMagnifier()}toggleMagnifier(){this.canvas.toggleMagnifier()}clear(e=!0,t){var i;for(const s of this.store.data.pens)(i=s.onDestroy)==null||i.call(s,s);clearStore(this.store,t),this.hideInput(),this.canvas.tooltip.hide(),this.map&&this.map.isShow&&(this.map.show(),this.map.setView()),this.canvas.clearCanvas(),sessionStorage.removeItem("page"),this.store.clipboard=void 0,this.store.sameTemplate||(this.canvas.canvasTemplate.bgPatchFlags=!0),this.store.patchFlagsBackground=!0,this.store.patchFlagsTop=!0,this.setBackgroundImage(void 0),e&&this.render()}emit(e,t){this.store.emitter.emit(e,t)}on(e,t){return this.store.emitter.on(e,t),this}off(e,t){return this.store.emitter.off(e,t),this}updateLineAnimateDraws(e,t){t&&(delete this.store.data.lineAnimateDraws[e],delete globalStore.lineAnimateDraws[e],t!==-1&&this.registerLineAnimateDraws(t.name||e,t.code))}registerMoveDock(e){this.canvas.customMoveDock=e}registerResizeDock(e){this.canvas.customResizeDock=e}find(e){return this.canvas.find(e)}findOne(e){return this.canvas.findOne(e)}getPenRect(e){return this.canvas.getPenRect(e)}setPenRect(e,t,i=!0){this.canvas.setPenRect(e,t,i)}startAnimate(e,t){this.stopAnimate(e);let i;e?typeof e=="string"?i=this.find(e):i=e:i=this.store.data.pens.filter(s=>(s.type||s.frames)&&s.autoPlay||s.animations&&s.animations.length&&s.animations.findIndex(a=>a.autoPlay)!==-1),i.length&&(i.forEach(s=>{var a,r;if(s.calculative.pause){const o=Date.now()-s.calculative.pause;s.calculative.pause=void 0,s.calculative.frameStart+=o,s.calculative.frameEnd+=o}else{let o=-1;if(t!==void 0&&s.animations){if(typeof t=="string"){if(o=s.animations.findIndex(n=>n.name===t),o===-1)return}else if(typeof t=="number")if(s.animations.length>t)o=t;else return}else t===void 0&&(o=(a=s.animations)==null?void 0:a.findIndex(n=>n.autoPlay),o===-1&&((r=s.animations)!=null&&r.length)&&(o=0));if(o!==-1&&o!==void 0){const n=deepClone(s.animations[o]);n.animateName=n.name,delete n.name,n.currentAnimation=o,!s.type&&n.frames&&(n.showDuration=this.calcAnimateDuration(n)),this.setValue({id:s.id,...n},{doEvent:!1,history:!1})}this.store.animates.add(s),s.type||this.store.animateMap.set(s,s.calculative.canvas.getFrameProps(s))}}),this.initImageCanvas(i),this.canvas.animate())}pauseAnimate(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:this.store.animates.forEach(i=>{t.push(i)}),t.forEach(i=>{i.calculative.pause||(i.calculative.pause=Date.now())})}stopAnimate(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:this.store.animates.forEach(i=>{t.push(i)}),t.forEach(i=>{i.currentAnimation=void 0,i.calculative.pause=void 0,i.calculative.start=void 0,i.calculative.cycleStart=void 0,i.calculative.duration=void 0,i.calculative.animatePos=0,this.store.animates.delete(i),this.canvas.restoreNodeAnimate(i),this.canvas.updateLines(i),this.store.animateMap.delete(i)}),this.initImageCanvas(t),setTimeout(()=>{var i;(i=this.canvas)==null||i.calcActiveRect(),this.render()},20)}startVideo(e){let t;e?typeof e=="string"?t=this.find(e):t=e:t=this.store.data.pens.filter(i=>(i.video||i.audio)&&i.autoPlay),t.forEach(i=>{var s,a;(s=i.calculative.media)==null||s.play(),(a=i.onStartVideo)==null||a.call(i,i)})}pauseVideo(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:t=this.store.data.pens.filter(i=>(i.video||i.audio)&&i.autoPlay),t.forEach(i=>{var s,a;(s=i.calculative.media)==null||s.pause(),(a=i.onPauseVideo)==null||a.call(i,i)})}stopVideo(e){let t=[];e?typeof e=="string"?t=this.find(e):t=e:t=this.store.data.pens.filter(i=>(i.video||i.audio)&&i.autoPlay),t.forEach(i=>{var s;i.calculative.media&&(i.calculative.media.currentTime=0,i.calculative.media.pause()),(s=i.onStopVideo)==null||s.call(i,i)})}calcAnimateDuration(e){return e.frames.reduce((t,i)=>t+i.duration,0)}combine(e=this.store.active,t,i=!0){if(!e||!e.length)return;const s=deepClone(e);if(e.length===1&&e[0].type){e[0].type=PenType.Node,this.canvas.active(e),this.pushHistory({type:EditType.Update,initPens:s,pens:deepClone(e,!0)}),this.render();return}const a=getRect$1(e);let r={id:s8(),name:"combine",...a,children:[],showChild:t};this.canvas.makePen(r);const o=deepClone(r);let n=1/0;return e.forEach(l=>{const c=this.store.data.pens.findIndex(d=>d.id===l.id);if(c<n&&(n=c),l===r||l.parentId===r.id||l.id===r.id)return;r.children.push(l.id),l.parentId=r.id;const h=calcRelativeRect(l.calculative.worldRect,a);Object.assign(l,h),l.locked=l.lockedOnCombine??LockState.None,l.locked=l.interaction||isInteraction.includes(l.name)?0:l.locked}),this.store.data.pens.splice(n,0,r),this.store.data.pens.pop(),i&&this.canvas.active([r]),this.pushHistory({type:EditType.Add,pens:[o],step:3}),this.pushHistory({type:EditType.Update,initPens:[o],pens:[r],step:3}),this.pushHistory({type:EditType.Update,initPens:s,pens:e,step:3}),t!=null&&(e.forEach(l=>{calcInView(l,!0)}),this.initImageCanvas([r])),this.store.emitter.emit("combine",[r]),this.render(),r}uncombine(e){if(!e&&this.store.active&&(e=this.store.active[0]),!e||!e.children)return;const t=e.children.map(a=>this.store.pens[a]);let i=deepClone(t);t.forEach(a=>{a.parentId=void 0,a.x=a.calculative.worldRect.x,a.y=a.calculative.worldRect.y,a.width=a.calculative.worldRect.width,a.height=a.calculative.worldRect.height,a.locked=LockState.None,a.calculative.active=void 0,a.calculative.hover=!1,this.setVisible(a,!0)});const s=this.isCombine(e)?3:2;this.pushHistory({type:EditType.Update,initPens:i,pens:t,step:s}),i=[deepClone(e)],e.children=void 0,this.pushHistory({type:EditType.Update,initPens:i,pens:[e],step:s}),this.isCombine(e)&&(this.delete([e]),this.store.histories[this.store.histories.length-1].step=s),this.inactive()}clearCombine(e){if(!e&&this.store.active&&(e=this.store.active[0]),!e||!e.children)return;const t=getAllChildren(e,this.store);t.forEach(s=>{s.parentId=void 0,s.x=s.calculative.worldRect.x,s.y=s.calculative.worldRect.y,s.width=s.calculative.worldRect.width,s.height=s.calculative.worldRect.height,s.locked=LockState.None,s.calculative.active=void 0,s.calculative.hover=!1,s.showChild!==void 0&&this.setVisible(s,!0),s.children=void 0});const i=[];t.forEach((s,a)=>{s.name==="combine"&&(s.children=void 0,i.push(s))}),this.delete(i,!0,!1),e.children=void 0,this.isCombine(e)&&this.delete([e],!0,!1),this.inactive()}appendChild(e=this.store.active){if(!e||e.length<2)return;const t=e.findIndex(i=>i.name==="combine"&&i.showChild!==void 0);if(t!==-1){let i=e[t];const s=getRect$1(e);Object.assign(i,s),Object.assign(i.calculative.worldRect,s),calcWorldAnchors(i),i.children.forEach(a=>{const r=this.store.pens[a],o=calcRelativeRect(r.calculative.worldRect,s);Object.assign(r,o)}),e.forEach(a=>{if(a.id!==i.id){i.children.push(a.id),a.parentId=i.id;const r=calcRelativeRect(a.calculative.worldRect,s);Object.assign(a,r),a.locked=a.lockedOnCombine??LockState.DisableMove,a.locked=a.interaction||isInteraction.includes(a.name)?0:a.locked,calcInView(a,!0)}}),this.initImageCanvas(e),this.render()}else console.warn("Invalid operation!")}updateRectbyChild(e,t,i){if(calcRightBottom(e),calcCenter(e),t.calculative.worldRect=e,rectInRect(e,i.calculative.worldRect,!0)){const s=calcRelativeRect(e,i.calculative.worldRect);Object.assign(t,s)}else{let s=Math.min(e.x,i.calculative.worldRect.x),a=Math.min(e.y,i.calculative.worldRect.y),r=Math.max(e.ex,i.calculative.worldRect.ex),o=Math.max(e.ey,i.calculative.worldRect.ey);i.calculative.worldRect={x:s,y:a,width:r-s,height:o-a,ex:r,ey:o},i.parentId||Object.assign(i,i.calculative.worldRect),calcCenter(i.calculative.worldRect),i.children.forEach(n=>{const l=this.store.pens[n],c=calcRelativeRect(l.calculative.worldRect,i.calculative.worldRect);Object.assign(l,c)}),i.parentId&&this.updateRectbyChild(i.calculative.worldRect,i,this.store.pens[i.parentId])}this.canvas.updatePenRect(i),this.render()}isCombine(e){return!!(e.name==="combine"||e.children&&e.children.length>0)}active(e,t=!0){this.canvas.active(e,t)}inactive(){this.canvas.inactive()}activeAll(){this.canvas.active(this.store.data.pens.filter(e=>!e.parentId&&e.locked!==LockState.Disable)),this.render()}focus(e){const t=this.findOne(e);t&&(this.store.hover=t,this.store.hover.calculative.hover=!0,this.showInput(t))}delete(e,t=!1,i=!0){this.canvas.delete(e,t,i)}scale(e,t={x:0,y:0}){this.canvas.scale(e,t)}translate(e,t){this.canvas.translate(e,t)}translatePens(e,t,i){this.canvas.translatePens(e,t,i)}getParent(e,t){return getParent(e,t)}getAllChildren(e){return getAllChildren(e,this.store)}getAllFollowers(e){return getAllFollowers(e,this.store)}data(){const e=deepClone(this.store.data),{pens:t,paths:i}=this.store.data;e.version=pkg.version,e.paths={};for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&t.find(a=>a.pathId===s)&&(e.paths[s]=i[s]);return e.dataPoints=[...Object.keys(this.store.bind),...Object.keys(this.store.bindDatas)],Object.entries(globalStore.lineAnimateDraws).forEach(([s,a])=>{e.lineAnimateDraws[s]=a.toString()}),e}copy(e){this.canvas.copy(e)}cut(e){this.canvas.cut(e)}paste(){this.canvas.paste()}undo(){this.canvas.undo()}redo(){this.canvas.redo()}listenSocket(){try{let e;const t=this.store.data.socketCbJs;if(t&&(e=new Function("e","context",t)),!e)return this.socketFn=null,!1;this.socketFn=e}catch(e){return console.error("Create the function for socket:",e),!1}return!0}connectWebsocket(e){this.closeWebsocket(),e&&(this.store.data.websocket=e),this.store.data.websocket&&(this.websocket=new WebSocket(this.store.data.websocket,this.store.data.websocketProtocols||void 0),this.websocket.onmessage=t=>{this.socketCallback(t.data,{type:"websocket",url:this.store.data.websocket})},this.websocket.onerror=t=>{this.store.emitter.emit("error",{type:"websocket",error:t})},this.websocket.onclose=()=>{if(this.store.options.reconnetTimes&&(this.websocketTimes++,this.websocketTimes>=this.store.options.reconnetTimes)){this.websocketTimes=0,this.closeWebsocket();return}console.info("Canvas websocket closed and reconneting..."),this.connectWebsocket()})}closeWebsocket(){this.websocket&&(this.websocket.onclose=void 0,this.websocket.close(),this.websocket=void 0)}connectMqtt(e){if(this.closeMqtt(),e&&(this.store.data.mqtt=e.mqtt,this.store.data.mqttTopics=e.mqttTopics,this.store.data.mqttOptions=e.mqttOptions),this.store.data.mqtt){this.store.data.mqttOptions.clientId&&!this.store.data.mqttOptions.customClientId&&(this.store.data.mqttOptions.clientId=s8());const t={...this.store.data.mqttOptions};t.username||delete t.username,t.password||delete t.password;const{username:i,password:s}=t;i&&s||!i&&!s?(this.mqttClient=mqtt_minExports.connect(this.store.data.mqtt,t),this.mqttClient.on("message",(a,r)=>{this.socketCallback(r.toString(),{topic:a,type:"mqtt",url:this.store.data.mqtt})}),this.mqttClient.on("error",a=>{this.store.emitter.emit("error",{type:"mqtt",error:a})}),this.mqttClient.on("close",()=>{this.store.options.reconnetTimes&&(this.mqttTimes++,this.mqttTimes>=this.store.options.reconnetTimes&&(this.mqttTimes=0,this.closeMqtt()))}),this.store.data.mqttTopics&&this.mqttClient.subscribe(this.store.data.mqttTopics.split(","))):console.warn("缺少用户名或密码")}}closeMqtt(){var e;(e=this.mqttClient)==null||e.end()}connectHttp(){this.closeHttp();const{https:e}=this.store.data;if(e)this.store.data.cancelFirstConnect||e.forEach(async t=>{this.oldRequestHttp(t)}),e.forEach((t,i)=>{t.http&&t.httpTimeInterval!==0&&(t.times=0,this.httpTimerList[i]=setInterval(async()=>{this.oldRequestHttp(t),this.store.options.reconnetTimes&&t.times>=this.store.options.reconnetTimes&&(t.times=0,clearInterval(this.httpTimerList[i]),this.httpTimerList[i]=void 0)},t.httpTimeInterval||1e3))});else{const{http:t,httpTimeInterval:i,httpHeaders:s}=this.store.data;t&&(this.httpTimer=setInterval(async()=>{const a=await fetch(t,{headers:s});if(a.ok){const r=await a.text();this.socketCallback(r,{type:"http",url:t})}},i||1e3))}}async oldRequestHttp(e){let t=deepClone(e);if(t.http){const i=await fetch(t.http,{headers:t.httpHeaders,method:t.method||"GET",body:t.method==="POST"?JSON.stringify(t.body):void 0});if(i.ok){const s=await i.text();this.socketCallback(s,{type:"http",url:t.http})}else e.times++,this.store.emitter.emit("error",{type:"http",error:i})}}async sendDatabyHttp(e){const{https:t}=this.store.data;if(t)t.forEach(async i=>{i.http&&(await fetch(i.http,{method:"post",body:e,headers:i.httpHeaders})).ok&&console.info("http消息发送成功")});else{const{http:i,httpHeaders:s}=this.store.data;i&&(await fetch(i,{method:"post",body:e,headers:s})).ok&&console.info("http消息发送成功")}}closeHttp(){clearInterval(this.httpTimer),this.httpTimer=void 0,this.httpTimerList&&this.httpTimerList.forEach(e=>{clearInterval(e),e=void 0})}connectNetwork(){this.closeNetwork();const{networks:e}=this.store.data,t=[];if(e){let i=0,s=0,a=0,r=0;this.mqttClients=[],this.websockets=[],this.eventSources=[],e.forEach(async o=>{o.protocol==="mqtt"?(o.index=i,this.connectNetMqtt(o),i+=1):o.protocol==="websocket"?(o.index=a,this.connectNetWebSocket(o),a+=1):o.protocol==="http"?(o.index=s,t.push({url:o.url,interval:o.interval,headers:o.headers||void 0,method:o.method,body:o.body}),s+=1):o.protocol==="ADIIOT"?connectJetLinks(this,o):o.protocol==="SSE"&&(o.index=r,this.connectSSE(o),r+=1)})}this.onNetworkConnect(t),this.connectIot(),this.connectSqls()}reconnectNetwork(e){var i,s;const t=this.store.data.networks[e];if(t.protocol==="mqtt")this.mqttClients&&((i=this.mqttClients[t.index])==null||i.end()),this.connectNetMqtt(t);else if(t.protocol==="websocket")this.websockets&&this.websockets[t.index]&&(this.websockets[t.index].onclose=void 0,this.websockets[t.index].close(),this.websockets[t.index]=void 0),this.connectNetWebSocket(t);else if(t.protocol==="http"){this.updateTimerList&&(clearInterval(this.updateTimerList[t.index]),this.updateTimerList[t.index]=void 0);const a=deepClone(t);this.store.data.cancelFirstConnect||this.requestHttp(a),this.updateTimerList[t.index]=setInterval(async()=>{this.requestHttp(a)},a.interval||1e3)}else t.protocol==="SSE"&&(this.eventSources&&((s=this.eventSources[t.index])==null||s.close(),this.eventSources[t.index]=void 0),this.connectSSE(t))}async connectIot(){var s;const{iot:e}=this.store.data;if(!(e&&((s=e==null?void 0:e.devices)!=null&&s.length)))return;const t=globalThis.iotUrl||await this.getMqttUrl();if(!t){console.warn("iot Request address error");return}const i=await this.getIotToken(e.devices,e.protocol==="websocket"?1:void 0);e.token=i,this.iotMqttClient=mqtt_minExports.connect(t),this.iotMqttClient.on("message",(a,r)=>{this.socketCallback(r.toString(),{topic:`le5le-iot/properties/${i}`,type:"iot",url:t,method:"mqtt"})}),this.iotMqttClient.on("error",a=>{this.store.emitter.emit("error",{type:"mqtt",error:a})}),this.iotMqttClient.subscribe(`le5le-iot/properties/${i}`),this.iotTimer=setInterval(()=>{this.iotMqttClient&&this.iotMqttClient.publish("le5le-iot/subscribe/ping",i)},3e5)}connectSqls(){const{sqls:e}=this.store.data;if(e&&e.length){let t=0;e.forEach(async i=>{await this.doSqlCode(i),i.interval&&(i.index=t,this.sqlTimerList[t]=setInterval(async()=>{await this.doSqlCode(i)},i.interval),t+=1)})}}connectSSE(e){this.eventSources[e.index]=new EventSource(e.url,{withCredentials:e.withCredentials}),this.eventSources[e.index].onmessage=t=>{this.socketCallback(t.data,{type:"SSE",url:e.url,name:e.name})},this.eventSources[e.index].onerror=t=>{this.store.emitter.emit("error",{type:"SSE",error:t})}}closeSSE(){this.eventSources&&this.eventSources.forEach(e=>{e&&(e.close(),e=void 0)})}connectNetMqtt(e){var s,a,r,o;e.options.clientId&&!e.options.customClientId&&(e.options.clientId=s8());let t=e.url;if(t.indexOf("${")>-1){let n=(s=t.match(/\$\{([^}]+)\}/g))==null?void 0:s.map(l=>l.slice(2,-1));n&&n.forEach(l=>{t=t.replace(`\${${l}}`,this.getDynamicParam(l))})}e.times=0;let i=deepClone(e.options);if(i!=null&&i.username&&i.username.includes("${")){let n=(a=i.username.match(/\$\{([^}]+)\}/g))==null?void 0:a.map(l=>l.slice(2,-1));n&&n.forEach(l=>{i.username=i.username.replace(`\${${l}}`,this.getDynamicParam(l))})}if(i!=null&&i.password&&i.password.includes("${")){let n=(r=i.password.match(/\$\{([^}]+)\}/g))==null?void 0:r.map(l=>l.slice(2,-1));n&&n.forEach(l=>{i.password=i.password.replace(`\${${l}}`,this.getDynamicParam(l))})}if(this.mqttClients[e.index]=mqtt_minExports.connect(t,i),this.mqttClients[e.index].on("message",(n,l)=>{this.socketCallback(l.toString(),{topic:n,type:"mqtt",url:e.url,name:e.name})}),this.mqttClients[e.index].on("error",n=>{this.store.emitter.emit("error",{type:"mqtt",error:n})}),this.mqttClients[e.index].on("close",()=>{var n;this.store.options.reconnetTimes&&(e.times++,e.times>=this.store.options.reconnetTimes&&(e.times=0,this.mqttClients&&((n=this.mqttClients[e.index])==null||n.end())))}),e.topics){let n=e.topics;if(n.indexOf("${")>-1){let l=(o=n.match(/\$\{([^}]+)\}/g))==null?void 0:o.map(c=>c.slice(2,-1));l&&l.forEach(c=>{n=n.replace(`\${${c}}`,this.getDynamicParam(c))})}this.mqttClients[e.index].subscribe(n.split(","))}}connectNetWebSocket(e){var i,s;this.websockets[e.index]&&(this.websockets[e.index].onclose=void 0,(i=this.websockets[e.index])==null||i.close(),this.websockets[e.index]=void 0);let t=e.url;if(t.indexOf("${")>-1){let a=(s=t.match(/\$\{([^}]+)\}/g))==null?void 0:s.map(r=>r.slice(2,-1));a&&a.forEach(r=>{t=t.replace(`\${${r}}`,this.getDynamicParam(r))})}this.websockets[e.index]=new WebSocket(t,e.protocols||void 0),this.websockets[e.index].onmessage=a=>{this.socketCallback(a.data,{type:"websocket",url:e.url,name:e.name})},this.websockets[e.index].onerror=a=>{this.store.emitter.emit("error",{type:"websocket",error:a})},this.websockets[e.index].onclose=()=>{var a;if(this.store.options.reconnetTimes&&(e.times++,e.times>=this.store.options.reconnetTimes)){e.times=0,this.websockets[e.index].onclose=void 0,(a=this.websockets[e.index])==null||a.close(),this.websockets[e.index]=void 0;return}setTimeout(()=>{console.info("Canvas websocket closed and reconneting..."),this.connectNetWebSocket(e)},2e3)}}async getMqttUrl(){const e=await fetch("/api/iot/app/mqtt",{method:"GET",headers:{Authorization:`Bearer ${getToken()}`}});if(e.ok){const t=await e.text();let i=JSON.parse(t);return i.wssPort||i.wsPort?`${location.protocol==="https:"?"wss":"ws"}://${i.host}:${location.protocol==="https:"?i.wssPort:i.wsPort}${i.path}`:void 0}}async getIotToken(e,t){const i=await fetch("/api/iot/subscribe/properties",{method:"POST",headers:{Authorization:`Bearer ${getToken()}`},body:JSON.stringify({devices:e,type:t})});if(i.ok){const s=await i.text();return JSON.parse(s).token}}async doSqlCode(e){var a;const t=e.method||"get";let i=e.sql;t==="list"&&(i+=` LIMIT ${e.pageSize||20}`+(e.current>1?" OFFSET "+(e.current-1)*e.pageSize:""));const s=await fetch(`/api/iot/data/sql/${t}`,{method:"POST",headers:{Authorization:`Bearer ${getCookie("token")||localStorage.getItem("token")||new URLSearchParams(location.search).get("token")||""}`},body:JSON.stringify({dbid:e.dbid,sql:i})});if(s.ok){let r=await s.text();if(r){const o=[];r=JSON.parse(r),(a=e.keys)==null||a.forEach(n=>{o.push({id:e.bindId+"#"+n,value:getter(r,n.split("#").join("."))})}),o.push({id:e.bindId,value:r}),this.socketCallback(JSON.stringify(o),{type:"sql",url:`/api/iot/data/sql/${t}`,method:t})}}}randomString(e){e=e||32;let t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",i=t.length,s="";for(let a=0;a<e;a++)s+=t.charAt(Math.floor(Math.random()*i));return s}mockValue(e){let t;if(e.enableMock&&e.mock!==void 0)if(e.type==="float")if(e.mock&&e.mock.indexOf(",")!==-1){let i=e.mock.split(","),s=Math.floor(Math.random()*i.length);t=parseFloat(i[s])}else if(e.mock&&e.mock.indexOf("-")!==-1){let i,s,a,r=e.mock.split("-");if(e.mock.charAt(0)==="-"?r.length===4?(i=-parseFloat(r[3]),s=-parseFloat(r[1]),a=r[3]):(i=parseFloat(r[2]),s=-parseFloat(r[1]),a=r[2]):(i=parseFloat(r[1]),s=parseFloat(r[0]),a=r[1]),(a+"").indexOf(".")!==-1){let o=(a+"").split(".")[1].length;t=(Math.random()*(i-s)+s).toFixed(o)}else t=Math.random()*(i-s)+s}else t=parseFloat(e.mock);else if(e.type==="integer")if(e.mock&&e.mock.indexOf(",")!==-1){let i=e.mock.split(","),s=Math.floor(Math.random()*i.length);t=parseInt(i[s])}else if(e.mock&&e.mock.indexOf("-")!==-1){let i,s,a=e.mock.split("-");e.mock.charAt(0)==="-"?a.length===4?(i=-parseFloat(a[3]),s=-parseFloat(a[1])):(i=parseFloat(a[2]),s=-parseFloat(a[1])):(i=parseInt(a[1]),s=parseInt(a[0])),t=parseInt(Math.random()*(i-s)+s+"")}else t=parseInt(e.mock);else if(e.type==="bool")typeof e.mock=="boolean"?t=e.mock:e.mock==="true"?t=!0:e.mock==="false"?t=!1:t=Math.random()<.5;else if(e.type==="object"||e.type==="array")e.mock;else if(e.mock&&e.mock.indexOf(",")!==-1){let i=e.mock.split(","),s=Math.floor(Math.random()*i.length);t=i[s]}else if(e.mock&&e.mock.startsWith("[")&&e.mock.endsWith("]")){let i=parseInt(e.mock.substring(1,e.mock.length-1));t=this.randomString(i)}else t=e.mock;return t}dataMock(){var t,i;let e=[];(i=(t=this.store.data.dataset)==null?void 0:t.devices)==null||i.forEach(s=>{let a=this.mockValue(s);a!==void 0&&e.push({id:s.id,value:a})}),e.length&&this.setDatas(e,{render:!0,doEvent:!0,history:!1})}startDataMock(){this.store.data.enableMock&&(this.stopDataMock(),this.initBinds(),this.updateTimer=setInterval(()=>{this.store.data.pens.forEach(t=>{this.penMock(t)}),this.dataMock(),this.render()},this.store.data.networkInterval||1e3))}stopDataMock(){clearInterval(this.updateTimer),this.updateTimer=void 0}penMock(e){var t;if(e.realTimes){let i={};if(e.realTimes.forEach(s=>{let a=this.mockValue(s);a!==void 0&&(i[s.key]=a)}),Object.keys(i).length){let s=e.onBeforeValue?e.onBeforeValue(e,i):i;this.canvas.updateValue(e,s),(t=e.onValue)==null||t.call(e,e),this.store.emitter.emit("valueUpdate",e)}}}penNetwork(e){const t={url:e.apiUrl,method:e.apiMethod,headers:e.apiHeaders,body:e.apiBody};this.requestHttp(t),e.apiEnable?(this.store.pensNetwork||(this.store.pensNetwork={}),this.store.pensNetwork[e.id]=t):delete this.store.pensNetwork[e.id]}getDynamicParam(e){return queryURLParams()[e]||localStorage[e]||getCookie(e)||globalThis[e]||""}onNetworkConnect(e){if(e&&e.length){if(this.store.pensNetwork)for(let t in this.store.pensNetwork)e.push(this.store.pensNetwork[t]);this.store.data.cancelFirstConnect||e.forEach(async t=>{this.requestHttp(t)}),e.forEach((t,i)=>{t.times=0,t.interval!==0&&(this.updateTimerList[i]=setInterval(async()=>{this.requestHttp(t),this.store.options.reconnetTimes&&t.times>=this.store.options.reconnetTimes&&(t.times=0,clearInterval(this.updateTimerList[i]),this.updateTimerList[i]=void 0)},t.interval||1e3))})}}async requestHttp(e){var i,s,a;let t=deepClone(e);if(t.url){if(t.url.indexOf("${")>-1){let o=(i=t.url.match(/\$\{([^}]+)\}/g))==null?void 0:i.map(n=>n.slice(2,-1));o&&o.forEach(n=>{t.url=t.url.replace(`\${${n}}`,this.getDynamicParam(n))})}if(typeof t.headers=="object"){for(let o in t.headers)if(typeof t.headers[o]=="string"){let n=(s=t.headers[o].match(/\$\{([^}]+)\}/g))==null?void 0:s.map(l=>l.slice(2,-1));n&&(t.headers[o]=t.headers[o].replace(`\${${n[0]}}`,this.getDynamicParam(n[0])))}}if(typeof t.body=="object"){for(let o in t.body)if(typeof t.body[o]=="string"){let n=(a=t.body[o].match(/\$\{([^}]+)\}/g))==null?void 0:a.map(l=>l.slice(2,-1));n&&(t.body[o]=t.body[o].replace(`\${${n[0]}}`,this.getDynamicParam(n[0])))}}const r=await fetch(t.url,{headers:t.headers,method:t.method,body:t.method==="GET"?void 0:JSON.stringify(t.body)});if(r.ok){const o=await r.text();this.socketCallback(o,{type:"http",url:t.url,name:t.name})}else e.times++,this.store.emitter.emit("error",{type:"http",error:r})}}closeNetwork(){this.mqttClients&&this.mqttClients.forEach(e=>{e.end()}),this.websockets&&this.websockets.forEach(e=>{e&&(e.onclose=void 0,e.close(),e=void 0)}),this.mqttClients=void 0,this.websockets=void 0,this.updateTimerList&&this.updateTimerList.forEach(e=>{clearInterval(e),e=void 0}),this.sqlTimerList&&this.sqlTimerList.forEach(e=>{clearInterval(e),e=void 0}),this.iotMqttClient&&(this.iotMqttClient.end(),this.iotMqttClient=void 0),clearInterval(this.iotTimer),this.iotTimer=void 0,closeJetLinks(this),this.closeSSE()}socketCallback(e,t){this.store.emitter.emit("socket",{message:e,context:t});let i=e;if(this.socketFn&&(i=this.socketFn(e,{meta2d:this,type:t.type,topic:t.topic,url:t.url,method:t.method}),!i))return;i===!0&&(i=e);let s;if(i.constructor===Object||i.constructor===Array)s=i;else if(typeof i=="string")try{s=JSON.parse(i)}catch(a){console.warn("Invalid socket data:",s,a)}else return;s&&(Array.isArray(s)||(s=[s]),s.length&&(s[0].dataId?this.setDatas(s):s.forEach(a=>{this.setValue(a)})))}setDatas(e,{render:t=!0,doEvent:i=!0,history:s}={}){const a=new Map;e.forEach(n=>{var l,c;(l=this.store.bindDatas[n.dataId])==null||l.forEach(h=>{const d=this.store.pens[h.id];if(!d)return;let f=a.get(d);if(!d.noOnBinds&&typeof d.onBinds=="function"){if(f)return;a.set(d,d.onBinds(d,e,h.formItem));return}f?f[h.formItem.key]=n.value:(f={id:h.id,[h.formItem.key]:n.value},a.set(d,f))}),(c=this.store.bind[n.id||n.dataId])==null||c.forEach(h=>{const d=this.store.pens[h.id];if(!d)return;let f=a.get(d);f?f[h.key]=n.value:(f={id:h.id,[h.key]:n.value},a.set(d,f))})}),this.store.data.locked&&this.doDataEvent(e);let r,o;s&&(r=[]),a.forEach((n,l)=>{this.setValue(n,{render:!1,doEvent:i,history:!1}),s&&(r.push(deepClone(l,!0)),o.push(l))}),t&&this.render(),s&&this.pushHistory({type:EditType.Update,initPens:r,pens:o})}setValue(e,{render:t=!0,doEvent:i=!0,history:s}={}){let a=[];if(!e)return;if(e.id){if(e.id===this.store.data.id){this.setDatabyOptions(e),e.bkImage&&this.setBackgroundImage(e.bkImage),e.background&&this.setBackgroundColor(e.background),this.render();return}const o=this.store.pens[e.id];if(o)a=[o];else{let n=this.store.bind[e.id];if(n&&n.length){a=[],this.setDatas([e],{render:t,doEvent:i,history:s});return}}}else if(e.dataId){a=[],this.setDatas([e],{render:t,doEvent:i,history:s});return}else if(e.tag)a=this.find(e.tag);else{let o=[];for(let n in e)o.push({dataId:n,id:n,value:e[n]});o.length&&this.setDatas(o,{render:t,doEvent:i,history:s});return}s=s&&!this.store.data.locked;let r;if(s&&(r=deepClone(a)),a.forEach(o=>{var l;const n=o.onBeforeValue?o.onBeforeValue(o,e):e;e.frames&&(this.stopAnimate([o]),e.showDuration||(e.showDuration=e.frames.reduce((c,h)=>c+h.duration,0))),setChildValue(o,n),this.canvas.updateValue(o,n),(l=o.onValue)==null||l.call(o,o)}),!this.store.data.locked&&this.store.active.length&&!this.canvas.movingPens&&this.canvas.calcActiveRect(),s){let o=deepClone(a);this.pushHistory({type:EditType.Update,initPens:r,pens:o})}i&&a.forEach(o=>{this.store.emitter.emit("valueUpdate",o)}),t&&this.render()}_setValue(e,t=!1){this.setValue(e,{history:t,render:!1,doEvent:!1})}pushHistory(e){this.canvas.pushHistory(e)}showInput(e,t){this.canvas.showInput(e,t)}hideInput(){this.canvas.hideInput()}clearDropdownList(){this.canvas.clearDropdownList()}clearRuleLines(){this.canvas.clearRuleLines()}doMessageEvent(e,t){this.store.messageEvents[e]&&this.store.messageEvents[e].forEach(i=>{let s=!1;i.event.conditions&&i.event.conditions.length?i.event.conditionType==="and"?s=i.event.conditions.every(a=>this.judgeCondition(i.pen,a.key,a)):i.event.conditionType==="or"&&(s=i.event.conditions.some(a=>this.judgeCondition(i.pen,a.key,a))):s=!0,s&&i.event.actions.forEach(a=>{this.events[a.action](i.pen,a,t)})})}initGlobalTriggers(){var e;this.store.globalTriggers={},(e=this.store.data.triggers)==null||e.forEach(t=>{t.conditions.forEach(i=>{i.source&&(this.store.globalTriggers[i.source]||(this.store.globalTriggers[i.source]=[]),this.store.globalTriggers[i.source].includes(t)||this.store.globalTriggers[i.source].push(t))})})}initMessageEvents(){this.store.messageEvents={},this.store.data.pens.forEach(e=>{var t;(t=e.events)==null||t.forEach(i=>{i.name==="message"&&i.message&&(this.store.messageEvents[i.message]||(this.store.messageEvents[i.message]=[]),this.store.messageEvents[i.message].push({pen:e,event:i}))})})}dataJudegeCondition(e,t,i){const{type:s,target:a,fnJs:r,fn:o,operator:n,valueType:l}=i;let c=!1;if(s==="fn"){if(o)c=o(e,{meta2d:this});else if(r){try{i.fn=new Function("data","context",r)}catch(h){console.error("Error: make function:",h)}i.fn&&(c=i.fn(e,{meta2d:this}))}}else{let h=i.value;l==="prop"&&(h=e[i.value]);let d=e[t];switch(n){case">":c=d>+h;break;case">=":c=d>=+h;break;case"<":c=d<+h;break;case"<=":c=d<=+h;break;case"=":case"==":c=d==h;break;case"!=":c=d!=h;break;case"[)":c=valueInRange(+d,h);break;case"![)":c=!valueInRange(+d,h);break;case"[]":c=valueInArray(d,h);break;case"![]":c=!valueInArray(d,h);break}}return c}judgeCondition(e,t,i){const{type:s,target:a,fnJs:r,fn:o,operator:n,valueType:l}=i;let c=!1;if(s==="fn"){if(o)c=o(e,{meta2d:this});else if(r){try{i.fn=new Function("pen","context",r)}catch(h){console.error("Error: make function:",h)}i.fn&&(c=i.fn(e,{meta2d:this}))}}else{let h=i.value;l==="prop"&&(h=this.store.pens[a][i.value]);let d=getter(e,t);switch(["x","y","width","height"].includes(t)&&(d=this.getPenRect(e)[t]),n){case">":c=d>+h;break;case">=":c=d>=+h;break;case"<":c=d<+h;break;case"<=":c=d<=+h;break;case"=":case"==":c=d==h;break;case"!=":c=d!=h;break;case"[)":c=valueInRange(+d,h);break;case"![)":c=!valueInRange(+d,h);break;case"[]":c=valueInArray(d,h);break;case"![]":c=!valueInArray(d,h);break}}return c}pushChildren(e,t){const i=[deepClone(e,!0)],s=[];e.children||(e.children=[]);const a=[];t.forEach(o=>{let n=deepClone(o,!0);if((!o.id||!this.store.pens[o.id])&&(this.canvas.makePen(o),n=null),o.parentId){const c=this.store.pens[o.parentId],h=c.children.findIndex(d=>d===o.id);i.push(deepClone(c,!0)),c.children.splice(h,1),a.push(deepClone(c,!0))}e.children.push(o.id),o.parentId=e.id;const l=calcRelativeRect(o.calculative.worldRect,e.calculative.worldRect);Object.assign(o,l),o.locked=o.lockedOnCombine??LockState.DisableMove,o.locked=o.interaction||isInteraction.includes(o.name)?0:o.locked,n?(i.push(n),a.push(deepClone(o,!0))):s.push(deepClone(o,!0))}),a.push(deepClone(e,!0));let r=1;s.length&&(r=2,this.pushHistory({type:EditType.Add,pens:s,step:r})),this.pushHistory({type:EditType.Update,initPens:i,pens:a,step:r})}toPng(e,t,i=!1,s){return this.canvas.toPng(e,t,i,s)}activeToPng(e,t){return this.canvas.activeToPng(e,t)}pensToPng(e=this.store.active,t,i){return this.canvas.pensToPng(e,t,i)}downloadPng(e,t,i){var s;for(const a of this.store.data.pens)(a.calculative.img||["iframe"].includes(a.name))&&((s=a.onRenderPenRaw)==null||s.call(a,a));setTimeout(()=>{const a=document.createElement("a");a.setAttribute("download",(e||this.store.data.name||"le5le.meta2d")+".png"),a.setAttribute("href",this.toPng(t,void 0,!0,i));const r=document.createEvent("MouseEvents");r.initEvent("click",!0,!0),a.dispatchEvent(r)},1e3)}downloadSvg(){if(!window.C2S)throw console.error("请先加载乐吾乐官网下的canvas2svg.js","https://assets.le5lecdn.com/2d/canvas2svg.js"),new Error("请先加载乐吾乐官网下的canvas2svg.js");let e=!1;const t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;t&&i&&!this.store.data.component&&(e=!0);const s=this.getRect();e&&(s.x=this.store.data.origin.x,s.y=this.store.data.origin.y,s.width=t*this.store.data.scale,s.height=i*this.store.data.scale),s.x-=10,s.y-=10;const a=new window.C2S(s.width+20,s.height+20);a.textBaseline="middle",a.strokeStyle=this.store.styles.color;const r=this.store.data.background||this.store.styles.background;r&&e&&(a.save(),a.fillStyle=r,a.fillRect(0,0,s.width,s.height),a.restore()),this.store.bkImg&&e&&a.drawImage(this.store.bkImg,0,0,s.width,s.height),r&&!e&&(a.save(),a.fillStyle=r,a.fillRect(0,0,s.width+20,s.height+20),a.restore());for(const f of this.store.data.pens)f.visible==!1||!isShowChild(f,this.store)||f.name==="combine"&&!f.draw||renderPenRaw$1(a,f,s,!0);let o=a.getSerializedSvg();this.store.data.background?(o=o.replace("{{bk}}",""),o=o.replace("{{bkRect}}",`<rect x="0" y="0" width="100%" height="100%" fill="${this.store.data.background}"></rect>`)):(o=o.replace("{{bk}}",""),o=o.replace("{{bkRect}}","")),o=o.replace(/--le5le--/g,"&#x");const n=window.URL,l=new Blob([o]),c=n.createObjectURL(l),h=document.createElement("a");h.setAttribute("download",`${this.store.data.name||"le5le.meta2d"}.svg`),h.setAttribute("href",c);const d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),h.dispatchEvent(d)}getRect(e=this.store.data.pens){return getRect$1(e)}hiddenTemplate(){this.canvas.canvasTemplate.hidden()}showTemplate(){this.canvas.canvasTemplate.show()}lockTemplate(e){this.store.data.pens.forEach(t=>{t.canvasLayer===CanvasLayer.CanvasTemplate&&(t.locked=e)})}fitView(e=!0,t=10){var h,d;if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:a}=i;this.resize(s,a);const r=formatPadding(t),o=this.getRect(),n=(s-r[1]-r[3])/o.width,l=(a-r[0]-r[2])/o.height;let c=n;e?c=n>l?l:n:c=n>l?n:l,(h=this.store.data.fits)!=null&&h.length&&(this.canvas.opening=!0),this.scale(c*this.store.data.scale),this.centerView(),(d=this.store.data.fits)!=null&&d.length&&this.fillView()}fillView(){var s,a;const e=this.getRect(),t=this.canvas.width-e.width,i=this.canvas.height-e.height;if(Math.abs(t)>10){(s=this.store.data.fits)==null||s.forEach(o=>{let n=[];o.children.forEach(c=>{this.store.pens[c]&&(this.store.pens[c].locked=LockState.None,n.push(this.store.pens[c]))});let l=t/2;if(o.left&&o.right){let c=o.leftValue,h=o.rightValue;c?c=Math.abs(c)<1?c*this.canvas.width:c:c=0,h?h=Math.abs(h)<1?h*this.canvas.width:h:h=0;let d=(this.canvas.width-c-h)/(e.width-c-h);n.forEach(f=>{var u,v;f.image&&f.imageRatio&&f.calculative.worldRect.width/this.canvas.width>.1&&(f.imageRatio=!1),f.calculative.worldRect.x=e.x-t/2+c+(f.calculative.worldRect.x-e.x)*d,f.calculative.worldRect.width*=d,f.calculative.worldRect.ex=f.calculative.worldRect.x+f.calculative.worldRect.width,f.calculative.width=f.calculative.worldRect.width,f.calculative.x=f.calculative.worldRect.x,f.width=f.calculative.worldRect.width,f.x=f.calculative.worldRect.x,this.canvas.updatePenRect(f,{worldRectIsReady:!1}),f.externElement&&((u=f.onResize)==null||u.call(f,f)),(v=f.children)!=null&&v.length&&getAllChildren(f,this.store).forEach(m=>{var w;m.externElement&&((w=m.onResize)==null||w.call(m,m))})})}else o.left?(l=-l,o.leftValue&&(l+=Math.abs(o.leftValue)<1?o.leftValue*this.canvas.width:o.leftValue),this.translatePens(n,l,0)):o.right&&(o.rightValue&&(l=l-(Math.abs(o.rightValue)<1?o.rightValue*this.canvas.width:o.rightValue)),this.translatePens(n,l,0))});const r=this.store.data.pens.filter(o=>o.name==="iframe");r==null||r.forEach(o=>{var l,c;const n=o.calculative.worldRect;if(n.width/this.store.data.scale>e.width*.8){let h=n.width;o.calculative.worldRect.x=n.x-t/2,o.calculative.worldRect.width=n.width+t,o.calculative.worldRect.ex=n.ex+t,o.operationalRect.x=o.operationalRect.x*h/o.calculative.worldRect.width,o.operationalRect.width=(o.calculative.worldRect.width-(1-o.operationalRect.width)*h)/o.calculative.worldRect.width,(l=o.onBeforeValue)==null||l.call(o,o,{operationalRect:o.operationalRect}),(c=o.onResize)==null||c.call(o,o)}})}if(Math.abs(i)>10){(a=this.store.data.fits)==null||a.forEach(o=>{let n=[];o.children.forEach(c=>{this.store.pens[c]&&(this.store.pens[c].locked=LockState.None,n.push(this.store.pens[c]))});let l=i/2;if(o.top&&o.bottom){let c=o.topValue,h=o.bottomValue;c?c=Math.abs(c)<1?c*this.canvas.height:c:c=0,h?h=Math.abs(h)<1?h*this.canvas.height:h:h=0;let d=(this.canvas.height-c-h)/e.height;n.forEach(f=>{var u,v;f.image&&f.imageRatio&&f.calculative.worldRect.height/this.canvas.height>.1&&(f.imageRatio=!1),f.calculative.worldRect.y=e.y-i/2+c+(f.calculative.worldRect.y-e.y)*d,f.calculative.worldRect.height*=d,f.calculative.worldRect.ey=f.calculative.worldRect.y+f.calculative.worldRect.height,f.calculative.height=f.calculative.worldRect.height,f.calculative.y=f.calculative.worldRect.y,f.height=f.calculative.worldRect.height,f.y=f.calculative.worldRect.y,this.canvas.updatePenRect(f,{worldRectIsReady:!1}),f.externElement&&((u=f.onResize)==null||u.call(f,f)),(v=f.children)!=null&&v.length&&getAllChildren(f,this.store).forEach(m=>{var w;m.externElement&&((w=m.onResize)==null||w.call(m,m))})})}else o.top?(l=-l,o.topValue&&(l+=Math.abs(o.topValue)<1?o.topValue*this.canvas.height:o.topValue),this.translatePens(n,0,l)):o.bottom&&(o.bottomValue&&(l=l-(Math.abs(o.bottomValue)<1?o.bottomValue*this.canvas.height:o.bottomValue)),this.translatePens(n,0,l))});const r=this.store.data.pens.filter(o=>o.name==="iframe");r==null||r.forEach(o=>{var l,c;const n=o.calculative.worldRect;if(n.height/this.store.data.scale>e.height*.8){let h=n.height;o.calculative.worldRect.y=n.y-i/2,o.calculative.worldRect.height=n.height+i,o.calculative.worldRect.ey=n.ey+i,o.operationalRect.y=o.operationalRect.y*h/o.calculative.worldRect.width,o.operationalRect.height=(o.calculative.worldRect.height-(1-o.operationalRect.height)*h)/o.calculative.worldRect.height,(l=o.onBeforeValue)==null||l.call(o,o,{operationalRect:o.operationalRect}),(c=o.onResize)==null||c.call(o,o)}})}this.canvas.canvasTemplate.fit=!0,this.canvas.canvasTemplate.init(),this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render(!0)}trimPens(){let e=this.store.data.pens.filter(t=>t.name==="line"&&t.anchors.length<2);this.delete(e)}fitTemplateView(e=!0,t=10){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:a}=i,r=formatPadding(t),o=this.getRect(),n=(s-r[1]-r[3])/o.width,l=(a-r[0]-r[2])/o.height;let c=n;e?c=n>l?l:n:c=n>l?n:l,this.canvas.templateScale(c*this.store.data.scale);let h=this.getRect(),d=this.store.data.pens.filter(f=>!f.parentId);this.canvas.templateTranslatePens(d,-h.x,-h.y),this.store.data.pens.forEach(f=>{f.type?this.canvas.initLineRect(f):this.canvas.updateLines(f)}),this.centerView()}fitSizeView(e=!0,t=10){var d,f;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:a}=i;this.resize(s,a);const r=formatPadding(t),o=(this.store.data.width||this.store.options.width)*this.store.data.scale,n=(this.store.data.height||this.store.options.height)*this.store.data.scale,l=(s-r[1]-r[3])/o,c=(a-r[0]-r[2])/n;let h=l;e==="width"?h=l:e==="height"?h=c:e?h=l>c?c:l:h=l>c?l:c,(d=this.store.data.fits)!=null&&d.length&&(this.canvas.opening=!0),this.scale(h*this.store.data.scale),this.centerSizeView(),(f=this.store.data.fits)!=null&&f.length&&this.fillView()}centerSizeView(){const e=this.getViewCenter(),t=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height,s={x:0,y:0,width:t,height:i};calcCenter(s);const{center:a}=s,{scale:r,origin:o,x:n,y:l}=this.store.data;this.translate((e.x-o.x)/r-a.x-n/r,(e.y-o.y)/r-a.y-l/r);const{canvas:c}=this.canvas,h=(c.scrollWidth-c.offsetWidth)/2,d=(c.scrollHeight-c.offsetHeight)/2;c.scrollTo(h,d)}scrollView(e=10,t=!1){if(!this.hasView()||!this.canvas.scroll)return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:a}=i;this.resize(s,a);const r=formatPadding(e),o=this.getRect(),n=(s-r[1]-r[3])/o.width;this.scale(n*this.store.data.scale),this.topView(r[0]),t&&this.canvas.scroll.changeMode()}screenView(e=10,t=!0){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:s,offsetHeight:a}=i;this.resize(s,a);const r=formatPadding(e),o=this.getRect();let n=(s-r[1]-r[3])/o.width;t||(n=(a-r[0]-r[2])/o.height),this.scale(n*this.store.data.scale),this.topView(r[0])}topView(e=10){if(!this.hasView())return;const t=this.getRect(),i=this.getViewCenter(),s=this.getPenRect(t);calcCenter(s);const{center:a}=s,{scale:r,origin:o,x:n,y:l}=this.store.data;this.translate((i.x-o.x)/r-a.x-n/r,(e-o.y)/r-s.y-l/r);const{canvas:c}=this.canvas,h=(c.scrollWidth-c.offsetWidth)/2,d=(c.scrollHeight-c.offsetHeight)/2;c.scrollTo(h,d)}centerView(){if(!this.hasView())return;const e=this.getRect(),t=this.getViewCenter(),i=this.getPenRect(e);calcCenter(i);const{center:s}=i,{scale:a,origin:r,x:o,y:n}=this.store.data;this.translate((t.x-r.x)/a-s.x-o/a,(t.y-r.y)/a-s.y-n/a);const{canvas:l}=this.canvas,c=(l.scrollWidth-l.offsetWidth)/2,h=(l.scrollHeight-l.offsetHeight)/2;l.scrollTo(c,h)}hasView(){return!!this.store.data.pens.filter(e=>!e.isRuleLine).length}getViewCenter(){const{width:e,height:t}=this.canvas;return{x:e/2,y:t/2}}beSameByFirst(e=this.store.data.pens,t){const i=deepClone(e),s=e[0],{width:a,height:r}=this.getPenRect(s);for(let o=1;o<e.length;o++){const n=e[o];t==="width"?this.setValue({id:n.id,width:a},{render:!1,doEvent:!1}):t==="height"?this.setValue({id:n.id,height:r},{render:!1,doEvent:!1}):this.setValue({id:n.id,width:a,height:r},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:e})}beSameByLast(e=this.store.data.pens,t){const i=deepClone(e),s=e[e.length-1],{width:a,height:r}=this.getPenRect(s);for(let o=0;o<e.length-1;o++){const n=e[o];t==="width"?this.setValue({id:n.id,width:a},{render:!1,doEvent:!1}):t==="height"?this.setValue({id:n.id,height:r},{render:!1,doEvent:!1}):this.setValue({id:n.id,width:a,height:r},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:e})}formatPainterByFirst(e=this.store.data.pens){const t=deepClone(e),i=e[0],s={};formatAttrs.forEach(a=>{s[a]=i[a]});for(let a=1;a<e.length;a++){const r=e[a];this.setValue({id:r.id,...s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}formatPainterByLast(e=this.store.data.pens){const t=deepClone(e),i=e[e.length-1],s={};formatAttrs.forEach(a=>{s[a]=i[a]});for(let a=0;a<e.length-1;a++){const r=e[a];this.setValue({id:r.id,...s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}setFormatPainter(){const e=this.store.active,t={};if(e.length>0){const i=e[0];formatAttrs.forEach(s=>{t[s]=i[s]!==void 0?i[s]:this.store.options.defaultFormat[s]||this.store.data[s]||this.store.options[s]})}else formatAttrs.forEach(i=>{this.store.options.defaultFormat[i]||this.store.data[i]||this.store.options[i]});localStorage.setItem("meta2d-formatPainter",JSON.stringify(t))}formatPainter(){const e=this.store.active,t=deepClone(e),i=JSON.parse(localStorage.getItem("meta2d-formatPainter"));for(let s=0;s<e.length;s++){const a=e[s];this.setValue({id:a.id,...i},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}clearFormatPainter(){const e=this.store.active,t=deepClone(e);formatAttrs.forEach(i=>{for(let s=0;s<e.length;s++){const a=e[s],{fontSize:r,lineHeight:o}=this.store.options;i==="lineWidth"?(a.lineWidth=1,a.calculative.lineWidth=1):i==="fontSize"?(a.fontSize=r,a.calculative.fontSize=r):i==="lineHeight"?(a.lineHeight=o,a.calculative.lineHeight=o):(delete a[i],delete a.calculative[i])}}),this.render(),this.pushHistory({type:EditType.Update,initPens:t,pens:e})}alignNodes(e,t=this.store.data.pens,i){!i&&(i=this.getPenRect(this.getRect(t)));const s=deepClone(t);for(const a of t)this.alignPen(e,a,i);this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:s,pens:t})}alignNodesV(e,t=this.store.data.pens,i=!1){const s=this.store.data.width||this.store.options.width,a=this.store.data.height||this.store.options.height;let r={x:0,y:0,width:s,height:a};const o=deepClone(t);if(i){const n=this.store.data.scale,l=this.getRect(t),c=(l.x-this.store.data.origin.x)/n,h=(l.y-this.store.data.origin.y)/n,d=l.width/n,f=l.height/n;let u=0,v=0;switch(e){case"left":u=-c;break;case"right":u=s-(c+d);break;case"top":v=-h;break;case"bottom":v=a-(h+f);break;case"center":u=s/2-(c+d/2);break;case"middle":v=a/2-(h+f/2);break}this.translatePens(t,u*n,v*n)}else for(const n of t)this.alignPen(e,n,r);this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:o,pens:t})}alignNodesByFirst(e,t=this.store.data.pens){const i=deepClone(t),s=t[0],a=this.getPenRect(s);for(let r=1;r<t.length;r++){const o=t[r];this.alignPen(e,o,a)}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:t})}alignNodesByLast(e,t=this.store.data.pens){const i=deepClone(t),s=t[t.length-1],a=this.getPenRect(s);for(let r=0;r<t.length-1;r++){const o=t[r];this.alignPen(e,o,a)}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:i,pens:t})}alignPen(e,t,i){const s=this.getPenRect(t);switch(e){case"left":s.x=i.x;break;case"right":s.x=i.x+i.width-s.width;break;case"top":s.y=i.y;break;case"bottom":s.y=i.y+i.height-s.height;break;case"center":s.x=i.x+i.width/2-s.width/2;break;case"middle":s.y=i.y+i.height/2-s.height/2;break}this.setValue({id:t.id,...s},{render:!1,doEvent:!1})}spaceBetweenByDirection(e,t=this.store.data.pens,i){if(!i){let l=1/0,c=-1/0,h=e==="width"?"x":"y";t.forEach(d=>{l=Math.min(l,d.calculative.worldRect[h]),c=Math.max(c,d.calculative.worldRect["e"+h])}),i=(c-l)/this.store.data.scale}if(t=t.filter(l=>!l.parentId),t.length<=2)return;const s=deepClone(t),a=t.reduce((l,c)=>{const h=this.getPenRect(c);return l+h[e]},0),r=(i-a)/(t.length-1);t=t.sort((l,c)=>e==="width"?l.x-c.x:l.y-c.y);const o=this.getPenRect(t[0]);let n=e==="width"?o.x:o.y;for(const l of t){const c=this.getPenRect(l);e==="width"?c.x=n:c.y=n,n+=c[e]+r,this.setValue({id:l.id,...c},{render:!1,doEvent:!1})}this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:EditType.Update,initPens:s,pens:t})}spaceBetween(e,t){this.spaceBetweenByDirection("width",e,t)}spaceBetweenColumn(e,t){this.spaceBetweenByDirection("height",e,t)}layout(e=this.store.data.pens,t,i=30){const s=this.getPenRect(getRect$1(e));!t&&(t=s.width),e=e.filter(l=>!l.type&&!l.parentId);const a=deepClone(e);let r=0;e.forEach(l=>{const c=this.getPenRect(l);c.height>r&&(r=c.height)});let o=s.x,n=s.y;e.forEach((l,c)=>{const h=this.getPenRect(l);if(h.x=o,h.y=n+r/2-h.height/2,this.setValue({id:l.id,...h},{render:!1,doEvent:!1}),c===e.length-1)return;const d=o+h.width-s.x,f=this.getPenRect(e[c+1]);Math.round(t-d)>=Math.round(f.width+i)?o+=h.width+i:(o=s.x,n+=r+i)}),this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:EditType.Update,initPens:a,pens:e})}gotoView(e){const t=this.getViewCenter(),i=t.x-e.calculative.worldRect.x-e.calculative.worldRect.width/2,s=t.y-e.calculative.worldRect.y-e.calculative.worldRect.height/2;this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.translate(i-this.store.data.x,s-this.store.data.y),this.store.data.x=i,this.store.data.y=s;for(const a of this.store.data.pens)calcInView(a);this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render()}showMap(){this.map||(this.map=new ViewMap(this.canvas)),this.map.show()}hideMap(){this.map.hide()}onSizeUpdate(){this.mapTimer&&(clearTimeout(this.mapTimer),this.mapTimer=void 0),this.mapTimer=setTimeout(()=>{this.map&&this.map.isShow&&this.map.show(),this.canvas&&this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.resize()},500)}toggleAnchorMode(){this.canvas.toggleAnchorMode()}addAnchorHand(){this.canvas.addAnchorHand()}removeAnchorHand(){this.canvas.removeAnchorHand()}toggleAnchorHand(){this.canvas.toggleAnchorHand()}top(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens,s=[...getAllChildren(t,this.store),t].map(r=>r.id);i.filter(r=>s.includes(r.id)).forEach(r=>{const o=i.findIndex(n=>n.id===r.id);o>-1&&(i.push(i[o]),i.splice(o,1),this.initTemplateCanvas([r]),this.initImageCanvas([r])),this.specificLayerMove(r,"top")})}this.store.emitter.emit("layer",{type:"top",pens:e})}initImageCanvas(e){this.canvas&&this.canvas.initImageCanvas(e)}initTemplateCanvas(e){this.canvas&&this.canvas.initTemplateCanvas(e)}bottom(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens,s=[...getAllChildren(t,this.store),t].map(r=>r.id),a=i.filter(r=>s.includes(r.id));for(let r=a.length-1;r>=0;r--){const o=a[r],n=i.findIndex(l=>l.id===o.id);n>-1&&(i.unshift(i[n]),i.splice(n+1,1),this.initTemplateCanvas([o]),this.initImageCanvas([o])),this.specificLayerMove(o,"bottom")}}this.store.emitter.emit("layer",{type:"bottom",pens:e})}upByArea(e){if(this.store.data.pens.findIndex(n=>n.id===e.id)===-1){console.warn("upByArea: pen not in canvas");return}const i=[e,...getAllChildren(e,this.store)];let s=i.map(n=>this.store.data.pens.findIndex(l=>l.id===n.id));s.includes(-1)&&(console.warn("upByArea: pen children not in canvas"),s=s.filter(n=>n!==-1));const a=Math.min(...s),r=e.calculative.worldRect,o=this.store.data.pens.findIndex((n,l)=>{if(l<=a||n.id===e.id||isAncestor(n,e))return!1;const c=n.calculative.worldRect;return rectInRect(r,c)});if(o===-1){this.up(e);return}this.store.data.pens.splice(o+1,0,...i);for(const n of i){const l=this.store.data.pens.findIndex(c=>c.id===n.id);l>-1&&this.store.data.pens.splice(l,1)}this.initImageCanvas([e])}specificLayerMove(e,t){var i;if(e.image&&e.name!=="gif"){let s=CanvasLayer.CanvasImageBottom;t==="top"?s=CanvasLayer.CanvasImage:(t==="up"||t==="down")&&(s=CanvasLayer.CanvasMain),this.setValue({id:e.id,canvasLayer:s},{render:!1,doEvent:!1,history:!1})}else if(e.externElement||e.name==="gif"){let s=0;t==="top"?(e.calculative.canvas.maxZindex+=1,s=e.calculative.canvas.maxZindex):t==="up"?s=e.calculative.zIndex===void 0?6:e.calculative.zIndex+1:t==="down"&&(s=e.calculative.zIndex===void 0?3:e.calculative.zIndex-1,s<0&&(s=0)),this.setValue({id:e.id,zIndex:s},{render:!1,doEvent:!1,history:!1}),(i=e.calculative.singleton)!=null&&i.div&&setElemPosition(e,e.calculative.singleton.div)}}up(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens;if(t.children&&t.children.length){const s=[...getAllChildren(t,this.store),t],a=[];for(let n=0;n<i.length;n++){const l=i[n];s.findIndex(c=>c.id===l.id)!==-1&&(l.temIndex=n,a.push(l))}let r=-1,o=0;a.forEach(n=>{n.temIndex-=o,i.splice(n.temIndex,1),o+=1,r=n.temIndex,delete n.temIndex,this.specificLayerMove(n,"up")}),i.splice(r+1,0,...a),this.initTemplateCanvas(a),this.initImageCanvas(a)}else{const s=i.findIndex(a=>a.id===t.id);s>-1&&s!==i.length-1&&(i.splice(s+2,0,i[s]),i.splice(s,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"up")}}this.store.emitter.emit("layer",{type:"up",pens:e})}down(e){e||(e=this.store.active),Array.isArray(e)||(e=[e]);for(const t of e){const i=this.store.data.pens;if(t.children&&t.children.length){const s=[...getAllChildren(t,this.store),t],a=[];for(let n=0;n<i.length;n++){const l=i[n];s.findIndex(c=>c.id===l.id)!==-1&&(l.temIndex=n,a.push(l))}let r=-1,o=0;a.forEach((n,l)=>{n.temIndex-=o,i.splice(n.temIndex,1),o+=1,l===0&&(r=n.temIndex),delete n.temIndex,this.specificLayerMove(n,"down")}),i.splice(r-1,0,...a),this.initTemplateCanvas(a),this.initImageCanvas(a)}else{const s=i.findIndex(a=>a.id===t.id);s>-1&&s!==0&&(i.splice(s-1,0,i[s]),i.splice(s+1,1),this.initTemplateCanvas([t]),this.initImageCanvas([t])),this.specificLayerMove(t,"down")}}this.store.emitter.emit("layer",{type:"down",pens:e})}setLayer(e,t,i=this.store.data.pens){const s=i.findIndex(a=>a.id===e.id);s>-1&&(s>t?(i.splice(t,0,i[s]),i.splice(s+1,1)):s<t&&(i.splice(t,0,i[s]),i.splice(s,1)))}changePenId(e,t){this.canvas.changePenId(e,t)}getLines(e,t="all"){var s;if(e.type===PenType.Line)return[];const i=[];return(s=e.connectedLines)==null||s.forEach(({lineId:a})=>{const r=this.store.pens[a];if(!r){console.warn(e,"node contain a error connectedLine");return}if(!i.find(o=>o.id===r.id))switch(t){case"all":i.push(r);break;case"in":getToAnchor(r).connectTo===e.id&&i.push(r);break;case"out":getFromAnchor(r).connectTo===e.id&&i.push(r);break}}),i}nextNode(e){if(e.type===PenType.Line){const t=this.store.pens[getToAnchor(e).connectTo];return t?[t]:[]}else{const t=this.getLines(e,"out"),i=[];return t.forEach(s=>{const a=this.nextNode(s);for(const r of a)!i.find(n=>n.id===r.id)&&i.push(r)}),i}}previousNode(e){if(e.type===PenType.Line){const t=this.store.pens[getFromAnchor(e).connectTo];return t?[t]:[]}else{const t=this.getLines(e,"in"),i=[];return t.forEach(s=>{const a=this.previousNode(s);for(const r of a)!i.find(n=>n.id===r.id)&&i.push(r)}),i}}getNext(e){var i;if(e.type===PenType.Line){console.warn("非连线节点");return}const t=[];return(i=e.connectedLines)==null||i.forEach(({lineId:s,anchor:a})=>{var n,l;const r=(n=e.anchors)==null?void 0:n.filter(c=>c.id===a)[0],o=this.findOne(s);if(o.anchors[0].connectTo==e.id){const c=o.anchors[o.anchors.length-1].connectTo;if(c){const h=this.findOne(c),d=(l=h.connectedLines)==null?void 0:l.filter(u=>u.lineId===o.id)[0],f=h.anchors.filter(u=>u.id===d.anchor)[0];t.push({from:e,fromAnchor:r,line:o,to:h,toAnchor:f})}}}),t}addAnchor(e,t,i){if(!e)return;if(e.anchors||(e.anchors=[]),e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),e.type===PenType.Line&&(i<0&&(i=e.anchors.length+1+i),i>e.anchors.length&&(i=e.anchors.length),i<0&&(i=0),i==0&&e.anchors[0].connectTo||i==e.anchors.length&&e.anchors[i-1].connectTo)){console.warn("端点存在连接关系");return}let s=null,a=null;t.x<=1&&t.x>=0&&t.y<=1&&t.y>=0?(a={id:t.id||s8(),penId:e.id,x:e.calculative.worldRect.x+e.calculative.worldRect.width*t.x,y:e.calculative.worldRect.y+e.calculative.worldRect.height*t.y},e.calculative.worldRect&&e.rotate%360&&rotatePoint(a,e.rotate,e.calculative.worldRect.center),s={id:a.id,penId:e.id,x:t.x,y:t.y}):(a={id:t.id||s8(),penId:e.id,x:t.x,y:t.y},e.calculative.worldRect&&(e.rotate%360&&rotatePoint(t,-e.rotate,e.calculative.worldRect.center),s={id:a.id,penId:e.id,x:(t.x-e.calculative.worldRect.x)/e.calculative.worldRect.width,y:(t.y-e.calculative.worldRect.y)/e.calculative.worldRect.height})),e.type===PenType.Line?(e.calculative.worldAnchors.splice(i,0,a),e.anchors.splice(i,0,s),this.canvas.updateLines(e),this.canvas.initLineRect(e),this.render()):(e.calculative.worldAnchors.push(a),e.anchors.push(s))}connectLine(e,t,i,s,a=!0){if(!i){const l=t.calculative.worldRect;i=nearestAnchor(e,{x:l.x+l.width/2,y:l.y+l.height/2})}if(!s){const l=e.calculative.worldRect;s=nearestAnchor(t,{x:l.x+l.width/2,y:l.y+l.height/2})}const r=Math.abs(i.x-s.x),n={height:Math.abs(i.y-s.y),lineName:"line",lineWidth:1,name:"line",type:1,width:r,x:Math.min(i.x,s.x),y:Math.min(i.y,s.y),anchors:[{x:i.x>s.x?1:0,y:i.y>s.y?1:0,id:s8()},{x:i.x>s.x?0:1,y:i.x>s.x?0:1,id:s8()}]};return this.addPens([n]),connectLine(e,i,n,n.calculative.worldAnchors[0]),connectLine(t,s,n,n.calculative.worldAnchors[1]),n.calculative.active=!1,this.canvas.updateLines(n),this.canvas.updateLines(e),this.canvas.updateLines(t),this.canvas.initLineRect(n),a&&this.render(),n}toComponent(e=this.store.data.pens,t,i){if(e.length===1){const c=deepClone(e[0]);return c.type=PenType.Node,c.id=void 0,[c]}const s=deepClone(e,!0),a=getRect$1(s);let r={id:s8(),name:"combine",...a,children:[],showChild:t};i&&(r.anchors=[{id:"0",penId:r.id,x:.5,y:0},{id:"1",penId:r.id,x:1,y:.5},{id:"2",penId:r.id,x:.5,y:1},{id:"3",penId:r.id,x:0,y:.5}]);const o=s.filter(c=>!c.parentId),n=s.find(c=>c.width===a.width&&c.height===a.height),l=n&&t===void 0;return o.length===1?r=o[0]:l&&(n.children||(n.children=[]),r=n),s.forEach(c=>{if(c===r||c.parentId===r.id||c.parentId)return;r.children.push(c.id),c.parentId=r.id;const h=calcRelativeRect(c.calculative.worldRect,a);Object.assign(c,h),c.locked=c.lockedOnCombine??LockState.DisableMove}),l||o.length===1?deepClone(s):deepClone([r,...s])}installPenPlugins(e,t){if(!e.tag&&!e.name&&!e.id)return;let i;e.id?i="id":e.tag?i="tag":e.name&&(i="name"),t.forEach(s=>{let a=s.plugin,r=s.options;if(a&&validationPlugin(a)&&i)if(a.install(e,r),!this.penPluginMap.has(a))this.penPluginMap.set(a,[{[i]:e[i],option:r}]);else{let o=this.penPluginMap.get(a).find(n=>n[i]===e[i]);o?o.option=r:this.penPluginMap.get(a).push({[i]:e[i],option:r})}})}uninstallPenPlugins(e,t){let i;e.id?i="id":e.tag?i="tag":e.name&&(i="name"),i&&t.forEach(s=>{let a=s.plugin;a.uninstall(e,s.options);let r=this.penPluginMap.get(a),o=r.findIndex(n=>n[i]===e[i]);o!==-1&&(r.splice(o,1),r.length===0&&this.penPluginMap.delete(a))})}setVisible(e,t,i=!0){if(this.onSizeUpdate(),this.setValue({id:e.id,visible:t},{render:!1,doEvent:!1}),e.children)for(const a of e.children){const r=this.store.pens[a];r&&this.setVisible(r,t,!1)}let s=getAllChildren(e,this.store);s.push(e),this.initImageCanvas(s),i&&this.render()}clearHover(){this.canvas.clearHover()}closeSocket(){this.closeWebsocket(),this.closeMqtt(),this.closeHttp()}destroy(e){if(this.clear(!1),this.stopDataMock(),this.closeSocket(),this.closeNetwork(),this.closeAll(),le5leTheme.destroyThemeSheet(this.store.id),this.store.emitter.all.clear(),this.canvas.destroy(),this.canvas=void 0,globalStore[this.store.id]=void 0,!e){for(const t in globalStore)delete globalStore[t];globalStore.path2dDraws={},globalStore.canvasDraws={},globalStore.anchors={},globalStore.htmlElements={}}}}function flowComment(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ey:o}=e.calculative.worldRect,n=r/4;if(i.moveTo(s+n,a),i.lineTo(s,a),i.lineTo(s,o),i.lineTo(s+n,o),i instanceof Path2D)return i}function flowCommentAnchors(e){const t=[{x:.25,y:0},{x:.25,y:1},{x:0,y:.5}];e.anchors=t.map(({x:i,y:s},a)=>({id:a+"",x:i,y:s,penId:e.id}))}function flowData(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ex:o,ey:n}=e.calculative.worldRect,l=e.offsetX;let c=r/7;if(l>1?c=l:l>0&&(c=r*l),i.moveTo(s+c,a),i.lineTo(o,a),i.lineTo(s+r-c,n),i.lineTo(s,n),i.closePath(),i instanceof Path2D)return i}function flowDataAnchors(e){const t=[{x:.5,y:0},{x:.9285714285714286,y:.5},{x:.5,y:1},{x:.07142857142857142,y:.5}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function flowDisplay(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o,ex:n,ey:l}=e.calculative.worldRect,c=r/8;if(i.moveTo(s+c,a),i.lineTo(n-c,a),i.bezierCurveTo(n+c/3,a,n+c/3,l,n-c,l),i.lineTo(s+c,l),i.lineTo(s,a+o/2),i.closePath(),i instanceof Path2D)return i}function flowDocument(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o,ex:n,center:l}=e.calculative.worldRect,c=l.x,h=a+o*6/7,d=o/6;if(i.moveTo(s,a),i.lineTo(n,a),i.lineTo(n,h),i.bezierCurveTo(n-20,h-d,c+r/5,h-d,c,h),i.bezierCurveTo(c-r/5,h+d,s,h+d,s,h),i.closePath(),i instanceof Path2D)return i}function flowDocumentAnchors(e){const t=[{x:.5,y:0},{x:1,y:.5},{x:.5,y:.8571428571428571},{x:0,y:.5}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function flowExternStorage(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ex:o,ey:n}=e.calculative.worldRect,l=r/10;if(i.moveTo(s+l*2,a),i.bezierCurveTo(s-l*2/3,a,s-l*2/3,n,s+l*2,n),i.lineTo(o,n),i.bezierCurveTo(o-l,n,o-l,a,o,a),i.closePath(),i instanceof Path2D)return i}function flowInternalStorage(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ex:o,ey:n}=e.calculative.worldRect;i.moveTo(s,a),i.lineTo(o,a),i.lineTo(o,n),i.lineTo(s,n),i.closePath();const l=r/7;if(i.moveTo(s,a+l),i.lineTo(o,a+l),i.moveTo(s+l,a),i.lineTo(s+l,n),i instanceof Path2D)return i}function flowManually(e,t){const i=t||new Path2D,{x:s,y:a,height:r,ex:o,ey:n}=e.calculative.worldRect,l=r/4;if(i.moveTo(s,a+l),i.lineTo(o,a),i.lineTo(o,n),i.lineTo(s,n),i.closePath(),i instanceof Path2D)return i}function flowManuallyAnchors(e){const t=[{x:.5,y:.125},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function flowParallel(e,t){const i=t||new Path2D,{x:s,y:a,ex:r,ey:o}=e.calculative.worldRect;if(i.moveTo(s,a),i.lineTo(r,a),i.moveTo(s,o),i.lineTo(r,o),i instanceof Path2D)return i}function flowParallelAnchors(e){const t=[{x:.5,y:0},{x:.5,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:a+"",x:i,y:s,penId:e.id}))}function flowQueue(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o,ex:n,ey:l}=e.calculative.worldRect;if(i.ellipse(s+r/2,a+o/2,r/2,o/2,0,0,Math.PI*2),i.moveTo(s+r/2,l),i.lineTo(n,l),i.closePath(),i instanceof Path2D)return i}function flowSubprocess(e,t){const i=t||new Path2D,{x:s,y:a,width:r,ex:o,ey:n}=e.calculative.worldRect,l=r/7;if(i.moveTo(s,a),i.lineTo(o,a),i.lineTo(o,n),i.lineTo(s,n),i.closePath(),i.moveTo(s+l,a),i.lineTo(s+l,n),i.moveTo(o-l,a),i.lineTo(o-l,n),i instanceof Path2D)return i}function flowDb(e,t){const i=t||new Path2D,{x:s,y:a,height:r,ex:o,ey:n}=e.calculative.worldRect,l=r/7;if(i.moveTo(s,a+l),i.bezierCurveTo(s,a-l/2|0,o,a-l/2|0,o,a+l),i.lineTo(o,n-l),i.bezierCurveTo(o,n+l/2|0,s,n+l/2|0,s,n-l),i.closePath(),i.moveTo(s,n-l),i.bezierCurveTo(s,n-l*2|0,o,n-l*2|0,o,n-l),i instanceof Path2D)return i}function flowPens(){return{flowComment,flowData,flowDb,flowDisplay,flowDocument,flowExternStorage,flowInternalStorage,flowManually,flowParallel,flowQueue,flowSubprocess}}function flowAnchors(){return{flowDocument:flowDocumentAnchors,flowManually:flowManuallyAnchors,flowParallel:flowParallelAnchors,flowComment:flowCommentAnchors,flowData:flowDataAnchors}}function activityFinal(e,t){const{x:i,y:s,width:a,height:r}=t.calculative.worldRect;e.beginPath(),e.ellipse(i+a/2,s+r/2,a/2,r/2,0,0,Math.PI*2),e.stroke(),e.beginPath(),e.fillStyle=e.strokeStyle,e.ellipse(i+a/2,s+r/2,a/4,r/4,0,0,Math.PI*2),e.fill()}function swimlaneH(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o,ey:n}=e.calculative.worldRect,l=e.calculative.lineLeft||.08;let c=e.calculative.borderRadius||0,h=c;c<1&&(c=r*c,h=o*c);let d=c<h?c:h;if(r<2*d&&(d=r/2),o<2*d&&(d=o/2),i.moveTo(s+d,a),i.arcTo(s+r,a,s+r,a+o,d),i.arcTo(s+r,a+o,s,a+o,d),i.arcTo(s,a+o,s,a,d),i.arcTo(s,a,s+r,a,d),i.closePath(),i.moveTo(s+l*r,a),i.lineTo(s+l*r,n),i instanceof Path2D)return i}function swimlaneV(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o,ex:n}=e.calculative.worldRect,l=e.calculative.lineTop||.08;let c=e.calculative.borderRadius||0,h=c;c<1&&(c=r*c,h=o*h);let d=c<h?c:h;if(r<2*d&&(d=r/2),o<2*d&&(d=o/2),i.moveTo(s+d,a),i.arcTo(s+r,a,s+r,a+o,d),i.arcTo(s+r,a+o,s,a+o,d),i.arcTo(s,a+o,s,a,d),i.arcTo(s,a,s+r,a,d),i.closePath(),i.moveTo(s,a+l*o),i.lineTo(n,a+l*o),i instanceof Path2D)return i}function activityDiagram(){return{forkV:rectangle,forkH:rectangle,swimlaneH,swimlaneV}}function activityDiagramByCtx(){return{activityFinal}}function interfaceClass(e,t){e.onDestroy||(e.onDestroy=onDestroy$3,e.onAdd=onAdd$4);const i=t||new Path2D,{x:s,y:a,width:r,height:o,ex:n}=e.calculative.worldRect;let l=e.calculative.borderRadius||0,c=l;l<1&&(l*=r,c*=o);let h=l<c?l:c;r<2*h&&(h=r/2),o<2*h&&(h=o/2),i.moveTo(s+h,a),i.arcTo(s+r,a,s+r,a+o,h),i.arcTo(s+r,a+o,s,a+o,h),i.arcTo(s,a+o,s,a,h),i.arcTo(s,a,s+r,a,h);const d=.2*o;i.moveTo(s,a+d),i.lineTo(n,a+d);const f=a+d+(o-d)/2;if(i.moveTo(s,f),i.lineTo(n,f),i.closePath(),i instanceof Path2D)return i}function onAdd$4(e){const{x:t,y:i,width:s,height:a}=e.calculative.worldRect,r=e.list,o={name:"text",x:t,y:i+.2*a,width:s,height:.4*a,textAlign:"left",textBaseline:"top",textLeft:10,textTop:10},n={name:"text",x:t,y:i+.6*a,width:s,height:.4*a,textAlign:"left",textBaseline:"top",textLeft:10,textTop:10};Object.assign(o,r[0]),Object.assign(n,r[1]),e.calculative.canvas.makePen(o),e.calculative.canvas.makePen(n),e.calculative.canvas.parent.pushChildren(e,[o]),e.calculative.canvas.parent.pushChildren(e,[n])}function onDestroy$3(e){const t=e.calculative.canvas.store;e.children.forEach(i=>{const s=t.data.pens.findIndex(a=>a.id===i);s>-1&&(t.data.pens.splice(s,1),t.pens[i]=void 0)}),e.children=void 0}function simpleClass(e,t){e.onDestroy||(e.onDestroy=onDestroy$2,e.onAdd=onAdd$3);const i=t||new Path2D,{x:s,y:a,width:r,height:o,ex:n}=e.calculative.worldRect;let l=e.calculative.borderRadius||0,c=l;l<1&&(l=r*l,c=o*c);let h=l<c?l:c;r<2*h&&(h=r/2),o<2*h&&(h=o/2),i.moveTo(s+h,a),i.arcTo(s+r,a,s+r,a+o,h),i.lineTo(s+r,a+o-h),i.arcTo(s+r,a+o,s,a+o,h),i.arcTo(s,a+o,s,a,h),i.arcTo(s,a,s+r,a,h);const d=.2*o;if(i.moveTo(s,a+d),i.lineTo(n,a+d),i.closePath(),i instanceof Path2D)return i}function onAdd$3(e){const{x:t,y:i,width:s,height:a}=e.calculative.worldRect,r=e.list;let o={name:"text",x:t,y:i+.2*a,width:s,height:.8*a,textAlign:"left",textBaseline:"top",textLeft:10,textTop:10};Object.assign(o,r[0]),e.calculative.canvas.makePen(o),e.calculative.canvas.parent.pushChildren(e,[o])}function onDestroy$2(e){const t=e.calculative.canvas.store;e.children.forEach(i=>{const s=t.data.pens.findIndex(a=>a.id===i);s>-1&&(t.data.pens.splice(s,1),t.pens[i]=void 0)}),e.children=[]}function classPens(){return{interfaceClass,simpleClass}}function focus(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;if(i.rect(s,a,r,o),i.closePath(),i instanceof Path2D)return i}function lifeline(e,t){const i=t.headHeight??50,{x:s,y:a,width:r,height:o,ey:n}=t.calculative.worldRect;let l=t.calculative.borderRadius||0,c=l;t.calculative.borderRadius<1&&(l*=r,c*=o);let h=l<c?l:c;r<2*h&&(h=r/2),i<2*h&&(h=i/2),e.beginPath(),e.moveTo(s+h,a),e.arcTo(s+r,a,s+r,a+i,h),e.arcTo(s+r,a+i,s,a+i,h),e.arcTo(s,a+i,s,a,h),e.arcTo(s,a,s+r,a,h),e.closePath(),e.stroke(),e.save(),e.beginPath(),e.lineWidth=1,e.setLineDash([7,7]);const d=s+r/2;e.moveTo(d,a+i+1),e.lineTo(d,n),e.stroke(),e.restore()}function sequencePens(){return{sequenceFocus:focus}}function sequencePensbyCtx(){return{lifeline}}var ReplaceMode$2;(function(e){e[e.Add=0]="Add",e[e.Replace=1]="Replace",e[e.ReplaceAll=2]="ReplaceAll"})(ReplaceMode$2||(ReplaceMode$2={}));let keyWords=["fontSize","nameGap","margin","width","symbolSize","itemWidth","itemHeight","fontWeight","top","left","right","bottom","zoom","edgeSymbolSize","nodeWidth","nodeGap","distance","length","length2","offsetCenter","size","symbolOffset","padding","barWidth","symbolOffset","shadowOffsetY","shadowOffsetX"];function echarts(e){var a,r;let t=globalThis.echarts;if(!e.echarts||!t)return;if(typeof e.echarts=="string")try{e.echarts=JSON.parse(e.echarts)}catch{}keyWords=((a=e.calculative.canvas.store.options.diagramOptions.chart)==null?void 0:a.keyWords)||keyWords,e.onDestroy||(e.onDestroy=destory,e.onMove=move,e.onResize=resize,e.onRotate=move,e.onValue=value,e.onBeforeValue=beforeValue$5,e.onBinds=binds,e.onMouseEnter=move,e.onRenderPenRaw=onRenderPenRaw,e.onScale=scale),e.calculative.singleton||(e.calculative.singleton={});const i=new Path2D,s=e.calculative.worldRect;if(!e.calculative.singleton.div){const o=document.createElement("div");o.style.position="absolute",o.style.outline="none",o.style.left="-9999px",o.style.top="-9999px",o.style.width=s.width+"px",o.style.height=s.height+"px",document.body.appendChild(o),(r=e.calculative.canvas.externalElements)==null||r.parentElement.appendChild(o),setElemPosition(e,o),e.calculative.singleton.div=o,e.calculative.singleton.echart=t.init(o,e.echarts.theme),initEvent(e),e.calculative.singleton.echartsReady=!0,e.echarts.geoName&&!t.getMap(e.echarts.geoName)&&(e.echarts.geoJson?t.registerMap(e.echarts.geoName,e.echarts.geoJson):e.echarts.geoUrl&&(e.calculative.singleton.echartsReady=!1,fetch(e.echarts.geoUrl).then(n=>{n.text().then(l=>{if(typeof l=="string")try{l=JSON.parse(l)}catch{}if(l.constructor!==Object&&l.constructor!==Array){console.warn("Invalid data:",l);return}t.registerMap(e.echarts.geoName,l),e.calculative.singleton.echartsReady=!0,e.calculative.singleton.echart.setOption(updateOption(e.echarts.option,e.calculative.canvas.store.data.scale),!0),e.calculative.singleton.echart.resize(),setTimeout(()=>{onRenderPenRaw(e)},300)})}))),e.calculative.singleton.echartsReady&&setTimeout(()=>{e.calculative.singleton.echart.setOption(updateOption(e.echarts.option,e.calculative.canvas.store.data.scale),!0),setTimeout(()=>onRenderPenRaw(e),300)})}return i}function initEvent(e){var s;const t=e.calculative.singleton.echart,i=["click","dblclick","mousedown","mousemove","mouseup","mouseover","mouseout","globalout","contextmenu"];i.forEach(a=>{t.off(a)}),(s=e.events)==null||s.forEach(a=>{a.actions&&a.actions.length&&i.includes(a.name)&&t.on(a.name,r=>{let o=!1;a.conditions&&a.conditions.length?a.conditionType==="and"?o=a.conditions.every(n=>e.calculative.canvas.parent.judgeCondition(e,n.key,n)):a.conditionType==="or"&&(o=a.conditions.some(n=>e.calculative.canvas.parent.judgeCondition(e,n.key,n))):o=!0,o&&a.actions.forEach(n=>{if(n.timeout){let l=setTimeout(()=>{e.calculative.canvas.parent.events[n.action]&&(e.calculative.canvas.parent.events[n.action](e,n,r),clearTimeout(l),l=null)},n.timeout)}else e.calculative.canvas.parent.events[n.action]&&e.calculative.canvas.parent.events[n.action](e,n,r)})})})}function destory(e){if(e.calculative.singleton&&e.calculative.singleton.div){e.calculative.singleton.div.remove();let t=globalThis.echarts;t&&t.dispose(e.calculative.singleton.echart),delete e.calculative.singleton.div,delete e.calculative.singleton.echart}}function move(e){e.calculative.singleton.div&&setElemPosition(e,e.calculative.singleton.div)}function resize(e){var t;move(e),(t=e.calculative.singleton)!=null&&t.echart&&e.calculative.singleton.echart.resize()}function scale(e){var i,s;if(!e.calculative.singleton.echart)return;let t=globalThis.echarts;if(setElemPosition(e,e.calculative.singleton.div),!(e.echarts.geoName&&!t.getMap(e.echarts.geoName))){if(!e.echarts.diabled){if((i=e.echarts.option)!=null&&i.dataZoom){const r=e.calculative.singleton.echart.getOption().dataZoom;(s=e.echarts.option.dataZoom)==null||s.forEach((o,n)=>{r[n]&&(o.start=r[n].start,o.end=r[n].end)})}e.calculative.singleton.echart.setOption(updateOption(e.echarts.option,e.calculative.canvas.store.data.scale),!0)}e.calculative.singleton.echart.resize()}}function value(e){var t,i;if(e.calculative.singleton.echart&&(setElemPosition(e,e.calculative.singleton.div),e.calculative.singleton.echartsReady))if(e.calculative.partialOption){const s=e.calculative.partialOption.echarts.option;(Array.isArray((t=e.echarts)==null?void 0:t.replaceMerge)?(i=e.echarts)==null?void 0:i.replaceMerge.some(r=>s[r]):!1)?e.calculative.singleton.echart.setOption(deepClone(s),{replaceMerge:e.echarts.replaceMerge}):e.calculative.singleton.echart.setOption(deepClone(s))}else e.calculative.singleton.echart.setOption(updateOption(e.echarts.option,e.calculative.canvas.store.data.scale),!0)}function beforeValue$5(e,t){if(e.calculative.partialOption=null,t.echarts){let v=globalThis.echarts;return t.echarts.geoName&&!v.getMap(t.echarts.geoName)&&(t.echarts.geoJson?v.registerMap(t.echarts.geoName,t.echarts.geoJson):t.echarts.geoUrl&&(e.calculative.singleton.echartsReady=!1,fetch(t.echarts.geoUrl).then(y=>{y.text().then(m=>{if(typeof m=="string")try{m=JSON.parse(m)}catch{}if(m.constructor!==Object&&m.constructor!==Array){console.warn("Invalid data:",m);return}return v.registerMap(t.echarts.geoName,m),e.calculative.singleton.echartsReady=!0,e.onValue(e),!1})}))),t}if(e.realTimes&&e.realTimes.length){let v=Object.keys(t);const{xAxis:y,yAxis:m}=e.echarts.option,{max:w,replaceMode:x,timeFormat:b}=e.echarts;let T=[],p=!1;for(let R in t)if(R.includes("echarts.option")){p=!0;let k=getter(e,R);if(Array.isArray(k)&&x===ReplaceMode$2.Add&&(k.push(t[R]),w&&k.splice(0,k.length-w),t[R]=k,!v.includes("echarts.option.xAxis.data"))){let I="echarts.option.xAxis.data";Array.isArray(y)&&y.length&&(I="echarts.option.xAxis.0.data");let P=getter(e,I),A=formatTime(b||"`${hours}:${minutes}:${seconds}`");P.push(A),w&&P.splice(0,P.length-w),t[I]=P}if(R.includes(".data.")){let I=R.substring(0,R.indexOf(".data.")+5);T.includes(I)||T.push(I)}}if(p){const R=deepClone(t);e.calculative.partialOption=dotNotationToObject(R,e),T.forEach(k=>{let I=getter(e,k);setter(e.calculative.partialOption,k,I)})}return t}if(!t.dataX&&!t.dataY)return t;const i=e.echarts,{max:s,replaceMode:a}=i;let r=t.dataX,o=t.dataY,n=[];o&&n.push("echarts.option.series");const l=i.option.series,c=l.length,{xAxis:h,yAxis:d}=i.option;Array.isArray(h)&&h.length>1&&console.warn("echarts 只支持单 x 轴，多 x 轴将被忽略");const f=Array.isArray(h)?h[0]:h,u=Array.isArray(d)?d[0]:d;if(a)if(a===ReplaceMode$2.Replace){if(!f&&!u)o&&(c===1?(!Array.isArray(o)&&(o=[o]),o.forEach((v,y)=>{const m=l[0].data.find(w=>w.name===v.name);m&&(m.value=v.value)})):l.forEach((v,y)=>{Array.isArray(o[y])||(o[y]=[o[y]]),o[y].forEach((m,w)=>{const x=v.data.find(b=>b.name===m.name);x&&(x.value=m.value)})}));else if((f.type==="category"||u.type==="category")&&r&&o){const v=f.type==="category"?f.data:u.data;!Array.isArray(r)&&(r=[r]),!Array.isArray(o)&&(o=[o]),f.type==="category"?n.push("echarts.option.xAxis"):n.push("echarts.option.yAxis"),c===1?o.forEach((y,m)=>{const w=v.indexOf(r[m]);l[0].data[w]=y}):l.forEach((y,m)=>{o[m].forEach((w,x)=>{const b=v.indexOf(r[x]);y.data[b]=w})})}}else a===ReplaceMode$2.ReplaceAll&&(r&&(f.data=r,f.data.splice(0,f.data.length-s),n.push("echarts.option.xAxis")),o&&(c===1?(l[0].data=o,l[0].data.splice(0,l[0].data.length-s)):l.forEach((v,y)=>{v.data=o[y],v.data.splice(0,v.data.length-s)})));else{if(r){!Array.isArray(r)&&(r=[r]);const v=f.data;v.push(...r),v.splice(0,v.length-s),n.push("echarts.option.xAxis")}if(o)if(c===1){!Array.isArray(o)&&(o=[o]);const v=l[0].data;v.push(...o),v.splice(0,v.length-s)}else l.forEach((v,y)=>{Array.isArray(o[y])||(o[y]=[o[y]]);const m=v.data;m.push(...o[y]),m.splice(0,m.length-s)})}return e.calculative.partialOption={},n.forEach(v=>{let y=getter(e,v);setter(e.calculative.partialOption,v,y)}),delete t.dataX,delete t.dataY,Object.assign(t,{echarts:i})}function binds(e,t,i){if(i.key!=="dataY")return;const s=e.echarts,{xAxis:a,yAxis:r}=s.option;Array.isArray(a)&&a.length>1&&console.warn("echarts 只支持单 x 轴，多 x 轴将被忽略");const o=Array.isArray(a)?a[0]:a,n=Array.isArray(r)?r[0]:r,l=s.option.series;if(!o&&!n){const c=[];if(Array.isArray(l)&&l.length===1)return l[0].data.forEach(h=>{const{dataId:d}=i.dataIds.find(f=>f.name===h.name);if(d){const f=t.find(u=>u.dataId===d);f&&c.push({name:h.name,value:f.value})}}),{id:e.id,dataY:c}}else if(o.type==="category"||n.type==="category"){const c=[],h=[],d=o.type==="category"?o.data:n.data;return d==null||d.forEach(f=>{const{dataId:u}=i.dataIds.find(v=>v.name===f);if(u){const v=t.find(y=>y.dataId===u);v&&(h.push(f),c.push(v.value))}}),{id:e.id,dataY:c,dataX:h}}else if(o.type==="time"){const c=[],h=+new Date;let d=!1;if(l.forEach((f,u)=>{const v=[],{dataId:y}=i.dataIds.find(m=>m.name===f.name);if(y){const m=t.find(w=>w.dataId===y);m&&(v.push([h,m.value]),d=!0)}c[u]=v}),d)c.forEach((f,u)=>{if(!f||f.length===0){const v=l[u].data[l[u].data.length-1];c[u]=[[h,v[1]]]}});else return;return{id:e.id,dataY:c.length===1?c[0]:c}}}function onRenderPenRaw(e){var i,s;const t=new Image;t.src=(s=(i=e.calculative.singleton)==null?void 0:i.echart)==null?void 0:s.getDataURL({pixelRatio:2}),e.calculative.img=t}function updateOption(e,t){const i=deepClone(e);if(i.dataZoom){let s=["right","top","width","height","left","bottom"];for(let a=0;a<s.length;a++)i.dataZoom.forEach(r=>{isNaN(r[s[a]])||(r[s[a]]*=t)})}return deepSetValue(i,keyWords,t),i}function dotNotationToObject(e,t){const i={};return Object.keys(e).forEach(s=>{const a=s.split(".");let r=i;a.forEach((o,n)=>{const l=!isNaN(parseInt(o));if(n===6){let c=a.slice(0,7).join(".");setter(t,s,e[s]);let h=getter(t,c);r[a[n]]=h}else{if(n>6)return;if(n===a.length-1)l?(Array.isArray(r)||(r=[]),r[parseInt(o)]=e[s]):r[o]=e[s];else if(l){const c=parseInt(o);if(Array.isArray(r)||r[a[n-1]],r[c]||(r[c]={}),Array.isArray(r))for(let h=0;h<parseInt(o);h++)r[h]||(r[h]={});r=r[c]}else r[o]||(o==="series"?r[o]=[]:r[o]={}),r=r[o]}})}),i}function register(e){e&&(globalThis.echarts=e),register$1({echarts})}var ReplaceMode$1;(function(e){e[e.Add=0]="Add",e[e.Replace=1]="Replace",e[e.ReplaceAll=2]="ReplaceAll"})(ReplaceMode$1||(ReplaceMode$1={}));function getTextLength(e,t){const i=t.calculative.worldRect.height*14/16,a=(e.match(/[\u4e00-\u9fa5]/g)||"").length;return(e.length-a)*i*.6+a*i}function initOptions(e){if(e.direction=="horizontal"){const t=[];let i=0;const s=e.height;e.checkboxHeight=s,e.options.forEach((r,o)=>{t.push(o*(40+s)+i),i+=getTextLength(r.text,e)}),e.optionPos=t;const a=t.length*(40+s)+i;e.checkboxWidth=a,e.width=a,e.calculative.width=a,e.calculative.worldRect={x:e.x,y:e.y,height:e.height,width:e.width,center:{x:e.x+e.width/2,y:e.y+e.height/2}},calcRightBottom(e.calculative.worldRect)}else if(e.direction=="vertical"){e.optionInterval==null&&(e.optionInterval=20),e.optionHeight||(e.optionHeight=20);const t=[];e.options.forEach((s,a)=>{t.push(a*(e.optionInterval+e.optionHeight))}),e.optionPos=t;const i=t[t.length-1]+e.optionHeight;e.checkboxHeight=i,e.width||(e.height=i,e.calculative.height=i,e.calculative.worldRect={x:e.x,y:e.y,height:e.height,width:e.width,center:{x:e.x+e.width/2,y:e.y+e.height/2}},calcRightBottom(e.calculative.worldRect))}}function table2(e,t){t.onAdd||(t.onAdd=onAdd$2,(!t.rowPos||!t.colPos||!t.calculative.maxOffsetY)&&t.onAdd(t),t.onMouseMove=onMouseMove,t.onMouseLeave=onMouseLeave,t.onMouseDown=onMouseDown,t.onShowInput=onShowInput,t.onInput=onInput,t.onValue=onValue$2,t.onBeforeValue=beforeValue$4,t.onMouseEnter=onMouseEnter,t.onWheel=onWheel,t.onDestroy=onDestroy$1),t.data.length!==t.rowPos.length&&(t.initWorldRect=null,t.calculative.isUpdateData=!0,t.onValue(t)),t.data[0].length!==t.colPos.length&&(t.initWorldRect=null,t.calculative.isUpdateData=!0,t.onValue(t));const i=t.calculative.canvas.store;if(t.calculative.canvas.store.data,t.calculative.canvas.store.options,t.color=t.color||i.styles.color,t.textColor=t.textColor||t.color||i.styles.textColor,t.activeColor=t.activeColor||i.styles.activeColor,t.hoverColor=t.hoverColor||i.styles.hoverColor,t.activeBackground=t.activeBackground||i.styles.activeBackground,t.hoverBackground=t.hoverBackground||i.styles.hoverBackground,!t.hasHeader){e.save(),e.beginPath();const{x:s,y:a,width:r,height:o}=t.calculative.worldRect;e.fillStyle="#fff0",e.rect(s-1,a-1,r+2,o+2),e.fill(),e.clip()}drawGridLine(e,t),drawCell(e,t),drawNote(e,t),e.restore(),t.isFirstTime=!1}function drawNote(e,t){if(!t.calculative.hover||!t.calculative.hoverCell||t.calculative.isInput||!t.calculative.isHover)return;let i=t.calculative.worldRect,s=t.calculative.canvas.mousePos;if(!(s.x>i.x&&s.x<i.x+i.width&&s.y>i.y&&s.y<i.y+i.height)){t.calculative.hover=!1,t.calculative.isHover=!1,t.calculative.hoverCell=void 0;return}const{row:a,col:r}=t.calculative.hoverCell,{x:o,y:n}=t.calculative.canvas.mousePos;if(!t.data[a])return;let l=t.data[a][r];if(typeof l=="object"||!l)return;e.save(),e.beginPath(),e.textAlign="start",e.textBaseline="middle",e.font=e.font=(t.calculative.fontStyle||"")+" normal "+(t.calculative.fontWeight||"")+" "+(t.calculative.fontSize||12)+"px "+t.calculative.fontFamily;const c=e.measureText(l).width;e.beginPath(),e.fillStyle="#fff",e.strokeStyle="#000",e.moveTo(o,n),e.rect(o-10,n,c+20,20),e.fill(),e.stroke(),e.beginPath(),e.fillStyle="#000",e.fillText(l,o,n+10),e.restore()}function initRect$1(e){const t=[],i=[],s={};e.rowHeight||(e.rowHeight=40),e.colWidth||(e.colWidth=150);let a=0;const r=e.styles&&e.styles.filter(u=>u.col!==void 0&&u.row===void 0&&u.width);let o={};r&&r.forEach(u=>{o[u.col]=u.width});for(let u=0;u<e.data[0].length;u++){a+=(o[u]||e.colWidth)*e.calculative.canvas.store.data.scale,t.push(a);let v=e.styles&&e.styles.filter(y=>y.col===u&&y.row===void 0);v&&(s[u]=v[0])}let n=0;const l=e.styles&&e.styles.filter(u=>u.col===void 0&&u.row!==void 0&&u.height);let c={};l&&l.forEach(u=>{c[u.row]=u.height});let h=n;for(let u=0;u<e.data.length;u++)n+=(c[u]||e.rowHeight)*e.calculative.canvas.store.data.scale,i.push(n),u<e.maxNum&&(h=n);if(e.calculative.maxOffsetY=(n-h)/e.calculative.canvas.store.data.scale,e.initWorldRect)return;e.colPos=t,e.rowPos=i,e.colStyle=s,e.initScale=e.calculative.canvas.store.data.scale,e.tableWidth=a,e.tableHeight=h||n,e.calculative.width=a,e.calculative.height=h||n,e.calculative.width=a,e.calculative.height=h||n,e.height||(e.height=e.calculative.height),e.width||(e.width=e.calculative.width);let d=e.x,f=e.y;if(e.parentId){let u=e.calculative.canvas.store.pens[e.parentId];d=u.calculative.worldRect.x+u.calculative.worldRect.width*e.x,f=u.calculative.worldRect.y+u.calculative.worldRect.height*e.y}e.calculative.worldRect={x:d,y:f,height:e.calculative.height,width:e.calculative.width,center:{x:e.x+e.calculative.width/2,y:e.y+e.calculative.height/2}},e.width=e.calculative.width,e.height=e.calculative.height,e.initWorldRect||(e.initWorldRect={width:e.calculative.worldRect.width,height:e.calculative.worldRect.height}),calcRightBottom(e.calculative.worldRect)}function drawGridLine(e,t){if(!t.colPos)return;const{x:i,y:s,width:a,height:r,ex:o,ey:n}=t.calculative.worldRect;e.save(),e.beginPath(),e.strokeStyle=t.color;let l=t.calculative.borderRadius||0,c=l;l<1&&(l=a*l,c=r*c);let h=l<c?l:c;if(a<2*h&&(h=a/2),r<2*h&&(h=r/2),e.moveTo(i+h,s),e.arcTo(o,s,o,n,h),e.arcTo(o,n,i,n,h),e.arcTo(i,n,i,s,h),e.arcTo(i,s,o,s,h),t.background&&(e.fillStyle=t.background,e.fill()),t.bordered!==!1&&(e.strokeStyle=t.borderColor||t.color||"#424B61",e.stroke()),t.hLine!==!1){let d=t.rowPos[t.rowPos.length-1];t.hasHeader&&(e.beginPath(),e.moveTo(t.calculative.worldRect.x,t.calculative.worldRect.y+t.rowPos[0]*t.calculative.worldRect.height/t.tableHeight),e.lineTo(t.calculative.worldRect.ex,t.calculative.worldRect.y+t.rowPos[0]*t.calculative.worldRect.height/t.tableHeight),e.strokeStyle=t.borderColor||t.color||"#424B61",e.stroke());for(const f of t.rowPos){if(f===d)continue;const u=f*t.calculative.worldRect.height/t.tableHeight-t.offsetY*t.calculative.canvas.store.data.scale;if(t.hasHeader){if(u<0+t.rowPos[0]||u>t.calculative.worldRect.height)continue}else if(u<0||u>t.calculative.worldRect.height)continue;e.beginPath(),e.moveTo(t.calculative.worldRect.x,t.calculative.worldRect.y+u),e.lineTo(t.calculative.worldRect.ex,t.calculative.worldRect.y+u),e.strokeStyle=t.borderColor||t.color||"#424B61",e.stroke()}}if(t.vLine!==!1){let d=t.colPos[t.colPos.length-1];t.colPos.forEach((f,u)=>{if(f===d)return;const v=f*t.calculative.worldRect.width/t.tableWidth;e.beginPath(),e.moveTo(t.calculative.worldRect.x+v,t.calculative.worldRect.y),e.lineTo(t.calculative.worldRect.x+v,t.calculative.worldRect.ey),e.strokeStyle=t.borderColor||t.color||"#424B61",e.stroke()})}e.restore()}function drawCell(e,t){var s,a,r,o,n;if(!t.colPos)return;t.calculative.texts||(t.calculative.texts=[]);const i=1;for(let l=0;l<t.rowPos.length;l++){if(t.hasHeader&&l===1){e.save(),e.beginPath();const{x:h,y:d,width:f,height:u}=t.calculative.worldRect;e.fillStyle="#fff0",e.rect(h-1,d+t.rowPos[0]*t.calculative.worldRect.height/t.tableHeight-1,f+2,u-t.rowPos[0]*t.calculative.worldRect.height/t.tableHeight+2),e.fill(),e.clip()}let{style:c}=getRow(t,l);for(let h=0;h<t.colPos.length;h++){let{value:d,style:f}=getCell(t,l,h),u=!0;if(Array.isArray(f)&&f.length>0){let I=0;f.forEach((P,A)=>{P.wheres&&P.wheres.every(S=>new Function("attr",`return attr ${S.comparison} ${S.value}`)(d))&&(I=A)}),f=f[I]}else f.wheres&&Array.isArray(f.wheres)&&(u=!1,u=f.wheres.every(function(I){return new Function("attr",`return attr ${I.comparison} ${I.value}`)(d)}));let v=t.color,y=t.textColor||t.color,m=null,w=null,x=null,b=null;u&&(v=f.color||c.color||t.color,y=f.textColor||c.textColor||t.textColor,m=f.background||c.background,w=(f.fontSize||c.fontSize||0)*t.calculative.canvas.store.data.scale,x=f.fontWeight||c.fontWeight,b=f.fontStyle||c.fontStyle);let T;t.stripe&&(t.hasHeader!==!1?l%2===1&&(m=m||t.stripeColor||"#407FFF1F"):l%2===0&&(m=m||t.stripeColor||"#407FFF1F")),t.calculative.active&&((s=t.calculative.activeCell)==null?void 0:s.row)===l&&((a=t.calculative.activeCell)==null?void 0:a.col)===h&&(v=t.activeColor,m=t.activeBackground,T=v,y=t.activeTextColor||t.activeColor),t.calculative.hover&&((r=t.calculative.hoverCell)==null?void 0:r.row)===l&&((o=t.calculative.hoverCell)==null?void 0:o.col)===h&&(v=t.hoverColor,m=t.hoverBackground,y=t.hoverTextColor||t.hoverColor,T=v);const p=getCellRect(t,l,h);if(p.y+p.height<t.calculative.worldRect.y||p.y>t.calculative.worldRect.height+t.calculative.worldRect.y)continue;m&&(e.save(),e.beginPath(),e.fillStyle=m,e.fillRect(p.x,p.y,p.width+.25*t.calculative.canvas.store.data.scale,p.height),e.restore()),T&&(e.save(),e.beginPath(),e.strokeStyle=T,e.strokeRect(p.x,p.y,p.width,p.height),e.restore()),t.calculative.worldTextRect=p;let R=t.calculative.texts[l];if(t.calculative.texts[l]||(R=[],t.calculative.texts.push(R)),R[h]==null){if(typeof d=="object"){const I=t.styles&&t.styles.filter(P=>P.col===h&&P.row===void 0&&P.pens);if(I.length>0){if(R[h]="",t.isFirstTime){t.maxNum&&t.hasHeader&&l>=t.maxNum&&(d.visible=!1);let P=JSON.parse(JSON.stringify(I[0].pens));P.forEach(A=>{Object.assign(A,{row:l,col:h},d),A.activeBackground=A.background,A.hoverBackground=A.background,A.activeColor=A.color,A.hoverColor=A.color,A.activeTextColor=A.textColor,A.hoverTextColor=A.textColor,A.height*=t.calculative.canvas.store.data.scale,A.width*=t.calculative.canvas.store.data.scale}),calcChildrenRect(t,p,P),t.calculative.canvas.parent.pushChildren(t,P)}continue}}else d===void 0?R[h]="":R[h]=d.text||d+"";if(!R[h])continue;R[h]=calcTextLines(t,R[h])}if(!R[h])continue;e.save(),e.beginPath(),e.fillStyle=y,e.textAlign="center",e.textBaseline="middle",e.font=(b||t.calculative.fontStyle||"")+" normal "+(x||t.calculative.fontWeight||"")+" "+(w||t.calculative.fontSize||12)*i+"px "+t.calculative.fontFamily;let k=t.colStyle&&((n=t.colStyle[h])==null?void 0:n.textAlign);if(k&&(e.textAlign=k),R[h].length===1)k==="left"?e.fillText(R[h][0],p.x,p.y+p.height/2):k==="right"?e.fillText(R[h][0],p.x+p.width,p.y+p.height/2):e.fillText(R[h][0],p.x+p.width/2,p.y+p.height/2);else{const P=(w||t.calculative.fontSize)*t.calculative.lineHeight*i,A=R[h].length*P;let L=(p.height-A)/2;k==="left"?R[h].forEach((S,M)=>{e.fillText(S,p.x,p.y+L+(M+.55)*P)}):k==="right"?R[h].forEach((S,M)=>{e.fillText(S,p.x+p.width,p.y+L+(M+.55)*P)}):R[h].forEach((S,M)=>{e.fillText(S,p.x+p.width/2,p.y+L+(M+.55)*P)})}e.restore()}}}function onAdd$2(e){var t;createInterval(e),(t=e.children)!=null&&t.length||(e.isFirstTime=!0),e.offsetY||(e.offsetY=0),initRect$1(e)}function onShowInput(e,t){if(!e.calculative.hoverCell)return;const{value:i}=getCell(e,e.calculative.hoverCell.row,e.calculative.hoverCell.col);if(typeof i=="object")return;e.calculative.isHover=!1,e.calculative.isInput=!0,e.calculative.canvas.render(),e.calculative.inputCell=e.calculative.hoverCell;const s=getCellRect(e,e.calculative.hoverCell.row,e.calculative.hoverCell.col);e.calculative.tempText=i.text||i+"",e.calculative.canvas.showInput(e,s,"#ffffff")}function onInput(e,t){e.calculative.inputCell&&(setCellText(e,e.calculative.inputCell.row,e.calculative.inputCell.col,t),e.calculative.isInput=!1,e.calculative.isHover=!0,e.calculative.canvas.render())}function onMouseMove(e,t){e.timer&&(e.calculative.isHover=!1,clearTimeout(e.timer)),e.timer=setTimeout(()=>{e.calculative.isHover=!0,e.calculative.canvas.render()},500),e.calculative.hoverCell=getCellIndex(e,t),e.calculative.canvas.render()}function onMouseLeave(e,t){createInterval(e),e.calculative.hoverCell=void 0,e.calculative.canvas.render()}function onMouseDown(e,t){e.calculative.activeCell=getCellIndex(e,t),e.calculative.canvas.render()}function getCellIndex(e,t){const i=e.calculative.worldRect.width/e.tableWidth,s=e.calculative.worldRect.height/e.tableHeight,a={row:0,col:0};for(let r=0;r<e.colPos.length;r++)t.x>e.calculative.worldRect.x+e.colPos[r]*i&&(a.col=r+1);for(let r=0;r<e.rowPos.length;r++)t.y>e.calculative.worldRect.y+e.rowPos[r]*s-e.offsetY*e.calculative.canvas.store.data.scale&&(a.row=r+1);return a}function getCell(e,t,i){if(!e.data||!Array.isArray(e.data))return;const s=e.data[t],a=e.styles&&e.styles.filter(r=>r.row===t&&r.col===i);if(Array.isArray(s))return{value:s[i],style:(a==null?void 0:a.length)>0?a.length>1?a:a[0]:{}};if(!s.data||!Array.isArray(s.data))return}function getRow(e,t){if(!e.data||!Array.isArray(e.data))return;const i=e.data[t],s=e.styles&&e.styles.filter(a=>a.row===t&&a.col===void 0);if(Array.isArray(i))return{value:i,style:(s==null?void 0:s.length)>0?s[0]:{}};if(!i.data||!Array.isArray(i.data))return}function setCellText(e,t,i,s){if(!e.data||!Array.isArray(e.data))return;e.isFirstTime=!1,e.calculative.texts=void 0;let a=e.data[t];a&&(a[i]instanceof Object||(a[i]=s),e.calculative.canvas.store.emitter.emit("valueUpdate",e))}function getCellRect(e,t,i){const s=e.calculative.worldRect.width/e.tableWidth,a=e.calculative.worldRect.height/e.tableHeight;let r=0,o=e.colPos[i]*s;i>0&&(r=e.colPos[i-1]*s);let n=0,l=e.rowPos[t]*a;t>0&&(n=e.rowPos[t-1]*a);let c=e.offsetY*e.calculative.canvas.store.data.scale;return t===0&&e.hasHeader&&(c=0),{x:e.calculative.worldRect.x+r,y:e.calculative.worldRect.y+n-c,ex:e.calculative.worldRect.x+o,ey:e.calculative.worldRect.y+l-c,width:o-r,height:l-n}}function calcChildrenRect(e,t,i){if(!(i&&i.length))return;const s=e.calculative.worldRect.width/e.tableWidth,a=e.calculative.worldRect.height/e.tableHeight;let r=1,o=1;e.initWorldRect&&(e.calculative.worldRect.width!==e.initWorldRect.width&&(r=e.calculative.worldRect.width/e.initWorldRect.width),e.calculative.worldRect.height!==e.initWorldRect.height&&(o=e.calculative.worldRect.height/e.initWorldRect.height));let n=0,l=0,c=0;const h=e.calculative.canvas.store.data.scale;if(i.length>1){for(const d of i)l+d.width*s+20*h*s<t.width?(d.x=t.x+l+10*h*s,d.y=t.y+c+10*h*a,l+=(d.width+10*h)*s,n=Math.max(n,c+(d.height+10*h)*a)):(l=0,c=n,d.x=t.x+l+10*h*s,d.y=t.y+c+10*h*a,n+=(d.height+10*h)*a);if(n+20*h*a<t.height){const d=(t.height-n-10*h*a)/2;for(const f of i)f.y+=d}}else i[0].x=t.x+(t.width-i[0].width)/2,i[0].y=t.y+(t.height-i[0].height)/2;i.forEach(d=>{d.width=d.width*r,d.height=d.height*o})}function onValue$2(e){if(e.calculative.isUpdateData){delete e.calculative.isUpdateData;let t=deepClone(e.children);e.children=[],onAdd$2(e),t&&t.forEach(i=>{e.calculative.canvas.delForce(e.calculative.canvas.findOne(i))}),e.calculative.texts=void 0}}function beforeValue$4(e,t){if(e.calculative.isUpdateData=!1,e.swiper!==void 0&&(e.swiper?createInterval(e):delInterval(e)),t.styles&&(e.initWorldRect=void 0),t.table||t.col==null&&t.row==null){if(t.dataY){const s=e.replaceMode;let a=[];return s?s===ReplaceMode$1.Replace?(a=e.data,t.dataX&&t.dataX.forEach((r,o)=>{a[r]=t.dataY[o]})):s===ReplaceMode$1.ReplaceAll&&(t.dataX?a[0]=t.dataX:a[0]=e.data[0],a=a.concat(t.dataY)):a=e.data.concat(t.dataY),delete t.dataX,delete t.dataY,e.calculative.isUpdateData=!0,Object.assign(t,{data:a})}(t.data||t.styles||t.maxNum||t.rowHeight||t.colWidth)&&(e.calculative.isUpdateData=!0,e.initWorldRect=null);for(let s of Object.keys(t))s.includes("data.")&&(e.calculative.isUpdateData=!0);return t}let i=e.data[t.row];return i&&(i[t.col]instanceof Object||(i[t.col]=t.value),setCellText(e,t.row,t.col,t.value),e.calculative.canvas.render(),delete t.col,delete t.row),t}function onWheel(e,t){if(!e.locked&&!e.calculative.canvas.store.data.locked||!e.maxNum)return;let i=0;t.deltaY>0?i=4:i=-4,scroll(e,i)}function scroll(e,t){var i;e.offsetY||(e.offsetY=0),e.offsetY+=t,e.offsetY>e.calculative.maxOffsetY&&(e.offsetY=e.calculative.maxOffsetY),e.offsetY<0&&(e.offsetY=0),(i=e.children)==null||i.forEach(s=>{const a=e.calculative.canvas.store.pens[s];changeChildVisible(e,a)}),e.calculative.canvas.render()}function changeChildVisible(e,t){if(!t)return;t.oldY||(t.oldY=t.y),t.calculative.worldRect,e.calculative.worldRect;const i=e.calculative.canvas.store.data.scale;e.calculative.worldRect.height/e.tableHeight;const s=e.rowHeight;t.y=t.oldY-e.offsetY*i/e.calculative.worldRect.height;const a=s*(e.initScale||1)/e.tableHeight*e.maxNum;if(e.calculative.canvas.updatePenRect(t),e.hasHeader)if(t.y<e.rowPos[0]/e.tableHeight){if(t.calculative.visible=!1,t.visible=!1,t.y<e.rowPos[0]/e.tableHeight/2){t.oldY+=a;let r=t.row+e.maxNum;if(!e.data[r])return;let o=deepClone(e.data[r][t.col]);o.background&&(o.activeBackground=o.background,o.hoverBackground=o.background),o.color&&(o.hoverColor=o.color,o.activeColor=o.color),o.textColor&&(o.activeTextColor=o.textColor,o.hoverTextColor=o.textColor),Object.assign(t,o,{row:r}),Object.assign(t.calculative,o,{row:r})}}else if(t.y+t.height>1){if(t.calculative.visible=!1,t.visible=!1,t.y+t.height/2>1){t.oldY-=a;let r=t.row-e.maxNum;if(!e.data[r])return;let o=deepClone(e.data[r][t.col]);o.background&&(o.activeBackground=o.background,o.hoverBackground=o.background),o.color&&(o.hoverColor=o.color,o.activeColor=o.color),o.textColor&&(o.activeTextColor=o.textColor,o.hoverTextColor=o.textColor),Object.assign(t,o,{row:r}),Object.assign(t.calculative,o,{row:r})}}else t.visible=!0,t.calculative.visible=!0;else if(t.y<0){if(t.calculative.visible=!1,t.visible=!1,t.y<-s/e.tableHeight/2){t.oldY+=a;let r=t.row+e.maxNum;if(!e.data[r])return;let o=deepClone(e.data[r][t.col]);o.background&&(o.activeBackground=o.background,o.hoverBackground=o.background),o.color&&(o.hoverColor=o.color,o.activeColor=o.color),o.textColor&&(o.activeTextColor=o.textColor,o.hoverTextColor=o.textColor),Object.assign(t,o,{row:r}),Object.assign(t.calculative,o,{row:r})}}else if(t.y+t.height>1){if(t.calculative.visible=!1,t.visible=!1,t.y+t.height/2>1){t.oldY-=a;let r=t.row-e.maxNum;if(!e.data[r])return;let o=deepClone(e.data[r][t.col]);o.background&&(o.activeBackground=o.background,o.hoverBackground=o.background),o.color&&(o.hoverColor=o.color,o.activeColor=o.color),o.textColor&&(o.activeTextColor=o.textColor,o.hoverTextColor=o.textColor),Object.assign(t,o,{row:r}),Object.assign(t.calculative,o,{row:r})}}else t.calculative.visible=!0,t.visible=!0}function onDestroy$1(e){delInterval(e)}function delInterval(e){e.interval&&(globalThis.clearInterval(e.interval),e.interval=null)}function createInterval(e){if(e.maxNum&&e.swiper){if(e.interval)return;e.interval=globalThis.setInterval(()=>{e.offsetY>=e.calculative.maxOffsetY?(e.offsetY=0,initChildrenStyle(e)):e.offsetY%e.rowHeight?scroll(e,1):(e.calculative.stap||(e.calculative.stap=0),e.calculative.stap+=1,e.calculative.stap==12&&(e.calculative.stap=0,scroll(e,1)))},50)}}function initChildrenStyle(e){var t;(t=e.children)==null||t.forEach(i=>{const s=e.rowHeight,a=e.calculative.canvas.store.pens[i];if(!a)return;const r=s*(e.initScale||1)/e.tableHeight*e.maxNum;a.oldY-=r;const o=a.row-e.maxNum;if(!e.data[o])return;let n=deepClone(e.data[o][a.col]);n.background&&(n.activeBackground=n.background,n.hoverBackground=n.background),n.color&&(n.hoverColor=n.color,n.activeColor=n.color),n.textColor&&(n.activeTextColor=n.textColor,n.hoverTextColor=n.textColor),a.calculative.visible=!0,a.visible=!0,Object.assign(a,n,{row:o}),Object.assign(a.calculative,n,{row:o})}),e.calculative.canvas.render()}function onMouseEnter(e){delInterval(e)}function le5leSwitch(e,t){t.onClick||(t.onClick=click,t.setTheme=setTheme$1);let i=t.calculative.worldRect.x,s=t.calculative.worldRect.y,a=t.calculative.worldRect.width,r=t.calculative.worldRect.height;a<r*1.5&&(a=1.5*r),e.beginPath(),e.arc(i+r/2,s+r/2,r/2,Math.PI/2,Math.PI*3/2),e.lineTo(i+a-r/2,s),e.arc(i+a-r/2,s+r/2,r/2,-Math.PI/2,Math.PI/2),e.lineTo(i+r/2,s+r),t.checked?(e.fillStyle=t.onColor,(t.disabled||t.disable)&&(e.fillStyle=t.disableOnColor||pSBC(.6,t.onColor)),t.lineWidth&&(e.strokeStyle=t.onStrokeColor,e.stroke()),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="#ffffff",e.moveTo(i+r*2,s+r/2),e.arc(i+a-r/2,s+r/2,r/2>2?r/2-2:1,0,Math.PI*2),e.fill()):(e.fillStyle=t.offColor,(t.disabled||t.disable)&&(e.fillStyle=t.disableOffColor||pSBC(.6,t.offColor)),t.lineWidth&&(e.strokeStyle=t.offStrokeColor,e.stroke()),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="#ffffff",e.moveTo(i+r,s+r/2),e.arc(i+r/2,s+r/2,r/2>2?r/2-2:1,0,Math.PI*2),e.fill()),e.closePath()}function click(e){e.disableDefaultClick||e.disabled||e.disable||(e.checked=!e.checked,e.calculative.canvas.store.emitter.emit("valueUpdate",e),e.calculative.canvas.render())}function setTheme$1(e,t){for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const s=t[i];e.hasOwnProperty(i)&&(e[i]=s),e.calculative.hasOwnProperty(i)&&(e.calculative[i]=s)}e.onStrokeColor=t.borderColor,e.offStrokeColor=t.borderColor}function slider(e,t){t.onAdd||(t.onAdd=initRect,t.onResize=initRect,t.onMove=initRect,t.onMouseMove=mouseMove,t.onMouseDown=mouseDown,t.onValue=onValue$1,t.onBeforeValue=beforeValue$3,t.setTheme=setTheme),t.calculative.barRect||initRect(t);const i=t.calculative.canvas.store;t.calculative.canvas.store.options;let s=t.background;t.disabled&&(s=t.disabledBackground||pSBC(.6,s)),e.fillStyle=s,e.beginPath();let a=t.calculative.worldRect.x+t.calculative.barRect.x,r=t.calculative.worldRect.y+t.calculative.barRect.y,o=t.calculative.barRect.width,n=t.calculative.barRect.height,l=n/2;e.moveTo(a+l,r),e.arcTo(a+o,r,a+o,r+n,l),e.arcTo(a+o,r+n,a,r+n,l),e.arcTo(a,r+n,t.x,t.y,l),e.arcTo(a,r,a+o,r,l),e.fill();let c=t.activeColor||i.styles.activeColor;t.disabled&&(c=t.disabledColor||pSBC(.6,c)),e.fillStyle=c,e.beginPath(),o=t.calculative.ballRect.x,e.moveTo(a+l,r),e.arcTo(a+o,r,a+o,r+n,l),e.arcTo(a+o,r+n,a,r+n,l),e.arcTo(a,r+n,t.x,t.y,l),e.arcTo(a,r,a+o,r,l),e.fill(),e.fillStyle=t.btnBackground||"#fff",e.strokeStyle=c,e.lineWidth=2,e.beginPath(),a=t.calculative.worldRect.x+t.calculative.ballRect.x,r=t.calculative.worldRect.y+t.calculative.ballRect.y+t.calculative.ballRect.height/2,e.lineWidth=t.calculative.ballRect.width/10,e.arc(a,r,t.calculative.ballRect.width/2,0,Math.PI*2),e.fill(),e.stroke()}function initRect(e){if(e._textWidth||(e._textWidth=e.textWidth||50,e._fontSize=e.fontSize||12),e.textWidth=e.calculative.worldRect.width,e.calculative.textWidth=e.textWidth,e.unit||(e.unit="%"),e.sliderWidth||(e.sliderWidth=e.width),e.sliderHeight||(e.sliderHeight=e.height),!e.calculative.worldRect)return;const t=e.calculative.worldRect.width/e.sliderWidth,i=e.calculative.worldRect.height/e.sliderHeight,s=Math.min(t,i);e.fontSize=e._fontSize*s;const a=e.calculative.worldRect.width-e._textWidth*s;e.textLeft=a+10*s,e.calculative.textLeft=e.textLeft,e.calculative.barRect={x:0,y:(e.calculative.worldRect.height-e.barHeight*i)/2,width:a,height:e.barHeight*i},calcRightBottom(e.calculative.barRect),calcBallRect(e)}function calcBallRect(e){const t=e.calculative.barRect.height*3.5,i=e.calculative.barRect.width*e.value/100;e.calculative.ballRect={x:i,y:(e.calculative.worldRect.height-t)/2,width:t,height:t},calcRightBottom(e.calculative.ballRect),e.calculative.text=e.value+e.unit,calcTextRect(e)}function mouseDown(e,t){if(e.disabled)return;const i=t.x-e.calculative.worldRect.x;if(i>e.calculative.barRect.width)return;let s=Math.round(i/e.calculative.barRect.width*100);s<e.min||s>e.max||s<0||s>100||(e.value=s,calcBallRect(e),e.calculative.text=e.value+e.unit,calcTextRect(e),e.calculative.canvas.store.emitter.emit("valueUpdate",e),e.calculative.canvas.render())}function mouseMove(e,t){e.calculative.canvas.mouseDown&&mouseDown(e,t)}function onValue$1(e){e.calculative.isUpdateData&&(delete e.calculative.isUpdateData,initRect(e)),calcBallRect(e)}function beforeValue$3(e,t){return e.calculative.isUpdateData=!1,(t.textWidth||t.barHeight)&&(t.textWidth&&(e._textWidth=0),e.calculative.isUpdateData=!0),t}function setTheme(e,t){for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const s=t[i];e.hasOwnProperty(i)&&(e[i]=s),e.calculative.hasOwnProperty(i)&&(e.calculative[i]=s)}e.background=t.sliderBg,e.calculative.background=t.sliderBg,e.btnBackground=t.sliderBtnBg,e.calculative.btnBackground=t.sliderBtnBg,e.activeColor=t.tabActiveBg,e.calculative.activeColor=t.tabActiveBg}function checkbox(e,t){t.onMouseDown||(t.onMouseDown=onMousedown$1),t.options||(t.options=t.data);let i=t.calculative.worldRect.x,s=t.calculative.worldRect.y,a=t.calculative.worldRect.height;t.calculative.worldRect.width;const{fontStyle:r,fontWeight:o,fontSize:n,fontFamily:l,lineHeight:c}=t.calculative;let h=2;e.beginPath(),e.moveTo(i,s),e.arcTo(i+a,s,i+a,s+a,h),e.arcTo(i+a,s+a,i,s+a,h),e.arcTo(i,s+a,i,s,h),e.arcTo(i,s,i+a,s,h),e.strokeStyle="#d9d9d9",e.fillStyle="#ffffff00",t.checked&&(e.fillStyle=t.background||"#1890ff",e.strokeStyle=t.background||"#1890ff"),(t.isForbidden||t.disabled)&&(e.fillStyle=t.disabledBackground||pSBC(.6,t.background)||"#ebebeb",e.strokeStyle=t.disabledColor||pSBC(.6,t.color)||"#d9d9d9"),e.closePath(),e.fill(),e.stroke(),e.save(),t.checked&&(e.beginPath(),e.lineWidth=a/10,e.strokeStyle="#ffffff",e.moveTo(i+102/506*a,s+a/2),e.lineTo(i+220/506*a,s+346/460*a),e.lineTo(i+404/506*a,s+142/460*a),e.stroke()),e.restore(),e.save(),e.fillStyle=t.disabled||t.isForbidden?t.disabledTextColor||pSBC(.6,t.textColor||t.color)||"#00000040":getTextColor(t,t.calculative.canvas.parent.store)||"#000000d9",e.textAlign="start",e.textBaseline="middle",e.font=getFont({fontStyle:r,fontWeight:o,fontFamily:l||t.calculative.canvas.parent.store.options.fontFamily,fontSize:n,lineHeight:c}),e.fillText(t.value+"",i+a+10,s+a/2),e.restore()}function onMousedown$1(e,t){e.isForbidden||(e.checked=!e.checked,e.calculative.canvas.store.emitter.emit("valueUpdate",e),e.calculative.canvas.render())}function radio(e,t){t.options||(t.options=t.data),t.onAdd||(t.onAdd=onAdd$1,t.optionPos||(t.onAdd(t),t.calculative.canvas.parent.active([t])),t.onMouseDown=onMousedown,t.onValue=onValue,t.onBeforeValue=beforeValue$2);let i=t.calculative.worldRect.x,s=t.calculative.worldRect.y,a=t.calculative.worldRect.height,r=t.calculative.worldRect.width;if(!t.optionPos)return;const{fontStyle:o,fontWeight:n,fontSize:l,fontFamily:c,lineHeight:h}=t.calculative;if(t.direction=="horizontal")for(let d=0;d<t.optionPos.length;d++){const f=t.optionPos[d]*r/t.checkboxWidth,u=t.options[d].isForbidden||t.disabled;e.beginPath(),e.arc(i+f+a/2,s+a/2,a/2,0,Math.PI*2),e.strokeStyle="#d9d9d9",e.fillStyle="#ffffff00",t.options[d].text===t.checked&&(e.strokeStyle=t.options[d].background||t.background||"#1890ff"),u&&(e.fillStyle=t.disabledBackground||pSBC(.6,t.background)||"#ebebeb",e.strokeStyle=t.disabledColor||pSBC(.6,t.color)||"#d9d9d9",t.options[d].text===t.checked&&(e.fillStyle="#ffffff00")),e.closePath(),e.fill(),e.stroke(),e.save(),t.options[d].text===t.checked&&(e.beginPath(),e.strokeStyle=t.options[d].background?t.options[d].background+"20":t.background||"#1890ff20",u&&(e.strokeStyle=t.disabledBackground||pSBC(.6,t.background)||"#ebebeb"),e.arc(i+a/2+f,s+a/2,a/2+1.5,0,Math.PI*2),e.stroke(),e.closePath(),e.beginPath(),e.fillStyle=t.options[d].background||t.background||"#1890ff",u&&(e.fillStyle=t.disabledBackground||pSBC(.6,t.background)||"#ebebeb"),e.arc(i+a/2+f,s+a/2,a/4,0,Math.PI*2),e.fill(),e.closePath()),e.restore(),e.save(),e.fillStyle=u?t.disabledTextColor||"#00000040":getTextColor(t,t.calculative.canvas.parent.store)||"#000000d9";const v=t.calculative.worldRect.height*14/16;e.textAlign="start",e.textBaseline="middle",e.font=getFont({fontStyle:o,fontWeight:n,fontFamily:c||t.calculative.canvas.parent.store.options.fontFamily,fontSize:v,lineHeight:h}),e.fillText(t.options[d].text,i+a+f+10/t.checkboxWidth*r,s+a/2),e.restore()}else if(t.direction=="vertical"){const d=t.optionHeight*a/t.checkboxHeight;for(let f=0;f<t.optionPos.length;f++){const u=t.optionPos[f]*a/t.checkboxHeight,v=t.options[f].isForbidden;e.beginPath(),e.arc(i+d/2,s+d/2+u,d/2,0,Math.PI*2),e.strokeStyle="#d9d9d9",e.fillStyle="#ffffff00",t.options[f].text===t.checked&&(e.strokeStyle=t.options[f].background||"#1890ff"),v&&(e.fillStyle="#ebebeb",e.strokeStyle="#d9d9d9"),e.closePath(),e.fill(),e.stroke(),e.save(),!v&&t.options[f].text===t.checked&&(e.beginPath(),e.strokeStyle=t.options[f].background?t.options[f].background+"20":"#1890ff20",e.arc(i+d/2,s+d/2+u,d/2+1.5,0,Math.PI*2),e.stroke(),e.closePath(),e.beginPath(),e.fillStyle=t.options[f].background||"#1890ff",e.arc(i+d/2,s+d/2+u,d/4,0,Math.PI*2),e.fill(),e.closePath()),e.restore(),e.save(),e.fillStyle=v?"#00000040":getTextColor(t,t.calculative.canvas.parent.store)||"#000000d9";const y=14*t.calculative.worldRect.height/t.checkboxHeight;e.textAlign="start",e.textBaseline="middle",e.font=getFont({fontStyle:o,fontWeight:n,fontFamily:c||t.calculative.canvas.parent.store.options.fontFamily,fontSize:y,lineHeight:h}),e.fillText(t.options[f].text,i+d+10,s+d/2+u),e.restore()}}}function onAdd$1(e){initOptions(e)}function onMousedown(e,t){if(e.direction=="horizontal")for(let i=0;i<e.optionPos.length;i++)!e.options[i].isForbidden&&t.x>e.calculative.worldRect.x+e.optionPos[i]*e.calculative.worldRect.width/e.checkboxWidth&&t.x<e.calculative.worldRect.x+(e.optionPos[i]+e.height)/e.checkboxWidth*e.calculative.worldRect.width+getTextLength(e.options[i].text,e)+10/e.checkboxWidth*e.calculative.worldRect.width&&(e.checked=e.options[i].text,e.calculative.canvas.store.emitter.emit("valueUpdate",e));else if(e.direction=="vertical"){const i=e.calculative.worldRect.height/e.checkboxHeight;for(let s=0;s<e.optionPos.length;s++)!e.options[s].isForbidden&&t.y>e.calculative.worldRect.y+e.optionPos[s]*i&&t.y<e.calculative.worldRect.y+(e.optionPos[s]+e.optionHeight)*i&&(e.checked=e.options[s].text,e.calculative.canvas.store.emitter.emit("valueUpdate",e))}e.calculative.canvas.render()}function onValue(e){e.calculative.flag&&initOptions(e)}function beforeValue$2(e,t){return e.calculative.flag=!1,(t.options!==void 0||t.direction!==void 0||t.optionInterval!==void 0||t.optionHeight!==void 0)&&(e.calculative.flag=!0),t}function formPens(){return{radio,switch:le5leSwitch,slider,checkbox,table:table2,table2}}const maxDecimal=15;function fixedNum(e,t=maxDecimal){let i=""+e;return i.indexOf(".")>=0&&(i=Number.parseFloat(i).toFixed(t)),Number.parseFloat(i)}function numberValid(e){return typeof e=="number"&&Number.isFinite(e)}function scaleCompute(e){e={max:null,min:null,splitNumber:4,symmetrical:!1,deviation:!1,preferZero:!1,...e};const t=[10,15,20,25,30,40,50,60,70,80,90,100,150];let{max:i,min:s,splitNumber:a,symmetrical:r,deviation:o,preferZero:n}=e;if(!numberValid(i)||!numberValid(s)||i<s)return{splitNumber:a};if(i===s&&i===0)return{max:fixedNum(t[0]*a),min:s,interval:t[0],splitNumber:a};i===s&&(n=!0),(!numberValid(a)||a<=0)&&(a=4),n&&i*s>0&&(i<0?i=0:s=0);const l=(i-s)/a;let c=Math.floor(Math.log10(l)-1);c=Math.pow(10,c);const h=l/c;let d=t[0]*c,f=-1,u;for(u=0;u<t.length;u++)if(t[u]>h){d=t[u]*c;break}let v=i,y=s;function m(x){if(v=parseInt(""+(i/x+1))*x,y=parseInt(""+(s/x-1))*x,i===0&&(v=0),s===0&&(y=0),r&&v*y<0){const b=Math.max(Math.abs(v),Math.abs(y));v=b,y=-b}}if(m(d),o)return{max:fixedNum(v),min:fixedNum(y),interval:fixedNum(d),splitNumber:Math.round((v-y)/d)};if(!r||v*y>0){let x;t:do{if(x=Math.round((v-y)/d),(u-f)*(x-a)<0){for(;x<a;)if(y-s<=v-i&&y!==0||v===0?y-=d:v+=d,x++,x===a)break t}if(u>=t.length-1||u<=0||x===a)break;f=u,x>a?d=t[++u]*c:d=t[--u]*c,m(d)}while(x!==a)}v=fixedNum(v),y=fixedNum(y);const w=fixedNum((v-y)/a);return{max:v,min:y,interval:w,splitNumber:a}}function coordinateAxis(e,t){var m,w,x,b,T,p,R,k,I,P,A,L,S,M,j,O,H,X,z,N,B,V,W,$,Y,U,G,J;const i=t.calculative.worldRect.x,s=t.calculative.worldRect.y,a=t.calculative.worldRect.width,r=t.calculative.worldRect.height;let o=t.calculative.canvas.store.data.scale,n=[];if(t.echarts)for(let E=0;E<t.echarts.option.series.length;E++)n.push(t.echarts.option.series[E].data);else n=t.data;let l=[];for(let E=0;E<n.length;E++)l=l.concat(n[E]);let c={max:Math.max.apply(null,l),min:Math.min.apply(null,l),splitNumber:5},h=scaleCompute(c),d=t.echarts?t.echarts.option.xAxis.data.length:t.xAxisData.length;e.beginPath(),e.strokeStyle="#BFBFBF",e.lineWidth=6*o,e.lineCap="butt";let f=(a-1*(d+1))/d;e.setLineDash([1,f]),e.moveTo(i,s+r+3*o),e.lineTo(i+a,s+r+3*o),e.stroke(),e.closePath(),e.beginPath(),e.lineWidth=1*o,e.setLineDash([]),e.moveTo(i,s+r),e.lineTo(i+a,s+r),e.stroke(),e.closePath(),e.beginPath(),e.fillStyle="#BFBFBF",e.strokeStyle="#E9E9E9",e.setLineDash([2,2]);let u={fontStyle:((w=(m=t.yAxis)==null?void 0:m.axisLabel)==null?void 0:w.fontStyle)||t.fontStyle,textDecoration:(b=(x=t.yAxis)==null?void 0:x.axisLabel)==null?void 0:b.textDecoration,fontWeight:((p=(T=t.yAxis)==null?void 0:T.axisLabel)==null?void 0:p.fontWeight)||t.fontWeight,fontFamily:((k=(R=t.yAxis)==null?void 0:R.axisLabel)==null?void 0:k.fontFamily)||t.fontFamily,fontSize:((P=(I=t.yAxis)==null?void 0:I.axisLabel)==null?void 0:P.fontSize)||t.fontSize,lineHeight:((L=(A=t.yAxis)==null?void 0:A.axisLabel)==null?void 0:L.lineHeight)||t.lineHeight};e.fillStyle=((M=(S=t.yAxis)==null?void 0:S.axisLabel)==null?void 0:M.fontColor)||t.color;for(let E=0;E<h.splitNumber+1;E++){let K=E*r/h.splitNumber;e.textAlign="right",e.textBaseline="middle",e.font=getFont(u),e.fillText(h.max-E*h.interval+"",i-10*o,s+K),e.fill(),E<h.splitNumber&&(e.beginPath(),e.moveTo(i,s+K),e.lineTo(i+a,s+K),e.stroke())}e.closePath(),e.beginPath(),e.strokeStyle="#BFBFBF";let v=t.echarts?t.echarts.option.xAxis.data:t.xAxisData,y=0;for(let E=0;E<v.length;E++){y=i+(1+f/2)+(f+1)*E,e.textAlign="center",e.textBaseline="top";let K={fontStyle:((O=(j=t.xAxis)==null?void 0:j.axisLabel)==null?void 0:O.fontStyle)||t.calculative.fontStyle,textDecoration:(X=(H=t.xAxis)==null?void 0:H.axisLabel)==null?void 0:X.textDecoration,fontWeight:((N=(z=t.xAxis)==null?void 0:z.axisLabel)==null?void 0:N.fontWeight)||t.calculative.fontWeight,fontFamily:((V=(B=t.xAxis)==null?void 0:B.axisLabel)==null?void 0:V.fontFamily)||t.calculative.fontFamily,fontSize:(($=(W=t.xAxis)==null?void 0:W.axisLabel)==null?void 0:$.fontSize)||t.calculative.fontSize,lineHeight:((U=(Y=t.xAxis)==null?void 0:Y.axisLabel)==null?void 0:U.lineHeight)||t.calculative.lineHeight};e.font=getFont(K),e.fillStyle=((J=(G=t.xAxis)==null?void 0:G.axisLabel)==null?void 0:J.fontColor)||t.calculative.color,e.fillText(v[E],y,s+r+10*o),e.fill()}return e.closePath(),e.setLineDash([]),{dash:f,normalizedOption:h}}function getValidValue(e,t){if(!isNaN(e))return t===-1?e:Math.round(Number(e)*1e3)/1e3}var ReplaceMode;(function(e){e[e.Add=0]="Add",e[e.Replace=1]="Replace",e[e.ReplaceAll=2]="ReplaceAll"})(ReplaceMode||(ReplaceMode={}));function lineChart(e,t){t.onBeforeValue||(t.onBeforeValue=beforeValue$1);const i=t.calculative.worldRect.x,s=t.calculative.worldRect.y;t.calculative.worldRect.width;const a=t.calculative.worldRect.height;let r=t.calculative.canvas.store.data.scale,o=[];t.echarts&&!t.echarts.option.color&&(t.echarts.option.color=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]);let n=coordinateAxis(e,t),l=n.dash,c=n.normalizedOption;const h=!!(t.echarts?t.echarts.option.series[0].smooth:t.smooth);let d=[];if(t.echarts)for(let f=0;f<t.echarts.option.series.length;f++)o.push(t.echarts.option.series[f].data);else o=t.data;for(let f=0;f<o.length;f++){e.beginPath();let u=o[f];e.strokeStyle=t.echarts?t.echarts.option.color[f]:t.chartsColor[f],e.fillStyle=t.echarts?t.echarts.option.color[f]:t.chartsColor[f];let v=i+(1+l/2),y=s+a-(u[0]-c.min)/(c.max-c.min)*a;if(e.moveTo(v,y),d.push({x:v,y}),h)if(u.length<=2)for(let m=1;m<u.length;m++)v=i+(1+l/2)+(l+1)*m,y=s+a-(u[m]-c.min)/(c.max-c.min)*a,e.lineTo(v,y),d.push({x:v,y});else{let m,w,x,b;u.forEach((T,p)=>{v=i+(1+l/2)+(l+1)*p,y=s+a-(u[p]-c.min)/(c.max-c.min)*a;let R=i+(1+l/2)+(l+1)*(p+1),k=s+a-(u[p+1]-c.min)/(c.max-c.min)*a,I=i+(1+l/2)+(l+1)*(p-1),P=s+a-(u[p-1]-c.min)/(c.max-c.min)*a,A=i+(1+l/2)+(l+1)*(p+2),L=s+a-(u[p+2]-c.min)/(c.max-c.min)*a;p===0?(I=i+(1+l/2)+(l+1)*p,P=s+a-(u[p]-c.min)/(c.max-c.min)*a):p===u.length-2&&(A=i+(1+l/2)+(l+1)*(p+1),L=s+a-(u[p+1]-c.min)/(c.max-c.min)*a),d.push({x:v,y}),m=v+(R-I)/4,w=y+(k-P)/4,x=R-(A-v)/4,b=k-(L-y)/4,e.bezierCurveTo(m,w,x,b,R,k)})}else for(let m=1;m<u.length;m++)v=i+(1+l/2)+(l+1)*m,y=s+a-(u[m]-c.min)/(c.max-c.min)*a,e.lineTo(v,y),d.push({x:v,y});e.stroke(),e.closePath(),e.save(),d.forEach((m,w)=>{e.beginPath(),e.strokeStyle="#fff",e.lineWidth=2*r,e.arc(m.x,m.y,4*r,0,Math.PI*2),e.stroke(),e.fill(),e.closePath()}),e.restore(),d=[]}}function beforeValue$1(e,t){if(t.xAxisData||t.data||!t.dataX&&!t.dataY)return t;const i=e.xAxisData,s=e.data,a=e.replaceMode;let r=[],o=[];return a?a===ReplaceMode.Replace?(t.dataX.forEach((n,l)=>{let c=i.indexOf(n);s.forEach((h,d)=>{h[c]=t.dataY[d][l]})}),r=i,o=s):a===ReplaceMode.ReplaceAll&&(r=t.dataX,o=t.dataY):(r=[...i,...t.dataX],s.forEach((n,l)=>{let c=[...n,...t.dataY[l]];o.push(c)})),delete t.dataX,delete t.dataY,Object.assign(t,{xAxisData:r,data:o})}function pieChart(e,t){var h,d;t.onBeforeValue||(t.onBeforeValue=beforeValue);let i=t.calculative.canvas.store.data.scale;const s=t.calculative.worldRect.x,a=t.calculative.worldRect.y,r=t.calculative.worldRect.width,o=t.calculative.worldRect.height,n=!!t.echarts;t.echarts?(t.echarts.option.color||(t.echarts.option.color=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]),t.chartsColor=t.echarts.option.color):t.chartsColor||(t.chartsColor=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]);const l=n?t.echarts.option.series:t.data;let c=0;for(let f=0;f<l.length;f++){let u=l[f],v=r/2;o<r&&(v=o/2);const y=s+r/2,m=a+o/2;let w=0;n?w=u.data.reduce((k,I)=>k+I.value,0):w=u.reduce((k,I)=>k+I.value,0);const x=v*parseFloat(n?u.radius[0]:t.chartsRadius[f][0])/100,b=v*parseFloat(n?u.radius[1]:t.chartsRadius[f][1])/100;if(x>b)return;let T=0,p=0;e.strokeStyle=n&&((h=u.itemStyle)==null?void 0:h.borderColor)||"#fff",e.lineWidth=(n&&((d=u.itemStyle)==null?void 0:d.borderWidth)||2)*i;const R=n?u.data:u;R.forEach((k,I)=>{var O,H,X,z,N,B,V,W,$,Y;p+=Math.PI*2*k.value/w,e.beginPath();let P=c+I;P>=t.chartsColor.length&&(P=P%t.chartsColor.length),e.fillStyle=n?t.echarts.option.color[P]:t.chartsColor[P],e.moveTo(y+x*Math.sin(p),m-x*Math.cos(p)),e.arc(y,m,x,-Math.PI/2+p,-Math.PI/2+T,!0),e.lineTo(y+b*Math.sin(T),m-b*Math.cos(T)),e.arc(y,m,b,-Math.PI/2+T,-Math.PI/2+p),e.lineTo(y+x*Math.sin(p),m-x*Math.cos(p)),e.stroke(),e.fill(),e.closePath();let A=(T+p)/2,L=y+(b+10*i)*Math.sin(A),S=m-(b+10*i)*Math.cos(A),M=e.fillStyle;u.label||(u.label={position:"outside",show:!0}),n&&["inner","inside"].includes(u.label.position)?(e.fillStyle="#ffffff",L=y+(b-x)/2*Math.sin(A),S=m-(b-x)/2*Math.cos(A)):n&&u.label.position=="outside",u.labelLine||(u.labelLine={show:!0}),(n&&u.labelLine.show!==!1||!n)&&(e.beginPath(),e.strokeStyle=n?t.echarts.option.color[c+I]:t.chartsColor[c+I],e.moveTo(y+b*Math.sin(A),m-b*Math.cos(A)),e.lineTo(L,S));let j={fontStyle:((O=t.tickLabel)==null?void 0:O.fontStyle)||t.calculative.fontStyle,fontWeight:((H=t.tickLabel)==null?void 0:H.fontWeight)||t.calculative.fontWeight,fontFamily:((X=t.tickLabel)==null?void 0:X.fontFamily)||t.calculative.fontFamily,lineHeight:((z=t.tickLabel)==null?void 0:z.lineHeight)||t.calculative.lineHeight,fontSize:(((N=t.tickLabel)==null?void 0:N.fontSize)||t.calculative.fontSize)*i};e.font=getFont(j),e.textBaseline="middle",e.textAlign="center",A>Math.PI?((n&&u.label.position==="outside"||!n)&&(e.textAlign="end"),(n&&u.labelLine.show!==!1||!n&&(((V=(B=t.tickLabel)==null?void 0:B.labelLine)==null?void 0:V.show)??!0))&&e.lineTo(L-5*i,S),(n&&u.label.show!==!1||!n&&(((W=t.tickLabel)==null?void 0:W.show)??!0))&&e.fillText(k.name,L-5*i,S)):((n&&u.label.position==="outside"||!n)&&(e.textAlign="start"),(n&&u.labelLine.show!==!1||!n)&&e.lineTo(L+5*i,S),(n&&u.label.show!==!1||!n&&((($=t.tickLabel)==null?void 0:$.show)??!0))&&e.fillText(k.name,L+5*i,S)),e.stroke(),e.closePath(),e.fillStyle=M,e.strokeStyle=n&&((Y=u.itemStyle)==null?void 0:Y.borderColor)||"#fff",T=p}),c+=R.length}}function beforeValue(e,t){if(t.data||!t.dataX&&!t.dataY)return t;const i=e.data,s=e.replaceMode;let a=[];return s?s===ReplaceMode.Replace?(t.dataY.forEach((r,o)=>{r.forEach((n,l)=>{let c=i[o].filter(h=>h.name===n.name);c.length>0&&(c[0].value=n.value)})}),a=i):s===ReplaceMode.ReplaceAll&&(a=t.dataY):i.forEach((r,o)=>{let n=[...r,...t.dataY[o]];a.push(n)}),delete t.dataX,delete t.dataY,Object.assign(t,{data:a})}function histogram(e,t){t.onBeforeValue||(t.onBeforeValue=beforeValue$1);let i=t.calculative.canvas.store.data.scale;const s=t.calculative.worldRect.x,a=t.calculative.worldRect.y;t.calculative.worldRect.width;const r=t.calculative.worldRect.height;let o=[];if(t.echarts&&!t.echarts.option.color&&(t.echarts.option.color=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]),t.echarts)for(let d=0;d<t.echarts.option.series.length;d++)o.push(t.echarts.option.series[d].data);else o=t.data;let n=coordinateAxis(e,t),l=n.dash,c=n.normalizedOption,h=l*4/5/o.length;for(let d=0;d<o.length;d++){e.beginPath();let f=o[d];e.fillStyle=t.echarts?t.echarts.option.color[d]:t.chartsColor[d],e.strokeStyle="#ffffff",e.lineWidth=1*i;let u=0,v=0,y=0;for(let m=0;m<f.length;m++)u=s+(1+.1*l)+(l+1)*m+h*d,y=(f[m]-c.min)/(c.max-c.min)*r,v=a+r-y,e.rect(u,v,h-1,y-1),e.stroke(),e.fill();e.closePath()}}function gauge(e,t){var z,N,B,V,W,$,Y,U,G,J,E,K,_,Z;t.onAdd||(t.onAdd=onAdd,t.onDestroy=onDestroy,t.onClick=onclick,t.clockInterval&&(t.onDestroy(t),t.onAdd(t)));const i=t.calculative.worldRect.x,s=t.calculative.worldRect.y,a=t.calculative.worldRect.width,r=t.calculative.worldRect.height;let o=t.calculative.canvas.store.data.scale,n={startAngle:225,endAngle:-45,min:0,max:100,splitNumber:10};if(t.echarts&&t.echarts.option){let C=t.echarts.option.series[0];t.startAngle=C.startAngle||n.startAngle,t.endAngle=C.endAngle||n.endAngle,t.min=C.min||n.min,t.max=C.max||n.max,t.axisLine=C.axisLine.lineStyle.color,t.unit=C.detail.formatter.replace("{value}",""),t.value=C.data[0].value,t.splitNumber=C.splitNumber||n.splitNumber}t={...n,...t};let l=a>r?r/2*9/10:a/2*9/10,c=i+a/2,h=s+r/2,d=t.echarts?t.echarts.option.series[0].data[0].value:t.value,f,u=t.startAngle-t.endAngle,v=t.background||"#E6EBF8";e.strokeStyle=v;let y=l/10;e.lineWidth=y,e.beginPath(),e.lineCap="round",e.arc(c,h,l,-t.startAngle/180*Math.PI,-t.endAngle/180*Math.PI),e.stroke(),e.closePath();let m=0;if(t.axisLine&&!t.isClock)for(let C=t.axisLine.length-1;C>=0;C--)t.axisLine[C][0]*(t.max-t.min)<d?m=t.axisLine[C][0]:(m=(d-t.min)/(t.max-t.min),f=t.axisLine[C][1]),e.beginPath(),e.strokeStyle=t.axisLine[C][1],e.arc(c,h,l,-t.startAngle/180*Math.PI,(-t.startAngle+m*u)/180*Math.PI),e.stroke(),e.closePath();e.lineCap="butt";let w=2*o,x=l-y;x<0&&(x=0);let b=u/180*Math.PI*x,T=(b-w*t.splitNumber)/t.splitNumber,p=u/180*Math.PI*w/2/b;e.beginPath(),e.strokeStyle=t.color||"#999999",e.lineWidth=l/20,e.setLineDash([w,T]),e.arc(c,h,x,-t.startAngle/180*Math.PI-p,-t.endAngle/180*Math.PI+p),e.stroke(),e.closePath();let R=1*o,k=l-y;k<0&&(k=0);let I=u/180*Math.PI*k,P=(I-R*5*t.splitNumber)/5/t.splitNumber,A=u/180*Math.PI*R/2/I;e.beginPath(),e.strokeStyle=t.color||"#999999",e.lineWidth=l/40,e.setLineDash([R,P]),e.arc(c,h,k,-t.startAngle/180*Math.PI-A,-t.endAngle/180*Math.PI+A),e.stroke(),e.closePath(),e.beginPath();let L=t.max-t.min,S=L/t.splitNumber,M={fontStyle:((z=t.tickLabel)==null?void 0:z.fontStyle)||t.calculative.fontStyle,textDecoration:((N=t.tickLabel)==null?void 0:N.textDecoration)||t.textDecoration,fontWeight:((B=t.tickLabel)==null?void 0:B.fontWeight)||t.calculative.fontWeight,fontFamily:((V=t.tickLabel)==null?void 0:V.fontFamily)||t.calculative.fontFamily,fontSize:(((W=t.tickLabel)==null?void 0:W.fontSize)||t.calculative.fontSize)*o,lineHeight:(($=t.tickLabel)==null?void 0:$.lineHeight)||t.calculative.lineHeight};e.font=getFont(M);let j=l-y-l/20;for(let C=0;C<=t.splitNumber;C++){if(Math.abs(t.startAngle)+Math.abs(t.endAngle)===360&&C==0)continue;let F=t.startAngle-S*C/L*u,D=Math.cos(F/180*Math.PI),q=Math.sin(F/180*Math.PI);e.fillStyle=((Y=t.tickLabel)==null?void 0:Y.color)||"#999999",D>.02?e.textAlign="end":D<-.02?e.textAlign="start":e.textAlign="center",q>.02?e.textBaseline="top":q<-.02?e.textBaseline="bottom":e.textBaseline="middle",e.fillText(getValidValue(S*C+t.min,1),c+j*D,h-j*q),e.fill()}e.closePath();let O=1,H=["value"];if(t.isClock&&(O=3,H=["hourvalue","minutevalue","secondvalue"]),t.isClock)for(let C=0;C<O;C++){let F=(t.startAngle-(t[H[C]]-t.min)/(t.max-t.min)*u)/180*Math.PI;C>0&&(F=(t.startAngle-(t[H[C]]-t.min)/(t.max*5-t.min)*u)/180*Math.PI);let D=4/5*l;H[C]==="hourvalue"&&(D=3/5*l),H[C]==="minutevalue"&&(D=3.5/5*l);let q=l*1/40;e.beginPath(),e.setLineDash([]),e.lineWidth=l/(C+1)/20,e.strokeStyle=t.color||"#999999",e.moveTo(c-q*3*Math.cos(F),h+q*3*Math.sin(F)),e.lineTo(c+D*Math.cos(F),h-D*Math.sin(F)),e.stroke()}else{let C=(t.startAngle-(d-t.min)/(t.max-t.min)*u)/180*Math.PI,F=4/5*l,D=l*1/40;e.beginPath(),e.setLineDash([]),e.lineWidth=2,e.fillStyle=f,e.moveTo(c-D*3*Math.cos(C),h+D*3*Math.sin(C)),e.lineTo(c+D*Math.cos(C-Math.PI/2),h-D*Math.sin(C-Math.PI/2)),e.lineTo(c+F*Math.cos(C),h-F*Math.sin(C)),e.lineTo(c+D*Math.cos(C+Math.PI/2),h-D*Math.sin(C+Math.PI/2)),e.lineTo(c-D*3*Math.cos(C),h+D*3*Math.sin(C)),e.fill()}e.beginPath(),e.textAlign="center",e.textBaseline="middle";let X={fontStyle:((U=t.titleLabel)==null?void 0:U.fontStyle)||t.calculative.fontStyle,textDecoration:((G=t.titleLabel)==null?void 0:G.textDecoration)||t.textDecoration,fontWeight:((J=t.titleLabel)==null?void 0:J.fontWeight)||t.calculative.fontWeight,fontFamily:((E=t.titleLabel)==null?void 0:E.fontFamily)||t.calculative.fontFamily,fontSize:(((K=t.titleLabel)==null?void 0:K.fontSize)||t.calculative.fontSize)*o,lineHeight:((_=t.titleLabel)==null?void 0:_.lineHeight)||t.calculative.lineHeight};e.font=getFont(X),e.fillStyle=((Z=t.titleLabel)==null?void 0:Z.color)||f,t.isClock?e.fillText(("0"+parseInt(t.hourvalue)).slice(-2)+":"+("0"+parseInt(t.minutevalue)).slice(-2)+":"+("0"+parseInt(t.secondvalue)).slice(-2),c,h+l/2):e.fillText(d+" "+(t.unit||""),c,h+l/2),e.fill(),t.isClock&&(e.beginPath(),e.fillStyle=t.color||"#999999",e.strokeStyle="#ffffff",e.arc(c,h,l/20,0,Math.PI*2),e.stroke(),e.fill(),e.closePath())}function onAdd(e){if(e.isClock)e.clockInterval=setInterval(()=>{let t=new Date,i=t.getSeconds(),s=t.getMinutes()+i/60,a=t.getHours()%12+s/60;e.calculative.canvas.parent.setValue({id:e.id,hourvalue:a,minutevalue:s,secondvalue:i},{render:!0,doEvent:!1})},1e3);else{const t=e.value;e.value=0,e.frames=[{duration:2e3,value:t}],e.calculative.canvas.parent.startAnimate(e.id),setTimeout(()=>{e.value=t},1e3)}}function onDestroy(e){e.clockInterval&&(clearInterval(e.clockInterval),e.clockInterval=void 0)}function onclick(e){e.isClock&&(e.onDestroy(e),e.onAdd(e))}function chartsPens(){return{lineChart,histogram,pieChart,gauge}}function andGate(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/6,l=r/4;if(i.moveTo(s+l*2,a+0),i.lineTo(s+l*2,a+n),i.moveTo(s,a+n+l*2),i.arc(s+l*2,a+n+l*2,l*2,Math.PI*1,Math.PI*2,!1),i.lineTo(s+l*4,a+n*5),i.lineTo(s,a+n*5),i.lineTo(s,a+n+l*2),i.moveTo(s+l,a+n*5),i.lineTo(s+l,a+n*6),i.moveTo(s+l*2,a+n*5),i.lineTo(s+l*2,a+n*6),i.moveTo(s+l*3,a+n*5),i.lineTo(s+l*3,a+n*6),i.closePath(),i instanceof Path2D)return i}function andGateAnchors(e){const t=[{x:.5,y:0},{x:.25,y:1},{x:.5,y:1},{x:.75,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function basicEvent(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o-r,l=.5*r;if(i.moveTo(s+r/2,a),i.lineTo(s+r/2,a+n),i.moveTo(s+r,a+l+n),i.arc(s+r/2,a+l+n,l,0,Math.PI*2,!1),i.closePath(),i instanceof Path2D)return i}function basicEventAnchors(e){const t=[{x:.5,y:0},{x:.5,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function conditionalEvent(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/2,l=r/5;if(i.moveTo(s,a+n),i.lineTo(s+l,a+n),i.moveTo(s+l*5,a+n),i.ellipse(s+l*3,a+n,2*l,n,0,0,Math.PI*2),i.closePath(),i instanceof Path2D)return i}function conditionalEventAnchors(e){const t=[{x:.6,y:0},{x:1,y:.5},{x:.6,y:1},{x:0,y:.5}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function event(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/4,l=.5*r;if(i.moveTo(s+l,a),i.lineTo(s+l,a+n),i.moveTo(s,a+n),i.rect(s,a+n,l*2,n*2),i.moveTo(s+l,a+3*n),i.lineTo(s+l,a+4*n),i.closePath(),i instanceof Path2D)return i}function forbiddenGate(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/8,l=.25*r;if(i.moveTo(s+l*2,a),i.lineTo(s+l*2,a+n*2),i.lineTo(s+l*3,a+n*3),i.lineTo(s+l*3,a+n*5),i.lineTo(s+l*2,a+n*6),i.lineTo(s+l*1,a+n*5),i.lineTo(s+l*1,a+n*3),i.lineTo(s+l*2,a+n*2),i.moveTo(s+l*3,a+n*4),i.lineTo(s+l*4,a+n*4),i.moveTo(s+l*2,a+n*6),i.lineTo(s+l*2,a+n*8),i.closePath(),i instanceof Path2D)return i}function forbiddenGateAnchors(e){const t=[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function orGate(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=r/2,l=o/10;if(i.moveTo(s+n,a),i.lineTo(s+n,a+l),i.moveTo(s+n,a+l),i.quadraticCurveTo(s+n*2,a+l,s+n*2,a+l*9),i.moveTo(s+n,a+l),i.quadraticCurveTo(s,a+l,s,a+l*9),i.quadraticCurveTo(s+n,a+l*6,s+n*2,a+l*9),i.moveTo(s+n,a+o*3/4),i.lineTo(s+n,a+o),i.moveTo(s+n*2/5,a+o*201/250),i.lineTo(s+n*2/5,a+o),i.moveTo(s+n*8/5,a+o*201/250),i.lineTo(s+n*8/5,a+o),i.closePath(),i instanceof Path2D)return i}function orGateAnchors(e){const t=[{x:.5,y:0},{x:.2,y:1},{x:.5,y:1},{x:.8,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function priorityAndGate(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/6,l=r/4;if(i.moveTo(s+l*2,a+0),i.lineTo(s+l*2,a+n),i.moveTo(s,a+n+l*2),i.arc(s+l*2,a+n+l*2,l*2,Math.PI*1,Math.PI*2,!1),i.lineTo(s+l*4,a+n*5),i.lineTo(s,a+n*5),i.lineTo(s,a+n+l*2),i.moveTo(s,a+n*5-n/3),i.lineTo(s+l*4,a+n*5-n/3),i.moveTo(s+l,a+n*5),i.lineTo(s+l,a+n*6),i.moveTo(s+l*2,a+n*5),i.lineTo(s+l*2,a+n*6),i.moveTo(s+l*3,a+n*5),i.lineTo(s+l*3,a+n*6),i.closePath(),i instanceof Path2D)return i}function switchEvent(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/4,l=.5*r;if(i.moveTo(s+l,a),i.lineTo(s+l,a+n),i.lineTo(s+l*2,a+n*2),i.lineTo(s+l*2,a+n*4),i.lineTo(s,a+n*4),i.lineTo(s,a+n*2),i.lineTo(s+l,a+n),i.closePath(),i instanceof Path2D)return i}function transferSymbol(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/4,l=r/2;if(i.moveTo(s+l,a),i.lineTo(s+l,a+n),i.lineTo(s+l*2,a+n*4),i.lineTo(s,a+n*4),i.lineTo(s+l,a+n),i.closePath(),i instanceof Path2D)return i}function unexpandedEvent(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect,n=o/3,l=.5*r;if(i.moveTo(s+l,a),i.lineTo(s+l,a+n),i.lineTo(s+r,a+2*n),i.lineTo(s+l,a+o),i.lineTo(s,a+2*n),i.lineTo(s+l,a+n),i.closePath(),i instanceof Path2D)return i}function unexpandedEventAnchors(e){const t=[{x:.5,y:0},{x:1,y:.6666666666666666},{x:.5,y:1},{x:0,y:.6666666666666666}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function xorGate(e,t){const i=t||new Path2D,{x:s,y:a,width:r,height:o}=e.calculative.worldRect;let n=r/2,l=o/10;if(i.moveTo(s+n,a),i.lineTo(s+n,a+l),i.moveTo(s+n,a+l),i.quadraticCurveTo(s+n*2,a+l,s+n*2,a+l*9),i.moveTo(s+n,a+l),i.quadraticCurveTo(s,a+l,s,a+l*9),i.quadraticCurveTo(s+n,a+l*6,s+n*2,a+l*9),i.moveTo(s,a+l*10),i.quadraticCurveTo(s+n,a+l*7,s+n*2,a+l*10),i.moveTo(s+n*2/5,a+o*201/250+l),i.lineTo(s+n*2/5,a+o),i.moveTo(s+n*8/5,a+o*201/250+l),i.lineTo(s+n*8/5,a+o),i.closePath(),i instanceof Path2D)return i}function xorGateAnchors(e){const t=[{x:.5,y:0},{x:.2,y:1},{x:.8,y:1}];e.anchors=t.map(({x:i,y:s},a)=>({id:`${a}`,penId:e.id,x:i,y:s}))}function votingGate(e,t){const{x:i,y:s,width:a,height:r}=t.calculative.worldRect,o=a/2,n=r/10;e.beginPath(),e.moveTo(i+o,s),e.lineTo(i+o,s+n),e.moveTo(i+o,s+n),e.quadraticCurveTo(i+o*2,s+n,i+o*2,s+n*9),e.moveTo(i+o,s+n),e.quadraticCurveTo(i,s+n,i,s+n*9),e.quadraticCurveTo(i+o,s+n*6,i+o*2,s+n*9),e.moveTo(i+o,s+r*3/4),e.lineTo(i+o,s+r*9/10),e.moveTo(i+o*2/5,s+r*201/250),e.lineTo(i+o*2/5,s+r*9/10),e.moveTo(i+o*8/5,s+r*201/250),e.lineTo(i+o*8/5,s+r*9/10),e.stroke(),e.closePath(),e.beginPath();const l=o*2>n*10?n:o/5;e.fillStyle="#333333",e.font=l+"px Arial",e.textBaseline="bottom",e.textAlign="center",e.fillText("o",i+o,s+r),e.fillText("m",i+o*2/5,s+r),e.fillText("o",i+o*8/5,s+r),e.closePath()}function ftaPens(){return{andGate,basicEvent,conditionalEvent,event,forbiddenGate,orGate,priorityAndGate,switchEvent,transferSymbol,unexpandedEvent,xorGate}}function ftaPensbyCtx(){return{votingGate}}function ftaAnchors(){return{andGate:andGateAnchors,orGate:orGateAnchors,priorityAndGate:andGateAnchors,votingGate:orGateAnchors,xorGate:xorGateAnchors,forbiddenGate:forbiddenGateAnchors,basicEvent:basicEventAnchors,unexpandedEvent:unexpandedEventAnchors,conditionalEvent:conditionalEventAnchors,transferSymbol:basicEventAnchors}}var SelectionMode=(e=>(e[e.File=0]="File",e[e.Pen=1]="Pen",e))(SelectionMode||{});const selections=reactive({mode:0,pen:void 0}),useSelection=()=>({selections,select:t=>{if(!t||t.length!==1){selections.mode=0,selections.pen=void 0;return}selections.mode=1,selections.pen=t[0]}}),_hoisted_1={id:"meta2d"},_sfc_main=defineComponent({__name:"View",setup(e){const{select:t}=useSelection(),i={rule:!0,ruleColor:"rgba(255, 255, 255, 0.2)",grid:!0,gridColor:"rgba(255, 255, 255, 0.08)",gridSize:10,color:"#fff",activeColor:"#40C4FF",hoverColor:"#80D8FF",anchorColor:"#fff",anchorRadius:4,anchorBackground:"#001529",background:"#001529",textColor:"#fff",font:{color:"#fff",fontFamily:'"Roboto", "Helvetica", "Arial", sans-serif'}};onMounted(()=>{new Meta2d("meta2d",i),registerGraphics(),register$1(flowPens()),registerAnchors(flowAnchors()),register$1(activityDiagram()),registerCanvasDraw(activityDiagramByCtx()),register$1(classPens()),register$1(sequencePens()),registerCanvasDraw(sequencePensbyCtx()),register(),registerCanvasDraw(formPens()),registerCanvasDraw(chartsPens()),register$1(ftaPens()),registerCanvasDraw(ftaPensbyCtx()),registerAnchors(ftaAnchors());let r=localStorage.getItem("meta2d");r&&(r=JSON.parse(r),location.pathname==="/preview"?r.locked=1:r.locked=0,meta2d.open(r)),meta2d.on("active",s),meta2d.on("inactive",a)});const s=r=>{t(r)},a=()=>{t()};return onUnmounted(()=>{meta2d.destroy()}),(r,o)=>(openBlock(),createElementBlock("div",_hoisted_1))}}),View_vue_vue_type_style_index_0_scoped_17a89fdd_lang="",View=_export_sfc(_sfc_main,[["__scopeId","data-v-17a89fdd"]]);export{SelectionMode as S,View as V,useSelection as u};
