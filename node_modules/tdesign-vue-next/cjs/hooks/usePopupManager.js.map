{"version":3,"file":"usePopupManager.js","sources":["../../../components/hooks/usePopupManager.ts"],"sourcesContent":["// https://github.dev/arco-design/arco-design-vue\nimport { onMounted, onBeforeUnmount, readonly, Ref, ref, watch } from 'vue';\nexport type PopupType = 'popup' | 'dialog' | 'message' | 'drawer';\n\nconst popupStackType = ['dialog', 'drawer'];\nconst POPUP_BASE_Z_INDEX = 1000;\nconst MESSAGE_BASE_Z_INDEX = 5000;\nconst Z_INDEX_STEP = 1;\n\nclass PopupManager {\n  private popupStack = {\n    popup: new Set<number>(),\n    dialog: new Set<number>(),\n    message: new Set<number>(),\n    drawer: new Set<number>(),\n  };\n\n  private zIndexStack: number[] = [];\n\n  private getNextZIndex = (type: PopupType) => {\n    const current =\n      type === 'message'\n        ? Array.from(this.popupStack.message).pop() || MESSAGE_BASE_Z_INDEX\n        : Array.from(this.popupStack.popup).pop() || POPUP_BASE_Z_INDEX;\n    return current + Z_INDEX_STEP;\n  };\n\n  public add = (type: PopupType) => {\n    const zIndex = this.getNextZIndex(type);\n    this.popupStack[type].add(zIndex);\n    if (popupStackType.includes(type)) {\n      this.popupStack.popup.add(zIndex);\n    }\n    this.zIndexStack.push(zIndex);\n    return zIndex;\n  };\n\n  public delete = (zIndex: number, type: PopupType) => {\n    this.popupStack[type].delete(zIndex);\n    if (popupStackType.includes(type)) {\n      this.popupStack.popup.delete(zIndex);\n    }\n    const index = this.zIndexStack.indexOf(zIndex);\n    if (index !== -1) {\n      this.zIndexStack.splice(index, 1);\n    }\n  };\n\n  // 最顶层的交互式弹窗（指Dialog和Drawer）\n  public isTopInteractivePopup = (popupType: PopupType, zIndex: number) => {\n    if (popupStackType.includes(popupType)) {\n      const lastZIndex = this.zIndexStack[this.zIndexStack.length - 1];\n      return zIndex === lastZIndex;\n    }\n\n    if (this.popupStack[popupType]?.size > 1) {\n      return zIndex === Array.from(this.popupStack[popupType]).pop();\n    }\n\n    return true;\n  };\n\n  public getLastZIndex = () => {\n    return this.zIndexStack[this.zIndexStack.length - 1];\n  };\n}\n\nconst popupManager = new PopupManager();\n\nexport default function usePopupManager(\n  type: PopupType,\n  {\n    visible,\n    runOnMounted,\n  }: {\n    visible?: Ref<boolean>;\n    runOnMounted?: boolean;\n  } = {},\n) {\n  const zIndex = ref(0);\n\n  const open = () => {\n    zIndex.value = popupManager.add(type);\n  };\n\n  const close = () => {\n    popupManager.delete(zIndex.value, type);\n  };\n\n  const isTopInteractivePopup = () => {\n    if (popupStackType.includes(type)) {\n      return popupManager.isTopInteractivePopup(type, zIndex.value);\n    }\n    return false;\n  };\n\n  watch(\n    () => visible?.value,\n    (visible) => {\n      if (visible) {\n        open();\n      } else {\n        close();\n      }\n    },\n    {\n      immediate: true,\n    },\n  );\n\n  if (runOnMounted) {\n    onMounted(() => {\n      open();\n    });\n\n    onBeforeUnmount(() => {\n      close();\n    });\n  }\n\n  return {\n    zIndex: readonly(zIndex),\n    open,\n    close,\n    isTopInteractivePopup,\n  };\n}\n"],"names":["popupStackType","POPUP_BASE_Z_INDEX","MESSAGE_BASE_Z_INDEX","Z_INDEX_STEP","PopupManager","_createClass","_this","_classCallCheck","_defineProperty","popup","Set","dialog","message","drawer","type","current","Array","from","popupStack","pop","zIndex","getNextZIndex","add","includes","zIndexStack","push","index","indexOf","splice","popupType","_this$popupStack$popu","lastZIndex","length","size","popupManager","usePopupManager","_ref","arguments","undefined","visible","runOnMounted","ref","open","value","close","isTopInteractivePopup","watch","immediate","onMounted","onBeforeUnmount","readonly"],"mappings":"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"}